{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Welcome to my Smart Home!","text":"<p>Info</p> <p>This site is still very much a work in progress. </p> <p>The goal, is to transition https://xtremeownage.com into a completely static site.</p>"},{"location":"#about","title":"About","text":"<p>This is my personal blog around my adventures in home-automation, software development, automative and machining projects... whatever other hobbies I find myself in.</p> <p>For content, please see The Blog </p> <p>If you wish to view content for specific projects, please view Projects</p>"},{"location":"#notifications","title":"Notifications","text":"<p>If you wish to have notifications for new content, You can....</p> <ol> <li>Leverage the RSS Feed in your favorite news reader. </li> </ol> <p>(For now, that is your only option.)</p>"},{"location":"#other","title":"Other","text":""},{"location":"#disclaimers","title":"Disclaimers","text":""},{"location":"blog/2019/c--logging-directly-to-splunk/","title":"c# \u2013 Logging Directly to Splunk","text":"<p>This is a portion of my Logging libraries, to allow me to log data to Splunk using the HEC. The data being logged can either be a simple string, or a full-blown object. Code examples are below to also handle exporting Metrics to Splunk.</p> <p>A few key fields are indexed as Metadata, to enable faster searches. The rest of the fields are automatically parsed out at Searchtime, via Json KV_MODE.</p> <p>To note- I will briefly document the utilization of this class, as it would be up to you, the developer, to properly implement it in your environment.</p> <p>As well- my implement does support waiting for indexer acknowledgements to return, if they are enabled.</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#disclaimer","title":"Disclaimer","text":"<p>This is not an all inclusive guide to writing your own library to log your application\u2019s data into Splunk. This is also not a simple plug and play for your application. This was written to provide some examples on how to roll your own logic for logging data into Splunk.</p> <p>If you wish to utilize a plug and play library with minimal configuration, I recommend you check out these alternatives.</p> <ul> <li>Apache Log4Net<ul> <li>Plug-ins do exist to send directly to Splunk.</li> </ul> </li> <li>NLog</li> <li>Microsoft Enterprise Library</li> <li>Serilog<ul> <li>A Splunk Sink does exist.</li> </ul> </li> </ul> <p>All of the above libraries are extensible, and Splunk targets likely already exist for them.</p> <p>If you go this route- I personally recommend serilog.</p> <p>Lastly- this is not a guide on how to create your own logging library! My below examples do not include my \u201cILogger\u201d classes, nor how my logic is setup to reliably log data asynchronously. The intent of this article is solely how you can log data to Splunk!</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#the-code","title":"The Code","text":"","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#ilogentry","title":"ILogEntry","text":"<p>This class holds a \u201cLog Message\u201d, and a few other various fields.</p> <p><pre><code>public interface ILogEntry\n{\n    //The Splunk index to log to. May be overridden by HEC settings.\n    string Index { get; set; }\n    //This is the name of the server the log is \"For\". Not to be confused with the name of the server logging the process.\n    //Example- This tool is running on Server_A, but, is logging data into Splunk from Server_B. Server_A would be stored as Logging_Computer\n    // Server_B would be set as \"ServerName\"\n    string ServerName { get; set; }\n    //The name of the computer logging this event.\n    string Logging_Computer { get; set; }\n\n    //If set as true, the \"host\" field in Splunk will be set to \"ServerName\" instead of \"Logging_Computer\"\n    bool SetSplunkHostAsServerName { get; set; }\n\n    //This is the name of the \"Process\" or \"Workflow\" doing the logging. It is mapped to \"source\" in Splunk.\n    string LogName { get; set; }\n\n    //This object can contain a string, or a full c# object, as long as it can be serialized.\n    object Message { get; set; }\n\n    //The time at which this event was generated.\n    DateTimeOffset TimeStamp { get; set; }\n\n    //Another field, used to filter events. It can contain additional information about what is being executed. Can be null.\n    string Component { get; set; }\n\n    //The \"Severity\" of the event. Follows normal syslog severity.\n    int SeverityID { get; set; }\n\n    //This is the \"SessionID\". IE- every instance of a workflow or process is executed with its own SessionID, making it very easy to group logs from a single execution.\n    // This also allows me to generate an email for each session.\n    Guid SessionID { get; set; }\n\n    //This log's order in the particular session. Not utilized by Splunk.\n    int Session_Order_ID { get; set; }\n}\n</code></pre> This interface contains a few various fields and properties.</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#event-exporter-class","title":"Event Exporter Class","text":"<p>This class is responsible for exporting my \u201cILogEntry\u201d objects to Splunk.</p> <pre><code>/// &lt;summary&gt;\n/// This class exports events to Splunk.\n/// Data is expected to fit into an ILogEntry.\n/// &lt;/summary&gt;\npublic class EventExporter : ILoggerTarget\n{\n    //This is the Splunk HEC Token, generated within Splunk.\n    private Guid authenticationToken;\n\n    //ISerializer is an abstraction for the serialization library. In my environment, it points at newtonsoft.\n    private ISerializer serializer;\n\n    //URI to Splunk HEC.\n    private Uri splunkURI;\n\n    public EventExporter(ISerializer Serializer, Uri SplunkURI, Guid Token)\n    {\n        this.splunkURI = SplunkURI;\n        this.authenticationToken = Token;\n        this.serializer = Serializer;\n    }\n\n    //If acknoweldgements are enabled, this is required.\n    private static Guid channelIdentifier = Guid.NewGuid();\n\n    public async Task WriteLogAsync(ILogEntry log)\n    {\n        string host = log.Logging_Computer;\n        string serverName = log.ServerName;\n\n        //If flag to set host as servername is checked, and a server name is specified....\n        //Use the value as the host, \n        if (log.SetSplunkHostAsServerName == true &amp;&amp; !string.IsNullOrEmpty(log.ServerName))\n        {\n            host = log.ServerName;\n            serverName = null;\n        }\n\n        string Json = serializer.SerializeObject(new\n        {\n            //Primary attributes, will be automatically log.Indexed by Splunk.\n            time = log.TimeStamp.ToEpochTime(),\n            index = log.Index,\n            source = log.LogName,\n            sourcetype = \"MyCustomSourceType\",   //Contains the proper extractions for dealing with the below fields, and structure.\n\n//Don't worry- that is not the actual sourcetype....\n            host = host, //The CURRENT logging machine\n            @event = new\n            {\n                //MetaData Fields, will be log.Indexed in Splunk, with a special transform.\n                SeverityID = log.SeverityID,\n                SessionID = log.SessionID,\n                Component = log.Component,\n                ComputerName = serverName,\n\n                //Only the raw data for the base event, will actually be stored.\n                Event = (log.Message is string) ? new { Value = log.Message } : log.Message,\n            }\n        });\n\n        using (var client = new HttpClient())\n        {\n            client.BaseAddress = splunkURI;\n            client.DefaultRequestHeaders.Accept.Clear();\n            client.DefaultRequestHeaders.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue(\"application/json\"));\n            client.DefaultRequestHeaders.Add(\"Authorization\", $\"Splunk {authenticationToken}\");\n            client.DefaultRequestHeaders.Add(\"X-Splunk-Request-Channel\", channelIdentifier.ToString());\n            try\n            {\n                // New code:\n                HttpResponseMessage response = await client.PostAsync(\"services/collector/event\", new StringContent(Json));\n\n                if (!response.IsSuccessStatusCode)\n                    throw new Exception(response.ReasonPhrase);\n\n                DateTimeOffset EventSent = DateTimeOffset.Now;\n\n                var Content = await response.Content.ReadAsStringAsync();\n                var Ack = serializer.DeSerializeObject&lt;Models.SplunkAck&gt;(Content);\n\n                //Completed.\n                if (!Ack.ackId.HasValue)\n                    return; \n\n                var req = serializer.SerializeObject(new\n                {\n                    acks = new int[] { Ack.ackId.Value }\n                });\n\n                //\n                await Task.Delay(TimeSpan.FromSeconds(2));\n\n                while (true)\n                {\n                    HttpResponseMessage responseAck = await client.PostAsync($\"services/collector/ack?channel={channelIdentifier.ToString()}\", new StringContent(req));\n                    Content = await responseAck.Content.ReadAsStringAsync();\n                    var AckCheck = serializer.DeSerializeObject&lt;Models.SplunkAck&gt;(Content);\n\n                    //Acknowledgements are disabled. Success.\n                    if (AckCheck.code == 14)\n                        return;\n\n                    //Acknowldgement was successful. Return.\n                    if (AckCheck.acks[Ack.ackId.ToString()] == true)\n                        return;\n\n                    double MinuteSinceFirstMessage = DateTimeOffset.Now.Subtract(EventSent).TotalMinutes;\n\n                    if (MinuteSinceFirstMessage &lt; 10)\n                    {\n                        await Task.Delay(TimeSpan.FromSeconds(30));\n                    }\n                    else if (MinuteSinceFirstMessage &lt; 60)\n                    {\n                        await Task.Delay(TimeSpan.FromMinutes(1));\n                    }\n                    else\n                    {\n                        //throw exception. The message bus or sender should retry.\n                        throw new Exception(\"No acknowledgement after 1 hour.\");\n                    }\n\n                }\n            }\n            catch (Exception ex)\n            {\n                throw;\n            }\n        }\n    }\n}\n</code></pre>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#splunk-propstransforms","title":"Splunk Props/Transforms","text":"<p>So- while you could run this code without the use of Props or Transforms, I utilize props/transforms to greatly reduce the amount of _raw data stored, and to clean up the events.</p> <p>Since SeverityID, SessionID, Component, and ComputerName are stored as INDEXED fields, I do not need to retain them with the _raw data. By removing them, I can clean up the events, making them easier to read within Splunk.</p> props.conf<pre><code>[MyCustomSourceType]\nLEARN_MODEL = false\nLEARN_SOURCETYPE = false\nSHOULD_LINEMERGE = 0\nKV_MODE = json\nTIME_FORMAT=%Y-%m-%dT%H:%M:%S.%6N%z\nTRANSFORMS-setMetadata=set_SeverityID,set_SessionID,set_Component,set_ComputerName,replace_event\n</code></pre> transforms.conf<pre><code>#Remove metadata.\n[set_SeverityID]\nREGEX = \"SeverityID\":([-0-9]{1,3}),\nFORMAT = SeverityID::$1\nSOURCE_KEY=_raw\nWRITE_META = true\n\n[set_Component]\nREGEX = \"Component\":\"([^\\}\\{,\\\"]*)\",\nFORMAT = Component::$1\nSOURCE_KEY=_raw\nWRITE_META = true\n\n[set_SessionID]\nREGEX = \"SessionID\":\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})\",\nFORMAT = SessionID::$1\nSOURCE_KEY=_raw\nWRITE_META = true\n\n[set_ComputerName]\nREGEX = \"ComputerName\":\"([a-zA-Z0-9-]{1,25})\",\nFORMAT = ComputerName::$1\nSOURCE_KEY=_raw\nWRITE_META=true\n\n[replace_event]\nLOOKAHEAD=100000000\nREGEX=\"Event\":(.*)}$\nFORMAT=$1\nDEST_KEY=_raw\nSOURCE_KEY=_raw\n</code></pre> <p>To add a bit of color to the events, we can leverage <code>eventtypes.conf</code></p> eventtypes.conf<pre><code>[Debug]\nsearch = SeverityID=-1\ncolor = et_blue\n\n[Fatal]\nsearch = SeverityID=4\npriority = 1\ncolor = et_red\n</code></pre> <p>The replace_event transform removes all of the extra json which was translated to metadata events. The primary purpose is to clean up the events to make searching easier.</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#splunk-metric-exporter","title":"Splunk Metric Exporter","text":"<p>As well, here is a snippet of code used to export Metric data to Splunk.</p> <p>First, here is a simple interface which contains a \u201cMetric\u201d. I have left out the classes to generate a metric. But- I will say, they contain logic to ensure the metric name is properly formatted, and matches our naming standards.</p> IMetricData.cs<pre><code>public interface IMetricData\n{\n    string Host { get; set; }\n    string Index { get; set; }\n    string Name { get; set; }\n    DateTimeOffset TimeStamp { get; set; }\n    double Value { get; set; }\n    Dictionary&lt;string, object&gt; Dimensions { get; }\n}\n</code></pre> <p>Next up, here is the class which is responsible for sending the metrics to Splunk.</p> SplunkMetricTarget.cs<pre><code>/// &lt;summary&gt;\n/// This class exports metrics to Splunk.\n/// &lt;/summary&gt;\npublic class Splunk : IMetricTarget\n{\n    //Splunk HEC Authentication Token\n    private Guid authenticationToken;\n    //Abstraction of preferred serialization library.\n    private ISerializer serializer;\n    //URI to Splunk.\n    private Uri splunkURI;\n\n    public Splunk(ISerializer Serializer, Uri SplunkURI, Guid Token)\n    {\n        this.splunkURI = SplunkURI;\n        this.authenticationToken = Token;\n        this.serializer = Serializer;\n    }\n\n    public async Task PublishMetricDataAsync(IMetricData log)\n    {\n        string Json = serializer.SerializeObject(new\n        {\n            //Primary attributes, will be automatically log.Indexed by Splunk.\n            time = log.TimeStamp.ToEpochTime(),\n            @event = \"metric\",\n            index = log.Index,\n            host = log.Host,\n            fields = log.Dimensions\n        });\n\n        using (var httpClientHandler = new HttpClientHandler())\n        {\n            httpClientHandler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) =&gt; { return true; };\n\n            using (var client = new HttpClient(httpClientHandler))\n            {\n                client.BaseAddress = splunkURI;\n                client.DefaultRequestHeaders.Accept.Clear();\n                client.DefaultRequestHeaders.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue(\"application/json\"));\n                client.DefaultRequestHeaders.Add(\"Authorization\", $\"Splunk {authenticationToken}\");\n\n                // New code:\n                HttpResponseMessage response = await client.PostAsync(\"services/collector\", new StringContent(Json));\n                if (response.IsSuccessStatusCode)\n                {\n                    return;\n                }\n                else\n                {\n                    //To note- I use MassTransit/RabbitMQ to handle messages between my tiers.\n                    //By throwing an exception, it allows the message to be retried and re-queued.\n                    throw new Exception(response.ReasonPhrase);\n                }\n            }\n        }\n    }\n}\n</code></pre>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#example","title":"Example","text":"program.cs<pre><code>private async Task MainAsync()\n{\n    //Testing logging a simple error\n    log.Error(\"Oh no, something went wrong!\");\n\n    //A \"Success\" message.\n    log.Success(\"It worked that time.\");\n\n    //Info\n    log.Info(\"Informational message.\");\n\n    //My \"ILogger\" supports multiple methods and overloads to handle many use-cases. I will not document them here.\n\n    //Lets try... logging a complete object.\n\n    var ToLog = new Dictionary&lt;string, string&gt;\n    {\n        { \"Test\", \"42\"},\n        {\"Another Field\", \"With another value\" }\n    };\n\n    //Lets log the entire dictionary.\n    log.Success(ToLog);\n\n    //Log an anonymous object.\n    log.Debug(new\n    {\n        Date = DateTimeOffset.Now,\n        RandomField = \"A random value as string\",\n        NestedObject = ToLog,\n        RandomArray = new int[] { 7, 13, 42 }\n    });\n\n    try\n    {\n        int NotZero = 42;\n        int Zero = 0;\n\n        log.Debug(new\n        {\n            Action = \"Try Divide NotZero by Zero\",\n            Zero,\n            NotZero\n        });\n\n        int TryDivideByZero = NotZero / Zero;\n    }\n    catch (Exception ex)\n    {\n        //Exception.GetUsefulDetails is an extenstion method I have created to log relavent details regarding the exception.\n        log.Fatal(ex.GetUsefulDetails());\n    }\n}\n</code></pre> <p>Running the above program, outputs the following content to the console:</p> <p></p> <p>When viewed within Splunk, we see the following details:</p> <p></p> <p>Output as seen inside of Splunk. Notice the metadata fields are not visible within the event text.</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/c--logging-directly-to-splunk/#final-notes","title":"Final Notes","text":"<p>This was not intended to be a complete guide on how to fully log your application with Splunk. The intentions of this post, were to giving you working examples on how to leverage Splunk for logging application / debugging data, as well as logging Metrics.</p> <p>I use some of the above code samples hundreds of thousands of times per day to log data into Splunk, which have been in production for going on nearly 7 years now.</p>","tags":["Development","Development/C#","Splunk"]},{"location":"blog/2019/unknown-error-0x80005000--getting-ad-group-members/","title":"Unknown error (0x80005000) \u2013 Getting AD Group Members","text":"<p>Earlier today, somebody asked me to help troubleshoot a piece of code which was randomly erroring out- with a very undescriptive exception, only containing <code>Unknown error (0x80005000)</code></p> <p>The code in question, was recurring over groups, to gather membership. After ruling out permissions issues, I decided to try and replicate what was happening.</p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2019/unknown-error-0x80005000--getting-ad-group-members/#replicating-the-issue","title":"Replicating the issue","text":"<p>Here is my test code, designed to replicate the functionality of the code in question:</p> <pre><code>using (var adc = new PrincipalContext(ContextType.Domain, \"mydomain.com\"))\n{\n    UserPrincipal filter = new UserPrincipal(adc);\n    filter.SamAccountName = \"FakeUser\";\n\n    //get user principal\n    PrincipalSearcher search = new PrincipalSearcher(filter);\n    var ME = search.FindAll().OfType&lt;UserPrincipal&gt;().First();\n\n    //query user's groups\n    var x = ME.GetGroups();\n\n    //loop through user's groups\n    foreach (var grp in x.OfType&lt;GroupPrincipal&gt;().Where(o =&gt; o.Name.StartsWith(\"test\", StringComparison.OrdinalIgnoreCase)))\n    {\n        grp.SamAccountName.WriteConsole();\n\n        \"Looking at the group's members\".WriteConsole();\n        //Loop through each group member\n        foreach (var obj in grp.Members)\n        {\n            (\"\\t\" + obj.Name).WriteConsole();\n\n        }\n\n        \"Looking at groups inside of the groups, using the GetGroups() Method\".WriteConsole();\n        try\n        {\n\n            //Loop through groups in group.\n            foreach (var subgrp in grp.GetGroups())\n            {\n                $\"\\t\\t{subgrp.SamAccountName}\".WriteConsole();\n            }\n        }\n        catch (Exception ex)\n        {\n            $\"\\t\\tIt broke: {ex.Message}\".WriteConsole();\n        }\n    }\n}\n</code></pre> <p>Here is the output:</p> <pre><code>Starting timed workflow.\n------------------------------------------------------------------------------------------------------------------------\nTEST_Group_EVIL\nLooking at the group's members\n        User, Fake\nLooking at groups inside of the groups, using the GetGroups() Method\n                It broke: Unknown error (0x80005000)\nTEST_GROUP_NOT_EVIL\nLooking at the group's members\n        User, Fake\nLooking at groups inside of the groups, using the GetGroups() Method\n------------------------------------------------------------------------------------------------------------------------\nCompleted in 0m 55s 318ms\nPlease initiate ctrl+c to exit program.\n</code></pre> <p>The particular method throwing the exception is Principal.GetGroups();</p> <p>While- it is not clear in my above example why- let me demonstrate the exact reason\u2026 with a screenshot of the accounts.</p> <p></p> <p>That\u2019s right. The \u201cEVIL\u201d group contains slashes.</p> <p>While Active Directory WILL let you create groups with slashes, it will warn you, that you should not do this.</p> <p>The error is being thrown inside of the code from GetGroups(), likely coming from code that is not able to properly handle the forward slash.</p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2019/unknown-error-0x80005000--getting-ad-group-members/#how-to-resolvefix-this-issue","title":"How to resolve/fix this issue?","text":"<ol> <li>Don\u2019t create groups with slashes. Seriously, it is a very bad practice and will only cause issues.</li> <li>Don\u2019t use the GetGroups() method. Instead- look at Group.Members.OfType().","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2019/office-links-broken/","title":"ASP.NET Core \u2013 Links don\u2019t work from office/word document to SSO site.","text":"<p>Here is an unusual issue.</p> <p>You build a website. Its address is say\u2026 <code>https://mywebsite.com/</code></p> <p>You email this link to somebody, and it works.  You share this link in a chat. it works.</p> <p>You put this link into a word or excel document, and all of a sudden, you see this:</p> <p></p> <p>Now, you are puzzled. Why are my hyper-links not working inside of a word or excel document? What makes them different??</p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2019/office-links-broken/#supporting-documentation","title":"Supporting Documentation","text":"<p>A colleague of mine had actually experienced this issue, and shared some Microsoft documentation with me.</p> <p>Issues when you click hyperlink to SSO Web site in a document</p> <p>Well, at least its good news that this issue isn\u2019t just me, right?</p> <p>It appears the cause, is because office tries to directly bind to the resource using Microsoft\u2019s hyper-link library, which causes very weird side-effects.</p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2019/office-links-broken/#the-work-around","title":"The Work-Around","text":"<p>Based on the documentation, it appears office attempts to insert its own broken cookie into the SSO-enabled website. or- at least, that is what I gathered.</p> <p>Well, turns out, I couldn\u2019t find a good solution. But, I did find A solution\u2026 based on THIS MICROSOFT ARTICLE</p> <p>Essentially, I found a place to hook into remote authentication failures. My solution was simply to redirect the user to the home page. It works\u2026.</p> <p>If you find the ACTUAL solution to this problem, please let me know.</p> <pre><code> services\n    .AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)\n    .AddMicrosoftIdentityWebApp(options =&gt;\n    {\n        Configuration.Bind(\"AzureAd\", options);\n        options.Events ??= new OpenIdConnectEvents();\n        options.Events.OnRemoteFailure += (RemoteFailureContext options) =&gt;\n        {\n            //Redirect the user to the home page.\n            options.HttpContext.Response.Redirect(\"/\");\n\n            //Stop further processing.\n            options.HandleResponse();\n\n            return Task.CompletedTask;\n        };\n    });\n</code></pre>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2020/searching-splunk-from-browser-bar/","title":"How to Search Splunk and Service-Now from your browser's search bar.","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#introduction","title":"Introduction","text":"<p>So-</p> <p>At least a few times a day, I find myself typing <code>index=\u2026</code> into my browser's search bar, and expecting something to happen\u2026</p> <p>If I were to not catch my mistake and press enter, it would just bring me to a random google search result full of garbage results.</p> <p></p> <p>But- what if, you could actually search Splunk or other products directly from the address bar?</p> <p>Well- it turns out, you can. And- below, I am going to show you how to do it.</p> <p>This guide should work for either chrome or chromium(not tested). I am quite certain, it would also work for firefox or other browsers as well\u2026 but, I have not checked their documentation.</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#adding-a-custom-search-provider-in-chrome","title":"Adding a custom search provider in Chrome","text":"<p>First- lets open up the search providers settings menu for chrome.</p> <ol> <li>Open Settings</li> <li>Click \u201cSearch Engine\u201d (on the left)</li> <li>Click \u201cManage Search Engines\u201d</li> </ol> <p>This will bring us to a screen which resembles this:</p> <p></p> <p>From here, we will need to click the \u201cAdd\u201d button to add a new provider.</p> <p></p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#search-engine","title":"Search Engine","text":"<p>This is how it will appear in the search bar when you are searching this source. You can specify whichever name you choose. If you wanted to configure MULTIPLE instances of Splunk to search, you can do that.</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#keyword","title":"Keyword","text":"<p>This is the prefix which you must type, before chrome will send search results to this custom provider.</p> <p>For my example, I used <code>|</code></p> <p>You may use whichever prefix you prefer.</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#url","title":"URL","text":"<p>This is the URL which will be called.</p> <p>If you would like to use a different app by default, you can specify that below.</p> <p>For my example, here is the URL I used:</p> <p>https://Splunk.MyCompany.com/en-US/app/search/search?q=%s</p> <p>It will navigate to the search app, at splunk,mycompany.com, and enter the query into a search, and search.</p> <p>You COULD get fancy and add additional parameters to the above query string, to limit the time range, etc.</p> <p>For a few examples, these are some of the defaults in my environment.</p> <p><code>&amp;display.page.search.mode=verbose</code></p> <p><code>&amp;dispatch.sample_ratio=1</code></p> <p><code>&amp;workload_pool=</code></p> <p><code>&amp;earliest=-24h%40h</code></p> <p><code>&amp;latest=now</code></p> <p><code>&amp;display.page.search.tab=statistics</code></p> <p><code>&amp;display.general.type=statistics</code></p> <p>There should be a parameter you can pass in your string to specify or set any of the defaults.</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#testing","title":"Testing!","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#before","title":"Before","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#after","title":"After","text":"<p>Ignore the blacked out areas, to protect my privacy!</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#service-now-instructions","title":"Service-Now Instructions","text":"<p>As well as having this issue with Splunk- I frequently find myself having to lookup records in service-now. Applying the same logic above, we can do this for ServiceNow as well!</p> <p>For the URL Field, use this:</p> <p><code>https://mycompany.service-now.com/nav_to.do?uri=/$sn_global_search_results.do?sysparm_search=%s</code></p> <p>If you would rather open up a task directly, you can use this search string:</p> <p><code>https://mycompany.service-now.com/nav_to.do?uri=/task.do?sys_id=%s</code></p> <p>You can\u2019t search with it, but, if a record which inherits from task exists, with the provided number, it will open it directly.</p> <p>For my use, I set the keyword as <code>sn</code>. You can use whichever prefix you would remember.</p> <p>Then, you can type\u2026. <code>sn CHG000123</code> to automatically open the change up in your service-now instance!</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#settings-preview","title":"Settings Preview","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#before_1","title":"Before","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#after_1","title":"After","text":"","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#summary","title":"Summary","text":"<p>If you found this article useful, please consider subscribing to this blog, or Liking us on Facebook\u2026 Or, even leaving a comment below. I don\u2019t sell your information or ask for money- but, leaving a comment or a Like does let me know that you did find this page useful.</p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2020/searching-splunk-from-browser-bar/#post-history","title":"Post History","text":"<p>This post was originally published on 2020-01-13, and migrated to this static site 2023-12-08. Content remains unaltered with minor formatting changes. </p>","tags":["Development","Splunk","Service-Now"]},{"location":"blog/2021/an-anonymous-request-was-received-in-between-authentication-handshake-requests/","title":"An anonymous request was received in between authentication handshake requests","text":"<p>I was receiving this error while hosting a webapi project on .net 5, using kestrel.</p> <pre><code>fail: Microsoft.AspNetCore.Authentication.Negotiate.NegotiateHandler[5]\n      An exception occurred while processing the authentication request.\n      System.InvalidOperationException: An anonymous request was received in between authentication handshake requests.\n         at Microsoft.AspNetCore.Authentication.Negotiate.NegotiateHandler.HandleRequestAsync()\nfail: Microsoft.AspNetCore.Server.Kestrel[13]\n      Connection id \"0HM6A34N67LO5\", Request id \"0HM6A34N67LO5:00000005\": An unhandled exception was thrown by the application.\n      System.InvalidOperationException: An anonymous request was received in between authentication handshake requests.\n         at Microsoft.AspNetCore.Authentication.Negotiate.NegotiateHandler.HandleRequestAsync()\n         at Microsoft.AspNetCore.Authentication.Negotiate.NegotiateHandler.HandleRequestAsync()\n         at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)\n         at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)\n         at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)\n         at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)\n</code></pre>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2021/an-anonymous-request-was-received-in-between-authentication-handshake-requests/#symptoms","title":"Symptoms","text":"<p>Windows authentication works just fine when debugging locally, however, fails when deployed to a server, or accessing remotely via dns, with this error: <code>System.InvalidOperationException: An anonymous request was received in between authentication handshake requests.</code></p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2021/an-anonymous-request-was-received-in-between-authentication-handshake-requests/#how-i-corrected-it","title":"How I corrected it","text":"<p>My kestrel endpoints were configured to <code>https://0.0.0.0:1234</code>, with a certificate from <code>myservice.mydomain.com</code>.</p> <p>I resolve the issue by setting my endpoint to <code>https://myservice.mydomain.com:1234</code></p> <p>As well, ensure you have a SPN configured using <code>setspn -S HTTP/myserver.mydomain.com myserviceaccount</code></p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2021/an-anonymous-request-was-received-in-between-authentication-handshake-requests/#why-am-i-blogging-about-this","title":"Why am I blogging about this?","text":"<p>Because all of the advice I found while googling was incredibly unhelpful.</p> <ul> <li>Github Issue #1 Closed by Microsoft bot. No help.</li> <li>Github Issue #2 Closed, states does not work by design.</li> <li>Stackoverflow #1. No help at all.</li> <li>Stackoverflow #2. No Help.</li> <li>Stackoverflow #3 Links back to a github article stating windows auth is not supported.</li> <li>Microsoft Documentation Says to use http.sys instead of kestrel, and/or update SPN.</li> </ul> <p>So, If I helped a single person, by taking the 5 minutes to write this article, it has served its purpose.</p> <p>If you do stumble upon this, and it helps you, leave a comment down below.</p>","tags":["Development","Development/C#","Development/.NET"]},{"location":"blog/2021/microsoftidentitywebchallengeuserexception/","title":"MicrosoftIdentityWebChallengeUserException: IDW10502","text":"<p>An MsalUiRequiredException was thrown due to a challenge for the user. See https://aka.ms/ms-id-web/ca_inc</p>","tags":["Development","Development/C#"]},{"location":"blog/2021/microsoftidentitywebchallengeuserexception/#introduction","title":"Introduction","text":"<p>When I started using Blazor earlier this year, I would occasionally run into this exception. For a long time, I could not reproduce it. Navigating to the root of my web application would cause the issue to stop happening.</p> <p></p> <p>A few weeks ago, I figured out how to reproduce this issue with 100% success rate.. and Today, I figured out how to resolve this issue.</p> <p>To reproduce this issue, you need to be running Microsoft.Identity for authentication. Then, just restart the backend service running kestrel.</p>","tags":["Development","Development/C#"]},{"location":"blog/2021/microsoftidentitywebchallengeuserexception/#what-is-happening-and-how-to-reproduce-it","title":"What is happening, and how to reproduce it.","text":"<p>This issue is only reproducible for me, on sub-pages within my website. It will not reproduce on the root page.</p> <p>However, what happens, is when your browser has a cached cookie, and you restart the backend service, the backend service now knows nothing regarding your session cookie, which causes this exception to be thrown.</p>","tags":["Development","Development/C#"]},{"location":"blog/2021/microsoftidentitywebchallengeuserexception/#how-do-you-fix-this","title":"How do you fix this?","text":"<p>Well, it took me 6 months to find the answer myself- however, I found it today after traveling through many linked Microsoft articles and github pages\u2026. On this github ticket</p> <p>Long story short- to fix the issue, you add a filter which rejects a session cookie which the website does not know how to handle.</p> <p>I will be copying the solution from here. Remember- this is not my code, I am just copying the solution here for you!</p> <p>First, you need to create a filter. This filters purpose is to \u201creject\u201d cookies, which are not cached by your front-end.</p> RejectSessionCookieWhenAccountNotInCacheEvents.cs<pre><code>    using Microsoft.AspNetCore.Authentication.Cookies;\n    using Microsoft.Extensions.DependencyInjection;\n    using Microsoft.Identity.Client;\n    using Microsoft.Identity.Web;\n    namespace YourProject;\n    internal class RejectSessionCookieWhenAccountNotInCacheEvents : CookieAuthenticationEvents\n    {\n        public async override Task ValidatePrincipal(CookieValidatePrincipalContext context)\n        {\n            try\n            {\n                var tokenAcquisition = context.HttpContext.RequestServices.GetRequiredService&lt;ITokenAcquisition&gt;();\n                string token = await tokenAcquisition.GetAccessTokenForUserAsync(\n                    scopes: new[] { \"profile\" },\n                    user: context.Principal);\n            }\n            catch (MicrosoftIdentityWebChallengeUserException ex) when (AccountDoesNotExitInTokenCache(ex))\n            {\n                context.RejectPrincipal();\n            }\n        }\n        /// &lt;summary&gt;\n        /// Is the exception thrown because there is no account in the token cache?\n        /// &lt;/summary&gt;\n        /// &lt;param name=\"ex\"&gt;Exception thrown by &lt;see cref=\"ITokenAcquisition\"/&gt;.GetTokenForXX methods.&lt;/param&gt;\n        /// &lt;returns&gt;A boolean telling if the exception was about not having an account in the cache&lt;/returns&gt;\n        private static bool AccountDoesNotExitInTokenCache(MicrosoftIdentityWebChallengeUserException ex)\n        {\n            return ex.InnerException is MsalUiRequiredException &amp;&amp; (ex.InnerException as MsalUiRequiredException).ErrorCode == \"user_null\";\n        }\n    }\n</code></pre> <p>After you have created this module somewhere, we just need to \u201cplug it in\u201d</p> <p>In your Startup.ConfigureServices method, just plug in the options.</p> Startup.cs<pre><code>    services.AddMicrosoftIdentityWebAppAuthentication(Configuration).AddInMemoryTokenCaches();\n    //Add this line.\n    services.Configure&lt;CookieAuthenticationOptions&gt;(CookieAuthenticationDefaults.AuthenticationScheme, options =&gt; options.Events = new RejectSessionCookieWhenAccountNotInCacheEvents());\n</code></pre> <p>Thats it! At least, that resolve this long-standing issue for me.</p> <p>Hopefully, this is of benefit to someone else. Based on the github article, there does not appear to be a \u201cfix\u201d going into the libraries for this issue.</p> <p>Edit- as of Nov 2022, this issue is still not resolved on Github.</p>","tags":["Development","Development/C#"]},{"location":"blog/2022/tfs--azure-devops---semantic-versioning/","title":"TFS / Azure Devops - Semantic Versioning","text":"<p>I publish nuget packages. Alot of nuget packages.</p> <p>I don\u2019t have time to maintain nuget package versioning, so, I automatically generate versions based on the date and build number, like so: 2022.07.14.1</p> <p>As well, I need support for alpha/beta/etc.</p> <p>So, 2022.07.14.1-alpha.</p> <p>Here is my method of doing it-</p>","tags":["Development","Development/C#"]},{"location":"blog/2022/tfs--azure-devops---semantic-versioning/#1-task-group-append-package-version","title":"1. Task Group: Append Package Version","text":"<p>The first step, is to create a simple, reusable task group which runs powershell to append the package version to the .csproj file.</p> <p>I have logic to automatically assign dev/* branches to -alpha, test or beta to -beta, qual / rc to -rc, master to production (no tag), and anything else gets assigned the -aa format, which is the lowest priority.</p> <pre><code>#Inputs\n$input = Resolve-Path -LiteralPath \"$(build.sourcesdirectory)\\$(projectPath)\"\n$branch = \"$(Build.SourceBranch)\"\n$buildNumber = \"$env:BUILD_BUILDNUMBER\"\n$suffix = \"\"\n$d = Get-Date\n$prefix = $buildNumber\n\n\n#Append -rc, -alpha, -beta versioning\n$parts = ($branch -split '/')\nif($parts[1] -eq \"heads\")\n{\n    if($parts[2] -eq \"master\")\n    {\n        #Production branch. Don't append anything.\n    }\n    elseif($parts[2] -eq \"alpha\" -or $parts[2].StartsWith(\"dev\"))\n    {\n        $suffix  = \"-alpha\"\n    }\n    elseif($parts[2] -eq \"beta\" -or $parts[2] -eq \"test\")\n    {\n        $suffix  = \"-beta\"\n    }\n    elseif($parts[2] -eq \"rc\" -or $parts[2] -eq \"qual\")\n    {\n        $suffix  = \"-rc\"\n    }\n    else\n    {\n        #Unknown branch format. AA receives LAST priority in package selection.\n        $suffix  = \"-aa\"  \n    }\n}\n\n# For Debugging\nWrite-Output \"Project Path: $input\"\nWrite-Output \"Build Number: $buildNumber\"\nWrite-Output \"VersionSuffix: $suffix\"\nWrite-Output \"VersionPrefix: $prefix\"\n\n#Get the Project Content\n[xml]$content = (Get-Content -path $input)\n\n#Remove all attributes for versioning. We will create new ones.\nforeach($v in $content.SelectNodes(\"//VersionPrefix\"))\n{\n    $v.ParentNode.RemoveChild($v)\n}\nforeach($v in $content.SelectNodes(\"//VersionSuffix\"))\n{\n    $v.ParentNode.RemoveChild($v)\n}\nforeach($v in $content.SelectNodes(\"//Version\"))\n{\n    $v.ParentNode.RemoveChild($v)\n}\n\n\n#create a new element with package version.\n$newPG = $content.Project.AppendChild($content.CreateElement(\"PropertyGroup\"))\n$newPrefix = $newPG.AppendChild($content.CreateElement(\"VersionPrefix\"))\n$newPrefix.InnerText = $prefix\n$newSuffix = $newPG.AppendChild($content.CreateElement(\"VersionSuffix\"))\n$newSuffix.InnerText = $suffix\nWrite-Output \"Created new package version element\"\n\n\nWrite-Output \"Saving updated project.\"\n\n#Save the modified file.\n$content.Save($input)\n</code></pre> <p>Your task group just needs a simple parameter, accepting the expected project path.</p> <p></p>","tags":["Development","Development/C#"]},{"location":"blog/2022/tfs--azure-devops---semantic-versioning/#how-to-use","title":"How to use?","text":"<p>I put this into my pipeline step, before my dotnet build / pack steps.</p> <p>Notice</p> <p>Under Options, you will need to set the Build number format to:</p> <pre><code>$(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)\n</code></pre>","tags":["Development","Development/C#"]},{"location":"blog/2022/parsing-sccm-collections/","title":"SCCM \u2013 Parsing Collection Maintenance Windows from C-Sharp","text":"","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#introduction","title":"Introduction","text":"<p>This post details how to extract useful information from the SCCM Schedules format.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#suggested-reading","title":"Suggested Reading","text":"<p>Here are a few useful links to documentation regarding some of the activities being performed-</p> <p>This solution makes heavy use of Logical AND operators.</p> <ul> <li>https://learn.microsoft.com/.../boolean-logical-operators</li> </ul> <p>As well as heavy use of shift operators.</p> <ul> <li>https://learn.microsoft.com/.../bitwise-and-shift-operators</li> </ul>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#the-format","title":"The Format","text":"<p>You can view the SCCM service windows by querying the view, \u201cvSMS_ServiceWindow\u201d</p> <p>Here is an example query for retrieving collections along with their service windows.</p> <pre><code>select\n    c.CollectionID\n    ,c.SiteID\n    ,c.CollectionName\n    ,c.CollectionType\n    ,c.ServiceWindowsCount\n    ,c.LimitToCollectionID\n    ,c.LimitToCollectionName\n    ,c.ObjectPath\n    ,sw.Name\n    ,sw.ServiceWindowType\n    ,sw.Description\n    ,sw.Enabled\n    ,sw.Schedules\nfrom v_Collections c\nJOIN vSMS_ServiceWindow sw on sw.SiteID = c.SiteID\nORDER BY c.LimitToCollectionName\n</code></pre> <p>When you query this- you will get a lot of common information about your collections, their names, collection IDs, types, etc.</p> <p>The piece I want to focus on here, is extracting out the actual schedules, which are stored in the \u201cSchedules\u201d column of the results from the above query.</p> <p>At a glance, it would appear this column is complete gibberish, containing values such as below-</p> <pre><code>00629CC0101A2000\n00A29CC0101A2000\n02A29CC0101A2000\n02E29CC0101A2000\n02A29CC0101D2000\n02E29CC0101D2000\n00229CC0101D2000\n00629CC0101D2000\n</code></pre> <p>However, this is in fact, 64bits of data, stored as a hexadecimal string.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#reversing-the-format","title":"Reversing the format","text":"<p>Using data from both PART 1 of this post, as well as a bunch of testing collections I created- I came up with this diagram showing the relationships of the data in that column.</p> <p></p> <p>For the time being- I will be focused on \u201cWeekly\u201d windows, which are service-windows which repeats on the specified day of the week, every week.</p> <p>I will note, the format of the above data will change, depending on the recurrence type, stored in bits 20- 22.</p> Low Bit High Bit N Bits Data Recurrence Type 1 1 1 Is Date GMT/CST 4 8 3 Recur Every N Days 2 = Daily 14 16 3 Recur Every N Weeks 3 = Weekly 16 18 3 Day Of Week 3 = Weekly 10 12 3 Week Order 4 = Monthly by WeekDay 13 16 4 Recur Every N Months 4 = Monthly by WeekDay 17 19 3 Day Of Week 4 = Monthly by WeekDay 11 14 4 Recur Every N Months 5 = Monthly By Date 15 19 5 Recur Every N Days 5 = Monthly By Date 7 9 3 Offset Days 6 = Monthly By Weekday Offset 10 12 3 Week Order 6 = Monthly By Weekday Offset 13 16 4 Recur Every N Months 6 = Monthly By Weekday Offset 17 19 3 Day Of Week 6 = Monthly By Weekday Offset 20 22 3 Recurrence Type 23 27 5 Duration (Mins) 28 32 5 Duration (Hours) 33 38 6 Duration (???) Unsure- of what this is. 39 44 6 Date \u2013 Year 45 48 4 Date \u2013 Month 49 53 5 Date \u2013 Day 54 58 5 Date \u2013 Hour 59 64 6 Date \u2013 Minute","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#converting-the-hex-string-into-a-ulong-for-processing","title":"Converting the HEX string into a ulong for processing.","text":"<pre><code>    if (!ulong.TryParse(Hex, System.Globalization.NumberStyles.HexNumber, provider: null, out ulong Result))\n      throw new Exception(\"Invalid hex provided. Unable to parse.\");\n</code></pre> <p>While there is nothing special about converting a string containing HEX, into a number- there is one important thing to note here- I am parsing the value as ulong, instead of long.</p> <p>The reason behind using ulong- all of the values are unsigned. If we parse as long instead, this will make it harder to manipulate the data later on, as c# will assume all of the resulting arithmetic results in signed numbers.</p> <p>If you don\u2019t know the difference between signed / unsigned-</p> <p>Signed data types leverage the most significant bit, to determine if the value is negative or positive. This allows them to hold a negative value, but, sacrifices half of the maximum value.</p> <p>Unsigned- uses all of the bits for numeric data.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#common-fields","title":"Common Fields","text":"<p>Bit 1, corresponds to \u201cIS GMT / CST\u201d, and is common for all types.</p> <p>Bits 23-38 contains the duration, which is common for all recurrence types. I am unsure of what bits 33-38 stores\u2026</p> <p>Bits 39 \u2013 64 contains the effective \u201cStart Date\u201d which is common and shared for all recurrence types. Parsing out this data is pretty easy.</p> <p>Used the table above- we shift the data the specified number of bits, and do a bitwise AND to only include the number of bits notated.</p> <pre><code>    var Flags = (Result &gt;&gt; 19) &amp; 0x7;                       //Recurrence Type Flags - 3 bits.\n    model.Recurrance = (ParsedSchedule.RecurranceType)Flags;\n\n    var R_Duration_Mins = (Result &gt;&gt; 22) &amp; 0x1F;            //Duration Mins - 5 bits.\n    var R_Duration_Hours = (Result &gt;&gt; 27) &amp; 0x1F;           //Duration Hours- 5 bits.\n    model.Duration = new TimeSpan((int)R_Duration_Hours, (int)R_Duration_Mins, 0);\n\n    var IsGMT = (Result &amp; 0x1) == 1;                    //First bit, specifies if this schedule is GMT, or Local.\n    var Duration = (Result &gt;&gt; 32) &amp; 0x3F;              // 6 bits. Not, sure exactly what this field's purpose is.\n    var Year = ((Result &gt;&gt; 38) &amp; 0x3F) + 1970;         // 6 bits + 1970\n    var Month = (Result &gt;&gt; 44) &amp; 0xF;                   // 1 byte\n    var Day = (Result &gt;&gt; 48) &amp; 0x1F;                    // 5 bits\n    var Hour = (Result &gt;&gt; 53) &amp; 0x1F;                   // 5 bits\n    var Minute = (Result &gt;&gt; 58);                        // Remaining 6 bits. (Operating on a 64-bit ulong, no need to mask the rest)\n    model.StartTime = new DateTime((int)Year, (int)Month, (int)Day, (int)Hour, (int)Minute, 0, IsGMT ? DateTimeKind.Utc : DateTimeKind.Local);\n</code></pre> <p>The final cast to int is needed, otherwise, you would receive a syntax error because you cannot create a datetime with ulongs.</p> <p>I will note, I am not using checked when casting, as\u2026. well. It\u2019s impossible to overflow an int with only 6 bits\u2026.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#recurrence-type","title":"Recurrence Type","text":"<p>The Recurrence type, stored in bits 20-22, will determine the data stored in bits 2-19.</p> <p>From my research, I have found these possible values:</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#none-1","title":"None = 1","text":"<p>This service windows is not recurring, and will only occur once on the date provided.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#daily-2","title":"Daily = 2","text":"<p>This schedule will repeat every N Days.</p> <p></p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#weekly-3","title":"Weekly = 3","text":"<p>This schedule, will repeat on the specified day of the week, every week.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#monthly-by-week-day-4","title":"Monthly By Week Day = 4","text":"<p>This Schedule will occur every month, on a given weekday.</p> <p></p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#monthly-with-offset-6","title":"Monthly, With Offset = 6","text":"<p>This is the same as \u201cMonthly by week day\u201d, but, with the \u201cOffset\u201d checkbox checked.</p> <p>This came with SCCM 2207</p> <p>From Microsoft-</p> <p></p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#parsing-out-recurrence-specific-fields","title":"Parsing out Recurrence-Specific Fields.","text":"<pre><code>switch (model.Recurrance)\n{\n    case ParsedSchedule.RecurranceType.None:\n        break;\n    case ParsedSchedule.RecurranceType.Daily:\n        model.RecurEveryNDays = (int)((Result &gt;&gt; 3) &amp; 0x1F);                      //5 Bits\n        break;\n    case ParsedSchedule.RecurranceType.Weekly:\n        model.DayOfWeek = (DayOfWeek)(((Result &gt;&gt; 16) &amp; 0x7) - 1);                // 3 bits.\n        model.RecurEveryNWeeks = (int)((Result &gt;&gt; 13) &amp; 0x7);                     // 3 bits\n        break;\n    case ParsedSchedule.RecurranceType.Monthly_ByWeekday:\n        model.WeekOccurence = (ParsedSchedule.WeekOrder)((Result &gt;&gt; 9) &amp; 0x7);    // 3 bits\n        model.RecurEveryNMonths = (int)((Result &gt;&gt; 12) &amp; 0xF);                    // 4 bits\n        model.DayOfWeek = (DayOfWeek)(((Result &gt;&gt; 16) &amp; 0x7) - 1);                // 3 bits        \n        break;\n    case ParsedSchedule.RecurranceType.Monthly_ByDate:\n        model.RecurEveryNDays = (int)((Result &gt;&gt; 14) &amp; 0x1F);                     // 5 bits\n        model.RecurEveryNMonths = (int)((Result &gt;&gt; 10) &amp; 0xF);                    // 4 bits\n        break;\n    case ParsedSchedule.RecurranceType.Monthly_ByWeekDay_Offset:\n        model.DayOfWeek = (DayOfWeek)(((Result &gt;&gt; 16) &amp; 0x7) - 1);                 // 3 bits.\n        model.OffsetDays = (int)((Result &gt;&gt; 6) &amp; 0x7);                             // 3 bits.\n        model.WeekOccurence = (ParsedSchedule.WeekOrder)((Result &gt;&gt; 9) &amp; 0x7);     // 3 bits\n        model.RecurEveryNMonths = (int)((Result &gt;&gt; 12) &amp; 0xF);                     // 4 bits\n        break;\n}\n</code></pre> <p>About the only thing special to note here- SCCM stores Days of week, starting with Sunday = 1. .NET Starts the week on Sunday = 0. To compensate, we just subtract 1.</p> <p>I will also note, for \u201cWeekOccurence\u201d, 0 corresponds to last, 1 = first, 2 = second, 3 = third, 4 = forth.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/parsing-sccm-collections/#how-did-i-obtain-this-data","title":"How did I obtain this data?","text":"<p>Easier said than done!</p> <p>While, I knew the general format from my previous article, and the pseudocode linked from it- I needed to parse out the specific offsets, and field types. As well, I wanted to leverage proper bitwise operations instead of relying on odd string/hex manipulation. So- a lot of this was trial and error.</p> <p>The first step I did- was to generate a large number of dummy schedules, copy the hex, and I built a bunch of unit tests.</p> <p></p> <p>I knew the expected output, so, I provided the expected values. After which- most of the process was running unit tests, and using a bit of logic.</p> <p>A lot of the work was done in Notepad++, looking at the binary values, and trying to determine what fits where.</p> <p></p> <p>By removing the \u201cKnown\u201d bits, and only comparing the unknown bits- it makes it pretty easy to find what data, fits where, by comparing multiple variations of the data.</p> <p>In the above example, it can be determined bits 17-19, corresponds to the day of the week.</p> <p>Overall, it took me about one full working day to reverse engineer all of the formats.</p>","tags":["Development","Development/C#","SCCM"]},{"location":"blog/2022/c---get-display-attribute-value-from-enum/","title":"C# - Get Display Attribute Value from Enum","text":"<p>Every now and then, I have a use case where decorating an Enum\u2019s values with Attributes comes in handy. Things such as\u2026 Adding Display Names, Descriptions, etc.</p> <p>Well, every time I have this use-case, I have to go google how I did it the previous time\u2026 and in most cases, StackOverflow is less then helpful. Then, I remember a few personal projects where I previously did this, and I find the code and reuse it.</p> <p>Well, for the others who have this issue, I am going to share the solution I came up with many moons ago.</p>","tags":["Development","Development/C#"]},{"location":"blog/2022/c---get-display-attribute-value-from-enum/#the-code","title":"The Code","text":"<pre><code>public static class AttributeHelper\n{\n    /// &lt;summary&gt;\n    /// If &lt;paramref name=\"Enum\"/&gt; has &lt;see cref=\"DisplayAttribute\"/&gt; defined, this will return &lt;see cref=\"DisplayAttribute.Name\"/&gt;. Otherwise, &lt;see langword=\"null\" /&gt; will be returned.\n    /// &lt;/summary&gt;\n    /// &lt;returns&gt;&lt;see cref=\"string\"/&gt; containing &lt;see cref=\"DisplayAttribute.Name\"/&gt; if defined. Otherwise, will return &lt;see langword=\"null\" /&gt;&lt;/returns&gt;\n    public static string GetDisplayName&lt;T&gt;(this T Enum) where T : System.Enum\n        =&gt; Enum.GetEnumAttribute&lt;T, DisplayAttribute&gt;()?.Name;\n    /// &lt;summary&gt;\n    /// If &lt;paramref name=\"Enum\"/&gt; has &lt;see cref=\"DisplayAttribute\"/&gt; defined, this will return &lt;see cref=\"DisplayAttribute.Description\"/&gt;. Otherwise, &lt;see langword=\"null\" /&gt; will be returned.\n    /// &lt;/summary&gt;\n    /// &lt;returns&gt;&lt;see cref=\"string\"/&gt; containing &lt;see cref=\"DisplayAttribute.Description\"/&gt; if defined. Otherwise, will return &lt;see langword=\"null\" /&gt;&lt;/returns&gt;\n    public static string GetDescription&lt;T&gt;(this T Enum) where T : System.Enum\n        =&gt; Enum.GetEnumAttribute&lt;T, DisplayAttribute&gt;()?.Description;\n    /// &lt;summary&gt;\n    /// Returns &lt;see cref=\"DisplayAttribute\"/&gt; from &lt;paramref name=\"Enum\"/&gt; if defined. Otherwise will return &lt;see langword=\"null\" /&gt;.\n    /// &lt;/summary&gt;\n    public static DisplayAttribute GetDisplayAttribute&lt;T&gt;(this T Enum) where T : System.Enum\n        =&gt; Enum.GetEnumAttribute&lt;T, DisplayAttribute&gt;();\n    public static TAttribute GetEnumAttribute&lt;TEnum, TAttribute&gt;(this TEnum Enum)\n        where TEnum : System.Enum\n        where TAttribute : System.Attribute\n    {\n        var MemberInfo = typeof(TEnum).GetMember(Enum.ToString());\n        return MemberInfo[0].GetCustomAttribute&lt;TAttribute&gt;();\n    }\n}\n</code></pre>","tags":["Development","Development/C#"]},{"location":"blog/2022/c---get-display-attribute-value-from-enum/#how-do-you-use-it","title":"How do you use it?","text":"<p>Simple. Since the helpers are defined as an extension method, just make sure you are using the proper namespace, and\u2026 that is it.</p> <pre><code>public enum TestEnum\n{\n    [Display(Name = \"Value 1\", Description = \"This is a description for value 1.\")]\n    VALUE_1,\n\n    VALUE_2,\n\n    [Display(Name = null, Description = null)]\n    VALUE_3\n}\n\n\npublic void TestDisplayName()\n{\n    TestEnum.VALUE_1.GetDisplayName(); //Returns \"Value 1\"\n    TestEnum.VALUE_2.GetDescription(); //Returns \"This is a description for value 1.\"\n    TestEnum.VALUE_1.GetDisplayAttribute().Name; //Returns \"Value 1\"\n\n    TestEnum.VALUE_2.GetDisplayName(); //Returns null\n    TestEnum.VALUE_2.GetDescription(); //Returns null\n    TestEnum.VALUE_2.GetDisplayAttribute(); //Returns null\n}\n</code></pre>","tags":["Development","Development/C#"]},{"location":"blog/2022/c---get-display-attribute-value-from-enum/#unit-tests","title":"Unit Tests","text":"<p>Nothing is complete without proper unit testing! Here are some simple tests to get you started.</p> <pre><code>[TestCase(TestEnum.VALUE_1, \"Value 1\", \"This is a description for value 1.\")]\n[TestCase(TestEnum.VALUE_2, null, null)]\n[TestCase(TestEnum.VALUE_3, null, null)]\npublic void TestDisplayName(TestEnum Enum, string DisplayName, string Description)\n{\n    Assert.DoesNotThrow(() =&gt;\n    {\n      Assert.AreEqual(DisplayName, Enum.GetDisplayName());\n      Assert.AreEqual(Description, Enum.GetDescription());\n    });\n}\n</code></pre>","tags":["Development","Development/C#"]},{"location":"blog/2024/gitea---slow-dashboard/","title":"Gitea - Slow Dashboard","text":"<p>For a few weeks now, I have noticed my Gitea instance takes nearly two minutes to load.</p> <p>Turns out, when you use gitea for archiving lots of public repos, this will build up many entries in the actions table, which can drastically increase the loading time needed.</p> <p>To fix this, I made a query &amp; cron job, which removes actions for my \"Archive\" organization. </p> <p>This- fixes the issue.</p> <p>IF, you aren't archiving/mirroring a lot of repositories, this post will not help you.</p>","tags":["Development","Development/Gitea"]},{"location":"blog/2024/gitea---slow-dashboard/#the-issue","title":"The issue","text":"<p>After googling for a bit, I came across This Issue for another user who was having issues with slow loading performance.</p> <p>The issue is, when mirroring a large number of repos, it tracks a large number of actions.</p> <p>For me- since I use a dedicated organization for my repository archiving/mirror- This is easy to fix. Just delete the associated records for my archive organization.</p> <p>I took the details from that comment- and made a slightly customized query, which only deletes the actions from a specific organization I use for archiving public repos.</p> <p>Danger</p> <p>Make sure you have working backups before you go poking around in your database.</p> <p>I am not responsible for you losing data. Take backups.</p> <p>Here is the resulting query:</p> <pre><code>DELETE a\nFROM action a\nJOIN user u on u.id = a.user_id\nWHERE\n  -- This is the name of my organization, which contains all of my public archives.\n    u.name = 'ArchiveForks'\n  -- Full list of action types: https://github.com/go-gitea/gitea/blob/67103eb2bc3cb73fab2363fda811c43b50ac9d89/models/activities/action.go#L39\n  -- ActionMirrorSyncPush                                  // 18\n    -- ActionMirrorSyncCreate                                // 19\n    -- ActionMirrorSyncDelete                                // 20\n    AND a.op_type IN (18, 19, 20);\n</code></pre> <p>And.... after running the query...</p> <pre><code>MariaDB [gitea]&gt; DELETE a FROM action a JOIN user u on u.id = a.user_id WHERE u.name = 'ArchiveForks' AND a.op_type IN (18, 19, 20);\nQuery OK, 438029 rows affected (0.540 sec)\n</code></pre> <p>The issue went away.</p>","tags":["Development","Development/Gitea"]},{"location":"blog/2024/gitea---slow-dashboard/#create-event","title":"Create \"Event\"","text":"<p>Originally, I was going to schedule this using CRON.</p> <p>However, I discovered \"Events\" in MariaDB. MariaDB: Events</p> <p>The TLDR; You can schedule the query to execute directly in the database. This makes it portable. If you backup and restore your database elsewhere- the query/schedule goes with it.</p> <p>Creating the event, is quite easy.</p> <pre><code>CREATE EVENT delete_archiveforks_actions\nON SCHEDULE EVERY 1 MONTH\nSTARTS '2024-01-01 00:00:00'\nDO\nDELETE a\nFROM action a\nJOIN user u ON u.id = a.user_id\nWHERE u.name = 'ArchiveForks'\nAND a.op_type IN (18, 19, 20);\n</code></pre> <p>Full output:</p> <pre><code>git:~# mysql -D gitea\nmysql: Deprecated program name. It will be removed in a future release, use '/usr/bin/mariadb' instead\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\n\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection id is 448\nServer version: 11.4.4-MariaDB Alpine Linux\n\nCopyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMariaDB [gitea]&gt; CREATE EVENT delete_archiveforks_actions\n    -&gt; ON SCHEDULE EVERY 1 MONTH\n    -&gt; STARTS '2024-01-01 00:00:00'\n    -&gt; DO\n    -&gt; DELETE a\n    -&gt; FROM action a\n    -&gt; JOIN user u ON u.id = a.user_id\n    -&gt; WHERE u.name = 'ArchiveForks'\n    -&gt; AND a.op_type IN (18, 19, 20);\nQuery OK, 0 rows affected (0.004 sec)\nMariaDB [gitea]&gt; show events;\n+-------+-----------------------------+----------------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+\n| Db    | Name                        | Definer        | Time zone | Type      | Execute at | Interval value | Interval field | Starts              | Ends | Status  | Originator | character_set_client | collation_connection | Database Collation\n   |\n+-------+-----------------------------+----------------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+\n| gitea | delete_archiveforks_actions | root@localhost | SYSTEM    | RECURRING | NULL       | 1              | MONTH          | 2024-01-01 00:00:00 | NULL | ENABLED |          1 | utf8mb3              | utf8mb3_general_ci   | utf8mb4_uca1400_as_cs |\n+-------+-----------------------------+----------------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+\n1 row in set (0.003 sec)\n</code></pre> <p>And, honestly, thats it.</p>","tags":["Development","Development/Gitea"]},{"location":"blog/2024/gitea---slow-dashboard/#make-sure-the-event-scheduler-is-running","title":"Make sure the event scheduler is running","text":"<p>Before- calling it good- DO make sure your events scheduler is running.</p> <pre><code>SHOW PROCESSLIST;\n\n+-----+-----------------+-----------------+-------+---------+------+-----------------------------+------------------+----------+\n| Id  | User            | Host            | db    | Command | Time | State                       | Info             | Progress |\n+-----+-----------------+-----------------+-------+---------+------+-----------------------------+------------------+----------+\n| 441 | event_scheduler | localhost       | NULL  | Daemon  |  372 | Waiting for next activation | NULL             |    0.000 |\n| 448 | root            | localhost       | gitea | Query   |    0 | starting                    | SHOW PROCESSLIST |    0.000 |\n| 538 | gitea           | localhost:46298 | gitea | Sleep   |    1 |                             | NULL             |    0.000 |\n+-----+-----------------+-----------------+-------+---------+------+-----------------------------+------------------+----------+\n3 rows in set (0.000 sec)\n</code></pre> <p>If, you don't see <code>event_scheduler</code> then you need to enable it.</p> <pre><code>SET GLOBAL event_scheduler = ON;\n</code></pre>","tags":["Development","Development/Gitea"]},{"location":"blog/2024/gitea---slow-dashboard/#how-to-delete-the-event","title":"How to delete the event?","text":"<p>If, you wish to delete this event...</p> <pre><code>DROP EVENT delete_archiveforks_actions\n</code></pre>","tags":["Development","Development/Gitea"]},{"location":"blog/2024/gitea---slow-dashboard/#view-execution-history","title":"View execution history","text":"<p>This query will give you execution history: <code>SELECT * FROM INFORMATION_SCHEMA.events\\G</code></p> <pre><code>MariaDB [gitea]&gt; SELECT * FROM INFORMATION_SCHEMA.events\\G\n*************************** 1. row ***************************\n       EVENT_CATALOG: def\n        EVENT_SCHEMA: gitea\n          EVENT_NAME: delete_archiveforks_actions\n             DEFINER: root@localhost\n           TIME_ZONE: SYSTEM\n          EVENT_BODY: SQL\n    EVENT_DEFINITION: DELETE a\nFROM action a\nJOIN user u ON u.id = a.user_id\nWHERE u.name = 'ArchiveForks'\nAND a.op_type IN (18, 19, 20)\n          EVENT_TYPE: RECURRING\n          EXECUTE_AT: NULL\n      INTERVAL_VALUE: 1\n      INTERVAL_FIELD: MONTH\n            SQL_MODE: STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\n              STARTS: 2024-01-01 00:00:00\n                ENDS: NULL\n              STATUS: ENABLED\n       ON_COMPLETION: NOT PRESERVE\n             CREATED: 2024-12-26 19:56:48\n        LAST_ALTERED: 2024-12-26 19:56:48\n       LAST_EXECUTED: NULL\n       EVENT_COMMENT:\n          ORIGINATOR: 1\nCHARACTER_SET_CLIENT: utf8mb3\nCOLLATION_CONNECTION: utf8mb3_general_ci\n  DATABASE_COLLATION: utf8mb4_uca1400_as_cs\n1 row in set (0.001 sec)\n</code></pre>","tags":["Development","Development/Gitea"]},{"location":"blog/2025/git---delete-merged-branches/","title":"Git - Deleting Merged Branches","text":"<p>I use git for source control when writing these posts. Eventually- my local editor ends up with 50 branches which have already been merged into origin/main, and I end up needing to manually go through and remove the old branches.</p> <p>This, is a VERY short post, detailing how to create a git alias to automatically prune branches, which have been merged, or deleted on your remote.</p> <p>If- you don't need steps on how to create the alias, then here is the command:</p> <p><code>!git fetch -p &amp;&amp; git branch -vv | awk '/: gone]/{print $1}' | xargs git branch -D</code></p> <p>Otherwise, keep reading.</p>","tags":["Development","Development/Git"]},{"location":"blog/2025/git---delete-merged-branches/#solution","title":"Solution","text":"<p>A simple git alias.</p> <p>Step 1. Edit your .gitconfig</p> <p>On windows, <code>invoke-item ~/.gitconfig</code></p> <p>On linux, <code>edit/nano/vi ~/.gitconfig</code></p> <p>Step 2. Add the alias.</p> <pre><code>[alias]\n    fprune = !git fetch -p &amp;&amp; git branch -vv | awk '/: gone]/{print $1}' | xargs git branch -D\n</code></pre> <p>You can change fprune to any alias you would prefer instead.</p>","tags":["Development","Development/Git"]},{"location":"blog/2025/git---delete-merged-branches/#how-to-use","title":"How to use","text":"<p>Simple. Type <code>git fprune</code></p> <pre><code>PS C:\\Users\\XO\\source\\repos\\Web&gt; git fprune\nDeleted branch DIN-Mount-Closet-Part2 (was 83c7e5a).\nDeleted branch Garage-Part-1 (was 8cbd240).\nDeleted branch fix-broken-links (was 9b5f439).\nDeleted branch hoodcat-chronicles (was a5baab7).\nDeleted branch mikrotik-outbound-vpn (was 3484c85).\n</code></pre>","tags":["Development","Development/Git"]},{"location":"blog/2025/git---delete-merged-branches/#what-does-the-command-do","title":"What, does the command do??!?","text":"<p>First, lets break the command down into parts.</p> <p>Original Command: <code>!git fetch -p &amp;&amp; git branch -vv | awk '/: gone]/{print $1}' | xargs git branch -D</code></p> <p>Parts: 1. git fetch -p     - Fetch from remote. -p prunes branches which no longer exist on remote. 2. git branch -vv     - Lists branches in verbose. Verbose includes commit id, and status on remote. 3. awk '/: gone]/{print $1}'     - This selects branches where the remote is listed as \"Gone\" (aka, deleted / merged / etc)     - Then, it selects the first column, which is the branch's name. 4. xargs git branch -D     - This, more or less does, <code>xargs git branch -D your-branch-name</code>     - xargs takes the stdin, and passes as an argument to the command you provide.</p>","tags":["Development","Development/Git"]},{"location":"blog/2020/automated-holiday-lighting/","title":"Automate Holiday Lighting using Home Assistant","text":"<p>This week, I started installing WS2813 individually addressable LEDs around the house. I made a few simple patterns containing colors relevant to Thanksgiving and Christmas.</p> <p>After manually turning on the lights for the 3rd day in a row\u2026 I thought to myself\u2026 This is automatable. So- I started down the quest to make it happen.</p>","tags":["Home Assistant"]},{"location":"blog/2020/automated-holiday-lighting/#goals","title":"Goals","text":"<ol> <li>To automate turning on holiday lightning relevant to the next upcoming holiday.</li> <li>For Christmas- I want the christmas patterns to begin as soon as Thanksgiving is over.</li> <li>For Thanksgiving, I want its pattern to start a week before Thanksgiving.</li> <li>For Independence day, and St. patrick\u2019s day, I only want the relevant patterns to display on that specific holiday.</li> <li>In the future, I plan on putting addressable LED scripts on the exterior of my house. This solution needs to accommodate that.</li> </ol>","tags":["Home Assistant"]},{"location":"blog/2020/automated-holiday-lighting/#the-solution","title":"The Solution","text":"<p>First, I checked the built in integrations and sensors in Home Assistant. While you can hack up the work_day sensor to alert on specific holidays, it doesn\u2019t allow me to easily setup a script or automation which triggers the proper colors, based on the holiday.</p> <p>Personally- I try to avoid writing big, messy javascript lambdas as well.</p> <p>After doing some research, I stumbled upon the Calendarific integration in the HACs store.</p> <p>Out of the box, with minimal configuration, it offered the capabilities I required\u2026. namely, being able to create a sensor for the specific holiday, with a configurable \u201clead\u201d days.</p> <p></p> <p>Except from Calendarific github page. I started by following the directions posted in the above github article, and came up with this configuration.</p> <p>To note- the integration has a built-in, configurable method of indicating when a holiday is upcoming. This is configured by the days_as_soon parameter.</p> <p>To simplify configuration later, I specified the icon_soon as the same as icon_today. This way, I just need a single check to see if the icon_soon is set as \"mdi:calendar-star\" in my script.</p> Configuration.yaml<pre><code># https://github.com/pinkywafer/Calendarific\ncalendarific:\n  api_key: (your calendarific api key here)\n  # Country / State List: https://calendarific.com/supported-countries\n  country: (your country here, based on the above link.)\n  state: (your state here, based on the above link.)\n\nsensor:\n    # Calendarific documentation: https://calendarific.com/holidays/2020/us\n  - platform: calendarific\n    holiday: St. Patrick's Day  # March\n    days_as_soon: 0\n    icon_soon: mdi:calendar-star\n  - platform: calendarific\n    holiday: Independence Day   # June\n    days_as_soon: 0\n    icon_soon: mdi:calendar-star\n  - platform: calendarific\n    holiday: Thanksgiving Day   # November\n    days_as_soon: 8\n    icon_soon: mdi:calendar-star\n  - platform: calendarific\n    holiday: Christmas Day      # December\n    days_as_soon: 30\n    icon_soon: mdi:calendar-star\n</code></pre> <p>After saving the configuration and restarting Home Assistant, I created a simple \u201ctesting\u201d dashboard to show the sensor values:</p> <p></p> <p></p> <p>State display of one of the individual sensors. Since- the state is just the days until the specific holiday, this makes it very easy to automate. Next- I started the process of building a few scenes for the different holidays.</p> Scenes.yaml<pre><code>- id: holiday_thanksgiving\n  name: Holiday Lighting - ThanksGiving\n  icon: mdi:silverware-fork\n  entities:\n    light.livingroom_window_led:\n      state: on\n      brightness: 255\n      effect: ThanksGiving Scan\n- id: holiday_christmas\n  name: Holiday Lighting - Christmas\n  icon: mdi:pine-tree\n  entities:\n    light.livingroom_window_led:\n      state: on\n      brightness: 255\n      effect: Christmas Scan\n- id: holiday_independanceday\n  name: Holiday Lighting - Independence Day\n  icon: mdi:firework\n  entities:\n    light.livingroom_window_led:\n      state: on\n      brightness: 255\n      effect: custom # I have not made the custom pattern yet for this one...\n- id: holiday_stpattyday\n  name: Holiday Lighting - St Patricks Day\n  icon: mdi:gold\n  entities:\n    light.livingroom_window_led:\n      state: on\n      brightness: 125\n      effect: None\n      rgb_color:\n      - 0\n      - 255\n      - 0\n</code></pre> <p>Since I now have sensors for each holiday, and I have scenes for each holiday, it is time to build the script to trigger the proper scene\u2019s lighting.</p> <p>For the script, here is the basic idea.</p> <p>I use a Choose, which will only execute the first matching action. For the condition, I simply check each sensor, and look for the icon we configured for soon, or today. From the UI, it resembles this:</p> <p></p> <p>The UI designer for the choose statement to select the correct holiday. Do note- I specified the holidays in the order of which the year they occur. I did this- because in the criteria I set above.. of say, trigger christmas 30 days out-\u2026. If christmas occured before thanksgiving on the choose, it would be picked instead because. However, with the order set properly, as soon as thanksgiving is over, the christmas scene will be applied.</p> <p>Here is the full configuration for the script:</p> Automation Example YAML<pre><code>trigger_holiday_scene:\n  alias: Global - Holiday Lighting\n  icon: mdi:calendar\n  mode: single\n  sequence:\n  - choose:\n    - conditions:\n      - condition: state\n        entity_id: sensor.st_patrick_s_day\n        state: mdi:calendar-star\n        attribute: icon\n      sequence:\n      - scene: scene.holiday_lighting_st_patricks_day\n    - conditions:\n      - condition: state\n        entity_id: sensor.independence_day\n        state: mdi:calendar-star\n        attribute: icon\n      sequence:\n      - scene: scene.holiday_lighting_independence_day\n    - conditions:\n      - condition: state\n        entity_id: sensor.thanksgiving_day\n        state: mdi:calendar-star\n        attribute: icon\n      sequence:\n      - scene: scene.holiday_lighting_thanksgiving\n    - conditions:\n      - condition: state\n        entity_id: sensor.christmas_day\n        state: mdi:calendar-star\n        attribute: icon\n      sequence:\n      - scene: scene.holiday_lighting_christmas\n    default: [] # No holiday? No scene!\n</code></pre> <p>The only task to do now, is to schedule the lighting. For this, I will the \u201cScheduler Card\u201d and \u201cScheduler Component\u201c. I personally enjoy this card, because it gives a very simple, unified interface for creating schedules with simple conditions.</p> <p>To note- I put the above logic into a script, to make it reusable by multiple automations. If you have no such need, you can place the above logic into an automation instead.</p> <p>Here is the configuration:</p> <p></p> <p></p> <p>And- with that, the automation for triggering holiday lighting scenes is now complete.</p> <p></p> <p>The steps to add more holidays is pretty simple.</p> <ol> <li>Setup a calendarific sensor the additional holidays.</li> <li>Create a new \u201cLighting\u201d scene for the new holiday.</li> <li>Update your script/automation and add in the new condition/trigger scene.</li> </ol>","tags":["Home Assistant"]},{"location":"blog/2020/automated-holiday-lighting/#notes","title":"Notes","text":"<p>There is no need to use a seperate script and automation/trigger, if you don\u2019t wish for the additional flexibility. You can use a single automation to simplify.</p> <p>If you don\u2019t intend on having many devices in your scenes and you would like to simplify the configuration, you can instead put the actions directly inside of your script or automation.</p> <p>If you want to get fancier, you can also have different actions apply depending on IF it is the holiday, or if the holiday is upcoming. However, I do not currently require that functionality.</p>","tags":["Home Assistant"]},{"location":"blog/2020/automated-holiday-lighting/#update-2023-01-08","title":"Update - 2023-01-08","text":"<p>Wow, I can't believe this was written 2-3 years ago. This setup still works fantastically fine for me, the only real change- I have a lot more WLED devices laying around now.</p> <p>I will note, a few times a year, the calandarific api key will start fussing about my API key having fetched too many times. When this happens, I just rotate to another key I have laying around, and the error goes away for a few months.</p> <p>As well- this post was migrated over to the static site today.</p>","tags":["Home Assistant"]},{"location":"blog/2021/433mhz-automation/","title":"433 Mhz Temp / Humidity Sensors","text":"<p>How to get started with 433mhz based automation and sensors. </p> <p>This article, will provide the basic steps, for integrating 433mhz based sensors, using docker containers, and an RTL-SDR</p> <p></p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#why-i-recommend-433mhz-automation","title":"Why I recommend 433mhz automation?","text":"","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#what-are-the-benefits","title":"What are the benefits?","text":"<ol> <li>Battery life is measured in years. </li> <li>Range is exceptionally well, and not strongly affected by interior walls.</li> <li>Update frequency is generally every 15-30 seconds.</li> <li>The sensors are cheap, and easy to get on-boarded.</li> <li>This solution is extremely reliable.</li> </ol> <p>Lastly- it makes it very easy to create a dashboard showing the temp and humidity for every room inside your house.</p> <p></p> <p><sub>Note- all three of the above bedrooms, the livingroom, and outdoor sensors are 433mhz. The other various sensors are different technologies.</sub></p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#what-are-the-downsides","title":"What are the downsides?","text":"<ol> <li>You will need a dedicated RTL-SDR stick, and antenna (rabbit-ears are fine.).</li> <li>433mhz has no security. Anybody in range, with the proper equipement can see the measurements.<ul> <li>This- generally isn't a huge issue- as I don't too much care if others can see the various temp/humidity measurements from my property.</li> <li>The data has no personally identifable information. It looks like this:</li> </ul> </li> </ol> <pre><code>{\"time\":\"2022-11-19 16:49:55\",\"model\":\"Acurite-Tower\",\"id\":14824,\"channel\":\"C\",\"battery_ok\":1,\"temperature_C\":20.1,\"humidity\":45,\"mic\":\"CHECKSUM\"}\n</code></pre>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#required-hardware","title":"Required Hardware","text":"<ol> <li>RTL_SDR Radio \u2013 Around 20-40$<ul> <li>I personally used the RTL-SDR v3 however, they do not appear to be for sale anymore.</li> <li>The NooElec NESDR Mini 2 appears to be pretty popular now, with an extremely reasonable price.</li> </ul> </li> <li>433mhz Sensors<ol> <li>AcuRite 06002M Indoor / Outdoor Temp/Humidity Sensor<ul> <li>These are my top pick</li> </ul> </li> <li>AcuRite 606TX Indoor/Outdoor Temp Only<ul> <li>Cheaper than the 06002M, however, only transmits temp. No humidity.</li> </ul> </li> <li>AcuRite 00986M Fridge/Freezer Temp Only<ul> <li>I use these to monitor my fridge/freeze temps.</li> <li>Includes a magnetic display you can put on your fridge.</li> <li>Only recommended for fridge/freezer monitoring. Does not work above 100F.</li> </ul> </li> </ol> </li> </ol>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#installing-rtl_433","title":"Installing RTL_433","text":"<p>In order to convert the 433mhz message into MQTT messages, we will be leveraging the software, rtl_433.</p> <p>Depending on your environment, there are a few ways to go about setting this up. I will detail kubernetes, docker-compose, and home-assistant.</p> Docker ComposeKubernetesHome Assistant <p>This is the method I used for around two years to run rtl_433. Only recently did I switch everything over to Kubernetes. docker-compose.yaml<pre><code>  rtl_433:\n    image: hertzg/rtl_433:master\n    hostname: rtl_433\n    container_name: rtl_433\n    #command: '-Fmqtt://IP_OR_HOSTNAME_OF_MQTT_SERVER:MQTT_PORT,events=MQTT_TOPIC[/model][/id]'  \n    command: '-Fmqtt://mqtt:1883,events=rtl_433[/model][/id]'  \n    devices:\n      - /dev/bus/usb\n    ## Note, I Leverage cgroups to only pass through the specific RTL-433 stick.\n    ## I have left this section commented out for ease of use.\n    #device_cgroup_rules:\n    #  - 'a 189:* rwm'                                           \n    volumes:\n      - /etc/timezone:/etc/timezone:ro\n      - /etc/localtime:/etc/localtime:ro\n      - rtl_433:/etc/rtl_433\n    labels:\n      ## Enable watchtower automatic updates.\n      com.centurylinklabs.watchtower.enable: true\n    restart: unless-stopped\nvolumes:\n  rtl_433:\n    name: rtl_433\n</code></pre></p> <p>To note- I simplified the manifests to make this more accessible to new-comers. rtl_433.yaml<pre><code># Create a namespace\nkind: Namespace\napiVersion: v1\nmetadata:\n  name: rtl_433\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: rtl-433\n  namespace: rtl_433\nspec:\n  replicas: 1\n  serviceName: rtl-433  \n  selector:\n    matchLabels:\n      app: rtl-433\n  template:\n    metadata:\n      labels:\n        app: rtl-433  \n    spec:  \n      volumes:\n        ## Custom Configuration - Will need to uncomment to leverage a custom configuration.\n        #- name: config\n        #  configMap:\n        #    name: rtl-config\n        #    defaultMode: 420\n        - name: usb\n          hostPath:\n            path: /dev/bus/usb\n      containers:\n        - name: rtl-433        \n          image: hertzg/rtl_433:master\n          securityContext:\n            privileged: true  # This is required to pass in the host path containing the USB devices.... At least until Kubernetes has an easier way to do device passthrough.\n          args:\n            - '-Fmqtt://mqtt:1883,events=rtl_433[/model][/id]'    # NOTE- Replace mqtt:1883 with the IP/Hostname, and port of your MQTT server. \n          volumeMounts:\n            ## If you want to pass through a custom configuration, you will need to uncomment these lines.\n            #- name: config\n            #  mountPath: /etc/rtl-433\n            - mountPath: /dev/bus/usb\n              name: usb\n      nodeSelector:\n        # Requires rtl stick. (See below comments.)\n        #feature.node.kubernetes.io/custom-rtl: 'true'\n</code></pre> Regarding <code>feature.node.kubernetes.io/custom-rtl</code>, the line is commented out because I cannot assume everyone runs Node Feature Discovery (NFD).</p> <p>As such- I left the required label commented. If however- you need an example as to how my values.yaml are configured for the RTL-SDR stick- here is an excerp from my values.yaml used by the helm chart.</p> <p>I would highly recommend using NFD.</p> values.yaml<pre><code>  worker:\n    config:\n      sources:\n        custom:\n        - name: \"rtl\" # RTL2838 radio dongel\n          matchOn:\n            - usbId:\n                vendor: [\"0bda\"]\n                device: [\"2838\"]\n</code></pre> <p>If you wish to pass through a custom configuration file, you will need to uncomment the lines in the above manifest under volumes, and volume mounts. See the Example RTL_433 configuration file</p> rtl-config.yaml<pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: rtl-config\n  namespace: rtl_sdr\ndata:\n  rtl_433.conf: &gt;\n    # config for rtl_433\n\n    # A valid config line is a keyword followed by an argument to the end of line.\n    # Whitespace around the keyword is ignored, whitespace is space and tab\n    # Comments start with a hash sign, no inline comments, empty lines are ok.\n    #\n    # Boolean options can be true/false, yes/no, on/off, enable/disable, or 1/0\n    #\n    # All options will be applied in the order given, overwriting previous values\n    #\n    # Config files can be nested/stacked (use multiple -c and config_file = ).\n    #\n    # If no -c option is given the first found of this list will be loaded:\n    # - ./rtl_433.conf\n    # - ~/.config/rtl_433/rtl_433.conf\n    # - /usr/local/etc/rtl_433.conf\n    # - /etc/rtl_433.conf\n\n    ## General options\n\n    # as command line option:\n    #   [-v] Increase verbosity (can be used multiple times).\n    #        -v : verbose, -vv : verbose decoders, -vvv : debug decoders, -vvvv : trace decoding).\n    # 0 = normal, 1 = verbose, 2 = verbose decoders, 3 = debug decoders, 4 = trace decoding\n    #verbose\n\n    # as command line option:\n    #   [-c &lt;path&gt;] Read config options from a file\n    #config_file\n    ## Rest of this file is truncated. Please see the example file linked above.\n</code></pre> <p>rtl_433 Home Assistant Add-on</p> <p>I will note, there are two versions, one with auto-discovery, and one without.</p> <p>I personally, recommend not using auto-discovery, unless you don't mind having entities created for each tire on every other car driving down the road.</p> <p><sub>Tire pressure sensors typically leverage 433mhz to transmit information. If you live in a busy area- this can generate a lot of entities.</sub></p> <p>To note, I do not use this method, However- I have assisted multiple people with executing this method, and it works flawlessly.</p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#validate-rtl_433-is-working-properly","title":"Validate RTL_433 is working properly","text":"<p>Regardless of the above method utilized to install your rtl_433 container- you should connect to your MQTT broker, and verify the data is being properly received.</p> <p>I personally use MQTT Explorer to view my broker. Its small, simple, and fast.</p> <p>After connecting to your broker, you should see a topic named, \"rtl_433\"</p> <p></p> <p><sub>Note- the above image was edited to remove non-relavent topics to protect my privacy</sub></p> <p>If, you can see data coming into the topic- you are ready to move to the next section.</p> <p>However- if you cannot see data, I would recommend looking at the container's logs.</p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#configuring-home-assistant","title":"Configuring Home Assistant","text":"<p>Next up, we need to configure the sensors for home-assistant. Depending on the method you went with (docker,kubernetes,add-on), this section will be slightly different for you.</p> <p>This is because with the docker-compose / kubernetes route, I specified a custom format, which I believe was more suitable for this data.</p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#common-configuration","title":"Common Configuration.","text":"<p>If you are like me, you will wind up having a ton of sensors. I personally didn't want to bloat home-assistant's <code>configuration.yml</code>, So, for this example, we will leverage YAML's ability to include another file.</p> configuration.yaml<pre><code>mqtt:\n  sensor: !include mqtt_sensors.yaml\n  binary_sensor: !include mqtt_binary.yaml\n</code></pre> Docker-Compose / KubernetesHome-Assistant RTL_433 Addon <p>The format and configuration is the same between the above Docker and Kubernetes deployments.</p> <p>Example Events, in JSON Format</p> <p>Acurite Tower - Example Event rtl_433/Acurite-Tower/6731<pre><code>{\"time\":\"2022-11-19 18:33:51\",\"model\":\"Acurite-Tower\",\"id\":2888,\"channel\":\"B\",\"battery_ok\":1,\"temperature_C\":22.4,\"humidity\":42,\"mic\":\"CHECKSUM\"}\n</code></pre></p> <p>Acurite 606TX - Example Event (Note, no humidity) rtl_433/Acurite-606TX/164<pre><code>{\"time\":\"2022-11-19 18:33:58\",\"model\":\"Acurite-606TX\",\"id\":164,\"battery_ok\":1,\"temperature_C\":22.9,\"mic\":\"CHECKSUM\"}\n</code></pre></p> <p>First- we need to define the temp and humidity sensors.</p> mqtt_sensors.yaml<pre><code>  ## 6731 = Back Porch\n  - name: back_porch_temp                                 # Set your preferred name here.\n    state_topic: \"rtl_433/Acurite-Tower/6731\"             # This needs to match the path as seen in your MQTT server.\n    json_attributes_topic: \"rtl_433/Acurite-Tower/6731\"   # This, should match the state_topic above.\n    value_template: \"{{ value_json.temperature_C }}\"      # This should match the json attribute containing your temperature.\n    device_class: temperature               \n    unique_id: 6731_temp                                  # This value needs to be unique PER sensor.   \n    unit_of_measurement: '\u00b0C'                             # This needs to match the measurement as seen in your MQTT events. You change your performance preference within Home-Assistant's GUI.\n    expire_after: 600                                     # After 10 minutes of no-data, report as unavailable.\n\n  - name: back_porch_humidity                             \n    state_topic: \"rtl_433/Acurite-Tower/6731\"\n    json_attributes_topic: \"rtl_433/Acurite-Tower/6731\"\n    value_template: \"{{ value_json.humidity }}\"\n    device_class: humidity\n    unique_id: 6731_humidity\n    unit_of_measurement: '%'                               # '%' is the unit of measurement for humidity.\n    expire_after: 600\n\n\n  ## Note- if you have the Acurite-606TX, you will only define a sensor for temperature.\n  - name: random_temp\n    state_topic: \"rtl_433/Acurite-606TX/14\"\n    json_attributes_topic: \"rtl_433/Acurite-606TX/14\"\n    value_template: \"{{ value_json.temperature_C }}\"\n    device_class: temperature\n    unique_id: 14_temp\n    unit_of_measurement: '\u00b0C'\n    expire_after: 600\n</code></pre> <p>The Acurite sensors report battery information back as \"battery_ok\", with a value of 1 for yes, or 0 for no. We will</p> mqtt_binary.yaml<pre><code>- name: back_porch_battery_ok                               # Unique name for this sensor\n  state_topic: \"rtl_433/Acurite-Tower/6731\"                 # Needs to match the json topic name\n  json_attributes_topic: \"rtl_433/Acurite-Tower/6731\"       # Needs to match the json topic name\n  value_template: \"{{ value_json.battery_ok }}\"             \n  payload_off: 0  \n  payload_on: 1\n  unique_id: 6731_battery                                   # Unique value for this sensor.\n</code></pre> <p>And- thats it. </p> <p>Since I leverage JSON format when using either the Docker or Kubernetes deployment, and the home-assistant addon does not- we will need to do our configuration slightly different.</p> <p>Since-I do not leverage this method- I do not have any example events to share.</p> mqtt_sensors.yaml<pre><code>- name: Outdoor Temperature                                                           # Friendly name for your sensor\n  state_topic: \"rtl_433/74930c0d-rtl433/devices/Acurite-Tower/A/2415/temperature_C\"   # This needs to match the state topic containing the temp.\n  device_class: temperature\n  object_id: outdoortemp_temp                                                         # Needs to be unique\n  unique_id: outdoortemp_temp                                                         # Needs to be unique\n  unit_of_measurement: \"\u00b0C\" \n  expire_after: 600\n- name: Outdoor Humidity\n  state_topic: \"rtl_433/74930c0d-rtl433/devices/Acurite-Tower/A/2415/humidity\"        # This needs to match the state topic containing the humidity.\n  device_class: humidity\n  object_id: outdoorhum_temp\n  unique_id: outdoorhum_temp\n  unit_of_measurement: '%'\n  expire_after: 600\n</code></pre> <p>The Acurite sensors report battery information back as \"battery_ok\", with a value of 1 for yes, or 0 for no. We will</p> mqtt_binary.yaml<pre><code>- unique_id: garagefreezer_battery_ok                                                # Must be a unique name.\n  state_topic: \"rtl_433/74930c0d-rtl433/devices/Acurite-986/1R/49691/battery_ok\"     # This needs to match the state topic for \"battery_ok\"\n  name: Garage Freezer Battery                                                       # Put a friendly name here.\n  device_class: battery\n  payload_off: 1\n  payload_on: 0\n</code></pre>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#conclusion","title":"Conclusion","text":"<p>At this point, you are all done. After restarting home assistant, or reloading its MQTT configuration- you should have working sensors within Home-Assistant.</p>","tags":["433mhz"]},{"location":"blog/2021/433mhz-automation/#history","title":"History","text":"<p>This post was migrated from my Wordpress Site. The original post was written in Jan, 2021.</p> <p>Since creating the orignal post, all of my sensors have been working flawlessly.</p> <p>I did- however, leave out the section on the Sonoff RM433, as I have not found it very useful.</p> <p>You may also want to check out the original Fridge / Freezer Monitoring Post for more information.</p>","tags":["433mhz"]},{"location":"blog/2021/fireplace-automation---part-3/","title":"Fireplace Automation - Part 3","text":"<p>The goal of this article, is to simplify everything as much as possible. Simpler automation, is more reliable automation generally.</p> <p>A few years ago, I automated my natural gas fireplace to automatically turn on and turn off to keep my house at a consistent temperature. This allows me to save a lot of energy by not heating the entire house during the day, and only heating the main living areas. As well, it also saves the electricity from running the blower fan.</p> <p>Well, Today, I also updated my HVAC systems to Z-Wave.</p> <p>If you have not seen the articles, here are links:</p> <p>Fireplace Automation \u2013 Part 1 \u2013 Building a esphome device, and using naive node-red automation to control it.</p> <p>Fireplace Automation \u2013 Part 2 \u2013 Updating the automation for better \u201cpresence\u201d detection, and using a template thermostat.</p> <p>Updating my HVAC to Z-Wave \u2013 Replacing my Cloud/Wifi thermostat with z-wave, and replacing my fireplace\u2019s electronics with a z-wave relay.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/fireplace-automation---part-3/#updating-the-presence-detection","title":"Updating the \u201cPresence Detection\u201d","text":"<p>In Part 2 of the fireplace automation, I used individual automations to both turn on, and turn off the fireplace automation. I am going to consolidate all of the logic into a single template binary_sensor. This will replace multiple automations.</p> configuration.yaml<pre><code>template:\n- binary_sensor:\n    - name: hvac_presence_detection\n    state: &gt;\n        {{\n        (\n            is_state('light.livingroom_ceiling_light', 'on')\n            or is_state('fan.ceiling', 'on')\n        )\n        and is_state('group.all_people', 'home')\n        and is_state('input_boolean.mode_vacation', 'off')\n        and\n        (\n            is_state('climate.thermostat', 'heat')\n            or is_state('climate.thermostat', 'heat_cool')\n        )\n        }}\n</code></pre> <p>The above template sensor, looks for a few conditions.</p> <ol> <li>One of the devices in the living room must be on. At the time of writing this, my TV relies on the smartthings integration which I have recently removed due to numerous issues. So, for now, you must have a light turned on to have heat.</li> <li>Next- SOMEBODY has to be at home, using the home assistant presence detection. group.all_people consists of me &amp; my wife\u2019s android phones with the home assistant app.</li> <li>Next- vacation mode must be off. This is a helper which I can toggle on, when we are away for extended periods of time.</li> <li>Lastly, the thermostat must be in either \u201cheat\u201d or \u201cheat_cool\u201d mode.</li> </ol> <p>By creating this template sensor, it allows me to trigger on its state to clean up the other automations.</p> <p>Next, I built a single automation to replace the \u201cEnable / Disable\u201d fireplace automations used previously.</p> <p>All it does, is either turn the climate entry for the fireplace on or off, based on the template sensor. Thats it.</p> <p>Since the template sensor has conditions built in for vacation, presence detect, and HVAC mode, there is no reason to repeat the logic here.</p> <pre><code>alias: 'HVAC: Fireplace Enable/Disable'\ndescription: Toggles the fireplace on and off based on presence detection\ntrigger:\n  - platform: state\n    entity_id: binary_sensor.hvac_presence_detection\ncondition: []\naction:\n  - choose:\n      - conditions:\n          - condition: state\n            entity_id: binary_sensor.hvac_presence_detection\n            state: 'on'\n        sequence:\n          - service: climate.turn_on\n            target:\n              entity_id: climate.fireplace\n    default:\n      - service: climate.turn_off\n        target:\n          entity_id: climate.fireplace\nmode: single\n</code></pre> <p>Next up, the climate.fireplace entity has not been changed since part 2, other then updating the entity IDs to match the new z-wave ids.</p> <pre><code>climate:\n  - platform: generic_thermostat\n    name: Fireplace\n    heater: switch.fireplace_gas\n    target_sensor: sensor.thermostat_air_temperature\n    min_temp: 60\n    max_temp: 90\n    ac_mode: false\n    target_temp: 0\n    cold_tolerance: 0.3\n    hot_tolerance: 0.5\n    min_cycle_duration:\n      minutes: 2\n    keep_alive:\n      minutes: 3\n    initial_hvac_mode: \"off\"\n    away_temp: 16\n    precision: 1.0\n</code></pre> <p>At this point, we have all of the automations needed to turn the fireplace on and off, when somebody is home, and likely in the living areas. The only remaining piece to do now, is to sync the temperature.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/fireplace-automation---part-3/#syncing-temperature","title":"Syncing Temperature","text":"<p>To handle this, I have a simple automation based on the thermostat\u2019s setpoint. When the setpoint changes, this automation kicks off. These automations utilize the number helper created previously, to tell the fireplace how many degrees above the thermostat setpoint to use. The way this works- I typically set the main thermostat two degrees under the value I actually want it to use, and I keep the fireplace setpoint helper set to \u201c2\u201d.</p> <pre><code>-- When the thermostat is in \"HEAT\" mode:\nservice: climate.set_temperature\ndata_template:\n  entity_id: climate.fireplace\n  temperature: |\n    {{  float(\n      state_attr('climate.thermostat','temperature') | float +\n      states(\"input_number.fireplace_setpoint_increase\")  | float \n      ) \n    }}\n  hvac_mode: heat\n-- When the thermostat is in \"HEAT_COOL\" mode (Includes a tiny amount of additional logic to ensure we don't kick the A/C on.)\nservice: climate.set_temperature\ndata_template:\n  entity_id: climate.fireplace\n  temperature: &gt;\n    {% if (float(state_attr('climate.thermostat', 'target_temp_low')) +\n    float(states(\"input_number.fireplace_setpoint_increase\"))) &lt;\n    float(state_attr(\"climate.thermostat\", 'target_temp_high')) %}\n      {{ float(state_attr('climate.thermostat','target_temp_low') + float(states(\"input_number.fireplace_setpoint_increase\"))  ) }}\n    {% else %}\n      {{ float(state_attr('climate.thermostat','target_temp_high') - 2) }}\n    {% endif %}\n  hvac_mode: heat\n</code></pre> <p>The only other piece to this, besides my dashboards, is an automation for cycling the central heat.</p> <p>Last year, while working from home during some of the colder weather, I noticed, it can get pretty chilly back here in my office.</p> <p>So, I built a simple script, which turns the fireplace off for a couple of hours, and turns the main thermostat up a few degrees to heat up the office. After the office gets up to the desired temperature, it kicks off. I can also rely on the central HVAC\u2019s fan to circulate a bit of heat back here as well.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/fireplace-automation---part-3/#summary","title":"Summary","text":"<p>That was it- This was just intended to be a simple explanation regarding how the automation for my fireplace is configured. </p> <p>As of me migrating this post from wordpress to this static site in 2023, this automation has been running more or less untouched. The only real difference- I no longer have any dependency on cloud-based tools or services now. So, no more smart things. </p> <p>And- I disabled the automation to sync the temp. The fireplace is now just statically configured between 70 and 72 degrees, and the main thermostat STAYS set around 64 during the day, and 58 at night.</p> <p>If we feel cold, we just turn it up a degree or two using the home-assistant app.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/","title":"Full local Z-Wave HVAC Control","text":"","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#introduction","title":"Introduction","text":"<p>My house has had a Emerson Sensi thermostat for the last 6 or 7 servers. While, this thermostat has served its purpose, and worked reliably (locally), I have had the ongoing issue of having to integrate it into my Home Assistant by using it through the Smart Things Integration. This cloud integration randomly stops working, and does not give very much warning regarding its status.</p> <p>Normally, this wouldn\u2019t be a huge issue, but, a few years back, I automated my fireplace. So, my fireplace will kick on during the day, to avoid heating the entire house, saving energy. Since, the fireplace bases its temp on the MAIN thermostat located in the center of the house, its important to have somewhat accurate details.</p> <p>So, I have decided to upgrade both the fireplace, as well as my thermostat, to leverage z-wave.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#parts-tools-needed","title":"Parts / Tools Needed","text":"","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#products-used","title":"Products Used","text":"<ol> <li>Zooz Z-Wave Plus Relay<ul> <li>I chose this option, because it has three inputs, and three relay outputs, and works via z-wave. While, it doesn\u2019t have any fancy features, it is simple, small, and self-contained.</li> </ul> </li> <li>Honeywell T6 PRO Z-Wave<ul> <li>There are not too many good z-wave thermostat options. I did not want a thermostat which looked like it came from the 1990s (Sorry GoControl Thermostat!). I did want to retain the ability to set a M-F + S+S weekly schedule, with the ability for HEAT, COOL, and AUTO scheduling. Those features have been amazing to have on the Sensi thermostat. The honeywell met all of the required criteria, so, I went with it.</li> </ul> </li> <li>WAGO connectors<ul> <li>A few years ago, I would called you crazy for telling me there is a better alternative then using screw nuts. Well, having used these connectors a handful of times, I am now telling you- they are nice, easy, and secure. If you have wiring you wish to reuse, these are even better.</li> </ul> </li> </ol>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#tools-required","title":"Tools Required","text":"<ol> <li>A phillips screwdriver</li> <li>A flat-head screwdriver</li> <li>A multi-meter.</li> </ol>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#installation","title":"Installation","text":"","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#thermostat-install","title":"Thermostat Install","text":"<p>The first step I took, was to replace my old thermostat, with the new thermostat.</p> <p>Caustion</p> <p>You should turn off power before performing work on your system. Even better- you should hire a licensed HVAC technician. The common wire DOES carry current, and CAN shock you. If you are not licensed to work on HVAC or electrical equipment, you should certainly hire a licensed professional.</p> <p>As you can see in the image, there was nothing overly fancy about the old thermostat.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-1-remove-the-old-thermostat","title":"Step 1. Remove the old thermostat","text":"<p>In my case, you grab it, and lift it off of its base-plate.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-2-loosen-all-of-the-wires-and-remove-the-old-base-plate","title":"Step 2. Loosen all of the wires, and remove the old base plate.","text":"<p>Using a small screwdriver, loosen the screws retaining the wires, carefully remove the fires, and then remove the baseplate from the wall.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-3-install-the-new-base-plate","title":"Step 3. Install the new base plate.","text":"<p>Since the existing holes were in the correct location, I reused them. This is a good time to check and ensure the baseplate is properly level. If this is not level, your thermostat will not be level. As well, your significant other, will remind you, it is not leveled.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-4-install-the-wiring-guide","title":"Step 4. Install the \u201cWiring guide\u201d","text":"<p>DEPENDING on your HVAC configuration (Typical, Heat-Pump, Multiple-Stages, etc\u2026.) your wiring will be different.</p> <p>I have a conventional system. It has these wires to be connected:</p> <ol> <li>Yellow: A/C Compressor</li> <li>White: Heating Relay (Turns on my natural gas furnace)</li> <li>Black: Common.</li> <li>Red: 24VAC</li> <li>Green: Fan</li> </ol> <p>Warning</p> <p>Do ensure you have 24VAC between RED and Black. If your voltage is out of tolerance, and you connect the new thermostat, you may damage it!!!</p> <p>If you do not know what you are doing, then you should call a licensed professional to do this step for you.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-5-install-the-new-thermostat","title":"Step 5. Install the new thermostat","text":"<p>Just slap it into place! Don\u2019t forget to put the new batteries in!</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-6-setup-and-configure-your-new-thermostat","title":"Step 6. Setup and configure your new thermostat.","text":"<p>In the case of my new thermostat, I followed the manufacturer\u2019s documentation to configure the thermostat to my specific requirements. This entailed configuration of the date and time, my HVAC system\u2019s requirements, enabling \u201cAuto\u201d mode, and lastly, setting the scheduling system to M-F, S+S</p> <p>As well, this is a good time to include your new thermostat into your z-wave setup.</p> <p></p> <p>For me, this was as simple as starting an exclusion, and following the manufacturer\u2019s documentation for the thermostat. Note- you WILL need to ensure it is joined with security (S2). If you do not join it in secure mode, its operation will be limited to read-only. For me, with ZWaveJS2MQTT, this happened automatically, and by default.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-7-admire-your-new-thermostat","title":"Step 7. Admire your new thermostat.","text":"<p>I hope you leveled it!</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#fireplace-conversion","title":"Fireplace Conversion","text":"<p>If, you have not read my previous posts, this is a good time to check them out. </p> <p>TLDR; My fireplace is controlled automatically by home assistant.</p> <p>Fireplace Part 1</p> <p>Fireplace Part 2</p> <p>My previous setup worked nearly perfectly last year. The only issues were related to smart things occasionally \u201cnot working\u201d. Since, my setup depends strongly on the thermostat\u2019s configuration, it is important that I can communicate with it.</p> <p>Also, sometime since last year, my ESP controller died. I don\u2019t know if it was due to a failed firmware update, or dust\u2026.. but, since I accidentally epoxied over the USB port, I just tossed it into the trash\u2026.. and replaced it with a Zooz Z-Wave Plus Relay.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-1-obtain-a-z-wave-dry-contact-relay","title":"Step 1. Obtain a z-wave DRY-CONTACT relay","text":"<p>Dry-contact is the key-word here. A Mains-relay, will not work. You need separate, individual relays.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-2-identify-the-mess-under-your-fireplace","title":"Step 2. Identify the mess under your fireplace","text":"<p>On the left, is the gas control valve. On its left, you have cables coming in for the thermophile, and a thermoprobe. The thermopile is responsible for generating a small amount of current for togging the flow of gas on and off. If your fireplace has issues remaining lit, you may need to replace your thermopile.</p> <p>Last year, I had to replace mine with this one for under 20$, and it solved a lot of my issues.</p> <p>Next- there is a switch at the bottom of the control block. This switch, toggles the fireplace between \u201cON\u201d, \u201cOFF\u201d, and \u201cREMOTE\u201d. For controlling it via external automation, we will leave this to the \u201cREMOTE\u201d position.</p> <p>The Red/Green wires you see, going into my old relay setup, are used to control remote operation. When the wires are connected to each other, current flows through, turning the gas flow on. When current stops, gas flow stops.</p> <p>Next, you will see a Sonoff Basic in place, which was used to control the fan on my fireplace. Since the new Zooz z-wave module has three relay outputs, I will be replacing it.</p> <p>Danger</p> <p>Your fan typically uses 110v AC. If you don\u2019t know what you are doing, CALL A LICENSED PROFESSIONAL! This can shock and/or kill you.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-3-unbox-your-new-solution","title":"Step 3. Unbox your new solution","text":"<p>The new solution requires USB-C power plug.</p> <p>Info</p> <p>Per the documentation, do not use a \u201cLAPTOP or Tablet\u201d charger. I used the existing 1 amp USB plug which was already in place from my old ESP-device.</p> <p>As you can see, there are three relays on the left, and three switch inputs on the right.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-4-replace-the-old-with-the-new","title":"Step 4. Replace the old, with the new","text":"<p>In my case, this involved removing both the sonoff, and my old ESP-based controller.</p> <p>One minor difference in wiring- The sonoff has both HOT(Black), and COMMON(White) passing through. With the new relay, we are only going to be switching the \u201cHOT\u201d wire. I used a wago connector to tie the common wires together, and inserted both HOT wires into the sockets marked \u201cR2\u201d.</p> <p>I also placed the RED/GREEN \u201cRemote\u201d wires for the gas control, into the sockets marked \u201cR1\u201d.</p> <p>Since, this is a dry-contact relay, order does not matter. Just- don\u2019t mix up the pairs or something will release magic smoke.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#step-5-admire-the-new-solution","title":"Step 5. Admire the new solution","text":"<p>Ok, it\u2019s pretty dirty and dusty down there. And the cables are a bit of a mess. So, perhaps I shouldn\u2019t admire it.</p> <p>But, this is a good time to join your device to your z-wave network.</p> <p>Ensure your USB-C cable is plugged into a power source (Not a laptop or tablet) Set your z-wave network into \u201cInclusion\u201d mode. Press the button on the zooz three times fast. Poof, its connected.</p> <p></p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#configuration-of-your-automation","title":"Configuration of your automation","text":"<p>But wait, there\u2019s more! You now need to update your home automation with these new devices! For me, using home assistant and zwavejs2mqtt(zwavejs now, as of 2023), this was performed automatically. The only action I took, was renaming the create entities to be a bit more descriptive.</p> <p>As well, I removed the old entities, and updated the configurations to use the new entities.</p> <p>To fully migrate everything from my old thermostat, to my new thermostat, was quite easy. I deleted the old integration, and renamed the new device to match the name of the old device, \u201cThermostat\u201d. Since, both the old and new were of the \u201cclimate\u201d device-type, everything automatically worked. Since the new z-wave integration automatically creates sensors for temp and humidity, I was able to remove my template-based sensors for the old integration.</p> <p>As well, when configuring the zooz, I set the \u201cpower-failure\u201d action to default all relays to \u201cOFF\u201d</p> <p></p> <p>Make sure your relays are configured for \u201cSwitch\u201d</p> <p></p> <p>You can also set auto-on/off timers if desired. However, I plan to manage this via the thermostat template.</p> <p>I don\u2019t plan on writing an article for the minor differences to convert from the old entities to the new\u2026 Its mostly just updating entity names. I lied- if you want to see some of the updates, then check out \u201cFireplace Automation \u2013 Part 3\u2033</p> <p>If you need a easy method to configure your schedules, Check out THIS GUIDE</p> <p>Have fun!</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#update-from-2023","title":"Update from 2023","text":"<p>If- you are reading this now- I finally updated this post from wordpress to the new static site.</p> <p>To give you an update after nearly two years-</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#honeywell-t6-pro","title":"Honeywell T6 Pro","text":"<p>I do not have a single issue at all to report for this thermostat. It works consistently as expected. I have not even had it disconnect from my network.</p> <p>So far, it has had 100% reliability. My automation, has been working without fail for the past two years.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#zooz-relay-fireplace-automation","title":"Zooz relay / fireplace automation","text":"<p>This is one of the most frequently used automations in my house. </p> <p>Being as this automation controls a critical appliance (It makes fire. In my living areas), it is extremely crucial for it to work properly.</p> <p>And- it has been rock solid. For the past two years, this automation has produced basically all of the heat in my house from the hours of 6am, to 11pm at night. (The central heater runs at night)</p> <p>The ONLY issue I have had with this automation- The pilot light on my fireplace likes to blow out every few weeks. Due to the mechanical safety devices on my fireplace the gas flow will be shutoff. So, the only impact here, is needing to manually go light the pilot again.</p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2021/full-local-z-wave-hvac-control/#disclaimers","title":"Disclaimers","text":"<p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["HVAC","Z-Wave","Home Assistant"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/","title":"First Alert Z-Wave Combo CO/Smoke Detector","text":"<p>This is a simple review, with a few steps for the First Alert Z-Wave CO/Smoke detectors.</p> <p></p>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#where-to-buy","title":"Where to buy","text":"<ul> <li>Purchase on Amazon</li> </ul> <p>Around 40$ a piece, these are a tad expensive for a smoke detector solution, however, I do enjoy having some central management.</p> <p>Note- Make SURE to get the 2nd generation. The 2nd generation is much easier to setup automations for, and supports SmartStart, and a few other features.</p>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#why-would-you-buy-this","title":"Why would you buy this?","text":"<p>If you have hard-wired alarms already, I wouldn\u2019t purchase this.</p> <p>These are useful for when you don\u2019t have a already hard-wired detector system. These alarms do not communicate with each other, so, if one goes off, the rest won\u2019t go off either. Many fire codes requires alarms to sync with each other now.</p> <p>If your goal is for alarms to sync with each other, these aren\u2019t the best pick. For me, my house is relatively small, which means you can hear any alarm, anywhere in the house quite easily.</p> <p>The main reason I picked up these units, is to enable some integration with the rest of my home automation.</p>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#what-can-you-accomplish-with-home-automation","title":"What can you accomplish with home automation?","text":"<ol> <li>View battery status in a central location. Setup alerts for batteries getting low.</li> <li>If either smoke or CO is detected, you can integrate this into your automation as well, to send alerts, call the fire dept, etc. I also have notifications setup to be sent to my phone.</li> </ol>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#what-are-my-opinions","title":"What are my opinions?","text":"<ol> <li>The battery status is a bit weird. I have found, you want to change the batteries when z-wave starts reporting battery status around 80% or less. This is the point where the detectors starts to beep, alerting you to low battery.</li> <li>Battery life is good, I got a bit over a year out of the original batteries before needing to swap them.</li> <li>Getting these units to pair, was a bit tricky. However, working steps are below.</li> <li>There is no way to trigger, or mute alerts via z-wave.</li> <li>Be prepared for these units to \u201csleep\u201d most of the day. Don\u2019t expect any frequent communication unless these units are being triggered.</li> <li>The Smoke detection does work, as my cooking has no issues triggering these units.</li> <li>As well, the CO detection feature works as well.</li> </ol>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#how-to-pair-these-to-your-z-wave-network","title":"How to pair these to your z-wave network","text":"<ol> <li>If you use smartstart, go ahead and scan the QR code and add it.</li> <li>Hold the button down for 20 seconds.<ul> <li>Its going to beep a few times, followed by a siren for a while\u2026. and eventually, it will beep again, and go quiet. You can let off the button after this.</li> <li>This step, is supposed to reset the unit.</li> </ul> </li> <li>Remove the battery tray</li> <li>Wait 30 seconds. This is important.</li> <li>You can go ahead and start inclusion mode IF, your z-wave does not support smart start.<ul> <li>If you do have smartstart, and you have already scanned the code, you don\u2019t have to do anything on this step.</li> </ul> </li> <li>HOLD THE BUTTON</li> <li>Reinsert the battery tray, while holding the button.</li> <li>Keep holding the button\u2026. for about 10 seconds, until you hear a long BEEP.</li> <li>Let off the button.</li> <li>The unit will now join your network.</li> </ol> <p>I posted these steps, because\u2026 I had a lot of trouble getting some of these units to join my network. Some would instantly join without issues. Others, absolutely refused to join. These above steps, worked 100% of the time with my 6 units.</p>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/first-alert-z-wave-combo-cosmoke-detector/#my-review-a-year-later","title":"My review a year later?","text":"<p>While- not quite a year later (8 months to be exact), I do like these units, compared to other battery-powered units.</p> <p>When I start hearing a beep, I can easily look at the battery status to determine exactly which detector is beeping. This is fantastic.</p> <p>One note, don't use rechargable batteries with these units... Unless you like hearing beeping noises.</p>","tags":["Reviews","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/","title":"Hidden door sensors","text":"<p>The default directions for installing doors sensors, involves using the included double-sized tape directly stick the sensor to doors and windows.</p> <p>I personally, wanted these sensors to be out of sight, and out of mind. So, I decided to recess them into the doors themselves.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/#parts-components-needed","title":"Parts / Components Needed","text":"","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/#contact-sensors","title":"Contact Sensors","text":"<ol> <li>Ring Alarm Contact Sensor - 6 Pack</li> </ol> <p>There are MANY options for contact sensors. My only real requirement was z-wave, and ideally, a long-battery life. I figure ring doesn\u2019t stay in business giving out contact sensors with a one month battery life. At the time of me writing this, it costed me 100$ for 6 contact sensors, which works out to about 15$ each.</p> <p>While, that sounds expensive, your typical sensor is around 20$ a piece if you order individually. So, while there are cheaper options, there aren\u2019t really cheaper options I found which are as well known.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/#coin-magnets","title":"Coin Magnets","text":"<p>For my door sensors, I want them completely recessed, invisible, out of sight, and out of mind. I am going to use a simple coin magnet recessed into the trim to accomplish this.</p> <ol> <li>Cheap coin magnets</li> </ol> <p></p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/#steps","title":"Steps","text":"<p>First, I used a 9/16\u2033 drill bit to hollow out a cavity in the top of the door. I used a wood chisel, hammer, and screwdriver to clean up the opening a bit. A router would be the preferred tool for this job\u2026 However, I do not have one.</p> <p>After making a cavity for the z-wave sensor, I recessed it into the door. The space was tight enough so that it was not required to use adhesives or hardware to hold it into place.</p> <p></p> <p>Next, I used a drill bit the same size as the coin cell magnets used, to drill a tiny recess into the door frame.</p> <p>I ended up using three magnets stacked on top of each other, as one was not powerful enough to account for the small gap.</p> <p>After making this hole, I press-fit the magnets. In the future, I will come back and epoxy them into place, and paint them to match the door frame.</p> <p>** Update, 2022-12-10, I have not yet had the need to use any adhesive to further secure the magnets.</p> <p></p> <p>With three magnets stack on top of each other, it has no issue accounting for the gap between the door and the frame. I could further recess both the magnets, and the sensor. However, it\u2019s basically unnoticeable unless you are on a ladder looking at the top of my door.</p> <p></p> <p>Overall, my first time putting up a door contact sensor. And, well, it works perfectly. If the alarm is armed, it will basically go off instantly upon opening the door.</p> <p>On my second attempt, I relied on the chisel more then the drill, which made a nicer pocket.</p> <p></p> <p>Sensor is hidden pretty well.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/embedded-door-sensors/#conclusion","title":"Conclusion","text":"<p>Since, installing these recessed sensors into all of the entry / exit locations in my house in April 2022, As of Dec 2022, these sensors are still working perfectly, with no issues at all.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/","title":"Home Assistant Alarm","text":"<p>So, you want to have an alarm for your house. But, you don\u2019t want to give your money to ADT/Ring/SimpliSafe/etc\u2026 and you want to build it yourself, with components you can easily service and replace, right? If so, this is the article for you.</p> <p>If you prefer for someone else to do all of the work, or you want a solution that just \u201cworks\u201d without any tweaking, you should look at other options perhaps. The process to get everything up and running is not hard at all. Quite easily as a matter of fact. But, there are a few mildly technical steps.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#parts-components-needed","title":"Parts / Components Needed","text":"","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#700-series-z-wave","title":"700 Series Z-Wave","text":"<p>A 700 series z-wave stick supporting Smart Start is recommended. S2 Security is required to get the ring keypad joined to your z-wave network. Without S2 security, you will not be able to add a few of the components.</p> <ol> <li>Zooz 700 Series</li> <li>Aeotec Z-Stick 7</li> </ol> <p> </p> <p>I personally went with the Zooz 700 series stick, because at the time (4/16/2022), it was nearly half the price.</p> <p>In this post, I will also be detailing the process of updating its z-wave firmware, AND replacing my existing HUSBZB-1 stick, without having to rejoin all of my devices. (There IS a firmware update to enable 700-series features, however, the process was more in-depth then I wanted to undertake\u2026)</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#alarm-keypad","title":"Alarm Keypad","text":"<p>You ideally, need a keypad for arming / disarming your alarm. Optionally, you can also leverage a kiosk with an alarm display, however, I do enjoy physical buttons.</p> <ol> <li>Ring Alarm Keypad (2nd Gen)</li> </ol> <p></p> <p>I went with this option, because the price was good, it looks nice, and, it is easily mounted.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#contact-sensors","title":"Contact Sensors","text":"<ol> <li>Ring Alarm Contact Sensor - 6 Pack</li> </ol> <p>There are MANY options for contact sensors. My only real requirement was z-wave, and ideally, a long-battery life. I figure ring doesn\u2019t stay in business giving out contact sensors with a one month battery life. At the time of me writing this, it costed me 100$ for 6 contact sensors, which works out to about 15$ each.</p> <p>While, that sounds expensive, your typical sensor is around 20$ a piece if you order individually. So, while there are cheaper options, there aren\u2019t really cheaper options I found which are as well known.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#installation-setup","title":"Installation / Setup","text":"","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-1-upgradereplace-your-existing-z-wave-stick","title":"Step 1. Upgrade/Replace your existing z-wave stick.","text":"<p>Since, 700 series z-wave is required for using S2 security, I will be replacing my current z-wave stick. If you do have a Nortek HUSBZB-1 stick, and would like to undertake the process of updating its firmware, there is a guide HERE. However, I will be completely rebuilding my network.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#why-did-i-rebuild-my-network","title":"Why did I rebuild my network?","text":"<p>Well, quite simply, I failed at doing a in-place replacement. The nortek did not support NVM backups, and in the process of\u2026 \u201creplacing\u201d it, I ended up with a z-wave network where I could not \u201cshift\u201d to the new master. Hopefully, your luck is better then mine. But, in either case, the absolute worst case scenario, is having to rebuild your network. As long as you have S2 QR codes, this process actually isn\u2019t too bad.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#updating-firmware","title":"Updating Firmware","text":"<p>Why do we need to update the firmware? See the below alert issued by Home Assistant.</p> <p>If you don\u2019t update the firmware, there is a chance your network could become unresponsive.</p> <p></p> <p>Since, I purchased the Zooz 700 Series stick, the below instructions will be for it specifically. However, if you went with the Aeotec Z-Stick 7, you can find the relevant documentation on how to update HERE. The steps are similar for both products.</p> <p>I will be following THESE instructions from Zooz.</p> <p>To note, if you are having trouble finding the \u201cPC Controller Software\u201d, READ THIS.</p> <p>I found a link to the updated firmware HERE.</p> <p>You supposedly can also update the firmware directly from zwavejs, however, I did not attempt this. I followed the official instructions and used the PC controller software.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-2-from-zwavejs-scan-the-qr-code","title":"Step 2. From zwavejs, scan the QR code","text":"<p>You can either start inclusion mode, then select scan QR code, or go under the provisioning entries section, and click add / scan.</p> <p>Make sure to keep your QR codes handy in a central location, and remember to write down what each code goes to.</p> <p>You will want to scan the codes for both the alarm keypad, as well as the contact sensors. The nodes will not join until you turn them on.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-3-turn-on-the-ring-keypad","title":"Step 3. Turn on the ring keypad","text":"<p>Plug in the USB power cable. And you will need to hold the \u201c1\u201d key. After this, the node should automatically join your z-wave network.</p> <p>If you require more in-depth instructions, please see THIS POST</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-4-add-alarmo-integration-to-home-assistant","title":"Step 4. Add Alarmo integration to home assistant","text":"<p>If, you do not already have the Alarmo integration installed, Add it. I installed it via HACs. You can find the official installation instructions HERE.</p> <p>After you have installed it, visit integrations, and add the Alarmo integration.</p> <p></p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-5-configure-alarmo","title":"Step 5. Configure Alarmo","text":"<p>On the navigation bar, there will be a new icon for \u201cAlarmo\u201d. Visit it, and configure everything to your liking.</p> <p>To note, the ring keypad will display three modes from the steps I will add below. Unarmed. Armed Home. Armed Away.</p> <p>You can follow Alarmo\u2019s DOCUMENTATION for more details.</p> <p></p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-6-ring-keypad-blueprint","title":"Step 6. Ring keypad blueprint","text":"<p>Thanks to a wonderful fellow on the Home assistant forums, this step is extremely easy.</p> <ol> <li>Visit THIS PAGE</li> <li> <p>Click Import Blueprint</p> <p></p> </li> <li> <p>Import the blueprint.</p> </li> <li> <p>Goto Automations. Click Create Automation.</p> <p></p> </li> <li> <p>Fill in the fields. You can edit this later. The fields for police/medical/etc are optional, and are not required.</p> <p></p> </li> <li> <p>Click Save.</p> </li> </ol> <p>You are done. That\u2019s it!</p> <p>At this point, you can arm and disarm your system directly from the keypad. The keypad has voice prompts for arming/disarming/etc. It will display your grace timer when exiting the building. It will also use the codes you defined in your alarmo configuration.</p> <p>That step, literally could not be easier.</p> <p>You can tweak some of the options via the zwavejs control panel too, if desired.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#step-7-install-door-sensors","title":"Step 7. Install Door Sensors","text":"<p>Please see Installing Embedded Door Sensors</p> <p>I moved this section to its own post to clean this post up a tad.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#further-steps-recommendations","title":"Further Steps / Recommendations","text":"<p>If you are intending to do a full home security system, here are a few of the steps I would recommend to you.</p> <ol> <li>Make sure your home assistant and related networking gear is on a proper battery backup. My setup has my homemade UPS keeping it powered.</li> <li>I highly recommend installing many external-facing POE cameras. Frigate is FANTASTIC at picking up people, and is quite accurate.</li> <li>Install door / window sensors on external doors and windows.</li> <li>In the event your alarm does go off, make sure it does something useful. The alarm keypad has a siren built-in, however, I could put it in my driveway and trigger it, and I doubt anyone would notice. Make sure you have SOMETHING useful happening when your alarm triggers\u2026. Notifications, SOMETHING.<ul> <li>An alarm system is only useful if it can attract attention to the fact someone broke into your house.</li> </ul> </li> <li>Internal motion sensors.<ul> <li>Unless you have cameras inside of your house performing person detection, there is no replacement for motion sensors!</li> </ul> </li> </ol> <p>Remember-</p> <ol> <li>Assume an intruder will try to cut your power and internet.</li> <li>Assume an intruder will use a wifi deauther.<ul> <li>This is a low effort / low cost attack which can render wifi-based devices unusable.</li> </ul> </li> <li>Wired security devices are ALWAYS preferred.</li> </ol>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#faqs","title":"FAQs","text":"","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#why-did-you-leverage-ring-components-you-hate-cloud-products-right","title":"Why did you leverage ring components? You hate cloud products, right?","text":"<p>I absolutely refuse to use cloud products with my home automation. However, all of these ring components will integrate into a proper z-wave network without any issues. There is NO requirement to have a ring account. These devices have no internet access as well.</p> <p>I went with these products due to somewhat reasonable pricing. The 6 pack of contact sensors prices each unit around the same as I would pay for a generic chinese unit. I will assume the quality of the ring unit is better then a generic no-name chinese unit as well.</p> <p>The keypad itself, is nicely made. It has OPTIONAL usb power. Can run on batteries. Has a lot of configuration options via zwavejs\u2026 and, well, it works.</p> <p>I can leverage all of its functionality, make use of all of its buttons, and even its motion sensor automatically integrates in.</p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#other","title":"Other","text":"","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#disclaimers","title":"Disclaimers","text":"<p>Not Sponsored</p> <p>This is NOT a sponsered post.</p> <p>All hardware, time, and tools was provided solely by me.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant-alarm/#changelogs","title":"Changelogs","text":"<ul> <li>2022-12-10 - Ported to static site from wordpress.<ul> <li>Embedded door sensors moved to dedicated post</li> </ul> </li> </ul>","tags":["Alarm","Z-Wave"]},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/","title":"Home Assistant - Is Working Sensor","text":"<p>Creating simple sensors to determine if we are \"at work\". Includes setting up a work_days sensor, time of day sensor, and a template sensor to tie everything togather. </p> <p>As well, includes steps for handling vacation / OoO days, and holidays.</p>"},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/#seperating-configuration-files","title":"Seperating configuration files.","text":"<p>This step is optional, however, to keep my configuration.yaml nice and simple, I split individual sections into dedicated files.</p> configuration.yaml<pre><code>binary_sensor: !include binary_sensor.yaml\nsensor: !include sensors.yaml\ntemplate: !include template.yaml\n</code></pre>"},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/#setup-work_days-integration","title":"Setup 'work_days' integration","text":"<p>We will need to setup the work_days integration. This is a built-in integration provided with home assistant, which will allow us to easily determine if a specific day, is a \"work day\". Please check out its Documentation for options which can be configured.</p> <p>As well, We will use the Time of Day integration, to determine if it is between the hours of 7:30am, and 5pm. This sensor is also built-in.</p> binary_sensor.yaml<pre><code>- platform: workday\n  name: work_days\n  country: US\n  province: OK\n  workdays: [mon, tue, wed, thu, fri]\n  excludes: [sat, sun, holiday]\n\n- platform: tod\n  name: work_hours\n  unique_id: work_hours\n  after: \"07:30\"\n  before: \"17:00\"\n</code></pre>"},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/#create-template-binary-sensor-to-tie-previous-sensors-togather","title":"Create template binary sensor to tie previous sensors togather.","text":"<p>To combine the previous two sensors (and a few others) into a single sensor, I will be leverage a template binary_sensor. Like the previous integrations, this is also a built-in out of the box integration.</p> <p>You will also note, I reference a helper boolean previously configured, for <code>input_boolean.mode_vacation</code>. When I am away from my house for an extended peroid of time, I use this helper to disable many of the automations I don't want running when I am away from home.</p> template.yaml<pre><code>- binary_sensor:\n  - name: is_working\n    state: &gt;\n      {{\n         is_state('binary_sensor.work_days', 'on')\n         and is_state('binary_sensor.work_hours', 'on')\n         and is_state('input_boolean.mode_vacation', 'off')\n      }}\n</code></pre> <p>As a disclaimer, you could also skip creating the above tod sensor, and wrap everything into a single template sensor if desired. However, I have special use-cases where having the above sensors broke-out into seperate sensors will come in handy.</p>"},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/#handling-days-off","title":"Handling Days Off","text":"<p>For handling taking a day off, I use the built-in Calendar Integration. I use this, rather then integrate with my work-calendar, due to company/security policies. </p> <p>The process is quite simple. </p> <p>Step 1. Goto Integrations</p> <p></p> <p>Step 2. Click Add Integration (Bottom-Right)</p> <p>Type in \"Calendar\"</p> <p>Step 3. Add the \"Local Calendar\" integration. For this example, I will use \"Vacation\" as the calendar name.</p> <p>Step 4. On the left bar, you should see \"Calendar\" At this point, you can select the calendar we just created, to add events.</p> <p>To tie this into the previous example, we can update the template sensor, like so:</p> template.yaml<pre><code>- binary_sensor:\n  - name: is_working\n    state: &gt;\n      {{\n         is_state('binary_sensor.work_days', 'on')\n         and is_state('binary_sensor.work_hours', 'on')\n         and is_state('input_boolean.mode_vacation', 'off')\n         and is_state('calendar.vacation', 'off')\n      }}\n</code></pre> <p>Do note, the state will be <code>off</code> when there are no events. However, when an event is added to the \"vacation\" calendar, its state will change to <code>on</code>.</p>"},{"location":"blog/2022/home-assistant---work-days--work-hours-sensor/#conclusion","title":"Conclusion","text":"<p>This was just a simple guide on how to setup some basic sensors to determine if it is during work hours, on a day you should be working.</p> <p>A few steps were added to also include an easy way to determine if its a vacation day. The built-in work_days already has support for handling holidays.</p> <p>Hope this is helpful, Cheers!</p>"},{"location":"blog/2022/kasa-powerstrip-as-pdu/","title":"Using Kasa HS300 powerstrip as a PDU.","text":"<p>Using a Tp-link kasa HS300 as a low-cost switchable PDU. This product has features for per-outlet power monitoring as well.</p> <p></p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#products-used","title":"Products Used","text":"<p>This article is centered around the Tp-link Kasa HS300 (Amazon)</p> <p></p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#setup-installation","title":"Setup / Installation","text":"","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#step-1-connect-to-your-network","title":"Step 1. Connect to your network.","text":"<p>For the initial setup, you will need the kasa app installed on your smart phone. After you have connected the device to your network, you will no longer need to leverage this app.</p> <p>I connected the HS300 to my \"IOT\" network, and allocated a static IP address. </p> <p></p> <p>Within my IOT network, the device is able to contact NTP, and DHCP, but, has no access to anything else.</p> <p>After the device successfully connects to your network, you can leverage the Kasa app to name the outlets. Don't worry about setting icons.</p> <p></p> <p>As well, since this is on an isolated IOT network, there is no need or reason to click the remote control. We are going to leverage this device in full local-only.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#update-firmware","title":"Update Firmware!","text":"<p>Warning</p> <p>Update your firmware! My HS300 came with a pretty early firmware version. I noticed it would not reconnect to the wifi after being disconnected... This would be a huge issue...</p> <p>After updating to firmware 1.0.12, it appears this issue may have been resolved.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#step-2-label-name-outlets","title":"Step 2. Label / Name outlets","text":"<p>If you don't have a label maker, I would recommend the Dymo 100H (Amazon), it has been working great for the last few years.</p> <p>After a bit of planning, I carefully attached labels to each of the outlets.</p> <p></p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#step-3-mount-to-your-rack","title":"Step 3. Mount to your rack.","text":"<p>Orignally, I considered cutting out a piece of steel to which I could mount the strip on the back of, and secure to my rack. After looking at various options, I decided I could leverage two of my rack screw/cages, to secure the strip.</p> <p>However, my cage screws were a tad too wide/tall to fit into the power strip. So, I leverage a drill with a bench-grinder to reduce the size of the screws.</p> <p>The unmodified screw is on the right. Doesn't look very pretty, however, it does get the job done.</p> <p></p> <p>Next, I installed a cage-nut, and screwed what was left of the screw into the nut.</p> <p></p> <p>Finally, I just needed to mount the strip to the screws. (There are two screws holding the strip in place.)</p> <p>(Ignore the hanging fibre... and cords. its on the to-do list...)</p> <p></p> <p>I used a few zip-ties to secure the power cord to the rack.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#step-4-integrate-with-home-assistant","title":"Step 4. Integrate with Home Assistant.","text":"<p>First, visit your integrations page, and click \"Add Integration\" at the bottom-right.</p> <p></p> <p>Search for \"kasa\"</p> <p></p> <p>Click on TP-Link Kasa Smart. Provide the IP address you allocated earlier.</p> <p></p> <p>Click submit.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#customize-entities","title":"Customize Entities","text":"<p>At this point, I went ahead and customized the entity names, display names, and icons.</p> <p></p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#all-done-setup-dashboards-reports-etc","title":"All done! Setup dashboards / reports / etc.","text":"<p>I was actually quite surprised to notice the HS300 does PER-plug consumption metrics.</p> <p>I expected, only consumption to be measured at the strip-level, however, having per-plug metrics is fantastic!</p> <p>Now- when somebody is wondering the power consumption of each of my SFF/MFF servers, I have concrete numbers!</p> <p></p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#home-assistant-features","title":"Home Assistant Features","text":"","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#data-exposed","title":"Data Exposed","text":"<ul> <li>Per-plug Current (amps)</li> <li>Per-plug Consumption (watts)<ul> <li>Current Consumption</li> <li>Today's Consumption</li> <li>Total Consumption</li> </ul> </li> <li>Per-plug voltage (volts)</li> </ul>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#controlsswitches-exposed","title":"Controls/Switches Exposed","text":"<ul> <li>Per-plug power<ul> <li>ie- each plug, can be individually toggled on/off.</li> </ul> </li> <li>LED Status<ul> <li>You can disable the LEDs. Useful if you don't want a bunch of LEDs lighting up a room.</li> </ul> </li> </ul>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#other-features","title":"Other Features","text":"<p>This unit DOES integrate with the built-in energy dashboards, out of the box, without additional configuration or customized sensors.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#my-thoughts-opinions","title":"My thoughts / Opinions","text":"<p>Overall- I am quite satisfied with the HS300. It exceeded my expectations by providing per-plug current/voltage metrics.</p> <p>I will note, I did have a lot of issues before updating to the latest firmware version, after it disconnected from the Wifi, I had to power-cycle the entire PDU to get it to reconnect.</p> <p>I have heard complaints of the PDU power-cycling after updates, but, during my testing- The firmware update did not cause any of the loads to be power cycled.</p> <p>WIth that said, I would recommend this product. The price is good. Ideally, I would leverage a used enterprise APC PDU from e-bay, however, I am quite pleased with the performance of this unit. In the future, I may acquire a dedicated APC unit to review, and repurpose this unit.</p> <p>Home assistant integration was effortless, with no issues at all here. </p> <p>As a bonus- since my Home Assistant automatically exports metrics to the prometheus instance hosted on my Kubernetes cluster, I was able to effortlessly graph these metrics in grafana.</p> <p></p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/kasa-powerstrip-as-pdu/#disclaimers","title":"Disclaimers","text":"<p>Not Sponsored</p> <p>This is NOT a sponsered post. This is was not endorsed, affiliated, or sponsered in any way by tp-link.</p> <p>All hardware, time, and tools was provided solely by me.</p>","tags":["Energy Monitoring","Homelab","Review"]},{"location":"blog/2022/programmable-thermostat-gui/","title":"Home Assistant \u2013 Programmable Thermostat GUI \u2013 Part 2","text":"<p>A while back, after converting my primary thermostat over to z-wave, I found a creative way of managing my thermostat\u2019s schedules using the scheduler-card.</p> <p>Well, I recently installed a new mini-split for my bedroom/office, and needed to integrate and maintain my schedules via home assistant. So, I decided to redo my schedules a bit.</p> <p>I found the scheduler-card has a \u201cmake-scheme\u201d button, which is far more intuitive for creating schedules then what I put together in PART 1. In hindsight, this feature existed then as well\u2026</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#the-end-result","title":"The end result","text":"<p>I am going to show you the completed product first, followed by the steps required to make it happen.</p> <p></p> <p>Completed view, with separate schedules for heating and cooling, for both my primary HVAC, as well as my mini-split. Upon clicking any of the above schedules, you can easily change/add/remove setpoints/modes.</p> <p></p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#how-to-do-it","title":"How to do it","text":"","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#how-to-add-and-configure-the-scheduler-card-component","title":"How to add and configure the scheduler-card / component.","text":"<p>Read the DOCUMENTATION. There is nothing I can add to improve on what is already documented.</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#how-to-create-a-dashboard","title":"How to create a \u201cdashboard\u201d","text":"","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-1-add-custom-scheduler-card-card","title":"Step 1. Add \u201cCustom: Scheduler Card\u201d Card","text":"<p>First, find a suitable dashboard, and click \u201cAdd Card\u201d</p> <p></p> <p>Next, add the \u201cCustom: Scheduler Card\u201d Card.</p> <p></p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-2-select-relevant-entities","title":"Step 2. Select Relevant Entities","text":"<p>For entities, select any entities AND conditions relevant to your setup.</p> <p>I would recommend selecting the relevant climate.* entities, and any other variables/entities/helpers you utilize to determine which schedules to run.</p> <p></p> <p>In my case, I will execute different schedules depending if it is a work-day, or if I am on vacation.</p> <p>So, I will select the relevant entities.</p> <p></p> <p>At this point, we should have a fully functional scheduler card.</p> <p></p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-3-additional-tweaks-sorting-and-display-options","title":"Step 3. Additional tweaks, sorting, and display options","text":"<p>However, there are a few additional tweaks I like to perform. Lets edit the card, and select \u201cOTHER\u201d</p> <p></p> <p>Here, you can adjust a few nice settings around this card.</p> <p>First, for HVAC schedules, I like to generally adjust the time-step to 30 minutes, instead of 10/15 minutes.</p> <p>For sorting, in this example, I am going to sort by \u201cDisplay Title of the schedule\u201d. Adjust these options to suit your needs. You can change this as many times as needed.</p> <p>Lastly, For my \u201cHVAC Schedules\u201d dashboard, I use a tag named \u201cHVAC\u201d to filter. This hides the many other schedules I utilize.</p> <p>Click save.</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-4-optionally-set-panel-mode","title":"Step 4. Optionally, set panel mode","text":"<p>One last note, I typically will modify the view containing this card and set it to \u201cpanel mode\u201d</p> <p></p> <p>This allows the scheduler-card to consume the entire screen, which is ideal for me, because this is the only card on the display. For the purpose of writing this post, I have this disabled though\u2026.. It\u2019s a tad hard for people to read massive 4k screenshots.</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#how-to-create-schedules","title":"How to create schedules","text":"","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-1-click-add","title":"Step 1. Click \u201cADD\u201d","text":"","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-2-click-make-scheme","title":"Step 2. Click Make Scheme","text":"<p>Select your Climate entity, and then click \u201cMAKE SCHEME\u201d</p> <p></p> <p>After clicking next, you will see a screen like this:</p> <p></p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-3-set-your-schedules","title":"Step 3. Set your schedules","text":"<p>Since, I am creating a daily cooling schedule for my bedroom mini-split\u2026 here is what I want:</p> <ul> <li>Midnight-6am: Cool to 63F</li> <li>6am-8pm: Cool to 72F</li> <li>8pm-Midnight: Cool to 63F</li> </ul> <p>You can add, or remove windows to suit your needs.</p> <p>Now, click on each \u201cwindow\u201d, and customize.</p> <p></p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#step-4-set-conditions","title":"Step 4. Set Conditions.","text":"<p>Next, I only want this schedule to become active if a few conditions are met. So, click \u201cOPTIONS\u201d in the bottom right.</p> <p></p> <p>I specified two conditions.</p> <ol> <li>The primary thermostat must be set to \u201cHEAT\u201d. I base all of the HVAC automation in my house on the primary thermostat\u2026. because it gives a single point of control.</li> <li>I only want this schedule active if vacation mode is OFF. I will have a separate schedule for vacation mode (which only serves the purpose of keeping the house from freezing, and below 90F).</li> </ol> <p>Do make sure to change the any/all selector to ALL, if you want all of the criteria to be met.</p> <p>After your conditions are set, I specified a name to easily identify this schedule.</p> <p>Finally, I use tags to separate my schedules between different dashboards. This way, I have a single view which shows all of the HVAC-related schedules, and different views for displaying lights, etc.</p> <p>Lastly, click save. Thats it!</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#mini-split-auto-mode","title":"Mini-Split \u201cAuto\u201d mode.","text":"<p>So, my mini-split has an auto mode which is pretty handy at keeping a given temp, efficiently. However, by default, I can only set a temp for HEAT or COOL modes.</p> <p>But, Ideally, I want to also be able to set a temp using \u201cAUTO\u201d mode too. Thankfully, the scheduler card has you covered, with minor configuration.</p> <p>First, edit the card, and select \u201cShow Code Editor\u201d at the bottom-left.</p> <p></p> <p>Next, we are going to add a bit of yaml to the bottom.</p> <pre><code>customize:\n  climate.bedroom:                        # Replace this with the name of your climate device.\n    actions: \n      - service: set_temperature\n        service_data:\n          hvac_mode: auto                 # The desired HVAC mode.\n        variables:\n          temperature:\n            min: 63                       # Set the minimum temp your unit allows.. or the minimum you wish to have displayed on the dashboard.\n            max: 80                       # Set the maximum temp your unit allows, or the maximum you want to have displayed on the dashboard.\n            step: 1\n            unit: \u00b0F                      # Feel free to change to \u00b0C, if this suits you better.\n        icon: mdi:autorenew                        \n        name: auto[ to {temperature}]     # Change \"auto\" to the text you want displayed.\n</code></pre> <p>The end result, should somewhat resemble this:</p> <pre><code>type: custom:scheduler-card\ninclude:\n  - binary_sensor.hvac_presence_detection\n  - binary_sensor.work_days\n  - climate\n  - input_boolean.bedroom_hvac_schedule_bypass\n  - input_boolean.cycle_heat\n  - input_boolean.mode_vacation\n  - script.cycle_heat_if_bedroom_is_cold\ntime_step: 5\ntitle: HVAC Schedules\ntags:\n  - HVAC\ndiscover_existing: false\ndisplay_options:\n  primary_info: default\n  secondary_info:\n    - relative-time\n    - days\nexclude: []\nshow_header_toggle: false\nsort_by:\n  - title\ncustomize:\n  climate.bedroom:\n    actions:\n      - service: set_temperature\n        service_data:\n          hvac_mode: auto\n        variables:\n          temperature:\n            min: 63\n            max: 80\n            step: 1\n            unit: \u00b0F\n        icon: mdi:autorenew\n        name: auto[ to {temperature}]\n</code></pre> <p>Now, when setting schemes, your new option will be displayed.</p> <p></p> <p>To note, you can add more options if you wish. You can also remove the existing options if desired.</p> <p>HERE is the relevant documentation for creating custom actions</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#more-reading","title":"More Reading","text":"<ul> <li>GitHub \u2013 Scheduler Card</li> <li>GitHub \u2013 Scheduler Component</li> </ul>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/programmable-thermostat-gui/#conclusion","title":"Conclusion","text":"<p>This is a very easy way to setup and maintain your schedules. The scheduler card and components are very easy to setup and utilize as well.</p> <p>One last note, If you use either the schedular card, or alarmo (Check it out, extremely useful), I would highly recommend saying thanks to the creator. Buy the man a cup of coffee, Send him 20$. He is well deserving of that, and far more for supporting the Home Assistant community.</p>","tags":["Home Assistant","HVAC"]},{"location":"blog/2022/reolink-rlc-520---set-custom-ntp/","title":"Set Custom NTP for Reolink Cameras","text":"<p>I have a few Reolink cameras. Recently, I noticed the time of many of the cameras was not set correctly.</p> <p>Since, I keep all of my IOT and Security devices isolated from the internet, they are not able to communicate with the pre-defined external NTP server. However, I do have a NTP server running on my opnsense firewall which they do have access to.</p> <p>But, it appears the ability to set a custom NTP server no longer exists in the reolink\u2019s configuration page.</p>","tags":["NVR","NTP"]},{"location":"blog/2022/reolink-rlc-520---set-custom-ntp/#the-solution-a-rest-api","title":"The Solution? A rest API.","text":"<p>Just a simple rest-api call. That is the only solution required here.</p> <p>Just replace YOUR_CAMERAS_IP, YOUR_NTP_SERVER_IP, YOUR_USER_ID, and YOUR_PASSWORD with the proper values.</p> <pre><code>curl -X POST -i 'http://YOUR_CAMERAS_IP/cgi-bin/api.cgi?cmd=SetNtp&amp;user=YOUR_USER_ID&amp;password=YOUR_PASSWORD' --data '[\n{\n\"cmd\":\"SetNtp\",\n\"param\":{\n\"Ntp\":{\n\"enable\":1,\n\"server\":\"YOUR_NTP_SERVER_IP\",\n\"port\":123,\n\"interval\":1440\n}\n}\n}\n]'\n</code></pre> <p>After executing the command, you will get back a response.</p> <pre><code>HTTP/1.1 200 OK\nDate: Thu, 28 Apr 2022 15:31:56 GMT\nContent-Type: text/html\nTransfer-Encoding: chunked\nConnection: keep-alive\nX-Frame-Options: SAMEORIGIN\nX-XSS-Protection: 1; mode=block\nX-Content-Type-Options: nosniff\n[\n   {\n      \"cmd\" : \"SetNtp\",\n      \"code\" : 0,\n      \"value\" : {\n         \"rspCode\" : 200\n      }\n   }\n]\n</code></pre> <p>In this case, rspCode, or Response Code, 200 means, Success.</p> <p>After this, you should be good to go.</p> <p>Credit for this, goes to THIS POST on reddit.</p>","tags":["NVR","NTP"]},{"location":"blog/2023/automating-the-galaxy/","title":"Automating the Galaxy!","text":"<p>Tonight, I wanted to do a small, random side-project. I automated the galaxy!</p> <p>(Or, at least a small version of it.)</p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#the-project","title":"The Project","text":"<p>During Christmas, I received one of these:</p> <p></p> <p>Buy on Amazon</p> <p>Being somebody who is really enjoys space... I enjoyed this gift. However, the only thing missing, was integration with home assistant!</p> <p>As well, I felt it could benefit from being able to display multiple colors at the same time, to present nice shading effects.</p> <p>BUT, in the event I failed at disassembling, and replacing the inner-workings of the globe, I decided to acquire a new one. After looking around, I discovered you could get these up to 10 inches in diamater.</p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#parts-products-needed","title":"Parts / Products needed.","text":"<ul> <li>9.6\" globe (Amazon Link)</li> <li>QuinLED-Dig-Uno<ul> <li>I already had a few of these on hand. These make assembling WLED projects a breeze. No guess work required. Plug and play.</li> <li>You don't NEED one- but, it sure does make the process easier.</li> </ul> </li> <li>WS2815 LED Strip<ul> <li>NORMALLY, I use WS2013 LEDs for my projects, which are 5v. However, I decided to go with 12v LEDs this time to maximize potential brightness. </li> <li>These are individually addressable, RGB LEDs with a backup channel. <ul> <li>The backup channel, prevents individual LED failures from affecting the rest of the strip.</li> </ul> </li> </ul> </li> </ul>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#getting-started","title":"Getting Started","text":"","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#step-1-remove-the-bottom","title":"Step 1. Remove the \"bottom\"","text":"<p>To remove the bottom section of the globe, I wedged a flat-head screw driver into the crack, and popped the bottom off.</p> <p>Once the bottom was off, you will be left with an empty globe</p> <p></p> <p>and, the stock circuity. Appears to be a very small microcontroller, with a small battery. It only contains 4 LEDs, which are always the same color.</p> <p></p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#step-2-mount-the-led-strip","title":"Step 2. \"Mount\" the LED strip.","text":"<p>After thinking for a bit, I decided to take a simple approach of just wrapping the LED strip around a piece of 2\" PVC pipe I had laying around.</p> <p></p> <p>Do note, I pushed a piece of foam into the bottom of the tube, to allow it to rest on the inside of the globe, once installed.</p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#step-3-connect-wled","title":"Step 3. Connect WLED","text":"<p>Make SURE to set your jumper to the proper voltage! If you are using 12v LEDs, make sure to use 12v power! For 5v LEDs, use 5v power. Make sure the 12v/5v jumper reflects the voltage!</p> <p>Once you have connected up the wires, and powered the QuinLED, connect to its wifi SSID using your phone. After connecting, you will be directed to a setup page.</p> <p>Here, you can setup the proper wifi details. Once you have connected this unit to your wifi network, you can manage WLED using the WLED app.</p> <p>The only configuration I performed, was to set the maximum current to 2 amps (This is the rating of my 12v power supply I am using), and set the number of LEDs. I happened to have exactly 200 LEDs.</p> <p>This is important, because WLED will automatically adjust the brightness in order to greatly assistat color accuracy. </p> <p>Here is the results after this step was completed:</p> <p></p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#step-4-add-power-plug","title":"Step 4. Add power plug.","text":"<p>IF, you decide to use 5v LEDs, you can retain the stock power adaptor. For me, I will need to replace the 5v plug, with a proper 12v plug.</p> <p>As you can see, there is a tiny bit of difference here.</p> <p></p> <p>Since, the old plug was just held in using some glue, I positioned the bottom-plate on my vice, and used a hammer, in conjunction with a punch to knock the old plug out.</p> <p></p> <p>Knock on wood, my new plug fit right into the old hole, and required no additional modifications.</p> <p></p> <p>While I was in the garage, I grabbed a few short pieces of copper wire I had laying around. This wire is about the maximum diamater for which the terminals can fit... and is over-kill for the purpose. </p> <p>However, I had the choice of this, or 24ga wire, which is undersized. I also used a hot glue gun to glue in the new 12v plug.</p> <p></p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#step-5-test-fit-everything-and-mount","title":"Step 5. Test fit everything, and mount.","text":"<p>Since I had a piece of 2\" PVC, this was plenty big to push the QuinLED into, with plenty of room for the resulting wire.</p> <p></p> <p>After pushing everything togather, and ensuring there are no clearance issues- I placed the assembly into the globe.</p> <p></p> <p>In an earlier step- you may have noticed a small piece of foam in the bottom of the PVC tube. This helps it fit snugly inside of the globe.</p> <p>After validating everything fits togather, and WORKS properly, I pressed on the bottom piece. You can use some glue here if needed.</p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#add-to-home-assistant","title":"Add to home assistant","text":"<p>Click here to open your home assistant integrations or navigate to your home assistant, click settings, integrations.</p> <p>Click Add Integration</p> <p></p> <p>Search for \"WLED\"</p> <p>Click \"WLED\"</p> <p>Type in the IP address of the WLED you configured earlier. If you did not allocate a static IP address via its configuration, or a static DHCP lease, I would strongly recommend doing so.</p> <p>Once everything is setup and configured, you will be able to view and control this device via home-assistant. </p> <p>For now, I included this into my office's scenes for ambiance lighting.</p>","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#the-final-result","title":"The final result?","text":"","tags":["WLED"]},{"location":"blog/2023/automating-the-galaxy/#disclaimers","title":"Disclaimers","text":"<p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["WLED"]},{"location":"blog/2023/feline-area-denial-device/","title":"FADD - Feline Area Denial Device","text":"<p>My wife presented me with a unique challenge recently. </p> <p>\"The cats keep getting on top of the kitchen table, and getting hair everywhere!\"</p> <p>So- the logically minded person I am- I decided to build a home-assistant integrated device for keeping cats off of the table!</p> <p>I present to you, the FADD. Feline Area Denial Device!</p> <p>\u26a1\ufe0f Shock Risk</p> <p>This project can shock you.  \u26a1\ufe0f\ud83e\udd15\ud83d\ude91\ufe0f</p> <p>\ud83d\udd25 Fire Hazard</p> <p>This project presents a potential fire hazard. Do not use this around anything flammable. Do not use this unsupervised. \ud83d\udd25\ud83d\ude92</p> <p>Danger</p> <p>This project should not be used around pets or small children. \ud83d\udc08\ufe0f\ud83d\udc15\ufe0f\ud83e\udd38</p> <p>Caution</p> <p>Make sure you read the disclaimers! </p> <p>Also- you probably should not build this. </p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#the-concept","title":"The concept","text":"<p>The concept is simple. I will use Frigate, combined with a Google Corral TPU, to detect when the cats are near the kitchen table.</p> <p>When the kittys are either on, or near the kitchen table, I will trigger a taser like device. </p> <p>This taser like device, is not intended to shock or physical harm anyone, and is mounted away from kids and pets.</p> <p>The idea- the taser-like sound, will scare away the cats. </p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#the-end-result","title":"The End Result","text":"","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#build-assembly","title":"Build / Assembly","text":"","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#software-used","title":"Software Used","text":"<ol> <li>Home Assistant<ul> <li>This is my home automation platform of choice.</li> </ul> </li> <li>ESPHome<ul> <li>This is the firmware I typically run on my ESP-based projects</li> </ul> </li> <li>Frigate<ul> <li>I am leveraging Frigate, combined with a Google Coral TPU to detect objects.</li> </ul> </li> </ol>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#parts-needed","title":"Parts needed","text":"<ol> <li>\"High-Voltage\" Generator.<ul> <li>Amazon</li> <li>I ended up picking up 5 of these, for 20$ shipped, or 4$ each. However, you can buy just a single module for 10$.</li> <li>This converts the incoming 5v, into around 40kv. (Ignore the 400kv claim... that is false. But, based on my math, it does generate 40-50kv)</li> </ul> </li> <li>5v 3 amp power supply<ul> <li>Amazon</li> <li>I suppose you could use a normal 2amp USB brick, however, I opted for this 3 amp power supply instead.</li> </ul> </li> <li>ESP32<ul> <li>Amazon</li> <li>I had a bunch of ESP32s laying around, however, you COULD instead use a ESP8266 or D1 Mini for a cheaper.</li> <li>I went with the ESP32, to also try out the new Esphome Bluetooth Proxy functionality. </li> <li>But- for this project, the ESP32 offers no additional required functionality over what a ESP8266-based module provides.</li> </ul> </li> <li>Some form of enclosure<ul> <li>Amazon</li> <li>A few years back, I picked up a bunch of these ABS plastic enclosures. They occasionally come in handy for projects exactly like this.</li> <li>I recommend a non-conductive enclosure, due to the high-voltages here.</li> </ul> </li> <li>MOSFET OR Relay module<ul> <li>MOSFET - Amazon</li> <li>I went with a MOSFET over a traditional relay, because I wanted to see if I could pass a PWM signal to the step-up coil to alter the frequency of the sound generated.</li> <li>I will note, I was unsuccessful in doing so. However- these little modules do work quite nicely. You can substitute a relay instead, with minor changes to wiring</li> <li>Relay - Amazon</li> <li>DO note- whichever solution you choose will need to be able to be triggered via 3v signal. </li> </ul> </li> </ol> <p>Overall, I'd estimate I spent around 50$ for this project, HOWEVER, I have enough components to build 5 of these things, if I wanted.</p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#other-hardware-used","title":"OTHER Hardware Used","text":"<ol> <li>Reolink E1<ul> <li>I always recommend using a hard-wired POE camera over a wireless camera. However, this is a temporary project, which will not be permanently attached. </li> <li>But, for 30$ a piece, these wireless cameras do come in quite handy for quick POC, testing, and other purposes.</li> <li>For permanent mount cameras, my current recommendation is the Reolink RLC-520</li> </ul> </li> <li>Google Coral USB Accelerator<ul> <li>IF you can get your hands on one of these, it greatly accelerates how quickly objects can be detected.</li> <li>It also allows you to perform object detection, while hardly using CPU resources.</li> </ul> </li> </ol>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#wiring","title":"Wiring","text":"<p>Please forgive my drawing. However, the wiring of this project is extremely simple.</p> <p></p> <p>From your 5V power supply- </p> <p>Connect positive to:</p> <ol> <li>VIN plug of your selected ESP device. (NOT the 3.3v link!!)</li> <li>Positive input of your MOSFET or relay.</li> </ol> <p>Connect negative/ground to:</p> <ol> <li>GND pin of your selected ESP device. There are a few GND pins, pick your favorite.</li> <li>Negative input of your MOSFET or relay.</li> </ol> <p>Connect the OUTPUTs of your MOSFET, to the inputs of the \"high-voltage generator\" (The side with a blue wire)</p> <p>Finally, connect a GPIO from the ESP to the MOSFET. I went with GPIO12. However, as long as you don't choose a reserved GPIO, you should be fine.</p> <p>In hindsight- I should have used GPIO16 - 33 as there is nothing special about those pins, and they are capable of generating a PWM signal, if you want to experiment.</p> <p>Connect the GPIO to the TRIG/PWM input of the MOSFET.</p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#assembly","title":"Assembly","text":"<p>For assembly, I only used a few tools:</p> <ol> <li>Soldering iron- for soldering wires to pins / connections.</li> <li>Hot Glue Gun - To hold everything in place. <ul> <li>This is a cheap, quick POC project. Hot glue will work just fine here.</li> </ul> </li> <li>A drill<ul> <li>Used to make a hole for the DC 5v PIN.</li> </ul> </li> </ol> <p>First, solder all of the connections noted in the previous step.</p> <p>Next, I drilled a hole for the DC 5v PIN, and then used hot glue to hold the plug into place.</p> <p>Finally- I carefully placed the remaining components inside of the case. </p> <p></p> <p>After careful organization, I snapped the lid into place, and soldered the high-voltage leads into a mostly-fixed position. </p> <p>Do note, altering the distance between the leads will alter the sound/frequency which is emitted. </p> <p></p> <p>The only concern I would be aware of during assembly- Try to keep the high-voltage leads as far away from the ESP as possible! Otherwise, you may end up zapping it.</p> <p>Danger</p> <p>Make sure to affix the high-voltage leads into a position where the ARC is NOT near anything flammable OR conductive. </p> <p>This CAN present a fire / shock risk. You have been warned.</p> <p>The last step- is to place the unit somewhere secure, away from children and pets.</p> <p></p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#esphome-firmware","title":"Esphome Firmware","text":"<p>For this project, I am using Esphome. It supports all of the functionality I need, and it easily integrates with Home Assistant, and MQTT, allowing me to easily automate it.</p> <p>Here is the configuration file I am using:</p> cat-zapper.yaml<pre><code>substitutions:\n  devicename: \"cat_zapper\"\n  friendly_name: \"Cat Zapper\"\n  ip_address: 10.1.2.3\n  gateway: 10.1.2.1\n  &lt;&lt;: !include secrets.yaml\n\n&lt;&lt;: !include common/common.yaml\n\nesphome:\n  name: ${devicename}\n  friendly_name: ${friendly_name}\n\nesp32:\n  board: esp32dev\n  variant: esp32\n\nsensor: \n  # Wifi Signal\n  - &lt;&lt;: !include common/sensor-wifi-signal.yaml\n\n  # Uptime\n  - &lt;&lt;: !include common/sensor-uptime.yaml\n\nbutton:\n  # Restart Button\n  - &lt;&lt;: !include common/button-restart.yaml\n\n  # Safe Mode Button\n  - &lt;&lt;: !include common/button-safemode.yaml\n\n  - platform: output\n    output: zap\n    name: \"Zapper\"\n    duration: 400ms\n\noutput:\n  - platform: gpio\n    pin: GPIO12\n    id: zap\n\n# Uncomment if you would like a web interface\n# web_server:\n#   port: 80  \n</code></pre> <p>Regarding the contents of the \"common\" files, I have those documented here: ESPhome Common. I use this include functionality, to keep my configuration files cleaner, and to avoid repeating the same configuration in multiple locations.</p> <p>For my configuration, I used a <code>Button</code> to trigger this device. This uses the generic output button, which allows me to trigger a GPIO output for a determined amount of time.</p> <p>You can alter the duration of the \"Zaps\" by adjusting the duration parameter in the above configuration. </p> <p>Info</p> <p>The reason I am leveraging a generic output button, instead of a GPIO switch, is to control the duration during which this device is active. I wanted to greatly reduce the possibility of this device getting stuck in an \"ON\" position, which would greatly elevate the risk of fire.</p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#the-automation","title":"The Automation","text":"","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#frigate-configuration","title":"Frigate Configuration","text":"<p>After configuring this camera in Frigate, I had a video stream.</p> <p></p> <p>However, I really only care when there is a <code>cat</code> on or near the kitchen table. I don't want to waste resources detecting people walking near the table.</p> <p>So, I created a motion mask, and masked off all of the areas I do not care about. This left me with the following view:</p> <p></p> <p>Do note, this is a color camera. However, since the room is currently uninhabited and dark- it is in \"night vision\" mode, which is black and white only.</p> <p>After everything was completed, here is what I was left with:</p> Frigate Config.yaml<pre><code>objects:\n  filters:\n    cat:\n      # I lowered the score for detecting cats slightly, to improve detections.\n      min_score: 0.4\n      threshold: 0.6\n\n\ncameras:\n  kitchen:\n    detect:\n      width: 640\n      height: 354\n      fps: 7\n    ffmpeg:\n      inputs:\n          # This path is specifically for a Reolink E1. As well, I am using the sub-stream for detection. \n        - path: rtsp://YourUser:YourPassword@10.1.2.3:554/h264Preview_01_sub\n          roles:\n            - detect\n            - record\n    motion:\n      mask:\n        - 502,304,366,354,640,354,640,277,640,181,640,0,0,0,0,354,202,354,115,206,173,134,227,61,442,58,473,93,569,101\n    zones: # I also created a specific zone, for the areas I am wanting to detect cats.\n      zone_0:\n        coordinates: 0,354,329,354,475,354,530,333,581,108,447,39,269,40,0,42\n    objects:\n      track:\n        - cat\n</code></pre> <p>With these settings, over the last few days, I have gotten extremely accurate detections.</p> <p></p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#home-assistant-configuration","title":"Home Assistant Configuration","text":"<p>I will be adding the actual automation inside of Home Assistant. The automation is actually quite simple.</p> <p></p> <pre><code>alias: Cat Taser\ndescription: Fire the lasers\ntrigger:\n  - type: occupied\n    platform: device\n    device_id: 94e0766834ecff68ee26b72f231499de\n    entity_id: binary_sensor.zone_0_cat_occupancy\n    domain: binary_sensor\ncondition:\n  - condition: state\n    entity_id: input_boolean.mode_vacation\n    state: \"off\"\naction:\n  - repeat:\n      while:\n        - condition: state\n          entity_id: binary_sensor.kitchen_cat_occupancy\n          state: \"on\"\n      sequence:\n        - device_id: 914217f5ad93dc688d9d6f3ea86e1b29\n          domain: button\n          entity_id: button.cat_zapper_zapper\n          type: press\n        - delay:\n            hours: 0\n            minutes: 0\n            seconds: 5\n            milliseconds: 0\nmode: single\n</code></pre> <ol> <li>When <code>binary_sensor.zone_0_cat_occupancy</code> turns on (ie. there is a cat inside of zone 0)</li> <li>AND, I am not on vacation</li> <li>THEN, Press the \"zapper\"  button every 5 seconds, until there is no longer a cat inside of zone 0.</li> </ol> <p>That's it!</p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#does-it-work","title":"Does it work?","text":"<p>I WOULD have more videos, however, after deploying this device- the first two videos didn't come through with any sound. And, after the 3rd detection- the cats have not returned to the kitchen table.</p> <p>Overall, I would call this a success... as not a single cat hair has been found on top of the kitchen table since deployment.</p> <p>And- this can be easily repurposed for other areas of the house.</p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/feline-area-denial-device/#disclaimers","title":"Disclaimers","text":"<p>\u26a1\ufe0f Shock Risk</p> <p>This project can shock you.  \u26a1\ufe0f\ud83e\udd15\ud83d\ude91\ufe0f</p> <p>\ud83d\udd25 Fire Hazard</p> <p>This project presents a potential fire hazard. Do not use this around anything flammable. Do not use this unsupervised. \ud83d\udd25\ud83d\ude92</p> <p>Danger</p> <p>This project should not be used around pets or small children. \ud83d\udc08\ufe0f\ud83d\udc15\ufe0f\ud83e\udd38</p> <p>Caution</p> <p>Make sure you read the disclaimers! </p> <p>Also- you probably should not build this. </p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Home Assistant","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/","title":"Using ESPHome on critical devices, such as networking gear","text":"<p>In an effort to monitor the consumption of everything- I ran across an unusual problem.</p> <p>When connecting my core switch to a ESPHome flashed smart switch, I noticed two things-</p> <ol> <li>It is very easy to accidentally turn the switch off.<ul> <li>This is a problem, because you cannot turn it back on remotely! Since, wifi connects to the core switch.</li> </ul> </li> <li>When flashing updated firmware, the relay will quickly toggle for a very short duration.<ul> <li>This can cause devices to power cycle.</li> </ul> </li> </ol> <p>So, I set out to see how I could customize my configuration to be suitable for managing my core switch.</p> <p>I will be implementing:</p> <ol> <li>A button to power-cycle the core switch.</li> <li>Configuration to prevent the relay from toggling during firmware updates / ESPHome restarts.</li> <li>Removing toggle switches.</li> </ol> <p>What are some of the use cases for doing this:</p> <ul> <li>Using a plug to monitor the energy consumption and status certain appliances, that you don't want to accidentally turn off.<ul> <li>A fridge</li> <li>A deep freezer</li> </ul> </li> <li>Using a smart plug on network equipment and servers.<ul> <li>Being able to power-cycle your router, switch, server, etc.</li> <li>Ensuring you are able to successfully power-cycle the device hosting your wifi.</li> </ul> </li> </ul>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#how-to-prevent-the-switch-from-cycling-during-restarts","title":"How to prevent the switch from cycling during restarts?","text":"<p>To prevent the relay from cycling during firmware updates, or software restarts, only needs two things.</p> <p>First- is this section in the configuration:</p> <pre><code>esp8266:\n  early_pin_init: false\n</code></pre> <p>References:</p> <ul> <li>Esphome - esp8266 component documentation</li> <li>Original Github issue</li> </ul> <p>Second- is setting the <code>restore_mode</code> for the GPIO switch.</p> <pre><code>switch:\n  - platform: gpio\n    pin: GPIO12\n    # It is assumed this switch is used for a piece of critical infrastructure.\n    # As such, we want it to remain ON turing reboots.\n    # Lastly- the only functionality exposed for interacting with this relay, is to quickly power cycle it.\n    restore_mode: ALWAYS_ON\n</code></pre> <p>With this two pieces of configuration, it should prevent the momentary \"blip\" of your relay being cycled when updating firmware, or restarting the software.</p>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#how-to-add-a-confirm-button","title":"How to add a confirm button?","text":"<p>The confirm button, required a few components.</p> <p>First up, I needed a variable to contain the \"confirm restart\".</p> <pre><code>globals:\n  # Global boolean containing value if confirm is selected.\n  - id: confirm_restart\n    type: bool\n    restore_value: no\n    # When the device is restarted, default the false / off.\n    initial_value: 'false'\n</code></pre> <p>Next, we need to expose this to home assistant.</p> <p>To handle this, I used a template switch, which references the above global variable. Clicking the switch, sets the state of the above variable.</p> <pre><code>switch:\n  # Expose a \"confirm restart\" switch.\n  - platform: template\n    name: Confirm Restart\n    id: confirm_restart_sw\n    icon: mdi:alert\n    lambda: |-\n      return id(confirm_restart);\n    turn_on_action:\n      - lambda: |-\n          id(confirm_restart) = true;\n    turn_off_action:\n      - lambda: |-\n          id(confirm_restart) = false;\n</code></pre> <p>Now that we have a switch which we can toggle on and off from within home assistant, we need to connect this to the restart button.</p> <pre><code>button:\n  - platform: template\n    name: Power Cycle\n    icon: mdi:restart-alert\n    on_press:\n      - if:\n          condition:\n              # Get the current value of the global variable.\n              lambda: 'return id(confirm_restart);'\n          then: # Below actions are ONLY executed, if the confirm switch is toggled on.\n            # Turn off confirm switch after cycling relay, to greatly reduce the chance of the device being power cycled again.\n            - switch.turn_off: confirm_restart_sw\n            # Turn off the relay.\n            - switch.turn_off: relay\n            # Wait a half second before turning the relay back on.\n            - delay: 0.5s\n            # Turn on the relay.\n            - switch.turn_on: relay\n</code></pre> <p>Here is the end result:</p> <p></p> <p>Notice, clicking the <code>Power Cycle</code> button does not actually cycle the device.</p> <p>BUT, after switching the confirm on, it does successfully power cycle the device.</p> <p></p> <p>Overall, this worked flawlessly.</p>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#final-configurations","title":"Final Configurations","text":"","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#main-configuration","title":"Main configuration","text":"Core-Switch.yaml<pre><code>substitutions:\n  devicename: \"rack_core_switch\"\n  friendly_name: \"Core Switch\"\n  # Put your own IPs here.\n  ip_address: 10.1.2.3\n  gateway: 10.1.2.1\n  &lt;&lt;: !include secrets.yaml\n\n&lt;&lt;: !include config/common.yaml\n&lt;&lt;: !include common/sonoff-s13-reset-only.yaml\n</code></pre> <p>For the top-level config I copy/paste for various devices, that is literally it! I try to follow the D.R.Y. principal when building configurations for ESPHome. </p>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#common-configuration","title":"Common Configuration","text":"common.yaml<pre><code>wifi:\n  ssid: ${wifi_ssid}\n  password: ${wifi_pass}\n  domain: \".yourdomain.com\"\n  fast_connect: True\n  power_save_mode: none\n  manual_ip:\n    static_ip: ${ip_address}\n    gateway: ${gateway}\n    # All of my IOT subnets are /24. I didn't see a need to make this a variable / substitution. \n    subnet: 255.255.255.0\n\n  ap:\n    ssid: \"${devicename} Fallback\"\n    password: ${fallback_pass}\n\n# captive_portal:\n\n# Enable logging\nlogger:\n\n# Enable Home Assistant API\napi:\n  encryption:\n    key: ${encryption_key}\n  # password: ${api_pass}\n  # services:\n  #   - service: reboot\n  #     then:\n  #       - platform: restart\n\nota:\n  password: ${ota_pass}\n\n# Enable Time Component\ntime:\n#  - platform: homeassistant\n#    id: homeassistant_time\n#    timezone: YourTimezoneHere.\n  # I use NTP, rather than home assistant, as I have been configuring my devices to be able to work stand-alone without home-assistant, if needed.\n  - platform: sntp\n    servers: ${ntp_server_ip}\n    timezone: ${timezone}\n\n# This section is optional. However, I configure all of my devices to also use MQTT, along with home assistant directly. \n# MQTT allows me to easily integrate them into other systems.\nmqtt:\n  broker: ${mqtt_pass}\n  username: ${mqtt_user}\n  password: ${mqtt_pass}\n  discovery: false\n  log_topic:\n    topic: esphome/logs/${devicename}\n    level: ERROR\n  topic_prefix: esphome\n  birth_message:\n    topic: esphome/state/${devicename}\n    payload: online\n  will_message:\n    topic: esphome/state/${devicename}\n    payload: offline\n</code></pre>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#secrets","title":"Secrets","text":"secrets.yaml<pre><code>api_pass: \"\"\nota_pass: \"\"\nfallback_pass: \"\"\nencryption_key: \"\"\n\nwifi_ssid: \"\"\nwifi_pass: \"\"\n\nbackup_wifi_ssid: \"\"\nbackup_wifi_pass: \"\"\n\n# NTP Server IP, if you use NTP instead of home assistant for time. \nntp_server_ip: 1.2.3.4\ntimezone: YourTimezoneHere\n\n# MQTT Server IP, if you use MQTT.\nmqtt_ip: 1.2.3.4\nmqtt_user: \"\"\nmqtt_pass: \"\"\n</code></pre>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#device-specific-configuration","title":"Device-specific configuration","text":"<p>Below is the primary configuration I am using for my Sonoff S13 devices, which have something important connected to them.</p> <p>This configuration is designed to prevent the switch from being placed into an \"Off\" position. </p> common/sonoff-s13-reset-only.yaml<pre><code>esphome:\n  name: ${devicename}\n  friendly_name: ${friendly_name}\n\nlogger:\n  # (UART logging interferes with cse7766)\n  baud_rate: 0\n\nesp8266:\n  # https://esphome.io/components/esp8266.html\n  # https://github.com/esphome/issues/issues/3263\n  # Stops relay from cycling when restarting or flashing\n  early_pin_init: false\n  board: esp01_1m\n\nuart:\n  rx_pin: RX\n  baud_rate: 4800\n\n\nglobals:\n  # Global boolean containing value if confirm is selected.\n  - id: confirm_restart\n    type: bool\n    restore_value: no\n    initial_value: 'false'\n\nbinary_sensor:\n  - platform: gpio\n    pin:\n      number: GPIO0\n      mode: INPUT_PULLUP\n      inverted: True\n    internal: true\n    id: the_button\n    on_press:\n      - switch.toggle: relay\n\n  - platform: status\n    name: Status\n\nsensor:\n  # Wifi Signal\n  - &lt;&lt;: !include sensor-wifi-signal.yaml\n\n  # Uptime\n  - &lt;&lt;: !include sensor-uptime.yaml\n\n  # Energy monitoring\n  - platform: cse7766\n    current:\n      name: \"Current\"\n      accuracy_decimals: 1\n      state_class: measurement\n      device_class: current\n    voltage:\n      name: \"Voltage\"\n      accuracy_decimals: 1\n      state_class: measurement\n      device_class: voltage\n    power:\n      name: \"Power\"\n      accuracy_decimals: 1\n      state_class: measurement\n      device_class: power\n      id: my_power\n    update_interval: 15s\n  - platform: total_daily_energy\n    name: \"Energy D\"\n    state_class: total_increasing\n    device_class: energy\n    power_id: my_power\n\nswitch:\n  - platform: gpio\n    pin: GPIO12\n    id: relay\n    # It is assumed this switch is used for a piece of critical infrastructure.\n    # As such, we want it to remain ON turing reboots.\n    # Lastly- the only functionality exposed for interacting with this relay, is to quickly power cycle it.\n    restore_mode: ALWAYS_ON\n    # Hide from home assistant / mqtt.\n    internal: true\n\n  # Expose a \"confirm restart\" switch.\n  - platform: template\n    name: Confirm Restart\n    id: confirm_restart_sw\n    icon: mdi:alert\n    lambda: |-\n      return id(confirm_restart);\n    turn_on_action:\n      - lambda: |-\n          id(confirm_restart) = true;\n    turn_off_action:\n      - lambda: |-\n          id(confirm_restart) = false;\n\nbutton:\n  # Restart Button\n  - &lt;&lt;: !include button-restart.yaml\n\n  - platform: template\n    name: Power Cycle\n    icon: mdi:restart-alert\n    on_press:\n      - if:\n          condition:\n              lambda: 'return id(confirm_restart);'\n          then:\n            - switch.turn_off: relay\n            - delay: 0.5s\n            - switch.turn_on: relay\n            # Turn off confirm switch after cycling relay\n            - switch.turn_off: confirm_restart_sw\n\nstatus_led:\n  pin:\n    number: GPIO13\n    inverted: yes\n</code></pre>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/esphome-on-critical-infrastructure/#other-referenced-configurations","title":"Other Referenced Configurations","text":"<p>button-restart, simply, is the restart button. Instead of placing the same 4 lines of configuration in every file, I just reference this one file.</p> button-restart.yaml<pre><code>  - platform: restart\n    name: Restart\n    icon: \"mdi:restart\"\n    entity_category: diagnostic\n</code></pre> <p>The same with my uptime sensor.</p> sensor-uptime.yaml<pre><code>  - platform: uptime\n    name: Uptime\n    state_class: measurement\n    device_class: duration\n</code></pre> sensor-wifi-signal.yaml<pre><code>  - platform: wifi_signal\n    name: \"WiFi Signal\"\n    update_interval: 60s\n    state_class: measurement\n    device_class: SIGNAL_STRENGTHr\n</code></pre> <p>I have these individual components broken out into dedicated files, because I have a pretty decent number of devices running ESPHome. By separating them into dedicated files, I can ensure all of my devices have a consistent configuration. </p>","tags":["Home Assistant","Homelab","ESPHome"]},{"location":"blog/2023/home-assistant---split-sensor/","title":"Home Assistant - Split Sensor into Negative and Positive","text":"<p>This is a very quick post on how to take a sensor- such as <code>sensor.grid_power</code> and split it into <code>sensor.grid_power_in</code> and <code>sensor.grid_power_out</code>.</p> <p>This can be handy if you need a separate sensor for energy/power in, and energy/power out.</p> <p>For this short post, I will be splitting <code>sensor.battery_power</code> into <code>sensor.battery_power_in</code> and <code>sensor.battery_power_out</code></p>","tags":["Home Assistant"]},{"location":"blog/2023/home-assistant---split-sensor/#how-to-do-it","title":"How to do it?","text":"<p>First- you need to update your <code>configuration.yaml</code>/<code>templates</code></p> <p>I personally keep my templates in a dedicated file named <code>template.yaml</code>. This helps me keep everything organized.</p>","tags":["Home Assistant"]},{"location":"blog/2023/home-assistant---split-sensor/#how-to-store-templates-in-a-dedicated-file","title":"How to store templates in a dedicated file","text":"<p>Simple, in your <code>configuration.yaml</code>, we will tell it to include sensors.yaml.</p> configuration.yaml<pre><code>template: !include template.yaml\n</code></pre> <p>You can do this with sensors, binary_sensors, or any other section. </p>","tags":["Home Assistant"]},{"location":"blog/2023/home-assistant---split-sensor/#how-to-split-sensor-into-negativepositive-sensors","title":"How to split sensor into negative/positive sensors","text":"<p>To do this, we will leverage home-assistant's template sensor.</p> template.yaml<pre><code>- sensor:\n  - name: battery_power_in\n    unit_of_measurement: \"W\"\n    state_class: measurement\n    device_class: power\n    state: &gt;\n        {% if states('sensor.battery_power')|float &gt;= 0 %}\n          {{ states('sensor.battery_power') }}\n        {% else %}\n          0\n        {% endif %}\n  - name: battery_power_out\n    unit_of_measurement: \"W\"\n    state_class: measurement\n    device_class: power\n    state: &gt;\n        {% if states('sensor.battery_power')|float &lt; 0 %}\n          {{ states('sensor.battery_power') | float  * -1  }}\n        {% else %}\n          0\n        {% endif %}\n</code></pre> <p><code>state_class</code>, and <code>device_class</code> are not required fields. However, if you wish to specify them, here is the documentation for acceptable values:</p> <ul> <li>State Class</li> <li>Device Class - Sensor</li> </ul> <p>After making your changes, in home assistant, press <code>C</code>, and <code>Reload Template Entities</code></p> <p>If your new sensors do not show up, check your logs for errors.</p>","tags":["Home Assistant"]},{"location":"blog/2023/home-assistant---split-sensor/#summary","title":"Summary","text":"<p>This was intended to be a very simple guide on how to split a number into multiple sensors.</p> <p>The use-case for needing to do this- is to create a dedicated sensor for power going INTO battery storage, or coming IN from the grid, and then, having a sensor for power LEAVING my house or battery.</p>","tags":["Home Assistant"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/","title":"Home Assistant - Energy Flow Diagram","text":"<p>This is a quite guide on creating a real-time sankey diagram to show your current energy usage.</p> <p></p> <p>Here is an image from earlier in the day, when the sun was shining a bit more.</p> <p></p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#what-is-the-use-case","title":"What is the use-case?","text":"<p>The use case for me doing this, was to build a dashboard to quickly identify real time instantaneous power consumption. </p> <p>That is- when I realize my energy consumption is higher then I expect, I can glance at this dashboard, and quickly determine which device or circuit is responsible for the additional consumption.</p> <p>Although, you technically should be able to design this dashboard around looking at energy utilization specified in Kwh/d, I will not be doing that in this post.</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#software-needed","title":"Software Needed","text":"<ol> <li>Home Assistant.</li> <li>ha-sankey-chart</li> <li>You can add this using hacs. Look under the frontend section.</li> </ol>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#how-to-collect-energy-data","title":"How to collect energy data","text":"<p>For my charts I use a combination of data from multiple different sources.</p> <p>If you are just curious to read about different solutions for gathering energy data, please see: Home Assistant - Energy Monitoring Solutions.</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#solar-grid-data","title":"Solar / Grid Data","text":"<p>The top-level production/consumption data is collected by my inverter, which also has strategically placed CT clamps to measure energy going into and from the main meter.</p> <p>It provides additional metrics for...</p> <ol> <li>Total load consumption</li> <li>Consumption for both Critical, and Non-Critical breaker panels. </li> <li>PV / Solar Production</li> <li>Generator Production</li> <li>Battery Power</li> </ol> <p>I leverage solar-assistant to collect data from my inverter. If you would like to learn more, read Solar Installation - Part 4 - Monitoring</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#per-breaker-data-collection","title":"Per-Breaker Data Collection","text":"<p>For collecting data for individual  breakers, there are many solutions you can leverage.</p> <p>I have a collection of Energy Monitoring Solutions</p> <p>I personally, use Iotawatt for per-circuit monitoring. I wrote about its recent installation here: Solar Installation - Part 4 - Monitoring</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#per-device-data-collection","title":"Per Device Data Collection.","text":"<p>Again, in the Energy Monitoring Solutions post, there are a few options for smart-plugs with energy monitoring capabilities. </p> <ol> <li>For the data I am collecting for a lot of my servers and computers, I leverage Tp-link Kasa HS300 strips. I reviewed and documented those here: Kasa HS300 as Rack-Mounted PDU</li> </ol> <p>Those strips are installed in both my server rack, as well as my office. </p> <p>For collecting data from my r730XD, I found THESE INSTRUCTIONS for collecting its SNMP data directly via home-assistant.</p> <p>For my office light switch, I leverage a Shelly 1PM behind a normal light switch.</p> <p>For the Entry and Porch lights (Double-switch box), I use a Shelly 2.5.</p> <p>All of my other lights are  Inovelli Red z-wave dimmer switches which self-reports consumption data.</p> <p>Lastly, I use Flashed Sonoff S31s for collecting data from single-devices. Link goes to my post on how to flash them.</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#creating-the-visualization","title":"Creating the visualization","text":"<p>This assumes you have already installed ha-sankey-diagram! If not, go install it via HACs.</p> <p>I recommend starting with a blank dashboard panel. </p> <p>Afterwards, I recommend setting the dashboard view mode to <code>Panel (Single Card)</code></p> <p></p> <p>IF, you want to stack multiple diagrams, such as my version at the top of this post, add a <code>vertical stack card</code></p> <p></p> <p>Once you have added the <code>vertical stack card</code>, add the <code>Custom: Sankey Chart</code></p> <p></p> <p>Next, Click Edit Code.</p> <p></p> <p>From this point- everything else will be mostly done with code.</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#the-code","title":"The Code","text":"<p>I started my diagram with the example provided in the ha-sankey-diagram repository. </p> <p>I will use my top panel as an example for this post.</p> <p>Under sections, you can have many groups of entities. Imagine each group of entities as a section. The children collection under each entity, defines the links.</p> <p>Do note, if you don't have individual sensors for <code>grid_power_in</code>/<code>grid_power_out</code>/<code>battery_power_in</code>/<code>battery_power_out</code>, but you do have sensors for say, <code>sensor.grid_power</code>, then you may need to create a template to split that sensor into others. See Split Sensor into Negative and Positive Sensors. I had to do this for <code>sensor.battery_power</code> and <code>sensor.grid_power</code></p> <pre><code>type: custom:sankey-chart\ntitle: Power Sources\n\nunit_prefix: k          # You can change this to alter which units are displayed. Leaving it blank/null, will result in the dashboard being displayed in watts. `k` displays values in Kw.\nshow_names: true\nshow_icons: false\nshow_units: true\nshow_states: true\nwide: true\nmin_state: null         # You can change this value to hide entities which are blow this number. ie, Setting \"5\", would hide anything below 5kw. (Because- we defined the unit as Kw above)\nround: 2                # I chose to round these numbers to two decimal places.\nsections:\n\n  # For the first section, I put together all of the energy sources in my home.\n  - entities:\n      - entity_id: sensor.pv_power              # Solar Production\n        name: Solar Power\n        color: green\n        children:\n          - sensor.total_power_in               # In the children section, add links to this object's children.\n      - entity_id: sensor.battery_power_out     # Battery Power OUT (Don't use Battery power!)\n        name: Battery Power\n        color: purple\n        children:\n          - sensor.total_power_in\n      - entity_id: sensor.grid_power_in\n        name: Grid Power\n        color: red\n        children:\n          - sensor.total_power_in\n\n  # I created a home-assistant helper, via the GUI, to create a sensor with the sum of sensor.load_power, sensor.battery_power_in, and sensor.grid_power_out\n  - entities:\n      - entity_id: sensor.total_power_in\n        name: Incoming Power\n        remainder: losses\n        children:\n          - sensor.load_power\n          - sensor.battery_power_in\n          - sensor.grid_power_out\n          - losses                        # This is a \"special\" identifier. More below.     \n\n  # The next section, is to split the loads, into a section for critical loads, and non-critical loads. Do note, sensor.grid_power_out is not defined here, and will be passed into the next section.\n  - entities:\n      - entity_id: losses                 # This is a special type, which shows the \"unaccounted/remaining\" value, which is not accounted for. See https://github.com/MindFreeze/ha-sankey-chart#entity-types\n        type: remaining_parent_state\n        name: Inverter Overhead           # My assumption, these losses are likely inverter overhead. The value matches with the amount of overhead I would expect from my inverter.\n      - entity_id: sensor.load_power      \n        children:\n          - sensor.load_power_essential\n          - sensor.load_power_non_essential\n\n  - entities:\n      - entity_id: sensor.load_power_essential\n        color: blue\n        name: Critical Loads\n      - entity_id: sensor.load_power_non_essential\n        color: yellow\n        name: Non-Critical Loads\n      - entity_id: sensor.grid_power_out\n        color: red\n        name: Grid Export\n      - entity_id: sensor.battery_power_in\n        color: purple\n        name: Battery Storage\n</code></pre> <p>After you put all of that together, you will end up with a dashboard like this:</p> <p></p> <p>Then- just add more Sankey Charts into your vertical stack, until you have the desired information displayed.</p> <p>The end result?</p> <p></p> <p>For one last example- here is the YAML from my <code>Critical Loads</code> panel.</p> <pre><code>type: custom:sankey-chart\ntitle: Critical Loads\nshow_names: true\nshow_icons: false\nshow_units: true\nshow_states: true\nwide: true\nmin_state: 5\nround: 0\nsections:\n  - entities:\n      - entity_id: sensor.criticalloads\n        color: blue\n        remaining: untracked_critical\n        children:\n          - sensor.bedroom\n          - sensor.lights\n          - sensor.server\n  - entities:\n      - entity_id: sensor.bedroom\n        name: Office\n        color: LightBlue\n        remaining: Office - Other\n        children:\n          - sensor.gaming_pc_current_consumption\n          - sensor.wife_pc_current_consumption\n          - sensor.monitors_current_consumption\n          - sensor.internet_current_consumption\n          - sensor.work_pc_current_consumption\n          - sensor.bedroom_switch_current_consumption\n      - entity_id: sensor.lights\n        children:\n          - sensor.livingroom_ceiling_light_electric_consumption_w\n          - sensor.kitchen_light_electric_consumption_w\n          - sensor.dining_room_light_electric_consumption_w\n          - sensor.front_porch_light_watts\n          - sensor.entry_light_watts\n          - sensor.back_porch_electric_consumption_w\n          - sensor.middle_bathroom_light_electric_consumption_w\n          - sensor.middle_bathroom_light_electric_consumption_w\n          - sensor.middle_bedroom_electric_consumption_w\n          - sensor.bedroom_light_watts\n      - entity_id: sensor.server\n        color: plum\n        remaining: Server - Other\n        children:\n          - sensor.kube01_current_consumption\n          - sensor.kube05_current_consumption\n          - sensor.kube06_current_consumption\n          - sensor.nvr_current_consumption\n          - sensor.kasa_smart_plug_383a_2_current_consumption\n          - sensor.truenas_power\n      - entity_id: untracked_critical\n        type: remaining_parent_state\n        name: Untracked\n  - entities:\n      - entity_id: Office - Other\n        type: remaining_parent_state\n      - entity_id: Server - Other\n        type: remaining_parent_state\n      - entity_id: sensor.gaming_pc_current_consumption\n        name: Gaming PC\n        color: LightBlue\n      - entity_id: sensor.bedroom_switch_current_consumption\n        name: Office 10G Switch\n        color: LightBlue\n      - entity_id: sensor.wife_pc_current_consumption\n        name: Wife Gaming PC\n        color: LightBlue\n      - entity_id: sensor.monitors_current_consumption\n        name: Office Monitors\n        color: LightBlue\n      - entity_id: sensor.internet_current_consumption\n        name: Optical Media Converter\n        color: LightBlue\n      - entity_id: sensor.work_pc_current_consumption\n        name: Work PC\n        color: LightBlue\n      - entity_id: sensor.livingroom_ceiling_light_electric_consumption_w\n        name: Livingroom Lights\n      - entity_id: sensor.kitchen_light_electric_consumption_w\n        name: Kitchen Lights\n      - entity_id: sensor.dining_room_light_electric_consumption_w\n        name: Dining Room Lights\n      - entity_id: sensor.front_porch_light_watts\n        name: Front Porch Light\n      - entity_id: sensor.entry_light_watts\n        name: Entry Lights\n      - entity_id: sensor.back_porch_electric_consumption_w\n        name: Back Porch Light\n      - entity_id: sensor.middle_bedroom_electric_consumption_w\n        name: Server Room - Light\n      - entity_id: sensor.middle_bathroom_light_electric_consumption_w\n        name: Middle Bathroom - Light\n      - entity_id: sensor.middle_bathroom_light_electric_consumption_w\n        name: Middle Bathroom - Toilet Light\n      - entity_id: sensor.bedroom_light_watts\n        name: Office - Lights\n      - entity_id: sensor.kube01_current_consumption\n        name: Kubernetes - Kube01\n        color: plum\n      - entity_id: sensor.kube05_current_consumption\n        name: Kubernetes - Kube05\n        color: plum\n      - entity_id: sensor.kube06_current_consumption\n        name: Kubernetes - Kube06\n        color: plum\n      - entity_id: sensor.nvr_current_consumption\n        name: Blue Iris (NVR)\n        color: plum\n      - entity_id: sensor.truenas_power\n        name: TrueNAS / r730XD\n        color: plum\n      - entity_id: sensor.kasa_smart_plug_383a_2_current_consumption\n        name: Opnsense\n        color: plum\n</code></pre>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/home-assistant---energy-flow-diagram/#summary","title":"Summary?","text":"<p>I designed this dashboard mostly for the purpose of having a real-time display of instantaneous power usage in my home. </p> <p>This was not designed to track monthly costs, I believe the built-in energy dashboard does a decent-enough job at this already.</p> <p>But, for the purpose of quickly identifying what in your home is using energy at a particular moment in time, this visualization works amazingly well. </p> <p>Overall, I would say I have accomplished my goal.</p> <p>If, this sounds like a project which may be useful to you, hopefully I have provided the resources you need in order to be successful.</p>","tags":["Home Assistant","Energy Monitoring"]},{"location":"blog/2023/pioneer-mini-split-esphome/","title":"Pioneer Minisplit control using ESPHome","text":"<p>Around a year and a half ago, I installed a Pioneer Mini-split and integrated it with Home Assistant</p> <p>I used a local integration, which had a cloud dependency for the initial setup. And, since installation, it has been working flawlessly. </p> <p>However, last week, it completely stopped working and I was unable to reinitialize it. </p> <p>So- Today- I will be replacing the midea dongle, with a device running esphome.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#which-units-are-supported","title":"Which Units are supported?","text":"<p>From what I have gathered- this may work with these brands (And- maybe more)</p> <ul> <li>Artel</li> <li>Beko</li> <li>Carrier</li> <li>Comfee</li> <li>Electrolux</li> <li>Idea</li> <li>Midea</li> <li>Neoclima</li> <li>Pioneer</li> <li>Qlima</li> <li>Senville</li> </ul> <p>For the purpose of this article, I can only verify this works for my Pioneer WYS 9,000 BTU unit.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#tools-hardware-needed","title":"Tools / Hardware needed","text":"<p>To control your mini-split, we will need a ESP processor, with a usb-port, with a 3.3v step down.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#esp-dongle","title":"Esp dongle","text":"","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#option-1-buy-pre-made","title":"Option 1. Buy pre-made","text":"<ul> <li>Smartlight AC Wi-fi Module</li> <li>CloudFree Ductless HVAC Wi-Fi Module<ul> <li>This is the option I went with. For 15$ shipped, this is cheaper then I could have done it myself.</li> <li>To note- this is the EXACT same module as sold by Smartlight. Just- with quicker shipping in North America.</li> </ul> </li> </ul> <p>I will note- the above modules are made in Ukraine. So- this is a very small way of showing a bit of support during the current (as of 2022-2023) war between Ukraine and Russia.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#option-2-diy","title":"Option 2. DIY","text":"<p>If you wish to build your own module, please see the iot-uni-dongle Github. This repo offers plans, diagrams, and everything you will need to DIY a module.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#serial-programmer","title":"Serial Programmer","text":"<p>If you plan on building your own unit, you will need a serial to USB adaptor for initially flashing it.</p> <p>With the pre-made unit above- I did not need to flash using serial.</p> <p>With the pre-made unit above, we can OTA flash it. However, if OTA flashing fails- you will need a serial adaptor to reflash it.</p> <ul> <li>DSD Tech USB to TTL Adapter</li> </ul> <p>This has been my primary USB to Serial adaptor since 2020. It handles 3.3v, it handles 5v, and in general, it just works.</p> <p>This DOES use a FTDI chip.</p> <p>A pair of Test Hooks will allow you to quickly connect the serial pads to your serial programmer. These came in quite handy when I was reflashing Sonoff S31 Energy Plugs in bulk. </p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#compiling-esphome-firmware","title":"Compiling ESPHome Firmware","text":"","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#getting-esphome","title":"Getting Esphome","text":"<p>Assuming you have never used ESPhome before, it is pretty simple to get started.</p> <p>I personally have a local python install for flashing new devices and testing locally. Once I have validated the new device is able to connect to my network, I copy the configuration file over to my ESPHome docker container where I can then centrally manage my Esphome devices.</p> <p>If, you are using Home-Assistant with the Esphome addon, you can copy the configurations to there. </p> <ul> <li>Esphome - Getting Started</li> <li>Installing Esphome Locally via Python</li> <li>Dockerhub - Esphome</li> </ul>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#creating-configuration-file-for-minisplit","title":"Creating configuration file for minisplit","text":"<p>I will start building my configuration from the example provided by Esphome.</p> <ul> <li>Esphome - Midea Air Conditioner</li> </ul> <p>If, you use Esphome for building your configuration, it does provide a nice interface with descriptions for attributes</p> <p></p> <p>After taking the example provided by ESPHome, and merging in my configuration files- here is the resulting configuration I came up with:</p> bedroom_minisplit.yaml<pre><code>substitutions:\n  devicename: \"bedroom_minisplit\"\n  friendly_name: \"Bedroom Minisplit\"\n  ip_address: 10.100.3.120\n  gateway: 10.100.3.1\n  &lt;&lt;: !include secrets.yaml\n\n&lt;&lt;: !include common/common.yaml\n\nesphome:\n  name: ${devicename}\n  friendly_name: ${friendly_name}\n\nesp8266:\n  early_pin_init: false\n  board: esp12e\n\n# Disable logging over UART (required)\nlogger:\n  baud_rate: 0  \n\nsensor:\n  # Wifi Signal\n  - &lt;&lt;: !include common/sensor-wifi-signal.yaml\n\n  # Uptime\n  - &lt;&lt;: !include common/sensor-uptime.yaml\n\nbutton:\n  # Restart Button\n  - &lt;&lt;: !include common/button-restart.yaml\n\nswitch:\n  - platform: template\n    name: Beeper\n    icon: mdi:volume-source\n    optimistic: true\n    turn_on_action:\n      midea_ac.beeper_on:\n    turn_off_action:\n      midea_ac.beeper_off:\n\nstatus_led:\n  pin:\n    number: GPIO13\n    inverted: yes\n\n# UART settings for Midea dongle (required)\nuart:\n  tx_pin: 1         # hardware dependant\n  rx_pin: 3         # hardware dependant\n  baud_rate: 9600\n\n# Main settings\nclimate:\n  - platform: midea\n    name: bedroom               # Use a unique name.\n    period: 1s                  # Optional\n    timeout: 2s                 # Optional\n    num_attempts: 3             # Optional\n    autoconf: true              # Autoconfigure most options.\n    beeper: false               # Beep on commands.\n    visual:                     # Optional. Example of visual settings override.\n      min_temperature: 15       # Note these values are in C\n      max_temperature: 30\n      temperature_step: 1       # This defaults to 0.5. I don't have a need for half-degree increments....\n    supported_swing_modes:      \n      - VERTICAL\n      - HORIZONTAL\n      - BOTH\n</code></pre> <p>If, you are curious regarding the contents of some of my common includes- I have created a basic page detailing my comment components</p> <p>After you have your configuration ready- compile it via esphome.</p> <p><code>esphome compile bedroom_minisplit.yaml</code></p> <p>Note- I used compile, instead of run, as I plan on OTA uploading the resulting firmware.</p> <p></p> <p>We will need the compiled firmware here in a minute. Take note of the resulting path.</p> <p>Note- don't plug the module into your computer.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#installation","title":"Installation","text":"<p>To start with, in my Pioneer WYS unit, the module which holds the USB dongle, is held into place by a single phillips screw. Remove the screw and lower the module.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#modifying-usb-port-dependant-on-your-unit","title":"Modifying USB Port (Dependant on your unit)","text":"<p>This- may not be required, and is dependant on your particular model of Mini-split.</p> <p>However, My Pioneer WYS series, had a few \"extra\" grooves on the USB slot.</p> <p></p> <p>To \"fix\" this issue, I used a knife to shave off the extra edges, which allowed the ESP module to correctly fit into the USB port.</p> <p>An exacto-knife would likely be a better tool. However, I only had my pocket-knife handy.</p> <p>The fix does not need to be perfect, but, you do need to shave off enough of the groove for your unit to properly fit.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#temporarily-module-and-test","title":"Temporarily Module and Test","text":"<p>Before final reassembly, I wanted to flash my new firmware onto the module, and ensure everything is working as expected.</p> <p></p> <p>Note- I do not have the plastic enclosure attached right now, as I want to ensure everything works correctly before wrapping the components in the plastic.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#ota-flashing-directions","title":"OTA Flashing Directions","text":"<p>Assuming your module works, and was able to correct fit into the USB port- you should now be able to connect to the device's WiFi.</p> <p>If, you are using the CloudFree/SmartLight module, you will see a new access point named, \"AC-Wifi\". </p> <p></p> <p>Connect using the password <code>slwf01pro</code></p> <p>Afterwards, open a browser and navigate to <code>http://192.168.4.1</code></p> <p>The top section of this page, will list APs which you can connect the unit to. At the bottom, you will see a section named \"OTA Update\"</p> <p>Click Choose File, and select the \".bin\" file you compiled using ESPHome earlier.</p> <p></p> <p>After a bit, the web page will open a prompt letting you know it was successfully flashed.</p> <p>At this time, I opened a command prompt with a ping to the IP address I specified in the above configuration file.</p> <p></p> <p>After the device started pinging successfully- I checked the ESPHome dashboard to ensure it was displaying \"Online\"</p> <p></p> <p>From this point, It was time to reassemble the device.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#mounting-the-new-esp-module","title":"Mounting the new ESP Module","text":"<p>The first step- was to reinsert the module into the plastic holder.</p> <p></p> <p>Since, the USB module was pretty small, I left it inserted, and carefully placed it into the enclosure.</p> <p>Here is the reverse side, after re-attaching the enclosure.</p> <p></p> <p>Finally- reattach the plastic enclosure with the single phillips head screw.</p> <p></p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#add-the-device-to-home-assistant","title":"Add the device to Home Assistant","text":"<p>This, follows the standard process of joining an ESPHome device to home assistant. </p> <p>To summarize:</p> <ol> <li>Goto Home Assistant</li> <li>Goto Devices / Integrations</li> <li>Click Add Device</li> <li>Select \"ESPHome\"</li> <li>Type in the IP Address of the device.</li> <li>Enter your encryption key</li> <li>Select the device's Area.</li> <li>You are done!</li> </ol> <p>After- doing those steps, you should see the new device in home assistant.</p> <p></p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#next-steps","title":"Next Steps?","text":"<p>After the device is working properly in home assistant- I would recommend adding schedules!</p> <ul> <li>Home Assistant - Programmable Thermostat GUI</li> </ul>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/pioneer-mini-split-esphome/#why-did-the-old-integration-fail","title":"Why did the old integration fail?","text":"<p>On the plus side, the old method using the midea/pioneer dongle did work FLAWLESSLY for over a year. Not a single issue.</p> <p>Two weeks ago, however, I woke up to it being 55F in my room and discovered something was not working correctly. </p> <p></p> <p>Obviously, something was very wrong with it. </p> <p>The first thing I did, was test its wifi connectivity. After validating it could ping, and I was able to open a telnet session to the dongle's port- I check the home assistant logs.</p> <p></p> <p>My best guess is the midea/pioneer dongle lost its configuration.</p> <p>I did temporarily grant the old dongle access to the internet, and attempt to generate a new pair of keys, however, I was unsuccessful. </p> <p>After looking at the github and integration, I realized they have not been updated in over a year. After doing more and more research, I discovered the now-recommended approach for integrating with these units, is to use the method outlined in this post.</p> <p>So- while the unit from CloudFree was in the mail- I Attempted to use the \"msmart\" app to set schedules on my unit.</p> <p>The few days suffering through the cloud app reminded me 100% of the reason I do everything full local.</p> <p>The cloud app would randomly not work. It would end up failing to set schedules. Every change made to a schedule would instead duplicate a new schedule. </p> <p>And- every time you opened the app, it would forget you had devices. It was just horrible.</p> <p>But- I am happy to know my integration is now running firmware locally compiled by me.</p>","tags":["Home Assistant","ESPHome","HVAC"]},{"location":"blog/2023/2023-prime-day-deals/","title":"2023 Prime Day Deals","text":"<p>Interested in home automation? Here are a few of the prime day deals I would personally recommend. </p> <p>Note, this is not a kitchen-sink post full of non-relaxant links, but, rather, a list of things I have hands on experience with. </p> <p>Every single product linked below, will work with Home Assistant, 100% LOCALLY, without any required cloud services or subscriptions.</p> <p>If, you need reasons as to why required cloud services are bad, see Reasons to avoid cloud products</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#home-automation","title":"Home Automation","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#smart-plugs","title":"Smart Plugs","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-sonoff","title":"[Wifi] Sonoff","text":"<p>Warning</p> <p>Warning! The Sonoff S40s are on sale, and are cheap. However, they do not leverage a esp-based processor, and cannot be easily flashed!</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#sonoff-s31","title":"Sonoff S31","text":"<p>These are my absolute favorite smart plug at this point in time. I have 30 of these laying around. I use them for turning things on and off. I use them for tracking energy consumption.</p> <p>Rock solid plugs.</p> <p>These are flashable to tasmota / esphome. These work 100% locally. The built-in firmware will also work locally too.</p> <p>Native home assistant integration.</p> <ul> <li>Amazon</li> <li>My Review / Install / Guide (2023)</li> <li>Esphome</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#sonoff-s31-lite","title":"Sonoff S31 Lite","text":"<p>If you don't need energy monitoring, and want to save a few bucks over the S31, you can instead opt for the S31 Lite.</p> <p>Rock solid plugs.</p> <p>These are flashable to tasmota / esphome. These work 100% locally. The built-in firmware will also work locally too.</p> <p>Native home assistant integration.</p> <ul> <li>Amazon</li> <li>Esphome</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-tplink-kasa","title":"[Wifi] Tplink Kasa","text":"<ul> <li>NATIVE Home-Assistant Integration</li> <li>100% local control.</li> <li>Kasa devices DO require you to do initial setup using the kasa app. However, can be controlled completely by home-assistant afterwards.</li> </ul> <p>Warning</p> <p>Be careful updating the firmware of kasa devices. They have removed local-only control in the past.</p> <p>More Inforamtion</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#kasa-hs103","title":"Kasa HS103","text":"<p>Generic 15 amp smart plug. No energy monitoring.</p> <p>I still have 10 of these around the house, and they do work well. But, I prefer sonoff S31s flashed with esphome instead.</p> <p>These do work 100% locally, but, requires a phone app for initial setup.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#kp405-outdoor-watertight-dimmer","title":"KP405 - Outdoor Watertight Dimmer","text":"<p>These plugs are quite handy for outdoor use. I have one I use for controlling yard decorations during christmas time. </p> <p>These do work 100% locally, but, requires a phone app for initial setup.</p> <ul> <li>Kasa KP405</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-zooz-zen05-outdoor-plug","title":"[Z-Wave] Zooz ZEN05 Outdoor Plug","text":"<p>Outdoor IP65 rated single-socket smart plug, using z-wave.</p> <ul> <li>Amazon - Zooz ZEN05</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#powerstrips","title":"Powerstrips","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-kasa-hs300","title":"[Wifi] Kasa HS300","text":"<p>6 socket, individually controllable powerstrip with per-plug energy monitoring. </p> <p>These do work 100% locally, but, requires a phone app for initial setup.</p> <p>Native home assistant integration.</p> <ul> <li>Kasa HS300 - Amazon</li> <li>My HS300 Review / Install / Guide (2022)</li> </ul> <p>I have 5 of these around for various use-cases, and can say, they work pretty nicely.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#other","title":"Other","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-shelly-assorted","title":"[Wifi] Shelly (Assorted)","text":"<p>All of these products can be flashed to esphome. These are also quite small, and will easily fit inside of a normal outlet box, or switch box.</p> <p>I have been running the older variants for years. The new \"Plus\" models are based on esp32 instead of esp8266, and offer bluetooth now as well.</p> <ul> <li>Shelly Plus 1PM<ul> <li>Single circuit with energy monitoring.</li> <li>Esphome</li> </ul> </li> <li>Shelly Plus 2PM<ul> <li>two circuits with energy monitoring</li> <li>Esphome</li> </ul> </li> <li>Shelly 1 Plus<ul> <li>DRY CONTACT switch. (Can be used to switch low voltage DC loads, such as your garage door.)</li> <li>Esphome</li> </ul> </li> <li>Shelly EM<ul> <li>Supports monitoring up to two channels, 120 amps each. This is used for energy monitoring only.</li> <li>Esphome</li> </ul> </li> <li>Shelly RGBW2<ul> <li>Used to control RGB / RGBW LEDs. Does NOT control individually addressable LEDs (ie. WS2812b)</li> <li>Esphome</li> </ul> </li> <li>Shelly Dimmer 2<ul> <li>Used to control up to two lighting circuits. Supports dimming.</li> <li>Esphome</li> </ul> </li> <li>Shelly i4<ul> <li>This is a pretty niche device. It has 4 inputs, and is intended to be used to trigger other actions externally.</li> <li>Esphome</li> </ul> </li> <li>Shelly Plus Addon<ul> <li>You can connect sensors up to this. It doesn't control or switch loads. But- you can connect temp sensors to it.</li> </ul> </li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-zooz-800-series-z-wave-stick","title":"[Z-Wave] Zooz 800-series Z-Wave Stick","text":"<p>My current z-wave stick is a zooz 700 series. It has been rock solid so far, with no issues to speak of. BUT, you can get a 800 series stick pretty cheap right now.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#why-800-series-over-700-series","title":"Why 800 series over 700 series?","text":"<p>If you are curious to know the difference between 700 series, and 800 series- I was too. Here are the differences</p> <p>Differences:</p> <ol> <li>Longer max range. (1.5+ miles vs 1 mile)</li> <li>S2 + Secure Vault.. (Its more secure... somehow.)</li> </ol> <p>The TLDR; if you already have a 700-series stick, I don't think it is worth upgrading. But, if you are on a 500 series stick, I'd consider upgrading.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-aeotec-z-stick-7-plus","title":"[Z-Wave] Aeotec Z-Stick 7 Plus","text":"<p>If, you need a z-wave hub, Aeotec has an option on sale.</p> <p>These work natively with home assistant. </p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-zooz-remote-control-switch","title":"[Z-Wave] Zooz Remote Control Switch","text":"<p>Z-wave by design, works 100% locally, and doesn't have the capability of talking to the internet even if it wanted to. </p> <p>Do note- Z-wave does require you to have a z-wave hub.</p> <p>Info</p> <p>Note- this is NOT a light switch. Instead, this is a battery-operated z-wave remote-control button, which looks like a light switch.</p> <p>This is generally used to control other z-wave based devices using scenes.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#zigbee-sonoff-zigbee-30-dongle","title":"[Zigbee] Sonoff Zigbee 3.0 Dongle","text":"<p>Disclaimer- I have not used this product before, and cannot confirm nor deny how well it functions.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#light-switches","title":"Light Switches","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-kasa-hs200-light-switch","title":"[Wifi] Kasa HS200 - Light Switch","text":"<p>While, all new switches I replace are generally z-wave based, or something running esphome- I do have one of these in my hallway, and it has been in place since 2020.</p> <p>And- it still works exactly as well as it did three years ago. That being said, there aren't many fancy features, but, it does work.</p> <p>These do work 100% locally, but, requires a phone app for initial setup. Does require neutral wire.</p> <p>Native home assistant integration.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#alarm-components","title":"Alarm Components","text":"<p>Do note, I am ONLY going to recommend things that will work 100% locally, with home-assistant, without a required subscription / application / etc....</p> <p>So, no ring doorbells.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-ring-alarm-14-piece-kit","title":"[Z-Wave] Ring Alarm - 14 piece kit","text":"<p>All of these components will work with a proper z-wave setup, WITHOUT having a ring/amazon account. </p> <p>These keypads, work really nicely. Please see my write-up for details on how to make them work with home assistant very easily. </p> <ul> <li>Amazon</li> <li>My Post - Home Assistant Alarm</li> <li>My Post - Embedded Door Sensors</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#kiosks","title":"Kiosks","text":"<p>The 50$ I spent on my refurbished Fire HD10 tablet, has been well worth it. It functions as a kiosk sitting beside my desk, showing me vitals for my home, solar production, and giving quick access to common things.</p> <p>Do note- if you isolate these devices from the internet (HIGHLY recommended), there are no lock screen ads.</p> <p>Xtremeownage.com - Fire Tablet as Home Assistant Kiosk</p> <p>Having ran my fire tablet as a kiosk for over a year, I would highly recommend one. Just- make sure to keep it 100% isolated from the internet!!!!</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-fire-tablet","title":"[Wifi] Fire Tablet","text":"<ul> <li>Amazon - HD 10</li> <li>Amazon - HD 8</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#weather-temp-environment-monitoring","title":"Weather / Temp / Environment Monitoring","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#433mhz-acurite","title":"[433mhz] Acurite","text":"<p>Most of the acurite hardware works over 433mhz.</p> <p>You WILL need a working 433mhz setup to properly integrate into home assistant.</p> <p>RTL-433 Getting Started</p> <ul> <li>Acurite Iris 5-in-1</li> </ul> <p>(Sadly, I didn't find any of the other acurite hardware on sale)</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#smart-blinds","title":"Smart Blinds","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#z-wave-iblinds-v3-smart-motor-kit","title":"[Z-Wave] iBlinds v3 Smart Motor Kit","text":"<p>Disclaimer- I have not personally used this product. However- this is a z-wave controlled motor you can retrofit into your existing blinds.</p> <ul> <li>Amazon</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/2023-prime-day-deals/#wifi-switchbot-blind-tilt-control","title":"[Wifi] Switchbot Blind Tilt Control","text":"<p>Disclaimer- I have not personally used this product either.</p> <p>However, this offers tilt control for your blinds. As well, it is solar powered with its own battery.</p> <ul> <li>Amazon</li> <li>Local, Native Home Assistant</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/proxmox---coral-tpu-usb-passthrough/","title":"Proxmox - Coral TPU USB Passthrough","text":"<p>This is a very short guide, on passing a USB Coral TPU through to a Proxmox VM.</p>","tags":["Home Assistant","Homelab","NVR"]},{"location":"blog/2023/proxmox---coral-tpu-usb-passthrough/#step-1-install-coral-tpu-drivers-on-proxmox","title":"Step 1. Install Coral TPU Drivers on Proxmox","text":"<p>By default, without the coral TPU drivers installed on proxmox, you will see this:</p> <pre><code>root@kube04:~# lsusb\nBus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub\nBus 001 Device 003: ID 1a6e:089a Global Unichip Corp.\nBus 001 Device 002: ID 046d:c31c Logitech, Inc. Keyboard K120\nBus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\n</code></pre> <p>To fix this, we will follow the official instructions here</p> <p>Here are the commands.</p> <pre><code>echo \"deb https://packages.cloud.google.com/apt coral-edgetpu-stable main\" | tee /etc/apt/sources.list.d/coral-edgetpu.list\n\ncurl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -\n\napt-get update\n\napt-get install libedgetpu1-std\n</code></pre> <p>After running these commands, and installing the package.. Unplug the stick, and plug it back in. </p> <p>Then, wait a few minutes.</p> <p>Afterwards, you will instead see this:</p> <pre><code>root@kube04:~# lsusb\nBus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub\nBus 001 Device 005: ID 18d1:9302 Google Inc.\nBus 001 Device 002: ID 046d:c31c Logitech, Inc. Keyboard K120\nBus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\n</code></pre> <p>This step was needed, because the USB Device ID changes.</p> <p>Take note of the ID. You will need it in the next step.</p>","tags":["Home Assistant","Homelab","NVR"]},{"location":"blog/2023/proxmox---coral-tpu-usb-passthrough/#step-2-pass-the-device-to-your-vm","title":"Step 2. Pass the device to your VM.","text":"<p>In my case, I could not see this device listed in the GUI, so, everything was done through the CLI.</p> <p>Find your VM's ID. You can use the GUI if you choose. Or, you can use bash.</p> <pre><code>root@kube04:~# qm list\n      VMID NAME                 STATUS     MEM(MB)    BOOTDISK(GB) PID\n       123 rancher              running    2048              32.00 690075\n       131 rke-worker-4         running    8192              64.00 16128\n</code></pre> <p>In my case, I want to pass the coral TPU through to rke-worker-4. Here is the command which will be used.</p> <p>So, now, a simple command will do the rest.</p> <pre><code>qm set 131 -usb0 host=18d1:9302\n</code></pre> <p>Voila. The device is now passed into the VM.</p> <p>You should now be able to see the device inside of your VM.</p> <pre><code>root@rke-worker-4:/mnt/nvr# lsusb\nBus 003 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub\nBus 002 Device 002: ID 18d1:9302 Google Inc.\nBus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\nBus 001 Device 002: ID 0627:0001 Adomax Technology Co., Ltd QEMU Tablet\nBus 001 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\n</code></pre> <p>Note</p> <p>You may need to install the drivers/software inside of your VM, in order to properly use it.</p> <p>If so, follow the same directions in step 2.</p>","tags":["Home Assistant","Homelab","NVR"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/","title":"Sonoff S31 - Low Cost Energy Monitoring","text":"<p>Everyone wants to monitor energy consumption. Everyone wants to automate their home.</p> <p>The Sonoff S31, is a pretty low-cost way of doing this.</p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#pros-cons","title":"Pros / Cons","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#why-choose-the-sonoff-s31","title":"Why choose the Sonoff S31?","text":"<ol> <li>15 amp capacity. So, as long as you aren't plugging an air compressor or air conditioner in, it will work.<ul> <li>If you need to run a large appliance, I recommend looking at the Zooz Zen15</li> </ul> </li> <li>Cheap! Around 5-7$ per plug.</li> <li>Can be flashed to open source firmware, such as ESPHome or Tasmota.</li> <li>Meets UL and CSA 60730-1. CE/FCC/ROHC Certified. Newer versions are UL certified. </li> </ol>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#cons","title":"Cons","text":"<ol> <li>Some soldering may required to flash these with open source firmware.<ul> <li>If you use test-pins (linked below), you can flash these devices without soldering.</li> </ul> </li> <li>Some technical ability is required, to flash these with open source firmware. </li> </ol>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#where-to-get-it","title":"Where to get it?","text":"<ul> <li>Amazon</li> <li>Sonoff</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#how-to-flash-it","title":"How To Flash it.","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#some-tools-required","title":"Some tools required","text":"<p>To connect to the UART pins, you will either need to solder on jumper wires, OR, you can use test hooks.</p> <ul> <li>A soldering iron</li> <li>Test Hooks<ul> <li>These can be used instead of soldering wires onto the pins. I strongly recommend this route. It is much faster, and there is a greatly reduced chance of lifting a pad.</li> </ul> </li> <li>A phillips #1 bit. Make sure you have a #1, otherwise, its easy to strip out the screws.</li> <li>A Serial Adapter. I have been using this DSD Tech Adapter for the past few years, with no issues. It supports 3v and 5v.</li> <li>(Optional) Label maker, or sharpie.<ul> <li>Used to mark identifiers on the plugs. </li> <li>Dymo LetraTag 100H I recommend this unit. Has been going strong for years for me. </li> </ul> </li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#firmware-links","title":"Firmware Links","text":"<p>I personally, will be running esphome on my plugs.</p> <ul> <li>Esphome configuration</li> <li>Tasmota Configuration</li> <li>Espurna</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#flash-it","title":"Flash it.","text":"<p>For a more detailed disassembly, please see THIS POST I found on the internet. I will be skimming over the basics.</p> <p>If you like videos:</p> <ul> <li>Video - Open Source Home</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-1-remove-grey-end-cap","title":"Step 1. Remove grey end cap","text":"<p>To remove the endcap, squeeze a knife, or sharp edge between the grey cap, and the white body. </p> <p>When the corner pops out a little bit, walk the knife around the entire body to remove the cap. Be careful not to break the plastic tabs.</p> <p>Once the cap has been removed, the two plastic \"edges\" will slide off. </p> <p>Afterwards, the three screws will be exposed.</p> <p>Use a phillips #1 bit to remove these screws. My screws were on pretty tight, if you do not have the correct screwdriver, you run the risk of stripping these screws.</p> <p>After the screws have been loosed enough, you can pull the unit out of the body.</p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#connect-to-serial-adapter","title":"Connect to serial adapter","text":"","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#the-hard-way-via-soldering","title":"The hard way - Via Soldering","text":"<p>Warning</p> <p>Do NOT solder on a header like I did in the following image. If you do, you run a higher risk of pulling one of the pads.</p> <p>Instead, solder on loose wires. Be careful to not put extra pressure on the pads. They WILL come off, and you will not be able to flash your unit.</p> <p>Ask me how I know....</p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#the-easy-way-with-test-leads","title":"The easy way - with test leads","text":"<p>This occurred after I initially published this post, however, I picked up another 4 pack of these plugs.. along with, test leads.</p> <p>With test leads, just place the leads on the pads.</p> <p></p> <p>Closeup on leads attached to pads.</p> <p></p> <p>Closeup on serial adapter.</p> <p></p> <p>This method was much faster, without the risk of lifting a pad. I was able to disassemble, flash, and reassemble 4 units in under 10 minutes.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-3-connect-your-serial-adapter","title":"Step 3. Connect your serial adapter","text":"<p>Pin Connections from Serial Interface TO Sonoff:</p> <ul> <li>RX -&gt; TX</li> <li>TX -&gt; RX</li> <li>VCC -&gt; VCC</li> <li>GND -&gt; GND</li> </ul> <p></p> <p>Info</p> <p>Before you plug the serial adapter in, you will need to hold the button on top of the S31. </p> <p>Continue holding the button for a few seconds AFTER it is plugged in. </p> <p>This is required before the unit will be able to be flashed.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-4-flash-your-firmware","title":"Step 4. Flash your firmware","text":"<p>Since I will be using esphome, the command I will need to run is...</p> <p><code>esphome my-s31-config.yaml run</code></p> <p>After it compiles, it will ask you how to connect. If you don't see the option for your serial port adapter, make sure you have the FTDI drivers installed.</p> <p>Afterwards, it should start uploading the firmware. The unit will automatically restart after it is flashed.</p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-5-flash-the-rest-of-them","title":"Step 5. Flash the rest of them!","text":"<p>I wanted to make sure I could successfully flash one, before starting on the other units.</p> <p>Since I was successful in flashing the first one, I started the process of disassembling the rest, and flashing them. </p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-6-reassembly","title":"Step 6. Reassembly","text":"<p>The reassembly is pretty simple for the most part.</p> <p>Slide the edges back into place. And, snap the end cap on.</p> <p>I will note, when you install the end cap, make sure to line up the corner.</p> <p></p> <p>I spent a while trying to get the corners on successfully, until I realized I was not lining up the \"odd\" corner. </p> <p>So- if you are having issues putting the end caps back into place, Just- check the corner.</p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#step-7-label-them-optional","title":"Step 7. Label them (Optional)","text":"<p>I personally prefer labeling my units to make it easier to identify them at a glance.</p> <p>Since, I include a static IP in each of the ESPHome configurations I push out, I choose to identify them via IP address.</p> <p>I don't use the device name, because these units do occasionally get re-allocated for other purposes.</p> <p></p> <p>If you are looking for a label maker, I have nothing but positive to say regarding my DYMO 100H. Even the refills are cheap for it. </p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#add-it-to-home-assistant","title":"Add it to home assistant","text":"<p>In Home Assistant, goto integrations.</p> <p>Search for <code>Esphome</code>. Click Add.</p> <p>Type in the IP Address you provisioned for your device. Poof, you are all done!</p> <p>I used one of these plugs for monitoring the energy consumption of my deep freezer. Here is a look at that within Home Assistant.</p> <p></p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#history","title":"History","text":"<ul> <li>2023-03-17 - Post initially published. Flashed 4 units via flashing.</li> <li>2023-03-19 - Second 4-pack arrived. Flashed more more units, using test-leads instead. Much faster.</li> </ul>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2023/sonoff-s31---low-cost-energy-monitoring/#disclaimers","title":"Disclaimers","text":"<p>Not Sponsored</p> <p>This content is not sponsored or affiliated by Sonoff.</p> <p>All products and materials were purchased by me for personal use.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Home Assistant","Energy Monitoring","ESPHome"]},{"location":"blog/2024/proxmox---install-haos/","title":"Proxmox - Install Home Assistant (Script)","text":"<p>Recently, I needed to spin up a HAOS VM for testing an integration I am developing.</p> <p>I realized- most of the methods, either have multiple steps, and/or are not very transparent.</p> <p>So- I created a script, which you can fully review, and copy/paste into your Proxmox system to fully install Home Assistant OS into a VM.</p> <p>You only need to fill out your target storage and network bridge.</p>","tags":["Homelab","Proxmox","Home Assistant"]},{"location":"blog/2024/proxmox---install-haos/#script","title":"Script","text":"<pre><code>#!/bin/bash\n# Home Assistant VM Setup Script\n# This script downloads and sets up a Home Assistant VM on Proxmox using API commands.\n\n##################################################################################\n####### Variables you NEED to check and configure.\n##################################################################################\n\nHAOS_BRIDGE=\"vmbr0\"                  # Network bridge, defaults to vmbr0. This- should be set to YOUR network bridge.\nHAOS_STORAGE=\"local-lvm\"             # Storage for Home Assistant OS\nEFI_STORAGE=$HAOS_STORAGE            # Storage where EFI disk will be kept. (Defaults to the same storage as HAOS)\n\n# To get the latest image URL\n# Goto https://www.home-assistant.io/installation/alternative\n# Copy the URL for \"KVM/Proxmox\", Paste below. Don't forget quotes.\nIMAGE_URL=\"https://github.com/home-assistant/operating-system/releases/download/12.4/haos_ova-12.4.qcow2.xz\" # URL to the VM image\n\n##################################################################################\n####### Variables which you can customize, if desired.\n##################################################################################\n\nVM_NAME=\"HomeAssistantVM\"            # The name of the created VM.\nSTART_AT_BOOT=true                   # Start at boot (true/false) You typically want to leave this set to true.\nSTART_AFTER_CREATE=true              # Start the VM after this script completes.\n\n##################################################################################\n####### VM Resources\n##################################################################################\n\nCPU_CORES=4                          # Number of CPU Cores\nMEMORY=4096                          # Memory in MB\n\n##################################################################################\n####### Optional Variables\n##################################################################################\n\n# This will be the generated VM_ID for the new VM.\n# It defaults to using the next available VM_ID from the proxmox API.\n# You can customize this, but, there is generally no need to.\nVM_ID=$(pvesh get /cluster/nextid)  # VM ID, default to the next available ID using the Proxmox API\n\n\n##################################################################################\n####### Do not touch below here!\n##################################################################################\n\n# This, is a temporary location where the image will be downloaded, and extracted, before being imported.\n# This script contains a cleanup method which deletes this directory after the script either finishes OR fails.\n# As such... if you put a persistent directory here- be aware- that it will get deleted after this script exists....\nTEMP_DIR=$(mktemp -d)                # Create a temporary directory for the image\n\n##################################################################################\n####### Validate Parameters\n##################################################################################\n\n# This section exists to validate some of the provided input parameters, and variables.\n# It does not validate everything, and is not intended to. However, it does validate a few common items.\n\n# Function to validate storage\nvalidate_storage() {\n  local storage_name=$1\n  if ! pvesh get /storage/$storage_name &gt; /dev/null 2&gt;&amp;1; then\n    echo \"Error: Storage '$storage_name' does not exist.\"\n    exit 1\n  fi\n  echo \"Success: Storage '$storage_name' exists.\"\n}\n\n# Function to validate network bridge\nvalidate_bridge() {\n  if ! pvesh get /nodes/$(hostname)/network/$HAOS_BRIDGE &gt; /dev/null 2&gt;&amp;1; then\n    echo \"Error: Network bridge '$HAOS_BRIDGE' does not exist.\"\n    exit 1\n  fi\n  echo \"Success: Network bridge '$HAOS_BRIDGE' exists.\"\n}\n\n# Function to check if VM ID exists\nvalidate_vm_id() {\n  if pvesh get /cluster/resources --type vm | grep -wq $VM_ID; then\n    echo \"Error: VM ID '$VM_ID' already exists.\"\n    exit 1\n  fi\n  echo \"Success: VM ID '$VM_ID' does not already exist.\"\n}\n\n# Validate storage, bridge, and VM ID\necho \"Validating storage, network bridge, and VM ID...\"\nvalidate_storage $EFI_STORAGE\nvalidate_storage $HAOS_STORAGE\nvalidate_bridge\nvalidate_vm_id\n\n##################################################################################\n####### Script Cleanup\n##################################################################################\n\nSUCCESS=false\n\n# Cleanup function to remove temporary directory and clean up VM if creation fails\ncleanup() {\n  echo \"Removing temp directory.\"\n  rm -rf $TEMP_DIR\n#   if [ ! -z \"$VM_ID_CREATED\" ]; then\n#     echo \"Cleaning up VM $VM_ID...\"\n#     pvesh delete /nodes/$(hostname)/qemu/$VM_ID\n#   fi\n}\n\n# Ensure the temp directory gets cleaned up\ntrap cleanup EXIT\n\n##################################################################################\n####### Methods / Helpers / etc...\n##################################################################################\n\n# Method to download and extract the VM image\n#\n# This method downloads the Home Assistant OS image from the specified URL and extracts it.\n# It uses the following global variables:\n# - IMAGE_URL: The URL to download the image from\n# - TEMP_DIR: The temporary directory where the image will be downloaded and extracted\ndownload_and_extract_image() {\n  local IMAGE_NAME=\"haos.qcow2\"\n  local COMPRESSED_IMAGE=\"$TEMP_DIR/$IMAGE_NAME.xz\"\n  local EXTRACTED_IMAGE=\"$TEMP_DIR/$IMAGE_NAME\"\n\n  # Download the VM image\n  echo \"Downloading the VM image from $IMAGE_URL...\"\n  if ! wget -O \"$COMPRESSED_IMAGE\" \"$IMAGE_URL\"; then\n    echo \"Error: Failed to download the VM image.\"\n    exit 1\n  fi\n\n  # Check if the download was successful\n  if [ ! -f \"$COMPRESSED_IMAGE\" ]; then\n    echo \"Error: Downloaded file $COMPRESSED_IMAGE does not exist.\"\n    exit 1\n  fi\n\n  # Expand the compressed image\n  echo \"Expanding the VM image...\"\n  if ! unxz \"$COMPRESSED_IMAGE\"; then\n    echo \"Error: Failed to extract the VM image.\"\n    exit 1\n  fi\n\n  # Check if the extraction was successful\n  if [ ! -f \"$EXTRACTED_IMAGE\" ]; then\n    echo \"Error: Extracted file $EXTRACTED_IMAGE does not exist.\"\n    exit 1\n  fi\n\n  echo \"VM image downloaded and extracted successfully to $EXTRACTED_IMAGE.\"\n}\n\n# Method to create the VM using Proxmox API\n#\n# This method creates a VM on the Proxmox server using the API. It uses the following global variables:\n# - VM_ID: The ID for the VM\n# - VM_NAME: The name for the VM\n# - MEMORY: The amount of memory in MB\n# - CPU_CORES: The number of CPU cores\n# - HAOS_BRIDGE: The network bridge to use\n# - EFI_STORAGE: The storage to use for the EFI disk\n# - START_AT_BOOT: Boolean indicating if the VM should start at boot (true/false)\ncreate_vm() {\n  echo \"Creating the VM...\"\n\n  # Construct the API command to create the VM\n  VM_ID_CREATED=$(pvesh create /nodes/$(hostname)/qemu \\\n    -vmid $VM_ID \\\n    -name $VM_NAME \\\n    -memory $MEMORY \\\n    -cores $CPU_CORES \\\n    -net0 model=virtio,bridge=$HAOS_BRIDGE \\\n    -boot order=virtio0 \\\n    -machine q35 \\\n    -bios ovmf \\\n    -agent enabled=1,type=virtio \\\n    -efidisk0 ${EFI_STORAGE}:32,pre-enrolled-keys=0 \\\n    -onboot $([ \"$START_AT_BOOT\" = true ] &amp;&amp; echo 1 || echo 0)\n  )\n\n  # Echo the configuration of the created VM\n  echo \"VM $VM_NAME (ID: $VM_ID) has been created with the following configuration:\"\n  echo \"Memory: $MEMORY MB\"\n  echo \"CPU Cores: $CPU_CORES\"\n  echo \"Network Bridge: $HAOS_BRIDGE\"\n  echo \"EFI Storage: $EFI_STORAGE\"\n  echo \"Start at Boot: $START_AT_BOOT\"\n\n  echo \"$VM_ID_CREATED\"\n}\n\n\n# Method to import the disk image into the VM\n#\n# This method imports the downloaded and extracted disk image into the specified VM using the Proxmox API.\n# It uses the following global variables:\n# - VM_ID: The ID for the VM\n# - HAOS_STORAGE: The storage for Home Assistant OS\n# - TEMP_DIR: The temporary directory where the image is located\nimport_disk_image() {\n  local EXTRACTED_IMAGE=\"$TEMP_DIR/haos.qcow2\"\n\n  # Check if the extracted image exists\n  if [ ! -f \"$EXTRACTED_IMAGE\" ]; then\n    echo \"Error: The extracted image $EXTRACTED_IMAGE does not exist.\"\n    exit 1\n  fi\n\n  # Import the disk image\n  echo \"Importing the disk image...\"\n  if ! qm importdisk $VM_ID $EXTRACTED_IMAGE $HAOS_STORAGE; then\n    echo \"Error: Failed to import the disk image into VM ID $VM_ID.\"\n    exit 1\n  fi\n\n  echo \"Disk image imported successfully into VM ID $VM_ID.\"\n}\n\n# Method to configure the imported disk and set the boot order\n#\n# This method configures the imported disk for the VM and sets the boot order to boot only from the imported disk.\n# It uses the following global variables:\n# - VM_ID: The ID for the VM\n# - HAOS_STORAGE: The storage for Home Assistant OS\npost_configure_vm() {\n  echo \"Configuring the imported disk and setting boot order...\"\n\n  # Note- this references disk-1, and not disk-0. \n  # Because disk-0 is the UEFI disk.\n  pvesh set /nodes/$(hostname)/qemu/$VM_ID/config \\\n    -virtio0 ${HAOS_STORAGE}:vm-$VM_ID-disk-1,discard=on \\\n    -boot order=virtio0\n\n  echo \"Post-configuration completed for VM ID: $VM_ID\"\n}\n\n# Method to start the VM using the Proxmox API\n#\n# This method starts the specified VM using the Proxmox API.\n# It uses the following global variables:\n# - VM_ID: The ID for the VM\nstart_vm() {\n  echo \"Starting the VM...\"\n\n  if ! pvesh create /nodes/$(hostname)/qemu/$VM_ID/status/start; then\n    echo \"Error: Failed to start the VM ID $VM_ID.\"\n    exit 1\n  fi\n\n  echo \"VM ID $VM_ID started successfully.\"\n}\n\n# Method to wait for the VM to boot and pull an IP address\n#\n# This method waits for the specified VM to boot and pull an IP address.\n# It uses the following global variables:\n# - VM_ID: The ID for the VM\nwait_for_vm_ip() {\n  local TIMEOUT=60  # Timeout in seconds for obtaining IP address\n  local ELAPSED=0   # Time elapsed\n  local INTERVAL=5  # Interval between checks\n  local STARTUP_TIMEOUT=120  # Maximum time to wait for VM to start\n  local IP_ADDR\n\n  echo \"Waiting for the VM to start. Press CTRL+C to skip.\"\n\n  # Wait for the VM to start running\n  while [ $ELAPSED -lt $STARTUP_TIMEOUT ]; do\n    VM_STATUS=$(qm status $VM_ID | awk '{print $2}')\n    if [ \"$VM_STATUS\" = \"running\" ]; then\n      echo \"VM ID $VM_ID is running. Waiting for it to pull an IP address...\"\n      break\n    fi\n    sleep $INTERVAL\n    ELAPSED=$((ELAPSED + INTERVAL))\n  done\n\n  if [ \"$VM_STATUS\" != \"running\" ]; then\n    echo \"Error: The VM ID $VM_ID did not start within $STARTUP_TIMEOUT seconds.\"\n    exit 1\n  fi\n\n  ELAPSED=0  # Reset elapsed time for IP waiting\n\n  # Wait for the VM to pull an IP address\n  while [ $ELAPSED -lt $TIMEOUT ]; do\n    # Check if the VM is running\n    VM_STATUS=$(qm status $VM_ID | awk '{print $2}')\n    if [ \"$VM_STATUS\" != \"running\" ]; then\n      echo \"Error: The VM ID $VM_ID stopped unexpectedly.\"\n      exit 1\n    fi\n\n    # Retrieve network interfaces and filter for the desired IP address\n    IP_ADDR=$(pvesh get /nodes/$(hostname)/qemu/$VM_ID/agent/network-get-interfaces | \\\n              grep -oP '\"ip-address\":\"\\K[0-9.]+' | \\\n              grep -vE '^127\\.|^172\\.|^10\\.0\\.' | \\\n              head -n 1)\n\n    if [ ! -z \"$IP_ADDR\" ]; then\n      echo \"Home Assistant is running at: http://$IP_ADDR:8123/\"\n      return 0\n    fi\n\n    sleep $INTERVAL\n    ELAPSED=$((ELAPSED + INTERVAL))\n  done\n\n  echo \"Error: Failed to obtain an IP address for VM ID $VM_ID within $TIMEOUT seconds.\"\n  exit 1\n}\n\n\n##################################################################################\n####### Start process\n##################################################################################\n\n# Download the VM image\ndownload_and_extract_image\n\n# Create the VM.\ncreate_vm\n\n# Import the disk image\nimport_disk_image\n\n# Final VM configuration.\npost_configure_vm\n\n# Start the VM if specified\nif [ \"$START_AFTER_CREATE\" = true ] ; then\n  start_vm\n  wait_for_vm_ip\nfi\n\necho \"Done! Your Home Assistant VM should now be up and running.\"\n</code></pre>","tags":["Homelab","Proxmox","Home Assistant"]},{"location":"blog/2024/proxmox---install-haos/#how-do-i-use-the-script","title":"How do I use the script?","text":"<pre><code># SSH to a proxmox host. Create a file in your editor of choice.\n# Make sure to update the variables near the top of the script.\nroot@kube02:~# nano install-home-assistant\n\n# Flag the script as executable.\nroot@kube02:~# chmod +x install-home-assistant\n\n# Run the script.\nroot@kube02:~# ./install-home-assistant\n</code></pre> <p>And.... it will download Home Assistant OS, create a VM, configure the VM, start the VM, and give you the resulting URL.</p>","tags":["Homelab","Proxmox","Home Assistant"]},{"location":"blog/2024/proxmox---install-haos/#script-output-result","title":"Script Output / Result","text":"<pre><code>root@kube02:~# ./install-home-assistant\nValidating storage, network bridge, and VM ID...\nSuccess: Storage 'ceph-block' exists.\nSuccess: Storage 'ceph-block' exists.\nSuccess: Network bridge 'vlan5' exists.\nSuccess: VM ID '144' does not already exist.\nDownloading the VM image from https://github.com/home-assistant/operating-system/releases/download/12.4/haos_ova-12.4.qcow2.xz...\n... # Excluded verbose output from wget.\n/tmp/tmp.DGM30zNzQb/haos.qcow2.xz                            100%[=============================================================================================================================================&gt;] 340.62M  39.0MB/s    in 9.7s\n\n2024-08-21 14:57:52 (35.1 MB/s) - \u2018/tmp/tmp.DGM30zNzQb/haos.qcow2.xz\u2019 saved [357168464/357168464]\n\nExpanding the VM image...\nVM image downloaded and extracted successfully to /tmp/tmp.DGM30zNzQb/haos.qcow2.\nCreating the VM...\nVM HomeAssistantVM (ID: 144) has been created with the following configuration:\nMemory: 4096 MB\nCPU Cores: 4\nNetwork Bridge: vlan5\nEFI Storage: ceph-block\nStart at Boot: true\ntransferred 0.0 B of 128.0 KiB (0.00%)\ntransferred 128.0 KiB of 128.0 KiB (100.00%)\ntransferred 128.0 KiB of 128.0 KiB (100.00%)\nefidisk0: successfully created disk 'ceph-block:vm-144-disk-0,pre-enrolled-keys=0,size=1M'\nUPID:kube02:000C5B04:016CF229:66C646F9:qmcreate:144:root@pam:\nImporting the disk image...\nimporting disk '/tmp/tmp.DGM30zNzQb/haos.qcow2' to VM 144 ...\ntransferred 0.0 B of 32.0 GiB (0.00%)\n... # Remove output from QM Transfer\ntransferred 31.7 GiB of 32.0 GiB (99.03%)\ntransferred 32.0 GiB of 32.0 GiB (100.00%)\ntransferred 32.0 GiB of 32.0 GiB (100.00%)\nSuccessfully imported disk as 'unused0:ceph-block:vm-144-disk-1'\nDisk image imported successfully into VM ID 144.\nConfiguring the imported disk and setting boot order...\nupdate VM 144: -boot order=virtio0 -virtio0 ceph-block:vm-144-disk-1,discard=on\nPost-configuration completed for VM ID: 144\nStarting the VM...\nUPID:kube02:000C5D17:016CF676:66C64704:qmstart:144:root@pam:\nVM ID 144 started successfully.\nWaiting for the VM to start. Press CTRL+C to skip.\nVM ID 144 is running. Waiting for it to pull an IP address...\nQEMU guest agent is not running\nQEMU guest agent is not running\nQEMU guest agent is not running\nHome Assistant is running at: http://10.100.5.159:8123/\nDone! Your Home Assistant VM should now be up and running.\nRemoving temp directory.\nroot@kube02:~#\n</code></pre>","tags":["Homelab","Proxmox","Home Assistant"]},{"location":"blog/2024/proxmox---install-haos/#error-handling","title":"Error Handling","text":"<p>This script does have basic error handling. Very basic.</p> <p>For example- If you do not pick a valid storage.</p> <pre><code>root@kube02:~# ./install-home-assistant\nValidating storage, network bridge, and VM ID...\nError: Storage 'local-lvm' does not exist.\n</code></pre> <p>And, it validates the network bridge.</p> <pre><code>root@kube02:~# ./install-home-assistant\nValidating storage, network bridge, and VM ID...\nError: Network bridge 'vmbr03' does not exist.\n</code></pre> <p>Note, it only validates network, and storage for the host you are logged into.</p> <p>Finally, it will validate the VM_ID does not already exist (By default, it selects a new, unused VM ID from the proxmox api)</p> <pre><code>Success: VM ID '143' does not already exist.\n</code></pre> <p>It does not check cluster members, shared/clustered storage/etc. Only- if the network/storage exists on the CURRENT host.</p> <p>I don't recommend trying to find errors. You will find them.</p>","tags":["Homelab","Proxmox","Home Assistant"]},{"location":"blog/2025/hacking-kvm-with-ip-control/","title":"Hacking a cheap KVM with IP Control","text":"<p>I picked up a PiKVM a few months back. I finally got to use it earlier this week when Comparing Link Speed to Power Consumption.</p> <p>But- it only works for a single PC. I need a solution for all four SFFs/Micros in my rack.</p> <p>So... I picked up a cheap Display Port KVM for 70$, and hacked it to be controllable via Home Assistant.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#the-goal","title":"The Goal","text":"<p>The goal is simple. I want to be able to control a KVM switch from Home Assistant.</p> <p>For- the immediate need, I will control a KVM switch behind PiKVM, allowing me to remotely access and control all 4 PCs in my rack, which do not have iDrac.</p> <p>For the future need, I'd love to automate the KVM in my office. But- before touching my more expensive KVM switch, I wanted to test a proof of concept with a cheap one.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#hardware-used","title":"Hardware Used","text":"<p>4 Port DisplayPort KVM Switch<sup>1</sup></p> <p>There is nothing fancy here. Costed me 70$</p> <p>It is a simple DP 1.2 KVM. I don't even think it supports EDID emulation.</p> <p>Espressif D1 Mini<sup>1</sup></p> <p>Cheap, effective micro controller. I just ordered another 20 ESP32-C3s for future projects. Can pick these up from 99 cents to a few bucks each.</p> <p>Even an older ESP8266 will be fine for this project. There are no special requirements.</p> <p>I had an old crusty one laying around, which I ended up using.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#tools-used","title":"Tools Used","text":"<p>A soldering iron. Solder. Flux.</p> <p>A screwdriver.</p> <p>Basic hand tools.</p> <p>A multimeter.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#execution","title":"Execution","text":"<p>First step, was to unpack the switch.</p> <p>Right away- you can notice I have four HDMI cables........ in a box for a DisplayPort KVM.</p> <p></p> <p>Next, we need to remove the cover. Two phillips #2 head screws on each side.</p> <p></p> <p>Afterwards, we can see the interior.</p> <p></p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#a-slight-bit-of-reverse-engineering","title":"A slight bit of reverse engineering","text":"<p>The layout is extremely simple. </p> <p>We can see Four switching chips. And- follow the traces.</p> <p>Info</p> <p>As a random note I learned recently- For DisplayPort, its pretty rare to see switching ICs with more then 2 channels.</p> <p>Turns out, the differential pairs used, are extremely sensitive to issues, and interference. </p> <p>I went down a rabbit hole researching the effort to build a homemade modular KVM switch, and this would be a huge challenge.</p> <p>I FIGURED, this could be handled by a simple FPGA, used to switch between the inputs, and outputs. However, this requires specialized hardware on the FPGA which.... $$$$$$$</p> <p></p> <p>So, each pair of DP ports, goes into a switch. Then the pair of switches, goes into another switch.</p> <p>This circled area, is where my interest is. This is the area where the buttons, and control hardware are.</p> <p></p> <p>So- just need to tie into the correct traces in order to activate the desired outputs.</p> <p>I started with this Cheap Oscilloscope<sup>1</sup> that I picked up for 30$. I wouldn't recommend one.</p> <p>I used my automotive multimeter instead....  Don't buy one of these. Its not even a good toy.</p> <p></p> <p>I also had this suspicion the included remote, did not actually use USB, and was instead just pulling lines high/low.</p> <p>I decided to open it up, and have a look.</p> <p>A knife was the easy tool here. Slide in in, and wedge the case apart.</p> <p></p> <p></p> <p>Low and behold- No ICs for USB signaling.</p> <p>When you press a button, it pulls that line low.</p> <p>This means... all four traces must be running into the IC, allowing setting individual inputs.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#thought-process","title":"Thought process","text":"<p>You don't need a degree in electrical engineering to fully reverse engineer this.</p> <p>The only useful tool I used for this, was a simple automotive multimeter I have had for years. Not even a fancy one. A 30$ one from Walmart.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#triggering-specific-pc","title":"Triggering Specific PC","text":"<p>Knowing there is no actual USB connection- follow the pines from the \"USB\" port, to the IC. Use your tester to double-check the connection is made when you press buttons 1-4 on the remote. </p> <p>Do note- some of these traces go under the IC, and hit pins on the top side of it.</p> <p></p> <p>After you identify where all four pins are- boom. Your done here.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#detect-active-pc","title":"Detect Active PC","text":"<p>Now- for a stretch goal, I wanted to detect which PC was currently active. </p> <p>HOWEVER, I ran into an issue.</p> <p>D1 Mini Pinout &amp; Limitations</p> <p>The D1 Mini I was using, only has a few usable pins. D1-Mini Pinout Reference</p> <p>D1, D2, D5, D6, D7. This gives 5 useful pins.</p> <p>D8 will cause boot to fail if pulled high.</p> <p>D3, D4 will cause boot to fail if pulled low.</p> <p>Do note- I did use pin D3 later in this post- which did successful fail to work.  </p> <p>So- be aware of the special pin limitations!</p> <p>Since, we only have 5 usable GPIOs, and four of them were just taken up to trigger individual outputs- This means we can't just attach a GPIO to each of the four LED pins.</p> <p>Instead- I identified two pins which were responsible for setting the switch chips. </p> <p>Those two pins, can successfully identify PC 1 - 4.  (Boolean logic)</p> <ul> <li>0, 0 = PC 1</li> <li>0, 1 = PC 2</li> <li>1, 0 = PC 3</li> <li>1, 1 = PC 4</li> </ul> <p>I decided to use those.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#power","title":"Power","text":"<p>For Power- I soldered a ground wire to one of thee USB port frames. I previous verified they all share a common ground.</p> <p>For +5v, I soldered to the +5v pin on USB5.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#soldering-connections","title":"Soldering Connections","text":"<p>I planned on using ESPHome from the start. now, I just need to start adding connections.</p> <p>For wire, I used a piece of copper CAT6 I had laying around. </p> <p>Info</p> <p>I will note.... there is already proper 22AWG cable in the mail.</p> <p>But- solid-copper CAT6 did the job just fine. Make sure to use a bit of flux when initially tinning the wire.</p> <p></p> <p>After a while, I had a lovely rat's nest of wire.</p> <p></p> <p>I felt this was a good time to test everything.</p> <p>Since everything tested as expected... lets move forward.</p> <p>Warning</p> <p>Do- be careful when working with the pads under the IC.</p> <p>They can be pulled easily.... (**cough, I pulled the pad for the LED for PC 2)</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#adding-the-esp","title":"Adding the ESP","text":"<p>Next, I decided to go ahead and add the ESP.</p> <p>NORMALLY, I would use a ESP32-C3, however, I am currently out of stock apparently. This old crusty d1 mini was all I had laying around.</p> <p>There was a bit open spot right in the middle, this looked ideal.</p> <p>To attach it, a bit of hot-glue worked just fine.</p> <p></p> <p>From this point, It was just a matter of trimming, and soldering the rest of the connections.</p> <p></p> <p>For ground, I soldered a wire to the USB port, which is grounded.</p> <p>For 5v, I soldered onto the 5V pin of USB Port 1. (5v is shared across all of the ports).</p> <p>Info</p> <p>Yes- I know- my soldering looks like \ud83d\udca9</p> <p>Minus- this website- nobody will ever physically see this again.</p> <p>And- despite the looks, it will function the same now, as it will in 5 years from now.</p> <p>At this point, all of the physical modifications are done.</p> <p>Once you have initially flashed the ESP, you can reassemble the case.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#esphome-firmware","title":"ESPHome Firmware","text":"<p>So, next up, I needed to come up with some ESPHome Firmware.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#details","title":"Details","text":"","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#outputs","title":"Outputs","text":"<p>We have four outputs, one for each PC we want to control.</p> <p>Notes:</p> <ol> <li><code>inverted=true</code>: All of the buttons, switches, etc work by pulling the line low. We need to do this on the ESP Side too.</li> <li>Interlock: <ul> <li>While testing, I noticed if two switches were toggled at the same time, it would soft-lock the KVM until you power cycled it.</li> <li>I added an interlock which only allows a single output to become active at the same time.</li> </ul> </li> </ol> <p>We need to do the same here.</p> <pre><code>output:\n  - platform: gpio\n    pin: D1\n    id: pc1_switch\n    inverted: true\n    interlock: &amp;pc_select [relay1, relay2]\n\n  - platform: gpio\n    pin: D2\n    id: pc2_switch\n    inverted: true\n    interlock: *pc_select\n\n  - platform: gpio\n    pin: D5\n    id: pc3_switch\n    inverted: true\n    interlock: *pc_select\n\n  - platform: gpio\n    pin: D6\n    id: pc4_switch\n    inverted: true\n    interlock: *pc_select\n</code></pre>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#inputs","title":"Inputs","text":"<p>And- we have two inputs. The two inputs are between the target IC, and the DP switches. Only two inputs are needed to tell us the exact PC activated.</p> <pre><code>  binary_sensor:\n    - platform: gpio\n      pin:\n        number: D3\n      name: \"Bit 0\"\n      id: bit_0\n      internal: true\n\n    - platform: gpio\n      pin:\n        number: D7\n      name: \"Bit 1\"\n      id: bit_1\n      internal: true\n</code></pre>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#current-pc-logic","title":"Current PC Logic","text":"<p>So, I did want the ability to see which PC was selected at a given time, hence, the two inputs above.</p> <p>HOWEVER- I did incorrectly solder ONE of the inputs to the incorrect pin on the IC. So, I decided to perform a work-around.</p> <p>I am storing the last selected state in a global variable. If- the currently selected input, is not allowed by the single functioning output, we will return \"Unknown\" instead.</p> <p>Perfect? No. But- now you know so you can do better then I did.</p> <pre><code>  globals:\n    - id: last_selected_pc\n      type: int\n      restore_value: no\n      initial_value: \"1\"\n\n  text_sensor:\n    - platform: template\n      name: \"Active PC\"\n      id: active_pc\n      lambda: |-\n        // I incorrectly soldered one of the pins.\n        // Instead, of redoing it- just adding simple logic here.\n        // bit_1 works correctly, bit_0 does not. So- we store the last selected pin\n        // If, the last selected pin is in a state allowed by bit_1, we display it. Otherwise, return unknown.\n        // This, works just fine even when cycling using remote, or button on KVM.\n        // Fake it, till you make it.\n        if (!id(bit_1).state) {\n          // Bit 1 OFF - Valid options: PC 1 or PC 3\n          if (id(last_selected_pc) == 1) return std::string(\"${pc_1}\");\n          if (id(last_selected_pc) == 3) return std::string(\"${pc_3}\");\n        } else {\n          // Bit 1 ON - Valid options: PC 2 or PC 4\n          if (id(last_selected_pc) == 2) return std::string(\"${pc_2}\");\n          if (id(last_selected_pc) == 4) return std::string(\"${pc_4}\");\n        }\n        // Invalid state detected\n        return std::string(\"Unknown\");\n</code></pre>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#click-button-logic","title":"Click Button Logic","text":"<p>When, you click the button inside of home assistant.... two things occur:</p> <ol> <li>It sets the last select PC into the global variable.</li> <li>It pulls the GPIO low for a half second, and then releases.</li> </ol> <pre><code>  button:\n    - platform: template\n      name: \"Switch to ${pc_1}\"\n      id: pc1_button\n      on_press:\n        then:\n          - lambda: id(last_selected_pc) = 1;\n          - output.turn_on: pc1_switch\n          - delay: 0.5s\n          - output.turn_off: pc1_switch\n          - delay: 0.5s\n\n    - platform: template\n      name: \"Switch to ${pc_2}\"\n      id: pc2_button\n      on_press:\n        then:\n          - lambda: id(last_selected_pc) = 2;\n          - output.turn_on: pc2_switch\n          - delay: 0.5s\n          - output.turn_off: pc2_switch\n          - delay: 0.5s\n\n    - platform: template\n      name: \"Switch to ${pc_3}\"\n      id: pc3_button\n      on_press:\n        then:\n          - lambda: id(last_selected_pc) = 3;\n          - output.turn_on: pc3_switch\n          - delay: 0.5s\n          - output.turn_off: pc3_switch\n          - delay: 0.5s\n\n    - platform: template\n      name: \"Switch to ${pc_4}\"\n      id: pc4_button\n      on_press:\n        then:\n          - lambda: id(last_selected_pc) = 4;\n          - output.turn_on: pc4_switch\n          - delay: 0.5s\n          - output.turn_off: pc4_switch\n          - delay: 0.5s\n</code></pre>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#finished-firmware","title":"Finished Firmware","text":"ESPHome Config (Click to expand) <pre><code>substitutions:\n  devicename: \"rack_kvm\"\n  friendly_name: \"Rack KVM\"\n  pc_1: Kube01\n  pc_2: Kube05\n  pc_3: Kube06\n  pc_4: Kube04\n\npackages:\n  common: !include common/package-common.yaml\n\nesp8266:\n  board: d1_mini\n  #variant: esp32\n\noutput:\n  - platform: gpio\n    pin: D1\n    id: pc1_switch\n    inverted: true\n\n  - platform: gpio\n    pin: D2\n    id: pc2_switch\n    inverted: true\n\n  - platform: gpio\n    pin: D5\n    id: pc3_switch\n    inverted: true\n\n  - platform: gpio\n    pin: D6\n    id: pc4_switch\n    inverted: true\n\nglobals:\n  - id: last_selected_pc\n    type: int\n    restore_value: no\n    initial_value: \"1\"\n\nbutton:\n  - platform: template\n    name: \"Switch to ${pc_1}\"\n    id: pc1_button\n    on_press:\n      then:\n        - lambda: id(last_selected_pc) = 1;\n        - output.turn_on: pc1_switch\n        - delay: 0.5s\n        - output.turn_off: pc1_switch\n        - delay: 0.5s\n\n  - platform: template\n    name: \"Switch to ${pc_2}\"\n    id: pc2_button\n    on_press:\n      then:\n        - lambda: id(last_selected_pc) = 2;\n        - output.turn_on: pc2_switch\n        - delay: 0.5s\n        - output.turn_off: pc2_switch\n        - delay: 0.5s\n\n  - platform: template\n    name: \"Switch to ${pc_3}\"\n    id: pc3_button\n    on_press:\n      then:\n        - lambda: id(last_selected_pc) = 3;\n        - output.turn_on: pc3_switch\n        - delay: 0.5s\n        - output.turn_off: pc3_switch\n        - delay: 0.5s\n\n  - platform: template\n    name: \"Switch to ${pc_4}\"\n    id: pc4_button\n    on_press:\n      then:\n        - lambda: id(last_selected_pc) = 4;\n        - output.turn_on: pc4_switch\n        - delay: 0.5s\n        - output.turn_off: pc4_switch\n        - delay: 0.5s\n\n\nbinary_sensor:\n  - platform: gpio\n    pin:\n      number: D3\n    name: \"Bit 0\"\n    id: bit_0\n    internal: true\n\n  - platform: gpio\n    pin:\n      number: D7\n    name: \"Bit 1\"\n    id: bit_1\n    internal: true\n\n\ntext_sensor:\n  - platform: template\n    name: \"Active PC\"\n    id: active_pc\n    lambda: |-\n      // I incorrectly soldered one of the pins.\n      // Instead, of redoing it- just adding simple logic here.\n      // bit_1 works correctly, bit_0 does not. So- we store the last selected pin\n      // If, the last selected pin is in a state allowed by bit_1, we display it. Otherwise, return unknown.\n      // This, works just fine even when cycling using remote, or button on KVM.\n      // Fake it, till you make it.\n      if (!id(bit_1).state) {\n        // Bit 1 OFF - Valid options: PC 1 or PC 3\n        if (id(last_selected_pc) == 1) return std::string(\"${pc_1}\");\n        if (id(last_selected_pc) == 3) return std::string(\"${pc_3}\");\n      } else {\n        // Bit 1 ON - Valid options: PC 2 or PC 4\n        if (id(last_selected_pc) == 2) return std::string(\"${pc_2}\");\n        if (id(last_selected_pc) == 4) return std::string(\"${pc_4}\");\n      }\n      // Invalid state detected\n      return std::string(\"Unknown\");\n</code></pre>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#final-product","title":"Final Product","text":"<p>The final product- does exactly what it was expected to do.</p> <p>Nothing fancy or over the top here.</p> <p></p> <p>After sitting it in the rack and connecting all four pairs of DisplayPort / USB cables.... I had a mess of wires to cleanup and organize later.</p> <p>My rack, Stays well organized, typically</p> <p></p> <p>Here is a video of it in action.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#qa-issues-etc","title":"Q&amp;A, Issues, etc.","text":"","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#why-does-it-take-so-long-to-switch-between-pcs","title":"Why does it take so long to switch between PCs?","text":"<p>The reason there is such a long delay when switching devices is due to the lack of EDID emulation.</p> <p>The delay when switching between PCs on a cheap KVM switch happens because it physically disconnects and reconnects the display each time you switch. </p> <p>Without EDID emulation, each PC thinks the monitor has been unplugged and replugged, causing it to reinitialize the display settings.</p> <p>With EDID emulation, the KVM switch presents a constant virtual display to each connected PC, making the system believe the monitor is always connected. This helps to prevent resolution changes, window repositioning, and eliminates the delay caused by display detection during switching.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#your-soldering-is-horrible","title":"Your Soldering is horrible","text":"","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#why-didnt-you-use-a-hdmi-kvm-they-are-cheaper-easier-to-work-with","title":"Why didn't you use a HDMI KVM, they are cheaper &amp; easier to work with.","text":"<p>Because the PCs I want to put behind this KVM, don't have HDMI. Dell SFFs/Micros are mostly DisplayPort.</p> <p>Since, the JetKVM is HDMI-based, there is a DisplayPort to HDMI converter between the KVM, and the JetKVM.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#you-can-get-kvm-switches-much-cheaper-blah-blah","title":"You can get KVM switches much cheaper blah blah...","text":"<p>This is one of the cheapest DP switches available on Amazon. </p> <p>And- to my knowledge, there is \"0\" home-assistant integrated KVM switches available for purchase.</p> <p>Especially not for the price I built this one. 70$ for DP switch + 1.50$ for D1 mini.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#the-esp-is-not-going-to-get-reception-without-an-external-antenna","title":"The ESP is not going to get reception without an external antenna.","text":"<p>I tested and flashed it in my office, which is one of the furthest areas from my Access points.</p> <p>As well, it will live the rest of its life inside of my server rack, which has an access point 5 ft away.</p> <p>Besides, its fine.</p> <ul> <li>WiFi Signal: -53 dBm</li> </ul>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#next-steps","title":"Next Steps?","text":"<p>The next stage of this process will be to automate the KVM(s) in my office.</p> <p>I want to be able to fully configure my desk, using home assistant scenes and automatons.</p> <p>Notice- I said KVM(s) &lt;-- \"(s) being the key word. </p> <p>If- you want to know more- expand the spoiler.</p> More Details <p>Three monitors. Three PCs. Turns out, 4x4 KVMs are expensive. </p> <p>2x2 KVMs are cheap. I picked up this CKL 2x2 DisplayPort KVM for 30$ today<sup>1</sup></p> <p>Its only DisplayPort 1.2- but, that won't be a problem here.</p> <p>Two massive 32\" screens, for work and play, and a single 24\" screen which is great for watching email/chats/videos/etc.</p> <p>The left 32\" screen, also is used by my wife's gaming PC whenever we are gaming.</p> <p>The top 24\" screen, and right 32\" screen, are work/personal only.</p> <p>Since... a picture says 1,000 words, here is a diagram of what I want to accomplish:</p> <pre><code>graph TB\nsubgraph \"Monitors\"\n    1[\"32in 1440p@144hz LG\"]\n    2[\"32in 4k@60hz Philips\"]\n    3[\"24in 1080p@60hz Dell\"]\nend\n\nsubgraph \"KVMs\"\n    K1[\"2x2 DP KVM-1\"]\n    K2[\"2x2 DP KVM-2\"]\n    K3[\"2x2 HDMI KVM-3\"]\nend\n\nsubgraph \"Computers\"\n    C[\"Wife's Gaming PC\"]\n    A[\"Gaming/Personal PC\"]\n    B[\"Work PC\"]\n\nend\n\nA &amp; B ==&gt; |2x DP| K1\nA &amp; B --&gt; |1x HDMI| K3\nK1 --&gt; |1x DP| 2 &amp; K2\nC --&gt; | 1x DP| K2\nK2 --&gt; | 1x DP| 1\nK3 --&gt; | 1x HDMI| 3</code></pre> <p>This, enables the following use-cases:</p> <ol> <li>\"Working\": All three monitors connected to work PC.</li> <li>\"Gaming/Personal\": \"All three monitors connected to Gaming/Personal PC.</li> <li>\"Gaming with Wife\": Left monitor connected to Wife's PC. Right two monitors connected to Gaming/Personal PC.</li> <li>\"Work Hybrid\": Both 32\" screens on work PC. 24\" Screen watching personal PC. (Watching NVR, Events, etc....)</li> <li>\"Personal Hybrid\": Both 32\" screens on personal PC. 24\" screen watching work PC. (\"Watching emails, long running processes, etc.)</li> </ol> <p>This setup allows the 24\" screen to be independently switched between Work/Game.</p> <p>It also allows the left 32\" screen to be independently switched between the Wife's PC, and Game/Work.</p> <p>Now- the above is easily handled with a matrix, or multi-view KVM switch, however a pair of cheap 30$ KVMs made a lot more financial sense to me, then picking up a single 400$ multi-view capable KVM.</p> <p>Finally- I will be doing that automation without any disassembly or modification to the KVMs. It will be handled through the remote port, which is a standard 3.5mm audio jack. Will still use ESP Home though.</p>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2025/hacking-kvm-with-ip-control/#footnotes","title":"Footnotes","text":"<ol> <li> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations.</p> <p>\u21a9\u21a9\u21a9\u21a9</p> </li> </ol>","tags":["Homelab","Home Assistant","ESPHome"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/","title":"Home Assistant - Energy Monitoring Options","text":"<p>A quick post going over the best options for taking advantage of home assistant's energy monitoring features. </p> <p>To note- you don't have to use home assistant with these products. But, these products were specifically chosen due to some level of integration with home assistant.</p> <p>Warning</p> <p>Mains voltage is dangerous. Incorrect handling of mains voltage can cause injury or death. You should ideally have a licensed electrician install any of the devices listed in this article.</p> <p>I am not responsible for any death, injury, or loss of property incurred.</p>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#products","title":"Products","text":"<p>Products will be split into these categories.</p> <ol> <li>Products which provide per device/circuit entire-home monitoring, typically from sensors located in your mains panel.</li> <li>Products which only monitor energy entering or leaving the home, typically through CT clamps on the mains.</li> <li>Smart Plugs and/or Devices with build in reporting</li> </ol>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#per-circuit-monitoring","title":"Per Circuit Monitoring","text":"<p>These products will typically have support for monitoring multiple circuits, and generally also include provisions for monitoring the mains.</p> <p>All of these products will be mounted in, or near your mains panel.</p>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#iotawatt","title":"Iotawatt","text":"<p>This is a wifi-based device, which has support for up to 14 CT Clamps.</p> <p>My personal experiences</p> <p>I picked up one of these units after cooking my CircuitSetup. It has been running since fall of 2021, with zero issues at all.</p> <p>The device itself, can operate fully independant of your internet, and home-automation software. It has a simple web-gui to display both real-time, and historial data.</p> <p>The interface itself, is very easy to configure as well.</p> <p>If- you want per-circuit monitoring, this product would be my recommendation. </p> <p>Home Assistant integration is provided via Native Iotawatt Integration</p> <p>Links: </p> <ul> <li>Iotawatt Website</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#circuitsetup","title":"CircuitSetup","text":"<p>This is a circuit board which you can add your own ESP32 to, and monitor up to 42 seperate channels, in real-time, at 16-bit resolution.</p> <p>Overall, the price isn't unreasonable. </p> <p>Warning</p> <p>This option may not be the most DIY friendly option, as you are provided with a circuit board for which you need to flash, maintain, and mount.</p> <p>If you are not comfortable flashing esphome, I would recommend other options.</p> <p>My personal experiences</p> <p>This was the orignal solution I personally acquired for doing per-circuit monitoring in my house. After getting everything setup initially, It was working fine. </p> <p>However- I decided to acquire another add-on board. During the process of installing it, I slotted the ESP incorrectly (not hard to do...), which fried all of the add-on boards rendering this solution non-usable.</p> <p>After opening a support ticket on Sept 13th, 2021, this issue was never resolved. Shortly after, I picked up an Iotawatt</p> <p>Links: </p> <ul> <li>CircuitSetup.us</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#greeneye-residential","title":"GreenEye Residential","text":"<p>This is one of the few options on this list supporting ethernet AND wifi. It also supports complete local control as well.</p> <p>Based on what I have seen, there is not a cloud component to this option which is always a plus\u2026 at least for me.</p> <p>If you need to monitor a large number of circuits, and you don\u2019t want to put together your own firmware this product is likely your best option\u2026 as the cost is quite reasonable when you look at other solutions to monitoring 20+ circuits.</p> <p>As another positive note this unit can also monitor pulse sensors from your energy meter.</p> <p>In my opinion, this product is a very attractive choice if you wish to monitor a large number of circuits. It does not require ANY diy, other then installation. It is essentially a plug and play module, with a native integration. It has its own server as well for configuration and display of data.</p> <p>Links: </p> <ul> <li>Vendor Page</li> <li>Vendor Store</li> <li>Native Home Assistant Integration</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#sense","title":"Sense","text":"<p>Warning, Cloud-Reliant</p> <p>WARNING- This product is dependant on its vendor's cloud.</p> <p>Home assistant functionality is provided via cloud-polling</p> <p>This device is advertised as being able to monitor your entire home, and to even distinguish different devices.</p> <p>It even has an OFFICIAL integration built-in.</p> <p>The downsides- This is dependant on cloud-polling. It is also quite pricey compared to the other options. I have heard a few times- its detection of specific devices may or may not work well.</p> <p>In my OPINION- it only senses at the mains level, and does not have sensors on a per-circuit basis. So- if you have a house with lots of electrical noise. Multiple AC units. Multiple Fridges. A mini server room like me. A shop containing welders and lathes- I don\u2019t imagine its detection is going to work that well. But- if you have a 2 bedroom apartment, with a very standard setup- it will prob work very well. But- at the 300$ price point- that is a bit pricey compared to some other options. I have seem mixed feedback. It works extremely well for some, but, not so well for others. </p> <p>Based on what I have seen from others, and my own conclusions, I would recommend choosing another product.</p> <p>Links: </p> <ul> <li>Purchase on Amazon</li> <li>Vendor Link</li> <li>Native Home Assistant Integration</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#emporia-vue","title":"Emporia Vue","text":"<p>Per-circuit monitoring, with support up to 16x 50amp circuits.</p> <p>This is THE most cost-effective option for per-circuit energy monitoring. For around 120$ shipped, including 8 50amp CT clamps for individual circuits, and 2x mains clamps- you cannot beat the price. But- this price, comes with a catch.</p> <p>Warning, Potentially Cloud-Reliant</p> <p>Out of the box, as shipped, this product is 100% dependant on Emporia's cloud. More below.</p> <p>How to flash with ESP Home for Local Control</p> <p>If you do not wish to be dependant on the vendor's cloud, which without notice, can stop working- A reddit user has created a guide on how to flash this device to leverage ESP Home, for full local control.</p> <p>If you are not a DIY friendly user, I would recommend another product. However, if you are not scared of soldering, and flashing firmware- </p> <p>View the guide HERE</p> <p>May 2023 - Updated Guide HERE</p> <p>Overall- I am against any product which relies on a vendor's servers to function. I am a very strong proponent of full, local control. As such, unless you plan on flashing this device to ESP Home using the links provided- I would recommend another product. However- if you do flash to Esp home, the price / functionality is unbeatable by anything else on this list.</p> <p>Links:</p> <ul> <li>Buy on Amazon</li> <li>Vendor Website</li> <li>3rd Party Home Assistant Integration</li> <li>Flashing to ESPHome</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#athom","title":"Athom","text":"<p>(Added Aug 2024)</p> <p>Athom recently released both 2, and 6 channel din-mountable energy monitoring modules. These come shipped WITH Esphome pre-installed. The prices are extremely reasonable too.</p> <ul> <li>Athom - 2ch</li> <li>Athom - 6ch</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#mains-monitoring","title":"Mains Monitoring","text":"<p>These products are intended to only monitor the current going through the mains. This is generally used to determine how much energy your residence is consuming.</p>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#shelly-em","title":"Shelly EM","text":"<p>The Shelly EM provides current monitoring using CT Clamps. It also enables the ability to switch high current loads, using contactors. </p> <p>This device uses Wifi for communication, and can monitor up to TWO 120amp circuits.</p> <p> Home Assistant Integration Options </p> <ol> <li>Built-in MQTT.</li> <li>Home Assistant's Shelly Integration</li> <li>Flashing ESPHome to this device.</li> </ol> <p>Links: </p> <ul> <li>Purchase on Amazon</li> <li>Shelly EM</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#aeotec-home-energy-monitor","title":"Aeotec Home Energy Monitor","text":"<p>This is a z-wave based solution which monitors the current passing through your mains.</p> <p>Integration with home assistant is provided through the native z-wave integration</p> <p>Links: </p> <ul> <li>Purchase on Amazon</li> <li>Aeotec Product Description</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#iammeter","title":"IAMMeter","text":"<p>I am not very familiar with this product, however it comes at a ~90$USD Price-point for monitoring a single phase. Or- 160$ USD for monitoring a three-phase house, or split-phase setup (This is what is typical in US households).</p> <p>A bit pricy, IMO based on the alternatives here, however, it does offer din-rail mounting, which can make for a very clean setup if you have a seperate nearby box with din-rails.</p> <p>On a strong-positive note, it does have a native integration with home assistant, which makes setup in HA a piece of cake. Vendor HA Documentation</p> <p>Links: </p> <ul> <li>Product Link</li> <li>Native Home Assistant Integration</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#individual-device-monitoring","title":"Individual Device Monitoring","text":"<p>This section is dedicated to plugs and strips with energy monitoring, and devices which report their own energy consumption.</p>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#kasa-hs300","title":"Kasa HS300","text":"<p>The Tp-link Kasa is a 6-port power strip with individually controlled and metered outlets.</p> <p>I have been using these units for some time now, and I can personally say- they work very nicely.</p> <p>I do recommend isolating these devices from the internet, and using home assistant to control them. They do work fully local when used this way.</p> <p>You can read my personal review / installation here: Using Kasa HS300 as Rack Mounted PDU</p> <p>Links:</p> <ul> <li>Purchase on Amazon</li> <li>Native Home Assistant Integration</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#sonoff-s31","title":"Sonoff S31","text":"<p>The Sonoff S31 is a low cost plug, which can report back energy utilization as well. This plug is UTL certified, and rated for up to 15 amps.</p> <p>As a bonus, you CAN flash these plugs with either esphome or tasmota.</p> <p>Warning</p> <p>Do not get the S40 plugs expecting them to be an upgraded version of the S31!</p> <p>The S40 plugs cannot be flashed to esphome or tasmota.</p> <p>Links:</p> <ul> <li>Purchase on Amazon</li> <li>Manufacturer Website</li> <li>Esphome Configuration</li> <li>Tasmota Configuration</li> <li>Here is a guide I found for flashing these</li> <li>Here is my post for these</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#zooz-zen15","title":"Zooz Zen15","text":"<p>This product, is advertised as a smart plug capable of handling large 110v appliances. </p> <p>If you have ever tried to control your air-compressor with a typical smart relay, you will understand why this is important.</p> <p>Due to this product's pricing, It is best suited for controlling large appliances such as Microwaves, Air conditioners, etc. I wouldn't advise using this for a lamp.</p> <p>Note, this product also leverages z-wave. As such, make sure you have a z-wave network! This also means, it works completely local, with no internet dependency at all.</p> <p>Links:</p> <ul> <li>Purchase on Amazon</li> <li>Manufacturer Website</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#shelly-1pm","title":"Shelly 1PM","text":"<p>The Shelly 1PM is a small form \"smart switch\" intended to be mounted either inside of devices, or small enough to be mounted in a typical 1 gang switch box.</p> <p>These devices can easily be flashed to either Esphome or Tasmota, using the exposed serial pins.</p> <p>I have personally, used these for years. Without a single complaint.</p> <p>Links:</p> <ul> <li>Purchase on Amazon</li> <li>Manufacturer Website</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#shelly-25","title":"Shelly 2.5","text":"<p>Need two inputs and outputs? The Shelly 2.5, like the Shelly 1PM, also has power monitoring. But, the 2.5 has two inputs, and two outputs.</p> <p>Also, like the Shelly 1PM, these units can be flashed to esphome or tasmota very easily.</p> <p>I have two of these still in use, with no issues to report.</p> <p>Links: </p> <ul> <li>Purchase on Amazon</li> </ul>","tags":["Energy Monitoring"]},{"location":"blog/2022/2023-home-assistant---energy-monitoring/#my-personal-recommendations","title":"My Personal Recommendations","text":"<p>For my personal recommendations- I present to you, a flow-chart.</p> <p>Overall, I cannot say enough positive things about my Iotawatt though. It.. just works.</p> <p>As a note- I do not have personal experience with Emporia, Aeotec, or Greeneye. I do have personal experience with Iotawatt, and Shelly.</p> <pre><code>graph TB\n    pcircuit{Do you need per-circuit monitoring?};\n    pcircuit --&gt; pcircuit_y([Per Circuit]) --&gt; mindflash;\n    pcircuit --&gt; pcircuit_n([Mains Only]) --&gt; mains;\n\n    mindflash{Do you mind DIY?};\n    mindflash --&gt; mindflash_y([DIY is fine]) --&gt; Emporia;\n    mindflash --&gt; mindflash_n([I prefer plug and play]) --&gt; Iotawatt;\n\n    mains{What communication do you prefer?};\n    mains --&gt; mains_zwave([Z-Wave]) --&gt; Aeotec;\n    mains --&gt; mains_wifi([Wifi]) --&gt; ShellyEM;\n    mains --&gt; mains_eth([Ethernet]) --&gt; Greeneye;\n\n    Emporia[Emporia Vue];\n    click Emporia \"#emporia-vue\";\n    Iotawatt[Iotawatt];\n    click Iotawatt \"#iotawatt\";\n    Aeotec[Aeotec];\n    click Aeotec \"#aeotec-home-energy-monitor\";\n    ShellyEM[ShellyEM];\n    click ShellyEM \"#shelly-em\";\n    Greeneye[Greeneye];\n    click Greeneye \"#greeneye-residential\";</code></pre>","tags":["Energy Monitoring"]},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/","title":"Reasons to avoid cloud-based home automation products","text":"<p>On this blog / my house, I try to use 100% local control products whenever possible. Many people don\u2019t understand the reasoning behind this\u2026. So, I am dedicating this page to reasons as to why you should ONLY buy products which are 100% local control only, with no cloud dependency, and no proprietary hub.</p> <p></p> <p>This is intended to be a \u201cliving\u201d post which will be updated as I add more items. If you have an item I missed, please comment below and I will add it in.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#major-issues","title":"Major Issues","text":"<p>This section will go over major issues reported, by year. Major issues are categorized as massive privacy breaches, discontinued / depreciated services, and extended outages.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2016","title":"2016","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#staples-connect-discontinued","title":"Staples Connect - Discontinued","text":"<ul> <li>https://www.retaildive.com/news/staples-replacing-connect-with-third-party-smart-home-system/423867/</li> <li>http://www.thedigitalmediazone.com/2016/06/04/staples-disconnect/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2019","title":"2019","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#googlenest-works-with-nest-discontinued","title":"Google/Nest - Works with nest discontinued","text":"<p>When google acquired nest, the \"works with nest\" program was discontinued.</p> <ul> <li>https://www.theverge.com/2019/5/16/18627719/google-works-with-nest-shutdown-clarification-statement-update</li> <li>https://nest.com/whats-happening/</li> <li>https://9to5google.com/2021/11/01/nest-app-transition-comment/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#best-buy-insignia-services-discontinued","title":"Best Buy Insignia Services discontinued","text":"<ul> <li>https://www.digitaltrends.com/home/best-buy-shuts-down-insignia-line-smart-home-products/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#plumlife-out-of-business-without-notice","title":"Plumlife out of business, without notice.","text":"<p>Plumlife went out of business. No communication. Just up and out.</p> <ul> <li>https://www.reddit.com/r/homeautomation/comments/fptxqf/plumlife_is_dead_if_you_own_plum_lightpads_they/</li> <li>https://apps.apple.com/us/app/plum-app/id1056257719?see-all=reviews</li> <li>https://pitchbook.com/profiles/company/94732-57</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#skydrop-switches-to-subscription-model","title":"Skydrop switches to subscription model.","text":"<ul> <li>https://community.smartthings.com/t/skydrop-going-subscription/164792</li> <li>https://www.reddit.com/r/homeautomation/comments/bufzto/skydrop_introduces_a_new_monthly_subscription_to/</li> <li>https://community.smartthings.com/t/skydrop-going-subscription/164792/47</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#lowes-iris-shutdown","title":"Lowes / Iris shutdown","text":"<ul> <li>https://www.techhive.com/article/583676/lowes-will-shut-down-its-iris-by-lowes-smart-home-platform.html</li> <li>https://support.firstalert.com/s/article/Now-that-the-Lowe-s-IRIS-platform-is-being-shut-down-what-will-happen-to-my-First-Alert-IRIS-alarms</li> <li>https://www.theverge.com/2019/2/2/18208407/lowes-iris-smart-home-platform-shutting-down-march-2019</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#leeo-smart-alert-shutdown","title":"Leeo Smart Alert shutdown.","text":"<ul> <li>https://www.gearbrain.com/leeo-smart-alert-shuts-down-2641145583.html</li> <li>https://www.reddit.com/r/homeautomation/comments/cwthjn/leeo_service_may_shut_down/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2020","title":"2020","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#belkin-wemo-products-discontinued","title":"Belkin / Wemo products discontinued.","text":"<ul> <li>https://www.forbes.com/sites/charlesradclyffe/2020/04/29/belkin-may-never-be-trusted-again-after-this-story/?sh=6e6108ad5795</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#petnet-discontinued-with-no-notice","title":"Petnet discontinued, with no notice.","text":"<p>It would appear for those users with a petnet pet feeder\u2026.. the company up and shuts its doors with little to no notice or warning\u2026.</p> <p>Just uh, imagine being on vacation for two weeks, and your animals starving because your cloud-connected pet feeder is not working, due to the company turning off systems without any warning.</p> <ul> <li>https://arstechnica.com/information-technology/2020/04/after-prolonged-service-outage-petnet-shuts-down-citing-coronavirus/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#wink-transitions-to-paid-service","title":"Wink transitions to paid service","text":"<ul> <li>https://www.consumerreports.org/smart-home/wink-tells-users-pay-up-or-we-will-disable-smart-home-hub/</li> <li>https://www.techhive.com/article/3542631/wink-users-revolt-following-its-sudden-shift-to-a-subscription-model.html\u00a0</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#ifttt-moves-torwards-subscription-model","title":"IFTTT moves torwards subscription model","text":"<p>IFTTT decided to roll out a 10$ a month subscription model, for building custom automations. As expected, this did not play very well.</p> <p>Having personally used IFTTT for a few odd-ball automations, I ended up cancelling/closing my account after this notice. </p> <ul> <li>https://www.droid-life.com/2020/09/10/ifttt-moves-to-subscription-model-with-introduction-of-ifttt-pro/</li> </ul> <p>I will note, after massive community backlash- the pricing and features were modified in a way to be more reasonable, and to not require a paid account in order to use functionality.</p> <p>However- the damage was already done after by the time those changes were announced.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#tp-link-kasa-removes-local-access","title":"Tp-Link KASA Removes Local Access","text":"<p>As a long-time user of tp-link plugs, I would recommend blocking your IOT devices from the internet, preferably in an isolated vlan.... for both security reasons, and to prevent them from updating to remove local access.</p> <ul> <li>https://community.tp-link.com/en/smart-home/forum/topic/255198</li> <li>https://www.reddit.com/r/TPLinkKasa/comments/k26v9l/psa_tp_link_is_shutting_down_local_api_access/</li> <li>https://community.tp-link.com/us/home/forum/topic/154951</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#dark-sky-shutting-down","title":"Dark Sky shutting down","text":"<p>Dark sky has been acquired by Apple, and will be shutting down.</p> <ul> <li>https://blog.darksky.net/dark-sky-has-a-new-home/</li> <li>https://alerts.home-assistant.io/#dark_sky.markdown</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2021","title":"2021","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#xiomi-yeelight-removes-local-lan-control","title":"Xiomi / Yeelight removes local LAN control","text":"<ul> <li>https://home-assistant-guide.com/news/2021/03/31/do-not-update-yeelight-devices-or-the-app/</li> <li>https://forum.yeelight.com/t/topic/22664/280</li> <li>https://www.reddit.com/r/smarthome/comments/mfdj1w/yeelight_no_more_lan_control/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#samsung-smartthings-hubs-depreciated","title":"Samsung / Smartthings hubs depreciated.","text":"<p>Samsungs deprecated its old smartthings hubs. For anyone who owned one, the only option was to buy more hardware and throw away the old, perfectly functional device.</p> <ul> <li>https://staceyoniot.com/smartthings-starts-saying-goodbye-to-its-hardware/</li> <li>https://arstechnica.com/gadgets/2021/06/samsung-is-killing-the-first-gen-smartthings-hub-this-month/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#ambee-goes-from-free-to-paid","title":"Ambee goes from free, to paid.","text":"<ul> <li>https://community.home-assistant.io/t/ambee-going-paid-only/328903</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2022","title":"2022","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#life360-sells-precise-location-data-for-tens-of-millions","title":"Life360 Sells Precise Location Data for Tens of Millions","text":"<p>Life360 caught selling precise location data for tens of millions of adults AND children</p> <ul> <li>https://isharingsoft.com/why-life360-is-bad-for-privacy</li> <li>https://themarkup.org/privacy/2021/12/06/the-popular-family-safety-app-life360-is-selling-precise-location-data-on-its-tens-of-millions-of-user</li> <li>https://appleinsider.com/articles/22/01/28/life360-to-stop-selling-precise-location-data-of-users</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#osram-lightify-discontinues-cloud-services","title":"Osram / Lightify discontinues cloud services","text":"<p>To note however, you can still use these bulbs local-only with zigbee. However, the cloud services have been discontinued.</p> <ul> <li>https://www.osram.com/cb/lightify/index.jsp</li> <li>https://www.techhive.com/article/578405/osram-turning-off-cloud-servers-for-lightify-smart-bulbs-next-august.html</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#d-link-mydlink-discontinues-cloud-services","title":"D-Link / mydlink discontinues cloud services","text":"<ul> <li>https://basic-tutorials.com/news/d-link-discontinues-two-of-its-cloud-services-for-older-devices/</li> <li>https://wifihifi.com/mydlink-app-discontinued</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#wink-ongoing-outages","title":"Wink - Ongoing outages","text":"<p>Wink has had a few outage this year, lasting WEEKS at a time\u2026. I don\u2019t know about you- but, I prefer my home automation and devices to continue working, despite\u2026.. what the vendor is doing.</p> <ul> <li>https://www.androidpolice.com/2021/02/01/wink-has-been-down-for-a-week-and-counting/</li> <li>https://www.reviewgeek.com/122521/wink-smart-homes-are-broken-again-why-are-people-still-paying/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#logitech-logi-circle-api","title":"Logitech / Logi Circle Api","text":"<p>Logitech is no longer accepting applications for access to the Logi Circle API.</p> <p>For existing users that have already obtained an API key, the Logi Circle API will continue to function. However, you may not be able to update your redirect URI.</p> <ul> <li>https://alerts.home-assistant.io/#logi_circle.markdown</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#insteon-shuts-down-without-notification-overnight","title":"Insteon shuts down, without notification, overnight.","text":"<p>This particular issue affected a large number of people. Essentially, Insteon quietly shutdown everything over night. </p> <ul> <li>https://www.home-assistant.io/blog/2022/04/19/for-insteon-users/</li> </ul> <p>Home-Assistant was able to quickly rollout a method for users to transition their insteon devices into home assistant.</p> <p>** Update, Communications were brought back online after a few months, after being re-acquired.</p> <ul> <li>https://arstechnica.com/gadgets/2022/06/insteon-smart-homes-resurrected-as-abruptly-as-they-were-bricked/</li> <li>https://hackaday.com/2022/06/18/insteon-gets-another-chance/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#ihome-discontinued-terminated","title":"iHome discontinued / terminated","text":"<ul> <li>https://community.smartthings.com/t/notice-ihome-control-cloud-service-termination-april-2-2022/240529</li> <li>https://www.reddit.com/r/HomeKit/comments/t6ybwh/warning_to_ihome_accessory_users/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#amazon-turns-over-ring-footage-to-police-without-user-consent-or-a-warrant","title":"Amazon turns over ring footage to police, without user consent, or a warrant.","text":"<p>This is a MASSIVE personal rights / privacy / security breach. Based on reports, this has happened many times before. </p> <p>Imagine having your own camera footage used against you, to incrimate you of a crime... without the authorites even having a search warrant. Regardless if you never break the law- this is a massive red flag. Imagine if you have a ring camera inside of your home which may capture personal / intimite footage... and that footage being turned over to another party, without your consent, a search warrent, or ANYTHING. </p> <ul> <li>https://theintercept.com/2022/07/13/amazon-ring-camera-footage-police-ed-markey/</li> <li>https://www.politico.com/news/2022/07/13/amazon-gave-ring-videos-to-police-without-owners-permission-00045513</li> <li>https://www.markey.senate.gov/news/press-releases/senator-markey-renews-investigation-into-amazon-rings-surveillance-practices-and-cooperation-with-police</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#anker-eufy-uploading-unencrypted-user-images-without-consent","title":"Anker / Eufy uploading unencrypted user images without consent","text":"<p>This, would be a rather interesting thing to hear..... for a camera you purchased which doesn't send data to the cloud. Right?</p> <p>To clarify, the company previously claimed, user data was only stored locally. Imagine being told this, and you find out your camera is sending your photos back to its cloud.</p> <p>This is why I ALWAYS recommend isolating IOT/Security devices on a dedicated vlan, without any internet/external access whatsoever.</p> <ul> <li>https://www.androidcentral.com/accessories/smart-home/security-researcher-says-eufy-has-a-big-security-problem</li> <li>https://arstechnica.com/gadgets/2022/12/more-eufy-camera-flaws-found-including-remote-unencrypted-feed-viewing/</li> <li>https://www.androidpolice.com/more-eufy-security-issues/</li> <li>https://www.youtube.com/watch?v=a_rAXF_btvE</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#anker-eufy-rollsback-privacy-promises","title":"Anker / Eufy rollsback privacy promises","text":"<p>After the above issue, I suppose the resolution to this issue, was to remove privacy promises....</p> <ul> <li>https://www.theverge.com/2022/12/16/23512952/anker-eufy-delete-promises-camera-privacy-encryption-authentication</li> <li>https://www.androidpolice.com/eufy-removes-privacy-language/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#fordpass-blocking-users","title":"Fordpass blocking users","text":"<p>I was unable to find any official response or statement regarding this issue- but, there are reports of users popping up having been blocked/banner from using the ford-pass API with home assistant.</p> <p>It would appear, this is due to an issue with the third party integration, however, it is posted here for awareness.</p> <ul> <li>https://www.macheforum.com/site/threads/psa-unauthorized-api-use-can-disable-your-fordpass-account.13893/</li> <li>https://www.reddit.com/r/homeassistant/comments/z92gvb/fordpass_users_fyi/</li> <li>https://github.com/itchannel/fordpass-ha/issues/214</li> <li>https://github.com/itchannel/fordpass-ha/issues/203</li> </ul> <p>See Disclaimer at the bottom of the third-party github integration:</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2023","title":"2023","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#amazon-ring-ring-requiring-subscription-to-arm-your-alarm","title":"Amazon / Ring - Ring requiring subscription to arm your alarm","text":"<p>Did you spend a few hundred bucks building your own ring alarm? Did you expect to own your hardware?</p> <p>Well, hopefully you pay your subscription to be able to arm your system!</p> <ul> <li>https://www.theverge.com/2023/3/3/23623523/ring-alarm-camera-features-subscription</li> </ul> <p>If you are a user of home-assistant, there IS an easy fix to this. Just- remove the ring cloud from your ring products. The hardware itself, uses z-wave.</p> <p>Full Local Ring Alarm - How To</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#belkin-wemo-massive-vulnerability","title":"Belkin / Wemo - Massive Vulnerability","text":"<p>If, you didn't take note from the Belkin / Wemo issues reported in 2020, a massive new vulnerability has been discovered.</p> <p>And... Belkin / Wemo has no intentions on fixing it. This should be a big sign, to not buy anymore products from Belkin...</p> <ul> <li>https://thehackernews.com/2023/05/serious-unpatched-vulnerability.html</li> <li>https://9to5mac.com/2023/05/16/wemo-smart-plug-security-flaw-no-patch-coming/</li> <li>https://www.hackster.io/news/sternum-researchers-find-a-serious-security-flaw-in-belkin-s-wemo-mini-which-will-remain-unpatched-e6f2255c164d</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#amazon-ring-employees-spying-on-customers-using-ring-cameras","title":"Amazon / Ring - Employees spying on customers using ring cameras","text":"<p>Massive privacy breach, where internal Amazon employees were found guilty of spying on women using ring cameras. </p> <ul> <li>https://www.reuters.com/legal/us-ftc-sues-amazoncoms-ring-2023-05-31/</li> <li>https://www.theguardian.com/technology/2023/may/31/amazon-ring-doorbell-spying-ftc</li> <li>https://abcnews.go.com/Technology/ring-security-cameras-gave-employee-full-access-customer/story?id=99737142</li> <li>https://www.itpro.com/security/privacy/amazons-ring-agrees-to-dollar58m-settlement-over-alleged-use-of-its-cameras-to-spy-on-female-customers</li> <li>https://metro.co.uk/2023/06/01/amazons-ring-camera-used-to-spy-on-customers-18879700/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#myq-officially-blocks-3rd-party-applications","title":"MyQ - Officially blocks 3rd party applications","text":"<p>While- MyQ has been very troublesome for years, In november, they officially announced that no 3rd-party access was allowed. </p> <ul> <li>https://chamberlaingroup.com/press/a-message-about-our-decision-to-prevent-unauthorized-usage-of-myq</li> <li>https://www.home-assistant.io/blog/2023/11/06/removal-of-myq-integration/</li> <li>https://www.theverge.com/23949612/chamberlain-myq-smart-garage-door-controller-homebridge-integrations</li> </ul> <p>So... if you take hint from the multitude of issues over the last few years.... officially, home assistant will no longer work with myQ.</p> <p>They did start a \"Works with MyQ\" program, however, the list of supported integrations is more of a joke, then a practicality. </p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#mazda-cease-and-desist-letter-sent-to-maintainer-of-integration-library","title":"Mazda - Cease and desist letter sent to maintainer of integration library","text":"<ul> <li>https://www.home-assistant.io/blog/2023/10/13/removal-of-mazda-connected-services-integration/</li> <li>https://github.com/github/dmca/blob/master/2023/10/2023-10-10-mazda.md</li> </ul> <p>As a result of the library's maintainer literally being threated with legal action.... Mazda integrations are no longer available.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2024","title":"2024","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#ariston-constant-api-issues1","title":"Ariston - Constant API Issues<sup>1</sup>","text":"<ul> <li>https://github.com/fustom/ariston-remotethermo-home-assistant-v3/issues/361</li> </ul> <p>Nothing worse then an API which is constantly breaking.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#viron-astral-pool-chlorinator","title":"Viron Astral Pool Chlorinator","text":"<ul> <li>https://community.home-assistant.io/t/viron-astral-pool-chlorinatorgo-integration/375495/408</li> </ul> <p>Updated their API, forced internet connections. Basically broke all local integrations.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#ecobee-no-longer-allowing-api-access","title":"Ecobee - No longer allowing API Access","text":"<p>*https://www.home-assistant.io/integrations/ecobee</p> <p>On the plus side, You can integrate these with homekit still.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#shark-api-no-longer-accessible-integration-broken","title":"Shark - API no longer accessible - Integration Broken","text":"<ul> <li>https://github.com/JeffResc/sharkiq/issues/51</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#tplinkkasa-kl135-bulbs-reset-without-internet","title":"Tplink/Kasa - KL135 bulbs reset without internet","text":"<ul> <li>https://www.reddit.com/r/TPLinkKasa/comments/x3pyh4/kl135_bulbs_keep_resetting_themselves/</li> </ul> <p>I personally keep all of my IOT devices 100% isolated from the internet, and the rest of my LAN. This is unacceptable.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#2025","title":"2025","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#tesla-charging-money-for-api-access","title":"Tesla - Charging money for API Access","text":"<ul> <li>https://mashable.com/article/tesla-api-pricing</li> <li>https://developer.tesla.com/docs/fleet-api/billing-and-limits</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#bambu-limiting-3rd-party-access","title":"Bambu - Limiting 3rd party access.","text":"<p>This- is not specifically cloud- as these products are locally accessed and controlled, however, I feel it deserves a spot on this list.</p> <ul> <li>https://blog.bambulab.com/firmware-update-introducing-new-authorization-control-system-2/</li> <li>https://github.com/greghesp/ha-bambulab/issues/833#issuecomment-2596570305</li> </ul> <p>This firmware update will make it to where many actions requires authorization in order to be executed.</p> <p>Not- YOUR authorization, but, \"Official\" authorization.</p> <p>Have a 3d printing dashboard in home assistant, where you have buttons to start/stop printing, etc?</p> <p>More or less- you are about to lose the ability to set/write anything to your Bambu products.</p> <p>Yet another reason to look for user-servicable firmware.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#on-going-issues","title":"On-Going Issues","text":"<p>On-going issues are categorized as issues which are frequently on-going, or repeating. </p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#amazon-cloud-outages","title":"Amazon / Cloud Outages","text":"<p>While, this is very infrequent and rare, There have been multiple cases of issues at amazon datacenter, which rendered many cloud-automation products unusable. I personally prefer my home automation remain functional, REGARDLESS of what is happening outside of my walls.</p> <p>This issue can impact any large service provider, internet circuit, etc.</p> <ul> <li>https://www.mercurynews.com/2021/12/08/how-amazon-outage-left-smart-homes-not-so-smart-after-all/</li> <li>https://awsmaniac.com/aws-outages/</li> <li>https://twitter.com/goveeofficial/status/1331776827321241600</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#tuya","title":"Tuya","text":"<p>I am not even going to go into the details. However, there are nearly daily reddit posts regarding people having issues with Tuya cloud products.</p> <p>As well, Tuya may be changing to a subscription model soon\u2026 SO, you will have to pay someone else to use the products you purchased. </p> <p>Just- do yourself a favor... avoid Tuya if at all possible.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#myq","title":"MyQ","text":"<p>Like Tuya, MyQ garage door openers are riddled with cloud issues.</p> <p>Google Search</p> <p>Do yourself a favor. Save a few bucks, and use one of these options</p> <p>MyQ also switched to a subscription model, in order to use external automation via IFTTT/Google/etc.</p> <ul> <li>https://decortweaks.com/does-chamberlain-myq-require-a-subscription/</li> <li>https://www.reddit.com/r/homeautomation/comments/cb2oxb/myq_premium_services_are_free_at_the_moment/</li> <li>https://www.reddit.com/r/homeautomation/comments/8l735z/when_did_myq_become_subscription_based_wtf/</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#your-personal-internet-network","title":"Your PERSONAL Internet / Network","text":"<p>Ever have an internet outage? Are you \"OK\" with your cloud products being non-functional while your internet is down?</p> <p>If you have a thief / intruder, are you \"OK\" with your security cameras not recording when your internet connection is cut?</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#your-privacy","title":"Your Privacy","text":"<p>If you are using an automation product which is cloud based, which does not charge you\u2026 YOU are the product. Nothing is free. Hosting costs money. </p> <p>If a cloud provider is not directly charging you, either they are likely selling your data elsewhere, or have future plans of a subscription-based model. If you don't believe in this statement- go read-over the earlier issues noted in this post.</p> <p>Need an example? </p> <p>Quote</p> <p>In December, self-described \"family-safety platform\" Life360 was reported to be selling location data from both adults and children to a dozen various data brokers. The brokers would then provide the information to other third parties.</p> <p>The company initially argued that selling the data was a way to \"keep the core Life360 services free for the majority of our users.\"</p> <p>Source</p> <p>See More</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#amazon-ring-blink-etc","title":"Amazon Ring / Blink / etc.","text":"<p>While, there are \u201csupported\u201d integrations for these products in home-assistant, I caution you to tread lightly. Here is an email chain between myself and blink customer support from 2020.</p> <p></p> <p>Blink stating any 3rd party automation is against their TOS. For the record, Home-Assistant, Hubitat, HomeSeer.... are all 3rd party integrations.</p> <p>For the record, Blink cameras are USELESS without their cloud service. There is no way of locally getting footage or images from the cameras. If your account is disabled, you may as well use these cameras as a doorstop.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#security-concerns","title":"Security Concerns","text":"<p>I am not about to post the hundreds of news posts where somebody\u2019s cloud-connected IOT device was compromised. However do be aware, those internet-connected devices may or may not be secure.</p> <p>I have seen many posts where an \u201cinternet-enabled\u201d camera was basically unsecured to the internet, allowing anyone to easily view footage from the camera. You don\u2019t want this to happen. </p> <p>As well, many ring/blink/simplisafe/cloud products are susceptible to a wifi-deauth attack. A deauth attack, in basic terms, rendors your wifi-network unusable. What do you believe happens when your wifi cameras cannot upload footage back to the cloud server? Most of them have VERY limited internal storage. Keep this in mind\u2026 For this reason, I would recommend hard-wired devices where possible.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#what-do-i-recommend","title":"What do I recommend?","text":"<p>I recommend using products which are either open-source based on easily obtainable hardware such as using Esphome with a dirt-cheap microcontroller. Or using a \u201copen\u201d protocol, such as Z-Wave, Zigbee, etc.</p> <p>I have been 100% satisfied with my z-wave devices.</p> <p>For cameras, get a camera which works 100% locally, which supports RTSP, RTMP, OnVIF. Reolink, Hikvision, Amcrest, and many more all have options for you. I would recommend avoiding Unifi cameras however.</p> <p>If you have any questions on what products to use, Ask. Ask in the discord for this site(Look at the very bottom of the page on the right). Ask on r/homeassistant. Ask on r/homeautomation.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#what-should-you-look-for-in-a-product","title":"What should you look for in a product?","text":""},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#vendor-agnostic","title":"Vendor Agnostic","text":"<p>When choosing a product, you want something that is vendor agnostic. You don\u2019t want to get locked into a particular vendor\u2019s ecosystem (Ring, Unifi, TP Omada, etc). If you need a new security camera, it should work with whichever NVR you decide to choose. Likewise, your NVR should work with whichever camera you get.</p> <p>This way, years down the line, when your vendor stops adding features, or you need to replace your unit\u2026 You can acquire a replacement unit with improved features/functionality/performance, and add your old cameras to the new unit.</p> <p>I will repeat this. Do NOT lock yourself into a single vendor\u2019s ecosystem. When that vendor closes doors, or discontinues the product line, you do not want to be stuck with a large investment of devices which are now either non-functional, or missing features which were dependant on that vendor\u2019s cloud.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#open-source","title":"Open Source","text":"<p>Many things will not be open source. But, if you can find things which are open source, it is always a plus.</p> <p>Why? Because when your vendor stops producing updates, or your old device has a crucial bug or vulnerability. Open source gives people the ability to update this. Esphome is absolutely fantastic for flashing onto your devices to give native home assistant capabilities, and to unlock new features.</p>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#open-standarderized","title":"Open / Standarderized","text":"<p>For communication methods, I look for devices with a standardized specification. Like z-wave. Why?</p> <ol> <li>It is backwards compatible. In 10 years from now, my current devices should still work.</li> <li>I can configure and maintain all of my z-wave devices in a consistent, and unified method.</li> <li>I don\u2019t need to maintain random apps on my phone to configure them. I don\u2019t need to keep around old documentation to remember how to configure a device with obscure methods. It\u2019s all in one place, in a unified manner.</li> <li>For this reason, I avoid Lutron Caseta / Insteon / etc, as those technologies have a very specific method of communication. If your hub stops working, can you easily drop in a 3rd party replacement, or DIY? In most cases, the answer is no.</li> </ol>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#changelog","title":"Changelog","text":"<p>As this is a living post, if you feel anything is missing, or incorrect, please let me know on the discord link at the bottom-right corner of this website.</p> <ul> <li>4/20/2022 \u2013 Created initial post.</li> <li>4/12/2022 \u2013 Added more references from THIS post.</li> <li>12/1/2022 - Migrated post to static site. Updated/followed up on a few of the entries.</li> </ul>"},{"location":"blog/2022/reasons-to-avoid-cloud-based-automation-products/#footnotes","title":"Footnotes","text":"<ol> <li> <p>This record was pulled from https://github.com/unixorn/internet-of-trash\u00a0\u21a9</p> </li> </ol>"},{"location":"blog/2024/bathroom-floor-replacement/","title":"Replacing a bathroom floor","text":"<p>Recently, it came to my attention the floor in my middle bathroom had become a hazard, and was rotting out.</p> <p>This post, goes over replacing the floor, including what happened, and how it was fixed.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#detecting-the-issue","title":"Detecting the issue","text":"<p>So, Sometime in July, my wife told me something odd was going on with the main bathroom.</p> <p>After investigation, I concurred that, something indeed odd was happening.</p> <p>The first sign- the toilet was literally sinking into the floor.</p> <p></p> <p>(Sorry- I didn't take a good \"Before\" picture, having to work on other pictures I had laying around).</p> <p>Next- when walking near the toilet, it was pretty obvious the floor was shifting. Looking at the trim on the back-wall- the floor had noticeably sunk as well.</p> <p>For reference- here is a picture of the area as of April, 2022.</p> <p></p> <p>This image was taken while we were remodeling the bathroom, removing the 1970's wood trim, and slightly updating everything.</p> <p>For reference- the area circled in red, is the area which appears to be affected.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#next-steps-determine-the-scope","title":"Next steps- Determine the scope","text":"<p>A few days later after work, I went ahead and crawled under the house, to scope out how bad the issue was.</p> <p>Well- what I discovered, was quite a bit worse then I was thinking....</p> <p></p> <p></p> <p>So- the first obvious symptom- the floor is literally rotten.</p> <p>Next- you will notice the plumber who installed this toilet, sliced right through the middle of the joist. (this- is/was responsible for sagging floor issues in the hallway......)</p> <p>Finally- you will notice- somebody was aware of this issue, and \"fixed\" it by nailing a bunch of 1x4s to the floor............</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#allstate-rejection-1","title":"Allstate - Rejection 1.","text":"<p>So, given I had water damage, I decided to contact my insurance company, Allstate, to get a claim opened. Because, of course, \"I am in good hands\"</p> <p>I suspected the damage was caused by a leaking toilet flange. After reviewing the photos, without sending out an inspector, or adjuster, the claim was denied.</p> <p></p> <p>I will save you from needing to read the entire policy, and its numerous pages of \"exclusions\" to coverage- but, I will draw attention to AllState - Does homeowners insurance cover water damage</p> <p>Specifically- this, copied from the above website, on 2024-10-10.</p> <p></p> <p>Does homeowners insurance cover water damage from leaking plumbing?</p> <p>Homeowners insurance may help cover damage caused by leaking plumbing if the leak is sudden and accidental, such as if a washing machine supply hose suddenly breaks or a pipe burst. However, homeowners insurance does not cover damage resulting from poor maintenance. So, if damage results after you fail to repair a leaky toilet, for example, homeowners insurance likely will not pay for repairs.</p> <p>So- assuming the theory of leaking toilet flange- it is indeed, not covered.</p> <p>Note- the highlighted section for later... It becomes extremely relevant.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#fixing-the-issue-myself","title":"Fixing the issue myself.","text":"<p>Given my insurance company who claims to cover burst pipes, does not cover burst pipes, I decided to go ahead and remediate this issue myself.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#removing-the-old-floor","title":"Removing the old floor","text":"<p>The first step was easy- remove the old floor. Simply hitting the tile with a hammer, was enough to cause the floor to completely collapse.</p> <p>Yes. The tile was holding the floor up.</p> <p></p> <p>On a positive note, while removing the floor, I did discover the floor under the tub, was in good condition, and did not need to be removed.</p> <p>This, would have escalated costs, and added another day or two of labor.</p> <p></p> <p>But, the other wall, was not so lucky. The rot extended well under the wall dividing the two bathrooms.</p> <p></p> <p>Here- is a picture showing the back-wall. </p> <p></p> <p>And- here is a picture of the entry way, after being mostly cleaned up.</p> <p></p> <p>A few hours was spent using hammers, chisels, drills, sawzalls, etc to remove the rotten wood where possible.... </p> <p>During this process, I also cut back the bad sections of the joist, and removed the useless 1ft section of joist attached to the exterior wall.</p> <p>Here- is a picture of the majority of cleanup completed.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#obtaining-supplies","title":"Obtaining Supplies","text":"<p>So- most of the replacement supplies were obtained BEFORE removing the floor... however, I did have to make quite a few additional stops to pick up unexpected items.</p> <p>But, here is a short list of items-</p> <p>Tile:     * New Tile (1ft x 2ft large format tile)     * Thinset     * Grout     * Grout Sealer     * Tile Spacers</p> <p>Subfloor:     * Advantek (I researched, and found this to be highly recommended... Its essentially soaked in resin.)     * Redguard (paint-on waterproofing membrane)</p> <p>Framing:     * 2x4s (Used in a few areas)     * 2x6, 2x8, 2x10 - Used to add new framing around joists, adding stringers. etc.     * 4x4 Used to support the currently unsupported joist.     * concrete pier</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#oops-cut-a-pipe-on-accident","title":"Oops. Cut a pipe on accident","text":"<p>During the removal process, I was using a saw-zall to cut out sections of the rotten subfloor.... and I accidentally nicked a drainage pipe.</p> <p>This- one was fun enough to eat up a couple of hours of time....</p> <p>First- a picture of the cut pipe through the wall, after I cut it off, at the section which was nicked.</p> <p></p> <p>And- a couple of angles from below.</p> <p></p> <p></p> <p>So, I did not take a picture during \"fixing\" this issue, or after. But- the process of fixing this, involved cutting away the nearly inch and a half base-floor to get enough pipe exposed to add a coupler.</p> <p>This process, involved using a saw-zall to cut the base-floor on the sides, up to the seal-plate.... and a very long drill-bit to slowly drill away behind the pipes, to avoid causing any more unneeded damage.</p> <p>Afterwards, I was able to remove this section of subfloor, and properly repair the drain-pipe using a coupler.</p> <p>(Sorry- images were not a huge priority during this process!)</p> <p>I did go ahead and cut the main drainage line to properly install new couplers anyways, as getting the pipe into the coupler without doing this, was proving to be overly difficult.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#framing-foundation","title":"Framing / Foundation","text":"<p>Part of installing the new floor, meant it needed to be properly secured, on all sides. You don't want a soft spot, this could cause the tile to crack.</p> <p>As well, since the center joist was completely cut in two by a careless plumber years back... a portion of the house was not properly supported causing the floor to sag.</p> <p>Most of the original joists were 2x6. For many of these areas, I used 2x8, and even 2x10 lumber, to provide additional strength. (Overkill... Not needed)</p> <p>The vast majority of lumbar used here, is also pressure-treated, to provide additional water/rot resistance. (If the wood is green-tinted, is likely pressure-treated.)</p> <p>The first step, was to properly support the old joist. A 2x8 was used here, with joist-hangers attaching to the other two joists. As well- if you look closely- there is a concrete pier supporting both the joist, and the new stringer from the bottom. You can also see stacks of 2x6 pressure-treated boards, used to create stringers, and additional support for the new floor, and the tub.</p> <p></p> <p>Next- we wanted to ENSURE the toilet would be properly supported. To accomplish this, a Pair of pressure-treated 2x10s were used to create joists. Joist-hangers were used to connect to the stringer. A few additional pieces of wood were used to ensure the seal-plate was properly supported, and to ensure everything is nice and tight.</p> <p>Note- Notches in the bottom of the new joists to compensate for the pipes.... These were needed because the new material, is.. well. bigger. Ample room was cut-out to allow for pipe-movement, without knocking against the boards.</p> <p></p> <p>Here- is this section closer to completion.</p> <p></p> <p>Here is a good shot of the additional support added for the original, severed joist. As a note- this joist had to be lifted around 1 inch, to become properly level again. (This is why my hallway floor has a massive sag in it!!!!)</p> <p>The 4x4 has a 2\" notch, which supports the old joist, and supports the new stringer as well.</p> <p></p> <p>In the following picture, the new foundation and framing has been nearly completed. You can see stringers on either side, designed to ensure the new subfloor is properly supported.</p> <p>Do note- the new floor does not fit under the tub. Additional support was added under the tub as well, to ensure it is properly supported.</p> <p></p> <p>And, after a while, the framing/foundation work was completed.... The subfloor was cut to dimensions, and a hole was added for the potty.</p> <p></p> <p>Not shown- all of the debris, wood, saw-dust, etc was raked up from under the house. I don't need to give terminates any extra reasons to move in. My trash-disposal company was quite happy with me.... /s.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#relocating-the-hvac-duct","title":"Relocating the HVAC Duct","text":"<p>During this process, We also decided to slightly relocate the vent from the tiled bathroom area, to the other side of the separating wall. This, would prevent water from being splashed into it, and would also mean I wouldn't need to slice up the pretty tile to install an ugly vent.</p> <p>Now, I don't have a good image showing where the duct used to be- but, if you look at some of the pictures during the rot-removal process- you will see the duct near the tub, by the corner of the separating wall.</p> <p>Due to the timing, most of the hardware stores was closed when this was done. Since, my new vent had a 4\" inlet, I needed to adapt the existing 5\" line.</p> <p>First- I used some tin-snips to make several small cuts on the radius.</p> <p></p> <p>Next, using a pair of linesman pliers, I made bends on each of the cut segments.</p> <p></p> <p>Finally- using a piece of the old 4\" aluminum drive-shaft from \"Project - Racetruck\", I clamped the 5\" pipe down, using a standard hose clamp.</p> <p></p> <p>Afterwards, I was able to fit a 4\" 90 degree bend on.</p> <p></p> <p>From here, I was able to go ahead and connect up the new duct. Insulation was wrapped around the new duct, and re-secured around the old duct to somewhat stop heat/cold loss.</p> <p></p> <p>Again- apologize for the lack of good images- Taking pictures was not a priority during this process! </p> <p>Also- it appeared the duct was not supported well enough. Since- I didn't have the correct hanger material, I bent a piece of scrap steel I had laying around, and securely attached it to the joist.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#installing-subfloor","title":"Installing Subfloor","text":"<p>Again- I didn't take nearly enough pictures to fully document this-</p> <p>But, after the subfloor was cut, a healthy bead of construction adhesive was placed on top of every board it touched. This- prevents noises, and squeaking while walking on the subfloor.</p> <p>#8, 2\" screws were used to fasten the sub-floor to the joists, and stringers. This, also helps secure the subfloor. Between the screws, and adhesive, there will be no noise, no squeaking, etc...</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#toilet-flange","title":"Toilet Flange","text":"<p>After the sub-floor was installed, a hole for the toilet line was cut with a hole saw, and the toilet flange was installed.</p> <p></p> <p>You may notice the silicon which was very liberally applied. I don't EVER want to worry about this particular floor rotting. Silicon was used everyone under, and around this flange. Even if it manages to leak- The silicon will prevent anything from rotting out.</p> <p>Note</p> <p>Only use 100% silicon caulk here! Don't use acrylic caulk!</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#foam","title":"Foam","text":"<p>Since, there were quite a few gaps around the wall, from where the new subfloor, didn't exactly match up with the old, spray-foam was used to provide a barrier.</p> <p>In- this image, you can see the foam applied, and a few of the tools used. Acrylic caulk was used in a few areas of the wall to assist with sealing.</p> <p>The main purpose of this foam, is to create a barrier which both prevents things from seeping out (thinset, membrane, etc....), and to prevent things like insects and slugs from crawling in.</p> <p>Yes- there is a specific reason slugs were mentioned.....</p> <p></p> <p>Before you ask why there is a machete in the above image.... Just know, it does a fantastic job of trimming foam, removing rotted wood, etc....</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#waterproofing-membrane","title":"Waterproofing Membrane","text":"<p>While, Adventek is supposed to be quite water resistent, I decided to go ahead and apply preventative measures as well. Especially- since my kids love splashing water all over the floors.</p> <p>For this, I decided to use Redguard. </p> <p>In short, you paint a few coats on the floor, and it provides copious amounts of water resistance. </p> <p></p> <p>Once it turns completely red, with no hints of pink- it is ready. This will generally take a few hours per coat. I applied 3 coats.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#cutting-tile","title":"Cutting Tile","text":"<p>To cut the tile, I picked up a tile-cutter from harbor freight. It performed its role without issue. </p> <p>You may also need a Diamond Blade for more elegant cuts. Especially, if your 2-foot wide tiles don't fit into the tile-cutter like me. </p> <p>Warning<p>When cutting tile, with a diamond blade- make sure to spray lots of water to keep the blade cool.</p> <p>I used a spray-bottle, to constantly stream water into the path being cut.</p> <p>Failure to keep the blade cool, will result in the blade failing prematurely. </p> </p> <p>After, measure, cut, measure, cut, measure cut.... for a while, I had all of the tile layed out on the floor.</p> <p></p> <p>And.... Af this point, I was ready to put in thinset to permanently mount these files. </p> <p>So.... I went to mix up a batch of thinset in a bucket, and came back to....</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#disaster-flooded-floor","title":"Disaster - Flooded Floor","text":"<p>Turns out, there is a plumbing leak. Whenever you turn on the spigot in the front- it floods the wall in-between the studs.</p> <p>After filling up my bucket with water, The new floor had accumulated a half inch of water.</p> <p>So.... I went ahead and opened up the wall to determine what was happening.</p> <p></p> <p>Other then... obviously the handy work of the old plumber who cut the entire joist in half.... (the torched drain-line...)</p> <p>Not- a lot to see here, right?</p> <p>Well- I saw with my own eyes, water pouring from this section of the wall. So, I turned the water mains off, and cut the copper line, and removed the spigot.</p> <p></p> <p>Low and behold, we have a burst pipe. This, likely occurred during one of the recent freezes.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#replacing-spigot","title":"Replacing Spigot","text":"<p>So, I went to the hardware store, again, to pick up a new spigot.</p> <p></p> <p>And, the next step, was to get everything sweated back on. </p> <p>No, I am NOT using shark bite fittings, or any of that other crap. Sweating a pipe is easy. You see my blog, Its covered in computers, programming, and technology. I am obviously not a plumber.</p> <p>And, I sweated the pipe, as seen below.</p> <p>Step 1- Clean up the old pipe.</p> <p>Use emory cloth, or just some high-grit sandpaper. It should be nice and shiny.</p> <p>Note, in the below image, you can see pieces of tile used to prevent from torching the sheetrock, or anything else behind this fitting.</p> <p>There are products specifically for this purpose, however, I had pieces of tile already on-hand. Tile, is quite resistent to heat. And, it was only exposed for a short duration.</p> <p></p> <p>Not shown- Apply flux to the interior of your new fitting, and on the pipe being sweated.</p> <p>Warning<p>Don't be like the plumber who originally did the plumbing. Block the heat from torching the rest of the house, or PVC behind the area you are working on.</p> <p>It takes 5 seconds to put a heat-barrier to avoid charring whatever is behind the copper you are working on.</p> </p> <p>Apply Heat via propane/map gas torch. The solder should melt, WITHOUT direct flame. If its not melting, your pipe is not hot enough.</p> <p>Danger<p>Do NOT sweat pipe the same way you solder electronics.</p> <p>The copper needs to be hot enough to melt the solder. If its not- then you will not properly sweat the connection.</p> <p>The solder should melt upon contact with the pipe, and it will be \"sucked\" into the gaps.</p> </p> <p>Once done, you should have a nice, and pretty fitting, with solder properly sucked into all of the gaps... Like this.</p> <p></p> <p>Don't be like the guy on the right. That is wrong. That is not professional.</p> <p>I'm not a plumber, and I have not sweated a pipe in over a decade. Compare my work with the previous work.</p> <p>Notice- the nice CLEAN job, without gobs of solder dripping all over the place? Do that.</p> <p>After this point, I opened the outdoor spigot, and turned the water mains back on.</p> <p>With- someone on the inside watching for any leaks, I closed the spigot. No leaks were detected, so, this is finished for now.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#easter-egg","title":"Easter Egg","text":"<p>While looking inside of the wall- we did manage to find an easter egg. </p> <p>A bit of research hints this can was from 1950-1970.</p> <p></p> <p>BUT.... if you paid attention in earlier images, especially the section where I accidentally cut the drain-pipe... You may have noticed an extra unpopulated hole.</p> <p>Well- this blocks the hole on the top side. So, instead of an easter egg, appears whoever was working on this was busy drinking beer. This- explains the horrible sweat jobs, and torched PVC....</p> <p>But- that was 50+ years ago...</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#laying-tile","title":"Laying Tile","text":"<p>With, the plumbing issue remediated, we went back to finishing up the tile.</p> <p>So- not pictured, BEFORE fixing the plumbing issue, we did get around half of the tile layed.</p> <p></p> <p>But- a huge problem arose.... Since, a few hours were wasted with drying up the floor, and locating the plumbing issue- The thinset (rapid-set, thinset) had already begun setting up.</p> <p>This was noticed about a row or two in. It was extremely obvious, when the thinset was \"set\", in mere minutes.</p> <p>We did attempt to set the rest of the floor, but, later that night, I \"tested\" the tiles using a hammer. (gentle taps). Based on the noise the tile makes, you can make an extremely good approximation if its properly \"set\".</p> <p>Turns out, the last two rows were not set. So- an hour was spent scraping, and hammering out the thinset. My pneumatic air-hammer worked REALLY good for removing the thinset... and redguard.</p> <p>So- I did have to wait a few more hours while new coats of redguard went down. </p> <p>During this waiting time, we melted down a few aluminum, and copper ingots in the driveway with my forge.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#passing-time-melting-copper","title":"Passing Time - Melting Copper","text":"<p>The first copper ingot- Apparently I did not do a good job removing all of the flux before pouring.</p> <p></p> <p>But, with a tiny bit of grinding and buffing, it cleaned up extremely nicely.</p> <p>I also recently acquired a new carbide saw blade for my 14\" DeWalt Chop Saw. Something like this: Amazon - Evolution Carbide Blade</p> <p>(Image- was taking a bit later when I was doing the wood floor.... but, still provided to give a good idea of the chop saw.)</p> <p></p> <p>After, watching it effortlessly slice through wood, aluminum, and basically everything else like a hot-knife through butter, I decided to try it one of my aluminum ingots.</p> <p>Turns out- slices through those like butter too.</p> <p></p> <p>In a few weeks, when I get my garage cleaned up, I'm going to toss all of my ingots on the lathe, and machine down the dimensions to be... uniform, and flat. The flat look is very nice looking.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#back-to-the-floor","title":"Back to the floor","text":"<p>After playing around with melting metal for a bit, the coats of redguard were once again applied. it was time to finish the tile.</p> <p>So, we did.</p> <p></p> <p></p> <p>This time, the process went MUCH smoother, as we also made the thinset, slightly thinner. This gave PLENTY of time for laying laying the files, and adjusting the height of each one.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#final-steps-grout-and-drywall","title":"Final Steps... Grout and Drywall.","text":"<p>So, the only remaining items left- grout the tiles, and add the drywall.</p> <p>This process, was honestly extremely easy, and quite relaxing. </p> <p>Mix grout to pancake-batter-like consistency, and use a float to push it into the cracks.</p> <p></p> <p>Wait a hour or so, come back with a wet grouting sponge, and wipe up any excess.</p> <p>The next day, come back and give it a nice shine.</p> <p></p> <p>Do note- the progress of replacing, and texturing the drywall in the background too.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#mostly-finished","title":"Mostly Finished","text":"<p>After a coat of paint, this project is nearly done.</p> <p></p> <p>Will need to add another coat of paint, and then cut/paint trim to replace the trim. However- project is nearly completed.</p> <p>A threshold will be added too, along with grout sealer after a week or so.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#bonus-closet-floor-replacement","title":"Bonus - Closet Floor Replacement","text":"<p>While someone was working on texturing the drywall, I did decide to go ahead and redo the floor in one of the closets.</p> <p>So, A few weeks ago, I pulled the carpet out of the closet, and sanded down the floors to remove the construction residue/etc.</p> <p></p> <p>I WAS planning on applying wood stain, with a coat of polyurethane, however, I came into possession of quite a few boxes of wood floor. So- I decided to use those.</p> <p>To, give an example- here is one of the other closets I pulled the carpet from, stripped, sanded, stained, and poly-d.</p> <p></p> <p>Nothing, fancy. But, I do like the wood texture.</p> <p>But, since... I had the boxes of wood flooring on hand.....</p> <p></p> <p>Yup. This looks much better. Really glad I did this.</p> <p>But- one thing that was bothering me- the wood did not perfectly line up.</p> <p></p> <p>Now- this is basically a non-issue, as the threshold would cover this.... But, I decided to pull out the wood chisel for a bit.</p> <p></p> <p>Much better.</p> <p>Anyways, will grab threshold in the future, which will completely cover the transition between wood, and \"fake wood\".</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#allstate-rejection-number-2","title":"Allstate - Rejection Number 2.","text":"<p>So, remember the part I quoted from Allstate's website above, talking about how burst pipes are covered? If not- here, I'll paste it here again.</p> <p>Does homeowners insurance cover water damage from leaking plumbing?</p> <p>Homeowners insurance may help cover damage caused by leaking plumbing if the leak is sudden and accidental, such as if a washing machine supply hose suddenly breaks or a pipe burst. However, homeowners insurance does not cover damage resulting from poor maintenance. So, if damage results after you fail to repair a leaky toilet, for example, homeowners insurance likely will not pay for repairs.</p> <p>Well, I decided to submit new evidence to my claim, since, obviously a pipe had burst.</p> <p></p> <p>I was greeted by an extremely pleasant individual.</p> <p></p> <p>So, in response, I sent back this response.</p> <p></p> <p>And, finally, they decided to take another look.</p> <p></p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#rejected-again","title":"Rejected, Again.","text":"<p>So, the next day (today), I received a phone call from the adjuster.</p> <p>And, once again, the claim is denied.</p> <p>Because, my burst pipe is being considered \"leaks and/or seepage\".</p> <p>Despite, it literally flooded the house, when the outdoor spigot is turned on.</p>","tags":["Home Improvement"]},{"location":"blog/2024/bathroom-floor-replacement/#final-words","title":"Final words?","text":"<p>I will strongly urge you to review your Allstate policy, and determine if they are the correct insurance company for you.</p> <p>In my case, I really don't feel as though, \"I am in good hands\".</p> <p>As quoted above directly from their website, \"Sudden and accidental breaks or pipe bursts\" are covered. But- suppose if the leak is inside of the wall, and goes undetected, then apparently it is considered a seeping pipe.</p> <p>Apparently, my pipe which suddenly burst during cold weather, is NOT covered.</p> <p>To also confirm, Allstate NEVER sent out an inspector, or adjuster to physically look at anything.</p> <p>I, am also no longer with Allstate.</p>","tags":["Home Improvement"]},{"location":"blog/2022/transitioning-to-kubernetes/","title":"The next homelab evolution &amp; Static Site","text":"","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/transitioning-to-kubernetes/#introduction","title":"Introduction","text":"<p>Over the last few months, I decided to learn kubernetes. </p> <p>Now- I am a pretty technical person. I have computers and old enterprise hardware all over my house. I have been a software developer for over a decade now...</p> <p>I previous had multiple docker servers running nearly 100 combined containers in my lab.</p> <p>Warning</p> <p>Spoiler! There was indeed a steep learning curve associated with kubernetes.</p> <p>You will often see people posting demonstrations of their setups online, posting how amazing it is, etc- but, you will hardly ever see the work which went into it, and the failures encountered.</p> <p>I personally, failed quite a few times before achieving an environment for which I am happy with. I spent on and off- nearly two months finding what works, and what doesn't work.</p> <p>I had to wade through depreciated software<sup>1</sup>. I have encountered software which has not properly been updated<sup>2</sup>. And- lots more.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/transitioning-to-kubernetes/#the-bright-side","title":"The bright side","text":"<p>However- after repeated efforts to build a cluster to my specifications- I was successful.</p> <p>Not only successful, but, I REALLY like Kubernetes. There are things you can do here- which were quite a bit more difficult, or not even possible using docker.</p> <p>The moral of this story- </p> <p>Quote</p> <p>If at First You Don't Succeed, Try, Try Again - Xen Cho <sup>3</sup></p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/transitioning-to-kubernetes/#a-few-topics-i-plan-on-addressing-in-the-near-future","title":"A few topics I plan on addressing in the near future.","text":"<p>In the future- I plan on covering a few of the features I am really pleased with in more details.</p> <ol> <li>Single Sign On, Using Authentik</li> <li>Backups using Veeam/Kasten</li> <li>Automated Monitoring and Data collection via Promthesis and Grafana using the Prometheus-Operator</li> <li>Automatically allocating GPUs for transcoding in Plex using Intel Device Plugin and Node Feature Discovery</li> <li>Using Ansible within Kubernetes to automatically provision servers, and build / push custom docker images. (This site runs on a custom container build using ansible.)</li> <li>How to get your Coral TPU, Z-wave stick, and RTL_SDR working within a multi-node kubernetes cluster.</li> <li>Rook-Ceph, and why I chose to use it over Longhorn.io</li> <li>Why and how I decided to post a static blog over using my existing Wordpress</li> </ol> <ol> <li> <p>See https://github.com/rancher/k3os/issues/846. TLDR; When OpenSUSE acquired rancher- a few... support... issues arose.\u00a0\u21a9</p> </li> <li> <p>Longhorn took over a year to remove pod security policy from their helm charts, despite it being depreciated in kubernetes v1.21. See github issue HERE. For a new-user trying to follow the setup directions on a current, up to date kubernetes cluster- this caused a lot of issues.\u00a0\u21a9</p> </li> <li> <p>Reference \u21a9</p> </li> </ol>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/","title":"Why I am migrating away from wordpress","text":"<p>Why am I moving away from wordpress?</p> <p>Three reasons.</p> <ol> <li>Security</li> <li>Performance</li> <li>Reliability</li> </ol>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#security","title":"Security","text":"<p>Wordpress is not the most secure platform in the world. Over the last 15 years or so, it has had quite a few CVEs. </p> <p>I am not immune to them. One of my other sites was pwned a year or two back, due to an expoit in a SMTP Plugin. Knock on wood- the damage was rather limited since I do not collect customer data, accounts- or well, anything at all useful. Restoring, was quite an easy task because I do validate my backups.</p> <p>However- Its only a matter of time before it happens again, and potentially causes worse impact.</p> <p>Given the scale of the wordpress ecosystem, and the number of plugins, and execuable logic hidden throughout- there are many attack surface which attacks can take advantage of.</p> <p>By making the move to a 100% static website- This removes nearly all potentially expoitable methods. </p> <ol> <li>The web server itself, is nothing more then an unprivileged nginx serving http files. There is no php. No javascript. Nothing at all, besides html, css, and a few images.</li> <li>In the event somebody did manage to exploit nginx, it runs with zero privilages. It doesn't even have the ability to update its own files.<ol> <li>The file system is also COMPLETELY read-only.</li> <li>Somebody would need to exploit both a zero-day vulnerability against NGINX, as well as a zero-day privilege escalation against the underlying container, and finally, a container-escape elevation.</li> <li>Gaining access to the container itself, without going a container-escape, wouldn't help too much- as these containers are extremely locked down network-wise as well. They can access the internet, and they can respond to responses from the proxy server (for which you are reading this article through).</li> </ol> </li> <li>Lastly- since there is no database, no middletiers, etc... There is nothing to host!</li> </ol>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#performance","title":"Performance","text":"<p>A big factor, is performance and resources in general. This entire site can be cached into less than 100Mb of ram. (currently.... before I port over a lot of the old articles...)</p> <p>It requires basically no resources whatsoever to host. As such, spinning up multiple instances to load balance traffic, is effortless as well.</p> <p>Finally- since all of the content is completely static, it is all cachable upstream. As such, it is likely you are reading a cached copy right now.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#reliability","title":"Reliability","text":"<p>While- I have not had any notable reliability issues with https://XtremeOwnage.com/, since it currently resides on my network, on a single machine- any time I do network maintenance, or maintenance for that particular machine- my site will come offline. </p> <p>And- since wordpress is a very dynamic site, its content is not suitable for offline cache. </p> <p>However- in the future, this website can be easily hosted by either CloudFlare Pages or Github Pages for basically free.</p> <p>Until then however- I have multiple copies distributed amongsty my Kubernetes cluster to keep everything online.</p> <p>Correction- This website is hosted by CloudFlare Pages.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#other-reasons","title":"Other reasons?","text":"","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#privacy","title":"Privacy","text":"<p>As my wordpress has lots of random scripts, addons, and plugins running- Privacy is a concern to me. I don't know which of the external resources may be leaking your data.</p> <p>With this site- there are very, very few external resources loaded, which limits the amount of potential exposure.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#usability","title":"Usability","text":"<p>As a developer, I tend to write markdown quite frequently. Since- I can write these posts in markdown- It feels easy to me. I don't have to mess around with Wordpress's slow editor... It's basically second nature to me to create markdown.</p> <p>So, for me personally, Its much easier to create content.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2022/static-site/#closing-notes","title":"Closing Notes","text":"<p>You can expect a lot of my old content to continue to be ported over into this new static site. </p> <p>One notable thing missing, is the ability to subscribe to new posts. If you want to be notified when a new post is available, I would recommend subscribing to this site's RSS FEED in your favorite feeder.</p> <p>If you do find my content useful- let me know on Reddit, Discord, Facebook, etc.... Links are at the top of the page, left of the search box.</p>","tags":["Kubernetes","Homelab"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/","title":"Kubernetes - Edit Files inside of Containers","text":"<p>This is a short post- documenting a few ways on how you can modify contents of files inside of a container's storage mounts.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#1-using-kubectl-exec-with-editors-like-vi-or-nano","title":"1. Using <code>kubectl exec</code> with editors like <code>vi</code> or <code>nano</code>","text":"<p>The most straightforward way is to exec into the container and use a text editor.</p> <pre><code>kubectl exec -it -n &lt;namespace&gt; &lt;pod_name&gt; -- /bin/sh\n\n# Once inside the container\nvi /path/to/your/file\n</code></pre> <p>Replace <code>&lt;namespace&gt;</code> with your pod's namespace, <code>&lt;pod_name&gt;</code> with your pod's name, and <code>/path/to/your/file</code> with the file you want to edit.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#2-using-kubectl-cp-to-copy-files","title":"2. Using <code>kubectl cp</code> to copy files","text":"<p>You can copy files between your local machine and the container using <code>kubectl cp</code>.</p> <pre><code># Copy file from local to container\nkubectl cp /local/path/to/file -n &lt;namespace&gt; &lt;pod_name&gt;:/container/path/to/file\n\n# Copy file from container to local\nkubectl cp -n &lt;namespace&gt; &lt;pod_name&gt;:/container/path/to/file /local/path/to/file\n</code></pre> <p>Replace <code>&lt;namespace&gt;</code> with your pod's namespace, <code>&lt;pod_name&gt;</code> with your pod's name, <code>/local/path/to/file</code> with the local file path, and <code>/container/path/to/file</code> with the container file path.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#3-browsing-to-the-mount-point-on-the-kubernetes-host","title":"3. Browsing to the mount point on the Kubernetes host","text":"<p>If you know the mount point, you can access it directly on the Kubernetes host.</p> <ol> <li>Locate the mount point:</li> <li>Identify the node where the pod is running: <code>kubectl get pod &lt;pod_name&gt; -o wide</code></li> <li>SSH into the node: <code>ssh user@node_ip</code></li> <li> <p>Find the mount point using: <code>findmnt | grep &lt;pod_name&gt;</code></p> </li> <li> <p>Edit the file on the mount point using a text editor.</p> </li> </ol>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#4-using-a-side-car-container-with-a-web-based-editor","title":"4. Using a Side-Car Container with a Web-Based Editor","text":"<p>Update your existing deployment/statefulset/daemonset by adding a side-car container running <code>Filebrowser</code>. Use a random, non-common port to avoid conflicts with other containers in the pod. Also, mount the storage in the expected location by the Filebrowser container.</p> <p>Add the following under the <code>containers</code> key and define the volume mounts:</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: your-deployment\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: your-app\n  template:\n    metadata:\n      labels:\n        app: your-app\n    spec:\n      containers:\n      # This is your EXISTING application.\n      - name: your-app-container\n        image: your-app-image\n        volumeMounts:\n        - mountPath: /data # Path in the app container\n          name: shared-storage\n\n      # This is the new filebrowser container you need to add.\n      - name: filebrowser\n        image: filebrowser/filebrowser\n        ports:\n        - containerPort: 8081       # Use a random, non-common port\n          name: file-browser-http   # Descriptive name for the port\n        # Update these volume mounts, to mount the pod's storage into this file browser plugin.\n        volumeMounts:\n        - mountPath: /srv # Path expected by Filebrowser\n          name: shared-storage\n      volumes:\n      - name: shared-storage\n        persistentVolumeClaim:\n          claimName: your-pvc\n</code></pre>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#option-1-use-kubectl-port-forward","title":"Option 1: Use <code>kubectl port-forward</code>","text":"<p>This method is ideal for temporary access to the Filebrowser.</p> <p>Create a script to forward the port and echo the access URL:</p> <pre><code>#!/bin/bash\n\nNAMESPACE=&lt;namespace&gt;\nPOD_NAME=&lt;pod_name&gt;\nCONTAINER_PORT=8081 # This should match the containerPort defined in the deployment\nFORWARD_PORT=8080 # The port to open on the host\n\nHOST_IP=$(hostname -I | awk '{print $1}')\nkubectl port-forward -n $NAMESPACE $POD_NAME $FORWARD_PORT:$CONTAINER_PORT --address 0.0.0.0 &amp;\necho \"Access Filebrowser at http://$HOST_IP:$FORWARD_PORT\"\n</code></pre>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#option-2-create-a-service-and-ingress","title":"Option 2: Create a Service and Ingress","text":"<p>This method is more permanent and suitable for regular access.</p> <p>Create a service to expose the Filebrowser:</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: filebrowser-service\n  namespace: your-existing-namespace        # Set this to the namespace of your pod.\nspec:\n  selector:\n    app: your-app                           # Change this to match the labels from your application.\n  ports:\n    - protocol: TCP\n      port: 80          \n      targetPort: file-browser-http         # We are referencing the file browser's port, by its name.\n</code></pre> <p>Create an ingress to access the Filebrowser:</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: filebrowser-ingress\n  namespace: your-existing-namespace        # Set this to the namespace of your pod.\nspec:\n  rules:\n  - host: filebrowser.yourdomain.com        # Update this to your desired host you wish to access the file browser on.\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: filebrowser-service\n            port:\n              name: file-browser-http # Reference the port by its name\n</code></pre>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#use-cases","title":"Use-Cases","text":"<ul> <li>Option 1 (Port-Forwarding): Ideal for temporary access during development or troubleshooting. The script sets up port forwarding and provides a URL for quick access.</li> <li>Option 2 (Service and Ingress): Suitable for more permanent access, allowing users to access the Filebrowser via a defined domain and service within the Kubernetes cluster.</li> </ul>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#5-if-using-nfs-storage","title":"5. If using NFS storage","text":"<p>Mount the NFS storage on another system and make changes directly.</p> <pre><code># On another system\nmount -t nfs &lt;nfs_server&gt;:/exported/path /mnt\nvi /mnt/path/to/file\n</code></pre>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/kubernetes---edit-files-in-containers/#6-if-using-iscsi","title":"6. If using ISCSI","text":"<p>Stop the deployment or stateful set, then mount the ISCSI volume on another system.</p> <ol> <li> <p>Stop the deployment:    <pre><code>kubectl scale deploy &lt;deployment_name&gt; --replicas=0\n</code></pre></p> </li> <li> <p>Mount the ISCSI volume on another system:    <pre><code>iscsiadm -m discovery -t sendtargets -p &lt;iscsi_target_ip&gt;\niscsiadm -m node --login\nmount /dev/&lt;iscsi_device&gt; /mnt\nvi /mnt/path/to/file\n</code></pre></p> </li> </ol>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/","title":"How to upgrade Rancher + K3s","text":"<p>This post outlines the steps needed to upgrade rancher + k3s.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#step-1-establish-a-back-out-plan","title":"Step 1. Establish a back out plan.","text":"","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#take-snapshots-of-servers-if-virtual","title":"Take snapshots of servers (If Virtual)","text":"<p>Danger</p> <p>Don't skip this step. If something goes wrong- reverting to snapshots will save you a ton of time.</p> <p>Visit your hypervisor- and take snapshots of Rancher, and your Master Server(s).</p> <p></p> <p>Warn</p> <p>Make sure to snapshot BOTH master servers, AND rancher.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#verify-backups","title":"Verify backups.","text":"<p>Verify you do have current backups of both rancher, and your master servers.</p> <p></p> <p>I personally went ahead and kicked off a fresh backup, just in case.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#step-2-upgrade-rancher-assuming-docker-install","title":"Step 2. Upgrade rancher (Assuming docker install)","text":"<p>Danger</p> <p>Make SURE you have backups, and snapshots before upgrading rancher!!!!!</p> <p>Info</p> <p>This guide assumes, you are running rancher in docker, on a dedicated host.</p> <p>Rancher: How to upgrade docker-based install</p> <p>To upgrade rancher, I created THIS SCRIPT a while back, and it still meets my needs.</p> <p>It- is not a very fancy script, however, it has done the job for nearly two years now.</p> <p>When you run the script, it will copy all of the settings from the old container, to a new container, and download the latest version.</p> <p>upgrade-rancher.sh</p> <pre><code>root@rancher:~# ./upgrade-rancher\nCurrent containers:\nrancher\nCurrent container: rancher\nEnter the old container name (press Enter for default 'rancher'):\nEnter the new container name (press Enter for default 'rancher'): rancher-1\nOld container name: rancher\nNew container name: rancher-1\nAre you ready to proceed? (yes/no): yes\nrancher\nlatest: Pulling from rancher/rancher\n4090dd5519fe: Pull complete\nfbf3740af50e: Pull complete\n4f4fb700ef54: Pull complete\n94fd9502e569: Pull complete\n451dfc562e17: Pull complete\n6e583e29a207: Pull complete\ncc0a56ef82a2: Pull complete\n89cea98ebea0: Pull complete\n6148b58cef71: Pull complete\n7dfba7080371: Pull complete\n43424839d54c: Pull complete\n24b29490e7ed: Pull complete\n0c7566f78e63: Pull complete\na700d88b4142: Pull complete\nee4b1b5ca508: Pull complete\n75db2bb94dbc: Pull complete\nb0207ea527d7: Pull complete\naf222a29d613: Pull complete\n755323881e8e: Pull complete\n6aeab77af983: Pull complete\nDigest: sha256:5301612358bb16e81549880e29a73a1214d9e353c2a94fb719b2cf158640e887\nStatus: Downloaded newer image for rancher/rancher:latest\ndocker.io/rancher/rancher:latest\n8314650afefad0b7a858424ba2c21a4ab091f381fe7a89aff6868a7240de65f7\nPress Enter to remove the old container 'rancher'...\nRemoving the old container 'rancher'...\nrancher\nroot@rancher:~#\n</code></pre> <p>After running, we will need to wait a while for rancher to start up. You can monitor the progress using <code>docker logs rancher-1 -f</code> (just- replace with the name of your new rancher container.)</p> <pre><code>root@rancher:~# docker logs rancher-1 -f\nINFO: Running k3s server --cluster-init --cluster-reset\n2024/12/13 19:46:23 [INFO] Rancher version v2.10.0 (df45e368c82d4027410fa4700371982b9236b7c8) is starting\n2024/12/13 19:46:23 [INFO] Rancher arguments {ACMEDomains:[] AddLocal:true Embedded:false BindHost: HTTPListenPort:80 HTTPSListenPort:443 K8sMode:auto Debug:false Trace:false NoCACerts:false AuditLogPath:/var/log/auditlog/rancher-api-audit.log AuditLogMaxage:10 AuditLogMaxsize:100 AuditLogMaxbackup:10 AuditLevel:0 Features: ClusterRegistry:}\n2024/12/13 19:46:23 [INFO] Listening on /tmp/log.sock\n2024/12/13 19:46:23 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:25 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:27 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:29 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:31 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:33 [INFO] Waiting for server to become available: Get \"https://127.0.0.1:6444/version?timeout=15m0s\": dial tcp 127.0.0.1:6444: connect: connection refused\n2024/12/13 19:46:42 [INFO] Running in single server mode, will not peer connections\n2024/12/13 19:46:42 [INFO] Applying CRD features.management.cattle.io\n2024/12/13 19:46:58 [INFO] Creating embedded CRD clusterrepos.catalog.cattle.io\n2024/12/13 19:46:58 [INFO] Updating embedded CRD clusterrepos.catalog.cattle.io\n2024/12/13 19:46:58 [INFO] Updating embedded CRD clusterroletemplatebindings.management.cattle.io\n2024/12/13 19:46:58 [INFO] Updating embedded CRD globalroles.management.cattle.io\n2024/12/13 19:46:58 [INFO] Updating embedded CRD globalrolebindings.management.cattle.io\n2024/12/13 19:46:58 [INFO] Updating embedded CRD projects.management.cattle.io\n2024/12/13 19:46:59 [INFO] Updating embedded CRD projectroletemplatebindings.management.cattle.io\n2024/12/13 19:46:59 [INFO] Updating embedded CRD roletemplates.management.cattle.io\n2024/12/13 19:46:59 [INFO] Updating embedded CRD clusterproxyconfigs.management.cattle.io\n2024/12/13 19:46:59 [INFO] Updating embedded CRD uiplugins.catalog.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD navlinks.ui.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD podsecurityadmissionconfigurationtemplates.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD clusters.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD apiservices.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD clusterregistrationtokens.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD settings.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD preferences.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD features.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD operations.catalog.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD apps.catalog.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD fleetworkspaces.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD managedcharts.management.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD clusters.provisioning.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD clusters.provisioning.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD rkeclusters.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD rkecontrolplanes.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD rkebootstraps.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD rkebootstraptemplates.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD rkecontrolplanes.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD custommachines.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD etcdsnapshots.rke.cattle.io\n2024/12/13 19:46:59 [INFO] Applying CRD clusters.cluster.x-k8s.io\n2024/12/13 19:47:00 [INFO] Applying CRD machinedeployments.cluster.x-k8s.io\n2024/12/13 19:47:00 [INFO] Applying CRD machinehealthchecks.cluster.x-k8s.io\n2024/12/13 19:47:00 [INFO] Applying CRD machines.cluster.x-k8s.io\n2024/12/13 19:47:00 [INFO] Applying CRD machinesets.cluster.x-k8s.io\n....\n</code></pre> <p>As a note, you will likely see a ton of errors.... AFAIK, this is somewhat normal....</p> <p></p> <p>Also- you will not see a log which indicates its ready. But- the number of errors scrolling by will decrease.</p> <p></p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#error-file-exists","title":"Error: \"File Exists\"","text":"<p>If- you notice errors like this:</p> <pre><code>2024/12/13 19:47:26 [ERROR] error syncing 'partner-extensions': handler helm-clusterrepo-ensure: ensure failure: git -C management-state/git-repo/partner-extensions/3ff55af926408daaca3b5bedc48d479d95cae4f43ade3df4a8c9dc7e65732db1 reset --hard FETCH_HEAD error: exit status 1, detail: error: update_ref failed for ref 'HEAD': cannot lock ref 'HEAD': Unable to create '/var/lib/rancher/management-state/git-repo/partner-extensions/3ff55af926408daaca3b5bedc48d479d95cae4f43ade3df4a8c9dc7e65732db1/.git/HEAD.lock': File exists.\n</code></pre> <p>There- are dozens of tickets open on the issue- yet, it still exists... I have a script which can clean up locks.</p> <p>remove-locks.sh</p> <pre><code>root@rancher:~# ./remove-locks\nOnly one container found: rancher. Do you want to proceed? (y/n): y\nsh: line 1: ps: command not found\nRemoved lock file: /var/lib/rancher/management-state/git-repo/rancher/4b40cac650031b74776e87c1a726b0484d0877c3ec137da0872547ff9b73a721/.git/objects/maintenance.lock\nRemoved lock file: /var/lib/rancher/management-state/git-repo/rancher/4b40cac650031b74776e87c1a726b0484d0877c3ec137da0872547ff9b73a721/.git/index.lock\nRemoved lock file: /var/lib/rancher/management-state/git-repo/rancher-ui-plugins/7f344bdf57f2a834863d74b13cf2f7f6f263870470794cc5902e6a7114600d83/.git/index.lock\nRemoved lock file: /var/lib/rancher/management-state/git-repo/partner-extensions/3ff55af926408daaca3b5bedc48d479d95cae4f43ade3df4a8c9dc7e65732db1/.git/HEAD.lock\nRemoved lock file: /var/lib/rancher/management-state/git-repo/partner-extensions/3ff55af926408daaca3b5bedc48d479d95cae4f43ade3df4a8c9dc7e65732db1/.git/refs/heads/main.lock\nRemoved lock file: /var/lib/rancher-data/local-catalogs/v2/rancher-rke2-charts/675f1b63a0a83905972dcab2794479ed599a6f41b86cd6193d69472d0fa889c9/.git/index.lock\nRemoved lock file: /var/lib/rancher-data/local-catalogs/v2/rancher-charts/4b40cac650031b74776e87c1a726b0484d0877c3ec137da0872547ff9b73a721/.git/index.lock\nRemoved lock file: /var/lib/rancher-data/local-catalogs/v2/rancher-partner-charts/8f17acdce9bffd6e05a58a3798840e408c4ea71783381ecd2e9af30baad65974/.git/index.lock\n</code></pre>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#finishing-up","title":"Finishing up...","text":"<p>After a while, the rancher interface should start responding. Once you reach this step- we are done upgrading rancher.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#upgrade-kubernetes","title":"Upgrade Kubernetes","text":"<p>After rancher has been upgraded- it is time to upgrade kubernetes. This will be executed via rancher.</p> <p>Inside rancher, goto the cluster management screen. Then we want to \"Edit Config\" for the cluster being upgraded.</p> <p></p> <p>On the next screen, you will have a dropdown showing the current version, and allowing you to select the version you wish to migrate to.</p> <p></p> <p>For this guide- I will be jumping ahead multiple major versions, going from version 1.28.9, up to 1.31.2</p> <p>Danger</p> <p>Yet again, MAKE SURE YOU HAVE BACKUPS!!!!!!!!!!!!!!</p> <p>I cannot stress this enough.</p> <p>After, choosing your desired version, click save in the bottom right.</p> <p>You may see this warning popup as well. Validate your addons still have the expected configuration.</p> <p></p> <p>After saving- the cluster should start bootstrapping itself, and will go through the upgrade process.</p> <p></p> <p>You can click on the cluster, and look at the machines tab to have a high-level overview of the current progress.</p> <p>This- will give a brief summary of which machines are updating.</p> <p></p> <p>If, you want more indepth logs, select \"Provisioning log\"</p> <p></p> <p>At this point, we are just waiting on everything to finish, and show green. This process took oh, around 5 minutes for me.</p> <p></p> <p></p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2024/rancher--k3s-how-to-upgrade/#next-steps","title":"Next steps?","text":"<p>Assuming your cluster successfully upgraded- now is a good time to go through and ensure all of your charts, and workloads are updated.</p> <p>I find a tool such as k9s is also handy for identifying any potential issues.</p> <p>Thats it for this guide.</p>","tags":["Kubernetes","Homelab","Kubernetes/General"]},{"location":"blog/2025/the-hoodcat-chronicles/","title":"The Hoodcat Chronicles","text":"<p>This- is the tale of hood-cat. The cat who decided to break into my house, assert dominance over my cat, pee on my chair, and make himself at home.</p> <p></p>"},{"location":"blog/2025/the-hoodcat-chronicles/#thursday","title":"Thursday","text":"<p>Thursday morning, my wife wakes me up frantic that her cat, Leia, is missing.</p> <p>The door between the kitchen and garage was open, along with the garage door open.</p> <p>Clumps of Leia's fur, were found all throughout the kitchen. </p> <p>When we went into the garage looking for the cat, an unknown orange cat was sitting on the freezer in the garage, and quickly left.</p> <p>After searching high and low, I finally located Leia who was cowering under the freezer.</p> <p></p> <p>Investigation of Leia, identified she had a wound on her rear-right leg, causing a minor limp.</p> <p>So.... What happened?</p> <p>Well, at this point, I decided to pull up the security camera footage.</p> <p>For- those who read this blog- you may have noticed my FADD / Cat Taser post in the past. Due to this project- I have cameras watching areas where we want to limit... cat movement. </p>"},{"location":"blog/2025/the-hoodcat-chronicles/#early-morning","title":"Early Morning","text":"<p>So, the first thing I noticed, was Luke (My dumbass cat) decided to come into the house as well, shortly after I went to sleep around midnight.</p> <p></p> <p>Luke, was converted to an outside kitty, after demonstrating... to not be very responsible. He would get the zoomies at nighttime, and literally jump and crawl on EVERYTHING in sight. His guilt every morning would instantly give away, he did something he shouldn't have. So- he became an outside cat.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#0400","title":"0400","text":"<p>Around 0411, Leia was spotted outside of the garage.</p> <p></p> <p>At 0418, Hoodcat can be seen sneaking into the garage.</p> <p></p>"},{"location":"blog/2025/the-hoodcat-chronicles/#0430","title":"0430","text":"<p>At 0430, Hoodcat was detected by indoor cameras.</p> <p></p> <p>Now- while I don't have every inch of the house covered in cameras, I did have enough footage to determine what was happening.</p> <p>Shortly after making his appearance, Hoodcat was seen trying to get under my chair. The importance here- That is one of Leia's hiding spots.</p> <p></p> <p>He then, proceeded to look at, and smell everything. Climbing on top of the furniture, the kitchen. etc.</p> <p></p> <p>After, he sat in Leia's favorite spot- she did not like this, and a standoff ensued.</p> <p></p> <p>After, 5 minutes of intense glaring, growing, and aggressive tail-swatting..... Hoodcat leaped.</p> <p></p> <p>Leia, being an indoor cat, since being rescued as a kitten, and having no combat experience, took the decision to run and hide.</p> <p>They disappeared into the Kitchen area, where I do not have adequate coverage to determine exactly what happen.</p> <p>However, I did notice Luke was watching, and cowering.</p> <p></p> <p>For, the next hour, he remained hidden, often peeking around objects, but, not allowing his presence to be seen.</p> <p></p> <p>Occasionally, he would peek around the corner to look, but, would go cower back behind cover. </p> <p>Despite having lived here in the family, he provided zero support to Leia while defending the territory. He instead, cowered while hoodcat deemed this territory as his. </p>"},{"location":"blog/2025/the-hoodcat-chronicles/#0600","title":"0600","text":"<p>Around 0600, we woke up, at which point they were in the garage. </p> <p>Hoodcat gracefully walked out of the garage at 0605 when the sound of people was heard.</p> <p></p> <p>This- leads back to the earlier story- of my wife waking me, and finding the cat cowering under the freezer as hoodcat asserted dominance on top of the freezer.</p> <p></p> <p>Further investigation yielded Hoodcat had marked my garage, and my chair, with his atrocious scent.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#the-plan","title":"The Plan","text":"<p>At this point, Hoodcat had racked up multiple charges.</p> <ol> <li>Breaking and entering.</li> <li>Assault.</li> <li>Kidnapping.</li> <li>Vandalism.</li> </ol> <p>Indeed, this would not be allowed to slide. So, I needed to formulate a plan to ensure hoodcat was brought to the proper authorities.</p> <p>I decided to build a trap for hoodcat. After taking inventory of options- I was left with a dog crate, some scrap metal, zip-ties, and ratchet straps.</p> <p>So, I built a trap.</p> <p></p> <p>The principal is simple. Unbalanced pieces of wood holds the weight of a 20lb barbell.</p> <p>Stepping onto the mat, where the food is located, pulls a piece of wire connected to the unbalanced wood.</p> <p>Unbalanced wood topples, which causes the weight to fall.</p> <p>The weight is connected to the door via a ratchet strap.</p> <p>Pieces of metal are behind the door, this is to help absorb the force of the door slamming to avoid deforming the kennel.</p> <p>Zero permanent modifications were performed. This is all zip-ties.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#thursday-night","title":"Thursday Night","text":"<p>So, while digging through footage watching the trap, I noticed something interesting.</p> <p></p> <p>Notice- there are two pieces of meat.</p> <p>And... then there was one.</p> <p></p> <p>What happened??!? Did the trap not work?</p> <p>After digging through the footage, I found a Possum put her head in the door, grabbed the piece of meat, and left. The lack of greed, saved this possum from capture.</p> <p></p> <p>At 1000, I noticed my dumbass cat, Luke, trying to get the meat.</p> <p></p> <p>In his infinite wisdom, he also decided to jump on top of the trap, which of course, triggered it to close.</p> <p></p> <p>I called him to the door, and put him somewhere more secure for the night to keep him from being captured.</p> <p>Afterwards, I had to reset the trap mechanism.</p> <p>At 11:54pm, Hoodcat showed up, curious about the smell of fresh turkey.</p> <p></p> <p>Interestingly, he laid near the cage for about 10 minutes.</p> <p></p> <p>And, then another cat showed up. I'm going to refer to this cat as Lackey.</p> <p>Hoodcat watched as lackey investigated the trap, and eventually became trapped inside.</p> <p></p> <p>Hoodcat watched for a couple of minutes, until walking away, leaving Lackey trapped.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#friday-early-morning","title":"Friday Early Morning","text":"<p>After a while had passed, Hoodcat did return to try and save his comrade.</p> <p></p> <p>However, the trap door would not budge. He again left, which left Lackey sad and lonely. She kept look hoping he would return to save her. But, he never came.</p> <p></p> <p>Lackey DID attempt to escape, multiple times. And even practiced flying aerobics, but to no avail.</p> <p></p> <p>She even practiced for a career in tight-rope walking.</p> <p></p> <p>0430 on Friday morning, heavy thunderstorms came through the area, which terrified lackey.</p> <p></p> <p>These storms also woke me up, at which point I provided additional shelter to Lackey.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#morning","title":"Morning","text":"<p>That morning I went to interview Lackey to attempt to determine the hiding location of hoodcat.</p> <p>Lacky, was visibly shaken from the storms this morning. </p> <p></p>"},{"location":"blog/2025/the-hoodcat-chronicles/#lackeys-interrogation","title":"Lackey's Interrogation","text":"<p>No time was wasted interrogating Lackey to find Hoodcat's hidden lair.</p> <p>However, Lackey became silent when questioned on the whereabouts of hoodcat.</p> <p>A few hours later, Lackey was turned over to the local authorities.</p> <p>As of right now Lackey is pending adoption, with high chances of being adopted. </p> <p>Lackey was checked for a chip, and provided proper vaccinations.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#friday-night","title":"Friday Night","text":"<p>Around 10pm on Friday night, Hoodcat made his appearance again. However, the trap did not properly trigger, leaving him free to leave.</p> <p></p> <p>Around 10:30pm, I reset the trap, and rebaited it.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#saturday","title":"Saturday","text":""},{"location":"blog/2025/the-hoodcat-chronicles/#early-morning_1","title":"Early Morning","text":"<p>Shortly after midnight, another cat had become trapped.</p> <p>Was it hoodcat? No. It was just my dumbass cat again.</p> <p></p> <p>Lucky for him, My wife woke up and checked the cameras around 4am, and let him out before heavy storms again hit the area.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#saturday-night","title":"Saturday Night","text":"<p>Well, Saturday night around 11:30pm, Hoodcat showed up. </p> <p>However, this time, the trap was ready for him.</p> <p>Without a hitch, hoodcat had been captured.</p> <p>Once captured, Hoodcat did not make a noise. Not even a single meow for help.</p> <p></p> <p>As it was 11:30 at night, Hoodcat's holding cell was relocated to the garage, until the correct authorities could be contacted in the morning. Food and water were provided.</p>"},{"location":"blog/2025/the-hoodcat-chronicles/#sunday","title":"Sunday","text":"<p>After further investigation of hoodcat, it was determined he was not a domesticated cat.</p> <p>Not a single meow was given. Only a growl.</p> <p>Initially, the plan was to turn hoodcat over to animal control. However, this would have indeed mean hoodcat would have likely been euthanized after a few weeks. </p> <p>After careful deliberation, it was determined hoodcat would go live out the rest of his days as a farm cat, on a farm in a remote area.</p> <p>His transport was arranged Sunday, and upon arriving to the location, a feeding area was provided.</p> <p>As soon as his carrier was opened, he sniffed the food, and shot off into the fields.</p> <p>I would imagine, after 5 or 10 minutes worth of running, and seeing nothing but empty fields- He realized the gravity of his situation, and eventually returned to the location where food and water were provided.</p> <p>While, hoodcat will not have the happiest ending, this does ensure he has the power to make his own ending rather then a game over provided to him after he would eventually fail to be re-homed.</p> <p>As for Leia, her injuries quickly healed.</p> <p></p> <p>She was nicely affected by the incident for a few days, however, she is completely back to normal now.</p> <p>The end.</p>"},{"location":"blog/2024/building-a-shop-table---part-1/","title":"Shop Table - Part 1","text":"<p>Part one of my shop-table project. This occurred in Oct 2024.</p> <p>Here is the end result. A simple, sturdy table.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#introduction","title":"Introduction","text":"","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#auctions","title":"Auctions","text":"<p>Occasionally I enjoy going to property auctions. I can generally pick up a good amount of scrap metal, tools, and parts for a reasonable price.</p> <p>One of these auctions, was a farm, where I obtained a decent trailer full of metal scrap, and a few tools.</p> <p></p> <p>There WAS a table auctioned off at the site, however, when its bidding price went above 600$, I stopped bidding. The table was bigger then I was looking for, and required... a forklift to be moved.</p> <p></p> <p>However, I did leave with a healthy assortment of angle-iron, and flat plate.</p> <p></p> <p>Here is another view of some of the materials I collected from this auction.</p> <p></p> <p>I did also pick up a solid steel I-beam for 15$.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#the-goal","title":"The Goal","text":"<p>With the auction details out of the way- My goal was simple. I wanted to build a table for my shop.</p> <p>The requirements-</p> <ol> <li>Must be sized as to not take up my entire shop floor. My shop, is the 2-car garage on my house.</li> <li>Must be sturdy. Needs to be able to withstand at least a half-ton of weight.</li> <li>Must tolerate hammering and beating. This table will be used.</li> </ol> <p>While- I planned on getting a piece of steel sheet for the top of my table, the bidding went above what I was willing to pay.</p> <p>Through, after taking inventory, I did feel, I had plenty of materials laying around to build a table.</p> <p>So- thats what I did.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#tools-used","title":"Tools Used","text":"<p>I'm not going to go into super-depth regarding all of the tools used, however, I will list out the big items.</p> <ol> <li>AHP AlphaTig: Amazon<ul> <li>I have the 2017 AlphaTig model. After 7 years of owning it, I still really enjoy this machine.</li> <li>I use it for Tig and Stick from 20 amps, up to 200 amps. Zero complaints.</li> <li>There have been a lot of improvements since my 2017 model, I'd highly recommend one of these units.</li> <li>The price/features is hard to beat.</li> </ul> </li> <li>Dewalt 14in Chop Saw: Amazon<ul> <li>I couldn't tell you what year I picked up my chop-saw, but, it was pre-2017.</li> <li>It works just as well now, as it did nearly a decade ago.</li> <li>I have cut angle-iron, 3\" structural tubing, bars of aluminum. You name it. It does it.</li> <li>For blades, I typically use 14\" Abrasive Disks - Amazon<ul> <li>These are cheap, and effective.</li> <li>I do have a carbide blade for cutting metal, however... It did not last too long.</li> </ul> </li> </ul> </li> <li>Primeweld CUT50D: Amazon<ul> <li>I picked this up in April of 2020. At the time, this was one of the cheapest available plasma cutters available.</li> <li>I'll admit- My expectations were not very high for this unit. However, I have owned it for 5 years, and it has logged hundreds of hours, without any issues or faults.</li> <li>The current units, have a lot more options. Mine only has a single physical knob for amperage.</li> <li>I did recently (2025) swap out the torch head, for a PT31 - Amazon. I did this, because the consumables are cheaper, and easier to acquire.</li> </ul> </li> <li>Dewalt Angle Grinder: Amazon<ul> <li>I have been using this angle grinder for the best part of the last decade. The handle finally broke off, to which I just created a single handle made from square tube. Its still kicking.</li> </ul> </li> <li>Flap Disks: Amazon<ul> <li>I have found these cheap flap disks, to be amazing when working with metal.</li> <li>I use a combination of 40 grit, and 120 grit disks. 40 grit when doing heavy shaping, or grinding. 120 grit for making it look pretty.</li> </ul> </li> <li>Rust-Oleum 215215: Amazon<ul> <li>I have been using this spray paint for many of my steel based projects.</li> <li>Works great for minor surface rust. You will want to grind and remove any heavy rust though.</li> </ul> </li> </ol>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#building-the-table","title":"Building the table","text":"<p>I started this, by cutting the steel plate into three sections to get my desired length and width.</p> <p></p> <p>Since, I knew I had quite a few of these cuts to do, and drawing straight lines is hard, I did fabricate a small.... \"guide\" for my tig torch.</p> <p></p> <p>More or less, you put the torch in, and slide it against a board or piece of metal. And, you get a straight cut.</p> <p></p> <p>With, the plate cut, I started building a frame using 1/4\" angle-iron.</p> <p></p> <p>One important detail here- I intended on the flat side of the angle iron to be on the OUTSIDE of the table.</p> <p>The reason- It makes it much easier to use clamps on the outside perimeter of the table.</p> <p>For cutting the angle-iron, I used my chop-saw.</p> <p></p> <p>I did, trim the edges with my torch.</p> <p>After this was done, I cut a few pieces of angle-iron to make ribs across the middle.</p> <p></p> <p>Here is a close-up picture of how the edges will be aligned. Nothing has been welded at this point. </p> <p></p> <p>With everything cut, at this point, I started welding all of the seams... My welds here, are less then ideal.</p> <p></p> <p>Warn</p> <p>I did- make a critical mistake during this process. </p> <p>I did not control my heat, which allowed one of the pieces of plate to warp slightly.</p> <p>Most of the welding was done using 6011/7018 welding electrodes.</p> <p>For the legs, I used 2 3/8 drill-string. </p> <p></p> <p>And, after a bit of leveling, measuring, clamping and welding... I had all four legs attached.</p> <p></p> <p>After the welding was done, I used flap-disks and my angle-grinder to smooth out the welds, and remove any remaining rust. I then added a coat of rustoleam rust-reformer primer.</p> <p></p> <p>And.... after a day of work, I had a functional table.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2024/building-a-shop-table---part-1/#next-steps","title":"Next Steps?","text":"<p>Since- its 2025 now, and I finally just wrote this post... You can skip to Part 2 where I added wheels and some tooling mounts.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/","title":"Shop Table - Part 2 - Wheels &amp; Tool Mounts","text":"<p>In Part 1, I built a solid steel shop table from plate and angle-iron.</p> <p>This- was the end result. A simple, solid table.</p> <p></p> <p>Well, Today, I added a few... changes to this table. I added wheels, and solid tool mounts.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#introduction","title":"Introduction","text":"<p>The table has proved itself quite handy. I have used it for everything from building the DIN-rack for my networking closet, all the way up to building a press from an steel I-beam..</p> <p>However, I really wish it was easier to move. Due, to its weight, its not exactly portable.</p> <p>After stewing on the idea for months, I finally decided to do a few upgrades.</p> <p>With, a positive recommendation from a friend, I decided to use these Ratcheting Casters</p> <p>I decided on these, because they are pretty easy to level the table when needed, and because when leveled, the table will not be resting on the wheels, allowing me to work on heavy projects without the table moving around.</p> <p>I ALSO went ahead and added a mounting system for my Vise, Anvil, and Bench Grinder. To do this, I used a simple bumper hitch receiver from Harbor Freight..</p> <p>At a cost of 15-20$, these met the need. To achieve a 3/4 ton rating, these must be able to endure quite a bit more force before deforming. So, there should be zero issues with strength.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#tools-used","title":"Tools Used","text":"<p>I'm not going to go into super-depth regarding all of the tools used, however, I will list out the big items.</p> <ol> <li>AHP AlphaTig: Amazon<ul> <li>I have the 2017 AlphaTig model. After 7 years of owning it, I still really enjoy this machine.</li> <li>I use it for Tig and Stick from 20 amps, up to 200 amps. Zero complaints.</li> <li>There have been a lot of improvements since my 2017 model, I'd highly recommend one of these units.</li> <li>The price/features is hard to beat.</li> </ul> </li> <li>Dewalt 14in Chop Saw: Amazon<ul> <li>I couldn't tell you what year I picked up my chop-saw, but, it was pre-2017.</li> <li>It works just as well now, as it did nearly a decade ago.</li> <li>I have cut angle-iron, 3\" structural tubing, bars of aluminum. You name it. It does it.</li> <li>For blades, I typically use 14\" Abrasive Disks - Amazon<ul> <li>These are cheap, and effective.</li> <li>I do have a carbide blade for cutting metal, however... It did not last too long.</li> </ul> </li> </ul> </li> <li>Primeweld CUT50D: Amazon<ul> <li>I picked this up in April of 2020. At the time, this was one of the cheapest available plasma cutters available.</li> <li>I'll admit- My expectations were not very high for this unit. However, I have owned it for 5 years, and it has logged hundreds of hours, without any issues or faults.</li> <li>The current units, have a lot more options. Mine only has a single physical knob for amperage.</li> <li>I did recently (2025) swap out the torch head, for a PT31 - Amazon. I did this, because the consumables are cheaper, and easier to acquire.</li> </ul> </li> <li>Dewalt Angle Grinder: Amazon<ul> <li>I have been using this angle grinder for the best part of the last decade. The handle finally broke off, to which I just created a single handle made from square tube. Its still kicking.</li> </ul> </li> <li>Flap Disks: Amazon<ul> <li>I have found these cheap flap disks, to be amazing when working with metal.</li> <li>I use a combination of 40 grit, and 120 grit disks. 40 grit when doing heavy shaping, or grinding. 120 grit for making it look pretty.</li> </ul> </li> <li>Rust-Oleum 215215: Amazon<ul> <li>I have been using this spray paint for many of my steel based projects.</li> <li>Works great for minor surface rust. You will want to grind and remove any heavy rust though.</li> </ul> </li> <li>Metal Marker: Amazon<ul> <li>This works well for writing on metal, even nasty rusty metal.</li> </ul> </li> <li>Spring Loaded Center Punch: Amazon<ul> <li>I ordered this March 2018. It still works very well.</li> <li>For the price paid, I have zero complaints.</li> </ul> </li> </ol>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adding-casters","title":"Adding casters","text":"<p>First, I needed to cut some plate to bolt the feet to. I dug a piece of steel plate out of the mud, and used it.</p> <p></p> <p>I used my flap disks to remove the rust from the plate, and then traced the outline of the castors using a paint marker.</p> <p></p> <p>With, the plate cleaned up, I used my homemade plasma guide to start cutting each of the pieces out.</p> <p></p> <p></p> <p>And, after a while.... I had 4 flaming hot steel pads ready to go.</p> <p></p> <p>Not pictured- I used my spring-loaded center punch to mark where I needed to drill the holes to mount the feet.</p> <p>After marking each of the plates, I brought them over to the drill press and started drilling out the holes.</p> <p></p> <p>Note- the oil can. Keep your drill bits cool and lubricated, and they will last a lot longer.</p> <p>Next, I welded the feet onto the table. E-7018 was used here.</p> <p></p> <p>And.... kept welding.... until all four pads were securely attached.</p> <p></p> <p>There SHOULD be a finished image here, However, I originally did not plan on writing a blog post for upgrades to my shop table, or even building the shop table.</p> <p>But- its wet and rainy outside, and I felt it would be a good time to catch up on writing some of my blog posts. </p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adding-vertical-tool-mount","title":"Adding Vertical Tool Mount","text":"<p>As noted in the introduction, I picked up a pair of bumper hitch receivers which I planned on using as tool mounts.</p> <p>Sadly, I did a very horrible job of taking pictures to document this.</p> <p>First- I used flap disks to knock off the layer of surface rust which had accumulated on the top of the table.</p> <p>Then- I measured a section for the hitch, and cut it out using the plasma torch.</p> <p>Here is a photo showing the hitch test-fitted. </p> <p></p> <p>The piece of rusty tube here was used to level the mount. </p> <p>The table was completely leveled earlier (not pictured), and then I added the piece of square tube, and leveled it, to ensure the mount was completely level.</p> <p>Next, I welded the hitch into plate.</p> <p></p> <p>As a note, you can see two of my magnetic levels in this photo. I have a total of four of these.</p> <p>These are Empire EM71.8 True Blue Magnetic Levels. I originally discovered these at home depot, and became a huge fan of them.</p> <p>The hammer seen, is a 2lb Crescent Engineer Hammer. I picked this up at home depot. It has quickly became one of my favorite hammers around the shop.</p> <p>Finally, after a bit more grinding and sanding, I added a thin coat of paint.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adapting-vise-to-vertical-mount","title":"Adapting vise to vertical mount","text":"<p>The first tool I planned to adapt, was a new/old vise I had picked up from an old building we were cleaning out.</p> <p>I needed to get it cleaned up, and get a base plate fabricated which would adapt it to the new mount.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#cleaning-the-vise","title":"Cleaning the Vise","text":"<p>The first step, I actually needed to clean the vise. It was pulled out of a old building which was falling apart, and was covered in dirt, grease, grime, etc.</p> <p>Sadly- I did not have a before picture... but, I will note, I had no idea it was blue. That is how dirty it was.</p> <p>So- I used my pressure washer to blast most of the grime off.</p> <p></p> <p>I then decided to fully disassemble the vise, clean it out, and re-grease it.</p> <p></p> <p>One interesting feature about this vise- It had a hardened steel \"top\" running full length.</p> <p>This- feature will come in quite handy for a few of my projects.</p> <p></p> <p>After fully disassembling, everything was again pressure washed, and left to dry in the sun.</p> <p></p> <p></p> <p>I did, find the bolt which holds the vise nut in plate, was compromised/broken. I replaced this with a new grade 8 bolt.</p> <p></p> <p>One last thing not pictured- I used some fine-grit sand paper to lightly sand the rust from the hardened surfaces of the vise. After knocking up the surface rust, I coated everything with light oil to prevent it from rusting in the future.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#fabricating-a-vise-mount","title":"Fabricating a vise mount","text":"<p>To make the base plate, I used the same rusty piece of plate I pulled out the mud earlier that day. I traced an outline of the vises base onto it using the paint marker.</p> <p></p> <p>Next, I used my plasma cutter to cut the plate.</p> <p></p> <p>Afterwards, I did a bit of basic grinding and smoothing, and put the vise's base onto the plate.</p> <p></p> <p>Not pictured- I used my spring-loaded center punch to mark where I needed to drill the holes.</p> <p>Since.... the plate did not exactly fit the cross-slide vise on my drill press, I used clamps to hold it onto a piece of wood while drilling. Again, make sure to keep those drill bits lubed up!</p> <p></p> <p>With the plate drilled, I test-fitted a piece of square tubing, and slide it into the table mount.</p> <p></p> <p>And, a quick test fit.</p> <p> </p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#finishing-the-vise-mount","title":"Finishing the Vise Mount","text":"<p>Next up, I ran a weld around the inside of the plate to join the base to the square tubing</p> <p></p> <p>I DID need the vise to sit flush on top of the table. While, two of the nuts/bolts wouldn't interfere, the third would. </p> <p></p> <p>To, work around this, I decided to weld studs into the plate to ensure there would not be interference.</p> <p>After... a quick trip the the hardware store, I picked up new grade 5 nuts and bolts. </p> <p>I then, cut the head off of the bolts, leaving just a threaded insert. I used a 3 1/2\" cutting disk with my pneumatic cutoff tool.</p> <p>The nuts / thread were installed onto the vise, and the vise was clamped to the base-plate before welding in the studs.</p> <p></p> <p>After welding, I used flap disks to grind down the welds to a flat finish.</p> <p>Not pictured- I also ran a bit of weld on the bottom side of the plate. I was careful to not go overly thick here, as it may cause interference issues.</p> <p></p> <p>Here is the top side of the mounting plate. </p> <p></p> <p>I gave the mount a quick coat of spray paint.</p> <p></p> <p>At this point, the vise mount is basically completed.</p> <p>Here, is a photo showing it laying on the ground.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adding-set-screw","title":"Adding set screw","text":"<p>I did notice, there was a bit of wobble from the receiver hitch. I did want to add a set-screw to eliminate all movement.</p> <p>To make this, I used a piece of rusty rebar, along with threaded rod (a bolt with the head chopped off), and a nut.</p> <p></p> <p>The rebar was welded to the threaded rod.</p> <p>The threaded rod was sized so that it could be easily turned. </p> <p>Here is the temporary mock up, before welding.</p> <p></p> <p>For mocking this, I used an additional nut inside of the hitch to hold everything steady.</p> <p></p> <p>And, finally, the nut was welded onto the receiver hitch, and everything was tightened up, and given a coating of black rust-paint.</p> <p></p> <p>While this was a very simple solution, I can confirm, it removed ALL of the wobble from the vise mount.</p> <p>It is also very quick to loosen to allow for tool removal.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adding-a-horizontal-tool-mount","title":"Adding a horizontal tool mount","text":"<p>In addition to mounting my vise to this work table, I also wanted to be able to mount a few other tools as well.</p> <p>In the first case- A simple bench grinder. In the current state, my bench grinder sits on the floor, and is secured to my table using wood clamps. This is not ideal, and I wanted a proper solution for this problem.</p> <p>With my 2nd receiver hitch, I decided to mount it horizontal under the table top.</p> <p>I used my paint marker to trace lines where to cut.</p> <p></p> <p>And, with the angle-iron cut, the mount fits quite nicely.</p> <p></p> <p>Not pictured- The table was turned upside down, and the mount was welded into place.</p> <p>Note- The mount is NOT flush with the outside of the table, rather, its recessed allowing it to be out of the way when not needed. This- can be seen in later images.</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#adapting-bench-grinder-to-horizontal-mount","title":"Adapting Bench Grinder to Horizontal Mount","text":"<p>Since the horizontal mount was now welded in, the next task was to develop a mounting base for it.</p> <p>I decided to use a piece of 1-ft plate for the base. The same square tube as earlier will be used as well.</p> <p></p> <p>I disassembled the grinder, to remove the base. With the base removed, I was able to use my spring-loaded center-punch to mark where to drill holes.</p> <p></p> <p>(Not Pictured), After marking the holes, The holes were drilled, and the base was mounted to the plate.</p> <p></p> <p>Next, I laid the plate onto the square tube, to start mocking up a good position for it.</p> <p>The bench grinder is NOT flush against the table by design. This allows the cord to more gracefully come down.</p> <p></p> <p>The grinders base was unbolted, and then a line was drawn where to cut the square tubing.</p> <p></p> <p>The square tubing was cut using my chop saw. I also used the chopsaw to clean up the edges of the plate slightly.</p> <p></p> <p>After, everything was welded together, and given a coating of black rustoleam</p> <p></p> <p>And, voila. My bench grinder is now securely mounted to the table.</p> <p>(Also- not pictured- A hole was drilled through the square tubing, allowing a bolt to hold the square tube to the receiver hitch.)</p> <p></p> <p>Here is a photo of the backside. Note the gap, which allows the cord room.</p> <p></p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2025/building-a-shop-table---part-2/#conclusion","title":"Conclusion","text":"<p>While, nothing drastic, these small changes added a ton of usability to my shop table.</p> <p>I do- give my apologies for not including photos for some steps as the original intentions did not involve writing a blog post for this.</p> <p>But... due to less then desirable weather- here I am catching up on old blog posts!</p>","tags":["Shop-Talk","Shop-Talk/Welding","Shop-Talk/Fabrication"]},{"location":"blog/2023/off-grid-ac/","title":"How to start your A/C compressor off-grid.","text":"<p>Starting your A/C compressor generates a massive inrush current. Many inverters will have issues getting the motor spinning.</p> <p>In the case of my 3.5 Ton unit, the L.R.A. (Locked rotor amps) is 112.0 amps @ 220v (24,640 watts). This is far more current then my inverter can provide. This is the amount of amperage which it can potentially take to start the compressor motor.</p> <p>This post, describes how to install a soft start, which will allow your compressor to easily start off-grid using your solar array with inverter and batteries, or via a smaller generator.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#introduction","title":"Introduction","text":"<p>The day my system was fully installed, one of the tests I performed, was attempting to start the A/C compressor off-grid. </p> <p>Well, when I tested this, there were a lot of horrible noises, dimming lights, and beeping noises. It wasn't a very successful test.</p> <p>There is in fact a pretty simple way to resolve this: With the use of a soft-starter</p> <p>For this test, I went with the EasyStart 368-X72-Blue by Micro-Air, rated for a 4 \u2013 6 ton compressor.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#why-you-might-want-to-do-this","title":"Why you might want to do this:","text":"<p>IF, you intend on running your A/C compressor either via generator power, or via off-grid solar, there is a good chance your inverter or generator will have issues starting it, without dimming lights.</p> <p>If you have a permanently installed 30kwh Generator, you likely don't need to worry about this.</p> <p>But, if your generator is rated for under 12,000 watts, this will likely help you.</p> <p>As well, if you are planning on running a large A/C compressor, off-grid on solar alone- this will help you. Without it- my unit wouldn't successfully start without having energy from the grid.</p> <p>Lastly, these units will improve the efficiency and lengthen the life of your compressor's motor by reducing the inrush current when starting the motor.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#parts-tools-needed","title":"Parts / Tools Needed.","text":"","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#soft-start","title":"Soft start","text":"<p>Micro-Air ASY-368-X72-BLUE (Max 6-ton, 220v), Manufacturer Link</p> <p>MicroAir ASY-368-X48 (2 - 3.5 ton, 220v) </p> <p>This is the unit I went with. I ordered through the exact same link, as it had next-day delivery. If you order through the manufacturer, you may save 20$, however, you don't get next day shipping!</p> <p>For RVs and other 110v applications, see the EasyStart 364-X20-IP or the 364-X36-Blue</p> <p>Info</p> <p>To note- the properly sized unit for my compressor motor is the ASY-368-X48.</p> <p>However, since I plan on installing a larger compressor in the future, I went with the ASY-368-X72-BLUE which is oversized for my unit.</p> <p>Micro-air does offer a model selector to identify a unit properly sized for your compressor HERE. As well, they may offer better pricing than Amazon.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#tools-needed","title":"Tools Needed","text":"<ol> <li>Not required, but a cordless drill helps a lot. If you don't have one<ul> <li>I would recommend the Milwaukee M18 Fuel Drill, if you want a high-quality drill. Seriously, this thing is great.</li> </ul> </li> <li>Most HVAC units use 1/4\" screws. If you don't have a set of hex nut drivers, they come in handy. <ul> <li>Milwaukee Magnetic Nut Driver Set. </li> <li>Cheap/Generic Set is also an option.</li> <li>A normal socket, or 1/4\" screwdriver will work too.</li> </ul> </li> <li>You will likely want a ratcheting crimper. This will allow you to make proper, secure crimps. <ul> <li>Klein 3005CR Wire Crimping Tool This is the high quality option.</li> <li>There are cheaper versions available, however, based on my research, you will only save 10 bucks.</li> </ul> </li> <li>You may need a pair of wire cutters. <ul> <li>Klein D248-8 Pliers This is the high quality option that will last you forever.</li> <li>Cheap Pliers These work too. All depends on what kinda tools you want to buy.</li> </ul> </li> <li>Spade connectors. In my case, 12AWG was the proper size. You may need 10, 12, or 14AWG depending on your installation.<ul> <li>12-10 AWG Spade Connectors</li> <li>Note- Make sure to get connectors rated for up to 600 volts.</li> </ul> </li> <li>Wire Nuts. I needed a single, 12AWG wire-nut. I picked it up from my local hardware store for 10 cents.<ul> <li>Wire Nuts if you prefer Amazon.</li> </ul> </li> </ol> <p>At a minimum, you will need wire cutters, a crimping tool, and a multi-meter.</p> <p></p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#hardware-to-mount-easy-start-unit","title":"Hardware to mount easy-start unit.","text":"<p>To mount my unit, I visited my local hardware store and picked up some 1/4\" nuts, bolts, washers, and lock washers. If you take this option, make sure you also have a suitable drill bit. Overall, it costed around $1.50 to buy the hardware I needed.</p> <p>You can also use 1/4\" stainless self-tapping screws</p> <p>A Center punch comes in handy for marking your holes and getting the hole started. I have had this exact one since 2018, and it still works well.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#getting-started","title":"Getting Started","text":"<p>Danger</p> <p>The electrical wiring inside of your A/C unit can kill you. Even when the power is disconnected, there can be residual energy stored in its start capacitor. This can kill you.</p> <p>If you are not qualified to work on electrical circuits, you should call a licensed electrician, or HVAC specialist to perform the installation for you.</p> <p>I am not responsible for injury, death, or loss of property which may occur. This unit works well for me, however, your results may vary.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#step-1-disconnect-power","title":"Step 1. Disconnect Power","text":"<p>Near most A/C units, there will be a box, containing either a disconnect blade, or a breaker. Remove the disconnect / shut the breaker off.</p> <p>In the example of mine, you would want to flip the breaker downwards, so that it displays \"Off\"</p> <p></p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#step-2-remove-access-panel-identify-suitable-mounting-location","title":"Step 2. Remove \"Access\" panel / Identify suitable mounting location.","text":"<p>Look for where the power cables come into the A/C unit. You should see a corner/side panel which can be easily removed with a few screws. Remove it.</p> <p>Next up, you will need to identify a suitable location to mount the soft start unit.</p> <p></p> <p>In my case, the box is larger then the available area on the inside of the access panel. Since the unit is water proof, and is rated for outdoor mounting/use, I decided to mount it directly to the access panel.</p> <p>After ensuring the hardware wouldn't come into contact with any of the electronics on the other side of the panel, I used my center-punch to mark where the holes should be. Then, I drilled holes, and mounted the unit with 1/4\" hardware.</p> <p>Do note, I did use lock washers here. Since the A/C unit vibrates a lot, I felt these would help keep the unit secure.</p> <p></p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#step-3-clean-the-unit","title":"Step 3. Clean the unit","text":"<p>After removing the access panel cover, My unit was a mess covered with spiders, spider webs, dust, etc.</p> <p>I personally used my leaf blower to clean up everything a bit. I'd recommend instead, using a brush and/or vacuum... as a leaf blower can potentially blow dirt and other debris into your components. </p> <p>Before cleaning-</p> <p></p> <p>After cleaning and removing some of the wire ties.</p> <p></p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#step-4-wiring","title":"Step 4. Wiring","text":"<p>The next step took the longest. You will need to double-check the wiring diagram of your unit (usually written on the cover).</p> <p>So, for my unit, here is the wiring diagram:</p> <p></p> <p><sub>Hopefully somebody appreciates the perspective transform done here in Gimp! I am not the best photographer..</sub></p> <p>Next, we will need the easy-air's instructions.</p> <p>Also, you might check if they have a brand-specific installation manual for your unit</p> <p>After reading over the installation manual, here is my annotated wiring diagram.</p> <p></p> <p>Here is a slide from one of Micro-Air's installation manuals showing the same steps:</p> <p>The red Xs on the right are noting to remove any existing start capacitor and relay as those will not work with this unit.</p> <p>If any of the start components are found- all connections and wires to them must be removed! Otherwise, this unit will not function correctly and you could potentially cause damage.</p> <p></p> <p>To summarize the connections-</p> <ol> <li>Black wire connects to a spare location on the left side of the contactor.</li> <li>Remove the \"Red\" wire from the right side of the contactor, going to the compressor. Then, wire nut it together with the \"Brown\" wire from the soft start. Note, Your compressor wire may not be red.</li> <li>Connect the \"White\" wire from the soft start, to the right side of the contactor.</li> <li>The \"Yellow\" wire from the soft start, will need to connect to the \"HERM\" terminal of your capacitor. For my unit, there was a purple wire connected to one of the spots on this terminal.</li> <li>IF, you have an existing start capacitor and start relay, it must be removed.</li> </ol> <p>For, anyone confused as to what is what- here is a slightly annotated diagram.</p> <p></p> <p>Warning</p> <p>If any of these steps are confusing or you are not 100% absolutely sure on what to do, you should stop what you are doing and call a licensed electrician or HVAC professional.</p> <p>Again, all of these wires can carry enough energy to kill you. If you incorrectly wire this, it can cause a fire which can damage your property.</p> <p>As well, incorrectly wiring anything can result in a 8,000$ repair bill for your now broken A/C compressor.</p> <p>Danger</p> <p>Before touching ANYTHING, Make SURE the power is turned off to this unit.</p> <p>I used a multimeter to probe all of the terminals for residual current. The capacitor can carry current even when this unit is not powered.</p> <p>IT CAN KILL YOU!!!!!</p> <p>Here is my install after performing the required connections</p> <p></p> <p>After crimping the proper spade connectors on, making the connections and ensuring everything was securely fastened, I added new zip-ties to keep all of the wires from moving around.</p> <p>The last piece here, is to reinstall the cover.</p> <p><sub>Don't forget to admire Project Racecar in the background! Its ugly, but, its the heart that counts!!</sub></p> <p></p> <p>Note, I left the cable long by design. This allows the cover to still be removed, and placed on the ground.</p> <p>If, this long cable bothers you, you are free to cut your cable to a shorter length.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#testing","title":"Testing","text":"","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#letting-the-unit-learn","title":"Letting the unit \"Learn\"","text":"<p>My unit recommends at least 5 starts while connected to the grid for the unit to \"learn\".</p> <p>So, over the course of a few hours, I let the unit run normally while it collected data.</p> <p>Start 1:</p> <p></p> <p>And- after letting the unit work normally for a while-</p> <p>Start 7:</p> <p></p> <p>Compared to the nearly 80 amp start surge this unit was drawing before installing this unit, 35 amps is a massive improvement. </p> <p>Since- the unit has now completed its recommended learning period, lets see if it works on solar!</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#testing-off-grid","title":"Testing Off-Grid","text":"<p>The testing plan was pretty simple.</p> <p>I flipped the grid disconnect breaker off. After doing this, my automatic transfer switch will shift all of the loads in my house to run on the inverter using a combination of battery power and solar energy.</p> <p>Afterwards, I just needed to turn the A/C compressor on.</p> <p>And- as you can see in my poorly edited video, it works!</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#conclusion","title":"Conclusion?","text":"<p>Overall, it took me around 45 minutes to install this unit. I took my time, and triple-checked all of the connections.</p> <p>The installation process was easy, and the unit worked as expected with nothing else needed.</p> <p>After letting the unit \"learn\" 5 starts, it had no issues at all starting up the compressor off-grid.</p> <p>In addition to now being able to run my A/C compressor off-grid, this unit should also extend the lifetime of my compressor's motor due to a reduction in the startup surge.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#how-does-this-unit-work","title":"How does this unit work?","text":"<p>After validating this unit did work as expected, and allowed me to run my A/C compressor on inverter alone- I was curious to know the specifics of how this unit worked.</p> <p>So, I gave Micro-air a call and they were able to send over some documentation to help me answer a few questions.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#how-does-this-unit-compare-to-installing-a-start-capacitor","title":"How does this unit compare to installing a start-capacitor?","text":"<p>A start-capacitor will actually INCREASE the amperage during compressor startup, but, will reduce the amount of time it takes to start.</p> <p>Terminology:</p> <ol> <li>Normal Start - This is referred to as an A/C compressor starting without the assistance of either a starting capacitor, or soft start module.</li> <li>Hard Start - This is when you are using a starting capacitor with your compressor motor.</li> <li>Soft Start - This refers to the Easystart soft start unit referenced in this article. </li> </ol> <p>For the longer answer, here are a few relevant slides I obtained from Micro-air.</p> <p></p> <p></p> <p>Here is a  graphical representation of the various methods to start an A/C compressor.</p> <p></p> <p>The gist of the above comparison- A start capacitor gives a bigger \"kick\" when starting the motor, to get it running faster. The easy-start unit causes the unit to start more slowly, with greatly reduced amperage.</p>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#what-are-some-other-benefits-this-unit-can-provide","title":"What are some other benefits this unit can provide?","text":"<p>Using a few of the provided slides-</p> <p></p> <p></p> <p>To summarize-</p> <ol> <li>Checks for many potential fault conditions, and offers protections for your A/C compressor.</li> <li>Built-in short-cycle protection. This will prevent your A/C compressor from being cycled too quickly. This can be handy if your thermostat / HVAC control board does not have short-cycle protection built-in. Short cycling your compressor can damage it.</li> <li>You will need a smaller generator/inverter to properly start your A/C compressor. </li> <li>This unit also provides bluetooth diagnostics. If you run into any issues, you can upload the diagnostics to Micro-air, and they will be happy to assist you with identifying and resolving the issue.</li> <li>No more dimming lights when your A/C kicks on.</li> </ol>","tags":["Solar","HVAC"]},{"location":"blog/2023/off-grid-ac/#disclaimers","title":"Disclaimers","text":"<p>Not Sponsored</p> <p>This post is not sponsored or affiliated by Micro-air, and I received no compensation for publishing this.</p> <p>All hardware, time, and tools was provided and paid for out of my pocket.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Solar","HVAC"]},{"location":"blog/2022/eg4-rack-assembly/","title":"EG4 Rack Review","text":"<p>As apart of the Home Solar Project, I purchased and assembled an EG4 battery rack.</p> <p>This post outlines the process of assembly, issues I encountered, and my final opinions.</p> <p></p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#overview","title":"Overview","text":"<p>This rack itself, is constructed from 16ga steel, and is extremely sturdy after it is assembled. </p> <p>While, I did not take step by step pictures of assembling this rack, here is an image before the sides were bolted togather.</p> <p></p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#issue-1-door-locklatch-clearances","title":"Issue #1 - Door Lock/Latch Clearances","text":"<p>After getting the rack assembled, I noticed the door lock clearances were really bad. With the door shut, there was nearly 3/4\u2033 of play. If you pulled the door hard enough, it would open regardless of being locked.</p> <p>While, my intentions isn\u2019t to build a perfectly secure cabinet for my batteries- I did want the door to shut nice and snug, instead of flapping around in the wind.</p> <p>The first step to fixing this issue- I added an extra washer on the back of the lock. As it came, there was just a hair too much play for my taste, which makes it sound \u201cJingly\u201d if you rattle the door. But- this little washer I had laying around, worked perfectly to take up the extra slop.</p> <p></p> <p>After adding the extra washer, this took nearly all of the slop out of the locking mechanism.</p> <p></p> <p>Next, I moved the \u201cLatch\u201d</p> <p>In the below pictures, the holes on the left, are where the latch was originally mounted. After crawling in the rack from the back, I realized I could move the bracket back a bit- and still have plenty of clearances.</p> <p></p> <p>Because, the once very loose fit, was now an extremely tight fit, I took a pair of channel locks, and slightly bent the locking lever, so that it could more easily \u201ccatch\u201d the \u201clatch\u201d</p> <p></p> <p>Looking in the rack from the back, You will notice- it is now an extremely tight fit, and will not rattle at all.</p> <p></p> <p>The extra bend, helps to ensure the lever can easily catch the backside of the latch.</p> <p>Overall, this minor tweak took me 10 minutes to figure out- and removes essentially all of the \u201cnoise\u201d from the door.</p> <p>My expectations aren\u2019t to make a perfectly secure door\u2026 but, rather, to just remove the noise from it, and to make it shut tightly.</p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#issue-2-2-phillips-bits","title":"Issue #2 - #2 Phillips bits","text":"<p>If- you are like me, and you buy a bunch of cheap tools from Amazon and Harbor Freight- because you don\u2019t want to pay the premium for a well made tool- Do yourself a favor and buy extra #2 bits.</p> <p>You will need them. \ud83d\ude42</p> <p></p> <p>I only broke 5 #2 Philips bits!</p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#recommended-tools","title":"Recommended Tools","text":"","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#a-good-drill","title":"A good drill","text":"<p>Make sure you have a good drill.</p> <p>I personally use a Milwaukee M18 Fuel 1/2\u2033 Drill. I found for this- the best torque setting was \u201c20\u201d. Any more, and it would snap the bits in half. Any less, and the screws wouldn\u2019t be fully tightened.</p> <p></p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#2-phillips-bits","title":"#2 Phillips Bits","text":"<p>AFTER breaking 5 of my chinesium #2 Philips bits- I went ahead and ordered a few dewalt #2 bits. I have had great luck with all of my tools and bits from Dewalt\u2026 Given, there are 25 of them, for only ~50 cents each- I imagine the quality has to be at least a step above the cheap ones I broke assembling this rack. It never hurts to have a few extra bits laying around.</p> <ul> <li>Amazon \u2013 DeWalt #2 Phillips Bits \u2013 25 count</li> </ul> <p></p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#drill-bit-extension","title":"Drill bit extension","text":"<p>Lastly- the cheap extensions\u2026 I had a few no-name ones, which were hardly magnetic, which got sloppier for each screw I drilled. I picked up a few DeWalt replacements for 3$ each.</p> <p></p>","tags":["Solar","Review"]},{"location":"blog/2022/eg4-rack-assembly/#final-verdict-45","title":"Final Verdict? 4/5","text":"<p>The rack itself, has a heavy, sturdy construction of 16ga steel.</p> <p>The instructions, are nearly non-existent for assembly though. I essentially had to figure out most of the details myself, which wasn\u2019t too hard, given there are only so many parts included.</p> <p>I did have to tweak the door mechanism to properly shut, without rattling. However, this was a pretty easy tweak.</p> <p>Once the rack was assembled, the battery slid in with no issues, and very good tolerances.</p> <p>Overall, I would recommend it.</p>","tags":["Solar","Review"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/","title":"Lessons learned from a local disaster","text":"<p>Continuation of the home solar project. </p> <p>Around Midnight, Saturday June 17th, a very strong storm passed over my house, and hit my town and surrounding areas with a 115mph wind gust. </p> <p>Power was out for around two and a half days, in which case, I powered my house fully off-grid.</p> <p>While- this doesn't sound like a huge deal- do note, I was able to maintain climate control in my home, along with my ENTIRE rack of servers.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#responding-to-the-crisis","title":"Responding to the Crisis","text":"<p>While this might not seem extraordinary, it's important to note that I managed to maintain climate control within my home and sustain the operation of an entire rack of servers throughout the power outage.</p> <p>Recognizing the impending storm's severity, I proactively initiated the battery charging process about an hour before it hit. Normally, the batteries would accumulate surplus solar energy during the day and discharge only to a minimum of 50% capacity.</p> <p>I adjusted the inverter settings to enable the battery charging at a full 10,000 watts from the grid, which was a significant enhancement from the previous limit of 5,000 watts.</p> <p>When the grid went down during the event, my house seamlessly transitioned to battery power, demonstrating a flawless performance of the system.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#a-day-by-day-account","title":"A Day-by-Day Account","text":"","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#the-first-night","title":"The first night","text":"<p>The first night, the only change I did, was to turn off the central HVAC unit (but, I left the mini-split in the bedroom running)</p> <p></p> <p>And- everything worked pretty well throughout the night. HOWEVER- I un-mistakenly had the inverter configured to completely shutoff when the battery reached 20%.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#day-1","title":"Day 1","text":"<p>This led to a significant reduction in available power by around 7:20 am. Fortunately, my servers are equipped with a dedicated UPS featuring a 2.4 kWh battery capacity, enabling them to remain operational.</p> <ul> <li>Correction Applied: Lowered the low-battery shut-off to 10% capacity.</li> </ul> <p>Typically, the batteries are configured to never deplete below 50% charge during standard usage. Therefore, the low-battery shut-off should ideally engage only when a complete grid failure occurs.</p> <p>After taking a coffee break, my initial step was to start the generator. Since solar energy production tends to pick up between 8 am and 9 am, this move was strategic.</p> <p>Although configuring the inverter to accept generator power required considerable tinkering, I eventually succeeded. Consequently, the generator began recharging the batteries.</p> <ul> <li>Correction Applied: Generator settings have been configured. However, this will become obsolete in a future step.</li> </ul> <p>As the generator operated and the batteries began to replenish, the sun emerged, contributing solar energy as well.</p> <p></p> <p>Several hours later, when the photovoltaic (PV) output had risen significantly, I deactivated the generator. This allowed solar production to take over and supply power to all the loads.</p> <p>To ensure that the batteries were optimally charged for the night, I decided to run the generator again after PV production ceased in the evening. This continued until around 10 pm, effectively achieving a battery charge level of approximately 95%.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#day-2","title":"Day 2","text":"<p>Day two was off to a much better start, since the batteries were properly charged the night before. </p> <p>However- something was different about Monday. It was going to be much hotter.</p> <p></p> <p>As you can see- Sunday night was night and cool, and the high temps on Sunday, were under 90 degrees. So, running a ceiling fan in the living areas was plenty to keep the temp maintainable. </p> <p>As such- I have not turned on the central AC unit at all.</p> <p>But, with temps reaching nearly 100 degrees out, that would not be an option for today.</p> <p>As with the previous day, I started the generator up in the morning to give a quick boost until the sun came out.</p> <p></p> <p>However, this time, I also fired up the generator around noon, to provide enough energy to run the central 3.5ton HVAC.</p> <p>While- I can run the big AC on nothing but battery and solar, it would quickly drain my battery.</p> <p>But, since the solar was producing a healthy 4kw, combined with the 5-6kw from the generator, this was plenty of capacity for running the central AC unit, while still pushing extra energy into the batteries.</p> <p>Day 2 Load Consumption</p> <p></p> <p>After running the unit for nearly three hours, it was able to drop the overall temps from around 80F, down to a more manageable 74F.</p> <p>However, after shutting the AC off, the temp quickly snuck back up.</p> <p>So- around 7PM, the generator was fired back up to both cool the house down, and to charge up the batteries.</p> <p>After running the generator until a bit after 10pm, the batteries were charged up to around 95% and ready to go another day.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#day-3","title":"Day 3","text":"<p>By this point, managing battery life at nighttime was not a huge deal. However- with all of the extra heat outside, the mini-split had to work harder to keep the bedrooms at a decent temp. </p> <p>As well, at this point, I had some of my neighbors loads (Fan, Fridge, etc) running off of my battery power at night. </p> <p>However- the night still ended with a reasonable amount of spare capacity. </p> <p></p> <p>As I did on previous days- I started the day by firing up the generator to put some charge into the batteries.</p> <p></p> <p>Since- today was pretty cloudy, solar production was not off to a good start. Despite the clouds, the temps were not affected at all.</p> <p>So, the generator was fired up again around noon, to allow the primary AC to run.</p> <p>And- around 3-ish PM, the grid was restored and I turned off the generator.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#problems-encountered","title":"Problems Encountered","text":"","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#generator-power-is-very-noisy","title":"Generator power is VERY noisy.","text":"<p>This- is one of the first issues I encountered. I had to adjust the settings on my inverter to even allow it to connect to the generator, due to its noise.</p> <p>I have been asked a few times- What do you mean by noise?</p> <p>To demonstrate this- I will provide a few pictures.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#inverter-power","title":"Inverter Power","text":"<p>The first picture, is what the frequency looks like under inverter / battery power alone.</p> <p>The sol-ark 12k inverter, produces a very clean sine wave. Notice- the maximum difference is 0.04hz.</p> <p></p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#grid-power","title":"Grid Power","text":"<p>Next up, this is standard grid power.</p> <p>This- is a full day worth of grid power. Notice, the maximum deviation, is only 0.10hz.</p> <p></p> <p>While- this looks quite noisy compared to inverter power... Just wait.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#generator-power","title":"Generator Power","text":"<p>This chart starts off using inverter-only power, until around noon. After which, the generator was turned on. </p> <p></p> <p>Notice- the generator's signal is extremely noisy.</p> <p>Lets look at a larger picture.</p> <p></p> <p>The slightly wiggly line up until the 18th, is grid power. The mostly solid flat line pieces afterwards, are inverter power.</p> <p>The MASSIVE spikes everywhere, is the frequency when operating under generator power.</p> <p>I did- however, manage to clean up the signal a bit by the 3rd day.</p> <p></p> <p>I was able to do this by placing a mostly static 6kw load on the generator. Running the generator at 5kw, placed its frequency much closer to 60hz, however, did not provide enough juice for the AC compressor.</p> <p>This was managed by a few settings on my inverter.</p> <ol> <li>A firmware update was completed. This corrected/fixed a lot of the generator related functionality. Before this update- generator peak shaving did not work correctly.</li> <li>This allowed me to configure peak shaving for my generator input. What this means- I place a 5kw peak shaving setting. Any loads &gt; 5kw, would instead be aggregated from battery power, allowing the generator to stay very close to 5kw.<ul> <li>While- not perfect, this did allow the frequency to remain somewhat consistent.</li> </ul> </li> <li>The firmware update also allowed me better control over charging the battery from the generator. This mean, when I didn't have 5kw of loads, the remaining capacity would instead be used to charge the batteries, keeping the load consistent. </li> </ol>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#how-to-fix-this-why-is-this-a-problem","title":"How to fix this / WHY is this a problem?","text":"<p>The generator's power quality issue stems from the fact that when the inverter receives power from the grid or generator, it doesn't convert it but directly routes it to the connected loads. This design doesn't suit smaller generators like the Harbor Freight Predator, as these inverters are generally optimized for larger generators.</p> <p>To address this problem, the solution involves not sending the generator power to the inverter. Instead, a more effective approach is to convert the generator's 240V AC power into clean DC power through inversion.</p> <p>A suitable solution for this scenario is offered by Signature Solar. They have a 5kW 48V charger available, which seamlessly integrates into this configuration. This charger provides the required functionality to rectify the generator power's noise issue and ensure a stable power supply.</p> <p></p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#upsides","title":"Upsides","text":"<ol> <li>Generator wiring and logic becomes extremely easy. If the generator is turned on, power gets automatically sent to the batteries.</li> <li>When the generator is off, the charger becomes inactive / dormant. </li> <li>I can very easily fine-tune the amount of energy I wish to pull from the generator, up to 5,000 watts.</li> <li>All of the electronics inside of the house will receive a very clean, pure sine wave, even when the generator is running.</li> </ol>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#the-downsides","title":"The downsides","text":"<ol> <li>Slight efficiency losses from inverting the power twice. (Generator AC -&gt; DC To Battery/Inverter -&gt; AC to House)</li> <li>Slightly reduced generator capacity. Going through the inverter, I can load the generator far in excess of its actual capacity. <ul> <li>During testing while off-grid, I did manage to load the 7,200 watt rated generator at 7,000 watts for around... 30 minutes before it tripped its circuit breaker.</li> <li>This- is not a massive disadvantage, as the generator is likely to run more efficiently at around 50-80% of its rated capacity. Running at full capacity, it was chugging fuel pretty quickly...</li> </ul> </li> </ol>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#limited-battery-capacity","title":"Limited Battery Capacity","text":"<p>With 20kwh of battery capacity- there is only so much you can run from battery.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#server-loads","title":"Server Loads","text":"<p>While most households can comfortably function on 20kWh of energy throughout a day, my specific situation is unique due to the presence of a full rack of servers dedicated to hosting various services. These services include my personal website, https://lemmyonline.com/, and my NVR, among others.</p> <p>Collectively, the servers in my setup consume around 400-700 watts of power, operating non-stop to provide both internal and external services. Although the option to downsize is available, such a move would unavoidably result in diminished functionality in other essential aspects.</p> <p>Nonetheless, I have made improvements to the setup by ensuring that all critical operations are now handled within my Kubernetes cluster. This strategic arrangement grants me the flexibility to power down my substantial \"BIG\" server, which accounts for a load of 300-400 watts. The remaining servers then operate at a mere 10-20 watts each, dedicated to running the Kubernetes cluster, firewall, home automation, NVR, and more.</p> <p>It's worth noting that the larger server also hosts a significant volume of content, exceeding 100 terabytes. Fortunately, this content can generally tolerate being shut down overnight without issue.</p> <p>In totality, my server rack shoulders the responsibility for more than half of the off-peak power consumption.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#hvac-loads","title":"HVAC Loads","text":"<p>Sleeping inside when its 80 degrees, also is not very pleasant. Running the mini-split consumes another 200-600watts depending on the amount of heat which needs to be removed.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#work","title":"Work","text":"<p>I work from home. For me to work, I need computers, and monitors working. During work hours, this consumes a healthy chunk of energy. </p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#battery-summary","title":"Battery Summary","text":"<p>While- 20kwh of storage is not ideal in my case, it is enough to keep everything powered throughout the night. In more critical circumstances, I can now power off the big server as well to save energy. </p> <p>As such, I did not feel significant changes needed to occur here. </p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#limited-pvsolar-capacity","title":"Limited PV/Solar Capacity","text":"<p>Presently, my roof is equipped with 5kW solar panels, theoretically capable of generating about 5kW of power. However, several factors have led to a reduction in the actual power production:</p> <ol> <li>Cloudy and overcast skies.</li> <li>Smoke from wildfires in Canada</li> <li>Other environmental conditions.</li> </ol> <p>As a result of these influences, my solar panels were producing approximately 3kW to 4kW of power during this particular event.</p> <p>Shown below is a chart detailing the production over the past week:</p> <p></p> <p>It's worth noting that the day following the storm, there was an unusually high spike in production. This could possibly be attributed to the storm dispersing the atmospheric smoke.</p> <p>Throughout the rest of the week, production remained modest due to the factors mentioned above.</p> <p>Fortunately, this level of production is sufficient to power a significant portion of my house. Essential operations like running servers, work computers, dishwashers, dryers, and washing machines can all function with this level of solar output. The main exception is the central HVAC unit, which requires more power than the available solar production can provide.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#significance-of-the-main-hvac","title":"Significance of the Main HVAC","text":"<p>It's important to emphasize the significance of maintaining a functional main HVAC system. It's worth noting that my household includes not only myself but also my wife and young children.</p> <p>During periods of heat advisories when the outdoor temperature exceeds 90 degrees Fahrenheit, the air conditioning (AC) becomes crucial. This is particularly true given the heat generated by the multitude of electronics necessary for my work and various projects.</p> <p>The main issue arises due to the energy demands of the AC compressor itself. It draws a substantial 3.5 to 4 kW of power, with an additional 500W required to operate the furnace blower. Consequently, the overall energy consumption for running the HVAC amounts to approximately 4-5 kW.</p> <p>However, the challenge lies in the fact that my solar panels generate around 3-4 kW of power. Moreover, considering the other typical daily loads of 1.2 to 2 kW, the collective energy demand surpasses the available solar power production. In total, running both the AC and other essential appliances would consume between 5 to 7 kW of energy.</p> <p>Although this arrangement is feasible, it would deplete the batteries at a swift pace, a situation that isn't ideal considering their importance for nighttime power needs. Therefore, the key lies in enhancing the solar panel capacity or employing alternative power solutions to ensure the reliable operation of the main HVAC system and maintain indoor comfort for my family.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---weather-disaster---lessons-learned/#how-to-fix-this","title":"How to fix this?","text":"<p>Well- I gave my solar installer a call to inquire about adding 3kw more capacity to my roof. However, I was unsatisfied with the best offer they were able to provide me.</p> <p>As such, unless I install a new array myself, I will not be expanding my PV capacity soon.</p>","tags":["Solar"]},{"location":"blog/2023/solar-assistant-with-solark-12k/","title":"Installing Solar-Assistant","text":"<p>Per my home solar project, I needed a method to collect data from both my batteries and inverters, in near-real-time, with no dependency on the internet.</p> <p>Since, my inverter's connection relies on cloud applications to move data around, I decided to give Solar Assistant a try after reading of its support for the solark-12k.</p> <p>Finished Energy Dashboard: </p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#required-hardware","title":"Required Hardware","text":"<p>For the required hardware, you can either acquire it from Solar-Assistant's Shop, or, you can acquire it via Amazon.</p> <p>I elected to go with Amazon, since the solar-assistant.io store claims to ship from South Africa. I didn't really want to wait a few weeks.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#product-links-used-here","title":"Product Links Used Here","text":"<p>This is the exact hardware I decided to use after reviewing solar-assistant's supported hardware:</p> <ol> <li>Orange Pi 3 LTS</li> <li>Generic USB RS485 Adapter<ul> <li>Note- I orignally had this unit, however, during troubleshooting steps, I replaced it with another adapter.</li> <li>I personally prefer the first one with the blinking tx/rx lights. It assisted with debugging. Also- the case on the bottom adapter started to fall apart. </li> </ul> </li> <li>Samsung MicroSD<ul> <li>Note, You really only need a 16G MicroSD card. I just happened to have a pile of 256G ones laying around. So- if you want to save a few bucks, you can get a smaller one.</li> <li>A 64G card will never run out of room for this use-case.</li> </ul> </li> <li>Ethernet Splitter<ul> <li>If... your inverter is reading the status of your battery, this will allow you to \"split\" the serial connection and allow solar-assistant to read your inverter, while your inverter reads your battery.</li> <li>If, you don't plan on using your inverter to read the serial data from your battery, you can skip this item. In my case, my inverter does not have support for reading my battery.</li> <li>As such- this won't be of much use to me.</li> </ul> </li> <li>Solar-Assistant License</li> </ol>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#install-configuring-solar-assistant-with-solark-12k-outdoor","title":"Install / Configuring Solar-Assistant with Solark-12k Outdoor","text":"","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#sol-ark-configuration","title":"Sol-ark configuration.","text":"<p>IF, you happen to have a solark-12k outdoor model- reading these two line items will save you potentially weeks of troubleshooting.</p> <ol> <li>Set Battery BMS mode to \"00\"</li> <li>Under Parallel Options, set the modbus ID to \"1\", it defaults to \"0\"<ul> <li>If you forget this, you will receive a lot of CRC Errors.... and- its not going to work.</li> </ul> </li> <li>Plug your cable into the BATTERY MONITORING port. The \"modbus\" port is... not enabled, unless you have a different firmware which enables it.</li> </ol> <p>Thats it! (It took me quite a while to get those settings correct...)</p> <p>Here is a very helpful page I found in the manual, after digging for a while:</p> <p></p> <p>If, you are unsure of which port to plug your cable into, here is a picture.</p> <p></p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#serial-wiring","title":"Serial Wiring","text":"<p>The plug on the solark uses typical RJ45/Ethernet wiring. Of the 8 wires in the cable, you can use either Orange+OrangeStripe, or Brown+BrownStripe. Both pairs are essentially the same. As well, green+greenStripe are both ground.</p> <p>Blue / Blue Stripe are both CAN bus.</p> <ol> <li>Solid Orange goes to \"A+\" pin.</li> <li>Striped Orange goes to \"B-\" pin.</li> <li>Solid Green goes to GND pin.</li> </ol>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#home-assistant-integration","title":"Home-Assistant Integration","text":"<p>We will integrate solar-assistant to home-assistant using MQTT as the medium. It supports publishing its data to its local MQTT server, seamlessly.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#step-1-enable-mqtt","title":"Step 1. Enable MQTT.","text":"<p>Under the configuration tab of your solar-assistant, at the bottom, you will find the MQTT options.</p> <p>Click \"ADVANCED\" to open up the settings.</p> <p></p> <p>Set a topic prefix, ensure home-assistant discovery is enabled. And optionally decide if you want to allow changing settings via MQTT/Home-Assistant.</p> <p>I went ahead and generated a random username and password combination.</p> <p>After that is done, from the main configuration page, enable/start the MQTT service.</p> <p></p> <p>At this point, solar-assistant will be running ITS OWN EMBEDDED mqtt server.</p> <p>The next step- is to get data from its MQTT server, into our mqtt server.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#step-2-setup-mqtt-broker","title":"Step 2. Setup MQTT Broker","text":"<p>IF, you are using home-assistant's embedded MQTT server, I recommend using Solar-Assistant's Home-Assistant MQTT Broker Setup Guide</p> <p>The directions I am going to provide, are specific to running Mosquitto MQTT via Kubernetes.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#kubernetes-configuration","title":"Kubernetes Configuration","text":"<p>First of all, lets create a configmap containing the various configuration files we need to expose to mosquitto MQTT.</p> mqtt_configs.yaml<pre><code>kind: ConfigMap\nmetadata:\n  name: mqtt-configs\n  namespace: home-automation\napiVersion: v1\ndata:\n  solar_assistant.conf: &gt;\n    connection SolarAssistant\n\n    remote_username your_user_goes_here\n\n    remote_password your_password_goes_here\n\n    address 10.1.2.3 &lt;-- Put the IP of your solar-assistant here.\n\n    topic # in\n\n    topic solar_assistant/# out    \n  mosquitto.conf: &gt;\n    persistence true\n\n    persistence_location /mosquitto/data/\n\n    include_dir /mosquitto/config/conf.d\n\n    listener 1883 0.0.0.0\n\n    password_file /etc/mosquitto/password_file\n  password_file: &gt;\n    ## Contents Obmitted.\n</code></pre> <p>In the above configuration, the secret needed is the <code>solar_assistant.conf</code> file. It contains the configuration needed to broker messages from the solar-assistant mqtt server, to this local mqtt server.</p> <p>If- you don't know how to configure a password file, please see The Official Documentation</p> <p>For obvious security purposes, the contents of my file will not be included here.</p> <p>Next up, you will optionally need persistent storage. If you do not want/need persistent storage, update the mosquitto.conf file above, set <code>persistence false</code> and remove the <code>persistence_location</code></p> mqtt_data.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mqtt-data\n  namespace: home-automation\nspec:\n  storageClassName: longhorn\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 2Gi\n</code></pre> <p>2G is likely overkill for this need. Adjust as you please.</p> <p>Finally, here is the stateful set manifest</p> mqtt.yaml<pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: mqtt\n  name: mqtt\nspec:\n  replicas: 1\n  serviceName: mqtt\n  selector:\n    matchLabels:\n      app: mqtt\n  template:\n    metadata:\n      labels:\n        app: mqtt\n    spec:\n      volumes:\n        - name: data\n          persistentVolumeClaim:\n            claimName: mqtt-data\n        - name: config\n          configMap:\n            name: mqtt-configs\n            defaultMode: 420\n      containers:\n        - name: mqtt\n          image: eclipse-mosquitto:latest\n          volumeMounts:\n          - name: data\n            mountPath: \"/mosquitto/data\"\n          - name: config\n            mountPath: \"/mosquitto/config/mosquitto.conf\"\n            subPath: mosquitto.conf\n          - name: config\n            mountPath: \"/mosquitto/config/conf.d/solar-assistant.conf\"\n            subPath: solar_assistant.conf\n          - name: config\n            mountPath: \"/etc/mosquitto/password_file\"\n            subPath: password_file            \n          ports:\n          - name: mqtt\n            containerPort: 1883\n          - name: websocket\n            containerPort: 9001\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: mqtt\nspec:\n  selector:\n    app: mqtt\n  ports:\n    - name: mqtt  \n      port: 1883         \n      protocol: TCP    \n      targetPort: mqtt\n    - name: websocket  \n      port: 9001         \n      protocol: TCP    \n      targetPort: websocket\n  type: LoadBalancer\n  loadBalancerIP: 10.140.5.6 ##Set your own exposed IP here. Or, change to nodeport. or- however you wish to expose MQTT.\n</code></pre> <p>At this point, you should have all of the pieces required to configure this within Kubernetes.</p> <p>To note- this was not intended to be the end-all guide on how to configure MQTT in kubernetes. Just- enough information for you to update your MQTT instance to work.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#step-3-update-home-assistant-mqtt-integration","title":"Step 3. Update Home-Assistant MQTT Integration","text":"<p>From home-assistant, goto settings -&gt; integrations.</p> <p>Assuming, you already have a MQTT integration configured, click on your existing integration and click configure.</p> <p>Then, at the top, click <code>RE-CONFIGURE MQTT</code>.</p> <p>Click Next.</p> <p>Make sure the checkbox to <code>Enable Discovery</code> is checked. Submit the changes, if any.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#step-4-wait-and-confirm","title":"Step 4. Wait, and Confirm","text":"<p>Wait a bit, and home-assistant should automatically discover all of the sensors, switches, etc from solar-assistant.</p>","tags":["Solar","Home-Automation"]},{"location":"blog/2023/solar-assistant-with-solark-12k/#configure-energy-dashboard","title":"Configure Energy Dashboard","text":"<p>For this piece, I followed the Directions from Solar-Assistant</p> <p>After following the directions, you should end up with something like this:</p> <p></p> <p>Now- before you get excited to go and see your fancy energy dashboard.... You need to wait. It will take an hour or two before home-assistant starts displaying data on its energy dashboard.</p> <p>While you are waiting, feel free to build out a few real-time dashboards.</p> <p></p> <p>In the above dashboard, you can see the energy dashboard panels still shows no data at all. (Even an hour later!)</p> <p>On the bottom, I setup two sections. \"Fast\" metrics, and \"Slow\" metrics.</p> <p>The kWh metrics are pretty slow to update. Since, the energy usage dashboards are also pretty slow to update, this is not an issue.</p> <p>The \"fast\" metrics, have update intervals in the seconds. If you wish to build a real-time dashboard, use these!</p> <p>After, waiting an hour or two- you should be presented with a working energy dashboard.</p> <p></p> <p>Here is a screenshot of solar-assistant's home page</p> <p></p>","tags":["Solar","Home-Automation"]},{"location":"blog/2022/home-solar-project---part-1---introduction/","title":"Home Solar Project - Introduction","text":"<p>One of my projects I have been working on over the last two years, is adding solar panels to my house to offset some/most of my electrical usage.</p> <p>Here are the goals I wish to accomplish, and how I plan on accomplishing them:</p> <ol> <li>Reduce my electricity bill by 75-100%.</li> <li>I want my electric to work when the main grid goes down (happens\u2026 pretty frequently.)<ul> <li>For my servers, computers, and networking devices- Failover needs to happen in UNDER 5ms.</li> </ul> </li> </ol>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-1---introduction/#goals","title":"Goals","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-1---introduction/#goal-1-reducing-energy-bill","title":"Goal 1 - Reducing Energy Bill","text":"<p>Last year, I installed an Iotawatt, to start tracking my energy utilization. It has done a fantastic job, and gives me very good data, which also integrates extremely well into home assistant.</p> <p>If, you don\u2019t have a solution for tracking your energy, and would like options, Please see Home Assistant \u2013 Energy Monitoring Options.</p> <p>Looking at this year's<sup>1</sup> worth of utilization-</p> <p></p> <p>As can see, I average around 1Mwh of utilization for most months, which shoots up to 2-3mwh during the hot summer months. As well, This year, we had outside temps &gt; 105F for over a month straight. It.. was a pretty hot year.</p> <p>Knock on wood, the minisplit I installed earlier this year, drastically reduced the amount of cooling I needed for my house. Without it- my bills would have been MUCH higher.</p> <p>That being said, lets figure 1,500Kwh as the average usage per month. This equals\u2026</p> <p>1,500 * 0.08c = 120$ of electricity.</p> <p>So, the first thing to do, is calculate the \u201cSolar hours per day\u201d, using a tool such as THIS. For my location, this gives me around 5.31 peak hours per day average for the entire year.</p> <p>Figuring, 5kw worth of installed panels-</p> <p>5kw * 5.31 peak hours = 26.55kwh average daily production.</p> <p>Skipping back to above, our average usage per month was 1,500kwh.</p> <p>1,500kwh / 30 days = 50kwh daily utilization.</p> <p>Based on reviewing the last years worth of data, this should be enough capacity to offset nearly everything during non-peak cooling months. During peak cooling months (June, July, Aug), I usage between 80-120Kwh per day.</p> <p>However, I also will receive around 7 hours of peak sunlight per day during those months, but, I will still come up pretty short here. But- I have a plan for this\u2026</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-1---introduction/#improved-insulation","title":"Improved Insulation","text":"<p>Since, my house was built in the 1970s, its insulation is not the best in the world. Its cellulose is old, and packed down, and likely is not working as good as it should.</p> <p>As apart of this project, I will be reinsulating the attic from its\u2026. current 6 inches, up to a foot and a half. This should drastically reduce the amount of heating AND cooling required for my house.</p> <p>My homes, during the peak cooling months, this should hopefully reduce the amount of energy required by 20-40%.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-1---introduction/#goal-2-improved-self-reliance-off-grid-backup","title":"Goal 2 - Improved self-reliance / Off-grid backup","text":"<p>For most people, this really wouldn\u2019t be an issue. However, I work out of my house. I host many public projects out of my house (This website being one of them.).</p> <p>Me being able to power on my computer, and work, is what keeps my bills paid. If I don\u2019t have electricity, I can\u2019t work.</p> <p>As such, one of the goals I want to accomplish here- is being able to keep my house \u201conline\u201d when the grid drops.</p> <p>NORMALLY, people don\u2019t have too many issues with the grid dropping. However, where I live- this is a bigger issue then I would like to admit. We have lots of small 1-2 hour outages throughout the year. As such, I would like to be able to power my house on battery for around one hour, before I have to pull out my generator.</p> <p>Also- while I do have a generator, and can power my house from it- it is not ideal\u2026 as it takes a bit of time to pull it out, get it set up, etc\u2026. and its pretty noisy. My end goal, is to only have to fire it up, for outages longer then a few hours. To reach this goal, I will be starting with 5Kwh total battery storage. This should give plenty of buffer. </p> <p>During peak cooling months, this gives enough time to pull out the generator and start it. (My A/C generally draws around 6+ kw)</p> <p>During non-peak cooling months, this should give me 5-20 hours of total runtime, depending on what all loads are engaged. (Obviously, running the dryer wouldn\u2019t be a good idea while running on battery).</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-1---introduction/#the-plan","title":"The Plan","text":"<p>A pretty simple solution was found for providing <code>always-on</code> capabilities for my computers. A <code>critical loads</code> panel will be leveraged, connected directly to the inverter. During power-drops or outages, the specific inverter I will be using is capable of switching from grid, to battery power in under 6ms.</p> <p>For the rest of the house, the main panel will be located behind an automation transfer switch. This switch, should be able to switch the mains panel from grid, to battery power in under 500 milliseconds.</p> <p>For starting out, I will be leveraging only 5.12kwh worth of LiFePO4 batteries. While- this is not enough capacity for long-term battery backup of my house- this gives me between 1-3 hours in order to turn on the generator, which will be connected to the inverter in order to charge the batteries, and carry the load.</p> <ol> <li> <p>Note, image captured on 2022-12-10, As such, month of december is not yet completed.\u00a0\u21a9</p> </li> </ol>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/","title":"Home Solar Project - Battery Selection","text":"<p>For the second part of my Home Solar Project, I researched possible solutions and ordered batteries.</p> <p>This post, describes some of the decision making process I went through.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#options-evaluated","title":"Options evaluated","text":"<p>I evaluated most of the commonly available options. For most of these options, I did include a video review, if you are interested.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#ampere-time-48v-100ah-battery-512kwh","title":"Ampere Time 48v 100ah battery - 5.12Kwh","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#351-kwh","title":"351$ / kwh","text":"<ul> <li>Purchase on Amazon</li> <li>Will Prowse Review (YouTube)</li> </ul> <p>Last year, I actually put together a portable power supply / UPS for my servers using this battery. I have no issues or complaints- it works exactly as expected. It has great capacity, for a pretty good price.</p> <p>This is a pretty cost-effective option, given the capacity.</p> <p>I will note- Chins batteries are basically identical.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#eg4-ll-48v","title":"EG4-LL 48v","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#341-kwh","title":"341$ / kwh","text":"<ul> <li>Purchase at Signature Solar</li> <li>Will Prowse Review (YouTube) (OLDER Version)</li> </ul> <p>The EG4-LL batteries are 48v rack-mountable batteries, with a total of 5.12kwh per battery. The form factor leads to being able to put together a quite dense storage solution, which doesn\u2019t require nearly as much footprint as opposed to using the above batteries.</p> <p>One of the features which really sold me on these batteries- They offer multiple solutions for communication. You can chain the batteries communication ports together, which can be connected to your inverter, allowing all of the components to talk together.</p> <p>As well, the batteries include a LCD panel, which displays lots of useful information such as individual cell voltages, temps, etc. There is also LEDs to display the current battery state of charge.</p> <p>The price here, works out to 341$ per Kwh of storage. While, this is more than the above Ampere Time battery- this battery has MANY more usable features.</p> <p>I will note, these batteries are the same as Gyll.</p> <p>I also have a post on Assembling the EG4 Rack</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#diy-build-your-own","title":"DIY / Build your own","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#120-200-kwh","title":"120-200$ / kwh","text":"<p>Building your own battery packs is a topic I see very frequently\u2026. and, for good reason.</p> <p>Why? Because you can generally build a complete system for FAR cheaper then you would otherwise be able to do.</p> <p>If, you were to want to take this route, the cells are generally 3.2 volts each. I would recommend building 48v cell packs to reduce the amount of copper required to connect everything together, and to improve the overall efficiency. (48v inverters are generally smaller and cheaper as opposed to 12v).</p> <p>So, 48/3.2 = 16 cells needed in series to hit 48v. = 51.2v maximum.</p> <p>For around 3,500$, I found a random seller on aliexpress, selling 32 * 280ah cells. This would be good enough to put two strings in parallel, for a total of\u2026</p> <p>51.2v * 280 ah * 2 sets = 28.672 kwh of capacity, for 3,500$.</p> <p>Your total cost here, would be around 122$ per kwh, which is under half of the above solutions.</p> <p>BUT, there are a few more things to factor in.</p> <p>You would need\u2026 a good BMS, bus bars, and a mounting solution.</p> <p>You also have to wait months for a boat to arrive from china, you have to HOPE all of your cells arrived un-damaged, and unbloated\u2026. and, overall, you have to accept the risk.</p> <p>In the event you do received damaged cells, getting replacements or refunds may be a huge ordeal. Having to ship cells back to China, generally means\u2026. its cheaper to just accept the loss.</p> <p>In addition to the above risks- you will also be paying between 100$ -&gt; 500$ for a good BMS solution.</p> <ul> <li>Will Prowse Assembling Bank(YouTube)</li> <li>More Will Prowse</li> <li>Will Prowse - Why people aren't buying raw cells</li> </ul>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#other-options","title":"Other Options","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#battle-born","title":"Battle-Born","text":"<ul> <li>Buy at Battleborn</li> <li>Teardown - Will Prowse</li> </ul> <p>I really have never heard anything negative regarding the quality of capabilities of battle born. If you are adding solar to an RV, these are likely one of your best choices due to the inclusion of heating elements in the batteries. However- for the bulk-capacity needed for a home- This solution isn\u2019t very cost-effective.</p> <p>The 12v heated cells, are\u2026 around 790$ / kwh, which is around double of some of the other options.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#victron","title":"Victron","text":"<p>Like battleborn- Victron produces high quality components. Also- like battle born, these components have a premium price tag.</p> <p>Having used Victron components in my previous Portable Power Supply / UPS, the Victron components were extremely flexible, and easy to use. They also integrated extremely well with other systems.</p> <p>But- for the bulk storage needs of my house- I cannot afford the price premium here. If price was not a factor, I would likely opt for Victron, due to all of its potential integrations.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#storz","title":"Storz","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#1500-2000-kwh-estimated","title":"1,500 \u2013 2,000$ / Kwh ESTIMATED","text":"<p>So, originally when I reached out to my solar installer, Their recommended battery was the Storz 10kwh.</p> <p>While, I have not heard anything negative around these batteries\u2026. and they do have a great warranty (15 years), I felt they were a bit pricy.</p> <p>While, I cannot find any publicly available information, and I was unable to get the exact price of this solution, I estimate their 10kwh solution would cost between 15-20,000$.</p> <p>I don\u2019t know how much was parts / labor / etc., so, this is just a ballpark estimate\u2026</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#tesla-powerwall","title":"Tesla Powerwall","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#851-kwh","title":"851$ / kwh","text":"<p>The Tesla Solarwall, has 13.5 kWh of capacity, and costs around 11,500$.</p> <p>This option has fancy apps you can look at on your phone to see its performance. While, this option has a few fancy features- I don\u2019t like the idea of the battery / inverter / everything being an AIO solution. I like the idea of being able to choose a different vendor\u2019s inverter depending on the price / features / availability.</p> <p>As well, Tesla has been receiving a lot of negative press lately regarding warranties, shoddy solar installations, etc. In the end, I will pass on this option.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#2022-ford-f-150-lightning","title":"2022 Ford F-150 Lightning","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#407-kwh","title":"407$ / kwh","text":"<p>Wait- this is a truck, not a battery... right?</p> <p>Correct. However- I felt this actually deserved a place on this post. Why? </p> <p>Because it offers bi-directional energy transfer. </p> <p>Post from FORD. Home-backup features are literally being provided as a feature supported by Ford.</p> <p>It has a ~10kwh inverter on board, with 98kwh of battery capacity. As such, it makes a competitive alternative. (And, it doubles as a truck!)</p> <p>Also- Why the 2022 model specifically? Because the 2023 model doubled in price, for the same capacity. (Went from 39k MSRP to 52k MSRP)</p> <p>$39,974 MSRP / 98 Kwh battery = 407$ per Kwh.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#lead-acid-car-batteries-golf-car-batteries","title":"Lead-Acid (Car Batteries / Golf car batteries)","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#100-kwh","title":"~100$ / Kwh","text":"<p>Overall, lead-acid is THE CHEAPEST <code>upfront</code> option for energy storage. Emphasis on <code>upfront</code>.</p> <p>If that is the case, why were they not considered / used?</p> <p>The quick and easy anwser- LiFePo4 will generally last 20-30 years, Lead-acid will typically need replacement around 5 years. </p> <p>In the long-term(10-30 years), LiFePO4 is cheaper.</p> <p>Typical lead-acid batteries will quickly lose capacity when discharged below 50%, and will only be able to provide &lt; 50 full cycles. Deep-cycle batteries designed for this, and are typically rated up to around 6 years.</p> <p>As such, for a typical starting battery, this means only half of the stated capacity is available.</p> <p>For deep cycle batteries, assuming full discharge cycles every day- you will get between 1-5 years of use on average. </p> <p>A typical Lithium Iron Phospate battery, is generally good for 3,000 or more full discharge cycles.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#nickle-iron","title":"Nickle Iron","text":"","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#1000-kwh","title":"~1,000$ / kwh","text":"<p>Nickle-Iron, also known as the Edison battery, technology dates back over 100 years ago. It was orignally developed in 1901 by Thomas Edison.</p> <ul> <li>Buy Iron Edison Batteries</li> </ul> <p>Pricing is based on 1,040$ per 800ah 1.2v cell from the above link. </p> <pre><code>800ah * 1.2v = 960wh per 1,040$ cell = ~$1,000 per 1kwh of capacity.\n</code></pre>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#why-is-it-being-included","title":"Why, is it being included?","text":"<p>Because it has a typical life expectancy measured in decades. There are 50 year old NickleIron batteries still in use in the train industry. These batteries are extremely durable, and servicable.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#what-are-the-downsides","title":"What are the downsides?","text":"<ul> <li>Constant maintenance is required. You will frequently need to top off the water level in the cells.</li> <li>Power density. These batteries are large and heavy, and have a lower power density compared to other options.</li> <li>Expensive. For- some reason, despite using commonly available elements, and century old technology, these batteries are quite expensive.</li> <li>Efficiency. These batteries have high self-discharge rate, charge slowly, and release energy slowly.</li> </ul> <p>More or less, everything about these batteries is a downside, other then, extremely high cycle endurance.</p>","tags":["Solar"]},{"location":"blog/2022/home-solar-project---part-2---battery-selection/#what-did-i-choose","title":"What did I choose?","text":"<p>In the end, I went with the EG4-LL batteries.</p> <p>I felt it has the best balance of available features, performance, and warranty. I wanted something that looked nice, and I really enjoyed the rack-mount enclosure also offered by Signature Solar.</p> <p>While, I debated on the cheaper Ampere Time / Chins batteries- I really liked the idea of a simple, dense rack of batteries in the garage. And- while the EG4-LifePower4 batteries offered a better price, I like the idea of the extra features offered by the EG4-LL batteries.</p> <p>I\u2026 am a sucker for features.</p> <p>Note- Prices / Price per Kwh listed is as of December 2022</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/","title":"Home Solar Project - Project Installation","text":"<p>Installation of my home solar project.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#finished-product","title":"Finished Product","text":"<p>I will start this post out with the finished product, and save a few pictures of the installation for later on.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#garage","title":"Garage","text":"","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#batteries","title":"Batteries","text":"<p>The black box on the left, is my EG4 Battery Rack. At this time, it contains a pair of 5,120wh 48v EG4-LL batteries for a total of ~10kwh of storage.</p> <p>These batteries are wired in parallel. The rack contains a bus bar on the left/right.</p> <p>Interior view: </p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#back-wall","title":"Back Wall","text":"<p>On the back wall- starting from left to right-</p> <p></p> <ol> <li>Solark-12k inverter.</li> <li>The top-middle box, is the critical loads panel.<ul> <li>Everything in this panel, is fed directly from the inverter. In the event of grid loss, this panel will be switched over to battery/inverter in around 4ms.</li> </ul> </li> <li>The far right box, is my main panel.<ul> <li>This panel, will also be fed in the event grid power is lost. However, it takes slightly longer for the ATS to redirect power to here.</li> </ul> </li> <li>The small grey box under the channel, on the left, is a \"passthrough\" box. This allows cables to travel under the house, to a box on the exterior/back wall of the house.</li> <li>The small white-ish box under the channel on the right, is the \"tigo optimizer\"<ul> <li>It talks to the panel, collects data, and... \"does stuff\"</li> </ul> </li> </ol>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#inverter","title":"Inverter","text":"<p>A quick glimpse inside of the inverter.</p> <p></p> <p>Lots of people were questioning why so many conduits ran into the inverter. While- yes- fewer could have technically been used... This is nicer to look at.</p> <p>The inverter does offer a nice display, which will show all of the critical details at a glance. You can also drill into battery status, panel status, etc.</p> <p></p> <p>Do note, at the time of writing this, the PV is disconnected until the proper approvals and inspections from my utility are acquired.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#main-backup-panel","title":"Main / Backup Panel","text":"<p>A quick shot with both the backup panel (left) and main panel (right) open. Nothing too fancy in here.</p> <p></p> <p>The 60amp breaker in the middle-right of the backup panel, feeds the emergency input of the automatic transfer switch. When power flips off- this breaker will feed the main panel.</p> <p>The 50 amp plug on the bottom-right of the main panel, is an extra hookup for my welders / plasma cutters / etc.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#exterior-wall","title":"Exterior Wall","text":"<p>Going over the exterior wall- From left to right (Ignore the bottom, for now.)</p> <ol> <li>Solar rapid-shutdown switch. This switch will disable all solar production. Required by code.</li> <li>Automatic transfer switch.<ul> <li>It will switch between grid power, when available, and inverter output when grid is unavailable. Completely automatic in both directions.</li> </ul> </li> <li>Grid-disconnect switch.<ul> <li>This will disconnect the entire house from the grid. Also- required by code. </li> <li>Useful to have when working on the electrical system. Before- completely killing energy required calling the electrical company to come out and remove the meter.</li> </ul> </li> <li>Meter. Measures energy bi-directionally.</li> </ol> <p>The crooked box on the right, is the OLD ADSL box from my ISP, which needs to be removed from the side of my house.</p> <p>The grey box on the bottom, is the passthrough box, containing circuits / cable going from the garage to this exterior wall. Do note- the two locations are around 20 foot away.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#the-roof","title":"The Roof","text":"<p>The solar panels.</p> <p></p> <p>Do note, this picture was taken before everything was completed. </p> <p>As such, you can see what is inside of the passthrough box.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#the-installation","title":"The Installation","text":"<p>The entire installation process took two and a half days to complete.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#day-1-mounting-hardware-pv-panels","title":"Day 1. Mounting Hardware &amp; PV Panels","text":"<p>For day 1, all of the electrial hardware was mounted in both the garage, and exterior of the house. Wiring between these locations was completed as well.</p> <p>A seperate crew installed all of the solar panels and hardware on the first day.</p> <p>Here is how the garage looked after the first day of work.</p> <p></p> <p>Here is a shot of the exterior wall, after the first day.</p> <p></p> <p>Note, the new meter box is not connected to anything yet. The old meter box is in the way!</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#day-2-relocating-mains-removing-old-hardware","title":"Day 2. Relocating Mains &amp; Removing Old Hardware","text":"<p>Day two, was mostly spent with a team of 4 electricans \"relocating\" my old mains panel.</p> <p>The day started out with my utility company disconnecting the mains from my house, so that work on the main panel could begin.</p> <p>To- give you an idea of why I elected to move the mains panel- lets have a look at it!</p> <p></p> <p>Now, this is AFTER most of the wiring had been removed from it. I am reluctant to show the \"before\" picture- because it was a literal deathtrap of wiring.</p> <p>The best I can figure, this box has been in place for the last 50 years. It was past-due to be upgraded.</p> <p>I will note, this process took the most time of this project. This is also a step most people will not need to worry about.</p> <p>But, due to the location, and condition of my mains panel, I felt it was best to go ahead and upgrade this.</p> <p>Everything inside of the main panel was eventually removed.</p> <p></p> <p>The panel was put back into place, and screwed shut. There are no electrical components remaining inside of it.</p> <p>After all of the circuits were pulled up into the attic- they were rerouted into a jbox, sitting above the conduit going into the new mains box. This junction box, has romex coming in from the attic, which is spliced into THHN/THWN, which then runs down the conduit into the panels.</p> <p>THHN/THWN, in laymans terms, is single-strand wire, without the insulation jacket.</p> <p>For the exterior of the house, most of the wiring here was completed on day 2. A mast/weatherhead was also installed after the old meter box was removed.</p> <p>The mains were reconnected to the new meter around 6pm in the evening.</p> <p>Here is a mid-day shot of the work on the exterior, on day 2. Note, the new mast was already installed, the old meter removed. The visible CT clamps are directly connected to the inverter.</p> <p></p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#day-3-finishing-up","title":"Day 3. Finishing Up.","text":"<p>There were only around 3-4 hours of work left to be completed on the final day. For this final day, only two crew members were required.</p> <p>The generator plug was added to the exterior of the house, and connected to the inverter.</p> <p>The crew finished up programming the inverters/optimizers/panels. Everything was tested and labeled.</p> <p>We tested... 1. To ensure the automatic transfer switched worked as expected.     * The critical loads remained powered the entire time.     * When a generator is connected, it would automatically start charging the batteries, and provide passthrough to the home.     * The automatic transfer switch automatically reset when grid power was restored. 2. Ensured all of the breakers were correctly labeled. 3. Communication was working properly between the various components.</p> <p>The remaining crew members were able to make pretty quick work of the remaining items, and left around noon after validating the system was working as expected. </p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---installation/#the-overall-experience","title":"The overall experience?","text":"<p>While- I cannot remember names to save my life- The entire crew was very pleasent to work with.</p> <p>I had a lot of questions, they were able to anwser all of the questions. As well, we were able to easily handle a few on the fly modifications as required for this project.</p> <p>The crew showed up on time, and was hard at work all day, until late in the evening. Power was only cut on the 2nd day, when the mains were being relocated.</p> <p>When crew members were inside of the house- they were very considerate of the surroundings. They knocked before entering the house, despite me telling them the door is open.</p> <p>And, not once did any of the members present any bad attitude at all, even after crawling around in my attic all day pulling wire. (It is not a very pleasant place.)</p> <p>Lastly- there was no mess left behind. Everywhere they went- was swept clean. No trash was left behind.</p> <p>Overall- a very good experience. I would highly recommend. 5/5</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/","title":"Home Solar Project - Adding Monitoring and Data Collection","text":"<p>Part 4 of the home solar project. Adding monitoring tools and hardware.</p> <p>Will be adding Iotawatt for per-circuit energy monitoring, and solar-assistant for monitoring the performance of my inverter / batteries. </p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#planning","title":"Planning","text":"<p>Previously, I have used Iotawatt with great success. The interface works well, and getting data into home assistant has been extremely easy.</p> <p>If you are interested in eithe this solution, or seeing other potential options for home energy monitoring, Please check out Home-Assistant Energy Monitoring Options.</p> <p>As I still have the hardware and software ready for this- I will be re-implementing this.</p> <p>Next up, for monitoring the performance and metrics of my inverter / batteries, I decided on Solar-Assistant.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#part-1-adding-a-new-electrical-box","title":"Part 1. Adding a new electrical box","text":"<p>For this project, I want to add a new sub-panel to help keep everything better organized. I don't want to end up in a scenario, where there is essentially a rat's nest inside of my mains panel.</p> <p>For reference- here is what I don't want to do:</p> <p>(Also, to give you an idea of why I elected to replace my mains panel during this project)</p> <p></p> <p>Since, I will need CT Clamps in both my main, and secondary panels, it would be best to have a new box connected directly to both panels.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#tools-used","title":"Tools Used","text":"<p>For the installation, I really only needed a few tools.</p> <p>Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#sawzall-or-other-way-to-cut-conduit-to-size","title":"Sawzall, or other way to cut conduit to size.","text":"<p>I have really enjoyed all of my Miluakee tools. I recently added the saw-zall to my collection, for the purpose of cutting up scrap for smelting I do on the side.</p> <p>For this project, it came in extremely handy for cutting the conduit to size.</p> <ul> <li>Amazon - Milwaukee M18 Fuel - 2821-20</li> <li>Amazon - Milwaukee 42-22-1129 - Sawzall Blade Set</li> </ul> <p>For drilling holes in the metal boxes, you will need a drill, and some hole-saw bits. Again, I strongly recommend milwaukee if you don't already have a suitable drill.</p> <ul> <li>Amazon - Milwaukee M18 Fuel - 2903-20 Drill</li> </ul> <p>Since, I frequently find myself drilling large holes (building dashboards for race-cars, installing mini-splits, etc....) I personally picked up the 49-22-4185</p> <ul> <li>Amazon - Milwaukee 28 piece bi-metal hole saw kit</li> </ul> <p>However, if you didn't want to buy a full set, you can also buy a single 1\" hole-saw bit. Just- make sure to get the arbor/bit with it.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#hand-tools-crimpers-pliers-etc","title":"Hand Tools, Crimpers, Pliers, etc.","text":"<p>For crimping / terminating CAT5/CAT6, I HIGHLY recommend the klein crimper.</p> <ul> <li>Amazon - Klein VDV226-110 Crimper / Stripper</li> </ul> <p>This crimper, makes very easy work of crimping cable. The days of having to redo crimps, and bad crimps are all over! I get a PERFECT crimp every single time.</p> <p>Just- don't forget the push through connectors to go with, Trust me... It makes a world of difference.</p> <ul> <li>Amazon - Klein Pass-through RJ45</li> </ul> <p>Neither of these tools are required. You can also use a generic crimper. But- trust me, if you find yourself terminating cable quite frequently- these tools are WELL worth it.</p> <p>As well, if you don't already have a good set of wire cutting pliers- Klein makes a very high quality set.</p> <ul> <li>Amazon - Klein Wire Cutters</li> </ul> <p>A pair of flush cutters comes in handy too, when you need to trim something with extra percision. These are also useful for removing hang-nails. (the ones on your fingers.)</p> <ul> <li>Amazon - Klein Flush Cutters</li> </ul> <p>If you don't already have a file, you may want to pick up one, in addition, to a deburring tool. This will be needed when you cut the conduit.</p> <p>The deburring tool, removes the sharp points left over. You don't want sharp points left inside of your conduit when passing through cables carrying electricity.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#hardware-used","title":"Hardware Used","text":"<p>I ordered all of my hardware from home-depot. I would recommend... picking everything up in the store.</p> <p>If you choose deliver to your home, there is a good chance you will receive 20 seperate shipments, with random pieces missing in the middle. Home depot has not been the most effective at delivering items....</p> <p>This is the box which I will mount all of my hardware into. * Weigmann Box - Gray</p> <p>Since, I will need electric to power my hardware, I also picked up a box to hold an outlet.</p> <ul> <li>Steel City - Utility Box</li> <li>Steel City - Utility Box Cover</li> <li>15 Amp Outlet</li> <li>Knockout Connector / Strain Relief</li> </ul> <p>For the conduit work, I already had a piece of 1\" EMT conduit. However, here are links:</p> <ul> <li>1\" EMT Conduit - 10ft</li> <li>EMT Compression Connectors</li> </ul> <p>Finally, we need hardware to mount the box to the wall. Since, I wanted my add-on box to resemble the rest of the hardware installed, I decided to mount it using struct channel.</p> <ul> <li>12ga Strut Channel - 2 ft</li> <li>Struct Channel Spring Nuts</li> <li>3/8\" bolts</li> </ul> <p>All togather, the hardware costed me 112$ after-tax, including a lot of extra items which I didn't not use/need.</p> <p>Warning</p> <p>Make sure to go pick up these items in person....</p> <p>I personally, have not had the best experiences with home depot's shipping. I have previously received damaged items, which needed to be return, or just not received items at all.</p> <p>From this particular order, two of the items in my order were never received. </p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#planning-and-execution","title":"Planning and Execution","text":"<p>After doing a bit of measuring, I cut 1\" holes into the bottom of the new add-on box for the conduit. I cut out 2 6\" sections of conduit to go into the bottom.</p> <p>For cutting conduit, I used a my vice to hold the tubing, and then cut it to length using a sawzall.</p> <p></p> <p>Warning</p> <p>Make sure to properly debur the inside of the conduit after cutting it! Sharp, pointy metal does not get along with live electrical cables!!!</p> <p>As well, in order to properly fit into the connectors, you will need to file the outside of the conduit smooth.</p> <p>Then, using the connectors, I mounted these to the bottom of the add-on box. After these sections were mounted to the new box, I was able to mock up where I felt the box would be best.</p> <p></p> <p>I felt this position would give direct access to both panels for installing CT clamps, as well as, allowing me to run another conduit to the duct below. </p> <p>For drilling holes into the box (When you don't have a knockout in the ideal location), use a center punch to make a small dimple, then let your hole-bit do the rest of the work. Here is a picture after drilling the middle hole.</p> <p></p> <p>Next up, it was time to plan out and mark the locations for installing the rails.</p> <p>I started by attaching the rails using the 3/8\" bolts, and spring nuts. To cut the rails, I again, used the sawzall.</p> <p></p> <p>After these rails were mounted, I was able to put the box into place, and mark the location on the wall where the rails would need to be attached.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#drilling-into-the-mains-panels","title":"Drilling into the mains panels","text":"<p>Everything up to this point, has been executed with very little risk, and has remained outside of the mains panels.</p> <p>Danger</p> <p>If you do not know EXACTLY what you are doing, Hire a licensed electrician.</p> <p>Live electricity WILL kill you.</p> <p>But- now, it was time to drill holes into the mains panel.</p> <p>After opening the panels, you will need to remove the covers.</p> <p></p> <p>Since, metal filing and live electricity has a large potential of causing issues, I used a piece of cardboard with a magnet taped on the back to catch and/or deflect metal shavings from the interior of the panel.</p> <p>Info</p> <p>If you place your magnet inside of a plastic bag, it makes it much easier to seperate the shavings from the magnet.</p> <p></p> <p>Here is what this looks like from back a few steps</p> <p></p> <p>For the critical-loads panel, the same steps were taken.</p> <p></p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#running-middle-conduit","title":"Running Middle Conduit","text":"<p>After drilling holes into both panels, I mounted the new box, and leveled it. Leveling the box is extremely important.</p> <p></p> <p>Once the box was leveled, I measured the length from the box, to the duct on the bottom, and then cut a piece of conduit.</p> <p>After mounting the conduit into the add-on box, I leveled it. Make sure to level it on BOTH sides.</p> <p></p> <p>After the conduit was perfectly level, I traced around it using a sharpie.</p> <p></p> <p>Finally, I used a center punch to make the center of the hole, used a magnet+cardboard to keep shavings out of the duct, and drilled a hole.</p> <p></p> <p></p> <p>After this point, the box was leveled, all of the connectors were tightened, and everything was properly secured.</p> <p>Not shown-</p> <p>I installed a single outlet into the add-on box to provide power for the hardware used for data collection. It was wired into a dedicated breaker on the critical-loads panel, which is on battery-backup. Since we are using a metal box, make sure to tie the ground into the metal box.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#reinstalling-iotawatt","title":"Reinstalling Iotawatt","text":"<p>The first step here- was to acquire my existing Iotawatt hardware.</p> <p></p> <p>After mapping out which circuits I wanted to monitor- I started connecting the CT Clamps and routing the cables.</p> <p></p> <p>After I was happy with the routing, I checked the Iotawatt website to verify all of the clamps were reporting correctly. Do note, the direction of clamps DOES matter.</p> <p></p> <p>If, you notice a \"reverse\" icon next to any of your loads, or, you notice something weird, such as circuits using negative electricity, you likely have a clamp installed backwards.</p> <p>Either, you can reinstall the clamp facing the correct direction, or Iotawatt can reverse it for you in software. I elected to point my clamps in the correct direction.</p> <p>For any 220v loads, you will need to select the \"double\" option to more accurately report energy consumption.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#not-shown-solar-assistant","title":"Not shown - Solar-Assistant","text":"<p>During this time, I also installed my solar assistant into this add-on box.</p> <p>If, you wish to read more, there is a seperate post: Installing Solar-Assistant</p> <p>Cat6 was ran between my serial adaptor, and my inverter via the middle-conduit channel. The middle channel's primary use is for holding data lines. As such, there is no electrical lines running down the middle conduit.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#final-thoughts","title":"Final Thoughts","text":"<p>At this point after installing Iotawatt and Solar-assistant, the only work left to do, was to start re-assembling all of the panels, and picking up my tools.</p> <p></p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#wifi-connectivity","title":"Wifi connectivity?","text":"<p>For connectivity, I am using wifi for both the solar-assistant, as well as Iotawatt. </p> <p>While, the majority of the internet will tell you.... you cannot mount a wifi appliance inside of a metal box and expect it to work- I will tell you- the internet is not always correct.</p> <p>For reference, as of the time of this post, everything has been running for over a week, with no issues at all.</p> <p>Here is what unifi says:</p> <p>I will note, the u6 pro is actually the furthest away AP in my house. There is an AP literally on the other side of the wall from these devices. I'd say- the u6 pro is around 20-25 feet away, through multiple sheetrock walls.</p> <p></p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#the-end-result","title":"The END result.","text":"<p>For the end result, I have quite a few dashboards in various systems.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#home-assistant","title":"Home-Assistant","text":"<p>First up, is the home-assistant energy dashboard</p> <p></p> <p>This dashboard is fantastic for giving me a quick glance into what the overall status was for a given day. As well, I can quickly view a weeks worth of consumption.</p> <p>As well, I have a dashboard for my Office Kiosk to show quick stats at a glance.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#solar-assistant","title":"Solar-Assistant","text":"<p>Solar-assistant provides both real-time reporting as well as historical data reports.</p> <p>Here is the main screen, which gives real-time data.</p> <p></p> <p>Here is the totals screen, which keeps daily / monthly aggregations</p> <p></p> <p>In addition to containing reporting capabilities, solar-assistant also integrates extremely well with home-assistant, and even exposes functionality for home-assistant to change inverter parameters and operating modes.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#iotawatt","title":"Iotawatt","text":"<p>Iotawatt contains  both a simple interface for showing current real-time data:</p> <p></p> <p>As well as a data reporting interface</p> <p></p> <p>Like solar-assistant, its onboard data collection is a massive benefit. Both of these devices will store potentially decades worth of data on-board.</p> <p>So, if your historial data ever gets purged due to retention from home assistant, influx, or prometheus, having all of your data retained on these devices is a very nice benefit.</p> <p>These devices BOTH will function completely stand-alone as well, with no network connectivity.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---part-3---monitoring/#conclusion","title":"Conclusion","text":"<p>I am very satisfied with how this project turned out. </p> <p>To me, the installation job looks great, and the data I have been collecting, has been very valuable from a planning standpoint.</p> <p>Lastly- this data will be crucial for calculating the on-going ROI to determine if this project is worth it.</p> <p>For those wondering if its worth it- I will let you know in about a year.</p>","tags":["Solar","Energy Monitoring"]},{"location":"blog/2023/home-solar-project---next-steps/","title":"Home Solar Project - Next Steps","text":"<p>Continuation of the home solar project. </p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---next-steps/#current-state","title":"Current State","text":"<p>As of the creation of this post, my system is technically \"complete\", and there are no additional items planned for changes/removal via my installer.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---next-steps/#adding-more-insulation","title":"Adding more insulation","text":"<p>As apart of the contract with my solar-installer, the insulation in my attic was brought up to 20 inches.</p> <p>To give an idea, areas of my attic barely had 2-3 inches.</p> <p>Here are a few before/after shots. In the before shots.</p> <p>Facing East </p> <p>Facing West </p> <p>I imagine the impact from this will be extremely noticable, especially once it starts warming up outside. During the summer of last year- we experienced average termps of 100-110F every single day, for nearly two months.</p> <p>My A/C was running constantly, leading to over 3Mwh of consumption, per month.</p> <p>For reference, here is my electrical usage for the last two years.</p> <p></p> <p>3.5Mwh = 3,500Kwh * 0.08c/Kwh = 280$ worth of electricity.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---next-steps/#future-projects","title":"Future Projects","text":"","tags":["Solar"]},{"location":"blog/2023/home-solar-project---next-steps/#adding-more-battery","title":"Adding more battery","text":"<p>The net-metering agreement with my utility provider, is not the  best.</p> <p>When I consume energy from the grid, it costs me 0.08c/kwh.</p> <p>When I push excess energy back to the grid, I receive 0.03c/kwh.</p> <p>So, it is in my best interest to be able to store all of my production into battery, and release when needed.</p> <p>To visualize this trend- here is daily stats coming from solar-assistant.</p> <p></p> <p>As you can see, during the heating season, I pretty consistently consume around 30Kwh of energy per day.</p> <p>The issue in the metrics here- See the grid exported column. If we are pulling energy from the grid, AND, exporting energy to the grid- we don't have enough battery storage.</p> <p>To better demonstrate this, here is a graph I setup in Grafana, showing yesterday's data.</p> <p></p> <p>The gred area, is grid usage. Notice- during the early morning hours, my battery is essentially empty (I have a 40% reserve set), and most of my energy is pulled from the grid.</p> <p>When the sun comes out (yellow area), by around noon-1pm, my batteries are fully charged, at which point I start dumping excess production to the grid. (Red area below the center)</p> <p>Well, when the sun starts going down, battery usage ramps up. The problem is- After 4-6 hours, the battery is hitting my reserve limit of 40%, at which point, battery consumption tapers off, and grid usage climbs.</p> <p>From 10pm to 8am, the bulk of my power comes from the grid.</p> <p>Since- I know my daily off-season energy consumption is 30-34kwh, My plan is to scale my DC system up to 30kwh of total capcity. This should be enough to allow me to store/release my energy all night.</p> <p>(Also- to scale beyond 30kwh, I would need to add an additional battery rack.)</p> <p>So- in the next month or two, look forward to seeing the addition of 4 new 48v 5kwh batteries.</p>","tags":["Solar"]},{"location":"blog/2023/home-solar-project---next-steps/#estimating-roi-savings","title":"Estimating ROI / Savings","text":"<p>As the year goes on, I will be estimating the savings / ROI of this solution. However, it will take a full year before I can get an accurate anwser as to, \"Was this worth it\".</p> <p>I think the summer will tell a very interesting picture- especially when I am able to produce a lot more energy, for a longer duration.</p> <p>And- since, lots of sun generally means, lots of heat, I think this should offset a large chunk of the HVAC consumption.</p> <p>But- only time will tell. Stay tuned.</p>","tags":["Solar"]},{"location":"blog/2021/1040g-home-network-upgrade/","title":"10/40G Home Network Upgrade Project and Costs","text":"<p>This is the original documentation for when I deployed 10G out to my network.</p> <p>This post was migrated from the old wordpress site, mostly unaltered from its original form.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#disclaimers","title":"Disclaimers","text":"<p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#how-much-did-it-cost","title":"How much did it cost??","text":"<p>Prices includes shipping and tax, except for the last two rows. Amazon did have free shipping through.</p> Part Quantity Price Source Mellanox MCX311A-XCAT CX311A ConnectX-3 EN Network Card 10GbE SinglePort SFP+ 1 $40.61 eBay Dell 3 meter QSFP+ Passive Direct Attach Cable DAC Dell DDWP2 1 $37.12 eBay Mellanox ConnectX-3 VPI 40 / 56GbE Dual-Port QSFP Adapter MCX354A-FCBT High Pro 1 $53.48 eBay SFP+ 10G 10Gbps 10GbE Passive DAC Direct Copper Cable 5m New In Bag 1 $13.81 eBay BROCADE ICX6610-48P-E 48-PORT 1G RJ45 PoE+ 8x 1G SFPP 4x 40G 2xP/S 1x FAN SWITCH 1 $152.83 eBay Lenovo Intel X540-T2 10Gb Dual Port Adapter 49Y7972 Low Profile G46477-003 1 $54.57 eBay 6COM 10GBase-T SFP+ Transceiver, RJ45 Copper Module 2 $91.68 Amazon SFP+10GBASE-T Transceiver Copper RJ45 Module 2 $74.00 Amazon MikroTik CSS610-8G-2S+in 1 $103.99 Amazon Total $622.09 <p>One third of the cost, was for 10GBase-T RJ45 10G Modules. If I had instead obtained fiber or SFP NICs, the price would have been quite a bit lower. Nearly one half of the cost, was because I purchased two new switches to support 10/40G NIC. I upgraded both my core switch, as well as the switch in my office/bedroom to 10G capable switches.</p> <p>If you didn't need a 10/40G capable switch, the price will be much lower. As well, if you leverage SFP+ NICs instead of 10GBase-T, the price will be much lower.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#testing-setup","title":"Testing Setup","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#network-configuration","title":"Network Configuration","text":"<p>Everything is done over the DEFAULT 1,500 MTU side. I did NOT utilize Jumbo frames, or 9,000 MTU settings anywhere. While, this could certainly improve performance, I did not want to try to rearrange the vlans/laggs on my firewall to try and put a 9,000MTU vlan, on TOP of a 1,500MTU default vlan.</p> <p>As well, I did no configuration of transmit or receive buffers. I don't even know what they are configured to. I did not touch them, or even look at them.</p> <p>This is NOT a clean room test. I did not stop ANY services on my network while performing these tests. I am not publishing a magazine here, and I just wanted basic, real-world test results. I did no configuration on any of the NICs. I did not try to maximize performance at all. I plugged the NIC into my PC, gave it an IP address, and started testing.</p> <p>As well, I did not disable any caching. In the real world, my server will still have 128GB of ram.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#devices-utilized","title":"Devices Utilized","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#my-pc","title":"My PC","text":"<p>refers to my Gaming PC. Unraid has long since been retired, and all services are running on my server now. It is using a ConnectX-3 NIC for 10G, with a DAC connecting to my office/bedroom switch. For 1G testing, it utilizes the intel ethernet port on its motherboard.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#my-server","title":"My Server","text":"<p>refers to my Dell R720XD. Its specs:</p> <p>CPU: Dual Xeon E5-2695v2 (Total of 24 cores, 48 threads)</p> <p>RAM: 128GB DDR3 ECC</p> <p>Spinning Array: 8x8TB seagate exos. 2 hot spares. Raid Z2</p> <p>NVMe Array: Dual 1TB samsung 970 evo. Mirrored.</p> <p>NIC: ConnectX-3 with QSFP+ DAC to core switch at 40Gbit/s</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#my-firewall","title":"My Firewall","text":"<p>refers to my opnsense firewall, hosted on a HP SFF z240 PC, with a quad core i5, 8gb of ram. It utilizes a X540 based 10GBase-T Dual Port NIC, with both links in a single LACP.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#network-diagram","title":"Network Diagram","text":"<p>SMB/ISCSI performance was performed between \u201cThe Gaming PC, at the bottom left\u201d, and \u201cMy server\u201d on the left.</p> <p>Also- as noted in the diagram, the links are my existing CAT 6, with the exception of two DACs.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#testing","title":"Testing","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#network-speedtest","title":"Network Speedtest","text":"<p>The first round of tests I wanted to perform- just simple network speed testing.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#pc-to-firewall","title":"PC to Firewall","text":"<p>After initially connecting the 10G NIC, and running a speedtest (hosted on my server, which is connected to the core switch with a 40G link), I noticed I was only pulling about 2Gb/s.</p> <p>Edit- The cause of poor firewall performance was due to the power savings configuration it had at the time. After adjusting the power savings configuration, it does full speed no problem now.</p> <p></p> <p>It appears my poor quad core i5, cannot process more then 2Gbit/s while applying rules/IPS/ACLs/etc\u2026 However- that is still an extremely respectable amount of throughput for full stateful inspection, DPI, IPS/IDS. I then, ran iperf tests, and again, only got about 1.5Gbit/s.</p> <p></p> <p>So, at this point, I am going to test throughput directly from my windows client, to my server, over its vlan without the firewall involved. BUT, first- another issue\u2026.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#pc-to-server","title":"PC to Server","text":"<p>The first test- was to simply run my docker-speed test. Right off the bat, it did a solid 10Gbps, with a default network MTU of 1,500.</p> <p></p> <p>On the core switch, I was able to confirm 98% utilization in both directions.</p> <p>Now that I am certain that I am able to get full performance between my PC, and the server, let\u2019s do some more testing!</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#server-40g-testing","title":"Server 40G Testing","text":"<p>A few days ago, I did post a thread on reddit, showing that I was able to fully utilize the LAGG between my firewall, and my server.</p> <p></p> <p>Original tests performed a few days ago.</p> <p>Since- I was able to use up to 20 gigabits of the connection, I did not feel the need to do further testing all the way up to 40- because, lets face it- even 10G for the most part is complete overkill.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#testing-smb-file-share-performance","title":"Testing SMB / File Share Performance","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#10g-smb-performance-to-spinning-disk-array","title":"10G SMB Performance to Spinning disk array.","text":"<p>First- I mapped a drive to a share hosted on my server\u2019s spinny disk array, over the 10G network.</p> <p></p> <p>My first thoughts while watching this test- Holy crap. It\u2019s actually pulling FULL 10G performance to my array of SPINNING DISKs. Note- I did NOT stop any services while performing this test. My NVR was still recording. My Plex is currently streaming, and all of the other 50 or so docker containers are still active.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#1g-performance-to-spinning-disk-array","title":"1G Performance to spinning disk array","text":"<p>As- I had already done the 10G test, I really just expected 1/10th of the throughput from its test. Well, I was in for a surprise.</p> <p>The test actually came in, underperforming, in my opinion. Remember- this is hitting the exact same destination. Only- over a 1G link instead of 10G.</p> <p></p> <p>Throughout the tests, I did keep an eye on the server\u2019s stats. CPU remained very reasonable.</p> <p></p> <p>Disk I/O showed something interesting. It showed I could likely use quite a bit more bandwidth before my array became a bottleneck. I imagine each of my exos drives could do a fair amount more I/O. 76MB/s is nothing.</p> <p></p> <p>But- let\u2019s move on to testing out the performance of SMB hitting my NVMe pool.</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#10g-smb-performance-to-nvme-array","title":"10G SMB Performance to NVMe Array","text":"<p>My initial expectations was that I would achieve roughly the same LARGE sequential speeds (since the 10G adaptor is the bottleneck here), but, the smaller/random tests would prove much better.</p> <p>The reality is- write speeds were better- but, not by a huge factor.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#1g-smb-performance-to-nvme-array","title":"1G SMB Performance to NVMe Array.","text":"<p>My expectations here- were to essentially see the exact same results I saw for the spinny disk array.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#total-results","title":"Total Results","text":"Large Sequential Random 4k Read MB/s Write MB/s Read MB/s 10G SMB Spinning Array 1152 793 59 1G SMB Spinning Array 97 102 72 10G SMB NVMe 1106 998 58 1G SMB NVMe 96 97 82 <p>All results added togather. In my opinion- The bottleneck to my array is currently the 10G ConnectX-3 adaptor on my workstation. Based on really no difference between NVMe and Spinning disk performance, I am going to write down the network as the root bottleneck.</p> <p>One thing I was curious about- many people over on r/TrueNAS and r/HomeLab will tell you- you cannot get full 10G performance over SMB, without extensive tuning.</p> <p>I am here, with evidence, to say, that is a lie. I was able to pull 1,150MB/s, which comes out to 9.2 Gigabits per second. Granted, I could tweak the MTU sizes, and send/receive buffers, and push that number closer to 9.5 \u2013 9.8Gb/s, however, I am perfectly satisfied with pulling 9.2Gb/s. While- I actually want to skip iScsi testing due to the impressive results I received for SMB testing, I have commited to it\u2026 So, lets get started\u2026</p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#testing-iscsi-performance","title":"Testing ISCSI Performance","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#testing-setup_1","title":"Testing Setup","text":"<p>The first step in order to test iScsi performance, was to configure a few zvols, and a few iscsi connections.</p> <p>I created a 15G zvol on both my NVMe array, and my Spinning disk array.</p> <p>The volume was formatting with GPT table, and NTFS file system with a quick format. Windows file/folder compression was not enabled.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#10g-iscsi-to-spinning-array","title":"10G ISCSI to Spinning Array","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#10g-iscsi-to-nvme-array","title":"10G ISCSI to NVMe Array","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#1g-iscsi-to-spinning-array","title":"1G ISCSI to Spinning Array","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#1g-iscsi-to-nvme-array","title":"1G ISCSI to NVMe Array","text":"","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#overall-results","title":"Overall Results","text":"Seq Read MB/s Seq Write MB/s RND Read MB/s RND Write MB/s 10G ISCSI Spinning Array 1172 523 211 105 10G SMB Spinning Array 1152 793 59 36 10G SMB NVMe 1106 998 58 53 10G ISCSI NVMe Array 1081 742 206 156 1G ISCSI Spinning Array 116 110 115 71 1G SMB Spinning Array 97 102 72 37 1G SMB NVMe 96 97 82 44 1G ISCSI NVMe Array 96 88 98 66","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#what-did-i-learn","title":"What did I learn?","text":"<ol> <li>My 10G NIC is the bottleneck to accessing my storage. In the future, I want to run a dedicated 40G link for my gaming PC.</li> <li>ISCSI performs marginally better than SMB, which surprised me. I expected it to greatly outperform SMB. However, my bottleneck is still my 10G network adaptor. With a faster 40G NIC in the future, we may see different results.</li> <li>I now want to store my Steam library on an SMB share, for my less frequently played games. My local 500G NVMe is getting pretty full.</li> <li>Oddly enough, random writes are interesting. ISCSI always wins here, regardless of connection.</li> <li>For sequential writes, SMB seems to perform better.</li> <li>Overall, I expected better performance from the NVMe array compared to the spinning array. Also, I did not expect my spinning array to perform EFFORTLESSLY over 10G.</li> <li>10G NICs and Modules use a lot of electric. They get very hot and like to run up my electric bill.</li> <li>A Brocade switch also likes to increase my electric bill. It uses 100w more than the switch it replaced (which was also doing POE).</li> </ol>","tags":["Homelab","Networking"]},{"location":"blog/2021/1040g-home-network-upgrade/#what-theories-were-debunked","title":"What theories were debunked?","text":"<ol> <li>You do NOT need to use a 9,000 MTU, and do extensive tuning to achieve 90% 10G performance. However, tuning will get you closer to achieving 100% performance.</li> <li>A cheap i5-based machine CAN do full IDS/DPI/ACL on 2 gigabits of traffic per second. It does not take a $5,000 firewall to do this.</li> <li>You CAN INDEED successfully run 10G over existing Cat6. You do NOT need Cat7/Cat8/fiber unless you are running longer distances. This is for a 40-foot run which goes under the crawl space of my house. If you are indeed planning on running 10G or more over cable, and you are in the process of laying the cable, do go ahead and use Cat6a/Cat7 however.</li> <li>A Z2 (RAID 6) array, with a bunch of big, large disks, can indeed saturate 10G. Many claim you need to run RAID 10, SSDs, etc., to come close to 10G performance. In my testing, I believe I can come close to saturating 20G from my spinning array.</li> <li>You do NOT NEED NVME/SSDs for 10G. 40G, Likely. But, I will get around to testing that in the future.</li> <li>(Added after this was posted) Oh, you are just getting close to 10G speeds because you are just testing the cache! Nope. 32G test files produce pretty much identical results over iSCSI to my array over 10G. I didn\u2019t run all of the tests because I don\u2019t want to spend 30 minutes waiting.</li> </ol>","tags":["Homelab","Networking"]},{"location":"blog/2021/rack-em-up/","title":"Rack em up - Adding a proper rack","text":"<p>I have a few pieces of enterprise gear for my home network. I have my server, a few 10/40G POE switches, and some other odds and ends. So far, its been stacked on boxes and buckets inside of my spare bedroom\u2019s closet.</p> <p>So, over the last two weeks, I started a project to clean everything up a little bit.</p> <p>Info</p> <p>This post was originally published in 2021, and has been adopted to this static-site from wordpress.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#before-and-after","title":"Before and After","text":"","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#before","title":"Before","text":"<p>As you can see in the above picture\u2026. its a bit of a mess. </p> <p>My switch on the left is sitting on a cardboard box. </p> <p>My server lives on top of a 5gal home depot bucket\u2026. and everything else is just \u201cin there\u201d.</p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#after","title":"After","text":"<p>After - Rack pulled out of the closet.</p> <p></p> <p>After, Rack neatly inside of the closet.</p> <p></p> <p>And- as a bonus, the closet doors can even close now!</p> <p>(Although, as of re-publishing this in 2023- there is far too much heat generated to leave the doors closed now...)</p> <p></p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#parts-links-used-in-this-article","title":"Parts / Links used in this article","text":"<ol> <li>Startech.com 25U Open Frame Rack</li> <li>48 port patch panel (FRONT, TOP Patch Panel)</li> <li>CAT6 Keystone Jacks</li> <li>6in Patch Cables. Green &amp; Black</li> <li>24 Port Patch Panel (REAR, TOP, incoming connections connect here)</li> <li>CAT6 Keystone Jacks</li> <li>3ft CAT6a THIN cables \u2013 connect rear patch panel to front patch panel</li> <li>Extra Cage Nuts</li> <li>2x Brocade ICX6610 Switches \u2013 2x40G QSFP+ ports, 16x 10G SFP+ ports, 48x 1G POE ports.</li> <li>Wiring loop shelf.</li> <li>HP Z240 \u2013 (OPnSense Firewall, 1G WAN, 2x 10G LAN)</li> <li>Homemade 2.4Kwh UPS</li> <li>APC 1500VA UPS. Buffers power while the big inverter fails over. Also- triggers my servers to shutdown after it has been on battery power &gt; 15 seconds.</li> <li>Dell R720XD \u2013 24c/48t, 128G RAM, 10x8TB Drives + 2x1TB 970 evo + 2x500G 970 evo + 2x 2.5\" 1TB + 40G NIC</li> <li>2x APC AP9562 \u2013 One for each PSU in multi-PSU devices.</li> </ol>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#the-process","title":"The Process","text":"","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#cleaning-up-the-closet","title":"Cleaning up the closet","text":"<p>So, the first goal, was to pull everything out of the closet, and remove the left-over spike strip from whenever this closet had carpet once upon a time.</p> <p>As you can see in the below image, spike strip was around the entire perimeter. It could\u2026 be bad if a power cord got pinched on top of this. So- the tools required for this job- Just a simple hammer and pry-bar.</p> <p></p> <p>After a bunch of beating and prying spike strip, Half way there\u2026..</p> <p></p> <p>And\u2026 done. Used the trusty shop-vac to clean up all of the remaining dust, fragments, etc.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#populating-the-rack","title":"Populating the rack","text":"<p>So, after the closet was cleaned up, my first goal was to move my 2.4Kwh UPS into the closet. If you have interest in building your own portable 2.4Kwh (or bigger) UPS, feel free to click that link. So far, it has worked fantastically, without issues.</p> <p>Info</p> <p>As of Dec 2023, this UPS is still in place, and still works perfectly.</p> <p>And, knock on wood, it fit into this space perfectly. The smaller UPS is used for a few smaller devices not mounted on my rack.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#finished","title":"Finished","text":"<p>And, next, through the magic of\u2026. editing, here is the final photo of the rack already populated.</p> <p>From Top to bottom:</p> <ol> <li>Startech.com 25U Open Frame Rack</li> <li>48 port patch panel (FRONT, TOP Patch Panel)<ul> <li>CAT6 Keystone Jacks</li> <li>6in Patch Cables. Green &amp; Black </li> </ul> </li> <li>24 Port Patch Panel (REAR, TOP, incoming connections connect here)</li> <li>CAT6 Keystone Jacks </li> <li>3ft CAT6a THIN cables \u2013 connect rear patch panel to front patch panel</li> <li>2x Brocade ICX6610 Switches \u2013 2x40G QSFP+ ports, 16x 10G SFP+ ports, 48x 1G POE ports.</li> <li>Wiring loop shelf.</li> <li>HP Z240 \u2013 (OPnSense Firewall, 1G WAN, 2x 10G LAN)</li> <li>APC 1500VA UPS. Buffers power while the big inverter fails over. Also- triggers my servers to shutdown after it has been on battery power &gt; 15 seconds.</li> <li>Dell R720XD \u2013 24c/48t, 128G RAM, 10x8TB Drives + 2x1TB 970 evo + 2x500G 970 evo + 2x 2.5\" 1TB + 40G NIC</li> <li>2x APC AP9562 \u2013 One for each PSU in multi-PSU devices.<ul> <li>Note: the 2nd unit arrived and was installed after these images were taken. It sits right under the server.</li> </ul> </li> </ol> <p></p> <p>And- when I need to \u201chide\u201d the rack\u2026 it fits nicely into the closet!</p> <p></p> <p>And- of course, the closet doors still shut.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#faqs-comments","title":"FAQs / Comments","text":"<p>Q: Why are you using two separate patch panels?</p> <p>A: Due to how my rack slides in/out of the closet, the cables come into the rear of my rack. To allow me to pull the rack OUT of the closet to perform maintenance, I wanted the cables coming in at the rear to give plenty of space.</p> <p>Q: Will it get too hot in the closet?</p> <p>A: Absolutely. The door will remain open until a proper ventilation system is created.</p> <p>Q: Will the \u201cTHIN\u201d patch cables work for POE / 10G?</p> <p>A: I was curious myself. Turns out, none of my POE devices are having issues, and all of the 10G links are working without issue, and no packet errors are reported on the switches.</p> <p>A note- My expectations for the startech rack were not very high, as it was pretty cheap. I was half-way expecting to receive a flimsy rack, not suitable for my heavy servers. I was pleasantly surprised, the build quality is actually\u2026. pretty nice. The parts are thick and solid.</p> <p>Info</p> <p>Edit from Dec 2023- This rack has held up perfectly fine, with no issues at all.</p> <p>Would strongly recommend. The thin patch cables have been absolutely fantastic. I still love these. A new post will be coming soon hopefully of the changes over the last few years.</p>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#future-ideas-projects","title":"Future Ideas / Projects","text":"<ol> <li>Cleanup some of the CAT6 in the closet. I have drops coming from both the floor, and ceiling. It would be nice to make this a bit\u2026 neater. Its a mess still.<ul> <li>As of 2024 - Issue is worse! Now there is also multiple fiber runs coming through the floor! But, is better organized now.</li> </ul> </li> <li>Apply SOME form of flooring to the closet. The old plywood is not easy on the eyes.<ul> <li>Yup. This is still ugly too.</li> </ul> </li> <li>It would be nice to have rails on the floor, to allow the rack to slide into and out of the closet with ease, every time.<ul> <li>This likely isn't going to ever happen.</li> </ul> </li> </ol>","tags":["Homelab"]},{"location":"blog/2021/rack-em-up/#disclaimers","title":"Disclaimers","text":"<p>A random note- you are viewing this website from the server in the bottom of that rack.</p> <p>This is not a sponsored post. There was no financial incentive behind ANY of the products used in this article.</p> <p>Affiliate links are present, however, they do not at all affect your pricing in any way.</p>","tags":["Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/","title":"TrueNAS Scale - Use Vanilla Docker","text":"<p>How to enable and leverage the vanilla docker built into TrueNAS Scale.</p>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#this-article-is-for-you-if","title":"This article is for you IF\u2026.","text":"<ol> <li>You wish to use a normal, vanilla docker experience.</li> <li>You do NOT like kubernetes, and wish to use normal docker, or docker swarm.</li> <li>You are a TECHNICAL INDIVIDUAL, who is capable of troubleshooting.</li> </ol>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#this-article-is-not-for-you-if","title":"This article is NOT for you IF\u2026.","text":"<ol> <li>You wish to be supported by IX-Systems. The below steps, are completely unsupported.</li> <li>You want to use the built-in apps interface. This will break that.</li> <li>You want to just point and click on the GUI to install plex. This is a hands-on process, for people familiar with managing docker via the CLI, or portainer.</li> <li>You do not know what SSH, CLI, Bridges, Bonds is.</li> </ol>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#steps","title":"Steps","text":"","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#step-1-startup-scripts","title":"Step 1. Startup scripts","text":"<p>To use a vanilla docker experience, we first need to create a few scripts, intended to configure your docker experience.</p> <p>The first step, is to build a docker/daemon.json file. Lets store this in a persistent directory. I personally use a dataset I created at <code>/mnt/Flash/docker</code></p> <p>Make sure to update the below file with your DNS server too. Or- if you don't have a DNS server, 8.8.8.8</p> ~/docker_config.json<pre><code>{\n        \"data-root\": \"/mnt/Flash/docker\",\n        \"exec-opts\": [\"native.cgroupdriver=cgroupfs\"],\n        \"storage-driver\": \"zfs\",\n        \"iptables\": true,\n        \"bridge\": \"\",\n        \"dns\": [\"10.100.4.1\"]\n}\n</code></pre> <p>Make sure to update the DNS IP address to your DNS server.</p> <p>Lastly, set the data-root to a persistent dataset on your system. Docker will store ALL of its images, volumes, and configuration here.</p> <p>Next, we need a script to start, and configure docker.</p> <p>This script does three things.</p> <ol> <li>Stops docker service if it is running.</li> <li>Remove any docker/daemon.json if it exists.</li> <li>Copies the daemon.json we created earlier to the proper location.</li> <li>Starts docker via systemctl.</li> </ol> ~/setup-docker<pre><code>systemctl stop docker\nrm /etc/docker/daemon.json\ncp docker_config.json /etc/docker/daemon.json\nsystemctl start docker\n</code></pre> <p>At this point, if you invoke the above script, it should startup a fresh copy of docker.</p> <p>If you run <code>docker ps</code>, It should return back an empty table, with nothing running. If not, something isn\u2019t correct. Make sure your modified <code>docker/daemon.json</code> file has a new/fresh dataset that was not in use by the built-in apps before.</p>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#step-2-install-portainer","title":"Step 2. Install Portainer","text":"<p>I keep a script handy for installing and upgrading portainer.</p> <p>This script will stop portainer if it is running. and remove its container if it exists.</p> <p>It will then install portainer, and create a docker volume named \u201cportainer_data\u201d if it does not exist.</p> <p>Info</p> <p>If you use portainer enterprise edition, replace <code>portainer-ce</code>, with <code>portainer-ee</code></p> <p>If you don\u2019t use enterprise edition, portainer IS/WAS giving out free licensees for home users.</p> ~/upgradeportainer<pre><code>docker stop portainer\ndocker rm portainer\ndocker pull portainer/portainer-ce:latest\ndocker run -d -p 9000:9000 \\\n--name=portainer --restart=always \\\n-v /var/run/docker.sock:/var/run/docker.sock \\\n-v portainer_data:/data \\\nportainer/portainer-ce:latest\n</code></pre> <p>After you have your script saved, <code>chmod+x upgradeportainer</code> to make the script executable, and then\u2026. execute it.</p> <p>Docker will proceed to download portainer, and install/run it.</p> <p>From this point\u2026. open a web browser and navigate to\u2026. <code>https://YourTrueNASHost:9000/</code> and you should see portainer.</p>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#step-3-re-enable-docker-compose","title":"Step 3. Re-enable docker compose.","text":"<p>In Scale 22.02, ix-systems decided to \"disable\" the ability the built-in docker-compose, and a few other binary files.</p> <p>You can \"re-enable\" docker-compose by running....</p> <pre><code>chmod +x /usr/bin/docker-compose\nchmod +x /bin/docker-compose\n</code></pre>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#how-to-undo","title":"How to undo","text":"<p>If you wish to revert to the built-in apps, just delete your <code>/etc/docker/daemon.json</code>, disable the startup script you created and restart the docker service.</p>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/truenas-scale---use-vanilla-docker/#changes-history","title":"Changes / History","text":"<ul> <li>Nov 2022 - This post was originally written Dec 15, 2021, and located on the Wordpress Blog. It was migrated here Nov 20, 2022.</li> <li>Mar 2022 - Confirmed this does still work for 22.02 release.<ul> <li>To note- you can leverage Docker compose using the built-in apps now</li> </ul> </li> </ul>","tags":["Homelab/TrueNAS","Homelab"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/","title":"Unraid Vs TrueNAS SCALE 2021","text":"<p>Often, I see a bunch of posts where someone is having a tough time considering between Unraid, or TrueNAS. so, I am going to write a quick summary based on my experiences, and recommendations.</p> <p>This article is basically copied from my comment on reddit.</p>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#unraid","title":"Unraid","text":"","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#pros","title":"Pros","text":"<ul> <li>Disk Management: You add disks, you gain storage, simple as that.</li> <li>Write Caching: Its method of write caching allows adding NVMe to a dedicated flash pool, enhancing performance.</li> <li>Resources: Doesn't require many resources to run a decently performant install.</li> <li>UI: Unraid has a fantastic UI that is very easy to use and navigate.</li> <li>Power Usage: Only the drive containing the file you are using needs to be spun up.</li> <li>Tiered Storage: Provides a rudimentary system of tiered storage.</li> </ul>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#cons","title":"Cons","text":"<ul> <li>Performance: Unless your data lives on your flash cache, you are limited to the performance of a single drive.</li> </ul>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#truenas","title":"TrueNAS","text":"","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#pros_1","title":"Pros","text":"<ul> <li>Storage Expansion: Adding storage means adding another vdev. In the future, online expansion will be added.</li> <li>Performance: Data is read from and written to all disks in a vdev simultaneously.</li> <li>UI: Scale is still in beta with bugs being worked out. The UI doesn't compare to Unraid's ease of use.</li> </ul>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#cons_1","title":"Cons","text":"<ul> <li>Resources: Requires ample RAM, especially ECC RAM.</li> <li>Power Usage: When you read or write something, your entire array has to spin up.</li> <li>Tiered Storage: Non-existent in TrueNAS.</li> </ul>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#which-is-better","title":"Which is Better?","text":"<p>Neither. Each one fits into a unique niche. For a recommendation, specific needs should be considered.</p> <ul> <li>Unraid: Suitable for non-technical users who want a NAS that \"just works\" with its simplistic UI and easy storage expansion.</li> <li>TrueNAS: Better for technical users who don't mind tinkering, offering excellent performance and reliability with proper hardware.</li> </ul>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#which-one-is-faster","title":"Which One is Faster?","text":"<p>Neither. Each has its strengths. TrueNAS excels in spinning disk array performance, while Unraid minimizes bottlenecks with NVMe caching.</p>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#personal-choice","title":"Personal Choice","text":"<p>I prefer TrueNAS for its performance, reliability, and control over data management.</p> <p>Seriously, both are good platforms to choose from.</p>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2021/unraid-vs-truenas-scale-2021/#update-from-2024-","title":"Update from 2024-","text":"<p>Since, this post was migrated from the old site, to this new static site- Just adding a quick update.</p> <p>As of 2024, I no longer utilize TrueNAS Scale. I do, however continue to run Unraid. </p> <p>Since- Unraid added native ZFS, this handles the one downside I originally had with Unraid. </p> <p>As well- it offers a lot more flexibility in terms of storage support. </p>","tags":["Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2022/truenas-scale---enable-apt-get/","title":"TrueNAS Scale - How to re-enable apt-get","text":"<p>A quick guide on re-enabling the apt-get functionality.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---enable-apt-get/#the-issue","title":"The Issue","text":"<p>So, I updated to the official release version earlier this morning\u2026. and was working on getting my InfiniBand cards up and running\u2026</p> <p>Well, I needed the infiniband diag tools, so, I ran:</p> <pre><code>root@truenas:~# apt-get install infiniband-diags\nbash: /bin/apt-get: Permission denied\n</code></pre> <p>Oh, that is interesting.</p> <p>So, I googled around, and found this: https://www.truenas.com/community/threads/no-apt-after-update-to-release.99579/</p> <p>Seems\u2026 it was disabled by design, because people do dumb stuff, make their installations unsupportable\u2026. and, then ask for support.</p> <p>Well\u2026.. I want my infiniband working. So, how do we resolve this?</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---enable-apt-get/#the-fix","title":"The fix","text":"<p>Warning</p> <p>I am going to assume ix-systems had a very good reason for doing this. So- if you aren't sure what you are doing, don't do it. My goal is not to increase the amount of support issues ix-systems has to deal with.</p> <p>If you run, for example, <code>apt-get update &amp;&amp; apt-get upgrade</code>, which is a very common thing to do on most linux systems, it will BREAK your TrueNAS Scale installation. Scale is provided 'As an appliance', and any modifications or changes to the underlying OS are not supported.</p> <p>Danger</p> <p>Before you do ANYTHING, take a configuration backup, and store it somewhere safe... NOT on your TrueNAS instance. That way- if you do manage to break your system, reinstall the OS, and re-import your backup. Voila, you are back up and running.</p> <p>Simple!</p> <pre><code>chmod +x /bin/apt*\n</code></pre> <p>Yup, that is literally all you need to do.</p> <p>Again, to restate- If you don\u2019t know the implications of something you are doing via CLI, DON\u2019T DO IT!</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---enable-apt-get/#adding-upstream-debian-repositories","title":"Adding upstream debian repositories","text":"<p>Also, if you DO understand the implications of something, and you know to not blow up support channels as a result of your actions, you can also update <code>/etc/apt/sources.list</code> to add in the debian repos\u2026 since, the ix-repos\u2026 are much smaller... and are missing lots of common software.</p> <p><code>vi /etc/apt/sources.list</code></p> /etc/apt/sources.list<pre><code>(Add the below lines, into this file.)\ndeb http://deb.debian.org/debian bullseye main\ndeb-src http://deb.debian.org/debian bullseye main\n</code></pre> <p>I removed the other repos.... since it is shipped with apt-disabled anyways.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---enable-apt-get/#update-2024","title":"Update - 2024","text":"<p>Note</p> <p>I have not personally tested the below commands as I no longer use TrueNAS.</p> <p>I am copying the information over, for others who end up here.</p> <p>Full credit here goes to u/SpecialZestyclose255</p> <p>From u/SpecialZestyclose255- </p> <p>In the latest version (24.04.0), you need to remount a virtual drive before you can use chmod +x:</p> <p><code>mount -o remount,rw 'boot-pool/ROOT/24.04.0/usr'</code></p> <p>You need to make sure that <code>/usr/local/bin</code> isn't in your PATH too.</p> <p><code>export PATH=/usr/bin:/usr/sbin</code></p> <p>And then:</p> <p><code>chmod +x /bin/apt*</code> <code>chmod +x /usr/bin/dpkg</code></p> <p>Full Commands: <pre><code># Remount as read-write\nmount -o remount,rw 'boot-pool/ROOT/24.04.0/usr'\n\n# Add bin / sbin directories to path.\nexport PATH=/usr/bin:/usr/sbin\n\n# Add executable flag to binaries, which is emoved by the TrueNAS team.\nchmod +x /bin/apt*\n\n# Re-enable the ability to execute the dpkg binary.\nchmod +x /usr/bin/dpkg\n</code></pre></p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas--iscsi--gpt-protective-partition/","title":"TrueNAS \u2013 iSCSI \u2013 GPT Protective partition","text":"<p>While migrating from TrueNAS Scale to Core, I ran into an issue when remounting my existing iSCSI shares.</p> <p>After getting everything configured, windows showed the status of, \u201cHealthy (GPT Protective partition)\u201d</p> <p></p> <p>After googling around for a bit, and finding many unresolved questions, I decided to start randomly changing settings.</p> <p>Turns out, if you set the LUN size incorrectly, you will see this error.</p> <p>After setting my LUN size to 4096 (Which is what was originally configured), the error goes away, and my mount works normally.</p> <p></p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/","title":"TrueNAS Scale - VM/Containers cannot access host.","text":"<p>How to address Virtual Machines and/or containers not being able to access the TrueNAS Scale server hosting them.</p> <p>To address this issue, we will need to add a new bridge interface for the TrueNAS system, and enable ipv4 forwarding to allow the network adaptor to pass packets between the VM's network adapter, and the adaptor assigned to TrueNAS.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/#process","title":"Process","text":"","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/#step-1-create-a-bridge-interface","title":"Step 1. Create a bridge interface","text":"<p>Goto the network tab. Find the interface which you are using for your VMs.</p> <p>Remove the IP address from this interface.</p> <p>Now, Create a new interface, make sure to specify type=Bridge, and specify the original interface as a member.</p> <p>At the bottom, add the IP address from the original interface.</p> <p>Save / Test / Save / etc.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/#step-2-update-tunables","title":"Step 2. Update tunables","text":"<p>Goto <code>System Settings</code> -&gt; <code>Advanced</code></p> <p>We will need to add a new value, which will enable ipv4 forwarding. This is required for packets to be forwarded from your VM's, to the TrueNAS host.</p> <p>Add a new value.</p> <ul> <li>Variable: <code>net.ipv4.ip_forward</code></li> <li>Value: 1</li> </ul> <p>Your form should look like this:</p> <p></p> <p>After saving, you should see the value listed in the sysctl section like so:</p> <p></p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/#step-3-update-vms","title":"Step 3. Update VMs","text":"<p>First, Power off your VMs.</p> <p>Next, for each VM, you need to click <code>Devices</code></p> <p></p> <p>Find the NIC which you want to have access to the host system via its network, and edit it.</p> <p>Change its interface to leverage the new bridge adapter, created in the first step. </p> <p></p> <p>Save your changes.</p> <p>Warning</p> <p>Don't power on the VM yet! We will need to reboot TrueNAS before ip forwarding is fully enabled.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/truenas-scale---vm-cannot-access-truenas/#step-4-reboot","title":"Step 4. Reboot","text":"<p>TrueNAS Scale doesn\u2019t seem to apply a lot of network changes until AFTER a reboot. So, a reboot is a must here. As well, the sysctl values we added won\u2019t take affect until after a reboot.</p> <p>After your machine successfully reboots- make sure you edit your VMs, and update their network interface to leverage the new bridge you created. You will need to power off / power on the VMs for this to apply.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/","title":"40Gb Ethernet Cost and Benchmarks","text":"<p>A while back, you may have seen my post for my 10/40GBe Network Upgrade. However, you were likely disappointed like myself, due to the lack of any actual 40GBe test results.</p> <p>Well, today, I have managed to get 40Gbit point to point connectivity from my PC, to my Server, and I have prepared test results!</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#disclaimers","title":"Disclaimers","text":"<p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#cost","title":"Cost","text":"","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#network-interface-cards-nics","title":"Network Interface Cards (NICs)","text":"","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#mellanox-connectx-3-dual-port-40gbe-around-40-60-40-60","title":"Mellanox ConnectX-3 Dual Port 40GBe \u2013 Around 40-60$ - 40-60$","text":"<p>I have used these NICs for my Gaming PC, My Server, and my firewall. The configuration CAN be a bit complex if you choose to use them in infiniband mode, however, you can use them for regular ethernet mode without issues. Drivers are included for Linux/Unix/Windows, and these NICs are \u201cmostly\u201d plug and play.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#chelsio-40gbe-dual-port-50-100-50-100","title":"Chelsio 40GBe Dual Port 50-100$ 50-100$","text":"<p>Chelsio also makes a very high quality NIC. These actually \u201cfeel\u201d heavier then the other options I have tested from Intel and Mellanox. You can\u2019t go wrong here.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#cables","title":"Cables","text":"","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#cheap-dac-from-ebay-or-amazon-20","title":"Cheap DAC From eBay or Amazon - 20$","text":"<p>For inter-rack connectivity, I have used cheap 5-10ft DAC cables without issue at both 10 and 40GBe. However\u2026. if you need to transmit 40GBe across your house, like I did for this test\u2026. See below.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#fscom-3-164-foot-dacaoc-100-200","title":"FS.com 3-164 foot DAC/AOC - 100-200$","text":"<p>After my QSFP+ modules failed to establish a connection, I ended up ordering a 15m cable from fs.com. It arrived in 3 or 4 days, and was literally plug and play. (Not- I am not sponsored or affiliated by fs.com)</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#total-cost-300","title":"Total Cost - ~300$","text":"<p>For the setup I ended up actually using, the total cost was around 240$.</p> <ol> <li>Chelsio T580-LP-CR: 99$</li> <li>ConnectX-3 CX354A: 45$</li> <li>FS.Com 50ft 40GBe DAC: 140$</li> </ol> <p>To note, there is a LOT of opportunity to go much cheaper here. You can get perfectly suitable NICs for 45$ each which can do 40GBe all day long.</p> <p>There is a MASSIVE opportunity to save on the fiber itself. I was able to get 50ft of OS2 fiber for hardly 20$. However, the cheap modules I found, did not actually work. I could have made a mistake somewhere. Never know. But, if these work for you, you can do the project much cheaper. The other option, is getting MPO cable, which costs a bit more, but, is still cheaper then the DAC I ordered. I ended up going the route of the DAC, because I was tired of things not working!</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#benchmarking","title":"Benchmarking","text":"","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#iperf2-result-36gbits","title":"IPerf2 \u2013 Result: 36Gbit/s","text":"<p>Note, I am using iperf2, instead of iperf3, due to iperf3 being single threaded, and being more difficult to benchmark 40G. You can read more about that here: https://fasterdata.es.net/performance-testing/network-troubleshooting-tools/iperf/multi-stream-iperf3/</p> <p>You can download both iperf2 and iperf3 from the official website: https://iperf.fr/iperf-download.php</p> <pre><code>Windows Client\niperf -c 10.100.255.1 -P 4\n------------------------------------------------------------\nClient connecting to 10.100.255.1, TCP port 5001\nTCP window size:  208 KByte (default)\n------------------------------------------------------------\n[  5] local 10.100.255.2 port 1147 connected with 10.100.255.1 port 5001\n[  3] local 10.100.255.2 port 1145 connected with 10.100.255.1 port 5001\n[  4] local 10.100.255.2 port 1146 connected with 10.100.255.1 port 5001\n[  6] local 10.100.255.2 port 1148 connected with 10.100.255.1 port 5001\n[ ID] Interval       Transfer     Bandwidth\n[  5]  0.0-10.0 sec  10.5 GBytes  8.99 Gbits/sec\n[  3]  0.0-10.0 sec  9.30 GBytes  7.98 Gbits/sec\n[  4]  0.0-10.0 sec  9.78 GBytes  8.39 Gbits/sec\n[  6]  0.0-10.0 sec  12.4 GBytes  10.6 Gbits/sec\n[SUM]  0.0-10.0 sec  41.9 GBytes  36.0 Gbits/sec\n\nTrueNAS Server\nroot@truenas[~]# iperf -s\n------------------------------------------------------------\nServer listening on TCP port 5001\nTCP window size:  128 KByte (default)\n------------------------------------------------------------\n[  4] local 10.100.255.1 port 5001 connected with 10.100.255.2 port 1148\n[  5] local 10.100.255.1 port 5001 connected with 10.100.255.2 port 1146\n[  6] local 10.100.255.1 port 5001 connected with 10.100.255.2 port 1145\n[  7] local 10.100.255.1 port 5001 connected with 10.100.255.2 port 1147\n[ ID] Interval       Transfer     Bandwidth\n[  4]  0.0-10.0 sec  12.4 GBytes  10.6 Gbits/sec\n[  5]  0.0-10.0 sec  9.78 GBytes  8.38 Gbits/sec\n[  6]  0.0-10.0 sec  9.30 GBytes  7.97 Gbits/sec\n[  7]  0.0-10.0 sec  10.5 GBytes  8.97 Gbits/sec\n[SUM]  0.0-10.0 sec  41.9 GBytes  35.9 Gbits/sec\n</code></pre>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#crystaldisk","title":"CrystalDisk","text":"","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#benchmark-disclaimer","title":"Benchmark disclaimer.","text":"<p>I have ran all of these benchmarks at both 1G test size, as well as 8G test size. I also ran 5 iterations of each test.</p> <p>Many people will argue that all of your results are \u201ccached\u201d in ram at a 1G test size. While, this may be completely accurate- Remember, in the real world, you don\u2019t move massive files very often!</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#testing-pools","title":"Testing Pools","text":"<p>My NVMe pool consists of two 1tb 970 evos mirrored together. For SMB Testing, The target dataset did have LZ4 compression enabled.</p> <p>My Spinning Disk pool, consists of 8x 8TB seagate exos sata drives, in a ZFS Z-2 configuration.</p> <p>My TrueNAS Box is hosted on a Dell R720XD, with 2x E5-2695v2 processors, and 128GB of DDR-3 1333mhz ECC ram. It is running TrueNAS Scale.</p> <p>Lastly- no services were stopped on this server while testing. The website you are reading is hosted on this server. I have game servers hosted here. I have MANY things hosted on this server. This is NOT a clean-room benchmark. This was benchmarked under my current, typical conditions.</p> <p>During none of the below testing, did CPU utilization really rise above 30%. The Server usually runs around 15-20% utilization on average.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#baseline-500g-970-evo","title":"Baseline - 500G 970 EVO","text":"<p>For a reference to compare again, this is a benchmark of a Samsung 970 evo 500G, on my testing PC. No Raid, No ZFS. No Compression. Just a windows client with a 970 evo.</p> <p></p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#iscsi-mirrored-nvme-pool-result-up-to-3gbs","title":"ISCSI -&gt; Mirrored NVMe Pool: Result: Up to 3GB/s.","text":"<p>Results seem consistent, inline with what I would expect. Random I/O isn\u2019t very great, but, being this is happening on a server 50 foot away, I am more than impressed.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#smb-mirrored-nvme-pool","title":"SMB -&gt; Mirrored NVMe Pool.","text":"<p>Something interesting happened here- For large test-sizes, SMB performance seemed to fall off a cliff. Although, writing to a file share at 1GB/s really isn\u2019t bad.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#iscsi-spinning-z2-array","title":"ISCSI -&gt; Spinning Z2 Array","text":"<p>What is very interesting about this test- The read speeds\u2026. are basically identical to that of my NVMe array. For a Z2 pool consisting of a bunch of dirt-cheap 8TB disks I picked up, This is quite impressive to me. Write speeds, as you would expect, aren\u2019t nearly as good\u2026 Parity calculation, and spinning disk performance shows its face here. I am willing to bet 8GB writes will be much worse.</p> <p>Even more interesting, for the 8GiB Test, read speeds\u2026. were extremely good.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#smb-spinning-z2-array","title":"SMB -&gt; Spinning Z2 Array","text":"<p>Again, it seems samba takes a huge drive in performance when testing larger sizes.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/40gb-ethernet-cost-and-benchmarks/#overall-results","title":"Overall Results?","text":"<p>My PRIMARY use case for upgrading to 40GBe, is for remote storage using ISCSI. I want to play with multi-booting multiple OS versions, over ISCSI. I want storage-level backups, snapshots, and recovery for my primary PC.</p> <p>Given, my array of spinning disks, is offering a level of performance nearly even to a stand-alone 970 evo, I am more then thrilled.</p> <p>While, I am only able to saturate around 25Gbit/s of the 40GBe link, I do believe there is still more performance on the table. As well, it is possible I may be bottlenecked due to my antique CPU and its 1,333mhz RAM. There is also the possibility of bottlenecks between the CPUs and associated PCIe busses. There are many possibilities.</p> <p>But, for now, this level of performance is more then acceptable. I will note, Server CPU utilization never exceeded 30-40%. CPU utilization on my workstation was nearly unnoticeable. I do have full offloading enabled on my chelsio NIC.</p>","tags":["Networking","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/","title":"Adding \"Bifurcation\" to a Dell R720XD","text":"<p>Wait, the R720XD doesn\u2019t support bifurcation?</p> <p>And- you would be correct by saying that.</p> <p>However- There are special PCIe cards you can acquire, which will perform the bifurcation.</p> <p>Credit for this idea goes to THIS POST which was brought to my attention by a fellow redditor. (I couldn\u2019t find the comment from a month ago..)</p> <p>As a note- this isn't specific to the R720XD, this guide/hardware should work in any hardware with the proper PCIe slots, which does not support bifurcation out of the box.</p> <p>If your hardware does support native bifurcation, I would recommend using it, with something such as the ASUS Hyper M.2. However, this hardware should still work even if you do have on-board bifurcation as well.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#why-bifurcate","title":"Why Bifurcate?","text":"<p>By default, without bifurcation, you can use one PCIe slot, for one device. This means, despite having a16 lane slot, you can only use a single NVMe (which only requires 4 lanes). With bifurcation, you can use all 16 lanes for 4 individual devices.</p> <p>My r720XD has\u2026 6 usable PCIe slots. Two are 16 lanes, the rest are 8 lanes. My current needs involves 4x NVMe devices, a dual port 40G NIC, and a USB 3.1 type-c card. In my current setup, this consumes all of my available slots, despite having many free lanes.</p> <p>Bifurcation isn\u2019t only for NVME, however, this is generally the most popular use for it.</p> <p>I would explain exactly how this works with a non-bifurcation motherboard\u2026. however, I would just be repeating what I read from the original Serve The Home post. So, please look at the original post.</p> <p>I will note- what I am doing below, isn\u2019t actually bifurcation. But, PCIe switching. If you are more interested to know the technical details, I recommend you read the PEX 8748 Product Brief or PEX 8724 Product Brief.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#getting-started","title":"Getting Started","text":"<ol> <li>https://www.aliexpress.com/item/1005001344675103.html<ul> <li>This is the one used for now.</li> </ul> </li> <li>https://www.aliexpress.com/item/1005001889076788.html<ul> <li>I picked up this one as a backup.</li> </ul> </li> </ol> <p>Regarding shipping, both cards ended up arriving at my house in the same package, only 2 weeks later. For- shipping from China, I was quite amazed at how quickly they arrived. Packaging was good.</p> <p>To note, the cards did seem to go out of stock. However, see the Serve The Home post for other potential cards.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#step-1-remove-the-old-hardware","title":"Step 1. Remove the old hardware","text":"<p>I started the process by removing all of the riser boards from my server. As you can see, I had a lot of adaptors using an entire PCIe slot for a single NVMe drive before.</p> <p></p> <p>Next- I started removing the NVMe adaptors from the risers.</p> <p></p> <p>After a few minutes\u2026. I had my pile of NVMe devices ready to go into the new card.</p> <p></p> <p>After removing the 6 screws on the back of the new device, I installed all 4 of my NVMe devices. The backside of the aluminum cover does have heat-sink pads, which hopefully should help keep my devices running a tad cooler.</p> <p></p> <p>And\u2026 all buttoned up, ready to be installed.</p> <p></p> <p>The final part of this process, was to re-install all of the devices into the chassis.</p> <p></p> <p>After adding everything back into the chassis, I still have three open PCIe slots.</p> <p>In the future, when I decide to add more stripes to my NVMe/Flash pool, I will move the USB Type-C adaptor over to the half-width slots. But, for now, this is fine.</p> <p>If the mspaint labels are not readable, the card on the left is the new quad NVMe switch, in the middle, I have a dual port 40Gbit ConnectX-3 NIC, with a USB 3.1 Type-C on top. The riser on the right has all three slots completely empty.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#does-it-boot","title":"Does it boot?","text":"<p>Yes!</p> <p>TrueNAS booted right up, without issues. My existing Flash/Cache pools were imported right away, without any issues at all.</p> <p>As well, all of the NVMe disks were detected just like nothing had changed.</p> <p></p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#does-it-perform","title":"Does it perform?","text":"<p>Without going too deep into benchmarks\u2026.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#iscsi-benchmark","title":"iSCSI Benchmark","text":"<p>iSCSI across my flash pool benchmarked exactly the same as in my Previous Benchmarks after removing my brocade ICX-6610.</p> <p></p> <p>As noted before, I am bottlenecked by my 10Gbe connection. I have still not tracked down the issue limited all of my iSCSI write speeds to 570MB/s.</p> <p>(Edit from 2023- This post came before I upgraded to 40GBe)</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#fio-sequential-benchmark","title":"FIO Sequential Benchmark","text":"FIO Benchmark<pre><code>truenas[/mnt/Cache]# fio --name=seqread --rw=read --direct=1 --ioengine=libaio --bs=8k --numjobs=8 --size=1G --runtime=600  --group_reporting\nseqread: (g=0): rw=read, bs=(R) 8192B-8192B, (W) 8192B-8192B, (T) 8192B-8192B, ioengine=libaio, iodepth=1\n...\nfio-3.25\nStarting 8 processes\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nJobs: 8 (f=8)\nseqread: (groupid=0, jobs=8): err= 0: pid=1319720: Sat Jan  8 11:52:23 2022\n  read: IOPS=686k, BW=5361MiB/s (5622MB/s)(8192MiB/1528msec)\n    slat (usec): min=3, max=661, avg= 9.33, stdev=20.50\n    clat (nsec): min=661, max=59010, avg=878.93, stdev=459.30\n     lat (usec): min=4, max=664, avg=10.34, stdev=20.69\n    clat percentiles (nsec):\n     |  1.00th=[  748],  5.00th=[  764], 10.00th=[  772], 20.00th=[  780],\n     | 30.00th=[  788], 40.00th=[  796], 50.00th=[  804], 60.00th=[  812],\n     | 70.00th=[  828], 80.00th=[  844], 90.00th=[ 1020], 95.00th=[ 1352],\n     | 99.00th=[ 1656], 99.50th=[ 1960], 99.90th=[ 9792], 99.95th=[11456],\n     | 99.99th=[15936]\n   bw (  MiB/s): min= 5423, max= 5743, per=100.00%, avg=5583.70, stdev=23.59, samples=16\n   iops        : min=694204, max=735222, avg=714713.00, stdev=3019.26, samples=16\n  lat (nsec)   : 750=0.84%, 1000=89.04%\n  lat (usec)   : 2=9.66%, 4=0.31%, 10=0.06%, 20=0.09%, 50=0.01%\n  lat (usec)   : 100=0.01%\n  cpu          : usr=17.78%, sys=82.04%, ctx=47, majf=16, minf=153\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     issued rwts: total=1048576,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=1\nRun status group 0 (all jobs):\n   READ: bw=5361MiB/s (5622MB/s), 5361MiB/s-5361MiB/s (5622MB/s-5622MB/s), io=8192MiB (8590MB), run=1528-1528msec\nroot@truenas[/mnt/Cache]#\n</code></pre> <p>Based on FIO, I am receiving the full expected performance from a single drive. But- this doesn\u2019t tell me if I am receiving full performance from multiple drives. SO\u2026. lets benchmark my Flash pool, which is mirrored across two NVMes on this card.</p> <pre><code>truenas[/mnt/Flash]# fio --name=seqread --rw=read --direct=1 --ioengine=libaio --bs=8k --numjobs=24 --size=1G --runtime=600  --group_reporting\nseqread: (g=0): rw=read, bs=(R) 8192B-8192B, (W) 8192B-8192B, (T) 8192B-8192B, ioengine=libaio, iodepth=1\n...\nfio-3.25\nStarting 24 processes\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nseqread: Laying out IO file (1 file / 1024MiB)\nJobs: 24 (f=21): [R(8),f(1),R(6),f(2),R(7)][-.-%][r=7881MiB/s][r=1009k IOPS][eta 00m:00s]\nseqread: (groupid=0, jobs=24): err= 0: pid=1663699: Sat Jan  8 12:06:40 2022\n  read: IOPS=959k, BW=7490MiB/s (7854MB/s)(24.0GiB/3281msec)\n    slat (usec): min=3, max=11418, avg=20.72, stdev=52.72\n    clat (nsec): min=735, max=582467, avg=1466.79, stdev=1155.76\n     lat (usec): min=4, max=11431, avg=22.42, stdev=53.14\n    clat percentiles (nsec):\n     |  1.00th=[  804],  5.00th=[  820], 10.00th=[  828], 20.00th=[  852],\n     | 30.00th=[  876], 40.00th=[  980], 50.00th=[ 1224], 60.00th=[ 1384],\n     | 70.00th=[ 1576], 80.00th=[ 1880], 90.00th=[ 2448], 95.00th=[ 3056],\n     | 99.00th=[ 4768], 99.50th=[ 5600], 99.90th=[ 8384], 99.95th=[12224],\n     | 99.99th=[27008]\n   bw (  MiB/s): min= 6418, max= 9478, per=100.00%, avg=7725.06, stdev=53.06, samples=135\n   iops        : min=821626, max=1213256, avg=988808.13, stdev=6791.08, samples=135\n  lat (nsec)   : 750=0.01%, 1000=40.74%\n  lat (usec)   : 2=41.92%, 4=15.39%, 10=1.88%, 20=0.04%, 50=0.02%\n  lat (usec)   : 100=0.01%, 250=0.01%, 500=0.01%, 750=0.01%\n  cpu          : usr=13.68%, sys=85.88%, ctx=1005, majf=0, minf=522\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     issued rwts: total=3145728,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\n   READ: bw=7490MiB/s (7854MB/s), 7490MiB/s-7490MiB/s (7854MB/s-7854MB/s), io=24.0GiB (25.8GB), run=3281-3281msec\n</code></pre> <p>Nearly 8GB/s. I am satisfied with this performance. This should have no issues at all saturating a 40G connection with iSCSI traffic.</p> <p>Lastly, I wanted to perform a simple write test to see how well it performs. SINCE, there is ZFS overhead when writing, checksums, etc\u2026 and a mirror has to write to both disks at once, I am not expecting dramatic numbers here.</p> <pre><code>truenas[/mnt/Flash]# fio --name=seqwrite --rw=write --direct=1 --ioengine=libaio --bs=8k --numjobs=16 --size=1G --runtime=600  --group_reporting\nseqwrite: (g=0): rw=write, bs=(R) 8192B-8192B, (W) 8192B-8192B, (T) 8192B-8192B, ioengine=libaio, iodepth=1\n... \nfio-3.25\nStarting 16 processes\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nseqwrite: Laying out IO file (1 file / 1024MiB)\nJobs: 16 (f=16): [W(16)][100.0%][w=3218MiB/s][w=412k IOPS][eta 00m:00s]\nseqwrite: (groupid=0, jobs=16): err= 0: pid=1680991: Sat Jan  8 12:07:53 2022\n  write: IOPS=398k, BW=3110MiB/s (3261MB/s)(16.0GiB/5268msec); 0 zone resets\n    slat (usec): min=6, max=108192, avg=36.06, stdev=429.09\n    clat (nsec): min=834, max=17356k, avg=1526.14, stdev=15762.08\n     lat (usec): min=7, max=108208, avg=37.90, stdev=429.63\n    clat percentiles (nsec):\n     |  1.00th=[  916],  5.00th=[  940], 10.00th=[  956], 20.00th=[  988],\n     | 30.00th=[ 1048], 40.00th=[ 1160], 50.00th=[ 1304], 60.00th=[ 1448],\n     | 70.00th=[ 1592], 80.00th=[ 1768], 90.00th=[ 2128], 95.00th=[ 2608],\n     | 99.00th=[ 4320], 99.50th=[ 5600], 99.90th=[11840], 99.95th=[16768],\n     | 99.99th=[33536]\n   bw (  MiB/s): min= 2074, max= 3972, per=100.00%, avg=3145.32, stdev=37.36, samples=158\n   iops        : min=265492, max=508464, avg=402599.37, stdev=4781.81, samples=158\n  lat (nsec)   : 1000=22.22%\n  lat (usec)   : 2=64.94%, 4=11.60%, 10=1.10%, 20=0.13%, 50=0.01%\n  lat (usec)   : 100=0.01%, 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\n  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%\n  cpu          : usr=8.90%, sys=66.20%, ctx=41092, majf=0, minf=402\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     issued rwts: total=0,2097152,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\n  WRITE: bw=3110MiB/s (3261MB/s), 3110MiB/s-3110MiB/s (3261MB/s-3261MB/s), io=16.0GiB (17.2GB), run=5268-5268msec\n</code></pre> <p>But, I am quite pleased to report around 3GB/s.</p> <p>Based on previous benchmarks I have performed against 970 evo NVMes\u2026 these numbers are extremely good.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2022/r720xd-bifurcation/#results","title":"Results","text":"<p>Based on the small amount of performance testing, I believe these devices are meeting my expectations of performance. Everything seems to be working at the same speed I was achieving before, and I successfully freed up 3 entire PCIe slots on my server.</p> <p>You may or may not have noticed- but, in a previous post, I powered down my brocade ICX6610 which was providing the 40Gbit connectivity. You may have also noticed, I reinstalled the 40G ConnectX-3 NIC during this post\u2026.</p> <p>And- moreso, if you have paid attention to my reddit comments, you may have picked up future 40Gbit connectivity to my main computer. To confirm, I do have 50 feet of fiber cable in the mail to complete this project\u2026 So, if anyone is curious to see iSCSI benchmarks over 40Gbit, stay tuned! Also- you may notice earlier in this post, I ordered TWO quad NVMe cards\u2026. More to come on this as well.</p>","tags":["TrueNAS","Homelab"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/","title":"Death of my r720XD","text":"<p>My r720XD took its last breath earlier this week...</p> <p></p> <p>This is just a short post about its troubleshooting, and.... what will replace it.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#what-happened","title":"What Happened?","text":"<p>Earlier this week, while I was installing my Solar panels, inverters, etc... I knew the power would be out all day. The idea- I would run everything important on my homemade UPS while the work was being done.</p> <p>Since- the R720XD is a bulk storage server primarly, and is not required for any of my critical services, I decided to shut it down to save 200watts or so of usage. This- was important because... I only have 2.4kwh of storage on my homemade UPS.</p> <p>Regarding the UPS- it performed fantastically. It maintained my fridge, freezer, gaming computer, kubernetes cluster, firewall, POE switch and everything else while the work was being done. </p> <p>Well, after the work was done, I went to power the r720XD back on.... and... Nothing.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#troubleshooting","title":"Troubleshooting","text":"<p>So- to troubleshoot, I removed the power cords, held the power button in for 10 seconds to drain the power- and reconnected power.</p> <p>At first- all looked good.</p> <p></p> <p>After a few seconds, the fan started kicking up- and a few warning lights appeared.</p> <p></p> <p>Ok- not a huge deal, right? Just a few warnings. And.... then....</p> <p></p> <p>Completely dead in the water! At this point, the power button is unresponsive. If you attempt to power the server on via iDrac, nothing happens.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#idrac-logs","title":"iDrac Logs?","text":"<p>iDrac presented a few errors for \"Power Supply Misconfiguration\"</p> <p></p> <p>So, at this point, I tried changing a few things. I tried...</p> <ol> <li>Only PSU 1</li> <li>Only PSU 2</li> <li>Both PSUs</li> <li>Connecting to different outlets</li> <li>Connecting only to inverter power</li> <li>Dancing with red slippers.</li> <li>Removing all of the HDDs, assuming perhaps the startup power was too much.</li> </ol> <p>No dice.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#remove-everything","title":"Remove everything!","text":"<p>The next troubleshooting step, was to remove every piece of non-essential hardware.</p> <p>So... I did.</p> <p></p> <p>I removed every PCIe device. The 2nd CPU was already done. I reseated all of the dimms. I disconnected the backplane.</p> <p>And? Nothing changed.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#final-notes-","title":"Final notes-","text":"<p>I will note, before the server \"shuts off\", both PSUs blink green fast, three times.</p> <p>IDrac remains fully operational the entire time.</p> <p>Once it shuts off, only removing power can get it to turn back on.</p> <p>At this point, its either an issue of a bad PSU, or a bad mainboard. </p> <p>If, anyone does have any ideas (That aren't already listed on Dell's troubleshooting guide....), I can give them a try.</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/death-of-my-poweredge-r720xd/#next-steps","title":"Next Steps","text":"<p>A replacement PSU can cost around 100$ a piece, even on eBay. A replacement mainboard, could potentially be in the same ballpark.</p> <p>Edit- I ended up finding a replacement PSU for 20$ shipped. If, the PSU fixes the server, at least I will have backup hardware if this ever happens again....</p> <p>So- Instead of potentially wasting a few hundred bucks attempting to guess to which component is having issues- </p> <p>I ordered a new (used) r730XD.</p> <p>This new server will exceed nearly everything about the r720XD it is going to replace. It will use less power. It should be faster in terms of compute. It has faster RAM. It has more HDD bays. It has native birfuracation which doesn't require fancy/expensive PLX cards</p> <p>So-</p> <p>Give a week or two for it to arrive in the mail, and I will do a quick write up of unboxing it, and getting it setup and configured to run my TrueNAS array.</p> <p>Speaking of my Array- it is setting on the bookshelf.</p> <p></p> <p>In the future, you can look forward to...</p> <ol> <li>Seeing if we can push the 40GBe ethernet project even faster!</li> <li>Comparing energy usage of the r720XD versus a newer r730XD.</li> </ol>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/","title":"ConnectX-3 Set Port Mode to ETH/IB","text":"<p>I just swapped my TrueNAS from a Dell R720XD over to a Dell r730XD. During this migration, I moved over my NVMe drives, NICs, and everything else relevant.</p> <p>However, after firing up TrueNAS on the new hardware, I noticed my 40G NIC was not listed in the list of devices!</p> <p>After once again googling how to change the mode over, I figured I would just quickly write some documentation incase this happens again in the future.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#depreciated","title":"Depreciated!!!!","text":"<p>Warn<p>A newer version of this post is available now.</p> </p> <p>See: ConnectX Guide</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#why-would-you-change-this","title":"Why would you change this?","text":"<p>Mellanox NICs can support traffic in either Ethernet mode, or Infiniband Mode. </p> <p>In ethernet mode, they function exactly like you would expect a NIC to work. However, in Infiniband mode, they work quite a bit different, and may require special drivers and software to perform correctly.</p> <p>For most homelab uses, you will generally want to ensure they are configured to ethernet mode.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#how-to-change-port-mode-of-connectx-3-nic","title":"How to change port mode of ConnectX-3 NIC","text":"","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#step-1-determine-the-pci-id","title":"Step 1. Determine the PCI ID.","text":"<p>You can do this using <code>lspci</code></p> <pre><code>root@truenas:~# lspci | grep Mell\n09:00.0 Network controller: Mellanox Technologies MT27500 Family [ConnectX-3]\n</code></pre> <p>In the above case, <code>09:00.0</code> is the information we are looking for.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#step-2-determine-current-port-mode","title":"Step 2. Determine current port mode.","text":"<pre><code>root@truenas:~# cat /sys/bus/pci/devices/0000\\:09\\:00.0/mlx4_port1\nib\nroot@truenas:~# cat /sys/bus/pci/devices/0000\\:09\\:00.0/mlx4_port2\neth\n</code></pre> <p>Using the above command, we can determine port1 is in infiniband mode, and port2 is in ethernet mode.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#step-3-how-to-change-port-mode","title":"Step 3. How to change port mode.","text":"<p>There are two ways you can change the port mode. You can either.... use a simple echo command, or, you can use mstflint.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#method-1-using-echo","title":"Method 1. Using echo.","text":"<pre><code>root@truenas:~# echo eth &gt; /sys/bus/pci/devices/0000\\:09\\:00.0/mlx4_port1\n-bash: echo: write error: Operation not supported\n\nroot@truenas:~# echo ib &gt; /sys/bus/pci/devices/0000\\:09\\:00.0/mlx4_port1\n\n# Works fine?\n</code></pre> <p>IF, this option does not work for you, then try using mstflint. If it does work (no error), reboot for it to take effect.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#method-2-using-mstflint","title":"Method 2. Using mstflint.","text":"<p><code>apt-get install mstflint</code></p> <p>Note- if you use TrueNAS like me... you may need to Re-enable apt-get</p> <p>Then use <code>mstflint -d {your pci id} q</code> to query info</p> <pre><code>root@truenas:~# mstconfig -d 09:00.0 q\n\nDevice #1:\n----------\n\nDevice type:    ConnectX3\nDevice:         09:00.0\n\nConfigurations:                              Next Boot\n         SRIOV_EN                            True(1)\n         NUM_OF_VFS                          8\n         LINK_TYPE_P1                        IB(1)\n         LINK_TYPE_P2                        ETH(2)\n         LOG_BAR_SIZE                        3\n         BOOT_PKEY_P1                        0\n         BOOT_PKEY_P2                        0\n         BOOT_OPTION_ROM_EN_P1               False(0)\n         BOOT_VLAN_EN_P1                     False(0)\n         BOOT_RETRY_CNT_P1                   0\n         LEGACY_BOOT_PROTOCOL_P1             PXE(1)\n         BOOT_VLAN_P1                        1\n         BOOT_OPTION_ROM_EN_P2               False(0)\n         BOOT_VLAN_EN_P2                     False(0)\n         BOOT_RETRY_CNT_P2                   0\n         LEGACY_BOOT_PROTOCOL_P2             PXE(1)\n         BOOT_VLAN_P2                        1\n         IP_VER_P1                           IPv4(0)\n         IP_VER_P2                           IPv4(0)\n         CQ_TIMESTAMP                        True(1)\n</code></pre> <p>For the <code>LINK_TYPE</code> fields, IB/1 = infiniband, ETH/2 = ethernet</p> <p>To change the mode, we can use <code>mstconfig -d 09:00.0 set LINK_TYPE_P1=2</code>, Just make sure to replace with your PCI device id.</p> <pre><code>root@truenas:~# mstconfig -d 09:00.0 set LINK_TYPE_P1=2\n\nDevice #1:\n----------\n\nDevice type:    ConnectX3\nDevice:         09:00.0\n\nConfigurations:                              Next Boot       New\n         LINK_TYPE_P1                        IB(1)           ETH(2)\n\n Apply new Configuration? (y/n) [n] : y\nApplying... Done!\n-I- Please reboot machine to load new configurations.\n</code></pre> <p>Per the note- you will need to reboot before this takes effect.</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-set-port-mode-to-ethib/#summary","title":"Summary","text":"<p>Just a quick guide on how to change the port mode of your ConnectX-3 NICs. This works for both the 10G and 40G variants.</p> <p>Also- the port-mode wasn't the issue as to why it wasn't being displayed- Instead- the NIC was at a differnet PCI address location. I just needed to move over the config. :-/</p>","tags":["Homelab","Networking/Mellanox"]},{"location":"blog/2023/network-performance-troubleshooting/","title":"How to identify and resolve network performance problems","text":"<p>Last week, I added a 10G Unifi aggregation switch to my network.</p> <p>I noticed a few potential performance issues, and decided to track them down.</p> <p>This is a simple guide, with a few methods you can leverage to troubleshoot network performance issues. </p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#my-topology","title":"My Topology","text":"<p>For this experiment, I have 4 servers which will be used for testing.</p> <ol> <li>Opnsense - HP Z240 Dual port 10G Intel X540-T2</li> <li>TrueNAS - Dell R730 Dual port 10G Dell X540 / 099GTM Daughterboard</li> <li>Kube01 - Optiplex 7060 i7-8700 10G ConnectX-3 MCX311A-XCAT</li> <li>Kube05 - HP Z240 i5-6500 10G ConnectX-3 MCX311A-XCAT</li> </ol> <p>All nodes are connected to a 10G Unifi Aggregation Switch</p> <p>Kube01 and Kube02, are leveraging Really Cheap DACs</p> <p>TrueNAS / Opnsense both leverage off-brand, cheapest of the cheap 10GBase-T modules to connect Cat6 into the switch.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#troubleshooting","title":"Troubleshooting","text":"","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#step-1-do-iperf-tests-between-nodes","title":"Step 1. Do iperf tests between nodes.","text":"<p>To run iperf3 server: <code>iperf3 -s</code></p> <p>To run test from a client: <code>iperf3 -c ip.of.your.server</code></p> <p>To run bidirectional test, use <code>--bidir</code> flag.</p> <p>For this post, I will be using <code>iperf3 -s target.ip --bidir</code> to do a bidirectial test from each combination of nodes. You will need to run <code>iperf3 -s</code> on the receiving server.</p> Sender Receiver Bandwidth Retries Kube01 Kube05 9.27 0 Kube01 Opnsense 4 150 Kube01 TrueNAS 5.81 3826 Kube05 Kube01 9.24 1028 Kube05 TrueNAS 6.79 4168 Opnsense Kube01 5 0 Opnsense Kube05 5 0 Opnsense TrueNAS 5.48 842 TrueNAS Kube01 9.16 0 TrueNAS Kube05 9.11 1637 TrueNAS Opnsense 5.09 0","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#step-2-interpret-the-results","title":"Step 2. Interpret the results","text":"<p>After looking at the data-</p> <p>There are generally no retransmits / issues when sending data to kube01, and kube05. Both are able to receive 10Gbit/s no problem.</p> <p>ANY test going to or from Opnsense, encounters the single-core iperf limitations, and generally is limited to 5-6Gbit/s of traffic.</p> <p>TrueNAS is unable to receive data without encountering retransmits, as well, it never receives more then 5-6Gbit/s.</p> <p>TrueNAS appears to be able to send data, without issue, and is able to achieve expected speeds.</p> <p>To help normalize the results, I decided to switch all of these nodes over to 9k MTU jumbo frames. To note, This is NOT required for 10GBe.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#iperf-cpu-limitation","title":"iperf / cpu limitation","text":"<p>I noticed while running iperf on opnsense, its thread was at 100% usage.</p> <p>iperf3 is single-threaded, which can make it more challenging to test 10/25/40/100GBe networks. This is especially a problem, when the single-threaded performance of a CPU is lower.</p> <p>From Opnsense while running tests <pre><code>PID USERNAME    THR PRI NICE   SIZE    RES STATE    C   TIME    WCPU COMMAND\n29147 root          1  85    0    17M  6296K CPU0     0   0:06  98.54% iperf3\n</code></pre> Despite having additional cores on the system for use, iperf will only use a single thread.</p> <p>Using <code>-P 4</code> will generate 4 parallel streams, however, is still limited to a single thread.</p> <pre><code>firewall:~ # iperf3 -c 10.100.5.2 -P 4\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID] Interval           Transfer     Bitrate         Retr\n[SUM]   0.00-10.00  sec  9.02 GBytes  7.75 Gbits/sec  8630\n</code></pre>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#switching-to-jumbo-frames","title":"Switching to Jumbo Frames","text":"<p>After taking a bit to switch all of the interfaces over to leverage a 9,000 mtu, I saw dramatically increased performance across the board, with far fewer retransmits.</p> Sender Receiver Bandwidth Retries Kube01 Kube05 9.7 0 Kube01 TrueNAS 9.6 26 Kube05 Kube01 9.7 0 Kube05 TrueNAS 9.6 21 TrueNAS Kube01 9.8 1 TrueNAS Kube05 9.8 85 Kube01 Opnsense 9.7 0 Opnsense Kube01 9.4 0 TrueNAS Opnsense 9.8 0 Opnsense TrueNAS 8.2 436 Kube05 Opnsense 700Mbit 0 Opnsense Kube05 46Mbit 853 <p>Now- nearly everything is working perfectly, EXCEPT, traffic going from kube05, to Opnsense.</p> <p>I suspect, this is an issue with the adapter.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#troubleshooting-kube05-opnsense","title":"Troubleshooting Kube05 -&gt; Opnsense","text":"<p>Since, kube05 works just fine testing to any of the other servers, this wouldn't be an issue relating to the physical network or cables. As well, this is likely not a switch issue.</p> <p>I suspect, this is an issue with interfaces on the machine itself.</p> <pre><code>kube05:~# ifconfig\n(extra junk cleared out)\neno1      Link encap:Ethernet  HWaddr A0:8C:FD:C0:46:6D\n          inet addr:10.100.5.103  Bcast:10.100.5.255  Mask:255.255.255.0\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:3145017 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:3955835 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000\n          RX bytes:462587507 (441.1 MiB)  TX bytes:5595142800 (5.2 GiB)\n          Interrupt:16 Memory:d1a00000-d1a20000\n\nenp1s0    Link encap:Ethernet  HWaddr E4:1D:2D:DD:88:A0\n          inet addr:10.100.5.105  Bcast:10.100.5.255  Mask:255.255.255.0\n          UP BROADCAST RUNNING MULTICAST  MTU:9000  Metric:1\n          RX packets:117799483 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:84629781 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000\n          RX bytes:147325596294 (137.2 GiB)  TX bytes:103176751032 (96.0 GiB)\n</code></pre> <p>So- eno1, is the onboard 1GBe nic... which, shouldn't be active.</p> <p>The solution here was quite simple. I wanted to leave it DHCP enabled, in the event I needed to access this box, without the 10GBe interface.</p> <p>So, I unplugged the cable!</p> <pre><code>kube05:~# iperf3 -c 10.100.5.1 --bidir\nConnecting to host 10.100.5.1, port 5201\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID][Role] Interval           Transfer     Bitrate         Retr\n[  5][TX-C]   0.00-10.00  sec  11.1 GBytes  9.52 Gbits/sec    0\n[  7][RX-C]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec    0\n</code></pre> <p>Easiest fix ever, right?</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#summary","title":"Summary","text":"<p>I was quite certain my issue was related to the really cheap DACs / SFP modules in use. However- turns out, it was all configuration issues.</p> <p>I started by looking the 10G NICs. I ensured proper settings and offloading was enabled. This did not help any.</p> <p>The next step, was to put togather a metrix showing performance between each node. This allowed me to actually rule out most of the cables and connections, by showing nodes which were working at full speed.</p> <p>The final step, was changing the MTU size.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/network-performance-troubleshooting/#why-did-mtu-size-fix-everything","title":"Why did MTU size fix everything?","text":"<p>NORMALLY, a larger MTU size won't have nearly as dramatic as a difference in my tests. </p> <p>However- one thing that was not clearly noted here- There are multiple vlans coming out of the interfaces for both Opnsense, and TrueNAS. ONE of the vlans was already set to 9,000MTU jumbo frames.</p> <p>My assumptions on what happened-</p> <ol> <li>Opnsense has low single-threaded CPU performance. This caused its results to be low across the board.</li> <li>Data being sent to TrueNAS, was low across the board too. I believe this is due to its 10G interface having another vlan already, with jumbo frames enabled.<ul> <li>It doesn't make sense to me, why its receive speed would be low, however. But, jumbo frames did correct this.</li> <li>This MAY be related to single-threaded iperf performance too. The CPU on my TrueNAS box has a lot of cores(40 of them), but, each core is quite slow.</li> </ul> </li> <li>Larger packet sizes cuts down on the amount of CPU required to process packets.</li> <li>Kube05 obviously had a network identify crisis, with two NICs on the same network, each with differing MTUs.</li> </ol> <p>So, my hopes of publishing this post, is to give you ideas of where to start troubleshooting network performance issues.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/connectx-3-configuration/","title":"How to configure ConnectX-3 via Linux","text":"<p>A quick guide on how to set common options with the ConnectX-3, via linux, without using the OFED driver.</p> <p>This guide is specific to ethernet mode, but, may or may not work with infiniband mode.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#depreciated","title":"Depreciated!!!!","text":"<p>Warn<p>A newer version of this post is available now.</p> </p> <p>See: ConnectX Guide</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#software-needed","title":"Software Needed","text":"<p>To perform general configuration of the ConnectX-3, we will need....</p> <ul> <li>ethtool<ul> <li><code>apt-get install ethtool</code></li> </ul> </li> <li>ConnectX-3 set in ETHERNET mode.<ul> <li>How to set ConnectX-3 to Ethernet</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#configuration","title":"Configuration","text":"<p>Note, for the following steps, replace <code>enp1s0</code> with your interface.</p> <p>If, you do not know how to find your interface's name, this guide likely isn't for you.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#ring-buffer-size","title":"Ring / Buffer Size","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#get-values","title":"Get Values","text":"<p><code>ethtool -g enp1s0</code></p> <pre><code># ethtool -g enp1s0\nRing parameters for enp1s0:\nPre-set maximums:\nRX:             8192\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             8192\nCurrent hardware settings:\nRX:             8192\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             8192\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#set-values","title":"Set Values","text":"<p><code>ethtool -G enp1s0 rx 8192 tx 8192</code></p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#offloading","title":"Offloading","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#get-values_1","title":"Get Values","text":"<p><code>ethtool -k enp1s0</code></p> <pre><code># ethtool -k enp1s0\nFeatures for enp1s0:\nrx-checksumming: on\ntx-checksumming: on\n        tx-checksum-ipv4: on\n        tx-checksum-ip-generic: off [fixed]\n        tx-checksum-ipv6: on\n        tx-checksum-fcoe-crc: off [fixed]\n        tx-checksum-sctp: off [fixed]\nscatter-gather: on\n        tx-scatter-gather: on\n        tx-scatter-gather-fraglist: off [fixed]\ntcp-segmentation-offload: on\n        tx-tcp-segmentation: on\n        tx-tcp-ecn-segmentation: off [fixed]\n        tx-tcp-mangleid-segmentation: off\n        tx-tcp6-segmentation: on\ngeneric-segmentation-offload: on\ngeneric-receive-offload: on\nlarge-receive-offload: off [fixed]\nrx-vlan-offload: on\ntx-vlan-offload: on\nntuple-filters: off [fixed]\nreceive-hashing: on\nhighdma: on [fixed]\nrx-vlan-filter: on [fixed]\nvlan-challenged: off [fixed]\ntx-lockless: off [fixed]\nnetns-local: off [fixed]\ntx-gso-robust: off [fixed]\ntx-fcoe-segmentation: off [fixed]\ntx-gre-segmentation: off [fixed]\ntx-gre-csum-segmentation: off [fixed]\ntx-ipxip4-segmentation: off [fixed]\ntx-ipxip6-segmentation: off [fixed]\ntx-udp_tnl-segmentation: off [fixed]\ntx-udp_tnl-csum-segmentation: off [fixed]\ntx-gso-partial: off [fixed]\ntx-tunnel-remcsum-segmentation: off [fixed]\ntx-sctp-segmentation: off [fixed]\ntx-esp-segmentation: off [fixed]\ntx-udp-segmentation: off [fixed]\ntx-gso-list: off [fixed]\nfcoe-mtu: off [fixed]\ntx-nocache-copy: off\nloopback: off\nrx-fcs: off\nrx-all: off\ntx-vlan-stag-hw-insert: off\nrx-vlan-stag-hw-parse: on\nrx-vlan-stag-filter: on [fixed]\nl2-fwd-offload: off [fixed]\nhw-tc-offload: off [fixed]\nesp-hw-offload: off [fixed]\nesp-tx-csum-hw-offload: off [fixed]\nrx-udp_tunnel-port-offload: off [fixed]\ntls-hw-tx-offload: off [fixed]\ntls-hw-rx-offload: off [fixed]\nrx-gro-hw: off [fixed]\ntls-hw-record: off [fixed]\nrx-gro-list: off\nmacsec-hw-offload: off [fixed]\nrx-udp-gro-forwarding: off\nhsr-tag-ins-offload: off [fixed]\nhsr-tag-rm-offload: off [fixed]\nhsr-fwd-offload: off [fixed]\nhsr-dup-offload: off [fixed]\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#set-values_1","title":"Set Values","text":"<p><code>ethtool -K enp1s0 tso on lro on</code></p> <pre><code># ethtool -K enp1s0 tso on lro on\nActual changes:\nrx-lro: off [requested on]\ntx-tcp-ecn-segmentation: off [requested on]\ntx-tcp-mangleid-segmentation: on\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#other-resources","title":"Other Resources","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/connectx-3-configuration/#users-manual","title":"User's Manual","text":"<p>This manual contains many of the steps above, documented in better detail.</p> <p>Page 68 contains ethtool specific documentation.</p> <p>User's Manual</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/","title":"2023 Network Revamp, and Homelab History","text":"<p>Going over the history of my home network from the previous three years... and...</p> <p>Deploying a Brocade ICX-6450 and Dell R730XD, without increasing power consumption.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#introduction","title":"Introduction","text":"<p>Back in Jan 2023, My r720XD lost both of its PSUs. Even after acquiring a new PSU, it still had a lot of power errors being displayed. So, I felt it was time to lay it to rest and replace it.</p> <p>Part of this project, I will be replacing it with a R730XD, then customizing the R730XD to be more energy efficient. </p> <p>As well, Back in Dec 2021, I Removed my Brocade ICX-6610. While, removal of the switch made a VERY distinct drop in my overall power utilization, I still found myself missing some of the capabilities of this switch. Mainly- the ability to do layer 3 routing, combined with layer 4 ACLs at line speed, on all ports, at the same time. </p> <p>BUT, I didn't want the noise, or power utilization of the ICX-6610. It was overly loud, and consumed a lot of energy.</p> <p>However, I will be replacing my existing Zyxel GS1900-24EP with the Brocade ICX-6450-48P, in an attempt to aggregate my 10G backbone, and- without greatly increasing noise and energy consumption.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#network-homelab-history","title":"Network / Homelab History","text":"<p>If you are not interested in the history of my home network, please feel free to SKIP TO PLANNED CHANGES</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#2020","title":"2020","text":"<p>At this time, my network was pretty simple.</p> <ul> <li>Ubquitity EdgeRouter 5, POE </li> <li>Unifi UAP-AC-PRO</li> <li>A Raspberry PI</li> </ul> <p>That was it! In the time before COVID, and I had to physically goto work every day, I really didn't have any serious home infrastructure.</p> <p>Pre-covid, I did start to experiment with home assistant, running it on a raspberry pi. But, there wasn't anything serious at this point.</p> <p>Once COVID happened, and I started working from home, the amount of home-automation projects I started tackling skyrocketed. At this point, the pi-4 was not up to the task anymore with the demands I was placing on it.</p> <p>So, I considered getting a synology NAS. After looking the prices- I felt I could built my own NAS, better AND cheaper.</p> <p>500$ Closet NAS Build</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#2021","title":"2021","text":"<p>Well, I started adding a ton of security cameras, and even more and more automation.</p> <p>As such, the compute and networking demands on my home network were quickly increasing beyond what my infrastructure could provide.</p> <p>So- I upgraded.</p> <p>10/40G Network Upgrade</p> <ul> <li>Brocade ICX-6610 1/10/40G switch</li> <li>Dell R720XD Running TrueNAS Scale</li> </ul> <p>And- everything was fast. I had tons of spare capacity.</p> <p>Here is the network as of the end of 2021.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#2022","title":"2022","text":"<p>I learned that electricity bills can get pretty expensive. Especially when you have a record breaking heat wave, causing it to be 110F outside for two months STRAIGHT.</p> <p>For literally two months, my Air condition would turn on around 8am, and would run until 2am the next morning try to keep the house cool.</p> <p>For reference, here is my WH of AC utilization per day for 2022.</p> <p>~</p> <p>1.5 mWh of consumption, in July. From My A/C Alone. That is 120$ alone! Not including the load of all of my servers running.</p> <p>I don't have a large house! </p> <p>So, the goal was to start trimming as much energy usage as possible.</p> <p>If you wish to read about a few of the things performed in details- See 40G NAS Project</p> <p>To summarize:</p> <ol> <li>R720XD put on a massive hardware diet.</li> <li>Additional, Newer more efficient SFFs added to take over compute loads from the inefficient E5-2667v2.</li> <li>10/40G Brocade replaced with 1G only Zyxel.</li> </ol> <p>This managed to get my network power utilization down to around 375-450w average, from 500-600w. As well, it GREATLY reduced the amount of noise in the server room.</p> <p>Here is a diagram of my network at the end of 2022.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#late-2022-kubernetes","title":"Late 2022 - Kubernetes","text":"<p>I started learning about Kubernetes. Well, this caused the number of servers in my rack to increase by a few to support my newfound passion.</p> <p>As well, I leveraged local NVMe on each of the nodes, with replicated ceph storage. Come to find out, ceph will completely annihilate the 1G link, which is also needed by control plane traffic. </p> <p>So, I needed to once again, establish 10G switching capabilities in my rack. I added a Unifi Aggregation Switch to handle this.</p> <p>And, it is quite efficient in terms of power usage, generally using around 15w, with 4x 10G links connected, and a 1G link via 10GBase-T module.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#2023","title":"2023","text":"<p>Again, I find my power consumption starting to creep up as I keep expanding out my Kubernetes environment. </p> <p>AND, My r720XD died, and was replaced with a r730XD. (Documented below). Power consumption increased from 190w of my stripped down R720XD, up to ~250W for the new R730XD.</p> <p>As well, I am REALLY missing some of the L3 routing capabilities I had with the Brocade ICX-6610.</p> <p>The solution here, was to replace my Zyxel core switch, with a modified Brocade ICX-6450-48P.</p> <p>The modifications are simple- Replacing the fans with quieter variants. The datasheet shows around a 30w idle consumption. </p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#planned-changes","title":"Planned Changes:","text":"<p>Here are the changes I hope to accomplish during this project:</p> <ol> <li>10G connectivity between all major components in my rack.</li> <li>Simplified network design.</li> <li>Reduced power consumption from putting the R730XD on a diet.</li> <li>Some VLANs/ACLs will be moved from Opnsense to the new switch, reducing Opnsense overhead.</li> <li>Removal of extra links <ul> <li>4-link lagg currently exists between Opnsense and the Zyxel switch.<ul> <li>Only a single 10G link for LAN, and a single 1G link for WAN after this is completed.</li> </ul> </li> <li>6-total network connections between TrueNAS and other systems. <ul> <li>Only a single 10G link to the aggregation switch will exist afterwards.</li> <li>40G point to point connection may be removed as well. Undetermined at this point.</li> </ul> </li> </ul> </li> </ol> <p>Here is the planned network diagram:</p> <p></p> <p>Why is the WAN connected to the Office/Bedroom switch??!?</p> <p>For those wondering why my wan connects to the bedroom switch- its because the fiber is terminated there. I do not have/want to invest in the tools to properly re-terminate the fiber currently. </p> <p>As such, it has an isolated vlan, which is only shared by the WAN port on the office/bedroom switch, and the WAN -&gt; Firewall port on the Core Switch.</p> <p>Since, the link between the two switches is 10Gigabit, and the internet speed is 1Gigabit MAX, there are no concerns of bottlenecks here.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#installing-the-brocade-icx-6450-48-p","title":"Installing the Brocade ICX-6450-48-P","text":"<p>Just a friendly reminder- make sure you have a console cable!</p> <p></p> <p>Always keep one of these somewhere.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-the-fans","title":"Replacing the fans","text":"<p>While the stock fans aren't overly loud, I wanted to replace them to make sure the switch was barely audible.</p> <p>I used information from this servethehome post and ordered the Delta fans from Digikey.</p> <p>Replacing the fans isn't hard at all. </p> <p>Check if your new fans have the header already included or not!</p> <p>The fans I received from digikey did not have a fan header already attached.</p> <p>Since- I didn't have a spare header around, I removed the old headers, and soldered the new fans onto them.</p> <p>First- remove the cover. </p> <p></p> <p>Then, remove the old fans. Here is a comparison between the stock fans (Left), and Delta fans (Right.)</p> <p></p> <p>Afterwards, Just attach the new fans, and plug them in.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-my-old-switch","title":"Replacing my old switch","text":"<p>First- here is my rack before starting work.</p> <p></p> <p>Since.... I share a house with my Wife and kids, who.... happen to stream TV, games, etc using the network/internet.....</p> <p>It was a high priority on my list to perform this migration WITHOUT impacting them. Happy wife = happy life.</p> <p>To perform the migration without bringing anything down- I unracked the old switch (It was just setting on a shelf...), and set it on the top of my rack.</p> <p></p> <p>This allowed me to configure ports one by one, migrate vlans, and move the circuits over.</p> <p>Since- my network makes very heavy use of vlans for segregation- this approach worked very well.</p> <p>After installing the new switch, I cleaned up the rack just a hair. More to come later...</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#power-usage-20-to-30-watts","title":"Power Usage - +20 to 30 watts.","text":"<p>As expected, the Brocade indeed uses more energy then the Zyxel.</p> <p>The brocade, with nothing connected, and no loads, runs around 50w of consumption.</p> <p>I have around 30w of total POE loads.</p> <p>All said and done, the Brocade uses around 85 to 90 watts pretty consistently with everything connected.</p> <p></p> <p>However, in exchange for added power consumption, we have gained a few benefits:</p> <ol> <li>A core switch with 10GBe connectivity. This means, there is no longer the need for different 1G / 10G interfaces handing off of the firewall. This simplifies the network.</li> <li>Layer 3 routing and ACLs, independent of the firewall. <ul> <li>This can be leveraged to reduce the load hitting the firewall, improving performance and reducing consumption.</li> </ul> </li> <li>A much better VLAN configuration interface. (I really disliked the interface on the Zyxel...)</li> </ol>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#r730xd-power-reduction","title":"R730XD Power Reduction","text":"<p>Since, my R730XD has been consuming around 240w average, I wanted to get it closer to the 190w average of my R720XD.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#changes","title":"Changes","text":"","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#cpu-replacement-28-watts-saved","title":"CPU Replacement - 28 watts saved.","text":"<p>I replaced the Dual E5-2680v3 Xeons, with a single E5-2667v4.</p> <p>I purposely did not choose a low power variant, because the last time I did that- I lost a lot of performance, without much energy savings. </p> <p>Instead, I went with a processor with very good single threaded performance.</p> <p>This saved a total of 28 watts.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#removing-unused-hdds-14-watts-saved","title":"Removing unused HDDs - 14 watts saved","text":"<p>I had a few extra HDDs in my r730XD which were not in use. Despite having spin down enabled, removal of two extra drives somehow saved energy. </p> <p>2TB + 3TB removed = 14 watts saved.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#optimizing-fans-14-watts-saved","title":"Optimizing Fans - 14 watts saved","text":"<p>Originally, I attempted to throttle the fans down using racadm.</p> <p>Dell: Modifying thermal settings using iDrac</p> <p>I specified the following settings:</p> <ul> <li><code>racadm set system.thermalsettings.ThirdPartyPCIFanResponse 0</code></li> <li><code>racadm set system.thermalsettings.FanSpeedOffset 255</code></li> <li><code>racadm set system.thermalsettings.FanSpeedLowOffsetVal 0</code></li> <li><code>racadm set system.thermalsettings.ThermalProfile 2</code></li> </ul> <p>However, the fans would never go below 40%, despite great temps.</p> <p>So, instead, I leveraged <code>ipmitool</code> to manually set the fans at 20%.</p> <p>After carefully watching temps, this value seems good.</p> <p>Manually setting fan speed</p> <p>For an even better solution, I found THIS REDDIT POST containing a script which allows you to manually define fan curves.</p> <p>But, for now, manually turning the fans down to 20% reduced power consumption by another 14 watts.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-boot-pool-drives-0-watts-saved","title":"Replacing boot pool drives. - 0 watts saved","text":"<p>My boot pool consisted of a pair of 10k 250G 2.5\" SAS disks.</p> <p>After the power savings from removing some of the other drives from my server, I felt I could gain a easy 10-20w power saving by replacing these 10k sas drives.</p> <p>So, I replaced them with a single 250G 2.5\" SATA SSD.</p> <p>No redundant boot pool? WTF</p> <p>I actually ordered two mixed-vendor SATA SSDs to use in a mirrored boot pool configuration.</p> <p>However, the second disk was throwing a lot of I/O errors, and was unable to be used. In the future, I will mirror the boot pool to a second drive.</p> <p>Sadly- after fiddling with a bad SSD for a few hours- I was greeted by saving...... zero watts.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#removing-all-of-the-hdds-total-98w-average","title":"Removing ALL of the HDDs - Total 98w average","text":"<p>While, attempting to reinstall TrueNAS onto my new SATA SSDs, for safety, I removed the HDDs for my primary array.</p> <p>During the installation process, power usage remained at a steady 98w.</p> <p>With that said, we can conclude the HDDs spinning in my array draw around 80 watts. </p> <p>That is- 8 drives normally spinning at all times, so, ~10 watts each.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#r730xd-summary-72-watts-saved","title":"R730XD Summary - 72 watts saved","text":"<ol> <li>Base power consumption<ul> <li>238w average</li> </ul> </li> <li>CPU Replacement<ul> <li>2x E5-2680v3 replaced with SINGLE E5-2667v4. BIOS Power Settings Optimized. </li> <li>-28 watts, 210w average.</li> </ul> </li> <li>Lowered memory frequency. No change.</li> <li>14 watts saved - Removed two HDDs from server, which were not in a pool.<ul> <li>Surprising, since these HDDs were set to maximum power savings with spin-down enabled. </li> <li>-14 watts, 196w average</li> </ul> </li> <li>Removed second power supply.<ul> <li>-14 watts, 182w average.</li> </ul> </li> <li>Manually setting fan speed.<ul> <li>14 watts, 168w average.</li> </ul> </li> </ol>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#40gbe-benchmarking","title":"40GBe Benchmarking","text":"<p>While I took quite a few measures to reduce power consumption, I still need my NAS to be able to perform. So, lets benchmark it.</p> <p>Hitting my flash pool, over 40GBe fiber via iSCSI.</p> <p></p> <p>Yup. Seems like performance is pretty good.</p> <p>Lets look at the metrics.</p> <p>CPU / Temps:</p> <p></p> <p>Temperatures remained within spec. No issues here.</p> <p>Network Usage: </p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#but-its-all-cache-you-are-just-benchmarking-your-cache","title":"BUT ITS ALL CACHE, YOU ARE JUST BENCHMARKING YOUR CACHE!!!","text":"<p>You might be correct...</p> <p></p> <p>BUT, in a real-world scenario, there are hardly any files that will not fit in my ARC.</p> <p>And, in a real-world scenario, my ARC hit rates are even higher then during benchmarking.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#kubernetes-updates","title":"Kubernetes Updates","text":"","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-hp-z240-sff-with-optiplex-3060-micro-15-25-watts-saved","title":"Replacing HP Z240 SFF with Optiplex 3060 Micro - 15-25 watts saved.","text":"<p>I felt I could do a few tweaks to my Kubernetes environment to save some power here as well.</p> <p>I started by replacing my HP Z240, with a Optiplex 3060M.</p> <p>The 3060 micro, doesn't have additional PCIe slots, however, it does have extremely low power consumption.</p> <p>The HP had a i7-6700, while the Optiplex has a i5-8500t. According to CPU Benchmark, I should have roughly the same compute power, with half of the energy.</p> <p>In addition to saving energy, this also cleaned up some room in my rack.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#firewall-opnsense-updates","title":"Firewall / Opnsense Updates","text":"<p>During this update, I wanted to improve the overall security, AND reliability of my home network as well. </p> <p>In the event the primary firewall is down, everything internal to my network should still work.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-hp-z240-with-optiplex-3060m-40-watts-saved","title":"Replacing HP Z240 with Optiplex 3060m - 40 watts saved","text":"<p>Since- all of the 10G routing is now handled by the Brocade, and all internal routing is handled between the switches/routers- I no longer need a firewall with full 10G connectivity.</p> <p>I only pay for 500 down/100 up WAN. </p> <p>So- I replaced the HP Z240, with a optiplex 3060m. </p> <p>Specs: * i5-8500t * 8Gb DDR4 RAM. * 256G NVMe.</p> <p>This box, is nothing special. However, it idles around 10 watts and has more then enough power for processing its traffic.</p> <p>It is responsible for: 1. Primary WAN firewall 2. NAT 3. Primary DNS server 4. VPN 5. Primary NTP server =======</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#firewall-updates","title":"Firewall Updates","text":"","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#replacing-opnsense-hardware-31-watts-saved","title":"Replacing Opnsense Hardware - 31 watts saved","text":"<p>At the start of this project, my firewall ran on a HP Z240, i5-6500/8g. </p> <p>It also had a quad 1G NIC, and a dual port Intel X540-T2 10G NIC. </p> <p>All said and done, it used around 35-45 watts, very consistently. </p> <p></p> <p>So- I felt there was room for improving this.</p> <p>I had an extra Optiplex laying around with a i5-8500T and 8G of ram. I felt this would make a great replacement.</p> <p>This new optiplex barely sips energy, averaging around 8-11 watts.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#optimizing-network-layout","title":"Optimizing network layout","text":"<p>Since, the new optiplex does not have 10G connectivity, and is limited to only 1G of throughput- I decided to re-architect the network to prevent this from being a bottleneck.</p> <p>So- I added an existing Edgerouter I had for handling the IOT/Security/Management VLANS, and I moved the LAN/SERVER traffic over to the new Brocade.</p> <p>Here- is a logical diagram showing the flow of data:</p> <p></p> <p>Another benefit of this approach, when updating/rebooting the primary firewall, only WAN/VPN traffic is affected now.</p> <p>OSPF is leveraged between Opnsense, the Edgerouter, and the Brocade for distributing routes. Each device announces its own subnets, and redistributes to the other devices.</p> <p>As such, adding/removing vlans/subnets is quite easy. </p>","tags":["Homelab","Networking"]},{"location":"blog/2023/2023-network-revamp-and-homelab-history/#overall","title":"Overall?","text":"<p>Overall- success.</p> <p>Under 500w.</p> <p>Here is the daily average power utilization for my server rack:</p> <p></p> <p>(This post is still a work-in-progress.)</p> <p>But, as of 4/20, average rack utilization is around 450w.</p>","tags":["Homelab","Networking"]},{"location":"blog/2023/join-the-fediverse/","title":"Join the Fediverse","text":"<p>Want to learn more about how to use the fediverse? </p> <p>Here are a few short tips to get started.</p>"},{"location":"blog/2023/join-the-fediverse/#what-is-the-fediverse","title":"What is the fediverse?","text":"<p>The Fediverse refers to a group of interconnected, decentralized, and federated servers.</p> <p>Mastadon, for example, works much like twitter.</p> <p>KBin and Lemmy, for example, works in the same way as reddit.</p> <p>ALL of these applications are interconnected.</p> <p>If- you are out of the loop as to why everyone is looking for alternatives- see... The end of reddit</p> <p>Here, is a useful infographic to explain some of the concepts.</p> <p></p>"},{"location":"blog/2023/join-the-fediverse/#useful-links","title":"Useful Links","text":"<p>Here is a section of useful links, and locations.</p>"},{"location":"blog/2023/join-the-fediverse/#tools","title":"Tools","text":"<ul> <li>Lemmy Community-Browser</li> <li>https://fediverse.party/</li> <li>Lemmy Stats / The Federation</li> <li>Lemmy Stats / Fediverse</li> <li>Lemmy Server List (Shows uptime) / Fediverse</li> <li>History of Lemmy</li> <li> <p>Subreddit Migration Finder</p> </li> <li> <p>Lemmy Account Migrator</p> <ul> <li>Python Script - This migrates your subscribed communities from one instance, to another.</li> </ul> </li> </ul>"},{"location":"blog/2023/join-the-fediverse/#places-to-join","title":"Places to join","text":"<ul> <li>https://join-lemmy.org/</li> <li>https://joinmastodon.org/</li> <li>My Self-Hosted Lemmy Instance</li> </ul>"},{"location":"blog/2023/join-the-fediverse/#mobile-applications","title":"Mobile Applications","text":"<p>Disclaimer- I have not tested any of these options, nor am I providing endorsements. </p> <ul> <li>Android<ul> <li>Jerboa<ul> <li>Github</li> <li>Google Play Store</li> </ul> </li> <li>Liftoff<ul> <li>Github</li> </ul> </li> <li>Lemmy itself, functions as a progressive web application. (Click menu, save to desktop)</li> </ul> </li> </ul> <p>Here is also a Kbin post containing a much more thorough list of options, including IOS options.</p> <p>Note- There is a rumor Sync for reddit will support the fediverse as on June 30th. Unconfirmed. </p>"},{"location":"blog/2023/join-the-fediverse/#how-to-join","title":"How to Join","text":""},{"location":"blog/2023/join-the-fediverse/#how-to-join-lemmy","title":"How to join lemmy?","text":"<p>You, can either join the server I am running LemmyOnline.com, or choose from one of the hundreds of available servers at https://join-lemmy.org/</p> <p>Do note, the only importance of the server you choose, is uptime and performance. Content is visible from any instance, for any instance. </p> <p>So, it is possible, for example, a user on lemmyonline.com, to read a post on lemmy.world, written by a user on kbin.social... and to do so, all transparently. </p>"},{"location":"blog/2023/join-the-fediverse/#why-should-i-join-xx-instance-instead-of-lemmyworld","title":"Why should I join XX instance, instead of lemmy.world?","text":"<ol> <li>Everything is federated. You can view any instance, from any other instance, as long as they aren't defederated. (Everything is federated by default.)</li> <li>As such, the content you want to view, is not limited by your instance.</li> <li>Joining a bigger instance MIGHT seem like the best thing to do, HOWEVER, you are likely to have a better user experience on a smaller, less loaded instance. This is due to less load.</li> <li>I won't force you to join my instance. However, I do recommend you pick an instance with high uptime. List of Instances</li> </ol>"},{"location":"blog/2023/join-the-fediverse/#what-if-i-want-to-host-my-own-instance","title":"What if I want to host my own instance?","text":"<p>You can!</p> <p>Follow the Official Documentation for Lemmy</p> <p>Do note, you WILL need a valid domain, and https certificate for federation to work. (Federation does not work without TLS)</p>"},{"location":"blog/2023/join-the-fediverse/#how-to-join-mastadon","title":"How to join mastadon?","text":"<p>JoinMastodon</p> <p>Again, it is completely possible for a user on mastadon, to post onto a lemmy server. Remember, everything is interconnected. </p>"},{"location":"blog/2023/join-the-fediverse/#how-can-i-move-my-account","title":"How can I move my account?","text":"<p>The easy answer, you don't </p> <p>At this current time, you would need to create a new account, on a new server.</p> <p>You can use the Lemmy Account Migrator to migrate your subscriptions to your new server.</p>"},{"location":"blog/2023/join-the-fediverse/#how-do-i-see-other-content-i-cant-see-any-of-the-communities-i-want-to-see","title":"How do I see other content?? I can't see any of the communities I want to see.","text":""},{"location":"blog/2023/join-the-fediverse/#how-do-i-subscribe-to-communities-from-other-instances","title":"How do I subscribe to communities from other instances?","text":"<p>I can't see anything!!</p> <p></p> <p>The first step- is to click \"ALL\". By default, only \"LOCAL\" posts/comments are displayed.</p> <p></p> <p>After clicking \"ALL\", you can see all of the communities your instance has subscribed to.</p> <p></p>"},{"location":"blog/2023/join-the-fediverse/#what-communities-has-my-instance-subscribed-to","title":"What communities has my instance subscribed to?","text":"<p>Click Communities at the top</p> <p></p> <p>Once you open the communities screen, click \"ALL\". Afterwards, you will see all communities your instance has subscribed to.</p> <p></p>"},{"location":"blog/2023/join-the-fediverse/#what-if-the-community-i-am-looking-for-is-not-there","title":"What if the community I am looking for is not there?","text":"<ol> <li>Use the Community-Browser</li> </ol>"},{"location":"blog/2023/join-the-fediverse/#how-do-i-subscribe-to-a-community-which-is-not-on-my-server","title":"How do I subscribe to a community which is not on my server?","text":"<p>Lets say, you see the FOSS community, and would like to join it.</p> <p></p> <p>Click the copy icon. This will copy <code>https://beehaw.org/c/foss</code> to your clipboard.</p> <p>Open a search. </p> <p></p> <p>In the search, paste the URL.</p> <p></p> <p>When the community pops up, click on it.</p> <p></p> <p>You are now viewing a federated community. </p> <p>You can subscribe to it. You can post on it. You can comment on it.</p>"},{"location":"blog/2023/join-the-fediverse/#its-not-working","title":"Its not working!","text":"<p>If the above steps aren't working for you-</p> <ol> <li>Make sure you are logged in</li> <li>Here are some more in-depth details on how to subscribe to remote communities StackExchange</li> </ol>"},{"location":"blog/2023/what-happened-to-reddit/","title":"What happened to reddit?","text":"<p>Why is everyone angry at reddit??</p> <p>What went wrong?</p> <p>A very short post, with a few links.</p>"},{"location":"blog/2023/what-happened-to-reddit/#why-is-everyone-leaving-reddit-all-of-a-sudden","title":"Why is everyone leaving reddit all of a sudden?","text":"<p>Hint, this isn't due to the Apollo app. </p> <p>It never was. Apollo just happens to be one of the bigger applications affected- and the most vocal.</p>"},{"location":"blog/2023/what-happened-to-reddit/#1-reddit-announced-api-changes-which-would-breakend-most-all-3rd-party-applications","title":"1. Reddit announced API changes, which would break/end most all 3rd party applications.","text":"<p>In addition, NSFW content, will no longer be available for 3rd-party applications.</p>"},{"location":"blog/2023/what-happened-to-reddit/#2-reddit-did-an-ama-to-address-the-changes","title":"2. Reddit did an AMA to address the changes.","text":"<p>AMA Link</p> <p>However, during this AMA, basically none of the questions were answered. </p> <p>And, during this process, spez was even caught copy and pasting from an answers sheet. Archive Link</p> <p>He, of course, edited his reply. Hence the archive link.</p>"},{"location":"blog/2023/what-happened-to-reddit/#3-reddit-goes-offline-to-protest-changes","title":"3. Reddit goes offline to protest changes.","text":"<p>Over 75% of reddit subs went private in order to protest the changes.</p> <ul> <li>Futurism.com</li> <li>BBC.com</li> </ul>"},{"location":"blog/2023/what-happened-to-reddit/#4-spez-refers-to-the-moderators-as-noise-and-says-this-protest-will-pass","title":"4. Spez, refers to the moderators as noise, and says this protest will pass.","text":"<ul> <li>YouTube Link - Louis Rossmann</li> <li>Mac Rumors</li> </ul>"},{"location":"blog/2023/what-happened-to-reddit/#5-spez-replaces-moderators-who-were-apart-of-the-protest","title":"5. Spez replaces moderators who were apart of the protest.","text":"<p>This of course, happened after reddit claimed it wouldn't be forcibly re-opening any of the subs.</p> <ul> <li>nbcnews.com</li> <li>Forbes</li> </ul> <p>Will try and dig up some of the archive links from reddit posts which were deleted...</p> <ul> <li>https://lemmyonline.com/post/2180</li> <li>Removed as moderator of /r/Celebrities after 14 years</li> </ul>"},{"location":"blog/2023/what-happened-to-reddit/#users-are-reporting-their-deleted-posts-are-becoming-undeleted","title":"Users are reporting their deleted posts, are becoming undeleted.","text":""},{"location":"blog/2023/what-happened-to-reddit/#many-moderators-after-being-threatened-re-opened-their-subs-with-a-twist","title":"Many moderators after being threatened, re-opened their subs, with a twist.","text":""},{"location":"blog/2023/what-happened-to-reddit/#john-oliver","title":"John Oliver","text":"<p>That twist is- you can only post pictures of John Oliver. </p> <p></p> <p></p> <p>Of course, this was voted on by the community, and not just forced by the mods.</p> <p></p> <p>Link to poll</p> <p>Link to explanation</p> <p></p> <p>Link to poll</p> <p>Link to explanation</p> <p>Many other subs are also participating in this movement. A fine example of r/maliciouscompliance... (Or- better yet- c/maliciouscompliance)</p> <p>News post - The Verge</p>"},{"location":"blog/2023/what-happened-to-reddit/#rsteam-from-steam-video-game-hosting-to-literal-steam","title":"r/steam - From steam (video game hosting) to Literal steam.","text":"<p>Play games on steam? Well, since r/steam was forced to re-open, they decided to only post pictures of literal steam!</p> <p></p>"},{"location":"blog/2023/what-happened-to-reddit/#rhorny-from-nsfw-sub-to-nsfw-christian-minecraft-server-sub","title":"r/horny - From NSFW sub, to NSFW Christian Minecraft Server sub","text":"<p>Despite how r/horny may appear- Its all pictures of a christian minecraft server now.</p> <p></p> <p></p> <p>The sidebar is also worth a glance.</p> <p></p> <ul> <li>Related News Post</li> </ul>"},{"location":"blog/2023/what-happened-to-reddit/#better-news","title":"Better News","text":"<p>The verge has created a consolidated news thread of all of the events occurring. </p> <p>I would highly recommending giving it a read. </p> <p>It is far more up to date as opposed to my post here, as they are actually paid to keep it current, and accurate. (I don't get compensated for this. I don't take your donations either.)</p> <ul> <li>https://www.theverge.com/2023/6/8/23754780/reddit-api-updates-changes-news-announcements</li> </ul>"},{"location":"blog/2023/what-happened-to-reddit/#where-have-my-favorite-subs-went-to","title":"Where have my favorite subs went to?","text":"<ul> <li>https://sub.rehab/</li> </ul>"},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/","title":"Proxmox - Add Disk to Existing Thin-Provisioned LVM Pool","text":"<p>A very short guide on adding a new disk to an existing LVM pool.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#how-to-do-it","title":"How to do it.","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#step-1-identify-the-new-disk","title":"Step 1. Identify the new disk.","text":"<p>First, identify the disk. </p> <p>You can acquire this information via the GUI, or the CLI.</p> <p>If you prefer the CLI, you can either use <code>lsblk</code>, <code>lvmdiskscan</code>, or <code>fdisk -l</code> to view disks on your system. </p> <p></p> <p>Again, in this case, <code>nvme0n1</code> is the empty disk I want to use.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#step-2-format-the-disk","title":"Step 2. Format the disk.","text":"<p>Danger<p>If you format the incorrect disk, you may lose data! </p> <p>Don't format the wrong disk.</p> </p> <p>For this step, we will need to use the CLI.</p> <p>From a console/terminal, type the command <code>cfdisk /dev/nvme0n1</code> (Replace with the name of the disk you are wanting to add.)</p> <p>For label type, choose GPT.</p> <p></p> <p>On the next screen, New will be selected by default. Press Enter.</p> <p></p> <p>After you press enter, you will notice a prompt at the bottom. It should automatically fill with the usable size of the disk. Press enter again.</p> <p></p> <p>Afterwards, your screen should resemble the below picture. Press right, and select \"Write\". Press enter again.</p> <p></p> <p>After you click write, you will to confirm your changes. Note- this will delete anything on the disk. Type <code>yes</code> followed by enter to confirm.</p> <p></p> <p>After your changes have been written, you may exist CFDisk.</p> <p></p> <p>Now- you can see your new partition using <code>lsblk</code> or <code>fdisk -l</code></p> <p></p> <p>Take note of the new partition name, it will be needed in the next step. In this case, <code>nvme0n1p1</code> is the new partition.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#step-3-create-a-physical-volume-pg","title":"Step 3. Create a physical volume / PG","text":"<p>Just type <code>pvcreate /dev/nvme0n1p1</code> (The name of the partition created in the previous step.)</p> <pre><code>root@kube05:~# pvcreate /dev/nvme0n1p1\n  Physical volume \"/dev/nvme0n1p1\" successfully created.\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#step-4-extend-the-existing-volume-group-vg","title":"Step 4. Extend the existing volume group / VG","text":"<p>You will need the name of your existing VG / Volume Group. If you do not know it, just type <code>vgscan</code></p> <pre><code>root@kube05:~# vgscan\n  Found volume group \"pve\" using metadata type lvm2\n  Found volume group \"Flash\" using metadata type lvm2\n</code></pre> <p>In my case, <code>Flash</code> is the VG / LVM I wish to extend.</p> <p>To extend the existing VG, we will use <code>vgextend VG_Name New_Device</code></p> <pre><code>root@kube05:~# vgextend Flash /dev/nvme0n1p1\n  Volume group \"Flash\" successfully extended\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#step-5-extend-the-logical-volume-lv","title":"Step 5. Extend the Logical Volume / LV","text":"<p>First, you will need to find the device path for your existing LV. If you do not know it, just type <code>lvscan</code></p> <pre><code>root@kube05:~# lvscan\n  ACTIVE            '/dev/pve/data' [&lt;53.93 GiB] inherit\n  ACTIVE            '/dev/pve/swap' [8.00 GiB] inherit\n  ACTIVE            '/dev/pve/root' [&lt;39.56 GiB] inherit\n  ACTIVE            '/dev/Flash/Flash' [&lt;1.79 TiB] inherit\n  ACTIVE            '/dev/Flash/vm-106-disk-0' [8.00 GiB] inherit\n  ACTIVE            '/dev/Flash/vm-104-disk-0' [8.00 GiB] inherit\n  ACTIVE            '/dev/Flash/vm-109-disk-0' [4.00 GiB] inherit\n  ACTIVE            '/dev/Flash/vm-105-disk-0' [16.00 GiB] inherit\n  ACTIVE            '/dev/Flash/vm-101-disk-0' [2.00 GiB] inherit\n</code></pre> <p>In my case, <code>/dev/Flash/Flash</code> is the device path for the LV. Ignore the disks mounted to it.</p> <p>To extend the LV, we will use the <code>lvextend</code> command.</p> <p>In my example, I will be adding <code>+100%FREE</code> to add all of the remaining free space to my LV.</p> <p>Just- replace <code>/dev/Flash/Flash</code> with your correct LV device path.</p> <pre><code>root@kube05:~# lvextend /dev/Flash/Flash -l +100%FREE\n  Size of logical volume Flash/Flash_tdata changed from &lt;1.79 TiB (468708 extents) to 2.25 TiB (590898 extents).\n  Logical volume Flash/Flash successfully resized.\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---add-disk-to-existing-thin-provisioned-lvm/#done","title":"Done!","text":"<p>At this point, you are done. The space has been added to your LVM pool.</p> <p>LVM Display, showing both disks completely assigned to the LV.</p> <p></p> <p>LVM-Thin Display, showing newly added space:</p> <p></p> <p>Enjoy.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/","title":"Building a ceph cluster","text":"<p>My adventures in building out a small clustered ceph environment for redundant VM / Container storage. </p> <p>Quote</p> <p>Ceph is a great way to extract 10,000 IOPs from over 5 million IOPs worth of SSDs! -XtremeOwnage</p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#why-should-you-use-ceph","title":"Why should you use ceph?","text":"<p>In most cases, you shouldn't.</p> <p>If you have a centralized storage server, or SAN, ceph is likely not the tool for you. </p> <p>As well, if you only have one or two nodes in a cluster, ceph is likely not the tool for you.</p> <p>Ceph is useful, for when you want to decentralize your storage, without having a central storage server, or SAN.</p> <p>You also should only use ceph, when you have AT LEAST three nodes. </p> <p>My reasons for wanting to use ceph:</p> <ol> <li>Reduce my dependency on any single piece of hardware. I want to be able to performance maintenance on any server in my rack, with the least amount of service disruption. </li> <li>I want to be able to instantly \"vMotion\" VMs in my proxmox cluster, without having to wait for ZFS replication.</li> <li>While I have previously leveraged ceph for my kubernetes cluster, I wanted to learn more about using it. For me, the best way to learn something, is to jump into it head first.</li> <li>Distributed, and remote storage. Any new node I add to my proxmox cluster, automatically has access to anything stored in ceph, regardless if the node hosts ceph storage or not. The proxmox/ceph integration works very nicely.</li> </ol>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#cluster-details","title":"Cluster Details","text":"<p>For my proxmox cluster, I have a total of four machines.</p> <ol> <li>Kube01 - Optiplex 7060 SFF<ul> <li>32G DDR4</li> <li>i7-8700 6c/12t</li> <li>ConnectX-3 10G SFP+</li> </ul> </li> <li>Kube02 - Dell r730XD 2U<ul> <li>256G DDR4</li> <li>2x E5-2697a v4 - 32c/64t total.</li> <li>10G RJ45</li> </ul> </li> <li>Kube05 - HP z240 SFF<ul> <li>28G DDR4</li> <li>i5-6500 4c/4t</li> <li>ConnectX-3 10G SFP+</li> </ul> </li> <li>Kube06 - Dell Optiplex 7050m Micro<ul> <li>16G DDR4</li> <li>i7-6700T 4c/8t</li> <li>Intel Gigabit (Motherboard)</li> <li>USB Gigabit NIC</li> </ul> </li> </ol> <p>Note, all nodes except Kube06 have access to a dedicated network for ceph, which is running 9,000 MTU jumbo frames.</p> <p>Only Kube01/02/05 will be running ceph storage. Kube06 will only consume it, if needed. (Its workloads are fine with local storage.)</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#my-first-attempt-failure","title":"My first attempt - Failure","text":"<p>My first attempt was not very well documented. However, it consisted of...</p> <ul> <li>2x 1T 970 evo</li> <li>2x 1T 970 evo plus</li> <li>1x 1T 980 evo</li> </ul> <p>The NVMes were scattered between kube01/02/05. </p> <p>The results were so horrible, it would cause my VMs to completely lockup due to excessive IO wait.</p> <p>After doing a lot of research, I discovered... ceph really does not like running on consumer SSDs/NVMes. </p> <p>This is due to... lower queue depths, lack of power loss protection (PLP), and a few other factors.</p> <p>Long story short- don't toss ceph on a bunch of 970 evos and expect it to work well. Just trust me... don't run ceph on consumer SSDs.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#ceph-benchmarks","title":"Ceph Benchmarks","text":"<p>Here are a few benchmarks I found across the internet. The results, also concluded that enterprise SSDs are a much better choice.</p> <ul> <li>Google Sheet with Ceph Benchmarks for many drives</li> <li>ceph-diskbench</li> </ul>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#attempt-2-using-enterprise-ssds","title":"Attempt #2, Using Enterprise SSDs","text":"<p>After doing a lot of research, reading benchmarks, etc.... I decided to give ceph another try. But, this time, I planned on using the \"proper\" SSDs.</p> <p>In the end, I decided on running 5x Samsung PM963 1T NVMes, along with 5x Samsung PM863 SATA SSDs. </p> <p>While, I would love to build an all-NVMe cluster, the optiplex machines have pretty limited expandability to work with. </p> <p>If, you are interested in the exact SSDs I purchased, here are the links:</p> <ul> <li>Samsung PM963 1T NVMe</li> <li>Samsung PM863 1T SATA SSd</li> </ul> <p>All 10 of the SSDs ordered, arrived with &lt; 5% advertised wear.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#testing-method","title":"Testing Method","text":"<p>Testing will be performed using a LXC container running on top of proxmox, with ceph-block storage mounted.</p> <pre><code>seq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\n</code></pre> <p>For mounting the storage, no special options were used.</p> <p></p> <p>Info</p> <p>Note, this is not a good method for benchmarking ceph.</p> <p>However, I did not know this at the time of doing this, and I really don't want to break and reconfigure my cluster to run tests on other configurations...</p> <p><code>rados bench</code> should instead be used.</p> <p>Warning</p> <p>This is NOT a clean room test! I did have active workloads on my cluster through all of this testing. </p> <p>As such, this tests could have been impacted by other cluster activity occurring.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#testing-volume-in-lxc-using-fio","title":"Testing Volume in LXC using fio","text":"","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-1-4x-sata-ssd-980-evo-ran-on-remote-node","title":"Test 1. 4x SATA SSD + 980 evo, Ran on remote node.","text":"<p>While I was waiting for the NVMes to arrive, I went ahead and ran this configuration:</p> <ol> <li>Kube01 <ul> <li>1x Samsung 980 evo</li> <li>1x Samsung PM863 SATA SSD</li> </ul> </li> <li>Kube05 <ul> <li>3x PM863 SATA SSDs</li> </ul> </li> </ol> <p>This test was ran from Kube02.</p> <p>This configuration was chosen, because Kube02 does not have room for any more 2.5\" HDDs, and Kube01 only has power connectors for a single SATA drive, currently.</p> Workload Read/Write Block Size Queue Depth Bandwidth (KiB/s) IOPS seq_rd Read 128 KiB 256 190 MiB/s 1519 seq_wr Write 128 KiB 256 86.0 MiB/s 688 rand_rd Read 4 KiB 256 6215 KiB/s 1553 rand_wr Write 4 KiB 256 7382 KiB/s 1845 <p>One very interesting thing I noticed during the results, the latency for the 980 evo was literally through the roof.</p> <p></p> <p>Going back to the very first attempt with all 970/980 evos, Just imagine all 5 drives exhibiting this severe latency. </p> Raw Results <pre><code>root@benchmark:~# fio bench\nseq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\nStarting 4 processes\nseq_wr: Laying out IO file (1 file / 8192MiB)\nJobs: 1 (f=1): [_(3),w(1)][57.2%][w=5258KiB/s][w=1314 IOPS][eta 03m:00s]\nseq_wr: (groupid=0, jobs=1): err= 0: pid=413: Tue Aug  8 14:19:43 2023\nwrite: IOPS=688, BW=86.0MiB/s (90.2MB/s)(5182MiB/60250msec); 0 zone resets\n    slat (usec): min=143, max=1347.1k, avg=1448.11, stdev=22612.62\n    clat (usec): min=30, max=1646.7k, avg=370440.14, stdev=384759.72\n    lat (msec): min=48, max=1646, avg=371.89, stdev=385.23\n    clat percentiles (msec):\n    |  1.00th=[   82],  5.00th=[   96], 10.00th=[  100], 20.00th=[  109],\n    | 30.00th=[  120], 40.00th=[  134], 50.00th=[  157], 60.00th=[  188],\n    | 70.00th=[  321], 80.00th=[  776], 90.00th=[  995], 95.00th=[ 1150],\n    | 99.00th=[ 1519], 99.50th=[ 1603], 99.90th=[ 1653], 99.95th=[ 1653],\n    | 99.99th=[ 1653]\nbw (  KiB/s): min=  768, max=257534, per=98.97%, avg=87169.29, stdev=67124.92, samples=59\niops        : min=    1, max= 2536, avg=757.70, stdev=620.52, samples=105\nlat (usec)   : 50=0.01%\nlat (msec)   : 50=0.13%, 100=10.78%, 250=55.94%, 500=4.76%, 750=7.16%\nlat (msec)   : 1000=11.35%, 2000=9.88%\ncpu          : usr=1.23%, sys=25.46%, ctx=4647, majf=0, minf=8264\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.8%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,41457,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nseq_rd: (groupid=1, jobs=1): err= 0: pid=414: Tue Aug  8 14:19:43 2023\nread: IOPS=1519, BW=190MiB/s (199MB/s)(11.1GiB/60001msec)\n    slat (usec): min=56, max=34096, avg=645.29, stdev=953.17\n    clat (usec): min=55, max=429907, avg=166363.09, stdev=54024.19\n    lat (msec): min=2, max=429, avg=167.01, stdev=54.21\n    clat percentiles (msec):\n    |  1.00th=[   83],  5.00th=[   84], 10.00th=[   85], 20.00th=[   86],\n    | 30.00th=[  163], 40.00th=[  176], 50.00th=[  184], 60.00th=[  190],\n    | 70.00th=[  197], 80.00th=[  203], 90.00th=[  215], 95.00th=[  234],\n    | 99.00th=[  284], 99.50th=[  313], 99.90th=[  372], 99.95th=[  384],\n    | 99.99th=[  426]\nbw (  KiB/s): min=95628, max=388352, per=100.00%, avg=194954.75, stdev=75586.78, samples=59\niops        : min=  219, max= 3042, avg=1520.28, stdev=592.97, samples=117\nlat (usec)   : 100=0.01%\nlat (msec)   : 4=0.01%, 10=0.01%, 20=0.01%, 50=0.04%, 100=25.92%\nlat (msec)   : 250=70.78%, 500=3.24%\ncpu          : usr=0.89%, sys=53.93%, ctx=68655, majf=0, minf=32913\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=91167,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_rd: (groupid=2, jobs=1): err= 0: pid=415: Tue Aug  8 14:19:43 2023\nread: IOPS=1553, BW=6215KiB/s (6365kB/s)(364MiB/60001msec)\n    slat (usec): min=7, max=140992, avg=633.19, stdev=1094.23\n    clat (usec): min=27, max=1084.6k, avg=163558.83, stdev=48615.67\n    lat (usec): min=1015, max=1085.3k, avg=164192.02, stdev=48758.65\n    clat percentiles (msec):\n    |  1.00th=[  105],  5.00th=[  126], 10.00th=[  136], 20.00th=[  144],\n    | 30.00th=[  150], 40.00th=[  155], 50.00th=[  161], 60.00th=[  165],\n    | 70.00th=[  171], 80.00th=[  178], 90.00th=[  188], 95.00th=[  203],\n    | 99.00th=[  253], 99.50th=[  309], 99.90th=[  927], 99.95th=[  986],\n    | 99.99th=[ 1083]\nbw (  KiB/s): min= 1048, max= 8404, per=99.70%, avg=6197.93, stdev=901.87, samples=59\niops        : min=  228, max= 2502, avg=1551.79, stdev=251.36, samples=119\nlat (usec)   : 50=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.02%, 50=0.05%\nlat (msec)   : 100=0.56%, 250=98.19%, 500=0.80%, 750=0.11%, 1000=0.20%\nlat (msec)   : 2000=0.05%\ncpu          : usr=1.91%, sys=5.80%, ctx=68497, majf=0, minf=1568\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=93233,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_wr: (groupid=3, jobs=1): err= 0: pid=416: Tue Aug  8 14:19:43 2023\nwrite: IOPS=1845, BW=7382KiB/s (7559kB/s)(433MiB/60009msec); 0 zone resets\n    slat (usec): min=7, max=62524, avg=536.37, stdev=3408.27\n    clat (usec): min=57, max=287346, avg=137716.21, stdev=65681.88\n    lat (msec): min=3, max=287, avg=138.25, stdev=65.86\n    clat percentiles (msec):\n    |  1.00th=[    4],  5.00th=[    4], 10.00th=[    5], 20.00th=[  112],\n    | 30.00th=[  129], 40.00th=[  140], 50.00th=[  161], 60.00th=[  161],\n    | 70.00th=[  188], 80.00th=[  192], 90.00th=[  197], 95.00th=[  215],\n    | 99.00th=[  232], 99.50th=[  249], 99.90th=[  259], 99.95th=[  259],\n    | 99.99th=[  279]\nbw (  KiB/s): min= 4352, max=73508, per=99.81%, avg=7368.55, stdev=8806.33, samples=60\niops        : min= 1024, max=31994, avg=1847.78, stdev=2827.66, samples=119\nlat (usec)   : 100=0.01%\nlat (msec)   : 4=9.63%, 10=4.49%, 20=0.11%, 50=0.93%, 100=4.56%\nlat (msec)   : 250=79.82%, 500=0.46%\ncpu          : usr=0.62%, sys=3.75%, ctx=3078, majf=0, minf=1419\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,110746,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256    \n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-2-980-evo-removed","title":"Test 2. 980 evo removed.","text":"<p>The only change for the 2nd test, is to remove the Samsung 980 evo.</p> <p>This was as simple as just removing the OSD, and giving the cluster a few minutes to rebuild itself.</p> <p></p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#results-comparison","title":"Results / Comparison","text":"<p>With the Samsung 980 evo removed, we get these results:</p> Workload IOPs Bandwidth (MiB/s) Avg Latency (ms) 99th Percentile Latency (ms) seq_wr 1428 179 179 334 seq_rd 1326 166 191 334 rand_rd 1136 4.44 224 300 rand_wr 4320 16.9 59.09 163 <p>Overall, write performance doubled in both IOPs, and bandwidth by removing the 980 evo. Read performance was slightly reduced.</p> <p>IOPs:</p> Workload IOPs Attempt #1 IOPs Attempt #2 Percent Difference seq_wr 688 1428 107.56% seq_rd 1519 1326 -12.74% rand_rd 1553 1136 -26.85% rand_wr 1845 4320 134.06% <p>Bandwidth:</p> Workload Bandwidth Attempt #1 (MiB/s) Bandwidth Attempt #2 (MiB/s) Percent Difference seq_wr 86.0 179 108.14% seq_rd 190 166 -12.63% rand_rd 6.07 4.44 -26.87% rand_wr 7.21 16.9 134.08% Raw Results - Test 2 <pre><code>root@benchmark:~# fio bench\nseq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\nStarting 4 processes\nseq_wr: Laying out IO file (1 file / 8192MiB)\nJobs: 1 (f=1): [_(3),w(1)][57.9%][w=16.0MiB/s][w=4084 IOPS][eta 02m:46s]\nseq_wr: (groupid=0, jobs=1): err= 0: pid=442: Tue Aug  8 15:51:56 2023\nwrite: IOPS=1428, BW=179MiB/s (187MB/s)(8192MiB/45881msec); 0 zone resets\n    slat (usec): min=150, max=203823, avg=694.06, stdev=3536.12\n    clat (usec): min=48, max=332391, avg=178428.15, stdev=65918.98\n    lat (usec): min=590, max=332660, avg=179122.21, stdev=65938.91\n    clat percentiles (msec):\n    |  1.00th=[   96],  5.00th=[  100], 10.00th=[  103], 20.00th=[  110],\n    | 30.00th=[  120], 40.00th=[  138], 50.00th=[  171], 60.00th=[  203],\n    | 70.00th=[  226], 80.00th=[  249], 90.00th=[  271], 95.00th=[  284],\n    | 99.00th=[  309], 99.50th=[  317], 99.90th=[  326], 99.95th=[  330],\n    | 99.99th=[  334]\nbw (  KiB/s): min=107520, max=236524, per=99.72%, avg=182318.29, stdev=23419.90, samples=45\niops        : min=  707, max= 2102, avg=1423.04, stdev=256.51, samples=91\nlat (usec)   : 50=0.01%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.02%, 20=0.04%, 50=0.10%\nlat (msec)   : 100=5.43%, 250=74.79%, 500=19.60%\ncpu          : usr=2.78%, sys=57.57%, ctx=7069, majf=0, minf=16479\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nseq_rd: (groupid=1, jobs=1): err= 0: pid=443: Tue Aug  8 15:51:56 2023\nread: IOPS=1326, BW=166MiB/s (174MB/s)(9946MiB/60002msec)\n    slat (usec): min=58, max=45807, avg=741.79, stdev=854.61\n    clat (usec): min=27, max=336382, avg=191241.41, stdev=21380.44\n    lat (usec): min=1610, max=336498, avg=191983.21, stdev=21415.07\n    clat percentiles (msec):\n    |  1.00th=[  155],  5.00th=[  163], 10.00th=[  169], 20.00th=[  178],\n    | 30.00th=[  182], 40.00th=[  186], 50.00th=[  190], 60.00th=[  194],\n    | 70.00th=[  199], 80.00th=[  205], 90.00th=[  211], 95.00th=[  220],\n    | 99.00th=[  255], 99.50th=[  326], 99.90th=[  330], 99.95th=[  334],\n    | 99.99th=[  334]\nbw (  KiB/s): min=96888, max=195139, per=99.60%, avg=169073.58, stdev=14409.01, samples=59\niops        : min=  240, max= 1675, avg=1324.62, stdev=142.06, samples=115\nlat (usec)   : 50=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.02%, 50=0.06%\nlat (msec)   : 100=0.10%, 250=98.70%, 500=1.09%\ncpu          : usr=0.88%, sys=49.28%, ctx=78969, majf=0, minf=49383\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=79571,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_rd: (groupid=2, jobs=1): err= 0: pid=444: Tue Aug  8 15:51:56 2023\nread: IOPS=1136, BW=4546KiB/s (4655kB/s)(266MiB/60001msec)\n    slat (usec): min=250, max=22570, avg=865.61, stdev=361.25\n    clat (usec): min=57, max=301459, avg=223429.76, stdev=29460.90\n    lat (usec): min=1044, max=302476, avg=224295.36, stdev=29540.92\n    clat percentiles (msec):\n    |  1.00th=[  153],  5.00th=[  169], 10.00th=[  182], 20.00th=[  199],\n    | 30.00th=[  211], 40.00th=[  220], 50.00th=[  228], 60.00th=[  234],\n    | 70.00th=[  243], 80.00th=[  249], 90.00th=[  257], 95.00th=[  264],\n    | 99.00th=[  275], 99.50th=[  288], 99.90th=[  300], 99.95th=[  300],\n    | 99.99th=[  300]\nbw (  KiB/s): min= 2771, max= 5756, per=99.77%, avg=4536.03, stdev=463.77, samples=59\niops        : min=  224, max= 1522, avg=1134.81, stdev=150.78, samples=119\nlat (usec)   : 100=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.04%\nlat (msec)   : 100=0.07%, 250=82.20%, 500=17.67%\ncpu          : usr=1.79%, sys=6.22%, ctx=70817, majf=0, minf=997\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=68195,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_wr: (groupid=3, jobs=1): err= 0: pid=445: Tue Aug  8 15:51:56 2023\nwrite: IOPS=4320, BW=16.9MiB/s (17.7MB/s)(1013MiB/60015msec); 0 zone resets\n    slat (usec): min=6, max=158293, avg=227.51, stdev=1960.14\n    clat (usec): min=56, max=161774, avg=58859.96, stdev=18208.69\n    lat (msec): min=2, max=161, avg=59.09, stdev=18.24\n    clat percentiles (msec):\n    |  1.00th=[    4],  5.00th=[    4], 10.00th=[   46], 20.00th=[   53],\n    | 30.00th=[   61], 40.00th=[   64], 50.00th=[   64], 60.00th=[   65],\n    | 70.00th=[   65], 80.00th=[   68], 90.00th=[   72], 95.00th=[   80],\n    | 99.00th=[   90], 99.50th=[   96], 99.90th=[  130], 99.95th=[  163],\n    | 99.99th=[  163]\nbw (  KiB/s): min=13709, max=89304, per=100.00%, avg=17287.20, stdev=9582.43, samples=59\niops        : min= 3072, max=35180, avg=4322.13, stdev=2909.08, samples=119\nlat (usec)   : 100=0.01%\nlat (msec)   : 4=6.13%, 10=1.19%, 50=8.38%, 100=84.00%, 250=0.31%\ncpu          : usr=1.33%, sys=7.74%, ctx=5010, majf=0, minf=733\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,259308,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\n\nRun status group 0 (all jobs):\nWRITE: bw=179MiB/s (187MB/s), 179MiB/s-179MiB/s (187MB/s-187MB/s), io=8192MiB (8590MB), run=45881-45881msec\n\nRun status group 1 (all jobs):\nREAD: bw=166MiB/s (174MB/s), 166MiB/s-166MiB/s (174MB/s-174MB/s), io=9946MiB (10.4GB), run=60002-60002msec\n\nRun status group 2 (all jobs):\nREAD: bw=4546KiB/s (4655kB/s), 4546KiB/s-4546KiB/s (4655kB/s-4655kB/s), io=266MiB (279MB), run=60001-60001msec\n\nRun status group 3 (all jobs):\nWRITE: bw=16.9MiB/s (17.7MB/s), 16.9MiB/s-16.9MiB/s (17.7MB/s-17.7MB/s), io=1013MiB (1062MB), run=60015-60015msec\n\nDisk stats (read/write):\nrbd8: ios=107982/239016, merge=0/3623, ticks=141999/3002863, in_queue=3144862, util=90.38%\n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-3-better-data-locality","title":"Test 3. Better data locality","text":"<p>Previous tests were ran on <code>kube02</code> which has no storage attached to it. As a result, all ceph traffic had to visit either <code>kube01</code> or <code>kube05</code>.</p> <p>For this test, the benchmarks will be ran from <code>kube05</code>, which hosts 3 of the 4 currently active OSDs.</p> Workload IOPs Bandwidth (MiB/s) Avg Latency (ms) 99th Percentile Latency (ms) seq_wr 2280 285 112.23 236 seq_rd 2271 284 112.16 171 rand_rd 1822 7.29 140.23 230 rand_wr 4015 15.7 63.74 107","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#results-comparison_1","title":"Results / Comparison","text":"<p>For this test, it appears read performance went 60%, although, random write performance was slightly reduced. </p> <p>IOPs:</p> Workload IOPs Attempt #2 IOPs Attempt #3 Percent Difference seq_wr 1428 2280 59.68% seq_rd 1326 2271 71.62% rand_rd 1136 1822 60.50% rand_wr 4320 4015 -7.07% <p>Bandwidth:</p> Workload Bandwidth Attempt #2 (MiB/s) Bandwidth Attempt #3 (MiB/s) Percent Difference seq_wr 179 285 59.22% seq_rd 166 284 71.08% rand_rd 4.44 7.29 64.11% rand_wr 16.9 15.7 -7.10% Raw Results - Test 3 <pre><code>root@benchmark:~# fio bench\nseq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\nStarting 4 processes\nseq_wr: Laying out IO file (1 file / 8192MiB)\nJobs: 1 (f=1): [_(3),w(1)][58.7%][w=13.5MiB/s][w=3456 IOPS][eta 02m:28s]\nseq_wr: (groupid=0, jobs=1): err= 0: pid=335: Tue Aug  8 16:01:12 2023\nwrite: IOPS=2280, BW=285MiB/s (299MB/s)(8192MiB/28740msec); 0 zone resets\n    slat (usec): min=52, max=137961, avg=435.80, stdev=3313.71\n    clat (usec): min=3, max=250114, avg=111794.30, stdev=62558.67\n    lat (usec): min=71, max=250359, avg=112230.09, stdev=62565.95\n    clat percentiles (msec):\n    |  1.00th=[   18],  5.00th=[   20], 10.00th=[   32], 20.00th=[   49],\n    | 30.00th=[   63], 40.00th=[   88], 50.00th=[  110], 60.00th=[  133],\n    | 70.00th=[  155], 80.00th=[  176], 90.00th=[  199], 95.00th=[  215],\n    | 99.00th=[  236], 99.50th=[  247], 99.90th=[  249], 99.95th=[  249],\n    | 99.99th=[  251]\nbw (  KiB/s): min=247287, max=364672, per=99.99%, avg=291855.79, stdev=29980.58, samples=28\niops        : min= 1755, max= 2976, avg=2273.82, stdev=342.63, samples=57\nlat (usec)   : 4=0.01%, 100=0.01%, 250=0.01%, 500=0.01%, 750=0.01%\nlat (usec)   : 1000=0.01%\nlat (msec)   : 2=0.02%, 4=0.04%, 10=0.12%, 20=6.67%, 50=14.90%\nlat (msec)   : 100=23.93%, 250=54.30%, 500=0.01%\ncpu          : usr=1.60%, sys=24.76%, ctx=3132, majf=1, minf=11\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nseq_rd: (groupid=1, jobs=1): err= 0: pid=336: Tue Aug  8 16:01:12 2023\nread: IOPS=2271, BW=284MiB/s (298MB/s)(16.6GiB/60001msec)\n    slat (usec): min=13, max=26543, avg=435.03, stdev=561.63\n    clat (usec): min=7, max=313590, avg=111721.25, stdev=16674.15\n    lat (usec): min=601, max=313636, avg=112156.28, stdev=16711.79\n    clat percentiles (msec):\n    |  1.00th=[   95],  5.00th=[   97], 10.00th=[  100], 20.00th=[  102],\n    | 30.00th=[  104], 40.00th=[  106], 50.00th=[  108], 60.00th=[  111],\n    | 70.00th=[  114], 80.00th=[  121], 90.00th=[  128], 95.00th=[  138],\n    | 99.00th=[  171], 99.50th=[  186], 99.90th=[  305], 99.95th=[  309],\n    | 99.99th=[  313]\nbw (  KiB/s): min=117234, max=318464, per=100.00%, avg=291104.83, stdev=27494.18, samples=59\niops        : min=  420, max= 2516, avg=2271.34, stdev=242.94, samples=119\nlat (usec)   : 10=0.01%, 750=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.02%, 50=0.06%\nlat (msec)   : 100=14.49%, 250=85.25%, 500=0.17%\ncpu          : usr=0.97%, sys=14.32%, ctx=79247, majf=0, minf=8204\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=136311,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_rd: (groupid=2, jobs=1): err= 0: pid=337: Tue Aug  8 16:01:12 2023\nread: IOPS=1822, BW=7291KiB/s (7466kB/s)(427MiB/60001msec)\n    slat (usec): min=109, max=37717, avg=542.78, stdev=446.78\n    clat (usec): min=4, max=315550, avg=139682.85, stdev=36356.47\n    lat (usec): min=372, max=315922, avg=140225.62, stdev=36463.40\n    clat percentiles (msec):\n    |  1.00th=[   90],  5.00th=[   96], 10.00th=[  101], 20.00th=[  107],\n    | 30.00th=[  114], 40.00th=[  124], 50.00th=[  133], 60.00th=[  144],\n    | 70.00th=[  157], 80.00th=[  171], 90.00th=[  190], 95.00th=[  205],\n    | 99.00th=[  230], 99.50th=[  284], 99.90th=[  313], 99.95th=[  313],\n    | 99.99th=[  317]\nbw (  KiB/s): min= 4303, max=10594, per=99.51%, avg=7255.12, stdev=1333.29, samples=59\niops        : min=  830, max= 2729, avg=1816.28, stdev=373.48, samples=119\nlat (usec)   : 10=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.02%, 20=0.03%, 50=0.07%\nlat (msec)   : 100=9.94%, 250=89.25%, 500=0.67%\ncpu          : usr=1.28%, sys=4.39%, ctx=109724, majf=0, minf=266\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=109367,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_wr: (groupid=3, jobs=1): err= 0: pid=338: Tue Aug  8 16:01:12 2023\nwrite: IOPS=4015, BW=15.7MiB/s (16.4MB/s)(941MiB/60001msec); 0 zone resets\n    slat (usec): min=2, max=207481, avg=247.62, stdev=2138.55\n    clat (usec): min=9, max=383435, avg=63492.95, stdev=23711.14\n    lat (usec): min=935, max=383439, avg=63740.58, stdev=23723.75\n    clat percentiles (usec):\n    |  1.00th=[   996],  5.00th=[  1156], 10.00th=[ 48497], 20.00th=[ 60031],\n    | 30.00th=[ 64226], 40.00th=[ 64226], 50.00th=[ 64226], 60.00th=[ 64226],\n    | 70.00th=[ 67634], 80.00th=[ 71828], 90.00th=[ 87557], 95.00th=[ 95945],\n    | 99.00th=[107480], 99.50th=[111674], 99.90th=[312476], 99.95th=[312476],\n    | 99.99th=[383779]\nbw (  KiB/s): min=11136, max=92856, per=100.00%, avg=16072.39, stdev=10302.29, samples=59\niops        : min= 2180, max=43593, avg=4015.29, stdev=3688.06, samples=119\nlat (usec)   : 10=0.01%, 1000=1.04%\nlat (msec)   : 2=6.86%, 4=0.11%, 20=0.56%, 50=1.60%, 100=87.50%\nlat (msec)   : 250=2.23%, 500=0.11%\ncpu          : usr=0.32%, sys=2.25%, ctx=4108, majf=0, minf=11\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,240951,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\n\nRun status group 0 (all jobs):\nWRITE: bw=285MiB/s (299MB/s), 285MiB/s-285MiB/s (299MB/s-299MB/s), io=8192MiB (8590MB), run=28740-28740msec\n\nRun status group 1 (all jobs):\nREAD: bw=284MiB/s (298MB/s), 284MiB/s-284MiB/s (298MB/s-298MB/s), io=16.6GiB (17.9GB), run=60001-60001msec\n\nRun status group 2 (all jobs):\nREAD: bw=7291KiB/s (7466kB/s), 7291KiB/s-7291KiB/s (7466kB/s-7466kB/s), io=427MiB (448MB), run=60001-60001msec\n\nRun status group 3 (all jobs):\nWRITE: bw=15.7MiB/s (16.4MB/s), 15.7MiB/s-15.7MiB/s (16.4MB/s-16.4MB/s), io=941MiB (987MB), run=60001-60001msec\n\nDisk stats (read/write):\nrbd1: ios=177524/216481, merge=0/4047, ticks=165958/2962504, in_queue=3128462, util=95.02%\n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-4-addition-of-4x-new-osds","title":"Test 4. Addition of 4x new OSDs","text":"<p>By this time, the 5x PM963 NVMes had arrived.</p> <p>For this test, we will be adding 4 of those to my r730XD.</p> <p>So... I added 4x PM963 NVMe to my r730XD</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#results-comparison_2","title":"Results / Comparison","text":"Workload IOPs Bandwidth (MiB/s) Average Latency (ms) 99th Percentile Latency (ms) seq_wr 2321 290 110.18 205 seq_rd 1959 245 130.12 243 rand_rd 1384 5.47 184.05 215 rand_wr 5171 20.2 49.43 137.36 <p>Although, oddly enough, read performance actually went down ~20%. Write performance, slightly improved.</p> <p>I was not expecting these results.</p> <p>IOPs:</p> Workload IOPs Attempt #3 IOPs Attempt #4 Percent Difference seq_wr 2280 2321 1.79% seq_rd 2271 1959 -13.79% rand_rd 1822 1384 -24.00% rand_wr 4015 5171 28.87% <p>Bandwidth:</p> Workload Bandwidth Attempt #3 (MiB/s) Bandwidth Attempt #4 (MiB/s) Percent Difference seq_wr 285 290 1.75% seq_rd 284 245 -13.73% rand_rd 7.29 5.47 -25.00% rand_wr 15.7 20.2 28.66% Raw Results <pre><code>root@benchmark:~# fio bench\nseq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\nStarting 4 processes\nseq_wr: Laying out IO file (1 file / 8192MiB)\nJobs: 1 (f=1): [_(3),w(1)][58.7%][w=19.1MiB/s][w=4879 IOPS][eta 02m:28s]\nseq_wr: (groupid=0, jobs=1): err= 0: pid=348: Tue Aug  8 19:56:18 2023\nwrite: IOPS=2321, BW=290MiB/s (304MB/s)(8192MiB/28235msec); 0 zone resets\n    slat (usec): min=79, max=208042, avg=426.32, stdev=1816.82\n    clat (usec): min=44, max=284619, avg=109753.76, stdev=36317.42\n    lat (usec): min=493, max=284977, avg=110180.09, stdev=36336.85\n    clat percentiles (msec):\n    |  1.00th=[   54],  5.00th=[   59], 10.00th=[   65], 20.00th=[   77],\n    | 30.00th=[   87], 40.00th=[   97], 50.00th=[  108], 60.00th=[  118],\n    | 70.00th=[  128], 80.00th=[  140], 90.00th=[  157], 95.00th=[  169],\n    | 99.00th=[  205], 99.50th=[  249], 99.90th=[  262], 99.95th=[  271],\n    | 99.99th=[  284]\nbw (  KiB/s): min=240132, max=345177, per=99.76%, avg=296379.46, stdev=27464.12, samples=28\niops        : min= 1529, max= 2919, avg=2313.96, stdev=263.69, samples=54\nlat (usec)   : 50=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 50=0.55%, 100=42.64%\nlat (msec)   : 250=56.38%, 500=0.40%\ncpu          : usr=5.57%, sys=73.40%, ctx=5909, majf=1, minf=41185\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nseq_rd: (groupid=1, jobs=1): err= 0: pid=349: Tue Aug  8 19:56:18 2023\nread: IOPS=1959, BW=245MiB/s (257MB/s)(14.3GiB/60001msec)\n    slat (usec): min=35, max=29598, avg=501.42, stdev=661.47\n    clat (usec): min=12, max=601588, avg=129618.12, stdev=38400.72\n    lat (usec): min=620, max=601797, avg=130119.53, stdev=38499.67\n    clat percentiles (msec):\n    |  1.00th=[   93],  5.00th=[  102], 10.00th=[  106], 20.00th=[  111],\n    | 30.00th=[  116], 40.00th=[  121], 50.00th=[  125], 60.00th=[  129],\n    | 70.00th=[  134], 80.00th=[  140], 90.00th=[  150], 95.00th=[  165],\n    | 99.00th=[  243], 99.50th=[  468], 99.90th=[  567], 99.95th=[  584],\n    | 99.99th=[  592]\nbw (  KiB/s): min=112240, max=300288, per=99.76%, avg=250176.93, stdev=37797.35, samples=59\niops        : min=  409, max= 2432, avg=1953.75, stdev=342.93, samples=115\nlat (usec)   : 20=0.01%, 750=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.02%, 50=0.06%\nlat (msec)   : 100=3.79%, 250=95.13%, 500=0.70%, 750=0.29%\ncpu          : usr=0.94%, sys=46.74%, ctx=113094, majf=0, minf=39679\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=117557,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_rd: (groupid=2, jobs=1): err= 0: pid=350: Tue Aug  8 19:56:18 2023\nread: IOPS=1384, BW=5539KiB/s (5672kB/s)(325MiB/60001msec)\n    slat (usec): min=174, max=13197, avg=712.18, stdev=316.75\n    clat (usec): min=61, max=222946, avg=183336.42, stdev=17341.92\n    lat (usec): min=1103, max=224050, avg=184048.61, stdev=17390.86\n    clat percentiles (msec):\n    |  1.00th=[  136],  5.00th=[  148], 10.00th=[  161], 20.00th=[  171],\n    | 30.00th=[  180], 40.00th=[  184], 50.00th=[  188], 60.00th=[  190],\n    | 70.00th=[  192], 80.00th=[  197], 90.00th=[  201], 95.00th=[  205],\n    | 99.00th=[  215], 99.50th=[  218], 99.90th=[  222], 99.95th=[  222],\n    | 99.99th=[  224]\nbw (  KiB/s): min= 3492, max= 6842, per=99.79%, avg=5527.17, stdev=447.19, samples=59\niops        : min=  504, max= 1810, avg=1382.77, stdev=135.58, samples=119\nlat (usec)   : 100=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.02%, 50=0.06%\nlat (msec)   : 100=0.08%, 250=99.83%\ncpu          : usr=1.25%, sys=4.82%, ctx=84221, majf=0, minf=1898\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=83080,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_wr: (groupid=3, jobs=1): err= 0: pid=351: Tue Aug  8 19:56:18 2023\nwrite: IOPS=5171, BW=20.2MiB/s (21.2MB/s)(1212MiB/60009msec); 0 zone resets\n    slat (usec): min=3, max=122313, avg=188.41, stdev=1678.95\n    clat (usec): min=79, max=223063, avg=49241.90, stdev=22938.69\n    lat (usec): min=1519, max=223071, avg=49430.31, stdev=23023.38\n    clat percentiles (usec):\n    |  1.00th=[  1565],  5.00th=[  1893], 10.00th=[ 29230], 20.00th=[ 39060],\n    | 30.00th=[ 44303], 40.00th=[ 47449], 50.00th=[ 47973], 60.00th=[ 49546],\n    | 70.00th=[ 52691], 80.00th=[ 58459], 90.00th=[ 66847], 95.00th=[ 87557],\n    | 99.00th=[137364], 99.50th=[154141], 99.90th=[189793], 99.95th=[204473],\n    | 99.99th=[223347]\nbw (  KiB/s): min= 7792, max=96380, per=100.00%, avg=20700.69, stdev=10787.73, samples=59\niops        : min= 1716, max=42076, avg=5176.01, stdev=3598.17, samples=119\nlat (usec)   : 100=0.01%\nlat (msec)   : 2=5.21%, 4=1.49%, 10=0.14%, 20=0.50%, 50=54.09%\nlat (msec)   : 100=35.10%, 250=3.47%\ncpu          : usr=2.35%, sys=17.74%, ctx=4361, majf=0, minf=2550\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,310315,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\n\nRun status group 0 (all jobs):\nWRITE: bw=290MiB/s (304MB/s), 290MiB/s-290MiB/s (304MB/s-304MB/s), io=8192MiB (8590MB), run=28235-28235msec\n\nRun status group 1 (all jobs):\nREAD: bw=245MiB/s (257MB/s), 245MiB/s-245MiB/s (257MB/s-257MB/s), io=14.3GiB (15.4GB), run=60001-60001msec\n\nRun status group 2 (all jobs):\nREAD: bw=5539KiB/s (5672kB/s), 5539KiB/s-5539KiB/s (5672kB/s-5672kB/s), io=325MiB (340MB), run=60001-60001msec\n\nRun status group 3 (all jobs):\nWRITE: bw=20.2MiB/s (21.2MB/s), 20.2MiB/s-20.2MiB/s (21.2MB/s-21.2MB/s), io=1212MiB (1271MB), run=60009-60009msec\n\nDisk stats (read/write):\nrbd1: ios=141860/286585, merge=0/1953, ticks=142339/2844110, in_queue=2986449, util=95.10%\n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-5-recreated-test-volume","title":"Test 5. Recreated test volume","text":"<p>For the 5th test, I deleted, and recreated the volume used in the benchmarking LXC.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#results-comparison_3","title":"Results / Comparison","text":"Workload IOPs Bandwidth (MiB/s) Average Latency (ms) 99th Percentile Latency (ms) seq_wr 2687 336 95.186 207 seq_rd 2249 281 112.753 317 rand_rd 1518 5.93 167.525 347 rand_wr 7569 29.6 33.748 95.945 <p>IOPs:</p> Workload IOPs Attempt #4 IOPs Attempt #5 Percent Difference seq_wr 2321 2687 15.81% seq_rd 1959 2249 14.80% rand_rd 1384 1518 9.69% rand_wr 5171 7569 46.33% <p>Bandwidth: </p> Workload Bandwidth Attempt #4 (MiB/s) Bandwidth Attempt #5 (MiB/s) Percent Difference seq_wr 290 336 15.86% seq_rd 245 281 14.69% rand_rd 5.47 5.93 8.40% rand_wr 20.2 29.6 46.53% <p>Although, much better then test #4, I was honestly still expecting a bigger boost from the addition of more NVMe.</p> <p>At this point, I was starting to question the method I was using for testing.</p> Raw test results <pre><code>root@benchmark:~# fio bench\nseq_wr: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nseq_rd: (g=1): rw=read, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=libaio, iodepth=256\nrand_rd: (g=2): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nrand_wr: (g=3): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=256\nfio-3.33\nStarting 4 processes\nseq_wr: Laying out IO file (1 file / 8192MiB)\nJobs: 1 (f=1): [_(3),w(1)][58.7%][w=26.8MiB/s][w=6872 IOPS][eta 02m:24s]\nseq_wr: (groupid=0, jobs=1): err= 0: pid=337: Tue Aug  8 20:17:56 2023\nwrite: IOPS=2687, BW=336MiB/s (352MB/s)(8192MiB/24385msec); 0 zone resets\n    slat (usec): min=89, max=116762, avg=369.04, stdev=1933.13\n    clat (usec): min=28, max=206684, avg=94817.18, stdev=36327.82\n    lat (usec): min=130, max=206795, avg=95186.22, stdev=36354.45\n    clat percentiles (msec):\n    |  1.00th=[   43],  5.00th=[   52], 10.00th=[   54], 20.00th=[   61],\n    | 30.00th=[   68], 40.00th=[   78], 50.00th=[   89], 60.00th=[   99],\n    | 70.00th=[  114], 80.00th=[  129], 90.00th=[  150], 95.00th=[  159],\n    | 99.00th=[  190], 99.50th=[  201], 99.90th=[  207], 99.95th=[  207],\n    | 99.99th=[  207]\nbw (  KiB/s): min=288032, max=451907, per=99.53%, avg=342387.96, stdev=33246.59, samples=24\niops        : min= 2014, max= 3835, avg=2673.21, stdev=332.83, samples=48\nlat (usec)   : 50=0.01%, 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.04%, 20=0.06%, 50=1.99%\nlat (msec)   : 100=58.96%, 250=38.91%\ncpu          : usr=2.83%, sys=60.68%, ctx=7547, majf=0, minf=24720\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nseq_rd: (groupid=1, jobs=1): err= 0: pid=338: Tue Aug  8 20:17:56 2023\nread: IOPS=2249, BW=281MiB/s (295MB/s)(16.5GiB/60001msec)\n    slat (usec): min=29, max=80659, avg=436.28, stdev=566.44\n    clat (usec): min=13, max=319140, avg=112753.33, stdev=19021.22\n    lat (usec): min=1510, max=319188, avg=113189.61, stdev=19042.83\n    clat percentiles (msec):\n    |  1.00th=[   83],  5.00th=[   91], 10.00th=[   95], 20.00th=[  102],\n    | 30.00th=[  106], 40.00th=[  109], 50.00th=[  112], 60.00th=[  115],\n    | 70.00th=[  118], 80.00th=[  124], 90.00th=[  130], 95.00th=[  136],\n    | 99.00th=[  153], 99.50th=[  232], 99.90th=[  313], 99.95th=[  317],\n    | 99.99th=[  317]\nbw (  KiB/s): min=217701, max=339539, per=99.92%, avg=287719.02, stdev=21760.39, samples=59\niops        : min= 1018, max= 2632, avg=2250.11, stdev=228.05, samples=119\nlat (usec)   : 20=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.04%\nlat (msec)   : 100=17.85%, 250=81.70%, 500=0.38%\ncpu          : usr=0.79%, sys=43.72%, ctx=135044, majf=0, minf=16454\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=134985,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_rd: (groupid=2, jobs=1): err= 0: pid=339: Tue Aug  8 20:17:56 2023\nread: IOPS=1518, BW=6073KiB/s (6219kB/s)(356MiB/60001msec)\n    slat (usec): min=142, max=29636, avg=651.40, stdev=365.44\n    clat (usec): min=34, max=346309, avg=167525.06, stdev=22943.41\n    lat (usec): min=1140, max=347036, avg=168176.46, stdev=23012.90\n    clat percentiles (msec):\n    |  1.00th=[  110],  5.00th=[  129], 10.00th=[  140], 20.00th=[  150],\n    | 30.00th=[  159], 40.00th=[  165], 50.00th=[  169], 60.00th=[  174],\n    | 70.00th=[  178], 80.00th=[  186], 90.00th=[  194], 95.00th=[  199],\n    | 99.00th=[  215], 99.50th=[  228], 99.90th=[  338], 99.95th=[  342],\n    | 99.99th=[  347]\nbw (  KiB/s): min= 3929, max= 7723, per=99.93%, avg=6069.37, stdev=619.44, samples=59\niops        : min=  584, max= 2090, avg=1515.55, stdev=193.83, samples=119\nlat (usec)   : 50=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.04%\nlat (msec)   : 100=0.07%, 250=99.55%, 500=0.31%\ncpu          : usr=1.10%, sys=4.48%, ctx=92763, majf=0, minf=996\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=99.9%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=91102,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\nrand_wr: (groupid=3, jobs=1): err= 0: pid=340: Tue Aug  8 20:17:56 2023\nwrite: IOPS=7569, BW=29.6MiB/s (31.0MB/s)(1775MiB/60014msec); 0 zone resets\n    slat (usec): min=3, max=94298, avg=129.84, stdev=1360.04\n    clat (usec): min=30, max=96644, avg=33618.38, stdev=10991.64\n    lat (usec): min=1506, max=96649, avg=33748.22, stdev=11020.58\n    clat percentiles (usec):\n    |  1.00th=[ 1598],  5.00th=[ 2147], 10.00th=[22152], 20.00th=[28443],\n    | 30.00th=[31589], 40.00th=[32375], 50.00th=[32900], 60.00th=[35390],\n    | 70.00th=[36963], 80.00th=[42730], 90.00th=[46924], 95.00th=[50070],\n    | 99.00th=[55313], 99.50th=[58459], 99.90th=[67634], 99.95th=[95945],\n    | 99.99th=[96994]\nbw (  KiB/s): min=24180, max=104840, per=100.00%, avg=30285.53, stdev=9957.62, samples=60\niops        : min= 5760, max=42384, avg=7579.24, stdev=3271.05, samples=119\nlat (usec)   : 50=0.01%\nlat (msec)   : 2=4.87%, 4=0.48%, 10=0.08%, 20=2.53%, 50=87.23%\nlat (msec)   : 100=4.82%\ncpu          : usr=1.46%, sys=11.83%, ctx=4652, majf=0, minf=1476\nIO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=0.1%, &gt;=64=100.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.1%\n    issued rwts: total=0,454286,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=256\n\nRun status group 0 (all jobs):\nWRITE: bw=336MiB/s (352MB/s), 336MiB/s-336MiB/s (352MB/s-352MB/s), io=8192MiB (8590MB), run=24385-24385msec\n\nRun status group 1 (all jobs):\nREAD: bw=281MiB/s (295MB/s), 281MiB/s-281MiB/s (295MB/s-295MB/s), io=16.5GiB (17.7GB), run=60001-60001msec\n\nRun status group 2 (all jobs):\nREAD: bw=6073KiB/s (6219kB/s), 6073KiB/s-6073KiB/s (6219kB/s-6219kB/s), io=356MiB (373MB), run=60001-60001msec\n\nRun status group 3 (all jobs):\nWRITE: bw=29.6MiB/s (31.0MB/s), 29.6MiB/s-29.6MiB/s (31.0MB/s-31.0MB/s), io=1775MiB (1861MB), run=60014-60014msec\n\nDisk stats (read/write):\nrbd1: ios=158596/433614, merge=0/4598, ticks=146784/2822599, in_queue=2969383, util=94.45%\nroot@benchmark:~#\n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#overall-results","title":"Overall Results?","text":"Workload Attempt #1 Attempt #2 Attempt #3 Attempt #4 Attempt #5 seq_wr 688 IOPS 1428 IOPS 2280 IOPS 2321 IOPS 2687 IOPS seq_rd 1519 IOPS 1326 IOPS 2271 IOPS 1959 IOPS 2249 IOPS rand_rd 1553 IOPS 1136 IOPS 1822 IOPS 1384 IOPS 1518 IOPS rand_wr 1845 IOPS 4320 IOPS 4015 IOPS 5171 IOPS 7569 IOPS ----------- ------------ ------------ ------------ ------------ ------------ seq_wr 86.0 MiB/s 179 MiB/s 285 MiB/s 290 MiB/s 336 MiB/s seq_rd 190 MiB/s 166 MiB/s 284 MiB/s 245 MiB/s 281 MiB/s rand_rd 6.07 MiB/s 4.44 MiB/s 7.29 MiB/s 5.47 MiB/s 5.93 MiB/s rand_wr 7.21 MiB/s 16.9 MiB/s 15.7 MiB/s 20.2 MiB/s 29.6 MiB/s <p>Here are the calculated differences between Attempt #1, and Attempt #5. </p> Workload IOPs Attempt #1 IOPs Attempt #5 Percent Difference seq_wr 688 2687 290.99% seq_rd 1519 2249 47.97% rand_rd 1553 1518 -2.25% rand_wr 1845 7569 310.24% Workload Bandwidth Attempt #1 (MiB/s) Bandwidth Attempt #5 (MiB/s) Percent Difference seq_wr 86.0 336 290.70% seq_rd 190 281 47.89% rand_rd 6.07 5.93 -2.31% rand_wr 7.21 29.6 311.36% <p>Overall, write performance was improved by 300%. Sequential reads improved by 50%</p> <p>Random reads were actually worse. </p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-6-ceph-tell","title":"Test 6. ceph tell","text":"<p>After noticing, far less then expected changes after test 4 and 5- I determined that perhaps my benchmarking strategy is flawed.</p> <p>So, a few more tests.</p> <p>First up, <code>ceph tell osd.* bench</code></p> OSD Bytes Written Block Size Elapsed Time (sec) Bytes Per Second (MiB/s) IOPS osd.0 1.0 GiB 4 MiB 2.2576 453.6 113.393 osd.1 1.0 GiB 4 MiB 2.3308 440.1 109.833 osd.2 1.0 GiB 4 MiB 2.2770 454.7 112.430 osd.3 1.0 GiB 4 MiB 1.0902 939.8 234.823 osd.4 1.0 GiB 4 MiB 2.2956 445.1 111.519 osd.5 1.0 GiB 4 MiB 1.0839 944.6 236.176 osd.6 1.0 GiB 4 MiB 1.0796 948.6 237.123 osd.7 1.0 GiB 4 MiB 1.0729 953.2 238.604","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#test-7-rados","title":"Test 7. Rados","text":"<p><code>rados bench -p scbench 10 write --no-cleanup</code></p> Metric Value Total time run 10.0457 sec Total writes made 1878 Write size 4194304 bytes Object size 4194304 bytes Bandwidth (MB/sec) 747.784 MB/s Stddev Bandwidth 55.6433 Max bandwidth (MB/sec) 828 MB/s Min bandwidth (MB/sec) 664 MB/s Average IOPS 186 Stddev IOPS 13.9108 Max IOPS 207 Min IOPS 166 Average Latency(s) 0.0855197 sec Stddev Latency(s) 0.0543139 sec Max latency(s) 0.394606 sec Min latency(s) 0.010446 sec <p><code>rados bench -p scbench 10 seq</code></p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#the-final-test","title":"The final test","text":"<p>After ordering a few additional parts, I now have my cluster completed.</p> <p>For the previous tests, due to not having enough distributed storage, I had my ceph pool configured for OSD redundancy.</p> <p>This means- it didn't attempt to distribute data between hosts, but, instead, just ensured three copies were scattered amongst the cluster. </p> <p>Here is the final configuration:</p> <ol> <li>Kube01<ul> <li>1x 1T PM963 NVMe</li> <li>2x 1T PM863 SATA SSD</li> </ul> </li> <li>Kube02<ul> <li>4x 1T PM963 NVMe</li> </ul> </li> <li>Kube05<ul> <li>3x 1T PM863 SATA SSD</li> </ul> </li> </ol> <p>At this point each host has at least 3T of dedicated ceph storage. </p> <p>I reconfigured the cluster, and set the replication rule to do \"host\" redundancy. This means, each PG, will have three copies, all on different hosts. As such, loss of a host (or even two), will cause little impact to ceph storage availability.</p> <p>Danger</p> <p>At the time this final test was completed, my ceph cluster was actively in production use, hosting a few handfuls of workloads.</p> <p>As such, it is extremely likely these results will be degraded due to other concurrent workloads occurring. </p> <p>However- I am including these for completions sake.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#fio-test","title":"fio test","text":"<p>For FIO test, was performed on kube02. Data locality should not be an issue here, as the data is shared equally amongst kube01,02,05.</p> Workload IOPs Bandwidth (MiB/s) Average Latency (ms) 99th Percentile Latency (ms) seq_wr 6523 25.5 39.144 61.081 seq_rd 1591 199 158.674 192.317 rand_rd 1109 4.38 229.331 259 rand_wr 6523 25.5 39.145 124 <p>Compared to the initial benchmarks in Attempt #1-</p> Workload IOPs % Diff Bandwidth % Diff Avg Latency % Diff 99th Latency % Diff seq_wr 329.99% -70.35% -61.00% -74.16% seq_rd 19.63% 4.21% 22.72% 43.25% rand_rd -28.42% -27.86% 63.88% 12.83% rand_wr 253.01% 253.34% -20.82% -9.95% <p>Even with a production load in traffic, we are still able to achieve ~300% better write performance. </p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#rados-bench","title":"rados bench","text":"<p><code>ceph osd pool create testbench 100 100</code></p> <p><code>rados bench -p testbench 10 write --no-cleanup</code></p> <pre><code>root@kube02:~# rados bench -p testbench 10 write --no-cleanup\nhints = 1\nMaintaining 16 concurrent writes of 4194304 bytes to objects of size 4194304 for up to 10 seconds or 0 objects\nObject prefix: benchmark_data_kube02_1190250\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat(s)  avg lat(s)\n    0       0         0         0         0         0           -           0\n    1      16       170       154   615.954       616   0.0572786   0.0947036\n    2      16       316       300   599.933       584   0.0393151   0.0938681\n    3      16       472       456    607.92       624   0.0561432    0.103634\n    4      16       633       617   616.914       644   0.0341497    0.101492\n    5      16       796       780   623.907       652    0.082976   0.0974648\n    6      16       940       924   615.906       576   0.0670499   0.0943829\n    7      16      1073      1057   603.909       532   0.0417127   0.0908596\n    8      16      1230      1214   606.907       628   0.0791687    0.105166\n    9      16      1393      1377   611.905       652    0.054615     0.10418\n   10      16      1550      1534   613.504       628    0.040837    0.103617\nTotal time run:         10.074\nTotal writes made:      1550\nWrite size:             4194304\nObject size:            4194304\nBandwidth (MB/sec):     615.444\nStddev Bandwidth:       38.5146\nMax bandwidth (MB/sec): 652\nMin bandwidth (MB/sec): 532\nAverage IOPS:           153\nStddev IOPS:            9.62866\nMax IOPS:               163\nMin IOPS:               133\nAverage Latency(s):     0.103814\nStddev Latency(s):      0.199058\nMax latency(s):         3.1792\nMin latency(s):         0.0220072\n</code></pre> <p>Sequential Read Performance:</p> <pre><code>root@kube02:~# rados bench -p testbench 10 seq\nhints = 1\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat(s)  avg lat(s)\n    0       0         0         0         0         0           -           0\n    1      16       268       252   1007.67      1008    0.127298    0.056575\n    2      16       477       461   921.762       836    0.110868   0.0591162\n    3      16       701       685   913.118       896   0.0439001   0.0529089\n    4      16       894       878   877.814       772   0.0511282    0.069025\n    5      16      1122      1106    884.62       912   0.0232856   0.0702106\n    6      16      1341      1325   883.161       876   0.0330259   0.0696807\nTotal time run:       6.99335\nTotal reads made:     1550\nRead size:            4194304\nObject size:          4194304\nBandwidth (MB/sec):   886.556\nAverage IOPS:         221\nStddev IOPS:          19.7526\nMax IOPS:             252\nMin IOPS:             193\nAverage Latency(s):   0.0703867\nMax latency(s):       2.86267\nMin latency(s):       0.0108277\n</code></pre> <p>Random Read Performance:</p> <pre><code>root@kube02:~# rados bench -p testbench 10 rand\nhints = 1\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat(s)  avg lat(s)\n    0       0         0         0         0         0           -           0\n    1      16       222       206   823.722       824   0.0798764   0.0599234\n    2      16       389       373   745.792       668    0.022481   0.0583019\n    3      16       571       555   739.815       728   0.0208143   0.0495808\n    4      16       755       739   738.829       736    0.292645   0.0839309\n    5      16       939       923   738.244       736   0.0286373   0.0830419\n    6      15      1129      1114   742.511       764  0.00882137   0.0783023\n    7      16      1328      1312   749.564       792   0.0264771   0.0731896\n    8      16      1525      1509   754.353       788   0.0329367    0.082967\n    9      16      1714      1698   754.519       756   0.0422553   0.0826638\n   10      16      1924      1908   763.055       840    0.415251   0.0817146\nTotal time run:       10.1227\nTotal reads made:     1924\nRead size:            4194304\nObject size:          4194304\nBandwidth (MB/sec):   760.269\nAverage IOPS:         190\nStddev IOPS:          12.6034\nMax IOPS:             210\nMin IOPS:             167\nAverage Latency(s):   0.0824948\nMax latency(s):       3.27673\nMin latency(s):       0.00710801\n</code></pre>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/proxmox---building-a-ceph-cluster/#overall-conclusion","title":"Overall Conclusion","text":"<p>My first attempt at building a ceph cluster, using consumer-grade 970 evos, ended in absolute disaster. </p> <p>Anything I/O heavy, would cause workloads to completely lockup. Backups running, would cause application crashes due to excessive I/O latency. </p> <p>Now? </p> <p>I was able to run all of those benchmarks, without impact any of the other workloads currently running. Backups are unnoticeable to the workloads. </p> <p>Compared to running a normal ZFS pool, the performance is pretty bad. However, for the workloads I am running, the level of performance is perfectly adequate. </p> <p>I have also tested random yanking the power cord on nodes, and- the workloads will automatically fire right back up on another node, perfectly intact with little disruption.</p> <p>Overall, I am happy. </p> <p>While, there is lots of potential to squeeze additional performance out of the cluster, I am happy with it, for now.</p>","tags":["Homelab","Proxmox","Ceph"]},{"location":"blog/2023/adding-more-nvme-to-my-r730xd/","title":"Adding more NVMe to the r730XD","text":"<p>Adding 4 more enterprise NVMe drives to my r730XD.</p> <p></p> <p>This is just a short post about its troubleshooting, and.... what will replace it.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/adding-more-nvme-to-my-r730xd/#getting-started","title":"Getting Started","text":"<p>For my ceph cluster project, I needed to add the proper amount of storage to each node, to make a decently performing, highly available ceph-cluster.</p> <p>So, the first task, was to identify a good place to put them....</p> <p>The problem is, my r730XD is already a tad on the full side.</p> <p></p> <p>The r730XD has 6 accessible PCIe slots. Three of which are half height, the rest are full height.</p> <p>Current slot usage:</p> <ol> <li>x8 Half <ul> <li>Coral TPU </li> </ul> </li> <li>Empty x8 Half</li> <li>Empty x8 Half</li> <li>x16 Full<ul> <li>ASUS Hyper M.2. Quad NVMe, Requires motherboard bifurcation<ul> <li>1T Samsung 970 evo</li> <li>1T Samsung 970 evo</li> <li>1T Samsung 970 evo plus</li> <li>1T Samsung 970 evo plus</li> <li>(All four of these NVMe are assigned to a striped-mirrors ZFS pool.)</li> </ul> </li> </ul> </li> <li>x8 Full<ul> <li>Quad NVMe Card. Does not require bifurcation. Fits 4x NVMe.<ul> <li>500G Samsung 970 Evo (Proxmox boot drive)</li> <li>empty</li> <li>empty</li> <li>empty</li> </ul> </li> </ul> </li> <li>x16 Full<ul> <li>Nvidia Tesla P4 GPU</li> </ul> </li> </ol> <p>Instead of putting the new NVMe into the PLX switch which had three empty slots, I felt it would be best to use the empty slots 1 and 2, and enable bifurcation.</p> <p>Since, this is being used for my ceph project, enterprise NVMes were a must here. I went with 4x used enterprise Samsung PM963 1T NVMe.</p> <p>For mounting the NVMe, I went with Chinese Dual M.2 PCIe Adapter. Note- requires motherboard bifurcation.</p> <p>After all of the parts had arrived, the first order of business was to mount the NVMe into the adapter.</p> <p></p> <p>After the cards were loaded, I pulled out the right sled from the r730xd, and inserted the cards into slots 2 and 3.</p> <p></p> <p>Another angle.</p> <p></p> <p>And... after adding everything, we just need to enable bifurcation on the selected slots. This is handled through the BIOS.</p> <p></p> <p>Finally- I had the fun task of assigning the drives within Proxmox. </p> <p>The \"fun\" part- Four of the NVMe are assigned for a pool hosted inside of my Unraid VM.</p> <p>Can- you spot which of the drives are the new ones, and which are the old? </p> <p></p> <p>All done!</p>","tags":["Homelab","PC Builds"]},{"location":"blog/2023/using-emc-drives-in-other-systems/","title":"Reusing EMC Drives in other systems","text":"<p>So, I picked up a EMC-branded 1.92TB PM1633 SAS drive off of ebay, to toss into my ceph cluster.</p> <p>After acquiring it, I slapped it into my Dell MD1220, and was surprised that it was not appearing in proxmox.</p> <p>This is a short post to help correct this issue.</p> <p>First- here are the available drives showing inside of Proxmox</p> <p></p> <p>Note- the 1.92T drives being displayed are a pair of Samsung PM863A SSDs which are also mounted inside of the MD1220.</p> <p>Lets run a <code>lsblk</code> to view the currently detected block devices.</p> <pre><code>root@kube02:~# lsblk\nNAME                                                                                                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsdb                                                                                                     8:16   1   7.5G  0 disk\n\u2514\u2500sdb1                                                                                                  8:17   1   7.5G  0 part /mnt/thumbdrive\nsdc                                                                                                     8:32   0   1.7T  0 disk\nsdf                                                                                                     8:80   0     0B  0 disk\nsdg                                                                                                     8:96   0 223.6G  0 disk\n\u251c\u2500sdg1                                                                                                  8:97   0  1007K  0 part\n\u251c\u2500sdg2                                                                                                  8:98   0     1G  0 part\n\u2514\u2500sdg3                                                                                                  8:99   0 222.6G  0 part\nsdh                                                                                                     8:112  0   1.7T  0 disk\nrbd0                                                                                                  251:0    0     8G  0 disk\nrbd1                                                                                                  251:16   0    16G  0 disk\nrbd2                                                                                                  251:32   0     8G  0 disk\nnvme0n1                                                                                               259:0    0 465.8G  0 disk\n\u251c\u2500nvme0n1p1                                                                                           259:1    0  1007K  0 part\n\u251c\u2500nvme0n1p2                                                                                           259:2    0     1G  0 part /boot/efi\n\u2514\u2500nvme0n1p3                                                                                           259:3    0 464.8G  0 part\n  \u251c\u2500pve-swap                                                                                          252:0    0     8G  0 lvm  [SWAP]\n  \u251c\u2500pve-root                                                                                          252:1    0    96G  0 lvm  /\n  \u251c\u2500pve-data_tmeta                                                                                    252:6    0   3.4G  0 lvm\n  \u2502 \u2514\u2500pve-data                                                                                        252:8    0 337.9G  0 lvm\n  \u2514\u2500pve-data_tdata                                                                                    252:7    0 337.9G  0 lvm\n    \u2514\u2500pve-data                                                                                        252:8    0 337.9G  0 lvm\nnvme6n1                                                                                               259:4    0 894.3G  0 disk\n\u2514\u2500ceph--8e2310de--b5ed--46bd--a32e--5048af46cfe0-osd--block--e06ae6d2--d881--40a0--adcd--2c55020474d5 252:3    0 894.3G  0 lvm\nnvme7n1                                                                                               259:5    0 894.3G  0 disk\n\u2514\u2500ceph--126d8000--5cdd--4ced--ab77--38893cd88dc8-osd--block--6db92940--fc38--4b0b--9fb4--4c5ac6742921 252:2    0 894.3G  0 lvm\nnvme5n1                                                                                               259:6    0 894.3G  0 disk\n\u2514\u2500ceph--3f428911--5213--461d--a5fd--029f673d7ad2-osd--block--e65f3c81--23de--4f81--af2b--be185f6fef42 252:4    0 894.3G  0 lvm\nnvme8n1                                                                                               259:7    0 894.3G  0 disk\n\u2514\u2500ceph--25d71cae--e648--4a95--ae1f--c45f8fa547d7-osd--block--ae41fc24--8408--4656--8310--58e00a2a146b 252:5    0 894.3G  0 lvm\n</code></pre> <p>I am assuming <code>/dev/sdf</code> is the missing drive, but, it is reporting a size of 0B.</p> <p>So, lets resolve this issue.</p> <p>Info</p> <p>Note- This guide assumes you are using a DAS / Disk-shelf, and uses sg3-utils to interact directly with the scsi device.</p> <p>For using local disks, there are easier methods to interact.</p>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#tldr-too-long-didnt-read","title":"TLDR - Too Long, didn't read","text":"<p>If- you don't want to read, and just want to get straight to the point, here is the summary. Otherwise, you can skip this section.</p> <p>This issue occurs because EMC, Netapp, (and others), use a non-standard block size for their drives. We can easily correct this issue by reformatting the drive, with the correct block-size.</p> <ol> <li>Install sg3-utils<ul> <li><code>apt-get install sg3-utils</code></li> </ul> </li> <li>Identify the drive using <code>sg_scan</code><ul> <li><code>sg_scan -i</code></li> </ul> </li> <li>Identify the current block size using <code>sg_readcap</code><ul> <li><code>sg_readcap /dev/sg2</code></li> </ul> </li> <li>Reformat the drive wit the correct block-size using <code>sg_format</code><ul> <li><code>sg_format --format --size=512 /dev/sg2</code></li> </ul> </li> <li>Done.</li> </ol>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#getting-started","title":"Getting Started","text":"","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#install-sg3-utils","title":"Install sg3-utils","text":"<p>This will add the commands needed to interact with SCSI devices.</p> <p><code>apt-get install sg3-utils</code></p>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#step-1-scan-scsi-using-sg_scan","title":"Step 1. Scan SCSI using sg_scan","text":"<p>Next, lets scan for scsi drives, using sg_scan</p> <pre><code>root@kube02:~# sg_scan -i\n/dev/sg0: scsi12 channel=0 id=0 lun=0 [em]\n    VendorCo  ProductCode       2.00 [rmb=1 cmdq=0 pqual=0 pdev=0x0]\n/dev/sg1: scsi11 channel=0 id=60 lun=0\n    ATA       SAMSUNG MZ7LM1T9  104Q [rmb=0 cmdq=1 pqual=0 pdev=0x0]\n/dev/sg2: scsi11 channel=0 id=65 lun=0\n    SAMSUNG   P1633N19 EMC1920  EQPC [rmb=0 cmdq=1 pqual=0 pdev=0x0]\n/dev/sg3: scsi11 channel=0 id=62 lun=0\n    ATA       KINGSTON SA400S3  T1A3 [rmb=0 cmdq=1 pqual=0 pdev=0x0]\n/dev/sg4: scsi11 channel=0 id=63 lun=0\n    ATA       SAMSUNG MZ7LM1T9  204Q [rmb=0 cmdq=1 pqual=0 pdev=0x0]\n/dev/sg5: scsi11 channel=0 id=64 lun=0\n    DELL      MD1220            1.05 [rmb=0 cmdq=0 pqual=0 pdev=0xd]\n</code></pre> <p>We can clearly see /dev/sg2 is indeed the missing PM1633.</p>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#step-2-identify-the-block-size-using-sg_readcap","title":"Step 2. Identify the block size using sg_readcap","text":"<p>From previous experiences with Netapp / EMC, Its not uncommon for those drives to use non-standard / unusual block sizes, which causes issues when you try to reuse the drives.</p> <p>We can use sg_readcap to detect this.</p> <p>Looking at known-working drives, we can see a standard blocksize of 512.</p> <pre><code>root@kube02:~# sg_readcap /dev/sg3\nRead Capacity results:\n   Last LBA=468862127 (0x1bf244af), Number of logical blocks=468862128\n   Logical block length=512 bytes\nHence:\n   Device size: 240057409536 bytes, 228936.6 MiB, 240.06 GB\nroot@kube02:~# sg_readcap /dev/sg4\nRead Capacity results:\n   Last LBA=3750748847 (0xdf8fe2af), Number of logical blocks=3750748848\n   Logical block length=512 bytes\nHence:\n   Device size: 1920383410176 bytes, 1831420.3 MiB, 1920.38 GB\n</code></pre> <p>However, looking at the EMC-branded drive, we get a returned block size of 520 bytes.</p> <pre><code>root@kube02:~# sg_readcap /dev/sg2\nRead Capacity results:\n   Last LBA=3674210303 (0xdaffffff), Number of logical blocks=3674210304\n   Logical block length=520 bytes\nHence:\n   Device size: 1910589358080 bytes, 1822080.0 MiB, 1910.59 GB\n</code></pre>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#step-3-reformat-the-drive-with-the-correct-block-size-using-sg_format","title":"Step 3. Reformat the drive with the correct block size using sg_format","text":"<p>To reformat the drive, we can use sg_format, which will allow us to format the SCSI disk, with the correct block size.</p> <p>The command we will use, is <code>sg_format --format --size=512 /dev/sg2</code> which will format /dev/sg2, with a new blocksize of 512bytes.</p> <pre><code>root@kube02:~# sg_format --format --size=512 /dev/sg2\n    SAMSUNG   P1633N19 EMC1920  EQPC   peripheral_type: disk [0x0]\n      &lt;&lt; supports protection information&gt;&gt;\n      Unit serial number: P0NA0H905801\n      LU name: 5002538a06950fb0\nMode Sense (block descriptor) data, prior to changes:\n  Number of blocks=3674210304 [0xdb000000]\n  Block size=520 [0x208]\n\nA FORMAT UNIT will commence in 15 seconds\n    ALL data on /dev/sg2 will be DESTROYED\n        Press control-C to abort\n\nA FORMAT UNIT will commence in 10 seconds\n    ALL data on /dev/sg2 will be DESTROYED\n        Press control-C to abort\n\nA FORMAT UNIT will commence in 5 seconds\n    ALL data on /dev/sg2 will be DESTROYED\n        Press control-C to abort\n\nFormat unit has started\n</code></pre> <p>After, sending the command, it will take a while to format, and will occasionally yield a progress message.</p> <pre><code>Format unit has started\n\nFormat unit in progress, 2.76% done\nFormat unit in progress, 5.90% done\nFormat unit in progress, 9.01% done\nFormat unit in progress, 12.11% done\nFormat unit in progress, 15.23% done\nFormat unit in progress, 18.33% done\nFormat unit in progress, 21.45% done\nFormat unit in progress, 24.55% done\nFormat unit in progress, 27.66% done\n...\n</code></pre> <p>Afterwards, you can verify is now has the correct block size.</p> <pre><code>root@kube02:~# sg_readcap /dev/sg2\nRead Capacity results:\n   Last LBA=3751804927 (0xdf9fffff), Number of logical blocks=3751804928\n   Logical block length=512 bytes\nHence:\n   Device size: 1920924123136 bytes, 1831936.0 MiB, 1920.92 GB\n</code></pre>","tags":["Homelab","Storage"]},{"location":"blog/2023/using-emc-drives-in-other-systems/#all-done","title":"All Done.","text":"<p>After removing the HDD, and re-inserting it, the drive correctly appeared within Proxmox.</p> <p></p> <p><code>lsblk</code> also now correctly identifies the drive's size. (/dev/sdf)</p> <pre><code>root@kube02:~# lsblk\nNAME                                                                                                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsdb                                                                                                     8:16   1   7.5G  0 disk\n\u2514\u2500sdb1                                                                                                  8:17   1   7.5G  0 part /mnt/thumbdrive\nsdc                                                                                                     8:32   0   1.7T  0 disk\nsdf                                                                                                     8:80   0   1.7T  0 disk\nsdg                                                                                                     8:96   0 223.6G  0 disk\n\u251c\u2500sdg1                                                                                                  8:97   0  1007K  0 part\n\u251c\u2500sdg2                                                                                                  8:98   0     1G  0 part\n\u2514\u2500sdg3                                                                                                  8:99   0 222.6G  0 part\nsdh                                                                                                     8:112  0   1.7T  0 disk\nrbd0                                                                                                  251:0    0     8G  0 disk\nrbd1                                                                                                  251:16   0    16G  0 disk\nrbd2                                                                                                  251:32   0     8G  0 disk\nnvme0n1                                                                                               259:0    0 465.8G  0 disk\n\u251c\u2500nvme0n1p1                                                                                           259:1    0  1007K  0 part\n\u251c\u2500nvme0n1p2                                                                                           259:2    0     1G  0 part /boot/efi\n\u2514\u2500nvme0n1p3                                                                                           259:3    0 464.8G  0 part\n  \u251c\u2500pve-swap                                                                                          252:0    0     8G  0 lvm  [SWAP]\n  \u251c\u2500pve-root                                                                                          252:1    0    96G  0 lvm  /\n  \u251c\u2500pve-data_tmeta                                                                                    252:6    0   3.4G  0 lvm\n  \u2502 \u2514\u2500pve-data                                                                                        252:8    0 337.9G  0 lvm\n  \u2514\u2500pve-data_tdata                                                                                    252:7    0 337.9G  0 lvm\n    \u2514\u2500pve-data                                                                                        252:8    0 337.9G  0 lvm\nnvme6n1                                                                                               259:4    0 894.3G  0 disk\n\u2514\u2500ceph--8e2310de--b5ed--46bd--a32e--5048af46cfe0-osd--block--e06ae6d2--d881--40a0--adcd--2c55020474d5 252:3    0 894.3G  0 lvm\nnvme7n1                                                                                               259:5    0 894.3G  0 disk\n\u2514\u2500ceph--126d8000--5cdd--4ced--ab77--38893cd88dc8-osd--block--6db92940--fc38--4b0b--9fb4--4c5ac6742921 252:2    0 894.3G  0 lvm\nnvme5n1                                                                                               259:6    0 894.3G  0 disk\n\u2514\u2500ceph--3f428911--5213--461d--a5fd--029f673d7ad2-osd--block--e65f3c81--23de--4f81--af2b--be185f6fef42 252:4    0 894.3G  0 lvm\nnvme8n1                                                                                               259:7    0 894.3G  0 disk\n\u2514\u2500ceph--25d71cae--e648--4a95--ae1f--c45f8fa547d7-osd--block--ae41fc24--8408--4656--8310--58e00a2a146b 252:5    0 894.3G  0 lvm\n</code></pre>","tags":["Homelab","Storage"]},{"location":"blog/2023/removing-stripe-from-zfs-pool/","title":"Removing a stripe from a zfs pool","text":"<p>In my quest to optimize on power usage, One of my servers has a zfs pool consisting of 4x 8T disks, in striped mirrors configuration.</p> <p>For this particular pool, IOPs and performance is not needed. As well, I am using barely 10% of the available space in this particular pool.</p> <p>So- I decided to remove a pair of disks, to save a miniscule amount of energy.</p> <p>Danger</p> <p>These steps are intended for openzfs.</p> <p>Also- I am not responsible for data loss. Don't perform actions on your pool, without tested, working backups.</p> <p>(Snapshots / Raid) is not backups.</p>","tags":["Homelab","Storage"]},{"location":"blog/2023/removing-stripe-from-zfs-pool/#step-1-identify-your-pool","title":"Step 1. Identify your pool","text":"<p><code>zpool status</code> can be used to identify your pool, and its vdevs.</p> <pre><code>root@Tower:~# zpool status\n  pool: cache\n state: ONLINE\n  scan: resilvered 1.59M in 00:00:00 with 0 errors on Wed Dec 13 19:09:21 2023\nconfig:\n\n        NAME           STATE     READ WRITE CKSUM\n        cache          ONLINE       0     0     0\n          mirror-0     ONLINE       0     0     0\n            nvme2n1p1  ONLINE       0     0     0\n            nvme1n1p1  ONLINE       0     0     0\n          mirror-1     ONLINE       0     0     0\n            nvme0n1p1  ONLINE       0     0     0\n            nvme3n1p1  ONLINE       0     0     0\n\nerrors: No known data errors\n\n  pool: main\n state: ONLINE\n  scan: scrub repaired 0B in 01:47:49 with 0 errors on Sun Dec 10 11:47:50 2023\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        main        ONLINE       0     0     0\n          mirror-0  ONLINE       0     0     0\n            sdc1    ONLINE       0     0     0\n            sdf1    ONLINE       0     0     0\n          mirror-1  ONLINE       0     0     0\n            sdg1    ONLINE       0     0     0\n            sdi1    ONLINE       0     0     0\n</code></pre> <p>In my case, I want to remove the <code>mirror-1</code> vdev from the <code>main</code> pool.</p>","tags":["Homelab","Storage"]},{"location":"blog/2023/removing-stripe-from-zfs-pool/#step-2-remove-the-vdev","title":"Step 2. Remove the vdev","text":"<p>Removing a top-level vdev is easy to do.</p> <p><code>zpool remove main mirror-1</code></p> <p>Where the syntax is- zpool remove pool-name vdev-name</p> <p>Documentation for this command Can be found on the openzfs github</p> <p>Running this command will not yield any output. However, you can view the current progress using <code>zpool status</code></p> <pre><code>root@Tower:~# zpool status\n  pool: cache\n state: ONLINE\n  scan: resilvered 1.59M in 00:00:00 with 0 errors on Wed Dec 13 19:09:21 2023\nconfig:\n\n        NAME           STATE     READ WRITE CKSUM\n        cache          ONLINE       0     0     0\n          mirror-0     ONLINE       0     0     0\n            nvme2n1p1  ONLINE       0     0     0\n            nvme1n1p1  ONLINE       0     0     0\n          mirror-1     ONLINE       0     0     0\n            nvme0n1p1  ONLINE       0     0     0\n            nvme3n1p1  ONLINE       0     0     0\n\nerrors: No known data errors\n\n  pool: main\n state: ONLINE\n  scan: scrub repaired 0B in 01:47:49 with 0 errors on Sun Dec 10 11:47:50 2023\nremove: Evacuation of mirror in progress since Wed Dec 13 21:18:05 2023\n        6.06G copied out of 940G at 98.6M/s, 0.64% done, 2h41m to go\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        main        ONLINE       0     0     0\n          mirror-0  ONLINE       0     0     0\n            sdc1    ONLINE       0     0     0\n            sdf1    ONLINE       0     0     0\n          mirror-1  ONLINE       0     0     0\n            sdg1    ONLINE       0     0     0\n            sdi1    ONLINE       0     0     0\n\nerrors: No known data errors\n</code></pre> <p>At this point, you just need to wait for the pool to finish moving data around.</p> <p>It will yield the estimated time, and once completed, the vdev will be removed.</p>","tags":["Homelab","Storage"]},{"location":"blog/2023/removing-stripe-from-zfs-pool/#step-3-wait","title":"Step 3. Wait","text":"<p>At this point, you just need to wait for it to finish. Once finished, the VDEV will be automatically removed.</p> <p>If- you use Unraid, you can also see the activity via its GUI. (At least, seeing reads from one stripe- and writes going to the other)</p> <p></p> <p>Using bash, you can use <code>watch zpool status &lt;poolname&gt;</code> which will display the current status every few seconds.</p> <pre><code>Every 2.0s: zpool status main                                                                                                                                                                                               Tower: Wed Dec 13 21:38:46 2023\n\n  pool: main\n state: ONLINE\n  scan: scrub repaired 0B in 01:47:49 with 0 errors on Sun Dec 10 11:47:50 2023\nremove: Evacuation of mirror in progress since Wed Dec 13 21:18:05 2023\n        150G copied out of 940G at 123M/s, 15.91% done, 1h49m to go\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        main        ONLINE       0     0     0\n          mirror-0  ONLINE       0     0     0\n            sdc1    ONLINE       0     0     0\n            sdf1    ONLINE       0     0     0\n          mirror-1  ONLINE       0     0     0\n            sdg1    ONLINE       0     0     0\n            sdi1    ONLINE       0     0     0\n\nerrors: No known data errors\n</code></pre>","tags":["Homelab","Storage"]},{"location":"blog/2024/reattaching-nvme-from-vfio/","title":"Proxmox - Reattach NVMe previous bound by VFIO","text":"<p>So, I have a VM on proxmox, which has 4 individual NVMe drives directly passed in. </p> <p>I wanted to attach one of those drives to another VM. </p> <p>This is a very short guide on how to unbind the NVMe from vfio, and re-attach it to the hypervisor.</p>","tags":["Homelab","Storage","Proxmox"]},{"location":"blog/2024/reattaching-nvme-from-vfio/#steps","title":"Steps","text":"","tags":["Homelab","Storage","Proxmox"]},{"location":"blog/2024/reattaching-nvme-from-vfio/#1-identify-the-drive","title":"1. Identify the drive","text":"<p>In my case, I am looking for a 1T Samsung 970 evo.</p> <p>However, looking at the drive from the hypervisor, shows that it is still bound by VFIO, despite being removed from the VM.</p> <pre><code>root@kube02:~# lshw -class storage\n  *-nvme\n       description: Non-Volatile memory controller\n       product: NVMe SSD Controller SM981/PM981/PM983\n       vendor: Samsung Electronics Co Ltd\n       physical id: 0\n       bus info: pci@0000:84:00.0\n       version: 00\n       width: 64 bits\n       clock: 33MHz\n       capabilities: nvme pm msi pciexpress msix nvm_express cap_list\n       configuration: driver=vfio-pci latency=0\n       resources: irq:82 memory:c8600000-c8603fff\n</code></pre> <p>Since, it is currently bound to the VFIO driver, we cannot currently use it with the host.</p>","tags":["Homelab","Storage","Proxmox"]},{"location":"blog/2024/reattaching-nvme-from-vfio/#step-2-release-the-device-from-vfio","title":"Step 2. Release the device from VFIO.","text":"<p>After googling this issue myself, I found lots of guides on the internet telling me to unload the vfio modules. </p> <p>You do not want to do this, as it will potentially break all of your other VMs with device passthrough.</p> <p>Instead, we can unbind a single device.</p> <p><code>echo \"0000:84:00.0\" &gt; /sys/bus/pci/devices/0000:84:00.0/driver/unbind</code></p> <p>Now, we can bind it to the nvme driver.</p> <p><code>echo \"0000:84:00.0\" &gt; /sys/bus/pci/drivers/nvme/bind</code></p>","tags":["Homelab","Storage","Proxmox"]},{"location":"blog/2024/reattaching-nvme-from-vfio/#step-3-done","title":"Step 3. Done.","text":"<p>As you can see, the NVMe is now usable by the host.</p> <pre><code>root@kube02:~# lsblk\nNAME                                                                                                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nnvme1n1                                                                                               259:8    0 931.5G  0 disk\n\u2514\u2500nvme1n1p1\n</code></pre> <pre><code>root@kube02:~# lshw -class storage\n  *-nvme\n       description: NVMe device\n       product: Samsung SSD 970 EVO 1TB\n       vendor: Samsung Electronics Co Ltd\n       physical id: 0\n       bus info: pci@0000:84:00.0\n       logical name: /dev/nvme1\n       version: 2B2QEXE7\n       serial: S5H9NS0NA99060M\n       width: 64 bits\n       clock: 33MHz\n       capabilities: nvme pm msi pciexpress msix nvm_express bus_master cap_list\n       configuration: driver=nvme latency=0 nqn=nqn.2014.08.org.nvmexpress:144d144dS5H9NS0NA99060M     Samsung SSD 970 EVO 1TB state=live\n       resources: irq:365 memory:c8600000-c8603fff\n</code></pre>","tags":["Homelab","Storage","Proxmox"]},{"location":"blog/2024/proxmox---import-ova/","title":"Proxmox - Import OVA","text":"<p>A random thing I recently came across while testing out LibreNMS- </p> <p>I discovered they have a published .ova, which I wanted to import into Proxmox. However, proxmox as of this post, does not have a easy option to support importing this.</p> <p>This- is a quick post, containing the commands you need, to import the ova.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---import-ova/#steps","title":"Steps","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---import-ova/#1-download-the-ova","title":"1. Download the .ova","text":"<p>First- download the ova onto one of your proxmox nodes.</p> <p><code>wget https://github.com/librenms/packer-builds/releases/download/23.11.0/librenms-ubuntu-22.04-amd64-vmware.ova</code></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---import-ova/#2-extract-the-ova-into-a-ovf","title":"2. Extract the .ova, into a .ovf","text":"<p>A .ova is just a tar archive, with a few extra things.</p> <p><code>tar -xf librenms-ubuntu-22.04-amd64-vmware.ova</code></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---import-ova/#3-import-the-ovf","title":"3. Import the .ovf","text":"<p>The format of the command-</p> <p>qm importovf VM-ID OVF-FILE YOUR-STORAGE</p> <p>135 is the next free ID I have, so I will use this.</p> <p>We will use the .ovf we got from extracting the .ova above.</p> <p>Finally- we need to pick the target storage for the new VM.</p> <p>If- you don't know which storage, or the name of your storage, you can use <code>pvesm status</code> to list the available storages.</p> <pre><code>root@kube02:~# pvesm status\nName               Type     Status           Total            Used       Available        %\nGameStorage     zfspool     active       942931968       294817116       648114852   31.27%\nISOs                nfs     active     15512513536      3881544704     11630968832   25.02%\nUnraid              nfs     active     15512513536      3881544704     11630968832   25.02%\nceph-block          rbd     active      3670495077       571569765      3098925312   15.57%\nlocal               dir     active        98497780        11778920        81669312   11.96%\n</code></pre> <p>I will be choosing ceph-block storage.</p> <p>Here is the resulting command</p> <p><code>qm importovf 135 librenms-ubuntu-22.04-amd64-vmware.ovf ceph-block</code></p> <pre><code>root@kube02:~# qm importovf 135 librenms-ubuntu-22.04-amd64-vmware.ovf ceph-block\ntransferred 0.0 B of 40.0 GiB (0.00%)\ntransferred 409.6 MiB of 40.0 GiB (1.00%)\ntransferred 819.2 MiB of 40.0 GiB (2.00%)\ntransferred 1.2 GiB of 40.0 GiB (3.00%)\n...\ntransferred 40.0 GiB of 40.0 GiB (100.00%)\ntransferred 40.0 GiB of 40.0 GiB (100.00%)\n</code></pre> <p>After this is done, you will have a new VM created. You can view and manage this VM using the web interface.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/","title":"Balancing Power Consumption and Cost: The True Price of Efficiency","text":"<p>Too often- I see the all too familiar post on reddit.</p> <p>Hey guys- Look at this really nice hardware I got for free, or for cheap. </p> <p>And- there is ALWAYS a comment along the lines of, \"Say good bye to your energy bill\", or \"Time to watch your meter spin!\"</p> <p>So- today, I am here to address a few common misconceptions. </p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#power-consumption-of-various-computer-components","title":"Power Consumption of various Computer Components","text":"<p>With exceptions- The motherboard and CPU generally represent a small piece of the efficiency puzzle, in most cases.</p> <p>What I mean by this....</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#the-real-power-consumers-accessories","title":"The Real Power Consumers: Accessories","text":"<p>The accessories you plug into a computer often consume the majority of power:</p> Component Typical Idle Power Consumption 100% Active Usage Power Consumption 3.5\" HDDs 3 to 5 watts 6 to 10 watts 2.5\" HDDs 1 to 3 watts 2 to 5 watts 15k SAS HDDs 10 to 15 watts 15 to 20 watts SATA SSDs 2 to 4 watts 4 to 6 watts NVMe SSDs 4 to 7 watts 6 to 10 watts Each 1G port in use Approximately 0.5 watts 1 to 2 watts Each DIMM of DDR3 2 to 5 watts 3 to 7 watts Each DIMM of DDR4 2 to 4 watts 3 to 6 watts DDR3 ECC RAM (Non-buffered) 2 to 5 watts 3 to 7 watts DDR4 ECC RAM (Non-buffered) 2 to 4 watts 3 to 6 watts DDR3 ECC RAM (Buffered) 3 to 6 watts 4 to 8 watts DDR4 ECC RAM (Buffered) 3 to 5 watts 4 to 7 watts Every add-on card Varies; up to 75 watts without dedicated power Varies; up to 75 watts without dedicated power Copper 10G port 3 to 6 watts 6 to 10 watts Fiber 10G port with transceiver 1 to 2 watts (port) + 0.6 to 1 watt (transceiver) 2 to 3 watts (port) + 1 to 1.5 watts (transceiver) SATA HBA 4 to 8 watts 8 to 12 watts Dedicated GPU (idle) 15 to 30 watts 150 to 300 watts (varies widely based on model) Power Supply (80+ Bronze, 500W) 10 to 15 watts (efficiency loss) 50 to 70 watts (efficiency loss) Power Supply (80+ Silver, 500W) 8 to 12 watts (efficiency loss) 40 to 60 watts (efficiency loss) Power Supply (80+ Gold, 500W) 5 to 10 watts (efficiency loss) 30 to 50 watts (efficiency loss) Power Supply (80+ Platinum, 500W) 3 to 7 watts (efficiency loss) 20 to 40 watts (efficiency loss) Power Supply (80+ Titanium, 500W) 2 to 5 watts (efficiency loss) 15 to 30 watts (efficiency loss) Case Fans (120mm) 1 to 3 watts 2 to 5 watts CPU Cooler (Air) 2 to 5 watts (varies based on size and speed) 5 to 15 watts (under heavy load) CPU Cooler (Liquid) 2 to 8 watts (varies based on pump and fan speed) 5 to 20 watts (under heavy load)","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#examples","title":"Examples","text":"","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#case-study-1-synology-ds423","title":"Case Study 1: Synology DS423+","text":"<p>Consider a Synology DS423+, rated to idle at 8.5 watts with HDD Hibernation.</p> <p>If you add:</p> <ul> <li>4x 3.5\" HDDs (I Mean... it is a NAS afterall... it doesn't work well without HDDs)</li> <li>Connect both gigabit ports</li> <li>Populate both NVMe slots</li> </ul> <p>It's going to use 45-50 watts at idle, instead of the expected 8 watts, despite only having a lowly intel celeron processor.</p> <p>Here- is my data. (What- you didn't think I was going to make claims without data, did you?)</p> <p></p> <p>That being said, this particular unit is only used for backups. 95% of the time, its sitting basically idle.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#case-study-2-optiplex-micros","title":"Case Study 2: Optiplex Micros","text":"<p>I have a pair of optiplex Micros</p> <ul> <li>i7-6700: Optiplex 7050m - Idles around 20 watts- but, stays around 30% utilization.</li> <li>i5-9500T: Optiplex 3070m - Also idles around 8-12 watts with a small load. Stays around 7% utilization.</li> </ul> <p>You would think, for only a 20% difference in utilization- the much newer i5-9500t would be leaps and bounds better then the i6-6700, right? I mean- Its three generations newer, and its a \"t\" variant with a much lower TDP. Also- its an i5, instead of an i7.</p> <p>Wrong!</p> <p>Again- here is 24 hours worth of usage.</p> <p>Red line is the machine with the i7-6700, and the blue line is the i5-9500t</p> <p></p> <p>Because data is king- here is one months worth of utilization from these devices.</p> <p>Kube04 (i5-9500t)</p> <p></p> <p>Kubeo6 (i7-6700)</p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#case-study-3-newer-isnt-always-better-or-is-it","title":"Case Study 3: Newer isn't always better (or is it?)","text":"","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#r720xd-vs-r730xd","title":"R720XD vs. R730XD","text":"<p>I used to run an R720XD, the server I built my 40G NAS Project with. After many optimizations, its idle utilization WITH:</p> <ul> <li>14 HDDs</li> <li>A ton of NVMe</li> </ul> <p>Was down to 168 watts. While that sounds high, remember that includes a significant number of HDDs and NVMe.</p> <p>Now, I have an R730XD with:</p> <ul> <li>v4 processors (compared to v2)</li> <li>DDR4 RAM (instead of DDR3)</li> </ul> <p>Its load is quite a bit less due to more SFFs and micros spreading the load. However, I can't get it to idle under 240 watts, to save my life.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#why","title":"Why?","text":"<p>Its due to the accessories loaded in it.</p> <p>My r720XD had most of the RAM removed, which a good bit of energy. My r730XD has 16 of the 24 slots populated currently, with 256G of ram. That- is 48 to 80 watts just worth of RAM.</p> <p>The r720XD also had one of its processors removed. </p> <p>Are- these servers less efficient the my i5-8500t?</p> <p>The answer- is not a simple yes or no. It depends on your needs.</p> <p>If you need tons of ram, its more efficient to get one of these big servers, rather then to get a bunch of smaller ones.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#why_1","title":"Why?","text":"<p>128G of DDR4-ECC Server memory costs 100$ shipped. 128G of DDR4-Desktop memory, costs 200$ shipped.</p> <p>My SFFs with i7-8700s can each fit 64G of RAM, and this ram costs 100$, and the machine is between 150-200$.</p> <p>It would take four of those machines to match the current memory capacity as my r730xd. My r730XD costed me 500$ shipped + 100$ for another 128G of ram = 600$ total.</p> <p>Four of those machines, would cost 600$ to 800$ for the machines, plus 400$ more for the ram. = 600-1,200$. </p> <p>The idle draw of my r730XD under typical load- is 220-240 watts, including 128T of spinning rust, a Nvidia GPU, and a dozen (not a typo) NVMes.</p> <p>Here is 24 hours of consumption for my SFFs.</p> <p></p> <p>Between 35-50 watt idle for each of them. So- lets assume between 160-200 watts if we had four of them.</p> <p>So- they are more efficient then, right?</p> <p>Nope. They don't have over 100 watts worth of hard drives and NVMes. </p> <p>If- you don't need, or have a use for the resources- then by all means- they are more efficient. But- if you do need those resources- the server hardware becomes drastically cheaper, and more efficient.</p> <p>Remember- servers are designed to be efficient... At Scale. (&lt;-- Keyword)</p> <p>If consumer hardware was \"The way\" for efficiency, you would see them being used in datacenters. </p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#case-study-4-lower-power-processors-dont-mean-lower-power","title":"Case Study 4- Lower power processors, don't mean lower power.","text":"<p>While I was doing the 40G NAS project, one of my experiments to reduce power- was to change out the CPUs with more \"efficient\" models.</p> <p>Originally, the server had E5-2695v2 processors</p> <p>These were 12c/24t processors, with a 2.4/3.2 ghz base/boost clock. The TDP was 115W each.</p> <p>So- I picked up a pair of E5-2630L v2 processors. The L, standing for low energy.</p> <p>These- were 6c/12t processors, with a 2.4/2.8ghz base/boost clock. The TDP was 60w each. Nearly half of the original processor.</p> <p>What happened? </p> <p>An EXTREMELY slight drop in power consumption. Nearly un-noticeable, measuring at most, 10w. </p> <p>As- these processors were noticably slower then the originals- I decided to swap processors again.</p> <p>This time, I swapped to a pair of E5-2667v2 processors</p> <p>These processors, are 8c/16t with a 3.3/4ghz base/boost clock. The TDP is 130W each.</p> <p>Based on the TDP alone- these processors sound like the worst choice! Right?</p> <p>Surprisingly- these were the most efficient processors, saving a whopping 30 watts over even the \"L\" variant processors.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#why-is-this-the-case","title":"Why is this the case?","text":"<p>Well- I had my theory that the faster processor was able to finish its work faster, and spend more time in an idle state. This- was just my theory.</p> <p>Yesterday- <code>r/thepsyborg</code> confirmed my theory, and let me know of the term \"race to sleep\", or \"race to halt\"</p> <p>Since- I am not knowledgeable enough to explain it- I am going to provide this summary here.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#understanding-race-to-sleep","title":"Understanding \"Race to Sleep\"","text":"<p>\"Race to Sleep\" refers to the competition among computer components to enter low-power sleep states quickly. This optimization is vital for energy efficiency in modern computing. Efficient power management extends battery life, reduces environmental impact, and saves costs. Challenges include balancing performance with power consumption and ensuring seamless transitions between states. Hardware and software optimizations address these challenges, promoting energy-efficient computing solutions.</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#the-efficiency-myth-raspberry-pi-4-8gb","title":"The Efficiency Myth: Raspberry Pi 4 8GB","text":"<p>Everyone touts the Raspberry Pi 4 8GB as being extremely efficient. </p> <p>They aren't. Their efficient is actually really horrible, for what they are. A pi-4 8g, will consume between 3-7 watts. The charger/wall bricks, are typically 80-90% efficient. (So- very little overhead here)</p> <p>Remember- the optiplex micros from step 2? The ones that idle at 8-12 watts WHILE running VMs and containers?</p> <p>Compare their CPU power to the Raspberry Pi 4 8GB:</p> <ul> <li>Benchmark Comparison</li> </ul> <p>They have TEN TIMES the CPU power and DRASTICALLY faster I/O, USB, etc.</p> <p>And- the optiplex micro is idling at only around twice the consumption of a raspberry pi. (not factoring in- that is also has both a 2.5\" SSD, and a NVMe)</p>","tags":["Homelab"]},{"location":"blog/2024/balancing-power-consumption-and-cost-the-true-price-of-efficiency/#conclusion-power-consumption-and-cost-efficiency","title":"Conclusion: Power Consumption and Cost Efficiency","text":"<p>Understanding power consumption is crucial for making informed hardware decisions. </p> <ul> <li>If you spend $200 more on a certain piece, but only save a few watts, it's pretty trivial to calculate the ROI to determine if it's actually worth it. More efficient does not always mean cheaper.</li> </ul> <p>A few years back, I created an ROI calculator to assist with determining the ROI based on power consumption, price, and your cost of energy.</p> <p>Power Consumption versus Price.</p> <p>In the end, there is no \"Correct\" answer, and at the time of writing this, there is no perfect solution. </p> <p>There- are simply too many variables, such as...</p> <ul> <li>Your cost of electricity.</li> <li>The amount of room you have (aka, is a standard tower too big? Rack server out of question?)</li> <li>How many accessories you add. (HDDs, NVMes, GPUs, etc)</li> <li>What is the average load. <ul> <li>Under idle load- much faster processors will actually consume far less energy- because they finish the task faster, and spend more time in an idle state. TDP has basically no impact on idle draw.</li> <li>Near max load - The TDP will have a drastic impact on efficiency- as TDP governs the maximum thermal power the CPU can generate for a duration.</li> </ul> </li> </ul> <p>Do the math. Do your research. </p> <p>Don't listen to every jackass who claims your electric meter is going to spin out of control.</p>","tags":["Homelab"]},{"location":"blog/2024/backup-strategies/","title":"My personal backup strategies. How I implement 3-2-1, or better.","text":"<p>This- is a short post explaining my personal backup strategies for VMs, Kubernetes, Personal Devices, etc.</p> <p>I discuss my strategies for implementing, and exceeding the 3-2-1 backup rule, for Kubernetes, Proxmox, File Shares, and personal devices.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#what-is-the-3-2-1-rule","title":"What is the 3-2-1 rule?","text":"<p>The 3-2-1 Rule is a data protection strategy that recommends having three copies of your data, stored on two different types of media, with one copy kept off-site.</p> <p>This means- 1. Maintain three copies of your data: This includes the original data and at least two copies. 2. Use two different types of media for storage: Store your data on two distinct forms of media to enhance redundancy. 3. Keep at least one copy off-site: To ensure data safety, have one backup copy stored in an off-site location, separate from your primary data and on-site backups.</p> <p>Any data that cannot be replaced extremely easily, should try to follow this strategy. </p> <p>For data that is irreplaceable- 3-2-1 isn't good enough. </p> <p>As an example- for the decades worth of photos I have collected, I have AT MINIMUM 7 PHYSICAL copies, excluding snapshots.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#my-backup-strategies","title":"My Backup Strategies","text":"","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#synology-itself","title":"Synology Itself","text":"<p>As you will find in this post- My synology is one of the primary pieces of infrastructure for my various backup strategies.</p> <p>I purchased this unit SPECIFICALLY with the use-case in mind, of using it for backups.</p> <p>All of the important shares, are protected by immutable snapshots, which prevents the deletion of the data / share, until a timer has passed. This- is intended to prevent administrative action, or ransomware from being able to affect or touch the backups until a specified amount of time has past.</p> <p>In addition to immutable snapshots of shares- All of the data gets  encrypted, and replicated off-site, to multiple locations.</p> <p>I use a well-known, but, unspecified cloud S3 provider for one copy, they also keep their own versioning and retention policies.</p> <p>And- I have a friend whom we share space on each other's NAS/Networks for the purpose of storing backups. The data is encrypted so that neither party can look at each other's backups, and is transferred through a VPN tunnel between our networks. We are geographically separated by enough distance, that a singular event has little chance of taking out both of our networks.</p> <p>That being said- this meets the 3-2-1 rule for anything on the synology, and exceeds it for anything backed up to it.</p> <ol> <li>First copy on the NAS itself<ul> <li>Immutable snapshots to help protect against administrative failure, or ransomware.</li> </ul> </li> <li>One copy in the cloud.<ul> <li>Cloud provider has their own snapshots.</li> </ul> </li> <li>One copy at a friends house.</li> </ol> <p>Lastly- ALL of my disks are encrypted at rest. Any data transferred outside of my network, is again encrypted by a key that only I know.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#minio","title":"Minio","text":"<p>Minio is used for backups of my Kubernetes environment, and a few other services</p> <p>If offers the advantage that I can store immutable buckets of data, automatically replicate that data, and have the ability to do a point-in-time restore.</p> <p>Here is a screenshot of the \"Rewind\" functionality.</p> <p></p> <p>My minio itself, has multiple layers of backups, and replication.</p> <ol> <li>Primary instance hosted on my Unraid server<ul> <li>Automatic scheduled snapshot creation and retention via sanoid. (Its hosted on a ZFS array)</li> <li>Underlying ZFS pool is redundant, and can tolerate loss of half of its disks.</li> </ul> </li> <li>Automatic replication between itself, and another minio instance hosted on my synology.<ul> <li>Automatic scheduled IMMUTABLE snapshot creation, and retention via Synology Snapshot Manager.</li> <li>Underlying BTRFS pool is redundant, and can tolerate loss of half of its disks.</li> </ul> </li> <li>Automatic Encrypted S3 replication off-site to my S3 provider.<ul> <li>They maintain their own versioning</li> <li>I'd assume they have redundant datacenters. But, never asked...</li> </ul> </li> </ol>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#proxmox-vms-and-configuration","title":"Proxmox - VMs and Configuration","text":"","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#proxmox-vm-lxc-backups-via-proxmox-backup-server-wiscsi-on-synology","title":"Proxmox VM / LXC Backups - Via Proxmox Backup Server w/iSCSI on Synology","text":"<p>Originally, I used a NFS target to unraid for my backups. When I picked up the synology, I decided to create a Proxmox Backup Server VM,  but, host its storage to the synology via iSCSI. </p> <p>Proxmox backup server is pretty great once you have it up and running. I am currently getting extremely good deduplication rates- that goes up with every single backup (since, very little actually changes). It does not consume many resources, and it only needs to transfer incremental (A NFS backup target did full backups, every time). In addition, you can do point in time, file-level restores.</p> <p>Here is a picture of the Proxmox Backup Server Console, showing my iSCSI share.</p> <p></p> <p>Here is a screenshot showing the file-level store functionality offered when you use Proxmox Backup Server.</p> <p></p> <p>Overall- HUGE success. With the deltas, and incremental backups, the iSCSI over 1G has not been an issue at all. There- isn't much data transfer needed.</p> <p>(Do note- I do not backup my Kubernetes worker-nodes. They have their own solution down below)</p> <p>The iSCSI LUN was configured with the \"SAN Manager\" app, and also has immutable snapshots scheduled, and custom retention policies... So, even in the event the share gets completely nuked, I still have entire disk snapshots.</p> <p>For this particular data- there will always be at least three copies, meeting the 3-2-1 rule.</p> <ol> <li>Stored in Proxmox Backup Server - w/Storage hosted on the synology.<ul> <li>Immutable snapshots and retention policies scheduled for the LUN.</li> </ul> </li> <li>Afterwards- follows the Synology's backup plan, which replicates the data to multiple cloud targets.</li> </ol>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#proxmox-configuration-via-synology-app-active-backup-for-business","title":"Proxmox Configuration - Via Synology App, \"Active Backup for Business\"","text":"<p>For backing up the running cluster state, and configuration, I found the \"Active Backup for Business\" to be the best fit. I configured one of my proxmox hosts with a SSH key, and configured it as a \"File Server\" using ssh/rsync.</p> <p>When- configuring a file server- here are the various options you have for backing it up.</p> <p></p> <p>Since- <code>/etc/pve</code> is a cluster file system on all of the nodes- backing up that directory from a single host is enough to capture the entire cluster state.</p> <p>Here is a screenshot showing some of the configuration options for this specific task. You can select many files, or folders as needed, set different retention policies, set file type filters, etc.</p> <p></p> <p>I was able to configure the synology to keep multi-versioned backups, which will allow me to execute a point-in-time recovery of any data.</p> <p>Here- is a picture of the recovery portal. It is quite easy to use.</p> <p></p> <p>Like the VM backups- we have a minimum of three copies of the cluster configuration state, available with point in time file restores.</p> <ol> <li>Stored on Synology<ul> <li>Immutable snapshots and retention policies scheduled for the LUN.</li> </ul> </li> <li>Afterwards- follows the Synology's backup plan, which replicates the data to multiple cloud targets.</li> </ol>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#unraid-file-servers","title":"Unraid / File Servers","text":"","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#unraid-shares-via-synology-app-active-backup-for-business","title":"Unraid Shares - Via Synology App, \"Active Backup for Business\"","text":"<p>Since, I have some important data stored on ZFS Pools within my Unraid cluster, I wanted to ensure I had backups for this as well.</p> <p>I used the same \"Active Backup for Business\" as before- but, I configured these backups as \"Mirrored\" (which doesn't keep full versioning). </p> <p>It is still configured as a File Server via rsync/ssh. I use this to backup my unraid's <code>/mnt/cache/appdata</code>, <code>/boot</code>, and a few other important shares.</p> <p>The shares hosted on ZFS, also have sanoid running to take automatic dataset snapshots on a schedule, and manage retention.</p> <p>For these important shares- we have plenty of redundancy in backups.</p> <ol> <li>(Redundancy) ZFS Striped-Mirrors. Will tolerate two failed disks before data-failure<ul> <li>(Local Backups) Scheduled snapshots, and retention of ZFS datasets via sanoid. This allows for lightning-fast point in time recovery, and cloning, without needing to touch backups.</li> </ul> </li> <li>(Remote, On-Site Backups) Synology replication / backups. This- gives me locally hosted backups remote from the NAS. Useful if I do something, like accidentally delete the zfs dataset or pool. <ul> <li>(Remote, On-Site Backups) Scheduled synology immutable snapshots. I keep a few months worth of immutable snapshots for the share storing the backups. This- gives me the ability to do a point-in-time recovery as well.</li> </ul> </li> <li>(Replicated, Off-Site Backups) I use the Synology \"Hyper-Backup\" app to perform off-site replications to a few difference sources. These backups are encrypted, and are stored in various cloud-providers to ensure redundancy.<ul> <li>(Remote, Off-Site) My S3 provider also maintains immutable snapshots.</li> </ul> </li> <li>(Replicated, Off-Site Backups) An encrypted copy is replicated to a friends house, where we swap space for backups.</li> <li>(and #6) (Manual, Secured) Every few months, for my most critical, irreplaceable shares, I also take a copy of the data, and store to both a 3.5\" HDD, and a stack of Blue Ray Disks. The data gets both compressed, and encrypted, and is stored inside of a solid safe which is rated against fire, and other attacks. In the event the safe is compromised, the data obtained is useless, with the encryption keys. I have also considered taking the stack of Blue Ray disks, and keeping in a safety deposit box at a bank as well.</li> </ol>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#kubernetes","title":"Kubernetes","text":"<p>Since, a large portion of my workloads are ran in Kubernetes clusters- its important to have solid backups here.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#kubernetes-manifestsworkloadsdata-via-veeamkasten-k10-to-minio","title":"Kubernetes - Manifests/Workloads/Data Via Veeam/Kasten K10 to minio","text":"<p>While, many people seem to prefer Velero.io, I have personally found Veeam/Kasten K10 to be my favorite option. </p> <p>For a short summary- It handles backups, recovery, and DR for my entire kubernetes cluster. It keeps point in time copies of all manifests, and configurations, and captures disk images. </p> <p>It does also do immutable, encrypted backups, and it can effortlessly migrate applications to other clusters, clone entire applications, and perform rewrites of manifests when restoring. (For example- changing the storage class). You can also use kanister scripts to do operations such as... application-consistent backups. </p> <p>Lastly- it does have a DR recovery option, where you can essentially recover the entire cluster from scratch, including your data. (Not- the VMs, or OS itself, just the stuff running inside of your cluster.)</p> <p>That being said- I am a fan. </p> <p>K10 Stores its encrypted backups to my minio cluster described above. </p> <p>Here is its dashboard.</p> <p></p> <p>In addition, all of the manifests for the workloads are also stored in a local gitea server, which is subject to Proxmox VM level backups / retention.</p> <p>The local git repo is also always up to date on one of my linux VMs where I run kubectl, and manage my cluster via the CLI. Also- subject to Proxmox VM level backups / retention.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#kubernetes-etcd-snapshots-and-master-state","title":"Kubernetes - etcd snapshots and master state","text":"<p>The final level of backups for my kubernetes environment- is the master node(s), and etcd. </p> <p>The master nodes themselves, are backed up by Proxmox backup server, in one of the above sections, along with the VM which runs Rancher.</p> <p>Rancher, takes etcd snapshots of my cluster's state, multiple times per day, and stores these snapshots both locally, and via minio.</p> <p>This- gives the ability to do a single-click restore of the state of my cluster.</p> <p>Here are the restore options:</p> <p></p> <p>Here- is browsing through local backups- and the ability to restore any at a point in time.</p> <p></p> <p>And, of course, it can restore the immutable copies uploaded to my S3/minio server too.</p> <p></p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#desktop-pcs-files","title":"Desktop PCs / Files","text":"<p>For backup up important files on my desktop- I use the Synology Drive app, to automatically replicate the data to my local synology unit.</p> <p>From there- as usual, it is subject to immutable snapshots, and the same snapshot/replication/backup policies as everything else.</p> <p>The only downside- if you have the need to backup a hidden folder, aka, something in your <code>%appdata%</code> folder, the synology drive client, really sucks at this.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#why-not-full-disk-backups","title":"Why not full disk backups?","text":"<p>95% of the storage on my gaming PC, is worthless. I can re-download windows, and my license is stored within my Microsoft account.</p> <p>I can re-download and reinstall the programs. Any programs I use frequently, or have a complex configuration- Gets backed up elsewhere.</p> <p>I have over 2 terabytes of games on steam, which can be easily redownloaded, and as such, there is no reason for me to back them up locally. (Especially, when I can download them from steam just as fast as I can restore them from my synology.)</p> <p>As such, I only backup the data that is important to me, and is NOT easily replaced, or redownloaded.</p> <p>Also- windows itself, accumulates crap overtime, and generally works better with a fresh install every 2-5 years.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#why-go-through-all-of-this-effort","title":"Why go through all of this effort?","text":"<p>Do- you want to know the honest answer? When I see all of the green checkboxes next to my successful backups, and then I admire the deduplication ratios- It makes me quite happy.</p> <p>Most of the data I backup, isn't exactly valuable, it would just be time-consuming to replace. </p> <p>The exception though- is irreparable things like photos and documents.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#how-do-i-handle-irreparable-things","title":"How do I handle irreparable things?","text":"<p>With lots of backups, of course!</p> <p>Using my photos as an example- I have decades worth of photos. They aren't replaceable once lost.</p> <p>They are subject to the same backup strategy as my \"Important\" file shares, as copied from above.</p> <ol> <li>(Redundancy) ZFS Striped-Mirrors. Will tolerate two failed disks before data-failure<ul> <li>(Local Backups) Scheduled snapshots, and retention of ZFS datasets via sanoid. This allows for lightning-fast point in time recovery, and cloning, without needing to touch backups.</li> </ul> </li> <li>(Remote, On-Site Backups) Synology replication / backups. This- gives me locally hosted backups remote from the NAS. Useful if I do something, like accidentally delete the zfs dataset or pool. <ul> <li>(Remote, On-Site Backups) Scheduled synology immutable snapshots. I keep a few months worth of immutable snapshots for the share storing the backups. This- gives me the ability to do a point-in-time recovery as well.</li> </ul> </li> <li>(Replicated, Off-Site Backups) I use the Synology \"Hyper-Backup\" app to perform off-site replications to a few difference sources. These backups are encrypted, and are stored in various cloud-providers to ensure redundancy.<ul> <li>(Remote, Off-Site) My S3 provider also maintains immutable snapshots.</li> </ul> </li> <li>(Replicated, Off-Site Backups) An encrypted copy is replicated to a friends house, where we swap space for backups.<ul> <li>Going to assume, he also keeps backups of this. But, never asked, nor bothered.</li> </ul> </li> <li>(and #6) (Manual, Secured) Every few months, for my most critical, irreplaceable shares, I also take a copy of the data, and store to both a 3.5\" HDD, and a stack of Blue Ray Disks. The data gets both compressed, and encrypted, and is stored inside of a solid safe which is rated against fire, and other attacks. In the event the safe is compromised, the data obtained is useless, with the encryption keys. I have also considered taking the stack of Blue Ray disks, and keeping in a safety deposit box at a bank as well.</li> </ol> <p>What wasn't listed above- These are also replicated to my phone (subject to local storage, retention policies), and also replicated to two OTHER major cloud providers (Google, and Amazon), leading to a total of 8 copies of this data. </p> <p>So- off the bat- we have 6 different, PHYSICAL copies of this data, ignoring that four of the copies also has snapshots.</p> <p>Backup #1 protects me against <code>rm -rf /my/data</code>, and SOME administrative failures    - If you <code>zfs destroy -r YourPool/YourDataset</code> for example- That data, and all of its snapshots are Gone. This is why snapshots is not considered backups.</p> <p>Backup #2 protects me against complete array / server failure, Or, deleting the ZFS dataset recursively. This, also protects against ransomware, and viruses which manages to NOT spread to the synology.    - But, it may not protect against Viruses / Malware / Attackers which have penetrated my home network.    - It will also not protect against physical location loss. Aka, Tornado, Fire, Flood.</p> <p>Backup #3 protects me against attacks to the synology, as well as failure of the synology.    - It also protects against physical location failure (Tornado, Fire, Flood... I get all of these in the mid-west)   - It \"SHOULD\" protect against attackers who manage to acquire the logon credentials to said cloud provider as you need my encryption key to touch or manage the backups. This- is not written or saved anywhere.</p> <p>Backup #4 Provides many of the same benefits as backup #3, but, as I have basically no permissions on the friend's NAS, other then to be able to replicate my data using a private key, this can potentially protect the data against determined attackers. As well- the VPN tunnel we have setup between us, only allows the replication traffic. Nothing else. No UI access. Nothing.</p> <p>Backup #5, Allows access to my saved data in the event the safe survives, and my hardware is destroyed. It also, works without needing internet access. (Backup #4 does this too- but, requires a long drive).</p> <p>And- finally...</p> <p>Backup #6, Protects against a very specific attack. Mass EMP.   - While, I am not paranoid about EMPs dropping- I still remain prepared for many different scenarios.   - Spinning HDDs, and SSDs can easily be wiped with a EMP pulse. And- A large EMP pulse can occur from other scenarios then nuclear weapons being detonated in the air...   - For example- A massive solar storm, can generate significant EMP activity. While, unlikely, this is a threat nonetheless.   - Finally- EMP pulses are actually quite common. Just- not powerful enough to do any actual damage. Flicking a light switch on for example, cases a very small EMP.</p> <p>Likely, my strategy is overkill... and completely over the top. But- Any data worth having, is worth protecting, and I REALLY enjoy watching my backups work like a well-oiled machine.</p> <p>The main scenarios I am actually worried about- are covered.</p> <ol> <li>Loss of property / devastation. Covered my multiple levels of offsite backups.</li> <li>Malware / Ransomware / Attacker. Should be covered by offsite replicated backups. Offline backups does cover this.</li> <li>Nuclear War / MAD - At this point, the value of the data drastically decreases. But- I will still have the physical, offline blue ray disks of my backups to enjoy for the few weeks before radiation poisoning kills me. </li> </ol>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/backup-strategies/#how-should-you-do-your-backups","title":"How should YOU do YOUR backups?","text":"<p>My answer to that is simple- Only you can decide.</p> <p>If you have a raspberry pi, running pihole, and homarr, you prob don't need to worry about backups.</p> <p>If you have a nice little server cluster, on-site VM backups might be nice to have.</p> <p>If you are storing data that is not replaceable with significant value, financial impact, or historical meaning, You might want to consider adopting a multi-tiered strategy such as mine with multiple on-site backups, multiple-cloud backups, and offline/cold backups.</p>","tags":["Homelab","Proxmox","Storage","Backups"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/","title":"Proxmox - Howto: Restore PVE Host Configuration","text":"<p>So, literally ONE DAY after writing My backup strategies post, I encountered a need to completely reinstall proxmox.</p> <p>As it turns out, there is not a documented, nor official restore process. After some trial and error, I did manage to completely restore my host, with no loss in configuration.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#what-happened","title":"What happened?","text":"<p>So- here I was minding my own business, and all of a sudden- my entire network goes Kaboom. </p> <p>Kubernetes is down, DNS is down, Home Assistant is down... and, very little was working correctly.</p> <p>After running my trusty PingInfoView, which I have configured with the IP addresses of my infrastructure- I noticed my r730XD was completely offline.</p> <p>After accessing it with iDrac, and opening the remote console- I discovered... It was unable to boot. Its boot NVMe was officially shot.</p> <p>After opening one of my other proxmox nodes by IP, I also discovered, well. basically everything was offline, as my ceph cluster had become unavailable.</p> <p>The reasoning for this- Apparently I did not have enough MONs to create a quorum, and when the host went down, ceph went down with it.</p> <p>That- was its own fun to correct- but, that isn't the purpose of this post. This post, is about reinstalling a proxmox server, and just having it come back online magically, without losing any configuration.</p> <p>Info</p> <p>This article ASSUMEs you have a cluster with at least one other healthy machine.</p> <p>If not, this post is not for you.</p> <p>Per my post on backups, I do not do full image level backups for these hosts, as you can reinstall them, and just reconfigure them.</p> <p>But, I do, do configuration backups of /etc/pve, as this drive holds the cluster state.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#how-to-restore-the-host","title":"How to restore the host","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#first-reinstall-proxmox","title":"First- Reinstall Proxmox.","text":"<ol> <li>Reinstall proxmox on the host.</li> </ol> <p>Make sure to set the hostname and network the same as it was before.</p> <ol> <li>Update / Prepare the new OS</li> </ol> <p>At this point, I also ran the tteck Post Install Script to update the repos, disable enterprise repos, disable nag, etc.</p> <p>And- I did a full <code>apt-get update &amp;&amp; apt-get dist-upgrade</code> to get everything installed, and updated.</p> <p>Next- I logged into this machines GUI, directly by IP, and clicked on ceph, and told it to install the ceph packages for the version the rest of my cluster is using.</p> <p>After the packages installed- I clocked out without completing the configuration.</p> <p>Next, I ran my ansible-playbook to update the SSH keys, kernel power savings mode, apply IPMI scripts, install common packages and tools I use, and do basic machine configuration. These- steps don't impact proxmox.</p> <p>At this point- you should have a fully functional stand-alone host. Now- we start the \"fun\" part.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#restoring-the-configuration","title":"Restoring the configuration","text":"<p>Danger</p> <p>These steps ARE completely unsupported, and may break your entire cluster!!!</p> <p>I came up with these steps through my own process of trial and error.</p> <p>This may not work for you. This may break your cluster and cause data loss.</p> <p>Enter at your OWN risk. </p> <p>I do not take any responsibility for any losses or damages which may occur from you following my unofficial 3rd party documentation.</p> <p>With- the warning out of the way- I will say- I was able to completely recover my cluster.</p> <p>This entire guide assumes you are running as root.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-1-prepare-remote-access-to-a-working-machine","title":"Step 1. Prepare remote access to a working machine.","text":"<p>The first thing we need to do, is establish PKI between the new server, and one of the existing nodes.</p> <p>Get the public key for your new server. <code>cat ~/.ssh/id_rsa.pub</code></p> <p>If, for some reason, the above file does not exist, then create one. <code>ssh-keygen</code>, and then copy the public key from the above command.</p> <p>Visit one of your working servers, as root, <code>nano ~/.ssh/authorized_keys</code>, and paste the public key in on a new line.</p> <p>Go back to the new machine, we need to add the old machine to our hosts file, just to make this slightly faster/easier. Although, if you wish, you can do all of the rsync commands using the IP as well.</p> <p>But- <code>nano /etc/hosts</code>, and add a line. <code>10.1.2.3    kube01</code> Save, and you are done.</p> <p>After those two steps- this command should automatically establish a ssh session with the other server.</p> <p><code>ssh root@oldmachine</code></p> <pre><code>root@kube02:/var/lib/ceph# ssh root@kube01\nLinux kube01 #1 SMP PREEMPT_DYNAMIC PMX 6.8.4-2 (2024-04-10T17:36Z) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Wed Jun 12 18:35:22 2024 from\nroot@kube01:~#\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-2-completely-stop-proxmox","title":"Step 2. COMPLETELY stop Proxmox","text":"<p>Goto the new host, the one which we are installing. We need to stop ALL proxmox related services.</p> <pre><code>systemctl stop pve-cluster\nsystemctl stop pvedaemon\nsystemctl stop pveproxy\nsystemctl stop pvestatd\nsystemctl stop corosync\nsystemctl stop pve-ha-lrm\nsystemctl stop pve-ha-crm\nsystemctl stop pve-firewall\nsystemctl stop pvescheduler\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-3-prepare-etcpve","title":"Step 3. Prepare /etc/pve","text":"<p>The <code>/etc/pve</code> directly will automatically be synced from your other cluster nodes once corosync and pve-cluster are running.</p> <p>We are going to move it elsewhere, and prepare the directory.</p> <pre><code># Move the pve directory somewhere else.\nmv /etc/pve ~/pve_backup\n\n# Create a new PVE directory\nmkdir /etc/pve\n\nchown root:root /etc/pve\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-4-corosync","title":"Step 4. Corosync","text":"<p>To get corosync running, we are just going to copy and paste from another host.</p> <pre><code># Update this to match the name of the source server, which is a cluster member that is currently running.\nSOURCE=your-old-server\n\n# Copy over corosync configuration\nscp root@$SOURCE:/etc/corosync/corosync.conf /etc/corosync/corosync.conf\nscp root@$SOURCE:/etc/corosync/authkey /etc/corosync/authkey\n\n# Set permissions and ownership.\nchown root:root /etc/corosync/corosync.conf\nchown root:root /etc/corosync/authkey\nchmod 600 /etc/corosync/authkey\n\n# Start corosync.\nsystemctl start corosync\n\n# Watch journalctl output, to ensure its working. Once it looks happy, CTRL+C\njournalctl -fe\n</code></pre> <p>This, is all of the configuration we need for corosync to work. If, corosync fails, you will need to identify and correct the issue. <code>journalctl -fe</code> is a good place to start.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-5-pve-cluster","title":"Step 5. PVE-Cluster","text":"<p>At this point, you should have the corosync service running. We need to start on pve-cluster.</p> <p>Start the service.</p> <pre><code>systemctl start pve-cluster\n</code></pre> <p>But, you will notice- it throws an error when querying the status.</p> <pre><code>root@kube02:/etc# pvecm status\nError: Corosync config '/etc/pve/corosync.conf' does not exist - is this node part of a cluster?\n</code></pre> <p>To fix this, we just need to copy the corosync file. Note- this step has to be done here. </p> <pre><code>cp /etc/corosync/corosync.conf /etc/pve/\n</code></pre> <p>Here is my output from this process. <pre><code>root@kube02:/etc# pvecm status\nError: Corosync config '/etc/pve/corosync.conf' does not exist - is this node part of a cluster?\nroot@kube02:/etc# cp /etc/corosync/corosync.conf /etc/pve/\nroot@kube02:/etc# pvecm status\nCluster information\n-------------------\nName:             Cluster0\nConfig Version:   11\nTransport:        knet\nSecure auth:      on\n\nQuorum information\n------------------\nDate:             Wed Jun 12 18:12:08 2024\nQuorum provider:  corosync_votequorum\nNodes:            5\nNode ID:          0x00000004\nRing ID:          1.9e1\nQuorate:          Yes\n\nVotequorum information\n----------------------\nExpected votes:   5\nHighest expected: 5\nTotal votes:      5\nQuorum:           3\nFlags:            Quorate\n\nMembership information\n----------------------\n    Nodeid      Votes Name\n0x00000001          1 10.100.4.106\n0x00000002          1 10.100.4.100\n0x00000003          1 10.100.4.105\n0x00000004          1 10.100.4.102 (local)\n0x00000005          1 10.100.4.104\n</code></pre></p> <p>Info</p> <p>The corosync.conf needs to be copied to <code>/etc/pve</code> AFTER we start the pve-cluster service.</p> <p>If you did this before starting pve-cluster, you would receive errors regarding the /etc/pve directly not being empty (as it mounts a cluster file system there.)</p> <p>If- you did make that mistake- just start over at step 2.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-6-reboot","title":"Step 6. Reboot","text":"<p>Reboot the host, and wait for it to come online.</p> <p>After the host comes online- It should be acting like a cluster member now, and should be visible in your cluster's standard interface.</p> <p>But- there a few more steps you may need to perform....</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-7-reimport-zfs-pools","title":"Step 7. Reimport ZFS Pools","text":"<p>If, you have ZFS pools, you may need to re-import them.</p> <p>You also may notice errors in your <code>journalctl -fe</code> output.</p> <pre><code>Jun 12 18:27:29 kube02 pvestatd[3033]: storage 'NOYB' is not online\nJun 12 18:27:29 kube02 pvestatd[3033]: zfs error: cannot open 'GameStorage': no such pool\nJun 12 18:27:30 kube02 pvestatd[3033]: zfs error: cannot open 'GameStorage': no such pool\nJun 12 18:27:30 kube02 pvestatd[3033]: could not activate storage 'GameStorage', zfs error: The pool can be imported, use 'zpool import -f' to import the pool.\nJun 12 18:27:30 kube02 pvestatd[3033]: storage 'ISOs' is not online\nJun 12 18:27:42 kube02 pvestatd[3033]: storage 'NOYB' is not online\nJun 12 18:27:42 kube02 pvestatd[3033]: zfs error: cannot open 'GameStorage': no such pool\nJun 12 18:27:42 kube02 pvestatd[3033]: zfs error: cannot open 'GameStorage': no such pool\nJun 12 18:27:42 kube02 pvestatd[3033]: could not activate storage 'GameStorage', zfs error: The pool can be imported, use 'zpool import -f' to import the pool.\n</code></pre> <p>The fix is simple enough, and is even provided in the log output: <code>zpool import YourPoolName -f</code></p> <pre><code>root@kube02:/var/lib/ceph# zpool import GameStorage\ncannot import 'GameStorage': pool was previously in use from another system.\nLast accessed by kube02 (hostid=7060dad4) at Sun Jun  9 00:24:41 2024\nThe pool can be imported, use 'zpool import -f' to import the pool.\nroot@kube02:/var/lib/ceph# zpool import GameStorage -f\nroot@kube02:/var/lib/ceph# zpool status\n  pool: GameStorage\n state: ONLINE\n  scan: scrub repaired 0B in 00:00:40 with 0 errors on Sun Jun  9 00:24:41 2024\nconfig:\n\n        NAME                                            STATE     READ WRITE CKSUM\n        GameStorage                                     ONLINE       0     0     0\n          nvme-Samsung_SSD_970_EVO_1TB_S5H9NS0NA99060M  ONLINE       0     0     0\n</code></pre> <p>At this point, you might also want to kick off a scrub. (My storage was very rudely shutdown when the boot drive died...)</p> <p>To do so, just type <code>zpool scrub YourPoolName</code></p> <p>It will continue running in the background with no additional attention needed.</p> <pre><code>root@kube02:/var/lib/ceph# zpool status\n  pool: GameStorage\n state: ONLINE\n  scan: scrub in progress since Wed Jun 12 21:02:55 2024\n        41.7G / 41.7G scanned, 6.44G / 41.7G issued at 549M/s\n        0B repaired, 15.44% done, 00:01:05 to go\nconfig:\n\n        NAME                                            STATE     READ WRITE CKSUM\n        GameStorage                                     ONLINE       0     0     0\n          nvme-Samsung_SSD_970_EVO_1TB_S5H9NS0NA99060M  ONLINE       0     0     0\n\n#And, eventually, it will finish\nroot@kube02:/var/lib/ceph# zpool status\n  pool: GameStorage\n state: ONLINE\n  scan: scrub repaired 0B in 00:01:37 with 0 errors on Wed Jun 12 21:04:32 2024\nconfig:\n\n        NAME                                            STATE     READ WRITE CKSUM\n        GameStorage                                     ONLINE       0     0     0\n          nvme-Samsung_SSD_970_EVO_1TB_S5H9NS0NA99060M  ONLINE       0     0     0\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-8-reimport-ceph-osds","title":"Step 8. Reimport Ceph OSDs","text":"<p>Info</p> <p>This step assumes, you have a \"somewhat\" healthy ceph cluster at this point, and are just needing to reimport your existing OSDs.</p> <p>If, you don't have functional monitors, and managers, you need to correct that first.</p> <p>Since, I am running ceph, my OSDs are currently not running. We need to correct this.</p> <p>Info</p> <p>This step can be used anytime you move a ceph OSD from one host to another, without rebuilding the OSD.</p> <p>So- the first step- just make sure your ceph volumes are still there. They shouldn't be mounted at this point, as we are on a pretty fresh install still.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#gathering-information","title":"Gathering information","text":"<p>You, don't really NEED any information from this step- It just details on how to find and view the information.</p> <p>If, you are sure your OSDs are on the host, and just aren't running, skip to the next step.</p> <pre><code>root@kube02:/var/lib/ceph# lsblk\nNAME                                                                                                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda                                                                                                     8:0    0  14.6T  0 disk\n\u2514\u2500sda1                                                                                                  8:1    0  14.6T  0 part\nsdb                                                                                                     8:16   0   7.3T  0 disk\n\u2514\u2500sdb1                                                                                                  8:17   0   7.3T  0 part\nsdc                                                                                                     8:32   0   7.3T  0 disk\n\u2514\u2500sdc1                                                                                                  8:33   0   7.3T  0 part\nsdd                                                                                                     8:48   0  14.6T  0 disk\n\u2514\u2500sdd1                                                                                                  8:49   0  14.6T  0 part\nsde                                                                                                     8:64   0   7.3T  0 disk\n\u2514\u2500sde1                                                                                                  8:65   0   7.3T  0 part\nsdf                                                                                                     8:80   0   7.3T  0 disk\n\u2514\u2500sdf1                                                                                                  8:81   0   7.3T  0 part\nsdg                                                                                                     8:96   0  14.6T  0 disk\n\u2514\u2500sdg1                                                                                                  8:97   0  14.6T  0 part\nsdh                                                                                                     8:112  0   7.3T  0 disk\n\u2514\u2500sdh1                                                                                                  8:113  0   7.3T  0 part\nsdi                                                                                                     8:128  0  14.6T  0 disk\n\u2514\u2500sdi1                                                                                                  8:129  0  14.6T  0 part\nsdj                                                                                                     8:144  1   7.5G  0 disk\n\u2514\u2500sdj1                                                                                                  8:145  1   7.5G  0 part\nsdk                                                                                                     8:160  1  29.9G  0 disk\n\u2514\u2500sdk1                                                                                                  8:161  1  29.9G  0 part\nnvme0n1                                                                                               259:0    0 894.3G  0 disk\n\u251c\u2500nvme0n1p1                                                                                           259:1    0  1007K  0 part\n\u251c\u2500nvme0n1p2                                                                                           259:2    0     1G  0 part /boot/efi\n\u2514\u2500nvme0n1p3                                                                                           259:3    0 893.3G  0 part\n  \u251c\u2500pve-swap                                                                                          252:3    0     8G  0 lvm  [SWAP]\n  \u251c\u2500pve-root                                                                                          252:4    0    96G  0 lvm  /\n  \u251c\u2500pve-data_tmeta                                                                                    252:6    0   7.7G  0 lvm\n  \u2502 \u2514\u2500pve-data                                                                                        252:8    0 757.8G  0 lvm\n  \u2514\u2500pve-data_tdata                                                                                    252:7    0 757.8G  0 lvm\n    \u2514\u2500pve-data                                                                                        252:8    0 757.8G  0 lvm\nnvme6n1                                                                                               259:4    0 894.3G  0 disk\n\u2514\u2500ceph--126d8000--5cdd--4ced--ab77--38893cd88dc8-osd--block--6db92940--fc38--4b0b--9fb4--4c5ac6742921 252:5    0 894.3G  0 lvm\nnvme5n1                                                                                               259:5    0 894.3G  0 disk\n\u2514\u2500ceph--8e2310de--b5ed--46bd--a32e--5048af46cfe0-osd--block--e06ae6d2--d881--40a0--adcd--2c55020474d5 252:2    0 894.3G  0 lvm\nnvme7n1                                                                                               259:6    0 894.3G  0 disk\n\u2514\u2500ceph--3f428911--5213--461d--a5fd--029f673d7ad2-osd--block--e65f3c81--23de--4f81--af2b--be185f6fef42 252:1    0 894.3G  0 lvm\nnvme8n1                                                                                               259:7    0 894.3G  0 disk\n\u2514\u2500ceph--25d71cae--e648--4a95--ae1f--c45f8fa547d7-osd--block--ae41fc24--8408--4656--8310--58e00a2a146b 252:0    0 894.3G  0 lvm\nnvme2n1                                                                                               259:8    0 931.5G  0 disk\n\u251c\u2500nvme2n1p1                                                                                           259:9    0 931.5G  0 part\n\u2514\u2500nvme2n1p9                                                                                           259:10   0     8M  0 part\nnvme1n1                                                                                               259:11   0 931.5G  0 disk\n\u2514\u2500nvme1n1p1                                                                                           259:12   0 931.5G  0 part\nnvme4n1                                                                                               259:13   0 931.5G  0 disk\n\u2514\u2500nvme4n1p1                                                                                           259:15   0 931.5G  0 part\nnvme3n1                                                                                               259:14   0 931.5G  0 disk\n\u2514\u2500nvme3n1p1  \n</code></pre> <p>And- as we can see- they are here, nvme6 through nvme8.</p> <p>A few commands to gather and show information-</p> <p>In the status, we can see multiple OSDs are down, in this part: <code>1 host (4 osds) down</code></p> <pre><code>root@kube02:/var/lib/ceph# ceph status\n  cluster:\n    id:     016d27bb-5e11-4c85-846a-98f1f0b7ec08\n    health: HEALTH_WARN\n            1 osds down\n            1 host (4 osds) down\n            Degraded data redundancy: 593570/1780710 objects degraded (33.333%), 78 pgs degraded, 129 pgs undersized\n\n  services:\n    mon: 2 daemons, quorum kube05,kube01 (age 16m)\n    mgr: kube05(active, since 2h), standbys: kube01\n    mds: 1/1 daemons up, 1 standby\n    osd: 13 osds: 9 up (since 15m), 10 in (since 3m)\n\n  data:\n    volumes: 1/1 healthy\n    pools:   5 pools, 129 pgs\n    objects: 593.57k objects, 1.3 TiB\n    usage:   2.5 TiB used, 8.8 TiB / 11 TiB avail\n    pgs:     593570/1780710 objects degraded (33.333%)\n             78 active+undersized+degraded\n             51 active+undersized\n\n  io:\n    client:   3.5 MiB/s rd, 1.6 MiB/s wr, 540 op/s rd, 192 op/s wr\n</code></pre> <p>Next- we check the lvms. You should see all of your missing OSDs here.</p> <pre><code>root@kube02:/var/lib/ceph# ceph-volume lvm list\n\n\n====== osd.3 =======\n\n  [block]       /dev/ceph-3f428911-5213-461d-a5fd-029f673d7ad2/osd-block-e65f3c81-23de-4f81-af2b-be185f6fef42\n\n      block device              /dev/ceph-3f428911-5213-461d-a5fd-029f673d7ad2/osd-block-e65f3c81-23de-4f81-af2b-be185f6fef42\n      block uuid                qYPoy2-fQ4B-GeCy-yO4J-9KgO-tVfb-KT3Qeq\n      cephx lockbox secret\n      cluster fsid              016d27bb-5e11-4c85-846a-98f1f0b7ec08\n      cluster name              ceph\n      crush device class\n      encrypted                 0\n      osd fsid                  e65f3c81-23de-4f81-af2b-be185f6fef42\n      osd id                    3\n      osdspec affinity\n      type                      block\n      vdo                       0\n      devices                   /dev/nvme7n1\n\n====== osd.5 =======\n\n  [block]       /dev/ceph-8e2310de-b5ed-46bd-a32e-5048af46cfe0/osd-block-e06ae6d2-d881-40a0-adcd-2c55020474d5\n\n      block device              /dev/ceph-8e2310de-b5ed-46bd-a32e-5048af46cfe0/osd-block-e06ae6d2-d881-40a0-adcd-2c55020474d5\n      block uuid                20e763-MU1H-9Yem-Qtru-R99T-tULs-V0QZhf\n      cephx lockbox secret\n      cluster fsid              016d27bb-5e11-4c85-846a-98f1f0b7ec08\n      cluster name              ceph\n      crush device class\n      encrypted                 0\n      osd fsid                  e06ae6d2-d881-40a0-adcd-2c55020474d5\n      osd id                    5\n      osdspec affinity\n      type                      block\n      vdo                       0\n      devices                   /dev/nvme5n1\n\n====== osd.6 =======\n\n  [block]       /dev/ceph-126d8000-5cdd-4ced-ab77-38893cd88dc8/osd-block-6db92940-fc38-4b0b-9fb4-4c5ac6742921\n\n      block device              /dev/ceph-126d8000-5cdd-4ced-ab77-38893cd88dc8/osd-block-6db92940-fc38-4b0b-9fb4-4c5ac6742921\n      block uuid                qLe3KP-d5we-EENg-SlkG-KDuc-Ri3f-xivchq\n      cephx lockbox secret\n      cluster fsid              016d27bb-5e11-4c85-846a-98f1f0b7ec08\n      cluster name              ceph\n      crush device class\n      encrypted                 0\n      osd fsid                  6db92940-fc38-4b0b-9fb4-4c5ac6742921\n      osd id                    6\n      osdspec affinity\n      type                      block\n      vdo                       0\n      devices                   /dev/nvme6n1\n\n====== osd.7 =======\n\n  [block]       /dev/ceph-25d71cae-e648-4a95-ae1f-c45f8fa547d7/osd-block-ae41fc24-8408-4656-8310-58e00a2a146b\n\n      block device              /dev/ceph-25d71cae-e648-4a95-ae1f-c45f8fa547d7/osd-block-ae41fc24-8408-4656-8310-58e00a2a146b\n      block uuid                bodGoC-XlhL-1TxK-x6K9-QqnF-h3LT-TRYkHy\n      cephx lockbox secret\n      cluster fsid              016d27bb-5e11-4c85-846a-98f1f0b7ec08\n      cluster name              ceph\n      crush device class\n      encrypted                 0\n      osd fsid                  ae41fc24-8408-4656-8310-58e00a2a146b\n      osd id                    7\n      osdspec affinity\n      type                      block\n      vdo                       0\n      devices                   /dev/nvme8n1\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#re-import-the-lvms","title":"Re-import the LVMs!","text":"<p>So- you might assume you need to manually rebuild systemd units, update configurations for proxmox, ceph, and do funky ceph commands.... But- that is not the case.</p> <p>Just enter this command: <code>ceph-volume lvm activate --all</code></p> <p>Thats it!</p> <p>Ceph will automatically re-mount the LVMs, create links, set ownership, create systemd unit files, and... basically handle nearly everything for you.</p> <pre><code>root@kube02:/var/lib/ceph# ceph-volume lvm activate --all\n--&gt; Activating OSD ID 6 FSID 6db92940-fc38-4b0b-9fb4-4c5ac6742921\nRunning command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-6\n--&gt; Executable selinuxenabled not in PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-6\nRunning command: /usr/bin/ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/ceph-126d8000-5cdd-4ced-ab77-38893cd88dc8/osd-block-6db92940-fc38-4b0b-9fb4-4c5ac6742921 --path /var/lib/ceph/osd/ceph-6 --no-mon-config\nRunning command: /usr/bin/ln -snf /dev/ceph-126d8000-5cdd-4ced-ab77-38893cd88dc8/osd-block-6db92940-fc38-4b0b-9fb4-4c5ac6742921 /var/lib/ceph/osd/ceph-6/block\nRunning command: /usr/bin/chown -h ceph:ceph /var/lib/ceph/osd/ceph-6/block\nRunning command: /usr/bin/chown -R ceph:ceph /dev/dm-5\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-6\nRunning command: /usr/bin/systemctl enable ceph-volume@lvm-6-6db92940-fc38-4b0b-9fb4-4c5ac6742921\n stderr: Created symlink /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-6-6db92940-fc38-4b0b-9fb4-4c5ac6742921.service \u2192 /lib/systemd/system/ceph-volume@.service.\nRunning command: /usr/bin/systemctl enable --runtime ceph-osd@6\n stderr: Created symlink /run/systemd/system/ceph-osd.target.wants/ceph-osd@6.service \u2192 /lib/systemd/system/ceph-osd@.service.\nRunning command: /usr/bin/systemctl start ceph-osd@6\n--&gt; ceph-volume lvm activate successful for osd ID: 6\n--&gt; Activating OSD ID 7 FSID ae41fc24-8408-4656-8310-58e00a2a146b\nRunning command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-7\n--&gt; Executable selinuxenabled not in PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-7\nRunning command: /usr/bin/ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/ceph-25d71cae-e648-4a95-ae1f-c45f8fa547d7/osd-block-ae41fc24-8408-4656-8310-58e00a2a146b --path /var/lib/ceph/osd/ceph-7 --no-mon-config\nRunning command: /usr/bin/ln -snf /dev/ceph-25d71cae-e648-4a95-ae1f-c45f8fa547d7/osd-block-ae41fc24-8408-4656-8310-58e00a2a146b /var/lib/ceph/osd/ceph-7/block\nRunning command: /usr/bin/chown -h ceph:ceph /var/lib/ceph/osd/ceph-7/block\nRunning command: /usr/bin/chown -R ceph:ceph /dev/dm-0\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-7\nRunning command: /usr/bin/systemctl enable ceph-volume@lvm-7-ae41fc24-8408-4656-8310-58e00a2a146b\n stderr: Created symlink /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-7-ae41fc24-8408-4656-8310-58e00a2a146b.service \u2192 /lib/systemd/system/ceph-volume@.service.\nRunning command: /usr/bin/systemctl enable --runtime ceph-osd@7\n stderr: Created symlink /run/systemd/system/ceph-osd.target.wants/ceph-osd@7.service \u2192 /lib/systemd/system/ceph-osd@.service.\nRunning command: /usr/bin/systemctl start ceph-osd@7\n--&gt; ceph-volume lvm activate successful for osd ID: 7\n--&gt; Activating OSD ID 3 FSID e65f3c81-23de-4f81-af2b-be185f6fef42\nRunning command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-3\n--&gt; Executable selinuxenabled not in PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-3\nRunning command: /usr/bin/ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/ceph-3f428911-5213-461d-a5fd-029f673d7ad2/osd-block-e65f3c81-23de-4f81-af2b-be185f6fef42 --path /var/lib/ceph/osd/ceph-3 --no-mon-config\nRunning command: /usr/bin/ln -snf /dev/ceph-3f428911-5213-461d-a5fd-029f673d7ad2/osd-block-e65f3c81-23de-4f81-af2b-be185f6fef42 /var/lib/ceph/osd/ceph-3/block\nRunning command: /usr/bin/chown -h ceph:ceph /var/lib/ceph/osd/ceph-3/block\nRunning command: /usr/bin/chown -R ceph:ceph /dev/dm-1\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-3\nRunning command: /usr/bin/systemctl enable ceph-volume@lvm-3-e65f3c81-23de-4f81-af2b-be185f6fef42\n stderr: Created symlink /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-3-e65f3c81-23de-4f81-af2b-be185f6fef42.service \u2192 /lib/systemd/system/ceph-volume@.service.\nRunning command: /usr/bin/systemctl enable --runtime ceph-osd@3\n stderr: Created symlink /run/systemd/system/ceph-osd.target.wants/ceph-osd@3.service \u2192 /lib/systemd/system/ceph-osd@.service.\nRunning command: /usr/bin/systemctl start ceph-osd@3\n--&gt; ceph-volume lvm activate successful for osd ID: 3\n--&gt; Activating OSD ID 5 FSID e06ae6d2-d881-40a0-adcd-2c55020474d5\nRunning command: /usr/bin/mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-5\n--&gt; Executable selinuxenabled not in PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-5\nRunning command: /usr/bin/ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/ceph-8e2310de-b5ed-46bd-a32e-5048af46cfe0/osd-block-e06ae6d2-d881-40a0-adcd-2c55020474d5 --path /var/lib/ceph/osd/ceph-5 --no-mon-config\nRunning command: /usr/bin/ln -snf /dev/ceph-8e2310de-b5ed-46bd-a32e-5048af46cfe0/osd-block-e06ae6d2-d881-40a0-adcd-2c55020474d5 /var/lib/ceph/osd/ceph-5/block\nRunning command: /usr/bin/chown -h ceph:ceph /var/lib/ceph/osd/ceph-5/block\nRunning command: /usr/bin/chown -R ceph:ceph /dev/dm-2\nRunning command: /usr/bin/chown -R ceph:ceph /var/lib/ceph/osd/ceph-5\nRunning command: /usr/bin/systemctl enable ceph-volume@lvm-5-e06ae6d2-d881-40a0-adcd-2c55020474d5\n stderr: Created symlink /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-5-e06ae6d2-d881-40a0-adcd-2c55020474d5.service \u2192 /lib/systemd/system/ceph-volume@.service.\nRunning command: /usr/bin/systemctl enable --runtime ceph-osd@5\n stderr: Created symlink /run/systemd/system/ceph-osd.target.wants/ceph-osd@5.service \u2192 /lib/systemd/system/ceph-osd@.service.\nRunning command: /usr/bin/systemctl start ceph-osd@5\n</code></pre> <p>Next, lets check the status of our OSDs using <code>ceph osd tree</code></p> <pre><code>root@kube02:~# ceph osd tree\nID  CLASS  WEIGHT    TYPE NAME        STATUS  REWEIGHT  PRI-AFF\n-1         14.84685  root default\n-5          5.24072      host kube01\n 4    ssd   0.87328          osd.4        up   1.00000  1.00000\n 9    ssd   0.87328          osd.9        up   1.00000  1.00000\n11    ssd   1.74709          osd.11       up   1.00000  1.00000\n12    ssd   1.74709          osd.12       up   1.00000  1.00000\n-7          3.49310      host kube02\n 3    ssd   0.87328          osd.3      down   1.00000  1.00000\n 5    ssd   0.87328          osd.5      down   1.00000  1.00000\n 6    ssd   0.87328          osd.6      down   1.00000  1.00000\n 7    ssd   0.87328          osd.7      down   1.00000  1.00000\n-3          6.11302      host kube05\n 0    ssd   0.87328          osd.0        up   1.00000  1.00000\n 1    ssd   0.87328          osd.1        up   1.00000  1.00000\n 2    ssd   0.87328          osd.2        up   1.00000  1.00000\n 8    ssd   1.74660          osd.8        up   1.00000  1.00000\n10    ssd   1.74660          osd.10       up   1.00000  1.00000\n</code></pre> <p>Oh, that is no good. They are still down. Lets fix that.</p> <p>First- mark sure they are marked as up. (Use the number from the ID column in <code>ceph osd tree</code>)</p> <pre><code>root@kube02:~# ceph osd in 3\nmarked in osd.3.\nroot@kube02:~# ceph osd in 5\nmarked in osd.5.\nroot@kube02:~# ceph osd in 6\nmarked in osd.6.\nroot@kube02:~# ceph osd in 7\nmarked in osd.7.\n</code></pre> <p>Next- try to start one.</p> <pre><code>root@kube02:~# systemctl start ceph-osd@3\nJob for ceph-osd@3.service failed because the control process exited with error code.\nSee \"systemctl status ceph-osd@3.service\" and \"journalctl -xeu ceph-osd@3.service\" for details.\n</code></pre> <p>Oops. That isn't good. Lets find out why.</p> <pre><code>root@kube02:~# journalctl -xeu ceph-osd@3.service\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 A start job for unit ceph-osd@3.service has finished successfully.\n\u2591\u2591\n\u2591\u2591 The job identifier is 8416.\nJun 12 21:16:12 kube02 ceph-osd[199292]: 2024-06-12T21:16:12.807-0500 7042e2cc56c0 -1 unable to find any IPv4 address in networks '10.100.6.105/24' interfaces ''\nJun 12 21:16:12 kube02 ceph-osd[199292]: 2024-06-12T21:16:12.807-0500 7042e2cc56c0 -1 Failed to pick cluster address.\nJun 12 21:16:12 kube02 systemd[1]: ceph-osd@3.service: Main process exited, code=exited, status=1/FAILURE\n\u2591\u2591 Subject: Unit process exited\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 An ExecStart= process belonging to unit ceph-osd@3.service has exited.\n\u2591\u2591\n\u2591\u2591 The process' exit code is 'exited' and its exit status is 1.\nJun 12 21:16:12 kube02 systemd[1]: ceph-osd@3.service: Failed with result 'exit-code'.\n\u2591\u2591 Subject: Unit failed\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 The unit ceph-osd@3.service has entered the 'failed' state with result 'exit-code'.\nJun 12 21:16:23 kube02 systemd[1]: ceph-osd@3.service: Scheduled restart job, restart counter is at 4.\n\u2591\u2591 Subject: Automatic restarting of a unit has been scheduled\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 Automatic restarting of the unit ceph-osd@3.service has been scheduled, as the result for\n\u2591\u2591 the configured Restart= setting for the unit.\nJun 12 21:16:23 kube02 systemd[1]: Stopped ceph-osd@3.service - Ceph object storage daemon osd.3.\n\u2591\u2591 Subject: A stop job for unit ceph-osd@3.service has finished\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 A stop job for unit ceph-osd@3.service has finished.\n\u2591\u2591\n\u2591\u2591 The job identifier is 8927 and the job result is done.\nJun 12 21:16:23 kube02 systemd[1]: ceph-osd@3.service: Start request repeated too quickly.\nJun 12 21:16:23 kube02 systemd[1]: ceph-osd@3.service: Failed with result 'exit-code'.\n\u2591\u2591 Subject: Unit failed\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 The unit ceph-osd@3.service has entered the 'failed' state with result 'exit-code'.\nJun 12 21:16:23 kube02 systemd[1]: Failed to start ceph-osd@3.service - Ceph object storage daemon osd.3.\n\u2591\u2591 Subject: A start job for unit ceph-osd@3.service has failed\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 A start job for unit ceph-osd@3.service has finished with a failure.\n\u2591\u2591\n\u2591\u2591 The job identifier is 8927 and the job result is failed.\nJun 12 21:19:27 kube02 systemd[1]: ceph-osd@3.service: Start request repeated too quickly.\nJun 12 21:19:27 kube02 systemd[1]: ceph-osd@3.service: Failed with result 'exit-code'.\n\u2591\u2591 Subject: Unit failed\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 The unit ceph-osd@3.service has entered the 'failed' state with result 'exit-code'.\nJun 12 21:19:27 kube02 systemd[1]: Failed to start ceph-osd@3.service - Ceph object storage daemon osd.3.\n\u2591\u2591 Subject: A start job for unit ceph-osd@3.service has failed\n\u2591\u2591 Defined-By: systemd\n\u2591\u2591 Support: https://www.debian.org/support\n\u2591\u2591\n\u2591\u2591 A start job for unit ceph-osd@3.service has finished with a failure.\n\u2591\u2591\n\u2591\u2591 The job identifier is 9281 and the job result is failed.\n</code></pre> <p>Near the top of the output, you may have noticed this line: <code>unable to find any IPv4 address in networks '10.100.6.0/24' interfaces</code></p> <p>I have a dedicated non-routed layer 2 network specifically for ceph-traffic. It would seem, I need to go re-add that interface.</p> <pre><code>nano /etc/network/interfaces\n\n## Make your changes to the networking file\n\n## And- then, reload networking\nsystemctl reload networking.service\n</code></pre> <p>If- after a few seconds, your bash prompt re-appears, its going to be a good day.</p> <p>If not, and you messed up your networking configuration- your day just got a little bit longer.</p> <p>In my case, I copied the networking file from one of my other hosts, as it has special bridge-vids, and settings for SDN (software defined networking). I updated the IP addresses, and network adapters, BUT, I forgot to update the vlan-raw-device under my vlan configuration. </p> <pre><code>auto lo\niface lo inet loopback\n\nauto eno1\n#ConnectX-3 10G\n\niface eno1 inet manual\n        mtu 1500\n\nauto vmbr0\niface vmbr0 inet static\n        address 10.100.4.102/24\n        gateway 10.100.4.1\n        bridge-ports eno1\n        bridge-stp off\n        bridge-fd 0\n        bridge-vlan-aware yes\n        bridge-vids 2-15 100 4040\n\nauto vlan6\niface vlan6 inet static\n        address 10.100.6.102/24\n        vlan-raw-device eno1      # &lt;------ I forgot to update this\n#V_STORAGE\nsource /etc/network/interfaces.d/*\n</code></pre> <p>At this point, lets go check our OSDs...</p> <pre><code>root@kube02:~# ceph osd tree\nID  CLASS  WEIGHT    TYPE NAME        STATUS  REWEIGHT  PRI-AFF\n-1         14.84685  root default\n-5          5.24072      host kube01\n 4    ssd   0.87328          osd.4        up   1.00000  1.00000\n 9    ssd   0.87328          osd.9        up   1.00000  1.00000\n11    ssd   1.74709          osd.11       up   1.00000  1.00000\n12    ssd   1.74709          osd.12       up   1.00000  1.00000\n-7          3.49310      host kube02\n 3    ssd   0.87328          osd.3      down   1.00000  1.00000\n 5    ssd   0.87328          osd.5      down   1.00000  1.00000\n 6    ssd   0.87328          osd.6      down   1.00000  1.00000\n 7    ssd   0.87328          osd.7      down   1.00000  1.00000\n-3          6.11302      host kube05\n 0    ssd   0.87328          osd.0        up   1.00000  1.00000\n 1    ssd   0.87328          osd.1        up   1.00000  1.00000\n 2    ssd   0.87328          osd.2        up   1.00000  1.00000\n 8    ssd   1.74660          osd.8        up   1.00000  1.00000\n10    ssd   1.74660          osd.10       up   1.00000  1.00000\n</code></pre> <p>Still down. Lets reset them, and try again.</p> <pre><code>root@kube02:~# systemctl reset-failed ceph-osd@3.service\nroot@kube02:~# systemctl reset-failed ceph-osd@5.service\nroot@kube02:~# systemctl reset-failed ceph-osd@6.service\nroot@kube02:~# systemctl reset-failed ceph-osd@7.service\nroot@kube02:~# systemctl start ceph-osd@3.service\nroot@kube02:~# systemctl start ceph-osd@5.service\nroot@kube02:~# systemctl start ceph-osd@6.service\nroot@kube02:~# systemctl start ceph-osd@7.service\n</code></pre> <p><code>ceph osd tree</code> won't update instantly. </p> <p>We can, check <code>journalctl -fe</code> for errors.</p> <pre><code>root@kube02:~# journalctl -fe\n...\nJun 12 21:30:12 kube02 systemd[1]: Starting ceph-osd@5.service - Ceph object storage daemon osd.5...\nJun 12 21:30:13 kube02 systemd[1]: Started ceph-osd@5.service - Ceph object storage daemon osd.5.\nJun 12 21:30:13 kube02 systemd[1]: Starting ceph-osd@6.service - Ceph object storage daemon osd.6...\nJun 12 21:30:15 kube02 systemd[1]: Started ceph-osd@6.service - Ceph object storage daemon osd.6.\nJun 12 21:30:16 kube02 systemd[1]: Starting ceph-osd@7.service - Ceph object storage daemon osd.7...\nJun 12 21:30:17 kube02 systemd[1]: Started ceph-osd@7.service - Ceph object storage daemon osd.7.\n...\n</code></pre> <p>No errors, should be all good.</p> <pre><code># After a few moments... we had one OSD up.\nroot@kube02:~# ceph osd tree\nID  CLASS  WEIGHT    TYPE NAME        STATUS  REWEIGHT  PRI-AFF\n-1         14.84685  root default\n-5          5.24072      host kube01\n 4    ssd   0.87328          osd.4        up   1.00000  1.00000\n 9    ssd   0.87328          osd.9        up   1.00000  1.00000\n11    ssd   1.74709          osd.11       up   1.00000  1.00000\n12    ssd   1.74709          osd.12       up   1.00000  1.00000\n-7          3.49310      host kube02\n 3    ssd   0.87328          osd.3      down         0  1.00000\n 5    ssd   0.87328          osd.5      down         0  1.00000\n 6    ssd   0.87328          osd.6      down         0  1.00000\n 7    ssd   0.87328          osd.7        up   1.00000  1.00000\n-3          6.11302      host kube05\n 0    ssd   0.87328          osd.0        up   1.00000  1.00000\n 1    ssd   0.87328          osd.1        up   1.00000  1.00000\n 2    ssd   0.87328          osd.2        up   1.00000  1.00000\n 8    ssd   1.74660          osd.8        up   1.00000  1.00000\n10    ssd   1.74660          osd.10       up   1.00000  1.00000\n\n## And- after a couple of minutes, everything was up.\nroot@kube02:~# ceph osd tree\nID  CLASS  WEIGHT    TYPE NAME        STATUS  REWEIGHT  PRI-AFF\n-1         14.84685  root default\n-5          5.24072      host kube01\n 4    ssd   0.87328          osd.4        up   1.00000  1.00000\n 9    ssd   0.87328          osd.9        up   1.00000  1.00000\n11    ssd   1.74709          osd.11       up   1.00000  1.00000\n12    ssd   1.74709          osd.12       up   1.00000  1.00000\n-7          3.49310      host kube02\n 3    ssd   0.87328          osd.3        up   1.00000  1.00000\n 5    ssd   0.87328          osd.5        up   1.00000  1.00000\n 6    ssd   0.87328          osd.6        up   1.00000  1.00000\n 7    ssd   0.87328          osd.7        up   1.00000  1.00000\n-3          6.11302      host kube05\n 0    ssd   0.87328          osd.0        up   1.00000  1.00000\n 1    ssd   0.87328          osd.1        up   1.00000  1.00000\n 2    ssd   0.87328          osd.2        up   1.00000  1.00000\n 8    ssd   1.74660          osd.8        up   1.00000  1.00000\n10    ssd   1.74660          osd.10       up   1.00000  1.00000\n</code></pre> <p>At this point, check <code>ceph status</code> If you want to watch the output as it heals up, you can use <code>ceph status -w</code> to watch the output.</p> <pre><code>root@kube02:~# ceph status -w\n  cluster:\n    id:     016d27bb-5e11-4c85-846a-98f1f0b7ec08\n    health: HEALTH_WARN\n            Degraded data redundancy: 288792/1798224 objects degraded (16.060%), 61 pgs degraded, 42 pgs undersized\n\n  services:\n    mon: 2 daemons, quorum kube05,kube01 (age 3h)\n    mgr: kube05(active, since 5h), standbys: kube01\n    mds: 1/1 daemons up, 1 standby\n    osd: 13 osds: 13 up (since 61s), 13 in (since 61s); 61 remapped pgs\n\n  data:\n    volumes: 1/1 healthy\n    pools:   5 pools, 129 pgs\n    objects: 599.41k objects, 1.3 TiB\n    usage:   3.8 TiB used, 11 TiB / 15 TiB avail\n    pgs:     288792/1798224 objects degraded (16.060%)\n             68 active+clean\n             39 active+undersized+degraded+remapped+backfill_wait\n             20 active+recovery_wait+undersized+degraded+remapped\n             2  active+recovering+undersized+degraded+remapped\n\n  io:\n    client:   328 KiB/s rd, 1.9 MiB/s wr, 83 op/s rd, 154 op/s wr\n    recovery: 21 MiB/s, 59 objects/s\n\n\n2024-06-12T21:33:54.022362-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 288765/1798227 objects degraded (16.058%), 61 pgs degraded, 61 pgs undersized (PG_DEGRADED)\n2024-06-12T21:33:59.025195-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 288407/1798227 objects degraded (16.038%), 60 pgs degraded, 60 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:04.030359-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 288263/1798227 objects degraded (16.030%), 60 pgs degraded, 60 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:09.033479-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 287886/1798227 objects degraded (16.009%), 60 pgs degraded, 60 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:14.037276-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 287654/1798230 objects degraded (15.997%), 59 pgs degraded, 59 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:19.040047-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 287336/1798230 objects degraded (15.979%), 59 pgs degraded, 59 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:24.043003-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 287029/1798251 objects degraded (15.962%), 58 pgs degraded, 58 pgs undersized (PG_DEGRADED)\n2024-06-12T21:34:29.047180-0500 mon.kube05 [WRN] Health check update: Degraded data redundancy: 286728/1798263 objects degraded (15.945%), 58 pgs degraded, 58 pgs undersized (PG_DEGRADED)\n</code></pre> <p>The important thing to look for in this output- is the services section.</p> <p>Make sure you have mons up, and quorum is established.</p> <p>Make sure you a mgr up.</p> <p>And, make sure all of your osds are up.</p> <p>Otherwise, ceph will scan the OSDs, make changes as needed, and self-heal.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-9-re-import-sdn","title":"Step 9. Re-import SDN","text":"<p>If, you use Proxmox's SDN Features, there is a good chance this will not be applied to your node currently.</p> <p>To correct this, you can do one of two things.</p> <ol> <li>Make a change in your SDN configuration, which will cause the new install to receive the update.</li> <li>OR, run this command: <code>pvesh set /nodes/$(hostname)/network</code></li> </ol> <pre><code>root@kube02:~# pvesh set /nodes/$(hostname)/network\ninfo: executing /usr/bin/dpkg -l ifupdown2\nUPID:kube02:0003BA42:00137BD5:666A5E7A:srvreload:networking:root@pam:\n</code></pre> <p>Afterwards, all of your SDN configurations will be reapplied.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#step-10-regenerate-certs-and-remove-old-ssh-keys","title":"Step 10. Regenerate certs, and remove old ssh keys","text":"<p>While- mostly everything is currently functional, if you attempt to open the console one of your VMs, you may noticed this:</p> <pre><code>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the ECDSA key sent by the remote host is\nSHA256:fxUoUrMalniKJQXOdrO0m9YAf03OXaa0gwQLaU0uwKA.\nPlease contact your system administrator.\nAdd correct host key in /root/.ssh/known_hosts to get rid of this message.\nOffending RSA key in /etc/ssh/ssh_known_hosts:2\n  remove with:\n  ssh-keygen -f \"/etc/ssh/ssh_known_hosts\" -R \"10.100.4.102\"\nHost key for 10.100.4.102 has changed and you have requested strict checking.\nHost key verification failed.\n</code></pre> <p>To fix this, we just need to re-generate the keys.</p> <p>Warning</p> <p>Do NOT run <code>ssh-keygen -f</code>! </p> <p>It is a symlink to <code>ssh_known_hosts -&gt; /etc/pve/priv/known_hosts</code></p> <p><code>ssh-keygen</code> will break this, and it will not be automatically synced and updated.</p> <p>Proxmox links the ssh_known_hosts file back to its cluster file system, and all hosts \"share\" the same file.</p> <p>BUG: https://bugzilla.proxmox.com/show_bug.cgi?id=4252</p> <p>On the new host, run <code>pvecm updatecerts</code></p> <p>Documentation: https://pve.proxmox.com/pve-docs/pvecm.1.html</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#ansible-task-to-re-link-symlinks","title":"Ansible task to re-link symlinks","text":"<p>Here is my ansible task, which corrects issues with symlinks</p> <pre><code>---\n- name: Check if symbolic link exists\n  stat:\n    path: /etc/ssh/ssh_known_hosts\n  register: ssh_known_hosts_stat\n\n- name: Remove existing file if it's not a symbolic link\n  file:\n    path: /etc/ssh/ssh_known_hosts\n    state: absent\n  when: ssh_known_hosts_stat.stat.islnk == false\n\n- name: Link /etc/ssh/ssh_known_hosts\n  file:\n    src:  /etc/pve/priv/known_hosts\n    dest: /etc/ssh/ssh_known_hosts\n    state: link\n</code></pre> <p>After completing this step- the errors will go away.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---reinstall-host-without-losing-cluster-configuration/#summary","title":"Summary","text":"<p>If- you are going through this process- hopefully the above documentation should save you a lot of time.</p> <p>It personally took me two or three hours to get this node fully back online and functional, as these steps, aren't really documented anywhere I could find.</p> <p>A few random links which were less then helpful...</p> <ul> <li>https://forum.proxmox.com/threads/backup-pve-host-and-restore-to-new-disk.129839/<ul> <li>Nothing of use in here</li> </ul> </li> <li>https://www.reddit.com/r/Proxmox/comments/105jqwp/backing_up_proxmox_host/<ul> <li>nothing of use in here either.</li> </ul> </li> <li>https://forum.proxmox.com/threads/backup-restore-procedure-for-proxmox-ve-host.118264/</li> <li>https://forum.proxmox.com/threads/how-to-restore-pve-host.139585/<ul> <li>had a few good pointers</li> </ul> </li> <li>https://pve.proxmox.com/wiki/Proxmox_Cluster_File_System_(pmxcfs)#_recovery<ul> <li>useless</li> </ul> </li> <li>https://pbs.proxmox.com/docs/backup-client.html#creating-backups<ul> <li>Also, useless. (There is no documentation on how to restore a host from PBS either!)</li> </ul> </li> </ul> <p>So- on that note, enjoy the first actual documentation (that I could find) on how to successfully reinstall a failed cluster node, and re-importing its configuration.</p> <p>I will note, this also validates that my backup strategy of backing up the <code>/etc/pve</code> directory from a single host, is adequate for doing a cluster recovery, if needed.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/","title":"Proxmox - Setup Debian Cloud-Init Templates","text":"<p>This post documents the steps needed to create a minified debian cloud image template, which you can easily clone, and have a running VM in seconds with no configuration needed.</p> <p>This includes common packages, ssh-keys, IP information.</p> <p>The end result of this project is...</p> <ol> <li>You clone a template, and start it.</li> <li>The cloned VM automatically starts up, updates itself, and starts running, with common packages installed, and your ssh details pre-configured.</li> <li>A slimmed down distribution, without excess (My end result was a 400M image.)</li> <li>No need to edit the VM after cloning, other then adding CPU/RAM, or other hardware as needed.</li> </ol>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#verbiage-documentation","title":"Verbiage / Documentation","text":"<p>Cloud-Init is a technology which allows you to clone a template, with customized user-settings. This is how you can spin up VMs in AWS in seconds.</p> <p>Debian Cloud Images</p> <p>These, are special images provided, which includes support for cloud-init. For this example, we will specifically be leveraging the \"genericcloud\" image, which is suitable for our VMs.</p> <p>This- image does not include many bare metal hardware drivers, which aren't needed, since the focus of this post is creating a VM template.</p> <p>Proxmox Templates / Clones Documentation is here, if you wish to learn more.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#getting-started","title":"Getting Started","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-1-acquire-cloud-image","title":"Step 1. Acquire Cloud Image","text":"<p>From Debian Official Cloud Images, we want to select the Bookworm/Latest folder at the bottom of the page.</p> <p></p> <p>Inside of this folder, is quite a few different files. </p> <p>We SPECIFICALLY want, the \"genericcloud\"-\"amd64\".qcow2 image. Its name is \"debian-12-genericcloud-amd64.qcow2\"</p> <p></p> <p>Warning</p> <p>While- the above link DOES link to the image- I don't recommend blindly copying and pasting links from the internet.</p> <p>We will now want to store this image on one of our proxmox nodes, in a temporary location.</p> <pre><code>root@kube01:~/template# wget https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-amd64.qcow2\n...\n2024-07-02 09:41:06 (15.7 MB/s) - \u2018debian-12-genericcloud-amd64.qcow2\u2019 saved [343378944/343378944]\n\nroot@kube01:~/template# ls -al\ntotal 335344\ndrwxr-xr-x  2 root root      4096 Jul  2 09:40 .\ndrwx------ 10 root root      4096 Jul  2 09:40 ..\n-rw-r--r--  1 root root 343378944 Jul  1 13:27 debian-12-genericcloud-amd64.qcow2\n</code></pre> <p>Keep this terminal open, we will come back to it in a bit.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-2-customize-image","title":"Step 2. Customize Image","text":"<p>At this point, we have a cloud init image. However, I personally like to customize my images, to install a few basic tools, as well as the qemu-guest-agent.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#install-packages-into-the-base-image","title":"Install packages into the base image","text":"<p>You will need to install the <code>libguestfs-tools</code> package, via your package manager. If you don't wish to install the tools on your proxmox machine, feel free to customize the image on your desktop, a LXC, VM, etc.</p> <pre><code>root@kube01:~/template# sudo apt-get install libguestfs-tools\n</code></pre> <p>Next- we can leverage virt-customize to customize our image.</p> <p>I personally, install these utilities on most of my machines, so, I will include them into this template.</p> <ul> <li>curl</li> <li>wget</li> <li>nano</li> <li>rsync</li> <li>htop</li> </ul> <p>At an absolute minimum though, we need to add the <code>qemu-guest-agent</code></p> <p>Place the packages names you would like, into the virt-customize command.</p> <pre><code>root@kube01:~/template# virt-customize -a debian-12-genericcloud-amd64.qcow2 --install qemu-guest-agent,curl,wget,nano,rsync,htop\n[   0.0] Examining the guest ...\n[   8.8] Setting a random seed\nvirt-customize: warning: random seed could not be set for this type of\nguest\n[   8.9] Setting the machine ID in /etc/machine-id\n[   8.9] Installing packages: qemu-guest-agent curl wget nano rsync htop\n[  18.4] Finishing off\n</code></pre> <p>Info</p> <p>Please read the Documentation for virt-customize. There is far more functionality then just adding packages.</p> <p>I personally, rely on ansible to do the final provisioning, as such, I am only installing the bare minimum software.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#optional-fix-dhcp-issue","title":"(Optional) Fix DHCP Issue","text":"<p>By default, the cloud images uses the hostname as the DHCP identifier. This- works fine.... when it doesn't send the default template name for every cloned image.</p> <p>A simple fix, is to just update the logic to use the hardware / mac address.</p> <pre><code>root@kube01:~/cloud-init# virt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"sed -i 's|send host-name = gethostname();|send dhcp-client-identifier = hardware;|' /etc/dhcp/dhclient.conf\"\n[   0.0] Examining the guest ...\n[   2.3] Setting a random seed\nvirt-customize: warning: random seed could not be set for this type of\nguest\n[   2.3] Setting the machine ID in /etc/machine-id\n[   2.3] Running: sed -i 's|send host-name = gethostname();|send dhcp-client-identifier = hardware;|' /etc/dhcp/dhclient.conf\n[   2.4] Finishing off\n</code></pre> <p>Want to learn more about this issue?</p> <ul> <li>https://github.com/Telmate/terraform-provider-proxmox/issues/481</li> <li>https://forum.proxmox.com/threads/cloud-init-registering-dns-with-template-name.106726/</li> </ul> <p>For me- setting the dhcp-identifier to use the MAC address, works extremely well, as proxmox gives each clone a randomly generated MAC address when cloning.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#reset-machine-id","title":"Reset machine-id","text":"<p>One more step- we need to add a step to reset the machine-id. If this step is left out, machines will each acquire the same IP address when using DHCP (Regardless if your MAC is different)</p> <pre><code>virt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"echo -n &gt; /etc/machine-id\"\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#optional-compress-and-shrink-the-image","title":"(Optional) Compress and shrink the image","text":"<p>We can also use qemu-img to compress, and shrink the final image.</p> <pre><code>root@kube01:~/template# qemu-img convert -O qcow2 -c -o preallocation=off debian-12-genericcloud-amd64.qcow2 debian-12-genericcloud-amd64-shrink.qcow2\nroot@kube01:~/template# qemu-img info debian-12-genericcloud-amd64-shrink.qcow2\nimage: debian-12-genericcloud-amd64-shrink.qcow2\nfile format: qcow2\nvirtual size: 16 GiB (17179869184 bytes)\ndisk size: 421 MiB\ncluster_size: 65536\nFormat specific information:\n    compat: 1.1\n    compression type: zlib\n    lazy refcounts: false\n    refcount bits: 16\n    corrupt: false\n    extended l2: false\nChild node '/file':\n    filename: debian-12-genericcloud-amd64-shrink.qcow2\n    protocol type: file\n    file length: 422 MiB (442643456 bytes)\n    disk size: 421 MiB\n</code></pre> <p>This- saved around 200M, which is pretty impressive when you consider the file was only 600M originally.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#commands-used","title":"Commands used","text":"<p>Full commands used: <pre><code># Install tools to manage images\napt-get install libguestfs-tools\n# Install packages\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --install qemu-guest-agent,curl,wget,nano,rsync,htop\n# Set DHCP-Identifier to use hardware address instead of hostname.\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"sed -i 's|send host-name = gethostname();|send dhcp-client-identifier = hardware;|' /etc/dhcp/dhclient.conf\"\n# Reset Machine-ID\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"echo -n &gt; /etc/machine-id\"\n# Compress the image\nqemu-img convert -O qcow2 -c -o preallocation=off debian-12-genericcloud-amd64.qcow2 debian-12-genericcloud-amd64-shrink.qcow2\n</code></pre></p> <p>At this point, we should have a suitable base image.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-3-create-a-vm","title":"Step 3. Create a VM","text":"<p>Now that we have a suitable image, we need to build a base VM template. I will be doing this step through the GUI.</p> <p></p> <p>For the general tab, give a name which implies this is a template.</p> <p>I also have a template source pool, and tag I assigned. But, this is optional.</p> <p>Finally- I set a shutdown timeout of 5 minutes. This- is also optional.</p> <p></p> <p>For the OS Tab- click \"don't use any media\". No other changes are needed here.</p> <p></p> <p>On the system tab, I enabled the checkbox for Qemu-Agent.</p> <p></p> <p>On the disks tab, you will want to REMOVE the default disks. We will add disks later.</p> <p></p> <p>For CPU / Memory tab- just set whatever defaults you want.</p> <p>I chose 2 CPU cores, x86-64-v2-AES on the type as its easily compatible with all of my nodes.</p> <p>For memory, I allocated 1024G of ram, and disabled ballooning. Remember- we will clone this template for creating VMs, and adjust the CPU/RAM there.</p> <p>For network, I chose my default vlan interface, where I typically create new nodes. I did select firewall.</p> <p></p> <p>On the confirm tab- don't select start after created.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-4-attach-qcow2-image-to-vm","title":"Step 4. Attach qcow2 image to VM","text":"<p>Next, we will attach the .qcow2 image we downloaded earlier. </p> <p>Skip back into the terminal / ssh session from the first step.</p> <p>Grab the ID from the VM we just created. Alternatively, you can find it via the CLI of the host you created it on.</p> <pre><code>root@kube01:~/template# qm list\n      VMID NAME                 STATUS     MEM(MB)    BOOTDISK(GB) PID\n       139 DebianCloudInitTemplate stopped    1024               0.00 0\n</code></pre> <p>Next, attach it, using <code>qm importdisk $VM_ID $IMAGEPATH $YOUR_STORAGE</code></p> <p>I want to store my template on my ceph-cluster, which is named <code>ceph-block</code></p> <pre><code>root@kube01:~/template# qm importdisk 139 debian-12-genericcloud-amd64.qcow2 ceph-block\nimporting disk 'debian-12-genericcloud-amd64.qcow2' to VM 139 ...\ntransferred 0.0 B of 16.0 GiB (0.00%)\ntransferred 20.7 MiB of 16.0 GiB (1.01%)\n...\ntransferred 2.0 GiB of 16.0 GiB (99.60%)\ntransferred 2.0 GiB of 16.0 GiB (100.00%)\nSuccessfully imported disk as 'unused0:ceph-block:vm-139-disk-0'\nroot@kube01:~/template#\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-6-template-tweaks","title":"Step 6. Template Tweaks","text":"<p>Lets go back to the VM in the GUI now.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#hardware-tab","title":"Hardware Tab","text":"<p>Remove the CD/DVD drive (Unless- you need one.)</p> <p>Attach the disk we created from the qcow2.</p> <ol> <li>Click on the unused disk, then click edit. Set Bus/Device to \"VirtIO Block\" as position 0</li> <li>I also like to set write back cache. However, this is optional.</li> <li>Click Add.</li> </ol> <p></p> <p>Next- Click Add -&gt; CloudInit Device</p> <p></p> <p>Select your storage. I leave IDE selected as the default bus.</p> <p></p> <p>Click Add.</p> <p>If, you plan on using UEFI, you can also add an EFI disk at this step.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#cloud-init-tab","title":"Cloud Init Tab","text":"<p>Now- we can customize the cloud init tab, with a default user, password (if desired), dns,ip, and ssh information.</p> <p>Since, I use ansible to provision, and prepare all of my machines- My cloudinit is specific to allow it to log in.</p> <p>Once it runs, it will automatically remove the temporary accounts, configure SSH, NTP, DNS, static IP options, etc.</p> <p>But- the key here is, for its initial login, it can log into VMs cloned from this template, using the username \"temp\" with ansible's public key.</p> <p>For the IP Config, I set dhcp as the default.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#options-tab","title":"Options Tab","text":"<p>Under options, there are a few things we will need to customize.</p> <p>First up- Boot order.</p> <p>I always uncheck network boot, since I don't use it. As well, make sure to unselect the cloudinit drive. </p> <p>We only want the primary disk, containing our cloned qcow2 selected here.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#script-containing-image-customizations","title":"Script containing image customizations","text":"<p>Here is the list of CLI commands used to download, and customize the image.</p> <pre><code># The ID of the Template/VM.\nVM_ID=139\n# Desired proxmox storage for the new image.\nSTORAGE=\"ceph-block\"\n\n# Download Image\nwget https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-amd64.qcow2\n# Install tools to manage images\napt-get install libguestfs-tools\n# Install packages\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --install qemu-guest-agent,curl,wget,nano,rsync,htop\n# Set the DHCP client identifier to use hardware address.\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"sed -i 's|send host-name = gethostname();|send dhcp-client-identifier = hardware;|' /etc/dhcp/dhclient.conf\"\n# Reset Machine-ID\nvirt-customize -a debian-12-genericcloud-amd64.qcow2 --run-command \"echo -n &gt; /etc/machine-id\"\n# Compress the image\nqemu-img convert -O qcow2 -c -o preallocation=off debian-12-genericcloud-amd64.qcow2 debian-12-genericcloud-amd64-shrink.qcow2\n# Import the image to our template.\nqm importdisk $VM_ID debian-12-genericcloud-amd64-shrink.qcow2 $STORAGE\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#final-touches","title":"Final touches?","text":"<p>I personally, like customizing a default set of sane firewall rules for my VMs. However- this is completely optional, and up to you.</p> <p>As a good example, I have a firewall rule defined at the data center level, for only allowing ssh access, for known, good hosts.</p> <p>Here- is my personal starting point for firewall rules.</p> <p></p> <p>If you do plan on including firewall rules, make sure to enable \"Firewall\" under Firewall -&gt; Options. It is not enabled by default.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#step-6-convert-to-template","title":"Step 6. Convert to template","text":"<p>This step is questionably optional, because you don't need to convert this to a template, in order to clone it.</p> <p>Info</p> <p>If you wish to use a linked-clone, you DO need to convert your VM to a template.</p> <p>Warning</p> <p>Without converting to a template, you will need to change the MAC address for every clone.</p> <p>(aka, you should make this a template, if you plan on cloning it)</p> <p>To convert this to a template- Right click on the VM, and select, Convert to template.</p> <p></p> <p>After you have converted it to a template, you will no longer be able to start/stop or snapshot this machine. You would need to clone it first, and then start the clone.</p> <p></p> <p>One final configuration item- Edit the network interface on your template. Ensure its MAC Address to <code>00:00:00:00:00:00</code> (This will cause a random MAC address to be generated for every new clone)</p> <p></p> <p>Warning</p> <p>If you miss this step- all of your cloned VMs will have the same MAC address.</p> <p>This, will likely cause a lot of problems. Make sure to do this step!</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#the-final-result","title":"The final result","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#clone","title":"Clone","text":"<p>Now- just clone the template, and voila- you will have a patched up debian machine ready for your workloads.</p> <p>Right click the template (or VM, if you didn't convert to a template), and select Clone.</p> <p></p> <p>Select a target node and a new name for your new VM.</p> <p>Next- the Mode dialog has a few options.</p> <p>Proxmox - Documentation for cloning</p> <p>The TLDR;</p> <p>IF you use a linked clone, your new VM only needs to store the \"changes\" from the base-template's image. These- can only be done to templates.</p> <p>A full clone, is exactly that. Its a full clone. You can full clone VMs or templates.</p> <p>Info</p> <p>If you don't have cluster-wide, reliable, shared storage for all of your nodes, I recommend using a full clone. </p> <p>The linked clone, MUST remain on the same storage as the original template.</p> <p>The cloned VMs REQUIRES the image from the template.</p> <p>Info</p> <p>Linked clones are implemented in the storage itself. So- you must have supported storage to use linked-clones.</p> <p>Per The Documentation</p> <p>Linked Clones works for theses storages: files in raw, qcow2, vmdk format (either on local storage or nfs); LVM-thin, ZFS, rbd, sheepdog, nexenta.</p> <p>It's not supported with LVM &amp; ISCSI storage.</p> <p>If- you try to delete the image used by a linked clone, you will get this:</p> <p></p> <p></p> <p>For this- I will be using a linked clone, as I leverage my Ceph Cluster for cluster-wide storage.</p> <p></p> <p>After you have performed your changes, click Clone.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#execute","title":"Execute","text":"<p>Once you start your VM, it will automatically start the process of downloading updates, and configuring itself.</p> <p></p> <p>And- lastly, you will be left, with a login prompt.</p> <p></p> <p>If- you followed through with the step to update the base-image, to add qemu-guest-agent, you will also be able to see IP details via the proxmox web interface.</p> <p></p> <p>Lastly- since we specified the username, and ssh-keys via the CloudInit, we can also log into this VM.</p> <pre><code>root@Ansible ~/Ansible# ssh temp@10.100.5.157\nLinux my-new-vm 6.1.0-22-cloud-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.94-1 (2024-06-21) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\n</code></pre> <p>And- all of our additional packages are installed.</p> <pre><code>temp@my-new-vm:~$ which htop\n/usr/bin/htop\ntemp@my-new-vm:~$ which nano\n/usr/bin/nano\ntemp@my-new-vm:~$ which curl\n/usr/bin/curl\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#other-notes","title":"Other Notes","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#ceph-editing-disks-after-converting-to-template","title":"Ceph- Editing disks after converting to template","text":"<p>If you edit the disks after converting them to a template. The new disks will not be properly flagged as \"base\".</p> <p>To fix this, convert your template back into a VM.</p> <pre><code>nano /etc/pve/qemu-server/139.conf\n\n#Set template=1, to template=0\n</code></pre> <p>Then, once your GUI reflects the changes, convert the VM back into a template again.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#patching-linked-clones-through-template","title":"Patching linked clones through template","text":"<p>If- you are thinking of creating a template, spinning up linked clones, and patching the base template- this method isn't ideal for doing that.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#ceph-space-usage-of-linked-clone-vs-full-clone","title":"Ceph - Space Usage of Linked Clone vs Full Clone","text":"<p>Looking at ceph- my base image is only using 1.3G of total disk space. </p> <p></p> <p>If- we look at a VM cloned using Full Clone- we can see, it is using 1.4G of disk space. The parent field is also empty (as it was a full copy)</p> <p></p> <p>Looking at a disk from a Linked clone, we can see, it is also using 1.3/1.4G of disk space, but, you can see the \"layering\" feature is enabled, and it has a parent specified.</p> <p></p> <p>Now- you might be saying- That doesn't sound right at all.</p> <p>And, I would agree. I would assume it is working as intended. But- I am out of time to determine how to find the actual child's usage over the parent.</p> <pre><code># Get base image children.\nroot@kube01:~# rbd children  ceph-block/base-139-disk-0\nceph-block/vm-141-disk-0\n# Get base image details\nroot@kube01:~# rbd info  ceph-block/base-139-disk-0\nrbd image 'base-139-disk-0':\n        size 16 GiB in 4096 objects\n        order 22 (4 MiB objects)\n        snapshot_count: 1\n        id: 773ac59ea6a2db\n        block_name_prefix: rbd_data.773ac59ea6a2db\n        format: 2\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features:\n        flags:\n        create_timestamp: Tue Jul  2 16:56:02 2024\n        access_timestamp: Tue Jul  2 17:00:41 2024\n        modify_timestamp: Tue Jul  2 16:56:02 2024\n# Get image details for the specific snapshot the child is using\nroot@kube01:~# rbd info ceph-block/base-139-disk-0@__base__\nrbd image 'base-139-disk-0':\n        size 16 GiB in 4096 objects\n        order 22 (4 MiB objects)\n        snapshot_count: 1\n        id: 773ac59ea6a2db\n        block_name_prefix: rbd_data.773ac59ea6a2db\n        format: 2\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features:\n        flags:\n        create_timestamp: Tue Jul  2 16:56:02 2024\n        access_timestamp: Tue Jul  2 17:00:41 2024\n        modify_timestamp: Tue Jul  2 16:56:02 2024\n        protected: True\n# Get child image details.\nroot@kube01:~# rbd info  ceph-block/vm-141-disk-0\nrbd image 'vm-141-disk-0':\n        size 16 GiB in 4096 objects\n        order 22 (4 MiB objects)\n        snapshot_count: 0\n        id: 7744398791b79f\n        block_name_prefix: rbd_data.7744398791b79f\n        format: 2\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features:\n        flags:\n        create_timestamp: Tue Jul  2 17:12:12 2024\n        access_timestamp: Tue Jul  2 17:12:12 2024\n        modify_timestamp: Tue Jul  2 17:12:12 2024\n        parent: ceph-block/base-139-disk-0@__base__\n        overlap: 16 GiB\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#how-to-add-disk-space-after-cloning","title":"How to add disk-space after cloning?","text":"<p>Easy- Add the disk space via proxmox. </p> <p>Then- you can take one of two paths.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#reboot-the-system","title":"Reboot the system","text":"<p>The debian cloud templates will automatically resize during boot.</p> <p>Just- add disk space, and reboot.</p> <pre><code>[    6.697063] EXT4-fs (vda1): resizing filesystem from 4161531 to 20938747 blocks\n[    6.813343] EXT4-fs (vda1): resized filesystem to 20938747\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#using-growpart-no-reboot-needed","title":"Using growpart- no reboot needed.","text":"<p>SSH into the VM, and run <code>growpart</code></p> <pre><code>temp@test:~$ lsblk\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsr0      11:0    1    4M  0 rom\nvda     254:0    0   32G  0 disk\n|-vda1  254:1    0 15.9G  0 part /\n|-vda14 254:14   0    3M  0 part\n`-vda15 254:15   0  124M  0 part /boot/efi\nroot@test:/home/temp# growpart /dev/vda 1\nCHANGED: partition=1 start=262144 old: size=33292255 end=33554398 new: size=66846687 end=67108830\nroot@test:/home/temp# lsblk\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsr0      11:0    1    4M  0 rom\nvda     254:0    0   32G  0 disk\n|-vda1  254:1    0 31.9G  0 part /\n|-vda14 254:14   0    3M  0 part\n`-vda15 254:15   0  124M  0 part /boot/efi\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---debian-cloud-init-templates/#help-all-of-my-machines-are-getting-the-same-ip-address-from-dhcp","title":"Help, all of my machines are getting the same IP address from DHCP.","text":"<p>Edit the hardware of your template. Set the Network Device's MAC address to <code>00:00:00:00:00:00</code></p> <p>New machines will receive a random mac address.</p> <p>(If- you missed the step above, and you have already cloned a dozen machines, you can \"clear\" the mac address field of the VMs NIC(s),  and a new address will be automatically configured.)</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/","title":"Detecting a weird packet loss issue.","text":"<p>So- I recently installed a Quad 100G Mikrotik CRS504-4XQ-IN Router into my lab recently and moved a few servers over to 100G NICs.</p> <p>Around the time I did this- I also started experiencing tons of random, hard to pinpoint instances of latency across my network.</p> <p>I validated flow-control was enabled for the network- and I checked various port counters to look for errors.</p> <p>This- issue took me around a week or two to finally pinpoint.... this post- is going through a bit of the steps taken.</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#the-symptoms","title":"The Symptoms","text":"<p>The symptoms- were rather unique.</p> <ul> <li>Web pages would pause for up to 10 seconds before loading.</li> <li>Some mobile apps (clash of clans) would randomly disconnect with connection issues.</li> <li>Random latency and disconnects occurring throughout my network. </li> <li>Very little detectable packet-loss. This- is key.</li> <li>The symptoms almost resembled what occurs when you have a STP loop causing a port to flap up and down.</li> </ul>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#starting-at-the-mikrotik","title":"Starting at the Mikrotik","text":"<pre><code>[admin@sw-100g] &gt; /interface print stats\nFlags: R - RUNNING; S - SLAVE\nColumns: NAME, RX-BYTE, TX-BYTE, RX-PACKET, TX-PACKET, RX-DROP, TX-DROP, TX-QUEUE-DROP, RX-ERROR, TX-ERROR\n #    NAME                  RX-BYTE            TX-BYTE      RX-PACKET      TX-PACKET  RX-DROP  TX-DROP  TX-QUEUE-DROP  RX-ERROR  TX-ERROR\n 0 R  ether1            201 163 444      3 040 455 588      2 264 797      2 543 603        0        0              1         0         0\n;;; Kube01: 100G\n 1 RS qsfp28-1-1  2 969 461 776 402  3 316 576 813 413  1 381 885 242  1 640 058 300                               26                    \n 2    qsfp28-1-2                  0                  0              0              0                                0                    \n 3    qsfp28-1-3                  0                  0              0              0                                0                    \n 4    qsfp28-1-4                  0                  0              0              0                                0                    \n;;; Kube02: 100G\n 5 RS qsfp28-2-1  2 740 746 241 766  3 137 569 536 280  1 741 858 272  1 520 825 302                                0                    \n 6    qsfp28-2-2                  0                  0              0              0                                0                    \n 7    qsfp28-2-3                  0                  0              0              0                                0                    \n 8    qsfp28-2-4                  0                  0              0              0                                0                    \n;;; Kube05: 100G\n 9 RS qsfp28-3-1  4 152 472 555 949  3 509 013 890 640  2 125 952 515  2 224 145 002                                0                    \n10    qsfp28-3-2                  0                  0              0              0                                0                    \n11    qsfp28-3-3                  0                  0              0              0                                0                    \n12    qsfp28-3-4                  0                  0              0              0                                0                    \n;;; Uplink: Core Switch Port 26\n13 RS qsfp28-4-1    128 030 532 966    173 290 502 219    122 095 521    150 966 404                              486                    \n14    qsfp28-4-2                  0                  0              0              0                                0                    \n15    qsfp28-4-3                  0                  0              0              0                                0                    \n16    qsfp28-4-4                  0                  0              0              0                                0                    \n17 R  bridge1                     0            541 473              0          3 139        0        0              0         0         0\n18 R  lo                  1 051 258          1 051 258          6 252          6 252        0        0              0         0         0\n;;; V_SERVER\n19 R  vlan4                       0            538 162              0          3 124        0        0              0         0         0\n</code></pre> <p>While there are a few TX drops on the uplink port going back to my Unifi USW-24-PRO core switch, 486 out of the millions of packets- isn't very concerning. Since, I updated all of the firmware for my switches, and routers yesterday- that is likely the cause of those drops.</p> <p>Having- had lots of issues with STP / RSTP in the past- I decided to check the logs for flapping interfaces.</p> <pre><code>[admin@sw-100g] &gt; /interface print stats\n 07-10 06:42:50 bridge,stp qsfp28-4-1:0 learning\n 07-10 06:42:50 bridge,stp qsfp28-4-1:0 forwarding\n 07-10 06:42:50 bridge,stp qsfp28-4-1:0 TCHANGE start\n 07-10 06:42:50 bridge,info hardware offloading activated on bridge \"bridge1\" ports: qsfp28-4-1,qsfp28-3-1,qsfp28-1-1,qsfp28-2-1\n 07-10 06:42:53 bridge,stp qsfp28-4-1:0 TCHANGE over\n 07-10 06:42:53 bridge,stp qsfp28-3-1:0 learning\n 07-10 06:42:53 bridge,stp qsfp28-3-1:0 forwarding\n 07-10 06:42:53 bridge,stp qsfp28-1-1:0 learning\n 07-10 06:42:53 bridge,stp qsfp28-1-1:0 forwarding\n 07-10 06:42:53 bridge,stp qsfp28-2-1:0 learning\n 07-10 06:42:53 bridge,stp qsfp28-2-1:0 forwarding\n 07-10 13:07:40 interface,info qsfp28-4-1 link down\n 07-10 13:07:40 interface,info qsfp28-4-1 link up (speed 10G, full duplex)\n 07-10 13:07:40 bridge,stp qsfp28-4-1:0 becomes Designated\n 07-10 13:07:41 bridge,stp qsfp28-4-1:0 becomes Root\n 07-10 13:07:41 bridge,stp qsfp28-4-1:0 learning\n 07-10 13:07:41 bridge,stp qsfp28-4-1:0 forwarding\n 07-10 13:07:41 bridge,stp qsfp28-4-1:0 TCHANGE start\n 07-10 13:07:43 bridge,stp qsfp28-4-1:0 TCHANGE over\n 07-10 17:10:35 interface,info qsfp28-4-1 link down\n 07-10 17:10:38 interface,info qsfp28-4-1 link up (speed 10G, full duplex)\n 07-10 17:10:38 bridge,stp qsfp28-4-1:0 becomes Designated\n 07-10 17:10:38 bridge,stp qsfp28-4-1:0 becomes Root\n 07-10 17:10:38 bridge,stp qsfp28-4-1:0 learning\n 07-10 17:10:38 bridge,stp qsfp28-4-1:0 forwarding\n 07-10 17:10:38 bridge,stp qsfp28-4-1:0 TCHANGE start\n 07-10 17:10:40 bridge,stp qsfp28-4-1:0 TCHANGE over\n</code></pre> <p>Note- most of the events you see above- was due to me changing around parameters. I did notice a high amount of RX-Pauses, and decided to see if toggling flow-control off would do anything of value. (It didn't)</p> <p>After- not finding anything really of use- I decided to try a few difference approaches....</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#multi-ping-python","title":"Multi-Ping (Python)","text":"<p>After digging down quite a few rabbit holes, I started running Python- multi-ping-ext. This- is a simple python project, which pings multiple hosts at the same time, and keeps track of latency and failures.</p> <p>And- it didn't take long for it to spot the issues. </p> <p></p> <p>For back-story, my network has 4 different routers, handling various pieces.</p> <p>All of my 1G networking, is routed via the UXG-Lite (10.100.1.1, 10.255.253.1)</p> <p>Most of my 10G networking, is routed by the USW-24-PRO (10.255.253.2)</p> <p>10.255.253.3, is one of my internal routers for various 10G subnets. BUT- for traffic to reach it, it typically goes through the UXG-Lite, due to... Unifi's crappy layer 3 switch support.</p> <p>The next question..... Where is this packet loss coming from? </p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#starting-at-the-usw-24","title":"Starting at the USW-24","text":"<p>Since- Unifi gives basically no details of use via the GUI / Interface, lets dig into the switch itself.</p> <pre><code>(UBNT) #show interface ethernet all\n\nPort      Bytes Tx         Bytes Rx         Packets Tx       Packets Rx       Utilization Tx (%)   Utilization Rx (%)\n------    --------         --------         ----------       ----------       ------------------   ------------------\n0/1       45309732962      78659561832      50079930         67805477         1                   12\n0/2       53058446789      1779656951       47792959         9648488          0                   0\n0/3       38979425716      39846249001      51526480         51914192         0                   0\n0/4       1173970958       174831946        2073311          1073446          0                   0\n0/5       8343943807       109783344193     18746036         76815417         0                   0\n0/6       24066682019      537929824        16833100         1724027          0                   0\n0/7       0                0                0                0                0                   0\n0/8       0                0                0                0                0                   0\n0/9       0                0                0                0                0                   0\n0/10      95260623684      141818291159     102760702        128171969        1                   13\n0/11      0                0                0                0                0                   0\n0/12      0                0                0                0                0                   0\n0/13      4861040          1268167          57094            17508            0                   0\n0/14      29821762         22472576         175979           47169            0                   0\n0/15      0                0                0                0                0                   0\n0/16      4799011          1204238          56230            16791            0                   0\n0/17      48800564         665190853        501605           566173           0                   0\n0/18      50779467155      3861213785       40912085         14892259         11                  0\n0/19      0                0                0                0                0                   0\n0/20      0                0                0                0                0                   0\n0/21      0                0                0                0                0                   0\n0/22      320095833288     61377643284      284889253        183029549        3                   0\n0/23      6988361559       256695727474     102007331        200475378        0                   2\n0/24      37968718630      13602255975      57136717         41141882         0                   0\n0/25      23447404365      23682097617      18507312         22317363         1                   0\n0/26      399311466370     371416678133     331286549        322562623        0                   0\n3/1       98368179751      80439218783      97872889         77453965         0                   6\n3/2       32410625826      110321274017     35579136         78539444         0                   0\n</code></pre> <p>Looking at the specific interface for the UXG-Lite, does not show anything of concern either.</p> <pre><code>(UBNT) #show interface 0/10\n\nPackets Received Without Error................. 128826893\nPackets Received With Error.................... 0\nBroadcast Packets Received..................... 91668\nReceive Packets Discarded...................... 18\nPackets Transmitted Without Errors............. 103061722\nTransmit Packets Discarded..................... 54\nTransmit Packet Errors......................... 0\nCollision Frames............................... 0\nNumber of link down events..................... 0\nLoad Interval.................................. 300\nBits Per Second Received....................... 120304808\nBits Per Second Transmitted.................... 15672624\nPackets Per Second Received.................... 10643\nPackets Per Second Transmitted................. 3365\nPercent Utilization Received................... 12%\nPercent Utilization Transmitted................ 1%\nTime Since Counters Last Cleared............... 1 day 0 hr 59 min 11 sec\n</code></pre> <p>Really- nothing of value to see....</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#uxg-lite","title":"UXG-Lite","text":"<p>Nearly instantly, after looking at the port counters- the issue was very clear.</p> <p>The primary bridge appears to be dropping tons of packets.</p> <pre><code>root@UniFiNext-GenGatewayLite:~# netstat --statistics\nIp:\n    Forwarding: 1\n    29023746 total packets received\n    25114294 forwarded\n    0 incoming packets discarded\n    3747325 incoming packets delivered\n    29195929 requests sent out\n    1709 outgoing packets dropped\n    44 dropped because of missing route\n    15 reassemblies required\n    5 packets reassembled ok\n    1 fragments failed\nIcmp:\n    995633 ICMP messages received\n    17 input ICMP message failed\n    ICMP input histogram:\n        destination unreachable: 259\n        echo requests: 826570\n        echo replies: 168804\n    1080204 ICMP messages sent\n    0 ICMP messages failed\n    ICMP output histogram:\n        destination unreachable: 80875\n        redirect: 3819\n        echo requests: 168940\n        echo replies: 826570\nIcmpMsg:\n        InType0: 168804\n        InType3: 259\n        InType8: 826570\n        OutType0: 826570\n        OutType3: 80875\n        OutType5: 3819\n        OutType8: 168940\nTcp:\n    78978 active connection openings\n    31357 passive connection openings\n    36080 failed connection attempts\n    3 connection resets received\n    3 connections established\n    2494553 segments received\n    2540942 segments sent out\n    337 segments retransmitted\n    0 bad segments received\n    37405 resets sent\nUdp:\n    142428 packets received\n    116282 packets to unknown port received\n    370 packet receive errors\n    507393 packets sent\n    370 receive buffer errors\n    0 send buffer errors\n    IgnoredMulti: 3072\nUdpLite:\nTcpExt:\n    41567 TCP sockets finished time wait in fast timer\n    67157 delayed acks sent\n    7842 delayed acks further delayed because of locked socket\n    Quick ack mode was activated 244 times\n    4061 packets directly queued to recvmsg prequeue\n    1405 bytes directly in process context from backlog\n    TCPDirectCopyFromPrequeue: 16537\n    950638 packet headers predicted\n    4 packet headers predicted and directly queued to user\n    422349 acknowledgments not containing data payload received\n    576758 predicted acknowledgments\n    TCPDSACKUndo: 3\n    12 congestion windows recovered without slow start after partial ack\n    1 retransmits in slow start\n    TCPTimeouts: 52\n    TCPLossProbes: 253\n    TCPLossProbeRecovery: 2\n    TCPDSACKOldSent: 244\n    TCPDSACKRecv: 221\n    TCPDSACKIgnoredNoUndo: 115\n    TCPSpuriousRTOs: 1\n    TCPSackShiftFallback: 1\n    IPReversePathFilter: 3261\n    TCPRcvCoalesce: 44097\n    TCPOFOQueue: 294\n    TCPSpuriousRtxHostQueues: 17\n    TCPAutoCorking: 1185\n    TCPSynRetrans: 107\n    TCPOrigDataSent: 1469084\n    TCPHystartTrainDetect: 4\n    TCPHystartTrainCwnd: 66\n    TCPACKSkippedSeq: 10\nIpExt:\n    InNoRoutes: 2524\n    InMcastPkts: 16772\n    OutMcastPkts: 34423\n    InBcastPkts: 21278\n    OutBcastPkts: 17548\n    InOctets: 24232842554\n    OutOctets: 45517272843\n    InMcastOctets: 1118364\n    OutMcastOctets: 1828988\n    InBcastOctets: 1251369\n    OutBcastOctets: 567758\n    InNoECTPkts: 32780595\n    InECT1Pkts: 9\n    InECT0Pkts: 2296\n    InCEPkts: 2\n</code></pre> <pre><code>root@UniFiNext-GenGatewayLite:~# netstat -i\nKernel Interface table\nIface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg\nbr0       1500   176609      0  18411 0        238268      0      0      0 BMRU\nbr13      1500     4191      0      0 0          2580      0      0      0 BMRU\neth0      1500 107188671      0     88 415    135637148      0    519      0 BMRU\neth1      1500 45873230      0      3 0      16769419      0      0      0 BMRU\n</code></pre> <pre><code>root@UniFiNext-GenGatewayLite:~# ip -s link show br0\n13: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000\n    link/ether d8:b3:70:8d:e8:b4 brd ff:ff:ff:ff:ff:ff\n    RX: bytes  packets  errors  dropped missed  mcast\n    44763888   177339   0       18520   0       0\n    TX: bytes  packets  errors  dropped carrier collsns\n    78755044   238774   0       0       0       0\n</code></pre> <p>br0 is the primary interface which receives incoming traffic. Given, its high packet loss- this certainly explains the random latency, and disconnects.</p> <p>The amount of current throughput, isn't very high- under 100Mbit/s.</p> <pre><code>top - 19:45:13 up 1 day,  1:54,  1 user,  load average: 2.82, 2.38, 2.30\nTasks: 144 total,   1 running, 143 sleeping,   0 stopped,   0 zombie\n%Cpu(s): 11.2 us,  4.2 sy,  0.0 ni, 73.2 id,  0.0 wa,  2.2 hi,  9.2 si,  0.0 st\nMiB Mem :    974.1 total,    172.7 free,    261.1 used,    540.3 buff/cache\nMiB Swap:    768.0 total,    761.1 free,      6.9 used.    530.4 avail Mem\n\n    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n   2165 root       5 -15  115492  23928  16488 S  18.0   2.4 127:56.77 ubios-udapi-ser\n      3 root      20   0       0      0      0 S   7.4   0.0  63:56.26 ksoftirqd/0\n   2729 root       5 -15  671156   7360   2232 S   3.2   0.7  47:30.15 utmdaemon\n  50759 root       5 -15  380824  35984  22152 S   1.3   3.6  11:34.95 dpi-flow-stats\n2083016 root      20   0    8920   3500   2728 R   1.0   0.4   0:00.26 top\n   3284 root      20   0  101796  16896   9444 S   0.6   1.7  31:51.49 mcad\n   3380 root      20   0  169904  12240   8784 S   0.6   1.2  29:59.01 exe\n   1836 root      20   0   25060   9744   8272 S   0.3   1.0   5:09.99 utermd\n  51799 root       5 -15   43288    744    644 S   0.3   0.1   0:22.12 dpinger\n2062438 root      20   0   14928   7308   6160 S   0.3   0.7   0:00.59 sshd\n2064428 root      20   0       0      0      0 D   0.3   0.0   0:00.72 kworker/u4:3\n</code></pre> <p>Top, shows current load average, is pretty high- but, not overwhelming.</p> <pre><code>root@UniFiNext-GenGatewayLite:~# ethtool -a eth0\nPause parameters for eth0:\nAutonegotiate:  on\nRX:             off\nTX:             off\nRX negotiated:  off\nTX negotiated:  off\n</code></pre> <p>Looks like flow-control is disabled by default too. So, as a test- I decided to enable it.</p> <p><code>ethtool -A eth0 rx on tx on</code></p> <p>While- this decreased the amount of packet drops, and the frequency- this did not correct the issue.</p> <p>Looking through the logs- I notice tons of processes complaining about executions taking too long.</p> <pre><code>root@UniFiNext-GenGatewayLite:/var/log# tail -n 40 -f messages | grep execution\n2024-07-10T19:50:10-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1156ms exceeds expectations in io_context_ext (process-manager-child-exit post event)\n2024-07-10T19:50:13-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 557ms exceeds expectations in io_context_ext (nl-neighbors-poll timer event)\n2024-07-10T19:50:29-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 554ms exceeds expectations in io_context_ext (nl-neighbors-poll timer event)\n2024-07-10T19:50:33-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1047ms exceeds expectations in ubios-udapi-server (single_filter_observer&lt;wan_failover_interfaces_iface_observer&gt; action tunovpnc1)\n2024-07-10T19:50:34-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1034ms exceeds expectations in ubios-udapi-server (single_filter_observer&lt;wan_failover_interfaces_iface_observer&gt; action tunovpnc1)\n2024-07-10T19:50:35-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1075ms exceeds expectations in io_context_ext (process-manager-child-exit post event)\n2024-07-10T19:50:45-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1029ms exceeds expectations in io_context_ext (nl-neighbors-poll timer event)\n2024-07-10T19:50:58-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 910ms exceeds expectations in ubios-udapi-server (single_filter_observer&lt;wan_failover_interfaces_iface_observer&gt; action tunovpnc1)\n2024-07-10T19:50:59-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 931ms exceeds expectations in ubios-udapi-server (single_filter_observer&lt;wan_failover_interfaces_iface_observer&gt; action tunovpnc1)\n2024-07-10T19:51:00-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1001ms exceeds expectations in io_context_ext (process-manager-child-exit post event)\n2024-07-10T19:51:01-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 634ms exceeds expectations in io_context_ext (nl-neighbors-poll timer event)\n2024-07-10T19:51:17-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 752ms exceeds expectations in io_context_ext (nl-neighbors-poll timer event)\n2024-07-10T19:51:23-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: utils-daemon: Routine execution time of 1094ms exceeds expectations in ubios-udapi-server (single_filter_observer&lt;wan_\n</code></pre> <p>More importantly, I noticed one of my OpenVPN clients was busy connecting over and over.</p> <pre><code>2024-07-10T19:51:50-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Got process exit event for process openvpn-raw-1\n2024-07-10T19:51:50-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: openvpn: tunnel tunovpnc1 wasn't being tracked\n2024-07-10T19:51:50-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientDisconnected server on /vpn/openvpn/raws/1\n2024-07-10T19:51:51-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientConnecting server on /vpn/openvpn/raws/1\n2024-07-10T19:51:51-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Watchdog will restart process openvpn-raw-1 in 20s\n2024-07-10T19:52:11-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Watchdog is restarting throttled process openvpn-raw-1\n2024-07-10T19:52:15-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Got process exit event for process openvpn-raw-1\n2024-07-10T19:52:15-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: openvpn: tunnel tunovpnc1 wasn't being tracked\n2024-07-10T19:52:15-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientDisconnected server on /vpn/openvpn/raws/1\n2024-07-10T19:52:16-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientConnecting server on /vpn/openvpn/raws/1\n2024-07-10T19:52:16-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Watchdog will restart process openvpn-raw-1 in 20s\n2024-07-10T19:52:37-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Watchdog is restarting throttled process openvpn-raw-1\n2024-07-10T19:52:41-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Got process exit event for process openvpn-raw-1\n2024-07-10T19:52:41-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: openvpn: tunnel tunovpnc1 wasn't being tracked\n2024-07-10T19:52:41-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientDisconnected server on /vpn/openvpn/raws/1\n2024-07-10T19:52:42-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: signal-out-notifier: Sending to mcad: EVT_VPN_ClientConnecting server on /vpn/openvpn/raws/1\n2024-07-10T19:52:42-05:00 UniFiNext-GenGatewayLite ubios-udapi-server[2165]: process: Watchdog will restart process openvpn-raw-1 in 20s\n</code></pre>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#the-root-cause","title":"The root cause","text":"<p>I decided to pause the failing connection, and to troubleshoot it later.</p> <p>Interesting enough- as soon as I paused it, I noticed a bunch of interesting.... updates.</p> <p>Also- while  digging around, I noticed one of my DDNS clients was failing. I went ahead and fix it.</p> <p>Afterwards, load dropped down to 1.5... and all noticeable packet loss stopped.</p> <pre><code>top - 20:35:47 up 1 day,  2:44,  1 user,  load average: 1.52, 1.56, 1.65\nTasks: 143 total,   1 running, 142 sleeping,   0 stopped,   0 zombie\n%Cpu(s):  9.7 us,  7.2 sy,  0.0 ni, 76.8 id,  0.0 wa,  2.0 hi,  4.3 si,  0.0 st\nMiB Mem :    974.1 total,    144.0 free,    264.9 used,    565.2 buff/cache\nMiB Swap:    768.0 total,    761.4 free,      6.6 used.    525.7 avail Mem\n\n    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n   3284 root      20   0  101796  16896   9444 S   6.8   1.7  33:06.78 mcad\n   2165 root       5 -15  117296  26396  16836 S   6.2   2.6 132:09.44 ubios-udapi-ser\n   3380 root      20   0  169904  12240   8784 S   3.6   1.2  31:04.44 exe\n   2729 root       5 -15  671156   7360   2232 S   2.9   0.7  48:56.65 utmdaemon\n2122585 root      20   0    8908   3420   2660 R   1.0   0.3   0:00.14 top\n      3 root      20   0       0      0      0 S   0.6   0.0  65:22.61 ksoftirqd/0\n     13 root      rt   0       0      0      0 S   0.3   0.0   0:18.67 migration/1\n   1085 root      20   0       0      0      0 S   0.3   0.0   0:08.40 jbd2/mmcblk0p4-\n   1836 root      20   0   25060   9744   8272 S   0.3   1.0   5:19.49 utermd\n  50759 root       5 -15  380824  35984  22152 S   0.3   3.6  11:59.51 dpi-flow-stats\n2062438 root      20   0   14928   7312   6160 S   0.3   0.7   0:01.27 sshd\n2063867 root      20   0       0      0      0 D   0.3   0.0   0:04.59 kworker/u4:0\n2079918 root      20   0  260128  16256  13864 S   0.3   1.6   0:05.55 syslog-ng\n2090876 root      20   0       0      0      0 S   0.3   0.0   0:02.57 kworker/u4:4\n      1 root      20   0  100268  10128   7364 S   0.0   1.0   1:12.42 systemd\n      2 root      20   0       0      0      0 S   0.0   0.0   0:00.11 kthreadd\n      5 root       0 -20       0      0      0 S   0.0   0.0   0:00.00 kworker/0:0H\n</code></pre> <p>So- the root cause, was due to a single OpenVPN client spamming reconnect attempts, and a DDNS client which was spamming retries.</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#next-steps-enable-snmp-on-the-uxg-lite-unsupported","title":"Next steps? Enable SNMP on the UXG-Lite (Unsupported)","text":"<p>Warn</p> <p>Note- installing software on the UXG-lite is unsupported. Firmware updates will likely remove any customizations you perform.</p> <p>I have libreNMS already running for every OTHER network device... EXCEPT the uxg-lite.</p> <p></p> <p>But- you know what? There is nothing special about the UXG-Lite. Its just an embedded system running a customized verison of debian.</p> <p>Don't believe me? Look for yourself.</p> <pre><code>root@UniFiNext-GenGatewayLite:/etc/snmp# cd ~\nroot@UniFiNext-GenGatewayLite:~# cat /etc/os-release\nPRETTY_NAME=\"Debian GNU/Linux 11 (bullseye)\"\nNAME=\"Debian GNU/Linux\"\nVERSION_ID=\"11\"\nVERSION=\"11 (bullseye)\"\nVERSION_CODENAME=bullseye\nID=debian\nHOME_URL=\"https://www.debian.org/\"\nSUPPORT_URL=\"https://www.debian.org/support\"\nBUG_REPORT_URL=\"https://bugs.debian.org/\"\n</code></pre> <p>So- I'm going to enable SNMP on this thing. </p> <p>Info</p> <p>Yes- I realize SNMP is available for UDM models, and *PRO models.</p> <p>I'm not paying 400$ for the privilege to \"enable SNMP\", or to handle 10G routing, when I have a perfectly serviceable 10G Layer 3 switch already.</p> <p>What is interesting- there is a snmp.conf on the base image.</p> <pre><code>root@UniFiNext-GenGatewayLite:/etc/snmp# ls -al\ntotal 5\ndrwxr-xr-x 2 root root   32 Aug 15  2022 ./\ndrwxrwxr-x 1 root root 4096 Jul 10 20:31 ../\n-rw-r--r-- 1 root root  510 Aug 15  2022 snmp.conf\nroot@UniFiNext-GenGatewayLite:/etc/snmp# cat /etc/snmp/snmp.conf\n# As the snmp packages come without MIB files due to license reasons, loading\n# of MIBs is disabled by default. If you added the MIBs you can reenable\n# loading them by commenting out the following line.\nmibs :\n\n# If you want to globally change where snmp libraries, commands and daemons\n# look for MIBS, change the line below. Note you can set this for individual\n# tools with the -M option or MIBDIRS environment variable.\n#\n# mibdirs /usr/share/snmp/mibs:/usr/share/snmp/mibs/iana:/usr/share/snmp/mibs/ietf\n</code></pre> <p>Although, there are no snmp services, or daemons. I was unable to locate snmpd binaries either. So, I installed it.</p> <pre><code>root@UniFiNext-GenGatewayLite:/etc/snmp# apt-get install snmpd\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nSuggested packages:\n  snmptrapd\nThe following NEW packages will be installed:\n  snmpd\n0 upgraded, 1 newly installed, 0 to remove and 36 not upgraded.\nNeed to get 56.7 kB of archives.\nAfter this operation, 142 kB of additional disk space will be used.\nGet:1 https://deb.debian.org/debian bullseye/main arm64 snmpd arm64 5.9+dfsg-4+deb11u1 [56.7 kB]\nFetched 56.7 kB in 0s (165 kB/s)\nPreconfiguring packages ...\nSelecting previously unselected package snmpd.\n(Reading database ... 24527 files and directories currently installed.)\nPreparing to unpack .../snmpd_5.9+dfsg-4+deb11u1_arm64.deb ...\nUnpacking snmpd (5.9+dfsg-4+deb11u1) ...\nSetting up snmpd (5.9+dfsg-4+deb11u1) ...\nadduser: Warning: The home directory `/var/lib/snmp' does not belong to the user you are currently creating.\nCreated symlink /etc/systemd/system/multi-user.target.wants/snmpd.service \u2192 /lib/systemd/system/snmpd.service.\n</code></pre> <p>After installing SNMPD, I modified the config file, and restarted the service.</p> <pre><code>root@UniFiNext-GenGatewayLite:/etc/snmp# vi snmpd.conf\nroot@UniFiNext-GenGatewayLite:/etc/snmp# systemctl restart snmpd.service\n</code></pre> <p>And, afterwards, I was able to add it directly into LibreNMS without any issues.</p> <p></p> <p>Now- I can centerally report on its stats, performance, and packet loss.</p> <p>Sure- it might get erased during the next firmware update- but, nothing an ansible playbook can't fix automatically.</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#why-was-this-issue-so-hard-to-pinpoint","title":"Why was this issue so hard to pinpoint?","text":"","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#reason-1-my-uxg-lite-does-not-support-snmp-to-export-data-back-to-a-central-location-have-its-data-in-librenms-would-have-made-it-much-easier-to-pinpoint-the-exact-location","title":"Reason #1- My UXG-Lite does not \"SUPPORT\" snmp to export data back to a central location. Have its data, in LibreNMS, would have made it much easier to pinpoint the exact location.","text":"<ul> <li>This- was corrected by manually installing SNMP, and configuring it.</li> <li>As well- I created an ansible playbook to handle automatically reinstalling, and reconfiguring it when I do firmware updates.</li> </ul>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#reason-2-i-have-a-overly-complex-network-with-7-switches-and-4-routers","title":"Reason #2- I have a overly complex network, with 7 switches, and 4 routers.","text":"","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#a-large-reason-for-this-is-performance-based","title":"A large reason for this- is performance-based.","text":"<ul> <li>1G clients can easily use the UXG as a gateway.</li> <li>10G clients, would limited to 1G MAX throughput by the UXG- so, their gateway is the 10G Layer 3 USW-Pro-24<ul> <li>Unifi's layer-3 support on switches is still, a laughable joke. Still, no IPv6 support. Can only add TWO static routes on a USW \"PRO\" switch. (Enterprise doesn't have this weird limitation)</li> </ul> </li> <li>100G clients, would also be bottlenecked when routing across the 10G. These client's use the Mikrotik for routing. It can do hardware asic routing, and can handle line-speed 100G with hardware offload.</li> </ul>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#another-reason-is-reliability-oriented","title":"Another reason- is reliability-oriented.","text":"<p>One goal of mine- is even when the internet is completely out, and backup circuits are unavailable- my entire network should continue to function normally.</p> <p>Rather then making the internet-facing UXG-Lite router the \"Center\" of my network, I prefer to think of it as being just another component on the edge, and not at the core.</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#security-concerns","title":"Security Concerns.","text":"<p>While- the Unifi interface is nice, easy and simple. It does not have supported for getting intricuite with firewall rules.</p> <p>For my Security, Management, and IOT vlans, I needed a robust solution which was powerful, easy to configure and monitor, and extremely reliable. So- I decided to use my 10 year old EdgeMAX.</p> <p>This device- has never once failed me. Its CLI is basted on Vyatta (VyOS now), which is extremely powerful, flexible, and performs well.</p> <p>So- it was chosen to host the sensitive items.</p> <p>This- was also done- to assist in the event someone gains access into my network. By having all of the management interfaces, physical security, IOT, etc behind a seperate firewaell- it allows me to seperate those devices from the rest of my network, physically. (If- you pretend vlans on the core switch is enough seperation).</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/detecting-a-packetloss--latency-issue/#farewall","title":"Farewall","text":"<p>Thats it. Just sharing a brief capture of the issue that I have been trying to track down for weeks. Hopefully- you find something handy in here.</p>","tags":["Homelab","Networking"]},{"location":"blog/2024/proxmox---random-error-fixes/","title":"Proxmox - Solutions to random errors.","text":"<p>This- is a short post which details how to resolve a few random errors you may experience with proxmox.</p> <p>This post is for you, IF, you are experiencing any of these errors:</p> <ul> <li>\"System booted in EFI-mode but 'grub-efi-amd64' meta-package not installed! Install 'grub-efi-amd64' to get updates.\"</li> <li>\"Couldn't find EFI system partition. It is recommended to mount it to /boot or /efi.\"</li> <li>\"/etc/kernel/proxmox-boot-uuids does not exist.\"</li> </ul>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---random-error-fixes/#system-booted-in-efi-mode-but-grub-efi-amd64-meta-package-not-installed-install-grub-efi-amd64-to-get-updates","title":"\"System booted in EFI-mode but 'grub-efi-amd64' meta-package not installed! Install 'grub-efi-amd64' to get updates.\"","text":"<p>Apparently some of the older versions of the proxmox installer included the incorrect package of <code>grub-pc</code> instead of <code>grub-efi-amd64</code></p> <p>You can run <code>apt-get install grub-efi-amd64</code> to correct this, and it will automatically remove the old package.</p> <pre><code>root@kube01:~# apt-get install grub-efi-amd64\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following package was automatically installed and is no longer required:\n  proxmox-kernel-6.5.11-8-pve-signed\nUse 'apt autoremove' to remove it.\nThe following packages will be REMOVED:\n  grub-pc\nThe following NEW packages will be installed:\n  grub-efi-amd64\n0 upgraded, 1 newly installed, 1 to remove and 22 not upgraded.\nNeed to get 45.7 kB of archives.\nAfter this operation, 384 kB disk space will be freed.\nDo you want to continue? [Y/n]\n</code></pre> <p>More references:</p> <ol> <li>https://forum.proxmox.com/threads/pve-7-3-3-configuring-grub-pc-grub-failed-to-install-to-the-following-devices.123395/</li> <li>https://forum.proxmox.com/threads/update-installed-system-booted-in-efi-mode-but-grub-efi-amd64-meta-package-not-installed.137324/</li> </ol>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---random-error-fixes/#couldnt-find-efi-system-partition-it-is-recommended-to-mount-it-to-boot-or-efi","title":"\"Couldn't find EFI system partition. It is recommended to mount it to /boot or /efi.\"","text":"<p>This error is encountered when trying to <code>update-initramfs</code></p> <pre><code>root@kube01:~# update-initramfs -u -k all\nupdate-initramfs: Generating /boot/initrd.img-6.8.4-2-pve\nRunning hook script 'zz-proxmox-boot'..\nRe-executing '/etc/kernel/postinst.d/zz-proxmox-boot' in new private mount namespace..\nNo /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.\nSystem booted in EFI-mode but 'grub-efi-amd64' meta-package not installed!\nInstall 'grub-efi-amd64' to get updates.\nCouldn't find EFI system partition. It is recommended to mount it to /boot or /efi.\nAlternatively, use --esp-path= to specify path to mount point.\nupdate-initramfs: Generating /boot/initrd.img-6.5.13-5-pve\nRunning hook script 'zz-proxmox-boot'..\nRe-executing '/etc/kernel/postinst.d/zz-proxmox-boot' in new private mount namespace..\nNo /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.\nSystem booted in EFI-mode but 'grub-efi-amd64' meta-package not installed!\nInstall 'grub-efi-amd64' to get updates.\nCouldn't find EFI system partition. It is recommended to mount it to /boot or /efi.\nAlternatively, use --esp-path= to specify path to mount point.\nupdate-initramfs: Generating /boot/initrd.img-6.5.11-8-pve\nRunning hook script 'zz-proxmox-boot'..\nRe-executing '/etc/kernel/postinst.d/zz-proxmox-boot' in new private mount namespace..\nNo /etc/kernel/proxmox-boot-uuids found, skipping ESP sync.\nSystem booted in EFI-mode but 'grub-efi-amd64' meta-package not installed!\nInstall 'grub-efi-amd64' to get updates.\nCouldn't find EFI system partition. It is recommended to mount it to /boot or /efi.\nAlternatively, use --esp-path= to specify path to mount point.\nupdate-initramfs: Generating /boot/initrd.img-6.2.16-20-pve\n^C\n</code></pre> <p>First- verify we are booted in EFI mode. (If, you see results in this directory- you are in EFI mode.)</p> <pre><code>root@kube01:~# ls /sys/firmware/efi\nconfig_table  efivars  esrt  fw_platform_size  fw_vendor  runtime  runtime-map  systab\n</code></pre> <p>Next- identify the \"root\" drive. Based on the <code>lsblk</code> results below, the primary drive is <code>/dev/nvme0n1</code></p> <pre><code>root@kube01:~# lsblk\nNAME                                                                                                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda                                                                                                     8:0    0   1.7T  0 disk\n\u2514\u2500ceph--94463e67--18fb--4b29--9e62--d3c40652cf14-osd--block--2ca45b36--0ca1--42e5--b66e--34f98dda21ca 252:0    0   1.7T  0 lvm\nsdb                                                                                                     8:16   0   1.7T  0 disk\n\u2514\u2500ceph--e7e5f5f3--fd44--46e6--bc71--c0c6343efd5e-osd--block--8930211c--aec9--4fde--86dd--b39ba42c7787 252:3    0   1.7T  0 lvm\nsdc                                                                                                     8:32   0 894.3G  0 disk\n\u2514\u2500ceph--03215be4--5055--4eb3--bc93--5e342cf7f9ea-osd--block--85e1beb9--a39e--46db--94db--61fe404ed0fb 252:2    0 894.3G  0 lvm\nsdd                                                                                                     8:48   0 894.3G  0 disk\n\u2514\u2500ceph--853aa98b--2aa5--4e7b--b411--5a737f80cffd-osd--block--5b3420a5--9e3b--4217--b27a--b236121e3e1a 252:1    0 894.3G  0 lvm\nsr0                                                                                                    11:0    1  1024M  0 rom\nnvme0n1                                                                                               259:0    0 119.2G  0 disk\n\u251c\u2500nvme0n1p1                                                                                           259:1    0  1007K  0 part\n\u251c\u2500nvme0n1p2                                                                                           259:2    0     1G  0 part\n\u2514\u2500nvme0n1p3                                                                                           259:3    0 118.2G  0 part\n  \u251c\u2500pve-swap                                                                                          252:4    0     8G  0 lvm  [SWAP]\n  \u251c\u2500pve-root                                                                                          252:5    0  39.6G  0 lvm  /\n  \u251c\u2500pve-data_tmeta                                                                                    252:6    0     1G  0 lvm\n  \u2502 \u2514\u2500pve-data                                                                                        252:8    0  53.9G  0 lvm\n  \u2514\u2500pve-data_tdata                                                                                    252:7    0  53.9G  0 lvm\n    \u2514\u2500pve-data                                                                                        252:8    0  53.9G  0 lvm\n</code></pre> <p>List the partitions for the drive identified above, using <code>fdisk -l /dev/your-device</code></p> <pre><code>root@kube01:~# fdisk -l /dev/nvme0n1\nDisk /dev/nvme0n1: 119.24 GiB, 128035676160 bytes, 250069680 sectors\nDisk model: KBG40ZNS128G NVMe KIOXIA 128GB\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: D59D0401-0022-4F68-8D7A-D6C0CD8F1EA4\n\nDevice           Start       End   Sectors   Size Type\n/dev/nvme0n1p1      34      2047      2014  1007K BIOS boot\n/dev/nvme0n1p2    2048   2099199   2097152     1G EFI System\n/dev/nvme0n1p3 2099200 250069646 247970447 118.2G Linux LVM\n</code></pre> <p>So- /dev/nvme0n1p2 contains the EFI system. Mount it.</p> <pre><code>root@kube01:~# mount /dev/nvme0n1p2 /boot/efi\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/proxmox---random-error-fixes/#etckernelproxmox-boot-uuids-does-not-exist","title":"\"/etc/kernel/proxmox-boot-uuids does not exist.\"","text":"<p>First, verify this is your issue-</p> <pre><code>root@kube01:~# proxmox-boot-tool status\nRe-executing '/usr/sbin/proxmox-boot-tool' in new private mount namespace..\nE: /etc/kernel/proxmox-boot-uuids does not exist.\n</code></pre> <p>Unmount <code>/boot/efi</code></p> <pre><code>umount /boot/efi\n</code></pre> <p>And.... run <code>proxmox-boot-tool init /dev/your-efi-drive-partition</code></p> <pre><code>root@kube01:~# proxmox-boot-tool init /dev/nvme0n1p2\nRe-executing '/usr/sbin/proxmox-boot-tool' in new private mount namespace..\nUUID=\"D34B-A25D\" SIZE=\"1073741824\" FSTYPE=\"vfat\" PARTTYPE=\"c12a7328-f81f-11d2-ba4b-00a0c93ec93b\" PKNAME=\"nvme0n1\" MOUNTPOINT=\"\"\nMounting '/dev/nvme0n1p2' on '/var/tmp/espmounts/D34B-A25D'.\nInstalling grub x86_64 target..\nInstalling for x86_64-efi platform.\nInstallation finished. No error reported.\nInstalling grub x86_64 target (removable)..\nInstalling for x86_64-efi platform.\nInstallation finished. No error reported.\nUnmounting '/dev/nvme0n1p2'.\nAdding '/dev/nvme0n1p2' to list of synced ESPs..\nRefreshing kernels and initrds..\nRunning hook script 'proxmox-auto-removal'..\nRunning hook script 'zz-proxmox-boot'..\nNo /etc/kernel/cmdline found - falling back to /proc/cmdline\nCopying and configuring kernels on /dev/disk/by-uuid/D34B-A25D\n        Copying kernel 6.5.13-5-pve\n        Copying kernel 6.8.4-2-pve\nGenerating grub configuration file ...\nFound linux image: /boot/vmlinuz-6.8.4-2-pve\nFound initrd image: /boot/initrd.img-6.8.4-2-pve\nFound linux image: /boot/vmlinuz-6.5.13-5-pve\nFound initrd image: /boot/initrd.img-6.5.13-5-pve\nAdding boot menu entry for UEFI Firmware Settings ...\ndone\n        Disabling upstream hook /etc/initramfs/post-update.d/systemd-boot\n        Disabling upstream hook /etc/kernel/postinst.d/zz-systemd-boot\n        Disabling upstream hook /etc/kernel/postrm.d/zz-systemd-boot\n</code></pre> <p>Afterwards, you should be good to go.</p> <pre><code>root@kube01:~# proxmox-boot-tool status\nRe-executing '/usr/sbin/proxmox-boot-tool' in new private mount namespace..\nSystem currently booted with uefi\nD34B-A25D is configured with: grub (versions: 6.8.4-3-pve, 6.8.8-2-pve)\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2024/rant-unifi-layer-3/","title":"Rant: Unifi Layer 3 Switches","text":"<p>I have a love-hate relationship with Unifi.</p> <p>One of the things I absolutely hate about Unifi, is their \"Layer 3\" switches.</p> <p>IMO, its a marketing gimmick, and an absolute joke.</p> <p>Info</p> <p>This post was originally written in July of 2024.</p> <p>I did not get around to finishing and publishing until December 2024.</p> <p>Some of my below issues have been resolved. I have left the original text, and included notes such as this where applicable.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#why-you-should-avoid-unifi-layer-3-switches","title":"Why you should avoid Unifi \"Layer 3\" Switches","text":"","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#reason-number-1-layer-3-routing-does-not-work","title":"Reason Number 1. Layer 3 Routing does not work.","text":"<p>So- the main reason you typically buy a layer 3 route, is for the ability to route traffic, right?</p> <p>Well, lets go through the process of adding a static route to a unifi layer 3 switch.</p> <p>Info</p> <p>You CAN manually add routes via the CLI. However, these will be lost whenever the switch provisions or reboots.</p> <p>The switches hardware is perfectly capable, and suitable for layer 3 routing.... WHEN you don't use the Unifi software.</p> <p>First, create your route through the Unifi's Static routes page. Make sure to click DeviceType: Switch, and select your Layer 3 switch.</p> <p></p> <p>Afterwards, wait a second for your device to provision.</p> <p>At this point, you would expect the layer 3 route to exist on your switch. But- it doesn't.</p> <pre><code>CoreSwitch-US.7.0.50# ip route | grep -v .100\ndefault via 10.255.253.1 dev rt_v4040  proto icos  metric 16\n10.255.253.0/24 dev rt_v4040  proto kernel  scope link  src 10.255.253.2\n</code></pre> <p>But- perhaps the issue is, the management's routes differ from the routes in the config.</p> <p>Nope. The routes don't exist there either.</p> <pre><code>CoreSwitch-US.7.0.50# cli\nWarning!\nThe changes may break controller settings and only be effective until reboot.\nEntering character mode\nEscape character is '^]'.\n(UBNT) &gt;enable\n(UBNT) #show ip route\nRoute Codes: C - Connected, S - Static\n\nDefault Gateway(s): 10.255.253.1\n\nS      0.0.0.0/0 [1/0] via 10.255.253.1,   4/1\n...\nC      10.255.253.0/24 [0/0] directly connected,   4/1\n</code></pre> <p>( I removed the routes for the subnets which are hosted by this switch. Those, work fine.)</p> <p>So, lets check the configuration.</p> <pre><code>(UBNT) #show running-config\n...\n\nno errdisable recovery cause keepalive\nip route 0.0.0.0 0.0.0.0 10.255.253.1 description Inter-VLAN routing\nexit\n</code></pre> <p>Ok, so, the only route that exists, is the default \"inter-vlan\" routing route.</p> <p>Summary?</p> <p>This feature does not work as expected.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#reason-2-non-configurable-default-vlan-4040-default-route","title":"Reason #2, Non-Configurable default \"VLAN 4040\" / Default Route.","text":"<p>Unifi \"layer 3\" switches, are shipped with a default route, of <code>0.0.0.0/0</code> via <code>10.255.253.1</code> on vlan 4040.</p> <p>You can read about this feature via Unifi's Official Documentation</p> <p>The short version, If you want to use a Unifi \"layer 3\" switch behind your existing firewall, you MUST configure your existing firewall, with an interface on vlan 4040, with an ip address of <code>10.255.253.1</code></p> <p>And no, per Unifi, you cannot change the VLAN ID.</p> <p></p> <p>Even if you have a Unifi UDM/UXG/Other Gateway- this default route, and vlan will always exist, on every Unifi Layer 3 switch you have.</p> <pre><code>(UBNT) &gt;enable\n\n(UBNT) #show ip route\n\nRoute Codes: C - Connected, S - Static\n\nDefault Gateway(s): 10.255.253.1\n\nS      0.0.0.0/0 [1/0] via 10.255.253.1,   4/1\n</code></pre> <p>Although, interesting, when your gateway does come online, the Linux kernel, will add a default route via your gateway, with a slightly higher priority.</p> <pre><code>CoreSwitch-US.7.0.50# ip route\ndefault via 10.100.1.1 dev eth0\ndefault via 10.255.253.1 dev rt_v4040  proto icos  metric 16\n</code></pre>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#reason-3-there-may-be-a-limitation-of-two-static-routes","title":"Reason #3, There MAY be a limitation of \"TWO\" static routes","text":"<p>Info</p> <p>This limitation exists for the \"PRO\" switches. </p> <p>However, it does not appear to exist for the \"ENTERPRISE\" switches.</p> <p>Imagine picking up a 400$ layer 3 unifi switch, and being excited to get all of your routes for your network configured.... and then....</p> <p></p> <p>You discover, there is a limitation of TWO static routes. Rights right, Two.</p> <p>You better make those routes count. Because you only get TWO of them.</p> <p>I don't know why there is only two allowed- I tested the hardware to see how many it would accept.</p> <pre><code>ip route 192.168.0.0 255.255.255.0 Null0 100 description \"Dummy Route 0\"\nip route 192.168.1.0 255.255.255.0 Null0 100 description \"Dummy Route 1\"\nip route 192.168.2.0 255.255.255.0 Null0 100 description \"Dummy Route 2\"\nip route 192.168.3.0 255.255.255.0 Null0 100 description \"Dummy Route 3\"\nip route 192.168.4.0 255.255.255.0 Null0 100 description \"Dummy Route 4\"\nip route 192.168.5.0 255.255.255.0 Null0 100 description \"Dummy Route 5\"\nip route 192.168.6.0 255.255.255.0 Null0 100 description \"Dummy Route 6\"\nip route 192.168.7.0 255.255.255.0 Null0 100 description \"Dummy Route 7\"\nip route 192.168.8.0 255.255.255.0 Null0 100 description \"Dummy Route 8\"\nip route 192.168.9.0 255.255.255.0 Null0 100 description \"Dummy Route 9\"\nip route 192.168.10.0 255.255.255.0 Null0 100 description \"Dummy Route 10\"\nip route 192.168.11.0 255.255.255.0 Null0 100 description \"Dummy Route 11\"\nip route 192.168.12.0 255.255.255.0 Null0 100 description \"Dummy Route 12\"\nip route 192.168.13.0 255.255.255.0 Null0 100 description \"Dummy Route 13\"\nip route 192.168.14.0 255.255.255.0 Null0 100 description \"Dummy Route 14\"\nip route 192.168.15.0 255.255.255.0 Null0 100 description \"Dummy Route 15\"\nip route 192.168.16.0 255.255.255.0 Null0 100 description \"Dummy Route 16\"\nip route 192.168.17.0 255.255.255.0 Null0 100 description \"Dummy Route 17\"\nip route 192.168.18.0 255.255.255.0 Null0 100 description \"Dummy Route 18\"\nip route 192.168.19.0 255.255.255.0 Null0 100 description \"Dummy Route 19\"\nip route 192.168.20.0 255.255.255.0 Null0 100 description \"Dummy Route 20\"\nip route 192.168.21.0 255.255.255.0 Null0 100 description \"Dummy Route 21\"\nip route 192.168.22.0 255.255.255.0 Null0 100 description \"Dummy Route 22\"\nip route 192.168.23.0 255.255.255.0 Null0 100 description \"Dummy Route 23\"\nip route 192.168.24.0 255.255.255.0 Null0 100 description \"Dummy Route 24\"\nip route 192.168.25.0 255.255.255.0 Null0 100 description \"Dummy Route 25\"\nip route 192.168.26.0 255.255.255.0 Null0 100 description \"Dummy Route 26\"\nip route 192.168.27.0 255.255.255.0 Null0 100 description \"Dummy Route 27\"\nip route 192.168.28.0 255.255.255.0 Null0 100 description \"Dummy Route 28\"\nip route 192.168.29.0 255.255.255.0 Null0 100 description \"Dummy Route 29\"\nip route 192.168.30.0 255.255.255.0 Null0 100 description \"Dummy Route 30\"\nip route 192.168.31.0 255.255.255.0 Null0 100 description \"Dummy Route 31\"\nip route 192.168.32.0 255.255.255.0 Null0 100 description \"Dummy Route 32\"\nip route 192.168.33.0 255.255.255.0 Null0 100 description \"Dummy Route 33\"\nip route 192.168.34.0 255.255.255.0 Null0 100 description \"Dummy Route 34\"\nip route 192.168.35.0 255.255.255.0 Null0 100 description \"Dummy Route 35\"\nip route 192.168.36.0 255.255.255.0 Null0 100 description \"Dummy Route 36\"\nip route 192.168.37.0 255.255.255.0 Null0 100 description \"Dummy Route 37\"\nip route 192.168.38.0 255.255.255.0 Null0 100 description \"Dummy Route 38\"\nip route 192.168.39.0 255.255.255.0 Null0 100 description \"Dummy Route 39\"\nip route 192.168.40.0 255.255.255.0 Null0 100 description \"Dummy Route 40\"\nip route 192.168.41.0 255.255.255.0 Null0 100 description \"Dummy Route 41\"\nip route 192.168.42.0 255.255.255.0 Null0 100 description \"Dummy Route 42\"\nip route 192.168.43.0 255.255.255.0 Null0 100 description \"Dummy Route 43\"\nip route 192.168.44.0 255.255.255.0 Null0 100 description \"Dummy Route 44\"\nip route 192.168.45.0 255.255.255.0 Null0 100 description \"Dummy Route 45\"\nip route 192.168.46.0 255.255.255.0 Null0 100 description \"Dummy Route 46\"\nip route 192.168.47.0 255.255.255.0 Null0 100 description \"Dummy Route 47\"\nip route 192.168.48.0 255.255.255.0 Null0 100 description \"Dummy Route 48\"\nip route 192.168.49.0 255.255.255.0 Null0 100 description \"Dummy Route 49\"\nip route 192.168.50.0 255.255.255.0 Null0 100 description \"Dummy Route 50\"\nip route 192.168.51.0 255.255.255.0 Null0 100 description \"Dummy Route 51\"\nip route 192.168.52.0 255.255.255.0 Null0 100 description \"Dummy Route 52\"\nip route 192.168.53.0 255.255.255.0 Null0 100 description \"Dummy Route 53\"\nip route 192.168.54.0 255.255.255.0 Null0 100 description \"Dummy Route 54\"\nip route 192.168.55.0 255.255.255.0 Null0 100 description \"Dummy Route 55\"\nip route 192.168.56.0 255.255.255.0 Null0 100 description \"Dummy Route 56\"\nip route 192.168.57.0 255.255.255.0 Null0 100 description \"Dummy Route 57\"\nip route 192.168.58.0 255.255.255.0 Null0 100 description \"Dummy Route 58\"\nip route 192.168.59.0 255.255.255.0 Null0 100 description \"Dummy Route 59\"\nip route 192.168.60.0 255.255.255.0 Null0 100 description \"Dummy Route 60\"\nip route 192.168.61.0 255.255.255.0 Null0 100 description \"Dummy Route 61\"\nip route 192.168.62.0 255.255.255.0 Null0 100 description \"Dummy Route 62\"\nip route 192.168.63.0 255.255.255.0 Null0 100 description \"Dummy Route 63\"\nip route 192.168.64.0 255.255.255.0 Null0 100 description \"Dummy Route 64\"\nip route 192.168.65.0 255.255.255.0 Null0 100 description \"Dummy Route 65\"\nip route 192.168.66.0 255.255.255.0 Null0 100 description \"Dummy Route 66\"\nip route 192.168.67.0 255.255.255.0 Null0 100 description \"Dummy Route 67\"\nip route 192.168.68.0 255.255.255.0 Null0 100 description \"Dummy Route 68\"\nip route 192.168.69.0 255.255.255.0 Null0 100 description \"Dummy Route 69\"\nip route 192.168.70.0 255.255.255.0 Null0 100 description \"Dummy Route 70\"\nip route 192.168.71.0 255.255.255.0 Null0 100 description \"Dummy Route 71\"\nip route 192.168.72.0 255.255.255.0 Null0 100 description \"Dummy Route 72\"\nip route 192.168.73.0 255.255.255.0 Null0 100 description \"Dummy Route 73\"\nip route 192.168.74.0 255.255.255.0 Null0 100 description \"Dummy Route 74\"\nip route 192.168.75.0 255.255.255.0 Null0 100 description \"Dummy Route 75\"\nip route 192.168.76.0 255.255.255.0 Null0 100 description \"Dummy Route 76\"\nip route 192.168.77.0 255.255.255.0 Null0 100 description \"Dummy Route 77\"\nip route 192.168.78.0 255.255.255.0 Null0 100 description \"Dummy Route 78\"\nip route 192.168.79.0 255.255.255.0 Null0 100 description \"Dummy Route 79\"\nip route 192.168.80.0 255.255.255.0 Null0 100 description \"Dummy Route 80\"\nip route 192.168.81.0 255.255.255.0 Null0 100 description \"Dummy Route 81\"\nip route 192.168.82.0 255.255.255.0 Null0 100 description \"Dummy Route 82\"\nip route 192.168.83.0 255.255.255.0 Null0 100 description \"Dummy Route 83\"\nip route 192.168.84.0 255.255.255.0 Null0 100 description \"Dummy Route 84\"\nip route 192.168.85.0 255.255.255.0 Null0 100 description \"Dummy Route 85\"\nip route 192.168.86.0 255.255.255.0 Null0 100 description \"Dummy Route 86\"\nip route 192.168.87.0 255.255.255.0 Null0 100 description \"Dummy Route 87\"\nip route 192.168.88.0 255.255.255.0 Null0 100 description \"Dummy Route 88\"\nip route 192.168.89.0 255.255.255.0 Null0 100 description \"Dummy Route 89\"\nip route 192.168.90.0 255.255.255.0 Null0 100 description \"Dummy Route 90\"\nip route 192.168.91.0 255.255.255.0 Null0 100 description \"Dummy Route 91\"\nip route 192.168.92.0 255.255.255.0 Null0 100 description \"Dummy Route 92\"\nip route 192.168.93.0 255.255.255.0 Null0 100 description \"Dummy Route 93\"\nip route 192.168.94.0 255.255.255.0 Null0 100 description \"Dummy Route 94\"\nip route 192.168.95.0 255.255.255.0 Null0 100 description \"Dummy Route 95\"\nip route 192.168.96.0 255.255.255.0 Null0 100 description \"Dummy Route 96\"\nip route 192.168.97.0 255.255.255.0 Null0 100 description \"Dummy Route 97\"\nip route 192.168.98.0 255.255.255.0 Null0 100 description \"Dummy Route 98\"\nip route 192.168.99.0 255.255.255.0 Null0 100 description \"Dummy Route 99\"\n</code></pre> <p>And, it appears it will accept around 60 routes total, before the hardware throws errors.</p> <pre><code>Route Codes: C - Connected, S - Static\n\n\nDefault Gateway(s): 10.255.253.1\n\n\nS      0.0.0.0/0 [1/0] via 10.255.253.1,   4/1\n(Four routes were excluded from here)\nC      10.255.253.0/24 [0/0] directly connected,   4/1\nS      192.168.0.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.1.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.2.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.3.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.4.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.5.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.6.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.7.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.8.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.9.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.10.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.11.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.12.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.13.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.14.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.15.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.16.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.17.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.18.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.19.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.20.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.21.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.22.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.23.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.24.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.25.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.26.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.27.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.28.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.29.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.30.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.31.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.32.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.33.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.34.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.35.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.36.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.37.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.38.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.39.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.40.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.41.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.42.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.43.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.44.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.45.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.46.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.47.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.48.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.49.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.50.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.51.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.52.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.53.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.54.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.55.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.56.0/24 [100/0] directly connected,   Null0 Discard\nS      192.168.57.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.58.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.59.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.60.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.61.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.62.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.63.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.64.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.65.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.66.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.67.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.68.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.69.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.70.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.71.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.72.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.73.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.74.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.75.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.76.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.77.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.78.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.79.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.80.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.81.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.82.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.83.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.84.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.85.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.86.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.87.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.88.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.89.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.90.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.91.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.92.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.93.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.94.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.95.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.96.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.97.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.98.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\nS      192.168.99.0/24 [100/0] directly connected,   Null0 Discard  hw-failure\n</code></pre> <p>So, yup. TWO static routes.</p> <p>This is a case of a  limitation, which will likely be released as a feature in the future.......</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#reason-4-no-ipv6-when-using-layer-3-switches","title":"Reason #4. No IPv6 when using \"Layer 3\" switches.","text":"<p>So, when you are creating a network on a UXG/UDM/etc.... You have quite a few features.</p> <p></p> <p>But, When you decide that you want to use that fancy 10 gig layer 3 switch to speed up traffic a bit... </p> <p>You will notice a few features disappear.</p> <p></p> <p>Notably, you lose the ability to configure any form of IPv6. No SLAAC, No DHCP-v6, No prefix delegation. Nothing.</p> <p>This also means, NO support for IPv6 routing</p> <p>IPv6 traffic can pass over layer 2 just fine. However, there is ZERO support for doing anything with IPv6 on this switch.</p> <p>I'd guess, one day years from now, a feature update will include \"IPv6 Support\" for Layer 3 switches.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#but-those-features-arent-advertised","title":"But... Those features aren't advertised!!!!","text":"<p>As of 2024-07-19, the front page advertises this as a \"Layer 3\" switch, with \"Layer 3 switching\"</p> <p></p> <p>Under Technical Specifications, it lists \"Static routing between local networks\"</p> <p></p> <p>Unifi's Layer 3 Routing Documentation</p> <p></p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#how-does-unifis-layer-3-work","title":"How DOES Unifi's \"Layer 3\" work?","text":"<p>When you use Unifi, It will form a star topology network.</p> <p>This- does not change regardless of the number of layer 2 switches in your deployment.</p> <p></p> <p>This- meaning, every client's packets, will be routed by the central gateway / udm / uxg / etc.</p> <p>When you decide to add a unifi layer 3 switch, and host networks on it, you end up with a extended star topology for your layer 3 routing.</p> <p></p> <p>Clients will send their packets through their assigned layer 3 switch. The switch will then route those packets to either other networks hosted by the switch..</p> <p>Or, if the destination network is not hosted on this switch, the switch will send the packets to the central gateway to be routed. </p> <p>The issue here- if you have multiple layer-3 switches in this way- the traffic going between switches MUST pass through the gateway. This causes additional latency, and load, especially when you do not need to apply ACLs between lan networks.</p> <p>Typically, in most enterprise networks, you have a \"Core Network\" which consists of inter-connected, meshed switches. All of your routing will occur here in the network core.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#other-complaints-about-unifi-in-general","title":"Other Complaints about Unifi in General","text":"","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#uxg-lite-does-not-support-snmp","title":"UXG-Lite \"does not support SNMP\"","text":"<p>Notice</p> <p>This feature has been added via software updates.</p> <p>The update occurred sometime between me writing the post in July 2024, and me publishing this post, in December 2024.</p> <p>While, this is a pretty minor compliant- You cannot enable SNMP on the UXG-Lite via the Unifi interface.</p> <p></p> <p>Although, you can enable it manually pretty easily. It just will not persist across reboots.</p> <pre><code>root@UniFiNext-GenGatewayLite:/var/log# apt-get install snmp\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following NEW packages will be installed:\n  snmp\n0 upgraded, 1 newly installed, 0 to remove and 36 not upgraded.\nNeed to get 170 kB of archives.\nAfter this operation, 639 kB of additional disk space will be used.\nGet:1 https://deb.debian.org/debian bullseye/main arm64 snmp arm64 5.9+dfsg-4+deb11u1 [170 kB]\nFetched 170 kB in 0s (617 kB/s)\nSelecting previously unselected package snmp.\n(Reading database ... 24657 files and directories currently installed.)\nPreparing to unpack .../snmp_5.9+dfsg-4+deb11u1_arm64.deb ...\nUnpacking snmp (5.9+dfsg-4+deb11u1) ...\nSetting up snmp (5.9+dfsg-4+deb11u1) ...\nroot@UniFiNext-GenGatewayLite:/var/log# service snmpd start\n</code></pre>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#no-support-for-gre-gif-or-tunnels-in-general","title":"No support for GRE, GIF, or Tunnels in general.","text":"<p>So, you want IPv6. Your ISP does not offer IPv6. You pick up a /48 block of ip addresses from HE.Net's Tunnelbroker, which is delivered via a GIF tunnel.</p> <p>Don't bother trying to set it up via Unifi. There is zero support.</p> <p>Info</p> <p>Although, as usual- you CAN manually add it via ssh/cli on your gateway.</p> <p>Just- don't expect it to persist.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#real-time-metrics","title":"Real time metrics","text":"<p>Info</p> <p>Unifi added Netflow recently, in Unifi Network Application 8.5.6</p> <p>This- is an issue I ran across recently when I was working on my Packet Loss issue.</p> <p>None of the data in Unifi is real-time. NONE of it.</p> <p>There is no way, you can view, anywheres near a live-traffic view for debugging and diagnosing issues. </p> <p>Sure, you can look at switch insights... But, this data is all aggregated, and does not update frequently.</p> <p></p> <p>Meanwhile, compared to my Mikrotik, which updates every piece of data in the entire interface... every half second...</p> <p>(Granted- this is a flat picture, which doesn't show updates.... But- know, those values update every half second or so.)</p> <p></p> <p>The best option you have, for getting any form of \"Useful\" diagnostics from Unifi- is by using a monitoring tool... Nagios, Zabbix, LibreNMS, etc.</p> <p></p> <p>Honestly, I am not kidding. I have to use a 3rd party tool to get any USEFUL metrics from Unifi.</p> <p>Going back to my Packet Loss issue, One of the items I had to do for troubleshooting, was to look for STP issues, Packet drops, and delay issues.</p> <p>So, Mikrotik RouterOS makes it easy to view TX/RX drops...</p> <p></p> <p>Mikrotik's SwOS also makes it easy to view Drops/Pauses/Issues.</p> <p></p> <p>So, one would think, it shouldn't be hard to do via Unifi, right?</p> <p>Well, the ONLY stats I can find in Unifi for packet issues, is when I click one of my APs from the Port Insights Page. And- it gives excellent information.</p> <p>Info</p> <p>After some googling, I did manage to find where switch-port interface stats are, at least for tx/rx drops.</p> <p></p> <p>Turns out- the feature DOES exist. Port Insights, Top right, Enable the columns.</p> <p></p> <p>Oddly enough those, this is the only location I can find the view the stats. You cannot just click on a device and see the packet drops/pauses.</p> <p>Still- there isn't a display to show paused packets.</p> <p>If, you drop to a CLI, you can see TONS of useful information. Just- not on the GUI.</p> <p>UXG-Lite:</p> <pre><code>root@UniFiNext-GenGatewayLite:/var/log# netstat --statistics\nIp:\n    Forwarding: 1\n    3785691 total packets received\n    3032238 forwarded\n    0 incoming packets discarded\n    729421 incoming packets delivered\n    3810233 requests sent out\n    33 outgoing packets dropped\n    10 dropped because of missing route\nIcmp:\n    66129 ICMP messages received\n    16 input ICMP message failed\n    ICMP input histogram:\n        destination unreachable: 218\n        echo requests: 23591\n        echo replies: 42320\n    70112 ICMP messages sent\n    0 ICMP messages failed\n    ICMP output histogram:\n        destination unreachable: 4129\n        redirect: 17\n        echo requests: 42375\n        echo replies: 23591\nIcmpMsg:\n        InType0: 42320\n        InType3: 218\n        InType8: 23591\n        OutType0: 23591\n        OutType3: 4129\n        OutType5: 17\n        OutType8: 42375\nTcp:\n    18429 active connection openings\n    8005 passive connection openings\n    9153 failed connection attempts\n    9 connection resets received\n    3 connections established\n    587307 segments received\n    595567 segments sent out\n    74 segments retransmitted\n    0 bad segments received\n    9368 resets sent\nUdp:\n    45904 packets received\n    4239 packets to unknown port received\n    0 packet receive errors\n    123152 packets sent\n    0 receive buffer errors\n    0 send buffer errors\n    IgnoredMulti: 27650\nUdpLite:\nTcpExt:\n    8799 TCP sockets finished time wait in fast timer\n    15497 delayed acks sent\n    1619 delayed acks further delayed because of locked socket\n    Quick ack mode was activated 29 times\n    1282 packets directly queued to recvmsg prequeue\n    TCPDirectCopyFromPrequeue: 4460\n    214851 packet headers predicted\n    116260 acknowledgments not containing data payload received\n    123131 predicted acknowledgments\n    TCPTimeouts: 26\n    TCPLossProbes: 27\n    TCPDSACKOldSent: 29\n    TCPDSACKRecv: 25\n    1 connections reset due to early user close\n    1 connections aborted due to timeout\n    TCPDSACKIgnoredNoUndo: 17\n    IPReversePathFilter: 343\n    TCPRetransFail: 3\n    TCPRcvCoalesce: 12421\n    TCPOFOQueue: 136\n    TCPSpuriousRtxHostQueues: 16\n    TCPAutoCorking: 2132\n    TCPSynRetrans: 49\n    TCPOrigDataSent: 342918\n    TCPHystartTrainDetect: 4\n    TCPHystartTrainCwnd: 64\n    TCPACKSkippedSeq: 3\n    TCPKeepAlive: 79\nIpExt:\n    InNoRoutes: 2682\n    InMcastPkts: 2450\n    OutMcastPkts: 6852\n    InBcastPkts: 32217\n    OutBcastPkts: 4406\n    InOctets: 2409440431\n    OutOctets: 4166885278\n    InMcastOctets: 168688\n    OutMcastOctets: 310328\n    InBcastOctets: 2731381\n    OutBcastOctets: 146366\n    InNoECTPkts: 3957265\n    InECT1Pkts: 9\n    InECT0Pkts: 3646\n</code></pre> <p>USW-PRO-24 (via CLI)</p> <p>Again, TONS of information to see here.</p> <pre><code>(UBNT) #show interface ethernet 0/1\n\nTotal Packets Received (Octets)................ 4738969822\nPackets Received 64 Octets..................... 19047\nPackets Received 65-127 Octets................. 1118147\nPackets Received 128-255 Octets................ 212154\nPackets Received 256-511 Octets................ 274117\nPackets Received 512-1023 Octets............... 99508\nPackets Received 1024-1518 Octets.............. 2382400\nPackets Received 1519-2047 Octets.............. 680274\nPackets Received 2048-4095 Octets.............. 0\nPackets Received 4096-9216 Octets.............. 0\nGood Packets Received &gt; 1518 Octets............ 680274\nPackets RX and TX 64 Octets.................... 315750\nPackets RX and TX 65-127 Octets................ 1822694\nPackets RX and TX 128-255 Octets............... 398190\nPackets RX and TX 256-511 Octets............... 348459\nPackets RX and TX 512-1023 Octets.............. 163115\nPackets RX and TX 1024-1518 Octets............. 2960678\nPackets RX and TX 1519-2047 Octets............. 0\nPackets RX and TX 2048-4095 Octets............. 0\nPackets RX and TX 4096-9216 Octets............. 0\n\nTotal Packets Received Without Errors.......... 4785647\nUnicast Packets Received....................... 4777342\nMulticast Packets Received..................... 4758\nBroadcast Packets Received..................... 3547\n\nReceive Packets Discarded...................... 6\n\nTotal Packets Received with MAC Errors......... 0\nJabbers Received............................... 0\nFragments Received............................. 0\nUndersize Received............................. 0\nAlignment Errors Received...................... 0\nFCS Errors Received............................ 0\nOverruns Received.............................. 0\nURPF Discards.................................. 0\n\nTotal Received Packets Not Forwarded........... 6\n802.3x Pause Frames Received................... 0\nUnacceptable Frame Type........................ 6\n\nTotal Packets Transmitted (Octets)............. 9651421756\nPackets Transmitted 64 Octets.................. 296703\nPackets Transmitted 65-127 Octets.............. 704547\nPackets Transmitted 128-255 Octets............. 186036\nPackets Transmitted 256-511 Octets............. 74342\nPackets Transmitted 512-1023 Octets............ 63607\nPackets Transmitted 1024-1518 Octets........... 578278\nPackets Transmitted &gt; 1518 Octets.............. 5671553\nMax Frame Size................................. 1518\nMaximum Transmit Unit.......................... 1500\n\nTotal Packets Transmitted Successfully......... 7575066\nUnicast Packets Transmitted.................... 7561291\nMulticast Packets Transmitted.................. 2281\nBroadcast Packets Transmitted.................. 11494\n\nTransmit Packets Discarded..................... 1\n\nTotal Transmit Errors.......................... 0\nFCS Errors Transmitted......................... 0\nTransmit errors................................ 0\nJabbers Transmitted............................ 0\n\nTotal Transmit Packets Discarded............... 0\nSingle Collision Frames........................ 0\nMultiple Collision Frames...................... 0\nExcessive Collision Frames..................... 0\n\n802.3x Pause Frames Transmitted................ 0\nGVRP PDUs received............................. 0\nGVRP PDUs Transmitted.......................... 0\nGVRP Failed Registrations...................... 0\nGMRP PDUs Received............................. 0\nGMRP PDUs Transmitted.......................... 0\nGMRP Failed Registrations...................... 0\n\nSTP BPDUs Transmitted.......................... 0\nSTP BPDUs Received............................. 0\nRSTP BPDUs Transmitted......................... 0\nRSTP BPDUs Received............................ 0\nMSTP BPDUs Transmitted......................... 0\nMSTP BPDUs Received............................ 0\nSSTP BPDUs Transmitted......................... 0\nSSTP BPDUs Received............................ 0\n\nEAPOL Frames Transmitted....................... 0\nEAPOL Start Frames Received.................... 0\n\nLoad Interval.................................. 300\nBits Per Second Received....................... 6714128\nBits Per Second Transmitted.................... 16502240\nPackets Per Second Received.................... 928\nPackets Per Second Transmitted................. 1589\nPercent Utilization Received................... 0%\nPercent Utilization Transmitted................ 1%\n\nTime Since Counters Last Cleared............... 0 day 1 hr 37 min 35 sec\n\n(UBNT) #\n</code></pre>","tags":["Networking/Unifi"]},{"location":"blog/2024/rant-unifi-layer-3/#routing-bgpospfetc","title":"Routing - BGP/OSPF/etc.","text":"<p>Info</p> <p>Note- BGP routing WAS added recently. However, it is only supported for \"Enterprise\" gateways.</p> <p>BGP was added in Unifi Network Application release 8.2.93</p> <p>Unifi DID recently release OSPF routing.</p> <p>And, while its a very basic implementation, it does work, mostly.</p> <p>But, it does NOT support the layer 3 switches, which is a shame as any routes you are passing back to Unifi, will route through your gateway, instead of your 10G layer 3 unifi switch.</p> <p>If- this was supported on the Layer 3 switches, I don't think this post would have even been written, let alone published.</p> <p>BGP- Supposedly- BGP is coming in a future update. </p> <p>Source</p> <p>Addition of the BGP Dynamic Routing Protocol is scheduled for an upcoming release.</p> <p>My complaint here, It took nearly a decade before we got support for a single dynamic routing protocol.</p>","tags":["Networking/Unifi"]},{"location":"blog/2024/synology-multipath/","title":"Synology Multipath SMB, and iSCSI","text":"<p>So... normally when you want faster networking, you can just upgrade to faster NICs (10g, 25, 40, 50, 100g.. etc...).</p> <p>However, in the case of my Synology DS423+, you get, two 1G ethernet ports with no expansion.</p> <p>You would think the best course of action, would be to leverage LACP- however that is NOT the case.</p> <p>Enabling Multichannel can double the amount of bandwidth per client, where as LACP, depending on hashing, only gives benefit up to the performance of one port.</p> <p>This post details how to enable multipath for SMB, and how to configure iSCSI on linux with multiple paths.</p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#why","title":"WHY?","text":"<p>LACP isn't perfect. With LACP, a single client's connection is typically limited to the maximum throughput of a single NIC, regardless of how many NICs you have.</p> <p>There are settings you can change and tweak with LACP to help mitigate this problem, HOWEVER, enable multipathing is far easier, and from my testing, is EXTREMELY effective at maximizing the amount of throughput.</p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#synology-network-configuration","title":"Synology Network Configuration","text":"<p>If, you previously had a LACP/LAGG group configured, delete it. </p> <p>Give each interface its own IP address.</p> <p></p> <p>Once you have done this, the steps are down below for individual protocols.</p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#smb-cifs","title":"SMB / CIFS","text":"","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#synology-configuration","title":"Synology Configuration","text":"<p>Enabling SMB multi-channel on the Synology, is... pretty effortless.</p> <p>Navigate to <code>Control Panel -&gt; File Sharing -&gt; File Services -&gt; SMB</code></p> <p></p> <p>Click on \"Advanced Settings\"</p> <p>Goto the \"Others\" tab.</p> <p>Enable <code>SMB3 Multichannel</code></p> <p></p> <p>Thats it. Your done.</p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#testing-from-windows","title":"Testing from Windows","text":"<p>From my windows test-PC, ZERO configuration was needed to take advantage.</p> <p>Without changing anything- just copying a file was now running close to 200MB/s</p> <p></p> <p></p> <p>The MAXIMUM transfer speed for a single 1G NIC, is around 120MB/s, and realistically, you will hit 110MB/s if everything is perfect.</p> <p>For this test, I didn't tune anything. I enabled multichannel, and ran benchmarks. There is no jumbo frames, no tuning, etc... as well, my 4-disk array has encryption enabled... which takes a pretty heavy toll on its tiny processor.</p> <p></p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#results-success","title":"Results? Success","text":"<p>With only selecting a single checkbox, I was able to basically double the performance of SMB shares. </p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#iscsi","title":"iSCSI","text":"","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#synology-configuration_1","title":"Synology Configuration","text":"<p>iSCSI, is a bit more involved then a single checkbox.</p> <ol> <li>Goto the \"SAN Manager\" application</li> <li>Goto the \"iSCSI\" tab. </li> <li>Edit your portal, and ensure both network interfaces are selected.</li> </ol> <p></p> <ol> <li>Under advanced tab, you need to Allow Multiple Sessions.</li> </ol> <p></p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#linux-configuration","title":"Linux Configuration","text":"<p>Info</p> <p>If you already had iSCSI running, you will need to remove the lines from <code>/etc/fstab</code>, unmount it, and log out of the portal before following these steps.</p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#installing-packages","title":"Installing packages","text":"<p>First- we need to install a few things.</p> <p><code>apt-get install multipath-tools open-iscsi</code></p> <ol> <li>open-iscsi - This allows us to connect to an iscsi target.</li> <li>multipath-tools - This manages the multipathing.</li> </ol> <p>After these packages are install, lets enable the units.</p> <pre><code>systemctl enable iscsid\n</code></pre> <p>This, will allow them to start at boot.</p> <pre><code>root@network-test:~# systemctl enable iscsid\nSynchronizing state of iscsid.service with SysV service script with /lib/systemd/systemd-sysv-install.\nExecuting: /lib/systemd/systemd-sysv-install enable iscsid\nCreated symlink /etc/systemd/system/sysinit.target.wants/iscsid.service \u2192 /lib/systemd/system/iscsid.service.\nroot@network-test:~# systemctl enable multipath-tools\nSynchronizing state of multipath-tools.service with SysV service script with /lib/systemd/systemd-sysv-install.\nExecuting: /lib/systemd/systemd-sysv-install enable multipath-tools\nFailed to enable unit: Refusing to operate on alias name or linked unit file: multipath-tools.service\n</code></pre> <p>Make sure both are running.</p> <pre><code>root@network-test:~# systemctl status multipath-tools\n\u25cf multipathd.service - Device-Mapper Multipath Device Controller\n     Loaded: loaded (/lib/systemd/system/multipathd.service; enabled; preset: enabled)\n     Active: active (running) since Tue 2024-07-23 01:54:37 UTC; 2min 3s ago\nTriggeredBy: \u25cb multipathd.socket\n   Main PID: 2048 (multipathd)\n     Status: \"up\"\n      Tasks: 7\n     Memory: 19.4M\n        CPU: 89ms\n     CGroup: /system.slice/multipathd.service\n             \u2514\u25002048 /sbin/multipathd -d -s\n\nJul 23 01:54:37 network-test systemd[1]: Starting multipathd.service - Device-Mapper Multipath Device Controller...\nJul 23 01:54:37 network-test multipathd[2048]: multipathd v0.9.4: start up\nJul 23 01:54:37 network-test multipathd[2048]: reconfigure: setting up paths and maps\nJul 23 01:54:37 network-test systemd[1]: Started multipathd.service - Device-Mapper Multipath Device Controller.\nroot@network-test:~# systemctl status iscsid\n\u25cb iscsid.service - iSCSI initiator daemon (iscsid)\n     Loaded: loaded (/lib/systemd/system/iscsid.service; enabled; preset: enabled)\n     Active: inactive (dead)\nTriggeredBy: \u25cf iscsid.socket\n       Docs: man:iscsid(8)\nroot@network-test:~#\n</code></pre>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#configure-iscsid-to-start-at-boot","title":"Configure iSCSId to start at boot","text":"<p>Info</p> <p>If- you forget this step, your mounts will not be automatically mounted after a reboot!</p> <p>To automatically start iSCSI at boot, we need to edit <code>/etc/iscsi/iscsid.conf</code></p> <p>and change <code>node.startup = manual</code> to <code>node.startup = automatic</code></p> <p>Here- is a single command to update the file for you.</p> <p><code>sudo sed -i 's/^#*\\s*node.startup\\s*=\\s*manual/node.startup = automatic/' /etc/iscsi/iscsid.conf</code></p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#connecting-to-iscsi","title":"Connecting to iSCSI","text":"<p>Next- lets discover the LUNs available to us.</p> <p>Run <code>iscsiadm -m discovery -t st -p YOUR_IP_HERE</code> against each of the IPs on your Synology.</p> <pre><code>root@network-test:~# iscsiadm -m discovery -t st -p 10.100.4.25\n10.100.4.25:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70\n10.100.4.26:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70\nroot@network-test:~# iscsiadm -m discovery -t st -p 10.100.4.26\n10.100.4.25:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70\n10.100.4.26:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70\n</code></pre> <p>Next, lets log into both targets using <code>iscsiadm -m node -T YOUR WWN HERE -p YOUR_IP_HERE --login</code></p> <p>The WWN, is the piece which looks like this: <code>iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70</code></p> <pre><code>root@network-test:~# iscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.25 --login\nLogging in to [iface: default, target: iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70, portal: 10.100.4.25,3260]\nLogin to [iface: default, target: iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70, portal: 10.100.4.25,3260] successful.\nroot@network-test:~# iscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.26 --login\nLogging in to [iface: default, target: iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70, portal: 10.100.4.26,3260]\nLogin to [iface: default, target: iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70, portal: 10.100.4.26,3260] successful.\n</code></pre> <p>The commands for each of the interface addresses should return successful.</p> <p>IF, you run into this error, its because you didn't enable the \"Allow multiple sessions\" checkbox on your portal. Go back to the synology and check it.</p> <pre><code>iscsiadm: Could not login to [iface: default, target: iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70, portal: 10.100.4.26,3260].\niscsiadm: initiator reported error (19 - encountered non-retryable iSCSI login failure)\niscsiadm: Could not log into all portals\n</code></pre> <p>Finally, flag the connections to autostart.</p> <pre><code>root@network-test:~# iscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.25 --op=update -n node.startup -v automatic\nroot@network-test:~# iscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.26 --op=update -n node.startup -v automatic\n</code></pre> <p>Here are all of the commands used in this section:</p> <pre><code># Discover targets.\niscsiadm -m discovery -t st -p 10.100.4.25\n\n# Connect to both targets.\niscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.25 --login\niscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.26 --login\n\n# Set targets to automatically start.\niscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.25 --op=update -n node.startup -v automatic\niscsiadm -m node -T iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 -p 10.100.4.26 --op=update -n node.startup -v automatic\n</code></pre>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#configuring-multipath","title":"Configuring Multipath","text":"<p>At this point, if you run <code>lsblk</code>, you will notice there are TWO devices showing for this LUN.</p> <pre><code>root@network-test:~# lsblk\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsda       8:0    0   20G  0 disk   &lt;-- One here\nsdb       8:16   0   20G  0 disk   &lt;-- One here too!\nsr0      11:0    1    4M  0 rom\nvda     254:0    0   16G  0 disk\n\u251c\u2500vda1  254:1    0 15.9G  0 part /\n\u251c\u2500vda14 254:14   0    3M  0 part\n\u2514\u2500vda15 254:15   0  124M  0 part /boot/efi\n</code></pre> <p>If, you attempt to use both, there is a good chance you can corrupt the LUN. Instead, we need to configure multipath now.</p> <p>Lets go ahead and get the WWNs for our lun with this command: <code>udevadm info --query=all --name=/dev/sda | grep 'ID_WWN'</code></p> <p>The WWN SHOULD be the same for both. The <code>ID_WWN</code> is what we are interested in.</p> <pre><code>root@network-test:~# udevadm info --query=all --name=/dev/sda | grep 'ID_WWN'\nE: ID_WWN_WITH_EXTENSION=0x600140551aa592fd025ed4ef1da523db\nE: ID_WWN=0x600140551aa592fd\nroot@network-test:~# udevadm info --query=all --name=/dev/sdb | grep 'ID_WWN'\nE: ID_WWN_WITH_EXTENSION=0x600140551aa592fd025ed4ef1da523db\nE: ID_WWN=0x600140551aa592fd\n</code></pre> <p>Lets make a new multipath configuration file. </p> <p><code>nano /etc/multpath.conf</code></p> <p>Make sure to update the wwid, to YOUR WWN.</p> <p>Info</p> <p>If you forget, or neglect to correctly set the multipaths, you will be limited to the speed of a single connection.</p> /etc/multpath.conf<pre><code>defaults {\n    user_friendly_names yes\n    find_multipaths yes\n}\n\nblacklist {\n    devnode \"^vda\"\n}\n\nmultipaths {\n    multipath {\n        wwid \"3600140551aa592fd025ed4ef1da523db\"\n        alias mpath0\n    }\n}\n</code></pre> <p>After creating the above file, we need to restart multipath, using <code>systemctl restart multipath-tools</code></p> <p>After this is done, you can now see the multiple paths, using <code>multipath -ll</code>, and lsblk will show the new device.</p> <pre><code>root@network-test:~# systemctl restart multipath-tools\nroot@network-test:~# multipath -ll\nmpatha (3600140551aa592fd025ed4ef1da523db) dm-0 SYNOLOGY,Storage\nsize=20G features='0' hwhandler='1 alua' wp=rw\n|-+- policy='service-time 0' prio=50 status=active\n| `- 2:0:0:1 sda 8:0  active ready running\n`-+- policy='service-time 0' prio=50 status=enabled\n  `- 3:0:0:1 sdb 8:16 active ready running\nroot@network-test:~# lsblk\nNAME     MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINTS\nsda        8:0    0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath\nsdb        8:16   0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath\nsr0       11:0    1    4M  0 rom\nvda      254:0    0   16G  0 disk\n\u251c\u2500vda1   254:1    0 15.9G  0 part  /\n\u251c\u2500vda14  254:14   0    3M  0 part\n\u2514\u2500vda15  254:15   0  124M  0 part  /boot/efi\nroot@network-test:~#\n</code></pre>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#formatting-new-mount","title":"Formatting new mount.","text":"<p>(If- you are trying to enable multipath on an existing LUN, you should prob skip this step....)</p> <p>Format the new mount using <code>mkfs.ext4 /dev/mapper/mpatha</code></p> <pre><code>root@network-test:~# mkfs.ext4 /dev/mapper/mpatha\nmke2fs 1.47.0 (5-Feb-2023)\nDiscarding device blocks: done\nCreating filesystem with 5242880 4k blocks and 1310720 inodes\nFilesystem UUID: 199858b0-e453-4e00-8905-d9bcbe892da9\nSuperblock backups stored on blocks:\n        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,\n        4096000\n\nAllocating group tables: done\nWriting inode tables: done\nCreating journal (32768 blocks): done\nWriting superblocks and filesystem accounting information: done\n</code></pre> <p>For this guide, we will be mounting this drive at <code>/mnt/multipath</code>. Go ahead and create an empty directory there.</p> <p><code>mkdir /mnt/multipath</code></p>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#mount-at-boot","title":"Mount at boot","text":"<p>To automatically mount this new partition, we will edit <code>/etc/fstab</code>, and add <code>/dev/mapper/mpatha /mnt/multipath ext4 _netdev 0 2</code></p> <pre><code>root@network-test:~# echo \"/dev/mapper/mpatha /mnt/multipath ext4 _netdev 0 2\" | sudo tee -a /etc/fstab\n/dev/mapper/mpatha /mnt/multipath ext4 _netdev 0 2\n\nroot@network-test:~# cat /etc/fstab\nPARTUUID=83c1818a-868c-4c97-832b-8195e4257804 / ext4 rw,discard,errors=remount-ro,x-systemd.growfs 0 1\nPARTUUID=d6f6a0fe-5811-483b-a7a5-a6bf5b6372e5 /boot/efi vfat defaults 0 0\n/dev/mapper/mpatha /mnt/multipath ext4 _netdev 0 2\n</code></pre> <p>After updating this file, run <code>systemctl daemon-reload</code></p> <p>Next, lets mount everything in <code>/etc/fstab</code>, using <code>mount -a</code>. After mounting, you should see the new LUN/Partition is now mounted.</p> <pre><code>root@network-test:~# mount -a\nroot@network-test:~# lsblk\nNAME     MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINTS\nsda        8:0    0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath /mnt/multipath\nsdb        8:16   0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath /mnt/multipath\nsr0       11:0    1    4M  0 rom\nvda      254:0    0   16G  0 disk\n\u251c\u2500vda1   254:1    0 15.9G  0 part  /\n\u251c\u2500vda14  254:14   0    3M  0 part\n\u2514\u2500vda15  254:15   0  124M  0 part  /boot/efi\n</code></pre> <p>Thats, mostly it. I would recommend a reboot at this point, just to ensure it automatically remounts as expected.</p> <pre><code>root@network-test:~# reboot\n</code></pre> <p>If, after a reboot, <code>lsblk</code> does not show the partitions, please address the issue. The \"Configure iSCSId to start at boot\" section above configures this.</p> <p>You can use <code>iscsiadm -m session -o show</code> to determine if you have active sessions.</p> <p>If- after your reboot- everything looks like this, you are good to go!</p> <pre><code>Last login: Tue Jul 23 02:30:50 2024 from 10.100.64.2\nroot@network-test:~# lsblk\nNAME     MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINTS\nsda        8:0    0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath /mnt/multipath\nsdb        8:16   0   20G  0 disk\n\u2514\u2500mpatha 253:0    0   20G  0 mpath /mnt/multipath\nsr0       11:0    1    4M  0 rom\nvda      254:0    0   16G  0 disk\n\u251c\u2500vda1   254:1    0 15.9G  0 part  /\n\u251c\u2500vda14  254:14   0    3M  0 part\n\u2514\u2500vda15  254:15   0  124M  0 part  /boot/efi\nroot@network-test:~# iscsiadm -m session -o show\ntcp: [1] 10.100.4.25:3260,1 iqn.2000-01.com.synology:NAS-2.PBS.8e935d09c70 (non-flash)\ntcp: [2] 10.100.4.26:3260,1 iqn.2000-01.com.synology:NAS-2.PBS.8e935d09c70 (non-flash)\ntcp: [3] 10.100.4.26:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 (non-flash)\ntcp: [4] 10.100.4.25:3260,1 iqn.2000-01.com.synology:NAS-2.TestTarget.8e935d09c70 (non-flash)\nroot@network-test:~# multipath -ll\nmpatha (3600140551aa592fd025ed4ef1da523db) dm-0 SYNOLOGY,Storage\nsize=20G features='0' hwhandler='1 alua' wp=rw\n|-+- policy='service-time 0' prio=50 status=active\n| `- 4:0:0:1 sda 8:0  active ready running\n`-+- policy='service-time 0' prio=50 status=enabled\n  `- 5:0:0:1 sdb 8:16 active ready running\nroot@network-test:~#\n</code></pre>","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/synology-multipath/#performance-testing","title":"Performance Testing","text":"<p>A quick performance test with <code>fio</code></p> <p>Command Used: <code>fio --name=seq_read_test --directory=/mnt/multipath --rw=read --bs=1M --size=1G --numjobs=1 --time_based --runtime=60 --group_reporting --ioengine=libaio --direct=1</code></p> <pre><code>root@network-test:~# apt-get install fio\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nfio is already the newest version (3.33-3).\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\nroot@network-test:~# fio --name=seq_read_test --directory=/mnt/multipath --rw=read --bs=1M --size=1G --numjobs=1 --time_based --runtime=60 --group_reporting --ioengine=libaio --direct=1\nseq_read_test: (g=0): rw=read, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=1\nfio-3.33\nStarting 1 process\nseq_read_test: Laying out IO file (1 file / 1024MiB)\nJobs: 1 (f=0): [f(1)][100.0%][r=101MiB/s][r=101 IOPS][eta 00m:00s]\nseq_read_test: (groupid=0, jobs=1): err= 0: pid=610: Tue Jul 23 02:40:09 2024\n  read: IOPS=101, BW=102MiB/s (107MB/s)(6114MiB/60007msec)\n    slat (usec): min=34, max=467, avg=67.39, stdev=30.11\n    clat (usec): min=9459, max=13308, avg=9742.25, stdev=184.59\n     lat (usec): min=9516, max=13358, avg=9809.64, stdev=201.90\n    clat percentiles (usec):\n     |  1.00th=[ 9503],  5.00th=[ 9634], 10.00th=[ 9634], 20.00th=[ 9634],\n     | 30.00th=[ 9634], 40.00th=[ 9634], 50.00th=[ 9765], 60.00th=[ 9765],\n     | 70.00th=[ 9765], 80.00th=[ 9765], 90.00th=[ 9896], 95.00th=[10028],\n     | 99.00th=[10421], 99.50th=[10683], 99.90th=[11731], 99.95th=[12256],\n     | 99.99th=[13304]\n   bw (  KiB/s): min=100352, max=106709, per=100.00%, avg=104412.78, stdev=1260.34, samples=119\n   iops        : min=   98, max=  104, avg=101.92, stdev= 1.23, samples=119\n  lat (msec)   : 10=94.29%, 20=5.71%\n  cpu          : usr=0.14%, sys=0.87%, ctx=6141, majf=0, minf=266\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     issued rwts: total=6114,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\n   READ: bw=102MiB/s (107MB/s), 102MiB/s-102MiB/s (107MB/s-107MB/s), io=6114MiB (6411MB), run=60007-60007msec\n\nDisk stats (read/write):\n    dm-0: ios=6090/4, merge=0/1, ticks=59297/16, in_queue=59322, util=98.96%, aggrios=3057/2, aggrmerge=0/0, aggrticks=29731/3, aggrin_queue=29734, aggrutil=98.60%\n  sdb: ios=0/0, merge=0/0, ticks=0/0, in_queue=0, util=0.00%\n  sda: ios=6115/4, merge=0/0, ticks=59462/7, in_queue=59468, util=98.60%\n</code></pre> <p>102MiB/s, that is only a single connection! If your results resemble this, you did not correctly configure <code>/etc/multipath.conf</code></p> <p>In my case, it was because I forgot to add the <code>multipaths</code> section to <code>/etc/multipath.conf</code>. </p> <p>The benefit of reading my post- I have already went back up and added all of the wonderful steps that were missing before you got a chance to read it!</p> <p>AFTER fixing <code>/etc/multipath.conf</code>, a VERY respectable 240MB/s. This is perfectly saturating both gigabit ports.</p> <pre><code>root@network-test:~# fio --name=seq_read_test --directory=/mnt/multipath --rw=read --bs=1M --size=1G --numjobs=1 --time_based --runtime=60 --group_reporting --ioengine=libaio --direct=1\nseq_read_test: (g=0): rw=read, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=1\nfio-3.33\nStarting 1 process\nseq_read_test: Laying out IO file (1 file / 1024MiB)\nJobs: 1 (f=1): [R(1)][100.0%][r=266MiB/s][r=266 IOPS][eta 00m:00s]\nseq_read_test: (groupid=0, jobs=1): err= 0: pid=577: Tue Jul 23 02:50:39 2024\n  read: IOPS=228, BW=229MiB/s (240MB/s)(13.4GiB/60003msec)\n    slat (usec): min=25, max=1448, avg=66.48, stdev=47.39\n    clat (usec): min=2458, max=50851, avg=4302.45, stdev=2230.52\n     lat (usec): min=2485, max=50990, avg=4368.93, stdev=2245.90\n    clat percentiles (usec):\n     |  1.00th=[ 2802],  5.00th=[ 2999], 10.00th=[ 3097], 20.00th=[ 3261],\n     | 30.00th=[ 3392], 40.00th=[ 3556], 50.00th=[ 3720], 60.00th=[ 3982],\n     | 70.00th=[ 4490], 80.00th=[ 5080], 90.00th=[ 5800], 95.00th=[ 6521],\n     | 99.00th=[ 9765], 99.50th=[19530], 99.90th=[34341], 99.95th=[43254],\n     | 99.99th=[50070]\n   bw (  KiB/s): min=141312, max=292864, per=100.00%, avg=234281.77, stdev=35620.16, samples=120\n   iops        : min=  138, max=  286, avg=228.59, stdev=34.78, samples=120\n  lat (msec)   : 4=60.57%, 10=38.46%, 20=0.49%, 50=0.47%, 100=0.01%\n  cpu          : usr=0.52%, sys=2.22%, ctx=13754, majf=0, minf=267\n  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n     issued rwts: total=13717,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n     latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\n   READ: bw=229MiB/s (240MB/s), 229MiB/s-229MiB/s (240MB/s-240MB/s), io=13.4GiB (14.4GB), run=60003-60003msec\n\nDisk stats (read/write):\n  vda: ios=13803/146, merge=0/40, ticks=59027/59, in_queue=59124, util=97.39%\nroot@network-test:~#\n</code></pre> Metric Value Read IOPS 228 Read Bandwidth 229 MiB/s (240 MB/s) Total Read 13.4 GiB (14.4 GB) Test Duration 60003 ms Bandwidth (min) 141312 KiB/s Bandwidth (max) 292864 KiB/s Bandwidth (avg) 234281.77 KiB/s Bandwidth (stdev) 35620.16 KiB/s CPU Usage (user) 0.52% CPU Usage (sys) 2.22% Context Switches 13754 IO Depth 1 Disk Utilization 97.39%","tags":["Homelab","Storage/Synology"]},{"location":"blog/2024/unifi---debugging-ddns/","title":"Debugging DDNS for Unifi","text":"<p>This is a very short post on how to debug DDNS for Unifi.</p>","tags":["Homelab","Networking/Unifi"]},{"location":"blog/2024/unifi---debugging-ddns/#the-issue","title":"The issue","text":"<p>The reason this guide is being published- is because Unifi will give you no hints, or indications of any issues with your DDNS configuration via the User Interface.</p> <p>Instead, you get a simple interface, which just displays your configured providers.</p> <p></p> <p>These, items will give you no indication if they are working, failing, etc.</p>","tags":["Homelab","Networking/Unifi"]},{"location":"blog/2024/unifi---debugging-ddns/#how-to-tell-if-its-broken","title":"How to tell if its broken?","text":"<p>The only way I have found so far, other then looking at the DDNS provider, is by either looking at <code>/var/log/messages</code> on the Unifi Gateway, or running the ddns-update command (Explained further below).</p> <p>Just- log into the gateway, and run this command: <code>tail -n 100 -f messages</code></p> <p>If- you have an issue, you will notice something along these lines:</p> <pre><code>&lt;/html&gt;\n2024-07-22T14:20:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:22:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:24:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:24:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:24:53-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:24:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:24:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:24:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:26:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:26:57-05:00 UniFiNext-GenGatewayLite mca-ctrl[554774]: mca-ctrl[554774]: mca-proto.service_json(): failed to contact mcad\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:28:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:30:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:30:54-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:30:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:30:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:30:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:30:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:32:43-05:00 UniFiNext-GenGatewayLite syslog-ng[76927]: Syslog connection broken; fd='12', server='AF_INET(10.100.7.254:5514)', time_reopen='60'\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n2024-07-22T14:32:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Error response from DDNS server, ignoring ...\n2024-07-22T14:34:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias HE.NET, new IP# 1.2.3.4\n2024-07-22T14:34:55-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Update forced for alias My-DDNS.no-ip.com, new IP# 1.2.3.4\n2024-07-22T14:34:56-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Updating cache for HE.NET\n2024-07-22T14:34:56-05:00 UniFiNext-GenGatewayLite inadyn[2007]: Fatal error in DDNS server response:\n2024-07-22T14:34:56-05:00 UniFiNext-GenGatewayLite inadyn[2007]: [400 Bad Request] &lt;html&gt;\n&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\n</code></pre> <p>Warning</p> <p>As a warning- Unifi does not have sane retry logic.</p> <p>If your provider is failing, It will retry every two minutes.</p> <p>If, uncaught, your gateway can literally spend months, spamming the upstream provider with bad DDNS requests.</p>","tags":["Homelab","Networking/Unifi"]},{"location":"blog/2024/unifi---debugging-ddns/#how-to-debug","title":"How to debug","text":"<p>Debugging, is actually pretty simple. The first thing we need to do, is determine where the configuration file is.</p> <p>You can do this by checking the running processes arguments by using: <code>ps aux | grep inadyn</code></p> <p>The piece we need, is the path.</p> <pre><code>root@UniFiNext-GenGatewayLite:/var/log# ps aux | grep inadyn\nroot      564878  0.0  0.5   6636  5192 ?        S&lt;   14:43   0:00 /usr/sbin/inadyn -n -s -C -f /run/ddns-ppp0-inadyn.conf\nroot      569939  0.0  0.0   4796   648 pts/0    S+   14:51   0:00 grep --color inadyn\n</code></pre> <p>We specifically need the configuration file, which in the above example is <code>/run/ddns-ppp0-inadyn.conf</code></p> <p>Afterwards, you can run the DDNS client manually using <code>inadyn -n -1 --force -f /run/YOUR_CONFIGURE_PATH_HERE.conf</code> </p> Running inadyn without debug<pre><code>root@UniFiNext-GenGatewayLite:/var/log# inadyn -n -1 --force -f /run/ddns-ppp0-inadyn.conf\ninadyn[575347]: In-a-dyn version 2.9.1 -- Dynamic DNS update client.\ninadyn[575347]: Guessing DDNS plugin 'default@no-ip.com' from 'no-ip:2'\ninadyn[575347]: Update forced for alias HE.NET, new IP# 1.2.3.4\ninadyn[575347]: Update forced for alias all.ddnskey.com, new IP# 1.2.3.4\ninadyn[575347]: Updating cache for HE.NET\ninadyn[575347]: Fatal error in DDNS server response:\ninadyn[575347]: [401 Unauthorized] badauth\ninadyn[575347]: Error response from DDNS server, exiting!\ninadyn[575347]: Error code 50: Authentication failure\n</code></pre> <p>IF, the generated logs are not descriptive enough, add <code>-l debug</code>, like so: <code>inadyn -n -1 -l debug --force -f /run/YOUR_CONFIGURE_PATH_HERE.conf</code> </p> Running inadyn with debug<pre><code>root@UniFiNext-GenGatewayLite:/var/log# inadyn -n -1 -l debug --force -f /run/ddns-ppp0-inadyn.conf\ninadyn[574090]: In-a-dyn version 2.9.1 -- Dynamic DNS update client.\ninadyn[574090]: Guessing DDNS plugin 'default@no-ip.com' from 'no-ip:2'\ninadyn[574090]: Cached IP# 1.2.3.4 for HE.NET from previous invocation.\ninadyn[574090]: Last update of HE.NET on Mon Jul 22 14:57:46 2024\ninadyn[574090]: Cached IP# 1.2.3.4 for all.ddnskey.com from previous invocation.\ninadyn[574090]: Last update of all.ddnskey.com on Mon Jul 22 14:57:46 2024\ninadyn[574090]: Get address for custom\ninadyn[574090]: Checking for IP# change, querying interface ppp0\ninadyn[574090]: Checking IPv4 address 1.2.3.4 ...\ninadyn[574090]: IPv4 address 1.2.3.4 is valid.\ninadyn[574090]: Checking IPv4 address 1.2.3.4 ...\ninadyn[574090]: IPv4 address 1.2.3.4 is valid.\ninadyn[574090]: No IP# change detected for custom, still at 1.2.3.4\ninadyn[574090]: Get address for default@no-ip.com\ninadyn[574090]: Checking for IP# change, querying interface ppp0\ninadyn[574090]: Checking IPv4 address 1.2.3.4 ...\ninadyn[574090]: IPv4 address 1.2.3.4 is valid.\ninadyn[574090]: Checking IPv4 address 1.2.3.4 ...\ninadyn[574090]: IPv4 address 1.2.3.4 is valid.\ninadyn[574090]: No IP# change detected for default@no-ip.com, still at 1.2.3.4\ninadyn[574090]: Update forced for alias HE.NET, new IP# 1.2.3.4\ninadyn[574090]: Update forced for alias all.ddnskey.com, new IP# 1.2.3.4\ninadyn[574090]: Sending IP# update to DDNS server, connecting to ipv4.tunnelbroker.net(:443)\ninadyn[574090]: Sending IP# update to DDNS server, initiating HTTPS ...\ninadyn[574090]: SSL connection using TLS_AES_256_GCM_SHA384\ninadyn[574090]: Certificate OK\ninadyn[574090]: SSL server cert subject: /CN=tunnelbroker.net\ninadyn[574090]: SSL server cert issuer: /C=US/ST=Arizona/L=Scottsdale/O=Starfield Technologies, Inc./OU=http://certs.starfieldtech.com/repository//CN=Starfield Secure Certificate Authority - G2\ninadyn[574090]: Sending alias table update to DDNS server: GET /nic/update?hostname=HE.NET HTTP/1.0\nHost: ipv4.tunnelbroker.net\nAuthorization: &lt;redacted&gt;\nUser-Agent: inadyn/2.9.1 https://github.com/troglobit/inadyn/issues\n\ninadyn[574090]: Successfully sent HTTPS request!\ninadyn[574090]: Successfully received HTTPS response (380/8191 bytes)!\ninadyn[574090]: DDNS server response: HTTP/1.0 429 NI\nDate: Mon, 22 Jul 2024 19:59:33 GMT\nServer: Apache/2.4.52 (Ubuntu)\nStrict-Transport-Security: max-age=31536000; includeSubDomains; preload\nSet-Cookie: referer=Direct%20Access; path=/; secure\nContent-Security-Policy: frame-ancestors 'self'\nX-Content-Type-Options: nosniff\nContent-Length: 6\nConnection: close\nContent-Type: text/html; charset=utf-8\n\nabuse\ninadyn[574090]: Fatal error in DDNS server response:\ninadyn[574090]: [429 NI] abuse\ninadyn[574090]: Sending IP# update to DDNS server, connecting to dynupdate.no-ip.com([158.247.7.204]:443)\ninadyn[574090]: Sending IP# update to DDNS server, initiating HTTPS ...\ninadyn[574090]: SSL connection using ECDHE-RSA-AES256-GCM-SHA384\ninadyn[574090]: Certificate OK\ninadyn[574090]: SSL server cert subject: /CN=*.no-ip.com\ninadyn[574090]: SSL server cert issuer: /C=US/O=DigiCert Inc/OU=www.digicert.com/CN=RapidSSL TLS RSA CA G1\ninadyn[574090]: Sending alias table update to DDNS server: GET /nic/update?hostname=all.ddnskey.com&amp;myip=1.2.3.4 HTTP/1.0\nHost: dynupdate.no-ip.com\nAuthorization: &lt;redacted&gt;\nUser-Agent: inadyn/2.9.1 https://github.com/troglobit/inadyn/issues\n\ninadyn[574090]: Successfully sent HTTPS request!\ninadyn[574090]: Successfully received HTTPS response (226/8191 bytes)!\ninadyn[574090]: DDNS server response: HTTP/1.1 200 OK\nServer: nginx\nContent-Type: text/plain; charset=UTF-8\nConnection: close\nCache-Control: private, must-revalidate\nDate: Mon, 22 Jul 2024 19:59:33 GMT\npragma: no-cache\nexpires: -1\n\nnochg 1.2.3.4\ninadyn[574090]: Successful alias table update for all.ddnskey.com =&gt; new IP# 1.2.3.4\ninadyn[574090]: Updating cache for all.ddnskey.com\ninadyn[574090]: Error response from DDNS server, exiting!\ninadyn[574090]: Error code 48: DDNS server response not OK\nroot@UniFiNext-GenGatewayLite:/var/log#\n</code></pre> <p>At this point, you should have plenty of details to hopefully determine the issue. </p> <p>Make your corrections to fix the issue through either the Unifi interface, or via manually editing the file (You will need to still update the unifi interface afterwards!). And- test again.</p> <pre><code>root@UniFiNext-GenGatewayLite:/var/log# inadyn -n -1 --force -f /run/ddns-ppp0-inadyn.conf\ninadyn[578851]: In-a-dyn version 2.9.1 -- Dynamic DNS update client.\ninadyn[578851]: Guessing DDNS plugin 'default@no-ip.com' from 'no-ip:2'\ninadyn[578851]: Update forced for alias HE.NET, new IP# 1.2.3.4\ninadyn[578851]: Update forced for alias all.ddnskey.com, new IP# 1.2.3.4\ninadyn[578851]: Updating cache for HE.NET\ninadyn[578851]: Updating cache for all.ddnskey.com\nroot@UniFiNext-GenGatewayLite:/var/log#\n</code></pre>","tags":["Homelab","Networking/Unifi"]},{"location":"blog/2024/metered-switch-pdu/","title":"Vertiv rPDU - A reasonably priced, 120v, individually switched and metered PDU.","text":"<p>For years- I have been using a combination of Sonoff S31 Plugs and a Kasa HS300 Strip to monitor, and measure my power consumption.</p> <p>This- allowed me to fully visualize my rack's power consumption, into a sankey diagram. </p> <p>However- the form-factor of neither solution was ideal, and as my rack has become nearly full, I needed a better solution as PDUs filled with smart-plugs, isn't exactly ideal.</p> <p>The issue is, there are not many 120v PDUs, for a 24U rack. As a matter of fact, there are not many zero-U PDUs at all for 24U racks.</p> <p>But- I finally found an option, for a fully managed PDU, with INDIVIDUALLY metered and switched outlets, which CAN<sup>2</sup> plug into a standard 120v outlet.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#the-vertiv-nu30117","title":"The Vertiv NU30117","text":"<p>So- as a warning- there is basically no public documentation I was able to find for these units. The manufacturer does not even list the datasheets anymore as these units are EOL.</p> <p>However- As I purchased a unit, racked it up, and put it into use- I will tell you- these do work, and they work quite well. </p> <p>At this time, they can be acquired for \"BRAND NEW\", in the original packaging, with the original manuals<sup>3</sup>, for 170$. However- I will also say- there are 27 units available still, and ZERO other results on eBay.</p> <p>So... if you are reading this post in one month- there is a good chance, they will all be gone.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#general-specifications","title":"General Specifications","text":"<p>Input Connection: NEMA L5-30R (120v, 30 amp locking plug) - Input connections are metered.</p> <p>Output Connections: 12x NEMA 5-20R (120v plug which supports standard 5-15R plugs, as well as 20amp 5-20R plugs.) All outputs are individually metered, and switched.</p> <p>Dimensions: 1U, rack mountable</p> <p>No licenses appear to be needed. Comes with web interface, SSH, SNMP. No additional \"cards\" needed to enable connectivity features.</p> <p>JSON WebAPI is also included.</p> <p>Has the ability to trigger outlets based on conditions.</p> <p>Dual, Redundant 100M network connections.</p> <p>Idle Consumption: 6w<sup>1</sup></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#where-can-you-get-it","title":"Where can you get it?","text":"<p>Ebay Link - Affiliated</p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p></p> <p>As of this time, this is the ONLY posting on eBay for this model. And, only a few dozen are left.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#how-to-use-it","title":"How to use it?","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#plug-adapter-converter","title":"Plug Adapter / Converter","text":"<p>Warning</p> <p>This unit uses a 30 amp plug, because this unit can pass 30 amps worth of current!</p> <p>There are always potential safety concerns when using adapters. </p> <p>However- your 15 or 20 amp breaker \"SHOULD\" be the weak-link in your circuit.</p> <p>Do at your own risk.</p> <p>You will need a special adapter to convert the NEMA L5-30R, into a standard NEMA 5-15P (or 5-20P)</p> <p>L5-30R, stands for...</p> <p>L = Locking (plug has a \"lock\", which requires it to be twisted to remove, or connect.) 5 = Number of poles. 5 specifically means, 125V with GND, HOT, Neutral. This- is the standard for circuits in North America. (5-15P, for example- is a normal outlet) - 30 = Amperage rating. 30 amps.  R = Receptacle (P = Plug)</p> <p>So, if you intend on plugging this into a standard wall-outlet, You need to an adapter from L5-30R to 5-15P</p> <p>Amazon Link - L530R to 5-15P</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#my-personal-strategy","title":"My personal strategy","text":"<p>For my personal needs- I will be cutting the code for the PDU. I plan on shortening the cable to only a few feet and installing a NEMA 5-20P.</p> <p>Amazon Link - NEMA 5-20P Connector</p> <p>My reasons for doing so-</p> <ol> <li>The included cable is much, much longer then I need.</li> <li>I plan on connecting this PDU, to a transfer switch, mounted next to the PDU. (inches away)</li> <li>I have YEARS worth of history on the exact power consumption for each element in my lab. I know my consumption will not warrant needing 30 amps of current.<ul> <li>At which point I need more then 15 amps of 120v, the next step is to run a dedicated 240v plug to my server room. 240V PSUs are typically more efficient in servers too.</li> </ul> </li> <li>The adapter linked before- has a large diameter, and is not very flexible. I need this to all fit within 2 rack units.</li> </ol>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#pictures","title":"Pictures","text":"<p>The front.</p> <p></p> <p>The rear.</p> <p></p> <p>Here- is a picture of the unit mounted in my rack. It is mounted securely on the rear of the rack in a vertical orientation. </p> <p>This, unusual mounting, is due to limited spaces in the rack, and, I want to get the mess of power cables OUT of the rack. </p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#web-interface-walkthrough","title":"Web Interface Walkthrough","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#sensors","title":"Sensors","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#sensors-overview","title":"Sensors &gt; Overview","text":"<p>Main Screen, showing connected devices, configurable labels, current, voltage, wattage.</p> <p></p> <p>Each plug, has configurable label, and mode. The PDU can enact automated actions to turn plugs on or off as needed, based on criteria you specify.</p> <p>As well- you can adjust the delay/behavior when power cycling, or rebooting.</p> <p></p> <p>For the actions for a plug- you can turn on, off, power cycle, or reset energy data. You can optionally include a delay.</p> <p></p> <p>For the circuits, and primary input, you have the ability to reset energy usage data.</p> <p>At the top/pdu level, you have a few actions for it. Reboot, Reset, Reset to defaults, etc.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#sensors-logging","title":"Sensors &gt; Logging","text":"<p>The logging tab has a few interesting features.</p> <ol> <li>Ability to export data in either JSON, or CSV format. Exported data includes basically everything seen on the main tab.</li> <li>Adjustable logging period, store data more, or less frequently.</li> <li>Ability to enable/disable logging for specific plugs.</li> </ol> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#sensors-alarms-warnings","title":"Sensors &gt; Alarms &amp; Warnings","text":"<p>For the warnings / alarms tab- there are few nice features here as well.</p> <ol> <li>You can specify alarms for plug,circuit, or pdu level, for current,voltage,status,energy, power factor, etc...</li> <li>Alarms can have a configurable time-slots.</li> <li>This- can be used to turn a plug on automatically, at certain times of day. Or, to toggle a plug based on other conditions.</li> </ol>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-tabs","title":"System Tab(s)","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-users","title":"System &gt; Users","text":"<p>For the users tab, multiple users can be specified. You can also optionally scope users access to only specific items.</p> <p>The guest account allows viewing an overview of current data, without logging in.</p> <p></p> <p>When creating users, you can specify if they are allowed to control plugs, if they have administrator rights (aka, adjust device configuration).</p> <p>And- you can optionally assign a scope which limits access to specific plugs. (These options can also be edited for existing users)</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-network","title":"System &gt; Network","text":"<p>For the networking tab- you can configure...</p> <ol> <li>the ethernet bridge (by default- both ethernet ports are bridged).</li> <li>IP Routing</li> <li>IPv4 Addresses (Multiple, are allowed)</li> <li>IPv6 Addresses (Multiple, are allowed)</li> <li>DHCP for IPv4.</li> <li>Optional RSTP for the bridge, with adjustable metric / cost.</li> <li>DNS Server(s)</li> </ol> <p>Image- Note- internal layer 2 / layer 3 addresses are removed.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-web-server","title":"System &gt; Web Server","text":"<p>For webserver options- HTTP can be enabled or disabled. HTTPs is always enabled. You can specify a SSL certificate and password for SSL.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-reporting-email","title":"System &gt; Reporting / Email","text":"<p>Interestingly, this PDU has the ability to automatically generate and email reports. The- options are not very flexible, however, still an interesting option.</p> <p></p> <p>Email Configuration:</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-authentication","title":"System &gt; Authentication","text":"<p>For external authentication, there are options to configure...</p> <ol> <li>LDAP / Active Directory</li> <li>TACACS+</li> <li>Radius</li> </ol> <p>Note- only ONE option can be selected. You can't use LDAP AND Radius, for example.</p> <p>Here- are the options-</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-display","title":"System &gt; Display","text":"<p>You have the ability to configure the display on the PDU itself. </p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-ssh","title":"System &gt; SSH","text":"<p>This unit has SSH access enabled by default. You can enable, or disable it, and change the port.</p> <p>There is no option to disallow password-login, or change any other functionality.</p> <p></p> <p>If you use key-based authentication, configure public keys in the user's tab.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-snmp","title":"System &gt; SNMP","text":"<p>The SNMP tab, has one extremely useful feature that you rarely see. It has link to download the MIBs for this PDU.</p> <p>For- those who have configured SNMP based monitoring and data collection- You will know exactly how great this feature is... (Especially, since there is ZERO documentation for this PDU... easily accessible)</p> <p>You can optional enable, or disable SNMP v1/2, and v3. You can adjust the port.</p> <p>Version 3 is supported, with NoAuth,NoPriv, or Auth,NoPriv, Or Auth&amp;Priv.</p> <p></p> <p>Multiple SNMP traps can be specified, with configurable host, version, port.</p> <p>Individual Alarms, or warnings can be configured to send to the traps specified.</p> <p></p> <p>Details for SNMP location/contact/phone/etc are adjustable in the System &gt; Admin tab.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-syslog","title":"System &gt; Syslog","text":"<p>The syslog settings allows you to export the event log.</p> <p>Info</p> <p>The exported eventlog, at least for me, seems to have an error, causing the columns to be mismatched.</p> <p>This, issue appears to carry over to remote syslog as well.</p> <p>Events include configuration changes, network interface changes/events(up/down), authentication, and system service status changes and notifications.</p> <p>You can configure a remote syslog server.</p> <p></p> <p>This unit does not appear to use the correct facility codes when used with a remote syslog server.</p> <p>My testing shows all events being sent to user:notice. However, events do contain a field for service, which</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-utilities","title":"System &gt; Utilities","text":"<p>The utilities tab, allows backup, and restore of configuration, along with factory reset.</p> <p>The aggregation section, I assume, is used with vendor-specific central management tools.</p> <p>Firmware is upgradable, if you can find it.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#system-misc","title":"System - Misc","text":"<p>For the system's time, NTP servers are supported, with configurable time-zone.</p> <p>There is a USB tab, which allows enabling, or disabling USB, along with a listing of devices, serial, max power. (Not- sure the intended purpose here)</p> <p>The serial port is configurable, with adjustable baud rate. Data/Stop/Parity are configured to 8/1/None with no ability to change.</p> <p>Units of F, or C are settable.</p> <p>Appears a few language options are selectable.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#provisioner-tab","title":"Provisioner Tab","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#provisioner-discovery","title":"Provisioner &gt; Discovery","text":"<p>As, again, documentation is pretty hard to come by, I am not sure of the intended purpose for this tab.</p> <p>This- is being included for completeness. </p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#provisioner-file-management","title":"Provisioner &gt; File Management","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#help-tab","title":"Help Tab","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#help-info","title":"Help &gt; Info","text":"<p>The info tab has a nice display showing current versions, firmware, serial, and lifetime energy.</p> <p></p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#help-online-support","title":"Help &gt; Online Support","text":"<p>This option redirects you to vertiv's support page.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#programmatic-access-getting-data","title":"Programmatic Access &amp; Getting Data","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#snmp-information","title":"SNMP Information","text":"<p>Using LibreNMS, I was able to effortless add this device. It was able to pull in common information with no configuration needed.</p> <p>Included data automatically populated- contains voltage, amperage, and wattage details, for The unit, and the two internal circuits.</p> <p>By default, individual plugs are not listed.</p> <p></p> <p>The included MIB sheet, is detailed, with names, OIDs, required access, units, and methods.</p> <p>Common options have methods to remotely update and manage via SNMP. You, can issue a power-cycle for a plug for example.</p> <p>The included MIBs, contains quite a few options not displayed in the GUI as well...</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#example-of-available-mibs","title":"Example of available MIBs","text":"<p>Here, are the MIBS listed for \"config and control for outlets with switching\", and \"metering data\"</p> <p></p> <p>I will note, the sheets, includes hundreds of MIBs across two separate CSVs. .MIB files are also included.</p> <p>I- am not going to dig into detail here on how to consume these MIBs, but, I will note, My goal is to automatically feed this data into EmonCMS, and from there, consume it with home assistant.</p> <p>Keep- an eye out for a separate post regarding this.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#ssh","title":"SSH","text":"<p>This unit does indeed have an SSH interface.</p> <pre><code>&gt; help\nUsage: COMMAND PATH [= ARGUMENT]\n  COMMAND\n    [get, set, logout, add, delete, control, ack, sendTest, reset, reboot, help]\n  PATH\n    The API path (excluding \"api\" and separated by spaces) to which COMMAND will be applied.\n  ARGUMENT\n    The \"data\" field for the API request formatted as either JSON or YAML.\n</code></pre> <p>This Manual for r-series v4, was helpful in determining how to use the interface.</p> <p>I found, the paths match exactly what the API returns. </p> <p>So- this command: <code>get dev A0AE260C851900C3 outlet 2 measurement</code> will return all of the measurement details, for outlet 2.</p> <p>Set commands are allowed, and are documented in the manual.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#json-api","title":"JSON API","text":"<p>Accessing the API, was extremely easy.</p> <p>Just- visit http://YOUR_PDU_IP_ADDRESS:80/api</p> <p>And- you will get a full listing of elements in json format.</p> <p>As, a simple example- here is a command to retrieve the current amperage from each outlet.</p> <pre><code>root@remote:~# curl -s http://ip.of.my.pdu:80/api | jq -r '.data.dev.A0AE260C851900C3.outlet | to_entries[] | \"\\(.value.label)\\t\\(.value.name)\\t\\(.value.measurement[\"4\"].value) A\"' | column -t\nUnifi:          USW-24-PRO  Outlet  12      0.18    A\nUnifi:          UXG-Lite    Outlet  3       0.04    A\nProxmox:        Kube01      Outlet  5       0.81    A\nDell:           MD1220      Outlet  2       0.40    A\nProxmox:        Kube05      Outlet  6       0.49    A\nProxmox:        Kube06      Outlet  4       0.31    A\nSynology:       NAS         Outlet  9       0.41    A\nDell:           R730XD      Outlet  1       1.98    A\nOutlet          7           Outlet  7       0.00    A\nProxmox:        Kube04      Outlet  10      0.30    A\nCloset-POE-UPS              Outlet  8       0.50    A\nCRS504-100G     Switch      Outlet  11  0.18  A\n</code></pre> <p>(Data- is oddly formatted, due to the characters in my labels.)</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#other-documentation-and-references","title":"Other documentation and references","text":"<p>Vertiv Geist RPDU - User Manual</p> <p>This manual, seems to be relevant for this particular PDU.</p> <p>Manual for r-series v4</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/metered-switch-pdu/#my-personal-plans","title":"My personal plans","text":"<p>My goal was to clean-up the back area of my rack. Since, the S31s are bulky, and the HS300  is literally a power strip mounted in my rack.. Its not the most appealing.</p> <p>As, I want to chart, and collect this data at a frequent interval, I will be exporting this data to emonCMS, where I will keep long-term history.</p> <p>As well, I am strongly considering creating a simple Home-Assistant plugin, which allows the entities to exist in home-assistant, with the ability to view stats, and manage the plugs (on/off/reset/etc.)</p> <ol> <li> <p>Measured in my lab, with no connected plugs, or network cables, with the unit powered on after initialization.\u00a0\u21a9</p> </li> <li> <p>With- the correct adapter to connect a NEMA L5-30R into a standard NEMA 5-15R, or 5-20R.\u00a0\u21a9</p> </li> <li> <p>The linked posting advertising as including original packaging, and manuals. My unit which was purchased from the same listing, did come in the original packages, unopened, with all original documentation, and accessories.\u00a0\u21a9</p> </li> </ol>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/","title":"Surge Protection - Entire Home, Rack-Only, etc.","text":"<p>A few months back, I noticed one of my ESP32s, got smoked during a few nasty thunderstorms.</p> <p>And- it got me thinking- what happens if a large surge hits my house? </p> <p>Is, it going to smoke my fridge? My TV? How about my server rack full of expensive gear?</p> <p>So- I went on a project to upgrade the surge protection for my house.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#protecting-the-house","title":"Protecting the house","text":"<p>So- first of all, I wanted to add a bit more protection to the general house.</p> <p>There- are quite a few options here, ranging from a few bucks (cheap surge protection), up to the thousands.</p> <p>I don't intend to being able to stop a DIRECT lightning strike- that takes a lot more then a small piece of hardware. My goal was to add some protection from near-strikes, or strikes to the distribution line.</p> <p>Ideally, this would be handled through a surge device directly after your service-entrance meter. </p> <p>After pondering, I decided to pick up a Eaton BRNSURGE Type BR. This fits into your breaker panel into an available double-slot, and provides protection for both poles.</p> <p>The price, was very reasonable, under 100$. If- it gets used once- that can easily justify itself.</p> <p>This- unit is rated to handle a 18,000 amp surge.</p> <p>If, you want an even better option (Eaton's wording, not mine!)- Consider a brick. The CHSPT2ULTRA costs double-the price,  but- there is a big-advantage-</p> <p>Eaton's warranty on these devices, will pay to replace any damaged equipment. </p> <p>See Eaton Residential Surge Protection</p> <p>This- is not covered under the \"basic\" BRNSURGE which I am using.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#installing-the-unit","title":"Installing the unit","text":"<p>Danger</p> <p>Obligatory disclaimer</p> <p>If you aren't an electrician, Don't go digging around with mains voltage.</p> <p>It can kill you. You have been warned.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#step-1-identify-your-panel","title":"Step 1. Identify your panel","text":"<p>The first part- before you consider ordering one of these- go find your panel.</p> <p></p> <p>Make sure you have an available slot for a double-breaker!</p> <p>In my case, you can see what appears to be an ideal spot at the top-right, along with available slots on the bottom.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#step-2-remove-the-front-cover","title":"Step 2. Remove the front-cover","text":"<p>You have already been warned to not play with live-voltage!!!!</p> <p>But- the next part, is to remain the front of the panel, to gain access to the breakers and wiring.</p> <p></p> <p>Now- a few things were discovered at this point-</p> <ol> <li>The conductors for the main breaker have stick-out- that is no bueno. But- a problem for another day.</li> <li>Remember that nice spot at the top-right? Its blocked.</li> <li>If- you are curious about the weird white things around half of the cables- that is my Per-Breaker Energy Monitoring.</li> </ol> <p>As a random note- there is no romex here- everything is THHN/THWN, because it travels through conduit.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#step-3-identify-a-suitable-location-for-the-surge-arrestor","title":"Step 3. Identify a suitable location for the surge arrestor","text":"<p>IDEALLY- you want this to be as close to the main-breaker as possible. </p> <p>In my case- there isn't a ton of slack to go around, and the top-right spot is filled. So- I slapped it into the bottom socket. </p> <p>Make sure to also connect the neutral leg.</p> <p></p> <p>The green light, lets you know the unit is functioning correctly. If you don't see a green light, something was done incorrectly.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#final-step-reinstall-the-cover","title":"Final Step - Reinstall the cover","text":"","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#but-but-but","title":"BUT, BUT, BUT....","text":"<p>Yes... I know. The arm-chair warriors are furious this is not installed next to the main-breaker.</p> <p>And- I am not worried. Would you like to know why?</p> <p>First- the manufacturer documentation does not specify location. Eaton knows more then you do. I promise. They have been doing this for over one hundred years.</p> <p>Next- I have received comments- It can't do ANYTHING at the bottom of the panel.</p> <p>On the happy side- mains panels don't use a token ring for energy distribution. Everything runs in parallel along the massive back-plane.</p> <p>The resistance from the main-breaker, to this surge protection device, is MUCH LESS then the resistance to the next-connected device.</p> <p>Remember- that THHN/THWN I mentioned? There is 20 foot of it. Afterwards, it goes into a junction box, where it gets translated into romex, which travels throughout the house.</p> <p>There is SIGNIFICANTLY less resistance through 8 inches of the 200amp panel's back-plane, then there is through 20 foot of 12/14AWG THHN/THWN + 20-80 foot of romex.</p> <p>Not to mention- the amount of inductance along the length of the wire.</p> <p>Long story short- I am not worried about it, and Eaton does not specify this needs to happen, and the product/warranty terms, also, do not specify this.</p> <p>Yes- I will agree, that the closer to the mains it is, the more effective it should be. However, I am not in the least bit worried about it. And- neither is eaton's </p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#project-two-better-surge-protection-for-my-rack","title":"Project Two- Better surge protection for my rack.","text":"<p>Since, none of the PDUs on my rack explicitly say, \"Surge Protection\"- I wanted to add an in-line device just as a fail-safe.</p> <p>And- for under 10$, Monoprice 1 Outlet Surge both fits the bill, and fits the need.</p> <p>The specifications list a rating of 400v, with a max current capacity of 15amps, and a &lt; 1ns response, which fits my needs perfectly.</p> <p>In, one nanosecond, light will travel 300 millimeters in a vacuum. Now- electricity, travels at the speed of light. </p> <p>Theoretically- this means, a massive voltage-surge will travel roughly one foot, before the device reacts. Since- there is 6 foot of cable between this device, and the next-connected load (An APC PDU), everything should be just fine.</p> <p>As a bonus- installation is very easy. You plug it in.</p> <p></p> <p>So- dirt-cheap, and effortless install. These are the best types of devices.</p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/surge-protection/#closing-notes","title":"Closing notes","text":"<p>Not- really the most exciting topic to post about. </p> <p>However, most of these posts are documented for my needs as well.</p> <p>I have found myself frequently needing to review previous documentation to determine the state of something in the past, or exactly how something was done.</p> <p>Or- maybe I have a friend, co-worker, or fellow Redditor looking to do something similar. In either case, this documentation comes in handy pretty frequently.</p> <p>And- I don't mine sharing my experiences. So- Enjoy!</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>Yup. The amazon links above are affiliated.</p> <p>If- the idea of you paying the exact same price, and me potentially getting 2 pennies worth of affiliate money makes you angry- I can provide you with documentation on how to completely block this entire domain using either u-block, or network-level DNS blocking. Makes no difference to me! Just remember- hours of research, experimentation, editing, and writing goes into each of these posts. I'd prefer you just completely block me, and my domain, rather then to hear you fuss about the affiliate links.  </p> <p>And- if you are wondering- Yes- there is an underlying reason for the above spill. </p>","tags":["Homelab","Homelab/Power"]},{"location":"blog/2024/windows-11---restore-context-menu/","title":"Windows 11 - Restore Old Context Menu","text":"<p>Want the old right-click context menu back?</p> <p>Copy/paste the below script into an administrative command prompt. Thats it.</p> <pre><code>:: Set \"Old\" Explorer Context Menu as Default\nreg add \"HKEY_CURRENT_USER\\SOFTWARE\\CLASSES\\CLSID\\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\\InprocServer32\" /ve /f\n\n:: Remove Explorer \"Command Bar\"\nreg add \"HKCU\\Software\\Classes\\CLSID\\{d93ed569-3b3e-4bff-8355-3c44f6a52bb5}\\InprocServer32\" /f /ve\n\n:: Restart Windows Explorer. (Applies the above settings without needing a reboot)\ntaskkill /f /im explorer.exe\nstart explorer.exe\n\n:: Empty Comment (Prevents you from having to press \"enter\" to execute the line to restart explorer.exe)\n</code></pre>","tags":["Homelab","Homelab/Windows/11"]},{"location":"blog/2024/windows-11---restore-context-menu/#why","title":"Why?","text":"<p>I VERY frequently right click to click, Open Folder in VSCode, Extract with 7Zip. Etc.</p> <p>The windows 11 context menu, is missing basically every option, and requires me to make one extract click.</p> <p>Thats it. Thats literally the entire post. Told you that you didn't need to click on it.</p>","tags":["Homelab","Homelab/Windows/11"]},{"location":"blog/2024/windows-11---restore-context-menu/#how-to-restore-win-11-context-menu-explorer-command-bar","title":"How to restore Win 11 Context Menu &amp; Explorer Command Bar","text":"<p>Copy and paste this into an administrative command prompt.</p> <pre><code>:: Restore Win 11 Explorer Context Menu\nreg.exe delete \"HKCU\\Software\\Classes\\CLSID\\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\" /f\n\n:: Restore Win 11 Explorer Command Bar\nreg.exe delete \"HKCU\\Software\\Classes\\CLSID\\{d93ed569-3b3e-4bff-8355-3c44f6a52bb5}\" /f\n\n:: Restart Windows Explorer. (Applies the above settings without needing a reboot)\ntaskkill /f /im explorer.exe\nstart explorer.exe\n\n:: Empty Comment (Prevents you from having to press \"enter\" to execute the line to restart explorer.exe)\n</code></pre>","tags":["Homelab","Homelab/Windows/11"]},{"location":"blog/2024/2024-network-revamp/","title":"2024 Network Revamp","text":"<p>This month's goal, is to update the network to provide isolation, and separation between LAN subnets, and my server subnets.</p> <p>Aka, if I go unplug my rack of servers- The internet should remain unaffected for members in my household.</p> <p>In the current state- I have WAN -&gt; UXG-Lite -&gt; Everything else.</p> <p>But, there are quite a few things which drives me crazy about unifi...</p> <ol> <li>No \"easy\" support for IPv6 GIF tunnels- I have an entire /48 block of IPv6 addresses I would like to use. I don't want to go do a bunch of hacks to get this to work.</li> <li>Traffic policies, etc, only work when apparently you use the Unifi as the primary DNS. I don't want to do this.</li> <li>Unifi's Layer 3 routing protocol support, is still questionable. But, at least it supports OSPF now.... </li> <li>I honestly hate its ACL interface. Its... horrible when you have lots of zones, lots of ACLs, etc.</li> </ol> <p>To meet these needs, I decided to pick up a new hEX refresh</p> <p>For 59$ shipped, this thing is nearly half of the price as the EdgeRouters used to sell for- back before the Unifi line was even introduced- and Unifi was known for the most cost-effective routers in existence.</p> <p>In addition, for this price point- it has extremely respectable hardware specs, and is more then capable of handling my gigabit fiber.</p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#the-goals","title":"The Goals","text":"<p>I want to remove the UXG from being in-line with general lab traffic. It does NOT work... at all, with traffic handled by other routers. It, just produces broken graphs, charts, etc.</p> <p>I WOULD use the USW-24-Pro as a router.... BUT, it has a ton of issues...</p> <ul> <li>https://www.reddit.com/r/UNIFI/comments/1e7irs5/do_not_buy_a_unifi_layer_3_switch_expecting_it_to/</li> <li>https://community.ui.com/questions/Layer-3-Switch-Static-Routes-do-NOT-work/5f7e98ac-745c-4437-b74c-cefe5630deaa</li> </ul> <p>It, honestly, sucks as a layer 3 router. (And- also, breaks many of the unifi features when you use it as a layer 3 router.... No traffic inspection, for example... despite the traffic still flowing through the UXG/UDR/etc...) Broken routing.</p> <p>So- instead, I'll let Unifi do what Unifi is good at- Managing simple LAN traffic with upstream delegation.</p> <p>I'll use the new Mikrotik hEX, to do what the Unifi is not good at. Managing multiple VPN tunnels, terminating GIF tunnels, and handling routing... using BGP for internal route propagation. </p> <p>Won't, really be any changes for the lab subnets- HOWEVER, I will be re-locating the hEX, and UXG ouside of my server rack- which will allow my rack to be completely unplugged, without affecting LAN traffic.</p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#the-plan","title":"The Plan","text":"<p>The hex will be added logically, directly behind the incoming WAN connection.</p> <p>Its duty, will be simple.</p> <ol> <li>Maintain PPPoe connection.</li> <li>Maintain IPv6 GIF tunnel.</li> <li>Perform IPv6 Suffix Remapping (Aka, It takes the public ipv6 suffix, and remaps to a private suffix- this makes my internal devices and subnets immune to any external changes. For example- if my ISP ever offers native IPv6- I can adopt it with no internal changes needed.)</li> <li>Perform NAT for IPv4 traffic. </li> <li>Perform Port Forwarding</li> <li>ACLs for WAN -&gt; Edge (Edge, is the zone between WAN &amp; TRUST / PUBLIC)</li> <li>ACLs for TRUST -&gt; Edge (Trust Zone- refers to everything in my \"Lab\")</li> <li>ACLs for PUBLIC -&gt; Edge (Public Zone- Aka, LAN traffic, Users, Guest subnets, etc.)</li> <li>Maintain VPN Client Access</li> <li>Maintain Outgoing VPN Tunnels</li> </ol>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#logical-routing-diagram","title":"Logical Routing Diagram","text":"<p>Logical Diagram, showing major Zones marked.</p> <pre><code>flowchart TD\n    subgraph OUTER\n        WAN \n    end\n\n    WAN--&gt; | PPPoe| HEX\n\n    subgraph EDGE\n        HEX\n    end\n\n    subgraph PUBLIC\n        UXG\n        UXG[\"Unifi UXG-Lite\"] --&gt; V_LAN &amp; V_Guest &amp; V_LAN_Isolated\n    end\n\n    HEX --&gt; |Static| UXG\n    HEX --&gt; |BGP| 100G\n    subgraph TRUSTED\n        100G[\"CRS504-4XQ\"] --&gt; V_Kubernetes &amp; V_Server &amp; V_Storage\n    end\n\n    100G --&gt; | BGP | EDGEMAX\n\n    subgraph UNTRUSTED\n        EDGEMAX[\"EdgeRouter\"] --&gt; V_IOT &amp; V_SECURE &amp; V_MGMT\n    end</code></pre>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#physical-diagram","title":"Physical Diagram","text":"<p>Here is a physical diagram, with the major locations marked, and connection type.</p> <pre><code>flowchart TD\n    WAN\n\n    subgraph Office\n        MC[\"Media Converter\"]\n        SW-B[CSS610-8G-2S]\n\n    end\n\n\n    subgraph Closet[\"Server Closet\"]\n        UXG[\"UXG-Lite\"]\n        HEX[\"hEX Refresh\"]\n        SW-L[\"USW-Lite 8 POE (LAN)\"]\n        SW-S[\"USW-Lite 8 POE (Secure)\"]\n\n    end\n\n    subgraph Rack[\"Server Rack\"]\n        100G[CRS504-4XQ]\n        Edge[\"EdgeMax\"]\n\n        %% Layer 2 Switches\n        10G[\"USW-Aggregation\"]\n        1G[\"USW-24-Pro\"]\n\n        S_1G[\"Servers 1G\"]\n        S_10G[\"Servers 10G\"]\n        S_100G[\"Servers 100G\"]\n    end\n\n    %% Access Points\n    AP1[\"UAP-AC-PRO\"]\n    AP2[\"U6 Pro\"]\n    SW-G[\"USW-Flex (Garage)\"]\n    SW-T[\"USW-Flex (Livingroom)\"]\n\n    %% OUTER --&gt; EDGE\n    WAN --&gt; | GPON |MC\n    MC --&gt; | 1G CAT6 | HEX\n\n    %% EDGE --&gt; Trust\n    HEX --&gt; | 1G CAT6 | 1G\n\n    %% EDGE --&gt; PUBLIC\n    HEX --&gt; | 1G CAT6 | UXG\n\n    %% PUBLIC\n    UXG --&gt; | 1G POE |SW-L\n    SW-L --&gt; | 1G POE |SW-G\n    SW-L --&gt; | 1G POE |SW-T   \n\n    %% TRUST\n    1G --&gt; |10G DAC | 100G    \n    1G --&gt; |10G MMF| 10G\n    100G --&gt; |10G DAC| 10G\n\n    10G --&gt; | 10G SMF| SW-B\n\n    1G --&gt; | 1G CAT6| SW-S\n\n\n\n    1G --&gt; | 1G CAT6 | S_1G\n    10G --&gt; | 10G Twinax | S_10G\n    100G --&gt; | 100G DAC| S_100G\n\n    %% IOT\n    1G --&gt; | 1G CAT6| Edge\n\n    %% Access Points\n    SW-L --&gt; | 1G POE |AP1 &amp; AP2</code></pre>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#individual-zones","title":"Individual Zones","text":"","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#edge","title":"EDGE","text":"<p>The Edge zone is responsible for performing ACLs between OUTER/WAN, and Internal Zones.</p> <p>It also performs NAT for IPv4 traffic, and prefix mapping for IPv6 traffic.</p> <p>It handles route propagation using BGP.</p> <p>And, it handles traffic policies for external traffic. (aka, selective routing of traffic through tunnels.)</p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#public-lan","title":"PUBLIC / LAN","text":"<p>Since, Unifi is actually pretty good at managing LAN subnets- I am going to set it up as if the hEX router is the ISPs router. </p> <p>It will have a delegated /58 IPv6 Prefix, which will give it the ability to automatically manage, and delegate /64 blocks as needed to any subnets it manages.... up to 64 subnets.</p> <p>It will also be delegated a /18 block of IPv4 addresses, which will allow it to automatically manage, and delegate up to 64 x /24 blocks of IPv4 addresses.</p> <p>As such- this allows the ability for it to automatically assign and maintain up to 64 internal subnets, as needed for various purposes. Although, realistically, only 2 subnets are actually used here.</p> <ol> <li>General LAN Traffic (aka, normal Wifi). NAT handled by the hEX.</li> <li>Guest / Internet Only (Isolated subnet, which can ONLY talk to the internet. NOTHING internally. This- is used for certain devices, like... My cat-feeder, and, Guest wifi access. Wireless Isolation enabled too.). Outbound to WAN is NAT-ed here.</li> </ol> <p>As.... many of the Unifi features only works, when it is used as the primary DNS/DHCP server- it will be used as the primary DNS/DHCP server. </p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#trust-homelab-servers","title":"TRUST / Homelab / Servers","text":"<p>The majority of my server rack lives in the \"TRUSTED\" Zone. Everything here is routed using the 100G CRS504-4XQ, which does an amazing job. Very minimal ACLs are applied here, rather- Vlans are used for isolation here needed..</p> <p>Since, everything in my lab is running proxmox, with the exception of a Synology- All of my firewall rules are done in Proxmox (Synology does its own Layer 3 ACLs). This is fantastic, as the firewall rules are stored WITH the VMs. I can manage everything in one place. All of my VMs/LXCs have configured firewall policies via Proxmox.</p> <p>Routes are propagated to/from hEx using BGP. I have found, BGP w/BFD works really nicely for internal routing, and load balancing. Extremely fast route propagation, and EXTREMELY customizable, as needed.</p> <p>For Addressing-</p> <ol> <li>/16 block of IPv4 addresses will be delegated to this zone. This gives 256 total /24 usable subnets.</li> <li>/56 block of IPv6 addresses will be delegated to this zone. This gives 256 total /64 usable subnets.</li> </ol> <p>DNS is handled by Technetium as the primary DNS server. The backup/failover DNS is handled by a Bind9 server, using zone transfers from the primary.</p> <p>DHCP is also handled by Technetium.</p> <p>All physical servers with hardware clocks, are automatically configured as a NTP pool, via Ansible playbooks. Chrony is used here.</p> <p>All Virtual Machines, LXCs, etc... are configured to use said NTP pool, via Ansible Playbooks.</p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#untrusted-iot-security-etc","title":"UNTRUSTED / IOT / Security / etc...","text":"<p>As someone who does a lot of home automation, I have a lot of IOT devices. I also have lots of security cameras, etc.</p> <p>I have been using an old EdgeRouter, I purchased over a decade ago, for maintaining these zones. It- works perfectly. It also can propagate routes using BGP, (or RIP/OSPF), and does support BFD.</p> <p>This zone, is more or less, completely isolated inside of the network. </p> <p>The devices inside of this zone- Can't really talk to anything. </p> <p>There is no access outside of the subnets, with very few limitations. No DNS. NTP is provided by the EdgeMAX. DHCP is provided by the EdgeMAX.</p> <ul> <li>My ESPHome Subnet, can talk to home assistant. Home assistant can talk to it.</li> <li>My generic IOT subnet, cannot talk to anything. Home assistant can talk to it. (This is for devices, such as Kasa- that I don't want phoning home. BUT, home assistant can fetch/control them).</li> <li>V_Secure- The only access allowed into this subnet- is from my reverse proxy to the blue iris interface. No access is allowed to external. </li> <li>V_Management - Management interfaces for switches, routers, etc. Separate VRFs are used on devices to isolate the management traffic, from everything else. </li> </ul>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-network-revamp/#final-words","title":"Final Words","text":"<p>I am not doing this, to fix an issue, Honestly- I really wanted to experiment with the new hex refresh routers.</p> <p>The hardware seems extremely capable, and the price point is really hard to beat.</p> <p>If- this works as I have planned- It should also make network management quite a bit easier.</p>","tags":["Homelab","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/","title":"10G or faster networking options.","text":"<p>Want connectivity faster then 10G?</p> <p>Well- I have a list of NICs, switches, and notes.</p> <p>Info</p> <p>This content is NOT sponsored.</p> <p>I do personally own these switch models mentioned below:     - Unifi USW-Aggregation     - Mikrotik CRS504-4XQ     - Mikrotik CSS610-8G-2S+     - Brocade ICX6610-48P     - Brocade ICX6610-48     - Brocade ICX6450-24P</p> <p>These switches were purchased by myself, with no undisclosed benefits.</p> <p>This post DOES include affiliate links. More information at the bottom of this post.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#network-adapters","title":"Network Adapters","text":"<p>Note- price estimates last updated Dec 18, 2024.</p> <p>I do not recommend picking up the 10G NICs. Instead, Spend 5 or 10$ more, and pick up one of the newer 25G NICs. They are compatible with 10G, but- are an entire generation newer.</p> <p>This is also not a complete list. This list will be updated as I discover new NICs worthy of being added.</p> Make Model Ports Type Multi-Gig Speed Generation Price Link Notes Chelsio T520-CR Dual SFP+ No 10G Chelsio T5 $30-$70 eBay Link nan Chelsio T540-CR Quad SFP+ No 10G Chelsio T5 $40-$100 eBay Link One of the few quad 10G NICs. Chelsio T580-CR Dual QSFP+ No 40G Chelsio T5 $20-$60 eBay Link nan Chelsio T6225-CR Dual SFP28 No 25G Chelsio T6 $50-$150 eBay Link nan Dell 099GTM<sup>4</sup> Dual SFP28 No 25G 500 Series $10-$20 eBay Link Compatible with many Dell servers (e.g., R730XD). Not picky with modules. 2x1G + 2x10G RJ45. Intel X540. Dell 6VDPG<sup>5</sup> Quad SFP+ No 2x 1G + 2x 10G 700 Series $20-30 eBay Link I do NOT recommend getting this NIC. It is extremely picky with modules. Dell R887V<sup>1</sup> Quad RJ45<sup>3</sup> No 2x 1G + 2x 10G ConnectX-4 $10-$20 eBay Link Compatible with many Dell servers (e.g., R730XD). Not picky with modules. Intel E810-CQDA2 Dual QSFP28 No 100G 800 Series $260+ eBay Link nan Intel E810-CQDA2 Single QSFP28 No 100G 800 Series $300+ eBay Link Oddly, the single port version costs more then the dual-port version. Intel E810-XXVDA2 Dual SFP28 No 25G 800 Series $150+ eBay Link nan Intel E810-XXVDA4 Quad SFP28 No 25G 800 Series $200-300 eBay Link nan Intel I226-T1 Single RJ45 Yes* 2.5G nan nan eBay Link 2.5G/1G Adapter. Not the best reviewed NICs. Intel X540-T2 Dual RJ45<sup>3</sup> No 10G 500 Series $15-$30 eBay Link These work well when you need a copper 10G link. Intel X550-T2 Dual RJ45<sup>3</sup> Yes 10G 500 Series $70-120 eBay Link nan Mellanox CX314A Dual QSFP+ No 40G ConnectX-3 $10-$20 eBay Link Recommend newer NICs (e.g., ConnectX-4). Can support 10G with SFP -&gt; QSFP adapter. Mellanox CX354A Dual QSFP+ No 40G ConnectX-3 $10-$20 eBay Link Recommend newer NICs (e.g., ConnectX-4). Can support 10G with SFP -&gt; QSFP adapter. Mellanox CX4121A Dual SFP28 No 25G ConnectX-4 $30-$40 eBay Link nan Mellanox CX416A Dual QSFP28 No 100G ConnectX-4 $100-$200 eBay Link This is the NIC I use in most of my servers. Mellanox CX455 Single QSFP28 No 100G ConnectX-4 $100 eBay Link nan Mellanox CX516A Dual QSFP28 No 100G ConnectX-5 $150-$300 eBay Link nan Mellanox MCX311A-XCAT Single SFP+ No 10G ConnectX-3 $15-$25 eBay Link ASPM broken on newer Intel CPUs; works with <code>mlx4_core</code>. Recommended to choose 25G. Mellanox MCX312B Dual SFP+ No 10G ConnectX-3 $30-$40 eBay Link Consider ConnectX-4 10/25G instead. Mellanox MCX4111A Single SFP28 No 25G ConnectX-4 $20-$40 eBay Link nan TP-Link TX201 Single RJ45<sup>3</sup> Yes* 2.5G nan 30$ Amazon 1/2.5G TP-Link TX401 Single RJ45<sup>3</sup> Yes 10G nan 100$ Amazon 1/2.5/5/10G","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#notes","title":"Notes","text":"<p>Please keep in mind, compatible speeds for a given network adapter.</p> <p>25G NICs will nearly always also support 10G. (and slower)</p> <p>100G NICs, can generally support anything less.</p> <p>If you wish to run a 40/50/100G NIC at 10G, you will need a QSFP+ to SFP+ Adapter.</p> <p>Only NICs which specify \"Multi-Gig\" are capable of 2.5G, or 5G. (TP-Link NICs &amp; Intel i226 are the only NICs flagged at this time)</p> <p>56Gbit/s is infiniband only, and only applies when running a Mellanox NIC, in IB mode, when connected to a supported infiniband switch.</p> <p>Mellanox Infiniband NICs (Every one of the listed Mellanox NICs) can be ran in either ethernet mode (where they behave like a normal NIC), or Infiniband mode. I strongly recommend ETH mode. Guide: Switch Port Mode</p> <p>I personally prefer Mellanox NICs. In my experiences, these are the best bang for the buck, are generally really cheap, plug and play, and have been extremely reliable.</p> <p>In my experiences, Intel, Mellanox, and Chelsio have all been plug and play with both Linux and Windows.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#switches","title":"Switches","text":"<p>Note, ALL switches listed, are MANAGED switches, with support for vlans.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#table","title":"Table","text":"<p>Notes: - Data used from manufacturer spec-sheets when possible. - Footnotes are included for additional context.</p> Manufacturer Model Layer 3 Max Speed RJ45 SFP SFP+ QSFP+ Multigig Noise Power POE Price Link Brocade ICX 6450-24 Yes 10G 24 - 4 - No 37.9 dBA 20-37w No 100$ eBay Brocade ICX 6450-24P Yes 10G 24 - 4 - No 39.2 dBA 21-400w<sup>9</sup> Yes 100$ eBay Brocade ICX 6450-48 Yes 10G 48 - 4 - No 37.2 dBA 30-55w No 60-100$ eBay Brocade ICX 6450-48P Yes 10G 48 - 4 - No 55.5 dBA 31-776w<sup>9</sup> Yes 60-100$ eBay Brocade ICX 6610-24 Yes 40G 24 - 16<sup>10</sup> 2<sup>10</sup> No 39.6 - 48.7 dB 120-140w No 100$ eBay Brocade ICX 6610-24P Yes 40G 24 - 16<sup>10</sup> 2<sup>10</sup> No 39.6 - 48.7 dB 120-140w Yes 100-140$ eBay Brocade ICX 6610-48 Yes 40G 48 - 16<sup>10</sup> 2<sup>10</sup> No 39.6 - 48.7 dB 165-185w No 60-100$ eBay Brocade ICX 6610-48P Yes 40G 48 - 16<sup>10</sup> 2<sup>10</sup> No 39.6 - 48.7 dB 165-185w Yes 60-100$ eBay Brocade ICX 7250-24 Yes 10G 24 - 8 - No 41.9 dBA 39-57w No 75-120$ eBay Brocade ICX 7250-24P Yes 10G 24 - 8 - No 44.7 dBA 48-454w<sup>9</sup> Yes 75-120$ eBay Brocade ICX 7250-48 Yes 10G 48 - 8 - No 44.5 dBA 50-70w No 90-140$ eBay Brocade ICX 7250-48P Yes 10G 48 - 8 - No 45.9 dBA 70-942w<sup>9</sup> Yes 90-140$ eBay Brocade ICX 7150-24 Yes 10G 24 - 4 - No Fanless 14-24w No 150-300$ eBay Brocade ICX 7150-24P Yes 10G 24 - 4 - No 41.4 dBA 32-472w<sup>9</sup> Yes 150-300$ eBay Brocade ICX 7150-48 Yes 10G 48 - 4 - No Fanless 24-39w No 250-600$ eBay Brocade ICX 7150-48P Yes 10G 48 - 4 - No 41.8 dBA 47-491w<sup>9</sup> Yes 250-600$ eBay Mellanox SX6036 Yes 40/56G<sup>7</sup> 2 - - 36 No Unknown ?? - 231w No 100-120$ eBay Mellanox SX1036 Yes 40/56G<sup>7</sup> 1 - - 36 No Unknown 78 - 100w? No 600$ ?? eBay Mellanox SX6012 Yes 40/56G<sup>7</sup> 1 - - 12 No Unknown 28w - ?? No eBay nan Mellanox SX6018 Yes 40/56G<sup>7</sup> 2 - - 18 No Unknown ?? No 100-250$ eBay Mellanox SX6005<sup>6</sup> No 56G IB Only - - - 12 No Unknown ?? No eBay nan Mellanox SX6015<sup>6</sup> No 56G IB Only - - - 18 No Unknown ?? No eBay nan Mellanox SX6025<sup>6</sup> No 56G IB Only - - - 36 No Unknown ?? No eBay nan Mikrotik CRS304-4XG-IN Yes**<sup>11</sup> 10G 1 - 4 - Yes Fanless 7-21w No 199$ Amazon Mikrotik CRS305-1G-4S+IN Yes**<sup>11</sup> 10G 1 - 4 - No Fanless 10-18w No 120$ Amazon Mikrotik CRS309-1G-8S+IN Yes**<sup>11</sup> 10G 1 - 8 - No Fanless 17-23w No 269$ Amazon Mikrotik CRS310-1G-5S-4S+IN Yes**<sup>11</sup> 10G 1 5 4 - No Nearly Silent 8-20w No 199$ Amazon Mikrotik CRS326-4C+20G+2Q+RM Yes**<sup>11</sup> 40G 20-24+1 - 0-4 2 Yes 36-54 dBA 31-70w No 999$ Amazon Mikrotik CRS504-4XQ-IN Yes**<sup>11</sup> 100G - - - 4<sup>8</sup> Yes Nearly Silent 11-41w No 650$ Amazon Mikrotik CRS510-8XS-2XQ-IN Yes**<sup>11</sup> 100G 1 - 8 2 Yes Silent - 40 dBA 15-45w No 999$ Amazon Mikrotik CRS518-16XS-2XQ-RM Yes**<sup>11</sup> 100G 1 - 16<sup>12</sup> 2<sup>8</sup> No Nearly Silent 15-95w No 1,595$ Amazon Mikrotik CSS318-16G-2S+IN No 10G 16 - 2 - No Fanless 10-13w No 139$ nan Mikrotik CSS610-8G-2S+IN No 10G 8 - 2 - No Fanless 5-11w No 110$ Amazon Unifi USW-Aggregation No 10G - - 8 - No Silent? 10-30w No 269$ Amazon Unifi USW-Pro-Aggregation Yes**<sup>13</sup> 25G - - 32 - No Unknown ?? - 100w No 899$ Amazon","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik","title":"Mikrotik","text":"<p>All of the listed Mikrotik options are acquired new.</p> <p>Mikrotik hardware will either run RouterOS, or SwOS.</p> <p>SwOS is a very basic interface, which only exposes basic layer 2 switching, and vlan functionality.</p> <p>RouterOS, exposes the kitchen sink of networking features.</p> <p>Warning<p>Do- check for hardware offload for the features you are interested in, however, as non-hardware offloaded features may have a gimped backplane connection.</p> <p>For example- My CRS504-4XQ can handle line-speed 100G routing, without breaking a sweat.</p> <p>If I enable a non-offloaded feature, such as smart-queues, NAT, or non-offloaded filtering- it would need to be process by the CPU. The CPU link works at 1Gbps MAX</p> <p>This is 100 times slower.</p> </p> <p>I have found Amazon to be the best place to buy. Mikrotik only sells to other distributors.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs518-16xs-2xq-rm","title":"Mikrotik CRS518-16XS-2XQ-RM","text":"<ul> <li>Price: $1,595</li> <li>Capabilities:<ul> <li>2x 100G QSFP+, 16x25G SFP+, 1x 10/100M RJ45</li> <li>This is a layer 3 switch. If using this for routing, make sure your features are hardware offloaded. The CPU is not very powerful.</li> </ul> </li> <li>Notes:<ul> <li>Runs RouterOS Only.</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs510-8xs-2xq-in","title":"Mikrotik CRS510-8XS-2XQ-IN","text":"<ul> <li>Price: $999</li> <li>Capabilities:<ul> <li>2x 100G QSFP+, 8x25G SFP+, 1x 10/100M RJ45</li> <li>This is a layer 3 switch. If using this for routing, make sure your features are hardware offloaded. The CPU is not very powerful.</li> <li>Can be powered via POE.</li> <li>This- is essentially the same hardware as the CRS504-4XQ, but, with two of the 100G QSFP+ ports instead broken out into 8x 25G SFP+</li> </ul> </li> <li>Notes:<ul> <li>Runs RouterOS Only.</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs504-4xq-in","title":"Mikrotik CRS504-4XQ-IN","text":"<ul> <li>Price: $650</li> <li>Capabilities:<ul> <li>Ports can support ONE OF:<ul> <li>1x 100GBe</li> <li>1x 40GBe</li> <li>4x 25GBe</li> <li>4x 10GBe</li> </ul> </li> <li>Silent and low power usage (~25W without load).<ul> <li>With 3x 100G + 4x10G, This switch consumes around 35 watts in my lab.</li> </ul> </li> <li>Cheapest 100GBe switch option. (One of the cheapest options for 25G too)</li> <li>This is a layer 3 switch.</li> <li>Can be powered via POE.</li> </ul> </li> <li>Notes:<ul> <li>Use the 1G port for management only; it does not share a backplane.</li> <li>This is the central layer 3 router for my lab. Excellent switch.</li> <li>Runs RouterOS Only.</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs326-4c20g2qrm","title":"Mikrotik CRS326-4C+20G+2Q+RM","text":"<ul> <li>Price: $999</li> <li>Capabilities:<ul> <li>20x Multi-gig RJ45 (1/2.5/5G)</li> <li>4x \"Combo\" ports. Either Multi-gig RJ45, or 10G SFP+</li> <li>1x 10/100m Management Port</li> <li>Noisy at startup, but, pretty quiet when running.</li> <li>Layer 3** (If you use this as a router, make SURE the features you will be using are hardware offloaded. If the CPU processes packets- performance will be very, very slow.)</li> </ul> </li> <li>Notes:<ul> <li>RouterOSv7</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs310-1g-5s-4sin","title":"Mikrotik CRS310-1G-5S-4S+IN","text":"<ul> <li>Price: $199</li> <li>Capabilities:<ul> <li>5x 1G SFP, 4x 10G SFP+, 1x 1G RJ45</li> <li>Nearly silent. Low energy</li> <li>Layer 3 (Limited to around 1G of routing throughput.)</li> </ul> </li> <li>Notes:<ul> <li>SwOS or RouterOSv7</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs309-1g-8sin","title":"Mikrotik CRS309-1G-8S+IN","text":"<ul> <li>Price: $269</li> <li>Capabilities:<ul> <li>8 port SFP+, with 1x 1G RJ45</li> <li>Silent and efficient.</li> <li>Can be powered via POE</li> </ul> </li> <li>Notes:<ul> <li>While this is a layer 3 switch- It does not have dedicated hardware offload, but, can offer reasonable routing performance (not linespeed!)</li> <li>Can run either RouterOS, or SwOS</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs305-1g-4sin","title":"Mikrotik CRS305-1G-4S+IN","text":"<ul> <li>Price: $120</li> <li>Capabilities:<ul> <li>4-port 10G Layer 3 switch.</li> <li>Silent and efficient.</li> </ul> </li> <li>Notes:<ul> <li>While this is a layer 3 switch- It does not have dedicated hardware offload, and is barely capable of routing 1Gbit/s. I only recommend using this for layer 2.</li> <li>Can run either RouterOS, or SwOS    </li> </ul> </li> <li>Links:<ul> <li>Amazon </li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-crs304-4xg-in","title":"Mikrotik CRS304-4XG-IN","text":"<ul> <li>Price: $199</li> <li>Capabilities:<ul> <li>4 port layer 3 10G switch with 1x 1G Management Port</li> <li>Silent and Efficient.</li> <li>Very cost-effective 10G router.</li> <li>This is a layer 3 switch.</li> <li>Can be powered via POE.</li> <li>Multi-gig capabilities (2.5G, 5G)</li> </ul> </li> <li>Notes:<ul> <li>Use the 1G port for management only; it does not share a backplane.</li> <li>This is the central layer 3 router for my lab. Excellent switch.</li> <li>Runs RouterOS Only.</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-css610-8g-2sin","title":"Mikrotik CSS610-8G-2S+IN","text":"<ul> <li>Price: $139</li> <li>Capabilities:<ul> <li>16x1G + 2x 10G SFP+</li> <li>Silent and efficient.</li> <li>Layer 2</li> </ul> </li> <li>Notes:<ul> <li>SwOS only. </li> <li>I have been personally running one of these for 2 years now. Simple, and effective.</li> </ul> </li> <li>Links:<ul> <li>Amazon</li> <li>Mikrotik</li> <li>ServeTheHome</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mikrotik-css318-16g-2sin","title":"Mikrotik CSS318-16G-2S+IN","text":"<ul> <li>Price: $139</li> <li>Capabilities:<ul> <li>16x1G + 2x 10G SFP+</li> <li>Silent and efficient.</li> <li>Layer 2</li> </ul> </li> <li>Notes:<ul> <li>SwOS only.     </li> </ul> </li> <li>Links:<ul> <li>Mikrotik</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#brocade","title":"Brocade","text":"<p>All of the following brocade switches are acquired used, from eBay or other sources.</p> <p>If you decide on picking up a brocade switch, I strongly recommend checking out Fohdeesha's Website</p> <p>These are best acquired from eBay, or other resellers.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#brocade-icx6610","title":"Brocade ICX6610","text":"<ul> <li>Price: $100 (Can go as low as $40)</li> <li>Capabilities:<ul> <li>Line-speed Layer 3 routing across all ports.</li> <li>2x 40G QSFP, 16x 10G SFP+, 48x 1G POE.</li> <li>Supports BGP, OSPF, RIP, NTP, and DHCP server.</li> </ul> </li> <li>Notes:<ul> <li>EXTREMELY loud. (Extremely difficult to make these quieter)</li> <li>High power consumption (~150W average).</li> <li>Absolute unit of a switch. Can get these dirt-cheap. Just- be prepared for it to be hot and loud.</li> <li>Comes in 24, or 48 port variants, with, and without POE.</li> </ul> </li> <li>Links:<ul> <li>Ebay</li> <li>Fohdeesha This is a setup guide, along with license unlocks, etc. Make SURE to go through these steps.</li> <li>Datasheet</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#brocade-icx6450","title":"Brocade ICX6450","text":"<ul> <li>Price: $60 average</li> <li>Capabilities:<ul> <li>4x 10G SFP + 24 or 48 port options (POE optional).</li> <li>Supports OSPF and RIP (no BGP).</li> </ul> </li> <li>Notes:<ul> <li>Fan mods are easy and can reduce power usage (~40-50W).</li> <li>Runs nearly silent with fan mods.</li> <li>Comes in 24, or 48 port variants, with, and without POE.</li> </ul> </li> <li>Links:<ul> <li>Ebay</li> <li>Fohdeesha This is a setup guide, along with license unlocks, etc. Make SURE to go through these steps.</li> <li>Datasheet</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#brocade-icx7150","title":"Brocade ICX7150","text":"<ul> <li>Price: $100-150 average</li> <li>Capabilities:<ul> <li>4-8 10G SFP+, 24-48 1G, with optional POE. Depending on configuration.</li> <li>Supports OSPF and RIP (no BGP).</li> </ul> </li> <li>Notes:<ul> <li>Very quiet. Silent when ran in fanless mode.</li> <li>Comes in 24, or 48 port variants, with, and without POE.</li> </ul> </li> <li>Links:<ul> <li>Ebay</li> <li>Fohdeesha This is a setup guide, along with license unlocks, etc. Make SURE to go through these steps.</li> <li>Datasheet</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#brocade-icx7250","title":"Brocade ICX7250","text":"<ul> <li>Price: $50-150 average</li> <li>Capabilities:<ul> <li>4-8 10G SFP+, 24-48 1G, with optional POE. Depending on configuration.</li> <li>Supports OSPF and RIP (no BGP).</li> </ul> </li> <li>Notes:<ul> <li>Pretty quiet under normal working conditions. 40-45dBA on spec sheets.</li> <li>Can be ran in fanless mode with reduced POE output.</li> <li>Comes in 24, or 48 port variants, with, and without POE.</li> <li>30-50w consumption at idle, without POE. From spec sheets.</li> </ul> </li> <li>Links:<ul> <li>Ebay</li> <li>Fohdeesha This is a setup guide, along with license unlocks, etc. Make SURE to go through these steps.</li> <li>Datasheet</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mellanox","title":"Mellanox","text":"<p>You can pick up used Mellanox infiniband switches for pretty cheap.</p> <p>Warning</p> <p>The unmanaged switches are drastically cheaper for a reason.</p> <p>They REQUIRE an external subnet manager. AFAIK, they are also infiniband-mode only.</p> <p>For- these reasons, only links to the MANAGED switches are included.</p> <p>The models ending with an odd-number are unmanaged.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#mellanox-sx6036","title":"Mellanox SX6036","text":"<ul> <li>Price: $75-150 average</li> <li>Capabilities:<ul> <li>36 QSFP+ (40 / 56GBe)</li> </ul> </li> <li>Notes:<ul> <li>This switch supports infiniband.</li> <li>This- is a very cost-effective switch, for 40GBe. (or 56G infiniband)</li> <li>As I do not own one of these- I cannot give more details.</li> </ul> </li> <li>Links:<ul> <li>Ebay</li> <li>Specs</li> <li>Datasheet</li> <li>Storage Review</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#other-models","title":"Other Models","text":"<ul> <li>SX1036 Brief</li> <li>SX6005 Brief</li> <li>SX6012 Brief</li> <li>SX6015 Brief</li> <li>SX6018 Brief</li> <li>SX6025 Brief</li> <li>SX6036 Brief</li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#unifi","title":"Unifi","text":"<p>Unifi's switches are silent, and efficient.</p> <p>I generally recommend buying these from Unifi.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#unifi-usw-aggregation","title":"Unifi USW-Aggregation","text":"<ul> <li>Price: $269</li> <li>Capabilities:<ul> <li>8x SFP+ (10GBe)</li> </ul> </li> <li>Notes:<ul> <li>8 port layer 2 10G Switch. Silent.</li> <li>My switch with all 8 ports in use, with either fiber modules, or DACs, uses around 10w average.</li> <li>A solid layer 2 switch.</li> </ul> </li> <li>Links:<ul> <li>Unifi</li> <li>Amazon</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#unifi-usw-pro-aggregation","title":"Unifi USW-Pro-Aggregation","text":"<ul> <li>Price: $899</li> <li>Capabilities:<ul> <li>28x 10G SFP+</li> <li>4x 25G SFP+<ul> <li>NOTE: Does not support mixed speed!! All of these ports must run at the same speed. </li> <li>Either- all four are 25G, or all four are 10G. </li> <li>Mixed speed is supported for 10G or below.</li> <li>This means, you CANNOT run 2x 25G, and 2x 10G. They will instead run at 4x 10G.</li> </ul> </li> </ul> </li> <li>Notes:<ul> <li>32 port \"layer 3\" switch.</li> <li>I STRONGLY do not recommend buying a Unifi switch, for its layer 3 capabilities. If you buy this switch, Then consider it a layer 2 switch.</li> </ul> </li> <li>Links:<ul> <li>Unifi</li> <li>Amazon</li> </ul> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#additional-notes","title":"Additional Notes","text":"","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#configuration","title":"Configuration","text":"<ul> <li> <p>Most NICs arrive ready to use. Use <code>ethtool</code> to adjust hardware offload parameters if needed:     Documentation on ConnectX-3 Configuration</p> </li> <li> <p>For setting port modes between ETH/IB:     Documentation on ETH/IB Mode</p> </li> </ul>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/2024-10g-or-faster/#disclaimers","title":"Disclaimers","text":"<p>This content is not sponsored</p> <p>None of the content, or products used in this post was sponsored.</p> <p>Any products tested, were purchased out of my pocket, and tested without cooperation with the manufacturer.</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <ol> <li> <pre><code>The Dell R887V is based on the ConnectX-4 CX4121C\n\nWhile the rx3x generation is not listed as compatible- I CAN confirm this does work in my r730XD.\n</code></pre> <p>\u21a9</p> </li> <li> <pre><code>These are dirt-cheap for a reason. I strongly recommend buying ConnectX-4 or newer NICs.\n\nThe price difference is not much, and they are better supported.\n</code></pre> <p>\u21a9</p> </li> <li> <pre><code>I generally recommend avoiding RJ45 for 10G.\n\nThe SFP+ modules use 10GBase-T. These run extremely hot, and have high energy consumption.\n</code></pre> <p>\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <pre><code>This is DELL Specific.\n\nI can confirm this works on both r720XD, and r730XD.\n\nPlease do research to ensure if this is compatible with your chassis.\n</code></pre> <p>\u21a9</p> </li> <li> <pre><code>This is DELL Specific.\n\nDo NOT buy this unless you are absolutely certain this is what you want.\n\nThese are EXTREMELY picky on modules. I was unable to get my server to boot without a supported module.\n\nNeither my Cisco, Mellanox, or Unifi SFP+ modules, or DACs would function.\n</code></pre> <p>\u21a9</p> </li> <li> <p>Unmanaged Infiniband Switch.</p> <p>REQUIRES external subnet manager.</p> <p>Does not support ethernet mode to my knowledge.</p> <p>Do not buy these, unless you know EXACTLY what you are purchasing.\u00a0\u21a9\u21a9\u21a9</p> </li> <li> <p>56Gb when running in Infiniband Mode.</p> <p>Supports 1/10/40G in ethernet mode.</p> <p>Note- IPoIB packets are processed by the CPU of the host typically- Do not recommend using IPoIB.\u00a0\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>This Mikroktik switch can support various speed configurations.</p> <p>Each QSFP+ port can do ONE of:</p> <ol> <li>1x 100G</li> <li>1x 50G</li> <li>1x 40G</li> <li>4x 25G</li> <li>4x 10G</li> <li>4x 5G</li> <li>4x 2.5G</li> <li>4x 1G</li> <li>4x 100M</li> </ol> <p>\u21a9\u21a9</p> </li> <li> <p>This includes POE loads.\u00a0\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>Two of the rear 40G ports can only be used in 4x10G breakout.\u00a0\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>Mikrotik hardware can perform layer 3 routing without having dedicated hardware offload.</p> <p>If using the layer 3 functionality, double-check Mikrotik's documentation to ensure your required features are hardware offloaded.</p> <p>The majority of Mikrotik switches have limited CPU, and are not very effective for doing high-speed routing without hardware offload.\u00a0\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>These SFP+ ports are 25GBe.\u00a0\u21a9</p> </li> <li> <p>Don't buy a Unifi switch for its layer 3 capabilities. </p> <p>You will be disappointed. Treat these as a layer 2 switch, and you will sleep better at night.\u00a0\u21a9</p> </li> </ol>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/Unifi"]},{"location":"blog/2024/my-history-with-unraid/","title":"My history with Unraid &amp; TrueNAS","text":"<p>I have swapped between Unraid, and TrueNAS a few times over the years.</p> <p>Often, I stumble upon threads asking... Should I use Unraid? SHould I use TrueNAS?? Which one?!?</p> <p>Well- I'm not going to tell you which one to use. Rather- I will give you the reason I personally use Unraid.</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#a-short-history","title":"A short history","text":"<p>I have flipped back and forth between Unraid, and TrueNAS for years.</p> <p>I started using FreeNAS back in 2014, long before it was known as TrueNAS.</p> <p>In 2020, When COVID hit, I built a 500$ server, which ran Unraid. Unraid was easy, Unraid was effective.</p> <p>But- I was not very happy with the performance of Unraid's array.</p> <p>When TrueNAS Scale dropped, with built-in docker, I switched to it chasing after improved storage performance. </p> <p>And- it delivered. My 40G NAS Project basically started life after I switched to TrueNAS Scale.</p> <p>I also- wrote a comparison post back then, after switching: Unraid Vs TrueNAS SCALE 2021</p> <p>Eventually- TrueNAS started being a pain in the rear...... causing blog posts such as...</p> <ol> <li>TrueNAS Scale - How to use vanilla docker<ul> <li>Because, using vanilla docker without using the built in kubernetes, took manual steps.</li> </ul> </li> <li>TrueNAS Scale - Re-enable Apt-get<ul> <li>Because someone at IX-Systems said, Hey, Before we ship this image, run <code>chmod -x /bin/apt*</code></li> </ul> </li> <li>TrueNAS Scale - VMs cannot access host</li> </ol> <p>And, while checking my news feed one day, I noticed Unraid had dropped a new version 7 beta.</p> <p>Unraid: 7.0.0 Release Notes</p> <p>The feature which caught my eye- NATIVE ZFS Pools.</p> <p>I installed the beta, and switched everything over the next day.</p> <p>I have honestly been here every since. Since, the 40G NAS Project is effectively dead, and no longer used or needed- Unraid honestly, suits my needs very well.</p> <p>I will, quickly touch base on a few features....</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#features-functionality-between-unraid-and-truenas-scale","title":"Features / Functionality between Unraid, and TrueNAS Scale","text":"<p>So first- lets get some misconceptions out of the way.</p> <p>Both Unraid and TrueNAS Scale, use the exact same OpenZFS, and the exact same KVM/QEMU. This means- they have the exact same capabilities.</p> <p>The only differences are the user interfaces, and, there are some notable differences.</p> <p>TrueNAS Pros:</p> <ol> <li>Snapshot management built in, without using a 3rd party plugin. (But, you can easily add sanoid/syncoid to unraid.)</li> <li>No FUSE. Its lightning fast. (Unraid 6.12 added \"Exclusive Shares\", which mitigates this issue for exclusive pools.)</li> <li>ZVol / iSCSI Management, Built In. (Unraid has plugins which can add iSCSI, but, its not native.) TrueNAS makes it effortless to provision a zvol, and attach to a server. Unraid can do it..... via the OpenZFS CLI.</li> </ol> <p>Unraid Pros:</p> <ol> <li>The core product has not experienced any massive, breaking changes. (Scale, has underwent multiple MASSIVE changes to how \"apps\" are handled.)</li> <li>The GUI is beautiful. Its simple. And its effective.</li> <li>Has honestly, one of the nicest user interfaces for hardware passthrough to VMs.</li> <li>Flexibility<ul> <li>It can do XFS, ReiserFS, ZFS, or BTRFS. TrueNAS ONLY does ZFS.</li> <li>In addition, It has the \"Unraid Array\", its special thing.</li> </ul> </li> <li>Power Efficiency<ul> <li>Unraid's built in array, is the most power efficient option, for write-once, read-many. See Power Efficient Storage</li> </ul> </li> <li>A nice app store. (Use both- and you will know what I mean)</li> <li>ACLs that aren't a PITA. Google: \"Reddit TrueNAS ACLs\"<ul> <li>Seriously- Unraid's ACLs are very, very easy. They just work. TrueNAS- takes a bit more effort.</li> <li>TrueNAS hands down has much more powerful ACLs, but- for most home uses- the simple ACLs used by Unraid, is PERFECTLY acceptable.</li> <li>Think about it- how many of our labs have more then a single user?</li> </ul> </li> <li>Need more storage? Add a disk. <ul> <li>Size does not need to match. As long as the parity disk is equal or larger in size, you can expand the array.</li> </ul> </li> </ol>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#power-efficient-storage","title":"Power Efficient Storage","text":"<p>One of the biggest reasons I use Unraid, is for energy consumption reductions.</p> <p>ZFS, requires all of the disks in its array to be spinning, in order to read, or write any contents.</p> <p>Ceph, I don't even think it supports disks sleeping.</p> <p>Unraid's \"Array\", is not raid. It stores files, on individual disks, and calculates parity on a dedicated parity drive.</p> <p>So, say, you use Unraid to store your archive of Linux ISOs. And- you need to access a debian ISO from 2011.</p> <p>Well, only the drive containing that ISO would need to spin up, in order to read the data. You can have an array with 32 disks, that only needs to spin up a single drive.</p> <p>This is FANTASTIC for building a media server.</p> <p>Even writes- don't need to spin up the disks. Instead- Unraid offers a cache pool. New data gets stored here. And, eventually the data gets flushed to the main array where it will need to spin up all of the disks, calculate parity, etc.</p> <p>BUT- you can tune the cache to only do this a few times a day, or better- only do when the cache pool is near full. </p> <p>Doing this- my drives spend 99% of the time asleep, saving dozens of watts of consumption.</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#apps-are-just-normal-docker","title":"\"Apps\" are just normal docker.","text":"<p>Remember the links above to things such as IX blocking built-in docker, removing apt-get, changing how apps are handled?</p> <p>Well, Unraid is NOTHING more then vanilla docker. Its even easier to use then portainer.</p> <p>You can use docker-compose files. The user interface will even show your stacks.</p> <p>You can use docker CLI. And it will work with the user interface.</p> <p>You can use the apps catalog. You can build your own apps. </p> <p>Its nothing but VANILLA docker. There is nothing that stops you, from managing your containers, on your hardware, how YOU want to manage them.</p> <p>Seriously- I am going to rant about this. IX-Systems for SOME REASON thought I shouldn't be able to use the distribution how I want to use it. If I want to shoot myself in the foot- then let me shoot myself in the foot. I want to control MY hardware, the way I want to control my hardware.</p> <p>So, massive win, for just having a nice interface around a widely used service.</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#interface","title":"Interface","text":"<p>I personally love the unraid interface. The dashboard, contains all of the information you need to see at a glance.</p> <p>Its extensible. You can find plugins to display whatever you want to see.</p> <p>Its easy to make VMs. Its easy to make containers. Its easy to add shares.</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/my-history-with-unraid/#summary","title":"Summary","text":"<p>A very short post- Originally this content was apart of 2024 Homelab Summary, However, I broke it out to have its own post.</p>","tags":["Homelab","Homelab/TrueNAS","Homelab/Unraid"]},{"location":"blog/2024/edgemax---git-backups/","title":"Edgemax - Auto sync configuration to git","text":"<p>Many years ago, I had setup a system which would automatically sync my Edgemax's configuration to a local git repo.</p> <p>It worked so good, I had completely forgotten about it. During a firmware update last year, it had stopped working.</p> <p>So- I went through, fixed and updated the scripts- and I am now sharing them with you.</p>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#before-you-start","title":"Before you start","text":"<p>Danger</p> <p>Take backups!!!!!</p> <p>I am not responsible for you losing your entire configuration !</p> <p>Take a backup before you touch anything. Save it somewhere AWAY from the router.</p>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#prerequisites","title":"Prerequisites","text":"<ol> <li>Have a working git repository.</li> <li>Edgerouter/Edgemax will need internet access to download the git package.</li> </ol>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#details","title":"Details","text":"","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#what-this-script-will-do","title":"What this script will do","text":"<ol> <li>Generate a hook causing a git commit to be created every time the configuration is updated.</li> <li>System package configuration will be updated, to include archived debian squeeze. This is needed to install git.</li> <li>Git will be installed.</li> <li>A new ssh-key will be generated, if one does not already exist.<ul> <li>You will be presented with the public key, and prompted to add it to your git repo/server.</li> </ul> </li> <li>A scheduled task will be configured, which will do a periodic backup. <ul> <li>This is to capture dhcp leases.</li> </ul> </li> <li>Generate a hook, which runs at system boot<ul> <li>Set expected permissions, and ownership of scripts.</li> <li>Create sym links for ssh keys, and hooks</li> </ul> </li> </ol>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#what-will-be-stored-in-git","title":"What will be stored in git?","text":"<ol> <li><code>/config/config.boot</code><ul> <li>This is the primary configuration file.</li> </ul> </li> <li><code>/config/*leases</code><ul> <li>DHCP Leases</li> </ul> </li> <li><code>/config/user-data</code><ul> <li>Associated scripts, and any other custom user-data you have stored.</li> <li>Note- This will include your private key. If this is not wanted, modify <code>/config/user-data/hooks/03-edgerouter-backup.sh</code> to remove this step.</li> </ul> </li> <li><code>/config/scripts</code></li> </ol> <p>You can modify as you like to add, or remove any other data.</p>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#how-does-the-data-get-backed-up","title":"How does the data get backed up?","text":"<p>After the script has been installed, a hook will be generated in <code>/etc/commit/post-hooks.d</code></p> <p>After you have executed \"commit\", this will invoke the script, which will create a backup.</p> <p>In addition to the above hook, the backup script will also run on a periodic timer, which lives in your configuration under <code>System &gt; Task Scheduler &gt; Task &gt; Backup Config</code></p> <p>Once the script has been invoked, it will copy selected files to the cloned repo, which by default is stored in <code>/root/backup</code></p> <p>Then, each of the files will be added to a new commit. The message will be automatically generated, and the changes will be pushed.</p> <p>Thats, basically it.</p>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#installation","title":"Installation","text":"<p>The entire script is LOCATED HERE</p> <p>You will need to modify ONE line. It is at the very top of the script.</p> edgemax-install-script.sh<pre><code># Update this to point at YOUR git server.\nGIT_SERVER=gitea@gitea.yourdomain.com:youruser/yourrepo.git\n</code></pre> <p>No other changes are needed.</p> <p>For a mostly scripted install...</p> <p>First- this will download the script, and open in an editor.</p> <p>Warning</p> <p>As a general warning- I do not recommend blinding downloading and running scripts from the internet.</p> <p>Please ALWAYS do your due diligence to validate what you are running.</p> <p>Even if you trust me- I don't control what happens between my server, and you. Always analyze scripts.</p> <p>This can be copy and pasted directly into a terminal.</p> <pre><code>SCRIPT_FILENAME=/tmp/setup-git-sync\ncurl https://static.xtremeownage.com/blog/Technology/2024/assets/edgemax-install-script.sh &gt; $SCRIPT_FILENAME\n# Open VI, so you can update the configuration. Set your git server.\nvi $SCRIPT_FILENAME \n</code></pre> <p>After you have made your required changes (update the git repo), we can add the execute flag, and run it.</p> <pre><code># Set script as executable.\nchmod +x $SCRIPT_FILENAME\n\n# Execute the script\n$SCRIPT_FILENAME\n</code></pre>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#resulting-output","title":"Resulting output","text":"<p>Since- I already had everything configured- there are not many changes. However, I did ensure the script is re-enterable. That is- running it multiple times, will not break anything.</p> <pre><code>Linux fw2 4.9.79-UBNT #1 SMP Thu Jun 15 11:34:57 UTC 2023 mips64\nWelcome to EdgeOS\nLast login: Thu Dec 26 15:39:24 2024 from 10.100.5.5\nroot@fw2:~# SCRIPT_FILENAME=/tmp/setup-git-sync\n\n# Note- by the time you read this- it won't be pointing at the dev site.\n\nroot@fw2:~# curl https://dev.static.xtremeownage.com/blog/Technology/2024/assets/edgemax-install-script.sh &gt; $SCRIPT_FILENAME\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100 10219  100 10219    0     0  23401      0 --:--:-- --:--:-- --:--:-- 23438\nroot@fw2:~# # Open VI, so you can update the configuration. Set your git server.\nroot@fw2:~# vi $SCRIPT_FILENAME\nroot@fw2:~# # Set script as executable.\nroot@fw2:~# chmod +x $SCRIPT_FILENAME\nroot@fw2:~#\nroot@fw2:~# # Execute the script\nroot@fw2:~# $SCRIPT_FILENAME\nDirectory already exists: /config/user-data\nDirectory already exists: /config/user-data/hooks\nDirectory already exists: /config/scripts\nDirectory already exists: /config/scripts/post-config.d\n\nSSH key found at /config/user-data/id_rsa\n\n###########################################################################\n#### PUBLIC KEY. (Make sure to add this to your github/gitea/git server/etc.)\n###########################################################################\n\n# Note, Its a public key. Its not sensitive. Hence, the name \"Public\" key. Don't get too excited. \n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDgbzBQ5KSiOjq73noF3LFCbZFf/9JCqwIWM/uLCgtvcbLyXKoyYrkymQ2be9aRGaYMSn5gOg6WweKKwSDmZ2CA0/hj5GnyaGVp327LdF7CWOVMlJDumm/1/rhM6Jp2dr72tkI08LfJ4cWjh715Tlq6mQsiW9SqNA6LgJgzwgVd/RnM1dVX8jPuYMLFpnScrcvea6Qsfbet0JM2X1jDRfNQZOZ+BY3+aKnnk+ISzZI6AbcFnEKPEQnCc8DqNAivjdBBq0LXsOc+vBJFZ+so+RgpCBD3NWfo9RIwXRQ3R9VZgeHsySv4tL3uc7uZ4S39NxMnhzzjVH/hlI1lkEPKynzebrofT72SLP4R8drXeh3zebjpgcynaCgjqJQvXcE5MPwL6Md//sF3hWY11ep+6ssGx4iowu+FIkmTYiLXOibAMYvGL+Rktme3olkur4zeB4JveBF1KFvY4MMwLDfTjMBadaET1GoJnfFS2dUozwn46rSHW7GlDqx3162FTi51GDt2czIQYa7IGUbf2ymGZTN9/xdvxQx5fwjqcbiGfhFV8ExnuvcjQmS5BpIu5jS0gJo17aLPHbEZ0+tB7t6gNDCM8Fx/Hw39u/jRnj8bvN+40QNFGMRODm6iPVOBEU13lBVpc6Yf6x6tvao39AtfRo6JAoD/k8R0OkAVg6Cg1GK6Vw== root@fw2\n\n###########################################################################\n#### END PUBLIC KEY\n###########################################################################\n\n# Note- git address, repo, username anonymized\n\nPlease add the above public key to the security configuration for gitea@mydomain.com:myuser/myrepo.git\nPress Enter to continue after you have added the public key to gitea@mydomain.com:myuser/myrepo.git...\nContinuing with the script...\\r # This non-interpreted carriage return will also be fixed.\nAdded system &gt; package &gt; repository configuration for debian stretch\nThe specified configuration node already exists\nThe specified configuration node already exists\nThe specified configuration node already exists\nGit is already installed.\nFile /config/backup created successfully.\nFile /config/user-data/edgerouter-backup.conf created successfully.\nFile /config/user-data/hooks/03-edgerouter-backup.sh created successfully.\nFile /config/scripts/post-config.d/hooks.sh created successfully.\nFile /config/scripts/post-config.d/hooks.sh created successfully.\nSetting file permissions....\nfatal: destination path '/root/backup' already exists and is not an empty directory.\nRepository cloned from gitea@mydomain.com:myuser/myrepo.git to /root/backup\nRunning init script\nSetting system &gt; task-scheduler &gt; task &gt; backup-config\nThe specified configuration node already exists\nThe specified configuration node already exists\nSaving changes. Script execution complete.\nSaving configuration to '/config/config.boot'...\nDone\n</code></pre> <p>And.... history-</p> <pre><code>root@fw2:~/backup# git log\ncommit ac802967acb93633a91f03f90884d8e7aea493a6\nAuthor: root &lt;root@fw2.xtremeownage.com&gt;\nDate:   Thu Dec 26 17:00:02 2024 -0600\n\n    Auto commit by edgerouter-backup on fw2 | by root | via other | 2024-12-26 17:00:02\n\ncommit c886aeb3c2b23c630fed4ef320f2c95b8c29bacb\nAuthor: root &lt;root@fw2.xtremeownage.com&gt;\nDate:   Thu Dec 26 16:44:44 2024 -0600\n\n    Auto commit by edgerouter-backup on fw2 | by root | via other | 2024-12-26 16:44:44\n\ncommit e4d10da5067faab3783f9a1bdabdc7df0cb4aa53\nAuthor: root &lt;root@fw2.xtremeownage.com&gt;\nDate:   Thu Dec 26 16:36:40 2024 -0600\n\n    Updated scripts\n\ncommit 06bca4b198ad2d3c17d27666e78a2db81db70921\nAuthor: root &lt;root@fw2.mgmt.xtremeownage.com&gt;\nDate:   Thu Dec 26 16:33:02 2024 -0600\n\n    Auto commit by edgerouter-backup on fw2 | by root | via other | 2024-12-26 16:33:02\n\ncommit 86f49d2eebfacfeecd9358620a0ffe25dcda1039\nAuthor: root &lt;root@Router.xtremeownage.com&gt;\nDate:   Thu Aug 19 12:34:01 2021 -0500\n\n    Auto commit by edgerouter-backup on Router | by root | via other | 2021-08-19 12:34:01\n\ncommit 6b7b2c2878e326dce8c50c07fa2a4da5bf8047b2\nAuthor: root &lt;root@Router.xtremeownage.com&gt;\nDate:   Thu Aug 19 12:00:01 2021 -0500\n\n    Auto commit by edgerouter-backup on Router | by root | via other | 2021-08-19 12:00:01\n\ncommit 89135eae5f462e4b88c2fc7a13d6cb2cc03d2168\nAuthor: root &lt;root@Router.xtremeownage.com&gt;\nDate:   Thu Aug 19 11:00:01 2021 -0500\n\n    Auto commit by edgerouter-backup on Router | by root | via other | 2021-08-19 11:00:01\n\ncommit fcbba6781306b1f2547223bd59cef24de19b21bc\nAuthor: root &lt;root@Router.xtremeownage.com&gt;\nDate:   Thu Aug 19 09:00:02 2021 -0500\n\n    Auto commit by edgerouter-backup on Router | by root | via other | 2021-08-19 09:00:01\n</code></pre>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/edgemax---git-backups/#summary","title":"Summary","text":"<p>Thats, basically it.</p> <p>You... change the configuration, it commits it to git.</p> <p>Its not perfect, and I am sure there are flaws. However, it suits my needs. </p> <p>And- I am sharing it with you. </p> <p>If, you do have a good idea, or enhancement, feel free to share it, there are social links in both the header, and footer of this site.</p>","tags":["Homelab","Networking","Networking/Edgemax"]},{"location":"blog/2024/2024-homelab-status/","title":"My homelab - End of 2024","text":"<p>This post will go over my lab, as a whole as of December 2024.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#overview","title":"Overview","text":"<p>I will split this post into a few sections.</p> <ol> <li>Compute<ul> <li>Discuss the servers, and workloads.</li> </ul> </li> <li>Storage<ul> <li>Discuss the various types of storage used.</li> <li>Backups</li> </ul> </li> <li>Power<ul> <li>How is my lab powered? </li> <li>Solar-powered lab</li> <li>How are outages handled?</li> </ul> </li> <li>Networking<ul> <li>A overview of how the network is setup, technologies used.</li> </ul> </li> <li>Issues / Complaints\"<ul> <li>What I want to improve on.</li> </ul> </li> <li>Rack Accessories, Organization, Cables<ul> <li>This- is the section for things seen in the rack. Finger trays, custom enclosures, the rear-mounted power management, etc.</li> <li>This section also includes links to all of the cables used, Ethernet, Fiber, DACs, SAS, etc.</li> <li>If anyone is looking for any of the specific products you see in my rack, I will include links.</li> </ul> </li> </ol> <p>But- first, a brief overview.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#pictures","title":"Pictures","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rack-itself","title":"Rack itself","text":"<p>This, is the front of my rack.</p> <p></p> <p>This- is the bottom, rear of the rack.</p> <p></p> <p>This, is the top-rear. I have my PDUs, and ATS mounted here.</p> <p></p> <p>This, is the top of the rack, looking down. (The ESP you see is a BT proxy for Home Assistant)</p> <p></p> <p>When- I am not working on my rack, It lives in the closet.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#power-delivery","title":"Power Delivery","text":"<p>I will go into this more in-depth further down- but, I have a pretty comprehensive power delivery system, with a few redundancies</p> <p></p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#compute","title":"Compute","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#servers-hardware","title":"Servers / Hardware","text":"<p>For servers, I have a balance between small, efficient hardware and enterprise servers.</p> <p>I run 5 machines, 24x7. The compute element of my lab uses around 350-400 watts.</p> <p>ALL of my servers run Proxmox as the base OS. </p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#optiplex-sffs","title":"Optiplex SFFs","text":"<p>First- I have a pair of optiplex SFFs- These are the \"core\" compute elements of my lab.</p> <p>These machines are reasonably efficient, and quite flexible. </p> <p></p> <ul> <li>2x Optiplex 5060 SFF Ebay: Optiplex 5060 SFF<sup>3</sup><ul> <li>i7-8700 (6c / 12t @ 3.20ghz)</li> <li>64G DDR4 (MAX Ram: 64G, 4 DIMMs, No ECC)</li> <li>LSI 9287-8e SAS HBA (External) eBay: LSI 9287-8e<sup>3</sup><ul> <li>This connects to the MD1220 disk shelf, which contains both SAS and SATA SSDs primarily used for CEPH.</li> <li>Each SFF, has access to \"Half\" of the shelf. (The shelf is running in \"split\" mode)</li> </ul> </li> <li>Mellanox ConnectX-4 CX-416A 100GBe Dual Port NIC eBay: ConnectX-4 CX-416A<sup>3</sup><ul> <li>This is the primary network connection.</li> <li>One port on each host connects to the 100G switch</li> <li>The other port, is used for failover, and is connected to my 10G Unifi Aggregation Switch.</li> <li>I picked these up for around 125$ each.</li> </ul> </li> <li>128G Kioxia NVMe eBay: 128G Kioxia NVMe<sup>3</sup><ul> <li>These things are dirt-cheap, and make great boot drives.</li> </ul> </li> <li>Power: These machines average around 50 watts. <ul> <li>These are the backbone of my ceph cluster, which houses the majority of my lab's storage.</li> <li>100GBe + SAS Controllers, does not do any favors for energy consumption.</li> </ul> </li> </ul> </li> </ul> <p>These machines are literally the backbone of my ceph cluster. The i7-8700 offers pretty good performance, and runs the bulk of my VMs.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#optiplex-micros","title":"Optiplex Micros","text":"<p>Next up, I have a pair of Optiplex Micros.</p> <p></p> If- you are curious about the enclosure- Its homemade in my garage (Click to expand..) <p>I honestly, was not very happy with the outcome of this enclosure- However, it does work well.</p> <p></p> <p></p> <p></p> <p>All of the imperfections are hidden by blanks.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#left-optiplex-micro-3070m","title":"(Left) Optiplex Micro 3070m","text":"<p>eBay: Optiplex 3070m<sup>3</sup></p> <p>Specs:</p> <ul> <li>CPU: i5-9500t (6c / 6t @ 2.20ghz)</li> <li>RAM: 24G DDR4</li> <li>Boot Drive: Samsung 980 1T [Amazon]<sup>4</sup></li> <li>NVR Storage: Samsung 870 QVO 4T SATA [Amazon]<sup>4</sup><ul> <li>This- is the primary storage for my NVR.</li> <li>SSD is used here instead of spinning rust for power efficiency. </li> <li>Also, makes accessing historical footage, snappy fast.</li> </ul> </li> <li>Power: This machine averages around 20w, while running my NVR 24/7/365.</li> </ul> <p>While this machine is inside of my proxmox cluster, its primary purpose is to run my NVR.</p> <p>It runs a Blue Iris VM, with over a handful of 5MP Reolink POE Cameras. It does an amazing job of it.</p> <p>It also runs a kubernetes VM, where Frigate runs. Frigate has a USB-Type C Coral TPU attached for object detection.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#right-optiplex-7050m","title":"(Right) Optiplex 7050m","text":"<p>eBay: Optiplex 7050m<sup>3</sup></p> <p>Specs:</p> <ul> <li>CPU: i7-6700 (4c / 8t # 3.40ghz)</li> <li>RAM: 16G DDR4</li> <li>Boot Drive: 256G Liteon SATA SSD</li> <li>VM Storage: 1T Samsung 980 1TB</li> <li>Power: 10w average.</li> </ul> <p>This, is one of the oldest machines in my lab. Its extremely efficient, and it works very well.</p> <p>Its silent. Its efficient.</p> <p>This is also the ONLY machine I have local storage for VMs. </p> <p>This machine hosts my Home Assistant VM, and a backup DNS server, both of which are on local storage.</p> <p>These- are on local storage- to ensure my home assistant remains working, even when I break my network....</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rack-servers","title":"Rack Servers","text":"<p>Now- we get to the big hardware.</p> <p></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#top-dell-r730xd","title":"(Top) Dell R730XD","text":"<p>[Ebay: Dell R730XD]<sup>3</sup></p> <ul> <li>Processor: 2x E5-2697a V4 (16c / 32t @ 2.6/3.6ghz ). Total: 32c, 64t</li> <li>Memory: 256GB DDR4 ECC (16 of 24 DIMMs populated)</li> <li>Primary NIC: 100Gbit Mellanox CX-4 [eBay]<sup>3</sup></li> <li>Secondary NIC: Dell 8887V ConnectX-4121C Dual port 25GBe [eBay]<sup>3</sup><ul> <li>Not used. These- are honestly DIRT cheap. They are literally only 11$ as of right now.</li> <li>Very nice NIC though.</li> </ul> </li> <li>Storage: <ul> <li>16x M.2 NVMe<ul> <li>I really like my NVMe. If you can't tell.</li> </ul> </li> <li>4x 16T 3.5\" SATA</li> <li>8x 8T 3.5\" SATA</li> <li>32G Samsung FIT<ul> <li>This runs Clover bootloader. My r730xd cannot boot from the M.2 which contains proxmox.</li> <li>So- I have a thumb drive which contains clover, which automatically boots into proxmox.</li> </ul> </li> <li>32G Samsung FIT<ul> <li>Unraid's Boot Drive</li> </ul> </li> </ul> </li> <li>HBA: Dell P2R3R PERC HBA330 Mini [eBay]<sup>3</sup><ul> <li>This is a JBOD-ONLY HBA. I replaced the raid HBA with this, for use with ZFS.</li> <li>This is passed directly into the Unraid VM.</li> </ul> </li> <li>Power Consumption: Yes.<ul> <li>This server is an energy hog.</li> <li>Average Consumption: 238w</li> </ul> </li> </ul> Expansion Slot Details. Click to expand <ul> <li>Slot 1: \"Generic\" dual M.2 cards [Amazon]<sup>4</sup><ul> <li>2x Samsung 1T PM963 Enterprise NVMe [eBay]<sup>3</sup></li> <li>Blog Post: Installing more NVMe into the r730XD</li> <li>4x4 bifurcation</li> </ul> </li> <li>Slot 2: \"Generic\" dual M.2 cards [Amazon]<sup>4</sup><ul> <li>2x Samsung 1T PM963 Enterprise NVMe [eBay]<sup>3</sup></li> <li>4x4 bifurcation</li> </ul> </li> <li>Slot 3: Mellanox ConnectX-4 CX-416A 100GBe Dual Port NIC [eBay]<sup>3</sup><ul> <li>This is the primary network adapter used. </li> <li>Installed in one of the x8 short slots. (Limits max throughput to around 60Gbit/s)</li> <li>No bifurcation</li> </ul> </li> <li>Slot 4: Asus Hyper M.2 [Amazon]<sup>4</sup><ul> <li>4x Samsung 1T PM963 Enterprise NVMe [eBay]<sup>3</sup></li> <li>4x4x4x4 bifurcation</li> </ul> </li> <li>Slot 5: Quad M.2 PLX Switch<ul> <li>Post: Adding Bifurcation to the r720XD (More detail about the cards, what cards to get, installation, etc.)</li> <li>These were originally used in the r720xd, but, are now used in the r730xd too, just to squeeze in a few more M.2</li> <li>No bifurcation</li> <li>1x Samsung 1T PM963 Enterprise NVMe [eBay]<sup>3</sup><ul> <li>Proxmox Boot Drive</li> </ul> </li> <li>2x Samsung 970 Evo Plus NVMe<ul> <li>Unraid ZFS Cache Pool (Mirrored)</li> </ul> </li> <li>1x Samsung 970 Evo NVMe<ul> <li>Unraid \"Scratch/Cache\" Pool</li> </ul> </li> </ul> </li> <li>Slot 6: Asus Hyper M.2 [Amazon]<sup>4</sup><ul> <li>4x Samsung 1T PM963 Enterprise NVMe [eBay]<sup>3</sup></li> <li>4x4x4x4 bifurcation</li> </ul> </li> </ul> <p>A fair amount of hardware is passed directly into Unraid.</p> Unraid Passthrough Hardware (Click to expand) <ul> <li>Unraid VM<ul> <li>CPU: 32 Cores (Logical, Not Physical)</li> <li>Memory: 64G</li> <li>2x Samsung 970 Evo Plus NVMe<ul> <li>These are used in a Mirrored ZFS Pool, INSIDE of Unraid. This- is my primary cache pool.</li> </ul> </li> <li>1x Samsung 970 EVO 1TB<ul> <li>This is used as another cache pool, for certain applications which are frequently writing data.</li> <li>Non-redundant.</li> </ul> </li> <li>8x 8T Seagate Exos<ul> <li>In 2021, I ordered 12x of these USED.</li> <li>It will be 2025 in less than two weeks, I have only had to return a single drive.</li> <li>Four of these are used in a ZFS Striped Mirror combination, for my \"Important\" data.</li> <li>One is used in the main Unraid \"Array\"</li> </ul> </li> <li>4x 16T Sata<ul> <li>Three are WD Drives. The fourth is a Seagate Iron Wolf.</li> <li>These form the main Unraid \"Array\", where I do bulk storage duties.</li> </ul> </li> <li>32G Samsung FIT<ul> <li>This is my original flash drive for unraid, purchased in 2020.</li> <li>This is Unraid's boot drive.</li> </ul> </li> </ul> </li> </ul> <p>Purpose</p> <p>This server's primary purpose is to host the Unraid VM, and its associated storage.</p> <p>It also hosts a significant amount of NVMe storage used with Ceph.</p> <p>I have HA rules configured to try to prioritize other hardware, as the other hardware uses less energy for a given amount of compute.</p> <p>HOWEVER- This machine has enough resources to literally host EVERYTHING. It has LITERALLY half of the resources.</p> <p>64 of the 102 CPUs is from this machine. 256G of the 416GB of ram is from this machine.</p> <p></p> <p>Maintenance is much easier when you have enough resources to live-migrate multiple machines at a time.</p> <p>This machine was acquired after my R720 Died at the beginning of 2023.</p> <p>Unraid's Purpose</p> <p>The primary purpose of Unraid, is for my \"Media center\".</p> <p>It hosts plex, along with a handful of containers which supports media streaming.</p> <p>It is also my primary SMB, and NFS host.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#bottom-dell-r720xd","title":"(Bottom) Dell R720XD","text":"<p>The r720XD is the server which was used in my 40G NAS Project.</p> <p>After it died last year, the r730xd was picked up to replace it. </p> <p>Its use case: Storage for DDR3 DIMMs, Unused 10G NICs, Extra HBAs, etc.</p> <p>It makes a very useful drawer in my rack.</p> R720XD Specs <ul> <li>CPU: 2x Intel Xeon E5-2667v2<ul> <li>8c / 16t @ 3.3/4.0Ghz</li> </ul> </li> <li>Memory: 128G DDR3</li> <li>HBA: Dell Perc H310 Flashed to IT Mode<ul> <li>Fohdeesha Guide</li> </ul> </li> </ul>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#applications-services","title":"Applications / Services","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#proxmox","title":"Proxmox","text":"<p>As previously stated, Proxmox runs bare metal on all of my servers. </p> <p>It has built in ceph cluster management, built in firewall rules, ACLs... It has built in backups, and overall, its just a fantastic base OS.</p> <p>Once upon a time, I did run Kubernetes (microk8s) bare metal. However, while out on a work-related trip, The cluster decided to.... Not work.</p> <p>Everything was wiped the following week, and Proxmox was installed bare metal. It has been that way ever since.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#kubernetes","title":"Kubernetes","text":"<p>Kubernetes is used to run around 90% of my containers. </p> <p>I am currently running Rancher + K3s. </p> <p>My K3s cluster has 7 VMs, scattered amongst the various servers. </p> <p></p> <ol> <li>rancher<ul> <li>This is a VM which only runs a single docker container, containing rancher.<ul> <li>I do this, to allow me to separately upgrade and maintain rancher, as rancher itself, is used to upgrade and maintain the cluster.</li> </ul> </li> </ul> </li> <li>rke-master-1<ul> <li>This is the master server. I only run a single master, as I rely on hypervisor redundancy here.<ul> <li>A single master reduces complexity, where the proxmox cluster itself, can handle the redundancy.</li> </ul> </li> </ul> </li> <li>k8s-admin<ul> <li>Generic admin box. Gotta manage the cluster!</li> </ul> </li> <li>Worker VMs (4)<ul> <li>1-3, have HA policies which prefers a specific machine. In this case, Both SFFs, and the r730XD get a VM.</li> <li>In the event of issues, cluster maintenance, these VMs are free to migrate as needed.</li> <li>rke-worker-4, this node is tainted to only allow NVR-related activities to run. It is pinned to the optiplex micro which runs my NVR.</li> </ul> </li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#unraid","title":"Unraid","text":"<p>Unraid itself, is running as a VM, on the R730XD. It is noted here as it runs all of the \"media-related\" compute.</p> <p>Aka, all of the associated docker containers, runs directly on unraid.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#storage","title":"Storage","text":"<p>Storage for my lab is provided by a few different means.</p> <ol> <li>CEPH<ul> <li>Ceph provides the primary storage used for both Proxmox VMs, LXCs, and Kubernetes containers.</li> <li>Hosted by both Optiplex SFFs as well as the R730XD.</li> <li>Blog Post: Building a ceph cluster<ul> <li>While- I have quite a few more OSDs now, and have 100G networking instead of 10G- Its still the same basic cluster.</li> </ul> </li> </ul> </li> <li>Unraid<ul> <li>Unraid provides SMB, and NFS storage.</li> <li>Its primary use-case is providing energy efficient BULK storage.</li> <li>As noted above, it is running as a VM on the r730xd.</li> </ul> </li> <li>Synology<ul> <li>This is used for backups only.</li> <li>Blog Post: My Backup Strategies<ul> <li>This goes over how backups are performed from Kubernetes, Unraid, and Proxmox.</li> </ul> </li> </ul> </li> </ol> <p>Inside of the rack- you may have noticed the storage arrays as well.</p> <p>Note</p> <p>To note, While I really enjoy the flexibility and reliability of ceph- </p> <p>I don't feel it is the perfect solution for my needs. Its just the best solution I have tested so far.</p> <p>Ideally, I'd love a better solution, which is Distributed, Flexible, and Reliable.... That also integrates with Proxmox &amp; Kubernetes.</p> <p>Perhaps 2025 will bring something.....<sup>1</sup></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#storage-hardware","title":"Storage - Hardware","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#dell-md1220","title":"Dell MD1220","text":"<p>Ebay: Dell MD1220<sup>3</sup></p> <p>Specs:</p> <ul> <li>Bays: 24x 2.5\" SAS / SATA</li> <li>Controllers: 2x 6Gbit SAS</li> <li>Power Consumption: 45 watts. Empty shelf will use 35-40 watts.</li> </ul> Purpose <p>This storage shelf's only purpose is to present a JBOD of SSDs to the two Optiplex SFFs. </p> <p>All of the installed SSDs are used by ceph.</p> <p>This shelf is running in \"Split Mode\". This \"Splits\" the shelf between  both SFFs.</p> <p>For- more information, please read the MD1200 series manual, Page 19-20.</p> <p>As a random note- my shelf arrived with 24x 2.5\" 15k SAS disks. Nearly 300 watts worth of them.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#dell-md1200","title":"Dell MD1200","text":"<p>Specs:</p> <ul> <li>Bays: 12 3.5\" SAS / SATA</li> <li>Controllers: 2x 6Gbit SAS</li> <li>Power Consumption: Empty shelf will use 35-40 watts.<ul> <li>Fully loaded with 3.5\" disks, this shelf will consume around 150w, 24/7.</li> <li>3.5\" disks, 8-12w each.</li> </ul> </li> </ul> Purpose <p>This shelf does not yet have a purpose.</p> <p>I have been trying to decide between two potential use-cases.</p> <ol> <li>Moving all of my unraid storage to this shelf, giving unraid the ability to migrate around the cluster, as SAS can multipath.</li> <li>Offline / Cold storage.</li> </ol> <p>Until a purpose has been determined, this shelf is powered off.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#synology-ds423","title":"Synology DS423+","text":"<p>I picked this model specifically, due to its Intel processor. </p> <p>If- I ever wanted to repurpose this into a plex streaming box, the integrated quicksync iGPU would become extremely handy.</p> Hardware Specs <ul> <li>CPU: Intel Celeron J4125</li> <li>RAM: 18GB<ul> <li>2GB is on the board itself.</li> <li>I added an additional 16G Curcial stick. Max \"Officially\" supported RAM is 6GB. Can confirm, it works. Exact ram used is linked below.</li> <li>Amazon<sup>4</sup></li> <li>Newegg</li> </ul> </li> <li>Storage: 4x 8T Seagate Exos</li> <li>Storage (NVMe): 1x Samsung 970 Evo.<ul> <li>Used as READ cache.</li> </ul> </li> </ul> <p>As stated above- this box's sole purpose is backups, and replication.</p> <p>Read more: My backup strategies (This post details exactly how it is used.)</p> <p>Also notable- I am using SMB, NFS, and iSCSI Multipathing to get 2Gbits of throughput consistently. This was much more effective then using LACP.</p> <p>Post: How to: Synology Multipathing (Outlines how to configure SMB, NFS, and iSCSI multipathing to take FULL advantage of multiple NICs without using LACP.)</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#storage-software","title":"Storage - Software","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#ceph","title":"Ceph","text":"<p>Ceph is the primary storage used for my VMs, Containers, LXCs, etc.</p> <p>The cluster consists of both SFFs, and the R730XD. </p> <p>A total of 17 SSDs are used as OSDs in my cluster currently. 8 NVMes hosted by the r730xd, the rest enterprise SATA or SAS SSDs inside of the Optiplex SFFs, or the MD1220.</p> <p>The reason I use ceph- is not performance... but, rather reliability, and flexibility.</p> <p>In terms of flexibility, both proxmox and kubernetes have built-in support for Ceph storage. Spinning up storage for new containers, VMs, LXCs... is effortless as a result.</p> <p>In terms of reliability, as long as ONE of the three storage nodes is online, My storage is fully usable. I run 3 copies of each piece of data, which is distributed across all three nodes.</p> <p>Performance, is nothing to write home about. I'll just note- it works. And performance isn't an issue.... (Although, I don't have any workloads hosted on ceph, which are I/O dependant.)</p> <p>If- you want to learn more about my ceph cluster setup, I have my Ceph Cluster: Documentation.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#unraid_1","title":"Unraid","text":"<p>Ok, so, I have went back and forth over the years between Unraid, and TrueNAS.</p> <p>If- you want to know more about why I use Unraid these days, Please see My history with Unraid &amp; TrueNAS</p> <p>But- for now, I will summarize why I use Unraid-</p> <ol> <li>Its simple.</li> <li>Its reliable.</li> <li>It works.</li> <li>Its flexible.</li> <li>It is THE most efficient way (power-wise) for storing large libraries of write once, read many files. <ul> <li>It ONLY needs to spin up a single HDD to access a given file, instead of spinning up an entire array.</li> </ul> </li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#unraids-purpose","title":"Unraid's Purpose","text":"<p>Unraid has a simple purpose in my lab.</p> <p>It provides file shares. Both NFS, and SMB.</p> <p>It provides BULK data over FILE shares. (Aka, When I need to store dozens of terabytes of data.... Like Archiving linux ISOs)</p> <p>It provides ZFS pools for data I want to keep very safe. In addition to having sanoid configured, Its data is backed up daily to my synology.</p> <p>It does not host ANY block storage. It DOES run docker containers, specifically related to \"media\". I run them here, instead of my kubernetes cluster to remove the need to transmit bulk data over the network.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#synology","title":"Synology","text":"<p>My synology's primary use-case, is backups. </p> <p>If- you didn't see the post already- My backup strategies</p> <p>The above post- will detail how the synology is used, with details, screenshots, etc.</p> <p>It does run a single container for minio. This container ONLY replicates data from the minio instance hosted on my Unraid server.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#power","title":"Power","text":"<p>Power- is the element of my lab which has received the most attention and funding.</p> <p>As- the power in my city has been historically unstable, and unreliable- I have taken many steps to attempt to compensate.</p> <p>Back in 2021, I built a homemade UPS out of a hand truck, and a LiFePO4 battery. It has went through quite a few outages, and has held up beautifully. Although- It might be replaced very soon..... with a solar generator<sup>2</sup>.</p> <p>In 2022, I made the decision to completely redo the power for my entire house, and outfit the entire home with solar power generation, and battery backup for EVERYTHING. This project was completed early 2023.</p> <p>If- you are interested to learn more about this project- Please see.... My Solar Project</p> <p>Nonetheless- Lets dig into how everything works.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#mains-power-delivery","title":"Mains power delivery","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#mains-power-diagram","title":"Mains Power Diagram","text":"<p>Here is a diagram which details the flow of mains power through my house.</p> <pre><code>flowchart LR\n    UTILITY[\"Utility Pole\"] --&gt; Meter\n    subgraph Exterior\n        Meter\n        Shutoff[\"Grid Disconnect Switch\"]\n        ATS[\"Automation Transfer Switch\"]        \n    end\n\n    subgraph Garage     \n        MainPanel[\"Main Breaker Panel\"]\n        BackupPanel[\"Critical Loads Panel\"]\n        Battery[\"Battery Bank\"]\n        Inverter[\"Main Inverter\"]\n        Inverter2[\"AC to DC Charger\"]\n    end\n\n    subgraph Exterior2[\"Exterior\"]\n        Generator\n    end\n\n    subgraph Loads\n        Server[\"Server Room\"]\n        L[\"Various Loads\"]\n    end\n\n    Meter --&gt; Shutoff --&gt; | Grid Up| ATS --&gt; MainPanel --&gt; L\n\n    Shutoff --&gt; Inverter --&gt; BackupPanel --&gt; Server\n\n    BackupPanel -.-&gt; | Grid Down| ATS\n\n    Battery --&gt; Inverter\n\n    Generator -.-&gt; |AC| Inverter2 -.-&gt; |48V DC|Battery</code></pre> <p>Lets start on the exterior of the house.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#exterior","title":"Exterior","text":"<p>Power comes into my meter from the pole- this part is pretty standard.</p> <p>After, the first box, is just a switch which will isolate my house from the GRID. </p> <p>Next- we enter the ATS (Automation transfer switch). This- is where most of the magic happens.</p> <p>How the ATS is configured</p> <p>My main breaker panel connects to the transfer switch.</p> <p>When in \"normal\" operation, the transfer switch is connected to the grid. </p> <p>However, when grid frequency, voltage goes out of spec, the ATS will switch to \"backup\" mode. </p> <p>In backup mode, The transfer switch is fed from a 60amp breaker in my \"Critical loads panel\", which is fed directly from the inverter.</p> <p>This means- when the grid goes down- the entire house is powered directly from the inverter.</p> <p>In addition, there is a rapid shutdown breaker, which will cause the solar panels to become inactive.</p> <p>All of the needed cables enter a race, which leads to the garage on the other side of the house.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#garage","title":"Garage","text":"<p>Inside of the garage, is where all of the fancy hardware is stored.</p> <p></p> <p>Note- this is an older picture- I have moved the battery rack, and installed an additional box which contains hardware for monitoring energy.</p> <p>Post: Adding Per-Breaker Energy Monitoring (This post details both the software, and hardware used to monitor energy consumption.)</p> <p>Power enters the garage through the bottom box, and goes inside of the cable race. From there- the main breaker panel is fed directly from the transfer switch.</p> <p>The Inverter, is connected on the MAINS side of the transfer switch.</p> <p>The critical loads panel, is connected directly to the inverter. </p> <p>The rack on the left currently contains a total of 20kwh of LiFEPO4 batteries, with 4/6 bays filled. The inverter is capable of 10-12kw continuous power, and up to 24kw peak bursts.</p> <p>It is fully capable of running the ENTIRE HOUSE, including the central AC unit, when fully off grid.</p> <p>A year or so back- this was tested. After a 100mph wind gust knocked out power for nearly two zipcodes, I ran completely off grid for most of a week (Of course- everything was documented, including lessons learned)</p> <p>The server rack, is fed directly from the critical loads panel. If grid power drops, there is a maximum of 6ms before it is powered from battery.</p> <p>Honestly- there is no need for a UPS at this point.</p> Generator Power <p>In the event the batteries are nearly discharged, and the sun is not shining, I will start up the Harbor freight predator 9000 generator.</p> <p>This- is not an inverter generator, and tends to produce pretty noisy power when under load.</p> <p>This is documented in this post</p> <p>To compensate for this, The generator feeds directly into a 5,000 watt 48V DC Charger, which feeds directly into the battery bank.</p> <p>Then, the 12kw sol-ark 12k produces clean pure sine wave power from the provided DC.</p> <p>Before- we move to the server rack- there is one other thing to note-</p> <p>Multiple forms of surge protection are used.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#server-rack-power","title":"Server Rack Power","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#diagram","title":"Diagram","text":"<p>With the mains power out of the way, lets dig into my miniature data center itself, starting with a diagram.</p> <pre><code>flowchart LR\n    Breaker\n    Outlet\n    UPS\n    Surge[\"Inline Surge Arrestor\"]\n\n    subgraph rack[\"Server Rack\"]\n        PDU1\n        PDU2\n        ATS\n        Servers\n    end\n\n    subgraph closet[\"Networking Closet\"]\n        WAN[\"WAN Router / Firewall\"] --&gt; UPS2\n        LAN[\"LAN Router / Firewall\"] --&gt; UPS2\n        POE[\"POE Switches\"] --&gt; UPS2\n        UPS2[\"Small UPS\"]\n    end\n\n\n    Servers --&gt; PDU1 &amp; PDU2\n    PDU1 &amp; PDU2 --&gt; ATS\n    ATS --&gt; | UPS Inline| UPS\n    ATS --&gt; | UPS Out of line | Surge\n    UPS --&gt; Surge\n    Outlet --&gt; Breaker\n    UPS2 --&gt; Surge\n    Surge --&gt; Outlet</code></pre>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking-closet","title":"Networking Closet","text":"<p>One goal of mine, is to allow the house to resume \"normal operation\" even if my entire rack of servers is offline.</p> <p>To do this, The main \"LAN/WAN\" is handled with low-power hardware.</p> <ol> <li>Unifi UXG-Lite<ul> <li>Link: Unifi</li> <li>This is the primary LAN/WAN Firewall/Router at the time of this post.</li> <li>Very soon, a Mikrotik HEX Refresh will become the primary WAN Router/Firewall, leaving the Unifi for LAN duties.</li> <li>Consumption: MAX 3.8 watts</li> </ul> </li> <li>2x Unifi USW-Lite-8-POE<ul> <li>Link: Unifi</li> <li>One of these powers a pair of access points, as well as a pair of usw-flex switches located in the living room, and garage.</li> <li>The other, powers all of my POE security cameras.</li> <li>Consumption: MAX 8w (Excluding POE Consumption)</li> <li>Note- If the USW-Ultra existed when I installed these... there wouldn't be two POE switches.<ul> <li>I will note, I did attempt to run a TPLink TL-SG1005P<sup>4</sup> for my POE cameras. However- it caused them to frequently crash. </li> </ul> </li> </ul> </li> </ol> <p>These devices are powered with a small, dedicated cyber power UPS unit. In the event of catastrophic failure, loss of solar, generator, and battery- This would keep the primary LAN/WAN online, along with the security cameras.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#server-rack","title":"Server Rack","text":"<p>On the rear of the server rack, I have the incoming power supply.</p> <p></p> <p>I have a pair of vertiv rPDUs to distribute power to my servers. These are 120v PDUs, with individually switched AND metered outlets. These units also cluster together.</p> <p>I did a full write-up of the capabilities here: Vertiv rPDU</p> <p>Overall- these units have been OUTSTANDING. I am- still working on creating a MQTT-based integration which connects them to both home assistant, and emoncms.</p> <p>If- you are interested in this- please checkout rPDU2MQTT on GitHub.</p> <p>I do this- because I like to be able to visualize every single watt which travels through my house.</p> <p>This is an older picture, and far more monitoring has been added since. Nearly every light fixture, every device. There are very few things I don't have monitored now for the entire house.</p> <p></p> <p>I do have a related post for Building energy flow diagram in home assistant</p> Why emoncms <p>I do often get asked why I use Emoncms, when Home Assistant exists, Influx, Prometheus, etc...</p> <p>The reason is- Its STUPID simple, and reliable. It does one thing. It collects and stores data.</p> <p>Not- in a database, but, in a simple flat-file format, where YEARS of energy data at a 15 second interval, only takes up a few kilobytes.</p> <p>The simplicity is key here. I need it to be as reliable as possible. And- it achieves this.</p> <p>Home assistant, occasionally has an update, which will rename entities, causing the energy data to break. As well, occasionally, something will happen, which just destroys its energy diagrams. </p> <p>I have 4 years of data in emoncms. If something is not reporting in data, it will let me know. Things do NOT change in here, without me explicitly changing them.</p> <p>So, TLDR; Its all about consistency, and reliability. Ecmoncms can run on a potato, and has zero external dependencies.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking","title":"Networking","text":"<p>I have a reasonably complex network setup, involving multiple routers, firewalls, switches etc.</p> <p></p> <p>Not Displayed- The closet where my rack resides, also contains.. a few switches, and other small hardware.</p> <p>Note</p> <p>As a note, this post is being written in parallel with my 2024 Network Refresh. </p> <p>I am documenting this in the state it was before that project, since that project will not be fully implemented this year.</p> <p>First- I will break this into the hardware used, and then explain routing, topologies, etc.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking-hardware","title":"Networking - Hardware","text":"<p>In the current state, My entire network consists of Unifi gear, and Mikrotik gear.</p> <p>Unifi gear, is fantastic at making a single plane of glass. </p> <p>It is absolutely horrible, if you want to use layer 3 switches. Post: Why you shouldn't buy a L3 Unifi Switch</p> <p>Also, \"POE\" and \"10G\", results in the same switch costing twice as much.</p> <p>As such, my lab is slowly transitioning away from Unifi, to contain more Mikrotik gear.</p> <p>I have no plans on completely moving away, but, instead wish to use the best piece of gear, where it makes sense.</p> <p>Ie- Unifi is extremely good at managing \"LAN\" subnets, and clients.</p> <p>Mikrotik, is extremely capable in terms of features, and its layer 3 routers, work exactly as one would expect.</p> <p>Also- When debugging- EVERYTHING on the Mikrotik is in real time. Debugging on Unifi can be a huge pain.</p> Unifi Hardware <ol> <li>Unifi: UXG-Lite: <ul> <li>Primary WAN Firewall/Router.</li> <li>Primary LAN Router.</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>5</sup></li> </ul> </li> </ul> </li> <li>Unifi: USW-Pro-24:<ul> <li>Horrible excuse for a \"Layer 3\" switch. Post: Why you shouldn't buy a L3 Unifi Switch</li> <li>Primary 1G switch for server rack.</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Unifi: USW-Aggregation:<ul> <li>Primary 10G Switch, for Server rack.</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Unifi: UAP-AC-Pro:<ul> <li>Wireless Access Point</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Unifi: U6 Pro:<ul> <li>Wireless Access Point</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>3x Unifi: USW-Flex-Mini:<ul> <li>I have these scattered around. One in the garage, one in the livingroom. etc.</li> <li>POE-powered layer 2 switches. Not many features, but, for 29$ each- they do EXACTLY what I need them to do.</li> <li>Links<ul> <li>Unifi</li> </ul> </li> </ul> </li> <li>2x Unifi: USW Lite 8 POE:<ul> <li>When I picked up all of my gear, Unifi didn't have a cost-effective POE switch, such as the USW-Ultra</li> <li>So... I have a pair of these.</li> <li>Links<ul> <li>Unifi</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Ubiquity EdgeMAX / EdgeRouter:<ul> <li>This has been in my home for over a decade. It was my primary router/firewall for most of the last decade. It serves live as my IOT/Security firewall these days.</li> <li>Links<ul> <li>Unifi</li> <li>Not- the same model. Also, out of stock.</li> </ul> </li> </ul> </li> </ol> Mikrotik Hardware <ol> <li>Mikrotik: CRS504-4XQ:<ul> <li>This is the \"CORE\" L3 Router for my network, and handles routing for all of my 10G, 25G, and 100G links.</li> <li>I love this switch. Just saying.</li> <li>Links<ul> <li>Mikrotik</li> <li>ServeTheHome</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Mikrotik: CSS610-8G-2S+:<ul> <li>The switch in my office. </li> <li>Its simple. Its stupid. It works.</li> <li>Links<ul> <li>Mikrotik</li> <li>ServeTheHome</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> <li>Mikrotik: hEX Refresh:<ul> <li>This- will soon be the primary WAN firewall. Until then though- it exists.<ul> <li>See 2024 Network Refresh</li> </ul> </li> <li>Note- this was released VERY recently. If you want one- don't accidentally order one of the older versions.</li> <li>Make sure you are getting the EU50G. Its significantly faster then the other hEX variants.... for the same price.</li> <li>Links<ul> <li>Mikrotik</li> <li>Amazon<sup>4</sup></li> </ul> </li> </ul> </li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking-diagrams","title":"Networking - Diagrams","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#logical-diagram","title":"Logical Diagram","text":"<p>Here is my logical routing diagram.</p> <p>Info</p> <p>Note- IP Subnets, VLAN Identifiers, and ASNs have been randomized.</p> <p>Subnet Masks remain the same.</p> <p>Note, All routers propagate routing information using OSPF. The UXG, EdgeRouter, and Mikrotik all have direct access to each other.</p> <pre><code>flowchart TB\n    subgraph OUTER\n        WAN \n    end\n\n    WAN--&gt; | PPPoe| UXG\n\n\n    subgraph BGP[\"Core 172.16.1.0/24 (OSPF)\"]\n        UXG[\"Unifi UXG-Lite &lt;br /&gt;172.16.1.1\"]\n        EDGEMAX[\"EdgeRouter &lt;br /&gt;172.16.1.3\"]        \n        100G[\"Mikrotik 100G &lt;br /&gt;172.16.1.4\"]\n    end\n\n    100G --&gt; TRUSTED\n    100G --&gt; LAN2\n    EDGEMAX --&gt; SECURE\n    UXG --&gt; LAN\n\n\n    subgraph TRUSTED[\"Servers 192.168.10.0/22\"]\n        direction LR\n        V_Server[\"V_Server  &lt;br /&gt;vlan 14&lt;br /&gt;192.168.10.0/24\"]\n        V_Kubernetes[\"V_Kubernetes  &lt;br /&gt;vlan 18&lt;br /&gt;192.168.11.0/24\"]\n        V_RKE[\"V_RKE  &lt;br /&gt;vlan 22&lt;br /&gt;192.168.13.0/24\"]\n    end\n\n    subgraph SECURE[\"SECURE 192.168.20.0/22\"]\n        direction LR\n        V_MGMT[\"V_MGMT &lt;br /&gt;vlan 50&lt;br /&gt;192.168.20.0/24\"]   \n        V_SECURE[\"V_SECURE  &lt;br /&gt;vlan 25&lt;br /&gt;192.168.21.0/24\"]   \n        V_IOT[\"V_IOT &lt;br /&gt;vlan 30&lt;br /&gt;192.168.22.0/24\"]  \n    end\n\n    subgraph LAN2[\"Internal 10.10.128.0/18\"]\n        direction LR\n        V_LAN_10G[\"V_LAN_10G &lt;br /&gt;vlan 75&lt;br /&gt;10.10.128.0/24\"]\n    end\n\n    subgraph LAN[\"LAN 10.20.0.0/16\"]\n        direction LR\n        V_LAN[\"V_LAN &lt;br /&gt;10.20.1.0/24\"]\n        V_LAN_Isolated[\"V_LAN_Isolated &lt;br /&gt;10.20.2.0/24\"]\n    end</code></pre>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#physical-diagram","title":"Physical Diagram","text":"<pre><code>flowchart LR\n    subgraph Office\n        WAN --&gt; |GPON| MC[\"Media Converter\"]\n        OfficeSwitch[\"Mikrotik CSS610-8G-2S\"]\n\n        OfficeSwitch --&gt; |10G DAC| PC1\n        OfficeSwitch --&gt; |1G| PC2 &amp; PC3\n        PC1[\"Gaming / Main PC\"]\n        PC2[\"Work PC\"]\n        PC3[\"Wife PC\"]\n    end\n\n    MC --&gt; |1G CAT6| USW1\n    OfficeSwitch --&gt; | 10G SM Fiber| AGG\n\n    subgraph Closet\n        USW1[\"Closet-Switch (Unifi USW Lite 8 POE)\"]\n        USW2[\"Security-Switch (Unifi USW Lite 8 POE)\"]\n\n        USW2 --&gt; |CAT6 POE| Security[\"Security Cameras\"]\n        USW1 --&gt; |CAT6 POE| LivingroomSwitch &amp; GarageSwitch\n        LivingroomSwitch[\"USW-Flex-Lite (Livingroom)\"]   \n        GarageSwitch[\"USW-Flex-Lite (Garage)\"]\n\n        USW1 --&gt; |CAT6 POE| UAPACPRO &amp; U6PRO\n        UAPACPRO[\"Unifi: UAP-AC-PRO AP\"]\n        U6PRO[\"Unifi: U6 Pro AP\"]\n    end\n\n\n\n    USW1 &amp; USW2 --&gt; |Bonded 1G| CORE\n    subgraph Rack\n        CORE[\"Unifi: USW-Pro-24\"]\n        AGG[\"Unifi: USW-Aggregation\"]\n        EDGE[\"Ubquiti: EdgeRouter 5\"]\n        100G[\"Mikrotik: CRS504-4XQ\"]\n        UXG[\"Unifi: UXG-Lite\"]\n\n        CORE &lt;--&gt; |10G MM| AGG &lt;--&gt; |10G MM| 100G &lt;-.-&gt; |\"10G MM (STP Down)\"| CORE\n        CORE --&gt; |2x 1G| EDGE &amp; UXG\n\n        100G --&gt; |100G DAC| KUBE01[\"Optiplex 5070\"]\n        100G --&gt; |100G DAC| KUBE02[\"Dell R730XD\"]\n        CORE --&gt; |1G| KUBE04[\"Optiplex 3070m\"]\n        100G --&gt; |100G DAC| KUBE05[\"Optiplex 5070\"]\n        CORE --&gt; |1G| KUBE06[\"Optiplex 7050m\"]\n        CORE --&gt; |2x 1G| NAS[\"Synology\"]\n    end</code></pre> <p>Sorry- the physical diagram is a hair messy.</p> <p>A few notes-</p> <ol> <li>My WAN enters through my office, where its GPON is converted to ethernet.<ul> <li>This feeds into a dedicated vlan on one of the switches in my closet.</li> <li>The core switch then connects this vlan to the UXG-Lite. (a dedicated link exists for LAN traffic)</li> </ul> </li> <li>There is a redundant loop between the switches in my server rack. STP is used to ensure we don't have loops.</li> <li>Not displayed- All of the 100G-connected servers also have a 10G failover link to the 10G switch.</li> <li>The various routers all propage routing information using OSPF.</li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking-security-acls","title":"Networking - Security / ACLs.","text":"<p>All WAN-related ACLs are currently handled by the UXG-Lite, including port forwarding.</p> <p>All ACLs related to my IOT devices, and Security cameras, are handled by the Edgemax/EdgeRouter.</p> <p>All ACLs related to my server, are handled directly inside of proxmox. Its built in firewall maangement, works great for what is needed.</p> <p>Additional ACls are defined inside of my kubernetes cluster, where needed.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#networking-services","title":"Networking - Services","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#dhcp","title":"DHCP","text":"<p>DHCP is handled by...</p> <ol> <li>UXG manages DHCP for its networks.</li> <li>Technitium handles DHCP for the \"LAN 10G\" network, as well as all of the server/kubernetes subnets.</li> <li>The Edgemax handles DHCP for its Security, Management, and IOT subnets.</li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#dns","title":"DNS","text":"<p>DNS is handled by....</p> <ol> <li>Technitium is my primary DNS server.</li> <li>Unifi forwards DNS requests to it, for its subnets.</li> <li>A BIND9 server, using zone transfers is the secondary DNS, and is capable of processing traffic in the event Techitum is down for maintenance.</li> <li>EdgeMAX functions as a DNS forwarder server for its subnets<ul> <li>IOT Subnets do NOT have DNS. None. By design.</li> </ul> </li> </ol>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#ntp","title":"NTP","text":"<p>NTP is handled by my Proxmox servers. </p> <p>An ansible playbook automatially provisions Chrony, running as a time server, and autoamtially adds them to an internal NTP pool.</p> <p>All other servers, networking devices are configured to use this internal pool.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#issues-complaints","title":"Issues / Complaints","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#ceph_1","title":"Ceph","text":"<p>Ceph, is a love and hate relationship for me.</p> <p>As I said above- its EXTREMELY flexible, and very reliable.</p> <p>However- I get a FRACTION of the IOPs out of it, as I have put into it.</p> <p>I have been keeping my eye out for anything which can offer the same level of integration, but, with vastly improved performance.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#lan-seperation","title":"LAN Seperation","text":"<p>My big project this year, is the Networking Revamp. </p> <p>Reason being- I want what I do in my lab, to not affect the LAN at all. </p> <p>Meaning- if I go yank the power cord for all of my servers- my wife shouldn't notice a thing, at least, in terms of the internet.</p> <p>So- the goal is to move the entire LAN-area of the network, outside of my server rack.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#unifi-gateway","title":"Unifi Gateway","text":"<p>My biggest complaint here, there is no \"native/builtin\" support in Unifi for handling my IPv6 GIF tunnels.</p> <p>Without that support- I don't have working IPv6 WAN. That- will be fixed soon though, when the Mikrotik hEX replaces the Unifi as the primary WAN router.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rack-organization","title":"Rack Organization","text":"<p>This section is soley dedicated to links of products used in my rack. Think.... Cable management, Brackets, etc.</p> <p>There is nothing technical documented in this section, its all just product links.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rack-hardware","title":"Rack Hardware","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rack-itself_1","title":"Rack Itself","text":"<p>The rack itself, is a Startech 4-Post 25U Rack.</p> <ul> <li>Amazon: Startec 4U 24U Rack<sup>4</sup></li> </ul>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#front-of-rack","title":"Front of Rack","text":"#1 - Startech 2U Finger Duct <ul> <li>Amazon: Startech 2U Finger Duct<sup>4</sup></li> </ul> <p>Having previously used patch panels, with keystones, and other options- this is my favorite option so far.</p> <p>Not- because its used to hide a mess of wires....</p> <p></p> <p>But- because its extremely easy to maintain.</p> <p>Keystone panels look nice, but, can be a challenge to maintain. Especially- if you color code them like my old panel. </p> #2 - (NoName) 1U Blanks <ul> <li>Amazon: 1U Blanks - 5 Pack<sup>4</sup></li> </ul> <p>Blanks are seriously the difference between an \"OK\" looking rack, and a \"Great\" looking rack.</p> <p>A 5-pack of no-name 1U blanks did the job for me.</p> #3 - Startech 2U Shelf <ul> <li>Amazon: Startech 2U Shelf<sup>4</sup></li> </ul> <p>A simple shelf on my rack is used to hold the Optiplex SFFs, and my Synology.</p> <p>As a note, it sags when loaded with all of the hardware I have on top of it. </p> <p>The below disk shelf provides verticle support &amp; stability. It has full-depth rails.</p> #4 - (NoName) 1U Brush Panel <ul> <li>Amazon: 1U Brush Panel<sup>4</sup></li> </ul> <p>So, the challenge for this particular location was handling the passthrough of not only the massive, fat 100GBe DACs.... But the front-positioned power cables from the CRS504.</p> <p>I settled for using a simple brush panel. </p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rear-of-rack-top","title":"Rear of Rack - Top","text":"#1 - Cable Matters 1U Keystone Panel <ul> <li>Amazon: Cable Matters 1U Keystone Panel<sup>4</sup></li> </ul> <p>Nothing much to say here- But, Cable matters does produce a solid panel.</p> <p>As a bonus, it has \"hooks\" for cable ties, or velcro.</p> <p>In the future, I will be mounting one of these inside of the closet itself, to help cleanup and terminate the incoming cables.</p> #2 - (NoName) 4U Wall Mount <p>For everyone who has read this far- I'm going to assume this is the part you are interested in.</p> <p>How did you verticle mount the PDUs and ATS.</p> <p>WELL, the solution, was actually extremely simple. A simple wall-mount.</p> <ul> <li>Amazon: 19 Inch 4U Heavy Duty Vertical Wall Mountable Rack<sup>4</sup></li> </ul> <p>Seriously, thats it. Its attached using standard cage-nuts, and a few 3/4\" washers.</p> A bit more history (Click to expand, if interested) <p>This- is actually the 2nd attempt at verticle mount.</p> <p></p> <p>Originally, I used a Amazon: Startech 2U Wall-Mount Shelf<sup>4</sup>, with Amazon: Startech 2U 4in spacers<sup>4</sup> to help \"distance\" the shelf from the rack.</p> <p>Since- the shelf was not intended to be rack-mounted, I did need to drill out holes which aligned to standard cage nut spacing.</p> <p>The issue I encountered- my PDUs are not 1U. They are 1.5U, which caused issues when I tried to add an ATS, as seen above.</p> <p>When I decided to pick up a 2nd vertiv PDU, I went ahead and swapped to the 4U rack instead.</p> <p>I mounted it flush to the rack-rails as the new unit had the correct width, and had correctly spaced holes which aligned to cage nuts.</p> <p>The original 2U unit, required drilling out holes which aligned with my cage-nuts.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#rear-of-rack-middle-power-cable-organization","title":"Rear of Rack - Middle (Power cable organization)","text":"<p>On the rear of the rack- hopefully you have noticed the effort I put into cable managment here!</p> <p></p> <p>The solution used here, is just a PAIR of no-name fingers trays.</p> Why <p>Honestly, after spending all of the time and effort cleaning up the front of the rack, I really wanted to try and make the rear pretty as well.</p> <p>Verticle PDUs for 24U racks are pretty hard to come by. And if you want both switched AND individually metered- its extremely difficult to find in a price that I was willing to pay.</p> <p>So- I needed a good way to help organize and clean up the wires, a set of fingers trays- did the job fantastically, with a little help from some velcro.</p> <p>PAIR- is bolded, as this is literally a pair of finger trys, with a spacer.</p> <p></p> <p>Remember.... the spacer that was originally used for holding the verticle shelf containing the PDUs? Well- it lives here now.</p> <p>Products-</p> <ul> <li>Amazon: 2 Pack 1U Finger Duct<sup>4</sup></li> <li>Amazon: Startech 2U 4in spacers<sup>4</sup></li> </ul> <p>The particular \"qiaoyoubang\" 1u ducts used- are actually extremely solid, stamped steel construction.</p> <p>I chose these particular units, due to the large openings between the fingers, which is plenty of room for power cables to fit without rubbing.</p> <p>Here is one final picture showing the top of the cable trays, which was taken before I acquired a 2nd PDU.</p> <p></p> <p>Overall- I am extremely happy with how this turned out.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#cables","title":"Cables","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#thin-ethernet","title":"\"Thin\" ethernet","text":"<p>One factor which really helped cleanup the mess of wires going through my rack- was just by using thinner cables.</p> <ul> <li>Amazon: Monoprice Cat6A 5ft 10-pack<sup>4</sup></li> <li>Amazon: Monoprice Cat6A 3ft 10-pack<sup>4</sup></li> <li>Amazon: Monoprice Cat6A 1ft 10-pack<sup>4</sup></li> </ul> <p>So- the first thing I will note- these DO work for both POE, and for 10G.</p> <p>The cables, also come in different color combinations.</p> <p>I have been using these cables for years, and I am a huge fan of them.</p> <p></p> <p>When I redid all of the cable management this year, I replaced all of the remaining standard CAT6 with these slim cables.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#fiber","title":"Fiber","text":"<p>For my fiber- I have a few different sources.</p> <ul> <li>Amazon: 6-Pack 1ft OM3<sup>4</sup></li> </ul> <p>You can see ONE of these used to link between my USW-PRO-24 and my USW-Aggregation</p> <ul> <li>FS.com: 66ft OS2<sup>6</sup></li> </ul> <p>I am using two runs of this fiber to link between my server closet, and my office. This is the yellow fiber you see running through the rack.</p> <p>It is single-mode fiber, running at 10G.</p> <ul> <li>FS.com: 5ft OM4<sup>6</sup></li> <li>FS.com: 3ft OM4<sup>6</sup></li> </ul> <p>I am using multi-mode patch cables from fs.com. </p> <p>These are used to connect the 10G switch, to my individual servers. (Note- Failover link only! 100G link is the primary)</p> <p>These are the blue runs of fiber you see running through the rack.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#fiber-modules","title":"Fiber Modules","text":"<p>I use fs.com modules exclusively for my fiber connections.</p> <ul> <li>FS.com: UF-MM-10G (Unifi 10G Multimode)<sup>6</sup></li> <li>FS.com: 10G-SFPP-SR (Brocade 10G Multimode)<sup>6</sup></li> <li>FS.com: MFM1T02A-SR (Mellanox 10G Multimode)<sup>6</sup></li> <li>FS.com: SFP-10G-LR-I (Cisco 10G Singlemode)<sup>6</sup></li> </ul> <p>Honestly, I have a combination of these modules, with Brocade, Cisco, and Unifi compatible.</p> <p>I really have not had any compatability issues between these modules, and any of the switches I have, regardless of if they are mismatched.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#dacs","title":"DACs","text":"<p>For 10G DACs, I honestly usually just buy whatever is the cheapest on eBay.</p> <p>I DO have a handful of legitimate cisco twinax cables, which are fanstatic. But- I have never had any issue with buying cheap DACs from eBay.</p> <p>For the 100G DACs, I am using FS.com: 1.5m 100G Twinax<sup>6</sup>.</p> <p>However, I actually purchased these cables from here: eBay: FS 100G DAC 116122<sup>3</sup>. (13$ less. Came brand-new in original packaging too)</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#sas","title":"SAS","text":"<p>For SAS cables, I am using Amazon: Monoprice 2 Meter SFF-8088<sup>4</sup></p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#misc-organization","title":"Misc Organization","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#velcro-strips","title":"Velcro Strips","text":"<ul> <li>Amazon: 120pcs Velcro<sup>4</sup></li> </ul> <p>I have found these off-brand/no-name velro strips to be extremely handy when doing cable management.</p> <p>If- you use zip-ties, I'd recommend you give these a try. For the 5$ it currently costs, you can't go wrong.</p> <p>There is no a single zip-tie in my rack, that I am currently aware of- I replaced all of them with these velcro strips.</p> <p>I use these same strips all over my house, my office, anywhere I need to organize cables togather.</p> <ul> <li>Amazon: Self-Adhesive Cable Clips<sup>4</sup></li> </ul> <p>While not visible- I use these cable clips inside of the rails of my rack to hold fiber, and ethernet in place.</p> <p>Don't- put these on your wall. They will damage the wall when you try to remove them.</p> <p>But- these are a simple item I have found to be quite effective for doing cable management.</p> <p>Note- Not suitable for power cables- only thinner cables.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#footnotes-disclaimers-etc","title":"Footnotes, Disclaimers, etc...","text":"","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#disclaimers","title":"Disclaimers","text":"<p>This content is not sponsored</p> <p>None of the content, or products used in this post was sponsored.</p> <p>Any products tested, were purchased out of my pocket, and tested without cooperation with the manufacturer.</p> <p>Affiliate Links Used</p> <p>This post DOES include affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>As a disclaimer, I do not display advertisements on this site. I do not accept donations.</p> <p>As such, the only compensation from this service, comes from affiliate links.</p> <p>I am a normal person, who plays with these projects in my spare time. </p> <p>I do not run a company with sponsored youtube channels. </p> <p>If you see a product linked on my blog, It means I paid for it out of my pocket, for my own personal uses, unless otherwise noted.</p> <p>This blog exists for the sole reason, of documenting my various projects and experiences, to share with others.</p> <p>If, you do not wish to use the links, you are under no obligation to click them.</p>","tags":["Homelab"]},{"location":"blog/2024/2024-homelab-status/#footnotes","title":"Footnotes","text":"<ol> <li> <p>Note- I am not hinting at anything here.\u00a0\u21a9</p> </li> <li> <p>This IS hinting at an upcoming project...\u00a0\u21a9</p> </li> <li> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations.</p> <p>\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations.</p> <p>\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> <li> <p>This is a non-affiliated Amazon link.\u00a0\u21a9</p> </li> <li> <p>Non-affiliated\u00a0\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9\u21a9</p> </li> </ol>","tags":["Homelab"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/","title":"Guide: Migrate from Virtualbox to Proxmox","text":"<p>Just a short guide on how to migrate a VirtualBox VM on Windows, to Proxmox.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-1-convert-vdi-to-raw-img","title":"Step 1. Convert .VDI to raw .IMG","text":"<p>To convert the VDI to a raw image, we can use <code>VBoxManage.exe</code></p> <p>This, is located in your Virtualbox install directory. I created a simple powershell script which will perform this task for you.</p> <p>Note</p> <p>Make sure you have enough space- The .IMG file created will be the FULL SIZE of the disk image.</p> <p>If- you notice in my example, I am putting the output IMG on another disk, as my root disk did not have enough free space.</p> <pre><code># This needs to be set to the exact path of VBoxManage.exe\n$VBoxManage = \"C:\\Program Files\\Oracle\\VirtualBox\\VBoxManage.exe\"\n# Set this to the source .vdi file for your VM.\n$InputVDI = \"C:\\Users\\YourUser\\VirtualBox VMs\\YourVM\\YourImage.vdi\"\n# Set this path, to the output file for the raw disk image.\n$OutputPath = \"I:\\Users\\YourUser\\VirtualBox VMs\\YourVM\\YourImage.img\"\n\n# No need to touch this.\n. $VBoxManage clonehd --format RAW $InputVDI $OutputPath\n</code></pre> <p>The following output will be produced.</p> <pre><code>. $VBoxManage clonehd --format RAW $InputVDI $OutputPath\n\nVBoxManage.exe : 0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%\nAt line:5 char:1\n+ . $VBoxManage clonehd --format RAW $InputVDI $OutputPath\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n    + CategoryInfo          : NotSpecified: (0%...10%...20%....0%...90%...100%:String) [], RemoteException\n    + FullyQualifiedErrorId : NativeCommandError\n\nClone medium created in format 'RAW'. UUID: 2915a341-0757-4315-982d-b48bdcd386a2\n</code></pre> <p>Ignore... the exception... Powershell does very odd things with stderr.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-2-create-a-new-proxmox-vm","title":"Step 2. Create a new proxmox VM.","text":"<p>No, special configurations are needed.</p> <p></p> <p>Do not use attach any boot media.</p> <p></p> <p>Nothing special needed here.</p> <p></p> <p>For disks- remove the default disk created. We will manually attach a disk via CLI.</p> <p></p> <p>Nothing special needed on CPU. Allocate cores as needed.</p> <p></p> <p>For memory, I personally always disable ballooning.</p> <p></p> <p>For network, I am not going to specify a NIC at this time. You can specify network as needed for your use-cases.</p> <p></p> <p>On the confirm screen, make sure \"Start after created\" is not checked.</p> <p></p> <p>You now have a new VM, without any storage, in a stopped state.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-3-migrate-the-img-to-proxmox","title":"Step 3. Migrate the .IMG to Proxmox","text":"<p>Ok... make sure you have enough room to copy the disk to proxmox.</p> <p>I ended up needing to take a detour to Delete the data partition from Proxmox</p> <p>But- you will need to copy the .IMG over to one of your servers.</p> <p>I ended up copying it to the ISOs share on my NAS, which is mounted to all of my PVE hosts.</p> <pre><code>root@kube02:~# ls -al /mnt/pve/ISOs/\ntotal 10709368\n-rwxr-xr-x 1 root root 4758700032 Feb  8 15:51  DiskImage.img\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-4-convert-the-raw-image-to-qcow2","title":"Step 4. Convert the raw image to QCow2","text":"<p>Suppose- you could do this before copying to your NAS/Hypervisor... But, now is as good of a time as any.</p> <p>This- will take a while.</p> <pre><code>root@kube02:~# qemu-img convert -f raw -O qcow2 /mnt/pve/ISOs/DiskImage.img NewImage.qcow2\n</code></pre> <p>If... you are using a remote mounted share- it will have to read over the network. According to Unraid, it was reading around 2g/s.</p> <p></p> <p>QCow2 stands for QEMU, Copy on Write... It supports compression, snapshots, thin-provisioning, and a few other nice features.</p> <p>The benefit here, is not having a 100G raw file. </p> <p>Instead, we just have a 20G file, as that is how much data is actually used.</p> <pre><code># Raw .IMG\nroot@kube02:~# du -h /mnt/pve/ISOs/DiskImage.img\n101G    /mnt/pve/ISOs/DiskImage.img\n# Qcow2\nroot@kube02:~# du -h NewImage.qcow2\n20G     NewImage.qcow2\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-4-import-the-raw-image-to-the-new-vm","title":"Step 4. Import the raw image to the new VM","text":"<p>We can use <code>qm importdisk</code> to achieve this. </p> <p>You will need to know...</p> <ol> <li>The VM's number</li> <li>The name of the storage you wish to use.</li> </ol> <p>The syntax is...</p> <p><code>qm importdisk YOUR_VM_ID /path/to/your/raw/image NAME_OF_YOUR_STORAGE</code></p> <pre><code>root@kube02:~# qm importdisk 144 NewImage.qcow2  ceph-block\nUse of uninitialized value $dev in hash element at /usr/share/perl5/PVE/QemuServer/Drive.pm line 555.\nimporting disk 'NewImage.qcow2' to VM 144 ...\ntransferred 0.0 B of 100.0 GiB (0.00%)\ntransferred 1.0 GiB of 100.0 GiB (1.00%)\n... (truncated logs)\ntransferred 100.0 GiB of 100.0 GiB (100.00%)\ntransferred 100.0 GiB of 100.0 GiB (100.00%)\nunused0: successfully imported disk 'ceph-block:vm-144-disk-0'\n</code></pre> <p>For me, this step took... about one minute. Ceph averaged 300-500MB/s</p> <p></p> <p>In proxmox, you will now see the new disk.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-5-configure-vm","title":"Step 5. Configure VM","text":"<p>Attach the disk. Click the unused disk, and click edit.</p> <p>Set your desired bus, and settings, then click add.</p> <p>I always use VirtIO when possible, as this provides the best performance using para-virtualized drivers.</p> <p></p> <p>The disk will now show attached.</p> <p></p> <p>Now, set the boot options. By default, it is set to ide2 (cd-rom drive). You can uncheck this, and select the new disk.</p> <p></p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/migrate-from-virtualbox-to-proxmox/#step-6-start-vm-done","title":"Step 6. Start VM / Done.","text":"<p>At this point, you can start the VM, and everything should work.</p> <p></p> <p>Congratulations, you have successfully migrated your Virtualbox VM to Proxmox.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/","title":"Guide: Proxmox - Delete \"data\" thinpool and extend root partition","text":"<p>Have... a full root partition on proxmox?</p> <pre><code>root@kube02:~# df -h\nFilesystem                            Size  Used Avail Use% Mounted on\nudev                                  126G     0  126G   0% /dev\ntmpfs                                  26G   21M   26G   1% /run\n/dev/mapper/pve-root                   94G   94G     0 100% /\n</code></pre> <p>Confused because your boot disk is much larger in size?</p> <p></p> <p>Well, its because Proxmox by default, partitions the root disk with LVM, Regardless if you are using it to store data.</p> <p></p> <p>This post detail completely removing the data partition and extending the root partition</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#just-tell-me-how-to-fix-the-problem","title":"Just tell me how to fix the problem.","text":"<p>If- you don't want the reading material- here is a script which can be copy and pasted.</p> <p>If- you prefer reading, and details, skip to the next section.</p> <p>Here is a script to perform all of the above steps, which can be copy and pasted to proxmox systems.</p> <p>Danger</p> <p>This ASSUMES you are not using the data pool for VM Storage.</p> <p>If you ARE using the data pool- this will result in data loss.</p> <p>Don't do this if you are using the pool.</p> <pre><code># Umount the data pool\nlvchange -an /dev/pve/data\n# Delete the data pool\nlvremove /dev/pve/data\n# Extend the root pool\nlvextend -r -l +100%FREE /dev/pve/root\n</code></pre> <p>Output:</p> <pre><code>root@kube05:~# df -h\nFilesystem                            Size  Used Avail Use% Mounted on\n/dev/mapper/pve-root                   68G  9.6G   55G  15% /\nroot@kube05:~# # Umount the data pool\nroot@kube05:~# lvchange -an /dev/pve/data\nroot@kube05:~# # Delete the data pool\nroot@kube05:~# lvremove /dev/pve/data\n  Logical volume \"data\" successfully removed.\nroot@kube05:~# # Extend the root pool\nroot@kube05:~# lvextend -r -l +100%FREE /dev/pve/root\n  Size of logical volume pve/root changed from &lt;69.37 GiB (17758 extents) to 229.46 GiB (58743 extents).\n  Logical volume pve/root successfully resized.\nresize2fs 1.47.0 (5-Feb-2023)\nFilesystem at /dev/mapper/pve-root is mounted on /; on-line resizing required\nold_desc_blocks = 9, new_desc_blocks = 29\nThe filesystem on /dev/mapper/pve-root is now 60152832 (4k) blocks long.\n\nroot@kube05:~# df -h\nFilesystem                            Size  Used Avail Use% Mounted on\n/dev/mapper/pve-root                  226G  9.6G  206G   5% /\nroot@kube05:~#\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#steps","title":"Steps","text":"","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#step-1-collect-data","title":"Step 1. Collect Data","text":"<p>First- lets collect some data using the , <code>pgs</code>, <code>vgs</code> and <code>lvs</code> commands.</p> <ol> <li><code>pgs</code> shows physical volumes. (aka, physical disks)</li> <li><code>vgs</code> shows volume groups (This, is a group of disks)</li> <li><code>lvs</code> shows logical volumes (This, is a logical volume, aka, partition.)</li> </ol> <p>To, explain the differences, here is a table.</p> Component Description Analogy PV (Physical Volume) Raw storage device or partition added to LVM Disk or partition VG (Volume Group) A collection of PVs forming a storage pool A warehouse LV (Logical Volume) A virtual partition created from a VG A shelf in the warehouse <pre><code>root@kube02:~# pvs\nPV             VG                                        Fmt  Attr PSize   PFree\n/dev/nvme4n1p3 pve                                       lvm2 a--  893.25g 16.00g\n\nroot@kube02:~# vgs\nVG                                        #PV #LV #SN Attr   VSize   VFree\npve                                         1   2   0 wz--n- 893.25g 16.00g\n\nroot@kube02:~# lvs\nLV                                             VG                                        Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\ndata                                           pve                                       twi-a-tz-- 765.62g             0.00   0.24\nroot                                           pve                                       -wi-ao----  96.00g\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#collecting-even-more-data","title":"Collecting even more data","text":"<p>If- you want more detail, you can use the commands....</p> <ol> <li><code>pvdisplay</code> - Show more information about physical volumes</li> <li><code>pvdisplay -m</code> - Show more information about physical volumes AND break down extends</li> <li><code>vgdisplay</code> - Show more information about volume groups</li> <li><code>lvdisplay</code> - Show more information about logical volumes</li> </ol> <p>Example:</p> <pre><code>root@kube02:~# pvdisplay /dev/nvme4n1p3\n  --- Physical volume ---\n  PV Name               /dev/nvme4n1p3\n  VG Name               pve\n  PV Size               893.25 GiB / not usable &lt;2.32 MiB\n  Allocatable           yes\n  PE Size               4.00 MiB\n  Total PE              228672\n  Free PE               4097\n  Allocated PE          224575\n  PV UUID               SHXo9z-M3jq-1VTk-gO5O-0YS3-EtX8-yFRypB\n\nroot@kube02:~# pvdisplay -m /dev/nvme4n1p3\n  --- Physical volume ---\n  PV Name               /dev/nvme4n1p3\n  VG Name               pve\n  PV Size               893.25 GiB / not usable &lt;2.32 MiB\n  Allocatable           yes\n  PE Size               4.00 MiB\n  Total PE              228672\n  Free PE               4097\n  Allocated PE          224575\n  PV UUID               SHXo9z-M3jq-1VTk-gO5O-0YS3-EtX8-yFRypB\n\n  --- Physical Segments ---\n  Physical extent 0 to 24575:\n    Logical volume      /dev/pve/root\n    Logical extents     0 to 24575\n  Physical extent 24576 to 220574:\n    Logical volume      /dev/pve/data_tdata\n    Logical extents     0 to 195998\n  Physical extent 220575 to 222574:\n    Logical volume      /dev/pve/data_tmeta\n    Logical extents     0 to 1999\n  Physical extent 222575 to 224574:\n    Logical volume      /dev/pve/lvol0_pmspare\n    Logical extents     0 to 1999\n  Physical extent 224575 to 228671:\n    FREE\n\nroot@kube02:~# vgdisplay pve\n  --- Volume group ---\n  VG Name               pve\n  System ID\n  Format                lvm2\n  Metadata Areas        1\n  Metadata Sequence No  6\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                2\n  Open LV               1\n  Max PV                0\n  Cur PV                1\n  Act PV                1\n  VG Size               893.25 GiB\n  PE Size               4.00 MiB\n  Total PE              228672\n  Alloc PE / Size       224575 / &lt;877.25 GiB\n  Free  PE / Size       4097 / 16.00 GiB\n  VG UUID               TWcjCJ-TYB8-uCy3-TVzP-0KvZ-cDCy-kbx0rM\n\nroot@kube02:~# lvdisplay pve/root\n  --- Logical volume ---\n  LV Path                /dev/pve/root\n  LV Name                root\n  VG Name                pve\n  LV UUID                FHgUow-erI5-FmgY-CkLh-sQH7-Z94p-P5WYx1\n  LV Write Access        read/write\n  LV Creation host, time proxmox, 2024-07-04 11:55:18 -0500\n  LV Status              available\n  # open                 1\n  LV Size                96.00 GiB\n  Current LE             24576\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     256\n  Block device           252:8\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#identify-the-issue","title":"Identify the issue","text":"<p>From the intro, we know the issue is the root partition being full.</p> <p>We can see this, by running <code>df -h</code></p> <pre><code>root@kube02:~# df -h\nFilesystem                            Size  Used Avail Use% Mounted on\nudev                                  126G     0  126G   0% /dev\ntmpfs                                  26G   21M   26G   1% /run\n/dev/mapper/pve-root                   94G   94G     0 100% /\n</code></pre> <p>From the path- we can see pve-root is the partition.</p> <p>From the above data we collected, we know...</p> <ol> <li>The logical volume name is \"root\"</li> <li>The volume group name is \"pve\"</li> <li>The physical volume/disk is \"/dev/nvme4n1p3\"</li> </ol>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#remove-data-thinpool","title":"Remove Data Thinpool","text":"<p>Steps:</p> <ol> <li>Unmount partition.</li> <li>Delete thinpool</li> </ol> <p>To umount, we can use <code>lvchange</code></p> <pre><code>root@kube02:~# lvchange -an /dev/pve/data\n</code></pre> <p>Then, delete the thin pool</p> <pre><code>root@kube02:~# lvremove /dev/pve/data\n  Logical volume \"data\" successfully removed.\n</code></pre> <p>Note</p> <p>You will need to reduce the disk usage under 100% in order to remove the thinpool.</p> <p>I found 3G worth of journal logs to clean up</p> <pre><code>root@kube02:~# rm -rf /var/log/journal/df694b9549624c8bb72acadbdd282b8d\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#extend-root-lvs","title":"Extend root LVS","text":"<p>Extending the root LVS is pretty easy using <code>lvextend</code></p> <pre><code>root@kube02:~# lvextend -r -l +100%FREE /dev/pve/root\n  Size of logical volume pve/root changed from 96.00 GiB (24576 extents) to 893.25 GiB (228672 extents).\n  Logical volume pve/root successfully resized.\nresize2fs 1.47.0 (5-Feb-2023)\nFilesystem at /dev/mapper/pve-root is mounted on /; on-line resizing required\nold_desc_blocks = 12, new_desc_blocks = 112\nThe filesystem on /dev/mapper/pve-root is now 234160128 (4k) blocks long.\n</code></pre>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/proxmox---delete-pvedata-pool/#done","title":"Done","text":"<pre><code>root@kube02:~# df -h\nFilesystem                            Size  Used Avail Use% Mounted on\nudev                                  126G     0  126G   0% /dev\ntmpfs                                  26G  4.9M   26G   1% /run\n/dev/mapper/pve-root                  879G   92G  751G  11% /\n</code></pre> <p>Your root partition has now been resized to match your disk.</p>","tags":["Homelab","Proxmox"]},{"location":"blog/2025/link-speed-versus-power-consumption/","title":"Does Link Speed Affect Power Consumption?","text":"<p>Will changing the link speed of your current NIC, affect Power Consumption?</p> <p>For me- I have 100G NICs in my SFFs. I don't need the full throughput. </p> <p>So- will reducing the link speed, impact power consumption?</p> <p>For this post- I will benchmark and determine the impact.</p> TLDR/Spoiler (Click to Expand)","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#tldr","title":"TLDR;","text":"<p>There is a 6% difference in idle consumption between 100G, and 1G link speed.</p> <p>A total of 3 watts difference.</p> <p>Under full network utilization, there was a 14.2% difference between 100G, and 1G link speed.</p> <p>A total of 7.8 watts difference.</p> <p>If- you want more detailed results, Skip straight to The Results</p> <p>Otherwise- stay tuned..</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#test-fixture","title":"Test Fixture","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#hardware","title":"Hardware","text":"<p>The hardware being tested, is a Dell Optiplex 5060SFF, with a 100G Mellanox ConnectX-4 NIC. More Details</p> <p>The NIC being tested is a Mellanox ConnectX-4 CX-416A 100GBe Dual Port NIC eBay: ConnectX-4 CX-416A<sup>1</sup></p> <p>Info</p> <p>Do note, the base consumption on my test machine is pretty high.</p> <p>As... it is maxed on RAM, SSDs, and includes a 100G NIC and an external SAS card- these add up.</p> <p>There is 20-30 watts worth of PCIe cards here.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#power-consumption-data","title":"Power Consumption Data","text":"<p>For measuring power consumption, I will be using my Vertiv rPDU</p> <p>I will be collecting data using rPDU2MQTT, which will insert into emoncms at a 10 second interval.</p> <p>Info</p> <p>rPDU2MQTT is a project I have been SLOWLY working on for a while.</p> <p>Its... not finished. I really need to get the v1.0 release out....</p> <p>*cough contributors are always welcome!</p> <p>The data is collected at a 10 second interval.</p> <p>I am aiming for around 25 to 30 datapoints for each test, which is around 4-5 minutes.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#testing-conditions","title":"Testing Conditions:","text":"<ol> <li> <p>Different Link Speeds</p> <ul> <li>100G</li> <li>50G</li> <li>40G</li> <li>25G</li> <li>10G</li> <li>1G</li> </ul> </li> <li> <p>Load</p> <ul> <li>Idle Load, with no workflows active, no VMs running.</li> <li>Full Tilt, saturated network bandwidth (at the current link speed)</li> </ul> </li> </ol> <p>Info</p> <p>Originally, I planned on including 2.5g, and 5g, however- my CX-4 nics do not support this.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#setting-link-speed","title":"Setting Link Speed","text":"<p>I am setting link speed on my switch- by changing the advertised speeds. Quick and easy.</p> <p></p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#generating-network-load-using-rdma","title":"Generating Network Load - Using RDMA","text":"<p>Generating network traffic is not as easy as just running iperf. </p> <p>Given that is easier to show, then explain.... Here is an example of why:</p> <pre><code>## Server\nroot@kube01:~# iperf -s\n\n## Client generating traffic\nroot@kube05:~# iperf -c 10.100.4.100 -t 5000 -i 5 -P 4\n</code></pre> <p>NIC is consistently saturated at 90Gbits, reported by the switch.</p> <p></p> <p>Results? 129 watts.</p> <p></p> <p>The huge issue- we aren't just measuring the NIC's consumption- we are measuring the entire system's consumption.</p> <p></p> <p>So... how can we measure the NIC alone?</p> <p>Well, RDMA speed tests have always been handy at isolating the CPU. Lets try that.</p> <p></p> <p>Much better. CPU is nearly idle, And we are passing a FULL 100G of bandwidth.</p> <p>Results using RMDA? 63 watts.</p> <p>This is a massive difference. Since- this allows us to isolate CPU, this will be the preferred method.</p> <pre><code>## Server (being tested)\nroot@kube01# ib_write_bw\n\n## Client (Sending bandwidth)\nroot@kube05:~# ib_write_bw 10.100.4.100 -D 600\n</code></pre> <p>Note</p> <p>For RDMA speed tests, both client and server need to be running at the same link speed.</p> <p>Aka- You can't test a 50G client, with a 100G client.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#preparation","title":"Preparation","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#step-1-remote-access","title":"Step 1. Remote Access","text":"<p>Since- we will be messing with network access, Make sure to have... means of accessing the server for when you find an unsupported link speed, etc.</p> <p>For this- I will be using my JetKVM.</p> <p></p> <p>Info</p> <p>This is honestly the first time I have plugged in the JetKVM.</p> <p>It pulled an IP address, went through a simple setup, and boom. It worked.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#step-2-proxmox-maintenance","title":"Step 2. Proxmox Maintenance","text":"<p>Since... I will be impacting network connectivity, I wanted to ensure I don't impact any of my current VMs.</p> <p>I have a nice bash alias to easily put the host into maintenance.</p> <pre><code>root@kube01:~# enable-maintenance\nroot@kube01:~#\n</code></pre> <p>For- those who don't have such a script, or alias... here is the source for mine.</p> <pre><code>#!/bin/bash\n\nha-manager crm-command node-maintenance enable $(hostname)\n</code></pre> <p>This, will cause Proxmox to automatically drain, and migrate VMs/LXCs to other hosts in my cluster.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#step-3-update-reboot","title":"Step 3. Update &amp; Reboot","text":"<p>Finally- before benchmarking, I am going to fully update the system, and reboot it for a fresh slate.</p> <pre><code>apt-get update\napt-get dist-upgrade\nreboot\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#step-4-stop-proxmox-ceph-snmp-etc","title":"Step 4. Stop Proxmox, Ceph, SNMP, etc...","text":"<p>We want to minimize interference as much as possible.</p> <p>So- I will be stopping Proxmox, Ceph, and SNMP.</p> <pre><code>#!/bin/bash\n\n# Stop Proxmox services and Corosync\nservices=(\n  \"ceph.target\"\n  \"snmpd.service\"\n  \"corosync\"\n  \"pve-cluster\"\n  \"pvedaemon\"\n  \"pvestatd\"\n  \"pveproxy\"\n)\n\nfor service in \"${services[@]}\"; do\n  echo \"Stopping $service...\"\n  systemctl stop \"$service\"\ndone\n\necho \"All services stopped successfully.\"\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#step-5-verify","title":"Step 5. Verify","text":"<p>After stopping all services, just needed to verify everything was indeed stopped.</p> <p>For ceph-</p> <p></p> <p></p> <p>And- watching HTOP for anything unexpected.</p> <p></p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#running-tests","title":"Running Tests","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#100g","title":"100G","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-50w","title":"Idle - 50w","text":"<p>For the baseline test- we have an idle system, with the NIC running at 100G.</p> <pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed &amp;&amp; uptime\n        Speed: 100000Mb/s\n 12:20:26 up  1:38,  2 users,  load average: 0.10, 0.07, 0.14\n</code></pre> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 27/31 49.0 50.0 1.0 50.0 17.9","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-548w","title":"Load - 54.8w","text":"<p>With, 100G of network traffic being reported by the switch, I took measurements</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 31/31 54.0 55.0 1.0 54.8 0.4","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#50g","title":"50G","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-50w_1","title":"Idle - 50w","text":"<p>Next- we are going to run these tests at 50G.</p> <pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed\n        Speed: 50000Mb/s\nroot@kube01:~# uptime\n 11:35:53 up 53 min,  3 users,  load average: 0.22, 0.29, 0.66\n</code></pre> <p>After changing the link speed to 50G, ensuring we were at a near-idle state, I waited a while to capture data.</p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 29/31 50.0 50.0 0.0 50.0 12.7 <p>EXTREMELY consistent data. </p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-51w","title":"Load - 51w","text":"<p>After, configuring the servers, I verified at the switch we had the expected bandwidth being sent.</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 26/31 51.0 51.0 0.0 51.0 20.5","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#40g","title":"40G","text":"<pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed &amp;&amp; uptime\n        Speed: 40000Mb/s\n 12:30:07 up  1:48,  2 users,  load average: 0.11, 0.05, 0.08\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-48w","title":"Idle - 48w","text":"Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 28/31 47.0 49.0 2.0 48.0 14.9","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-53w","title":"Load - 53w","text":"<p>Verifying expected bandwidth via switch.</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 26/31 53.0 53.0 0.0 53.0 21.3","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#25g","title":"25G","text":"<pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed &amp;&amp; uptime\n        Speed: 25000Mb/s\n 12:42:01 up  2:00,  2 users,  load average: 0.05, 0.05, 0.07\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-48w_1","title":"Idle - 48w","text":"Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 29/31 47.0 48.0 1.0 48.0 12.2","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-521w","title":"Load - 52.1w","text":"<p>Verifying bandwidth...</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 31/31 52.0 53.0 1.0 52.1 0.3","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#10g","title":"10G","text":"<pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed &amp;&amp; uptime\n        Speed: 10000Mb/s\n 12:55:52 up  2:13,  2 users,  load average: 0.01, 0.03, 0.05\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-463w","title":"Idle - 46.3w","text":"Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 28/31 46.0 47.0 1.0 46.3 14.4","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-491w","title":"Load - 49.1w","text":"<p>Verify bandwidth...</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 28/31 49.0 50.0 1.0 49.1 15.3","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#1g","title":"1G","text":"<pre><code>root@kube01:~#  ethtool enp1s0f0np0  | grep -i speed &amp;&amp; uptime\n        Speed: 1000Mb/s\n 13:13:00 up  2:31,  2 users,  load average: 0.04, 0.05, 0.04\n</code></pre>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#idle-47w","title":"Idle - 47w","text":"Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 31/31 46.0 47.0 1.0 47.0 0.2","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#load-47w","title":"Load - 47w","text":"<p>Verify bandwidth...</p> <p></p> Feed Data Points Min Max Diff Mean Stdev 614:Temp:Temp_Benchmark () 28/31 47.0 47.0 0.0 47.0 14.6","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#testing-results","title":"Testing Results","text":"","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#raw-data","title":"Raw Data","text":"<p>Here is the results for each test, aggregated into a table.</p> Link Speed Idle/Load Power (W) Data Points Min Max Diff Mean Stdev Power Diff (W) 100G Idle 50 27/31 49.0 50.0 1.0 50.0 17.9 100G Load 54.8 31/31 54.0 55.0 1.0 54.8 0.4 4.8 50G Idle 50 29/31 50.0 50.0 0.0 50.0 12.7 50G Load 51 26/31 51.0 51.0 0.0 51.0 20.5 1.0 40G Idle 48 28/31 47.0 49.0 2.0 48.0 14.9 40G Load 53 26/31 53.0 53.0 0.0 53.0 21.3 5.0 25G Idle 48 29/31 47.0 48.0 1.0 48.0 12.2 25G Load 52.1 31/31 52.0 53.0 1.0 52.1 0.3 4.1 10G Idle 46.3 28/31 46.0 47.0 1.0 46.3 14.4 10G Load 49.1 28/31 49.0 50.0 1.0 49.1 15.3 2.8 1G Idle 47 31/31 46.0 47.0 1.0 47.0 0.2 1G Load 47 28/31 47.0 47.0 0.0 47.0 14.6 0.0 <p>Here is a screenshot of the entire collected dataset in emonCMS.</p> <p></p> <p>After- disabling all non-essential services to ensure a consistent idle load- you can see the power usage slowly stepping down little by little for each test.</p> <p>Load tests followed after idle tests. At the end, the NIC was restored to 100G link speed.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#formatted-data","title":"Formatted Data","text":"Link Speed Idle Power (W) Load Power (W) Idle-Load Diff (W) Idle % Chg Load % Chg 100G 50 54.8 4.8 0.0% 0.0% 50G 50 51 1.0 0.0% -6.9% 40G 48 53 5.0 -4.0% -3.3% 25G 48 52.1 4.1 -4.0% -4.9% 10G 46.3 49.1 2.8 -7.4% -10.4% 1G 47 47 0.0 -6.0% -14.2%","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#summary","title":"Summary","text":"<p>Based on the data collected, YES, there is a difference in power consumption based on your link speed.</p> <p>However, the difference is not as huge as I expected to see.</p> <p>I did, however, find it interesting 50G used less energy under load, as compared to 40G/25G, with identical hardware and setup.</p> <p>In the future, I will likely swap the 100G NIC out with a 25G NIC to determine any potential savings.</p> <p>I have the NIC, just need a few breakout cables.</p>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/link-speed-versus-power-consumption/#footnotes","title":"Footnotes","text":"<ol> <li> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations.</p> <p>\u21a9</p> </li> </ol>","tags":["Homelab","Homelab/Efficiency","Networking"]},{"location":"blog/2025/mellanox-configuration-guide/","title":"Mellanox ConnectX-NIC Configuration Helper","text":"<p>This post centralizes data for configuration of Mellanox ConnectX Series NIC (Tested with CX3, and CX4)</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#tasks","title":"Tasks","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#packages-used","title":"Packages Used","text":"<p>Packages Used:</p> <ul> <li>pciutils         - contains <code>lspci</code> used in this post.</li> <li>ethtool</li> <li>wget</li> <li>unzip         - Used for extracting .zip files. Suppose you could use a tar command too...</li> </ul> <p>Command:</p> <pre><code>apt-get update &amp;&amp; apt-get install -y pciutils ethtool wget\n</code></pre> <p>Output:</p> Install package output <pre><code>root@kube05:~# apt-get update &amp;&amp; apt-get install -y pciutils ethtool wget\nHit:1 http://security.debian.org/debian-security bookworm-security InRelease\nHit:2 http://deb.debian.org/debian bookworm InRelease\nHit:3 http://deb.debian.org/debian bookworm-updates InRelease\nHit:4 http://download.proxmox.com/debian/pve bookworm InRelease\nHit:5 http://download.proxmox.com/debian/ceph-reef bookworm InRelease\nReading package lists... Done\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\npciutils is already the newest version (1:3.9.0-4).\nethtool is already the newest version (1:6.1-1).\nThe following packages were automatically installed and are no longer required:\nlibc-ares2 libyang2\nUse 'apt autoremove' to remove them.\nThe following packages will be upgraded:\nwget\n1 upgraded, 0 newly installed, 0 to remove and 30 not upgraded.\nNeed to get 937 kB of archives.\nAfter this operation, 86.0 kB disk space will be freed.\nGet:1 http://deb.debian.org/debian bookworm/main amd64 wget amd64 1.21.3-1+deb12u1 [937 kB]\nFetched 937 kB in 0s (11.1 MB/s)\napt-listchanges: Reading changelogs...\n(Reading database ... 63296 files and directories currently installed.)\nPreparing to unpack .../wget_1.21.3-1+deb12u1_amd64.deb ...\nUnpacking wget (1.21.3-1+deb12u1) over (1.21.3-1+b2) ...\nSetting up wget (1.21.3-1+deb12u1) ...\nProcessing triggers for man-db (2.11.2-2) ...\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#install-mlnx-ofed-mstflint","title":"Install MLNX-OFED &amp; MSTFlint","text":"<p><code>mlnx-ofed</code> is the drivers and software for ConnectX IB/Ethernet NICs.</p> <p><code>mstflint</code> is software provided by Nvidia for the purpose of configuring ConnectX series network adapters. </p> <p>It is also used to update firmware.</p> <p>It is not required for all of the below tasks in this guide, however, does come in handy.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-apt-get-for-proxmox","title":"Via apt-get (For Proxmox)","text":"<p>Here you go, straight to the point. This was the script I used this week for installing on proxmox.</p> <p>Script:</p> <pre><code>## See available versions here: https://linux.mellanox.com/public/repo/mlnx_ofed/\nVERSION=\"latest\"\n## See available distributions here: https://linux.mellanox.com/public/repo/mlnx_ofed/latest/\nDISTRO=\"debian12.1\"\nwget -qO - https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox | sudo apt-key add -\ncd /etc/apt/sources.list.d/\nwget https://linux.mellanox.com/public/repo/mlnx_ofed/$VERSION/$DISTRO/mellanox_mlnx_ofed.list\napt-get update\napt-get install mlnx-ofed-basic mstflint\n</code></pre> <p>See the listing HERE for available versions.</p> <p>For other distributions, look at the repository listing HERE</p> <p>Output:</p> <p>As the output was quite long and verbose, I did not embed it on this page.</p> <p>View the raw output here.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#rpm-tarball-etc","title":"RPM / Tarball / etc","text":"<p>If, you are using RPM, the directions will be slightly different for you.</p> <p>(Official) Nvidia Networking Repository Documentation</p> <p>Note</p> <p>You can download tarballs for the MLNX_OFED drivers from Nvidia. However, in my case it yielded \"Unsupported distribution\" using the debian 12 version, on my debian 12.1 proxmox hosts.</p> <p>The apt-get method, worked as expected.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#gathering-information","title":"Gathering Information","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#get-pci-address-required","title":"Get PCI Address (Required)","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-lspci","title":"via <code>lspci</code>","text":"<p>This step is required for basically everything else in this guide. You will need the PCIe address of your card. This is easily obtained using <code>lspci</code></p> <p>Command: </p> <pre><code>lspci | grep Mellanox\n</code></pre> <p>Output: </p> <pre><code># One host with a 25G CX4\nroot@kube01:/etc/apt/sources.list.d# lspci | grep Mellanox\n01:00.0 Ethernet controller: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]\n01:00.1 Ethernet controller: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]\n\n# On another host with a 100G CX4\nroot@kube02:~# lspci | grep Mellanox\n81:00.0 Ethernet controller: Mellanox Technologies MT27700 Family [ConnectX-4]\n81:00.1 Ethernet controller: Mellanox Technologies MT27700 Family [ConnectX-4]\n\n# Another host, also, 100G CX4\nroot@kube05:~# lspci | grep Mellanox\n01:00.0 Ethernet controller: Mellanox Technologies MT27700 Family [ConnectX-4]\n01:00.1 Ethernet controller: Mellanox Technologies MT27700 Family [ConnectX-4]\n</code></pre> <p>As all of my NICs are dual-port- there are two entries for each NIC.</p> <p>In the first example, you would want to take note of <code>01:00.0</code>, and <code>01:00.1</code>. This is the NIC's address.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#get-pci-address-from-interface-name-via-ethtool","title":"Get PCI Address - From Interface Name - Via ethtool","text":"<p>If- you have the adapter/interface name, you can use this to acquire the PCI address</p> <pre><code>ethtool -i enp1s0f0np0 | grep \"bus-info\"\n</code></pre> <p>Output:</p> <pre><code>root@kube01:~#  ethtool -i enp1s0f0np0 | grep \"bus-info\"\nbus-info: 0000:01:00.0\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#set-variable","title":"Set Variable","text":"<p>Warning<p>To make it easier to run commands in this article, I will be using a variable to avoid needing to remember/retype the address name.</p> <p>If- you choose not to do this, you can instead replace <code>$CX_ADDRESS</code> in the provided scripts, with the address of your network adapter.</p> </p> <p>To make it easier to run scripts or commands in this post, I am going to set a local variable containing the card's address. </p> <p>This will negate the need to remember, or type this in for every command.</p> <p>Command:</p> <pre><code># Replace the address, with the address of YOUR card.\n# If- like me, your cards have multiple ports, choose the .0 port.\nCX_ADDRESS=\"81:00.0\"\n</code></pre> <p>You can paste that directly into a bash prompt to set the variable.</p> <p>Output:</p> <pre><code>root@kube02:~# CX_ADDRESS=\"81:00.0\"\nroot@kube02:~# echo $CX_ADDRESS\n81:00.0\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#get-interface-name-required","title":"Get Interface Name (Required)","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#get-logic-adapter-name-from-pci-address-via-sys","title":"Get Logic Adapter Name - From PCI Address- via <code>/sys</code>","text":"<p>To get the network interface name, we can simply <code>ls</code> <code>/sys</code></p> <p>Command: </p> <pre><code>ls /sys/bus/pci/devices/0000:$CX_ADDRESS/net\n</code></pre> <p>Output:</p> <pre><code>root@kube02:~# ls /sys/bus/pci/devices/0000:$CX_ADDRESS/net\nenp129s0f0np0\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#set-variable-required","title":"Set Variable (Required)","text":"<p>Warning<p>To make it easier to run commands in this article, I will be using a variable to avoid needing to remember/retype the logical interface name.</p> <p>If- you choose not to do this, you can instead replace <code>$CX_INTERFACE</code> in the provided scripts, with the name of your network interface.</p> </p> <p>Like before, to simplify this article, I will be using a variable containing the interface name.</p> <p>Command:</p> <pre><code># Replace the interface name here, with the interface name of YOUR card.\nCX_INTERFACE=\"enp129s0f0np0\"\n\n# Alternatively, here is a command which will pick the FIRST interface listed.\nCX_INTERFACE=$(ls /sys/bus/pci/devices/0000\\:$CX_ADDRESS/net/ | head -n 1)\n\n# Echo out, ensure the variables are correctly set.\necho \"$CX_ADDRESS &gt; $CX_INTERFACE\"\n</code></pre> <p>Output:</p> <pre><code>## From Kube02\nroot@kube02:~# CX_INTERFACE=$(ls /sys/bus/pci/devices/0000\\:$CX_ADDRESS/net/ | head -n 1)\nroot@kube02:~# echo \"$CX_ADDRESS &gt; $CX_INTERFACE\"\n81:00.0 &gt; enp129s0f0np0\n\n## From Kube01\nroot@kube01:~# echo \"$CX_ADDRESS &gt; $CX_INTERFACE\"\n01:00.0 &gt; enp1s0f0np0\n\n## From Kube05\nroot@kube05:/etc/apt/sources.list.d# echo \"$CX_ADDRESS &gt; $CX_INTERFACE\"\n01:00.0 &gt; enp1s0f0np0\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#lspci-verbose-information","title":"Lspci - Verbose Information","text":"<p><code>lspci</code> can be used to list many details regarding the card, such as allocated PCIe lanes, potential issues, ASPM status, speed, etc.</p> <p>This information is crucial for troubleshooting.</p> <p>Using the device ID, you can query the information as so:</p> <p>Command: </p> <pre><code>lspci -s $CX_ADDRESS -vvvvv\n</code></pre> <p>Output: </p> Output from Kube01 (CX4121A) <pre><code>root@kube01: CX_ADDRESS=\"01:00.0\"\nroot@kube01:/etc/apt/sources.list.d# lspci -s $CX_ADDRESS -vvvvv\n01:00.0 Ethernet controller: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]\n        Subsystem: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]\n        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx+\n        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-\n        Latency: 0, Cache Line Size: 64 bytes\n        Interrupt: pin A routed to IRQ 16\n        IOMMU group: 2\n        Region 0: Memory at 92000000 (64-bit, prefetchable) [size=32M]\n        Expansion ROM at 95400000 [disabled] [size=1M]\n        Capabilities: [60] Express (v2) Endpoint, MSI 00\n                DevCap: MaxPayload 512 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited\n                        ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 75W\n                DevCtl: CorrErr+ NonFatalErr+ FatalErr+ UnsupReq+\n                        RlxdOrd+ ExtTag+ PhantFunc- AuxPwr- NoSnoop+ FLReset-\n                        MaxPayload 256 bytes, MaxReadReq 512 bytes\n                DevSta: CorrErr+ NonFatalErr- FatalErr- UnsupReq+ AuxPwr- TransPend-\n                LnkCap: Port #0, Speed 8GT/s, Width x8, ASPM not supported\n                        ClockPM- Surprise- LLActRep- BwNot- ASPMOptComp+\n                LnkCtl: ASPM Disabled; RCB 64 bytes, Disabled- CommClk+\n                        ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-\n                LnkSta: Speed 8GT/s, Width x8\n                        TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-\n                DevCap2: Completion Timeout: Range ABCD, TimeoutDis+ NROPrPrP- LTR-\n                        10BitTagComp- 10BitTagReq- OBFF Not Supported, ExtFmt- EETLPPrefix-\n                        EmergencyPowerReduction Not Supported, EmergencyPowerReductionInit-\n                        FRS- TPHComp- ExtTPHComp-\n                        AtomicOpsCap: 32bit- 64bit- 128bitCAS-\n                DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis- LTR- 10BitTagReq- OBFF Disabled,\n                        AtomicOpsCtl: ReqEn-\n                LnkCap2: Supported Link Speeds: 2.5-8GT/s, Crosslink- Retimer- 2Retimers- DRS-\n                LnkCtl2: Target Link Speed: 2.5GT/s, EnterCompliance- SpeedDis-\n                        Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-\n                        Compliance Preset/De-emphasis: -6dB de-emphasis, 0dB preshoot\n                LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete+ EqualizationPhase1+\n                        EqualizationPhase2+ EqualizationPhase3+ LinkEqualizationRequest-\n                        Retimer- 2Retimers- CrosslinkRes: unsupported\n        Capabilities: [48] Vital Product Data\n                Product Name: Mellanox ConnectX-4 LX Dual Port 25 GbE SFP Network Adapter\n                Read-only fields:\n                        [PN] Part number: 020NJD\n                        [EC] Engineering changes: A02\n                        [MN] Manufacture ID: 1028\n                        [SN] Serial number: IL020NJD740316C40056\n                        [VA] Vendor specific: DSV1028VPDR.VER1.0\n                        [VB] Vendor specific: FFV14.14.23.20\n                        [VC] Vendor specific: NPY2\n                        [VD] Vendor specific: PMT78\n                        [VE] Vendor specific: NMVMellanox Technologies, Inc.\n                        [VF] Vendor specific: DTINIC\n                        [VG] Vendor specific: DCM10010010C512020010C514030010C516040010C521010010C523020010C525030010C527040010C5\n                        [VH] Vendor specific: L1D0\n                        [RV] Reserved: checksum good, 3 byte(s) reserved\n                End\n        Capabilities: [9c] MSI-X: Enable+ Count=64 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00003000\n        Capabilities: [c0] Vendor Specific Information: Len=18 &lt;?&gt;\n        Capabilities: [40] Power Management version 3\n                Flags: PMEClk- DSI- D1- D2- AuxCurrent=375mA PME(D0-,D1-,D2-,D3hot-,D3cold+)\n                Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-\n        Capabilities: [100 v1] Alternative Routing-ID Interpretation (ARI)\n                ARICap: MFVC- ACS-, Next Function: 1\n                ARICtl: MFVC- ACS-, Function Group: 0\n        Capabilities: [110 v1] Advanced Error Reporting\n                UESta:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UEMsk:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UESvrt: DLP+ SDES- TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-\n                CESta:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- AdvNonFatalErr+\n                CEMsk:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- AdvNonFatalErr+\n                AERCap: First Error Pointer: 04, ECRCGenCap+ ECRCGenEn- ECRCChkCap+ ECRCChkEn-\n                        MultHdrRecCap- MultHdrRecEn- TLPPfxPres- HdrLogCap-\n                HeaderLog: 00000000 00000000 00000000 00000000\n        Capabilities: [1c0 v1] Secondary PCI Express\n                LnkCtl3: LnkEquIntrruptEn- PerformEqu-\n                LaneErrStat: 0\n        Kernel driver in use: mlx5_core\n        Kernel modules: mlx5_core\n</code></pre> Output from Kube02 (CX416) <p>Here is the output from another server of mine with the 100G CX4</p> <pre><code>root@kube02: CX_ADDRESS=\"81:00.0\"\nroot@kube02:~# lspci -vvvvv -s $CX_ADDRESS\n81:00.0 Ethernet controller: Mellanox Technologies MT27700 Family [ConnectX-4]\n        Subsystem: Mellanox Technologies ConnectX-4 Stand-up dual-port 100GbE MCX416A-CCAT\n        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+\n        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-\n        Latency: 0\n        Interrupt: pin A routed to IRQ 407\n        NUMA node: 1\n        IOMMU group: 19\n        Region 0: Memory at ca000000 (64-bit, prefetchable) [size=32M]\n        Expansion ROM at cd900000 [disabled] [size=1M]\n        Capabilities: [60] Express (v2) Endpoint, MSI 00\n                DevCap: MaxPayload 512 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited\n                        ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 25W\n                DevCtl: CorrErr+ NonFatalErr+ FatalErr+ UnsupReq+\n                        RlxdOrd+ ExtTag+ PhantFunc- AuxPwr- NoSnoop+ FLReset-\n                        MaxPayload 256 bytes, MaxReadReq 4096 bytes\n                DevSta: CorrErr+ NonFatalErr- FatalErr- UnsupReq+ AuxPwr- TransPend-\n                LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM not supported\n                        ClockPM- Surprise- LLActRep- BwNot- ASPMOptComp+\n                LnkCtl: ASPM Disabled; RCB 64 bytes, Disabled- CommClk+\n                        ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-\n                LnkSta: Speed 8GT/s, Width x8 (downgraded)\n                        TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-\n                DevCap2: Completion Timeout: Range ABC, TimeoutDis+ NROPrPrP- LTR-\n                        10BitTagComp- 10BitTagReq- OBFF Not Supported, ExtFmt- EETLPPrefix-\n                        EmergencyPowerReduction Not Supported, EmergencyPowerReductionInit-\n                        FRS- TPHComp- ExtTPHComp-\n                        AtomicOpsCap: 32bit- 64bit- 128bitCAS-\n                DevCtl2: Completion Timeout: 65ms to 210ms, TimeoutDis- LTR- 10BitTagReq- OBFF Disabled,\n                        AtomicOpsCtl: ReqEn-\n                LnkCap2: Supported Link Speeds: 2.5-8GT/s, Crosslink- Retimer- 2Retimers- DRS-\n                LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-\n                        Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-\n                        Compliance Preset/De-emphasis: -6dB de-emphasis, 0dB preshoot\n                LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete+ EqualizationPhase1+\n                        EqualizationPhase2+ EqualizationPhase3+ LinkEqualizationRequest-\n                        Retimer- 2Retimers- CrosslinkRes: unsupported\n        Capabilities: [48] Vital Product Data\n                Product Name: CX416A - ConnectX-4 QSFP28\n                Read-only fields:\n                        [PN] Part number: MCX416A-CCAT\n                        [EC] Engineering changes: AG\n                        [SN] Serial number: MT1838X04950\n                        [V0] Vendor specific: PCIeGen3 x16\n                        [RV] Reserved: checksum good, 2 byte(s) reserved\n                End\n        Capabilities: [9c] MSI-X: Enable+ Count=64 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00003000\n        Capabilities: [c0] Vendor Specific Information: Len=18 &lt;?&gt;\n        Capabilities: [40] Power Management version 3\n                Flags: PMEClk- DSI- D1- D2- AuxCurrent=375mA PME(D0-,D1-,D2-,D3hot-,D3cold+)\n                Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-\n        Capabilities: [100 v1] Advanced Error Reporting\n                UESta:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UEMsk:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt+ UnxCmplt+ RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UESvrt: DLP+ SDES- TLP+ FCP+ CmpltTO+ CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC+ UnsupReq- ACSViol-\n                CESta:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- AdvNonFatalErr+\n                CEMsk:  RxErr+ BadTLP+ BadDLLP+ Rollover+ Timeout+ AdvNonFatalErr+\n                AERCap: First Error Pointer: 04, ECRCGenCap+ ECRCGenEn+ ECRCChkCap+ ECRCChkEn+\n                        MultHdrRecCap- MultHdrRecEn- TLPPfxPres- HdrLogCap-\n                HeaderLog: 00000000 00000000 00000000 00000000\n        Capabilities: [150 v1] Alternative Routing-ID Interpretation (ARI)\n                ARICap: MFVC- ACS-, Next Function: 1\n                ARICtl: MFVC- ACS-, Function Group: 0\n        Capabilities: [180 v1] Single Root I/O Virtualization (SR-IOV)\n                IOVCap: Migration- 10BitTagReq- Interrupt Message Number: 000\n                IOVCtl: Enable- Migration- Interrupt- MSE- ARIHierarchy+ 10BitTagReq-\n                IOVSta: Migration-\n                Initial VFs: 8, Total VFs: 8, Number of VFs: 0, Function Dependency Link: 00\n                VF offset: 2, stride: 1, Device ID: 1014\n                Supported Page Size: 000007ff, System Page Size: 00000001\n                Region 0: Memory at 00000000cc800000 (64-bit, prefetchable)\n                VF Migration: offset: 00000000, BIR: 0\n        Capabilities: [1c0 v1] Secondary PCI Express\n                LnkCtl3: LnkEquIntrruptEn- PerformEqu-\n                LaneErrStat: 0\n        Capabilities: [230 v1] Access Control Services\n                ACSCap: SrcValid- TransBlk- ReqRedir- CmpltRedir- UpstreamFwd- EgressCtrl- DirectTrans-\n                ACSCtl: SrcValid- TransBlk- ReqRedir- CmpltRedir- UpstreamFwd- EgressCtrl- DirectTrans-\n        Kernel driver in use: mlx5_core\n        Kernel modules: mlx5_core\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#manage-firmware","title":"Manage Firmware","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#get-firmware-information","title":"Get Firmware Information","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-mstflint","title":"via mstflint","text":"<p>We can use mstflint to get details about the currently installed firmware.</p> <p>Command:</p> <pre><code>mstflint -d $CX_ADDRESS query\n</code></pre> <p>Output:</p> From Kube02 (Older firmware) <pre><code>root@kube02:~# mstflint -d $CX_ADDRESS query\nImage type:            FS3\nFW Version:            12.28.2006\nFW Release Date:       15.9.2020\nProduct Version:       12.28.2006\nRom Info:              type=UEFI version=14.21.17 cpu=AMD64,AARCH64\n                type=PXE version=3.6.102 cpu=AMD64\nDescription:           UID                GuidsNumber\nBase GUID:             98039b0300688698        4\nBase MAC:              98039b688698            4\nImage VSD:             N/A\nDevice VSD:            N/A\nPSID:                  MT_2150110033\nSecurity Attributes:   N/A\n</code></pre> <p>In the above case, this firmware is a bit out of date. We will be updating it later in this guide.</p> Output from Kube01 (Before Update / PSID Change) <pre><code>root@kube01:/etc/apt/sources.list.d# mstflint -d $CX_ADDRESS q\nImage type:            FS3\nFW Version:            14.14.2320\nFW Release Date:       10.5.2016\nProduct Version:       rel-14_14_2320\nRom Info:              type=UEFI version=14.9.50\n                type=PXE version=3.4.729\nDescription:           UID                GuidsNumber\nBase GUID:             248a070300914da4        8\nBase MAC:              248a07914da4            8\nImage VSD:             N/A\nDevice VSD:            N/A\nPSID:                  DEL2420110034\nSecurity Attributes:   N/A\n</code></pre> <p>PSID Update<p>Take note of the PSID here- when I updated this card, I flashed back to OEM firmware, rather then the Dell? branded firmwire which was previously on it.</p> </p> Output from Kube01 (After Update / PSID Change) <pre><code>root@kube01:~# mstflint -d $CX_ADDRESS query\nImage type:            FS3\nFW Version:            14.32.1900\nFW Release Date:       25.8.2024\nProduct Version:       14.32.1900\nRom Info:              type=UEFI version=14.25.17 cpu=AMD64,AARCH64\n                type=PXE version=3.6.502 cpu=AMD64\nDescription:           UID                GuidsNumber\nBase GUID:             248a070300914da4        8\nBase MAC:              248a07914da4            8\nImage VSD:             N/A\nDevice VSD:            N/A\nPSID:                  MT_2420110034\nSecurity Attributes:   N/A\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-mlxfwmanager","title":"via mlxfwmanager","text":"<p>Command:</p> <pre><code>mlxfwmanager\n</code></pre> <p>Output:</p> From Kube02 (Older Firmware) <pre><code>root@kube02:~# mlxfwmanager\nQuerying Mellanox devices firmware ...\n\nDevice #1:\n----------\n\nDevice Type:      ConnectX4\nPart Number:      MCX416A-CCA_Ax\nDescription:      ConnectX-4 EN network interface card; 100GbE dual-port QSFP28; PCIe3.0 x16; ROHS R6\nPSID:             MT_2150110033\nPCI Device Name:  0000:81:00.0\nBase GUID:        98039b0300688698\nBase MAC:         98039b688698\nVersions:         Current        Available\nFW             12.28.2006     N/A\nPXE            3.6.0102       N/A\nUEFI           14.21.0017     N/A\n\nStatus:           No matching image found\n</code></pre> From Kube01 (BEFORE Updating Firmware) <pre><code>root@kube01:~/mlnx# mlxfwmanager\nQuerying Mellanox devices firmware ...\n\nDevice #1:\n----------\n\nDevice Type:      ConnectX4LX\nPart Number:      020NJD_0MRT0D_Ax\nDescription:      Mellanox 25GBE 2P ConnectX-4 Lx Adapter\nPSID:             DEL2420110034\nPCI Device Name:  0000:01:00.0\nBase MAC:         248a07914da4\nVersions:         Current        Available\nFW             14.14.2320     N/A\nPXE            3.4.0729       N/A\nUEFI           14.9.0050      N/A\n\nStatus:           No matching image found\n</code></pre> From Kube01 (Firmware Updated) <pre><code>root@kube01:~# mlxfwmanager\nQuerying Mellanox devices firmware ...\n\nDevice #1:\n----------\n\nDevice Type:      ConnectX4LX\nPart Number:      MCX4121A-ACA_Ax\nDescription:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6\nPSID:             MT_2420110034\nPCI Device Name:  0000:01:00.0\nBase MAC:         248a07914da4\nVersions:         Current        Available\nFW             14.32.1900     N/A\nPXE            3.6.0502       N/A\nUEFI           14.25.0017     N/A\n\nStatus:           No matching image found\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-ethtool","title":"via ethtool","text":"<p>You can use <code>ethtool -i</code> to get firmware information from an interface.</p> <p>Command:</p> <pre><code>ethtool -i $CX_INTERFACE\n</code></pre> <p>Output:</p> <pre><code>root@kube01:~# ethtool -i $CX_INTERFACE\ndriver: mlx5_core\nversion: 6.8.12-8-pve\nfirmware-version: 14.32.1900 (MT_2420110034)\nexpansion-rom-version:\nbus-info: 0000:01:00.0\nsupports-statistics: yes\nsupports-test: yes\nsupports-eeprom-access: no\nsupports-register-dump: no\nsupports-priv-flags: yes\nroot@kube02:~# ethtool -i $CX_INTERFACE\ndriver: mlx5_core\nversion: 6.8.12-4-pve\nfirmware-version: 12.28.2006 (MT_2150110033)\nexpansion-rom-version:\nbus-info: 0000:81:00.0\nsupports-statistics: yes\nsupports-test: yes\nsupports-eeprom-access: no\nsupports-register-dump: no\nsupports-priv-flags: yes\nroot@kube05:~# ethtool -i $CX_INTERFACE\ndriver: mlx5_core\nversion: 6.8.12-8-pve\nfirmware-version: 12.28.2006 (MT_2150110033)\nexpansion-rom-version:\nbus-info: 0000:01:00.0\nsupports-statistics: yes\nsupports-test: yes\nsupports-eeprom-access: no\nsupports-register-dump: no\nsupports-priv-flags: yes\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#locate-new-firmware","title":"Locate New Firmware","text":"<p>The first task we need to do, is identify the card.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#identify-card","title":"Identify Card","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-mlxfwmanager_1","title":"via <code>mlxfwmanager</code>","text":"<p>To find new firmware, we need the model of your network adapter.</p> <p>This is the \"Part Number\" field from <code>mlxfwmanager</code></p> <p>Command:</p> <pre><code>mlxfwmanager | grep -E \"Part Number|PSID\" \n</code></pre> Output <pre><code># Before updating with Dell Firmware\nroot@kube01:~# mlxfwmanager | grep -E \"Part Number|PSID\"\nPart Number:      020NJD_0MRT0D_Ax\nPSID:             DEL2420110034\n# After updating &amp; flashing back to OEM Firmware\nroot@kube01:~# mlxfwmanager | grep -E \"Part Number|PSID\"\nPart Number:      MCX4121A-ACA_Ax\nPSID:             MT_2420110034\nroot@kube02:~# mlxfwmanager | grep -E \"Part Number|PSID\"\nPart Number:      MCX416A-CCA_Ax\nPSID:             MT_2150110033\nroot@kube05:/etc/apt/sources.list.d# mlxfwmanager | grep -E \"Part Number|PSID\"\nPart Number:      MCX416A-CCA_Ax\nPSID:             MT_2150110033\n</code></pre> <p>In the above output, Kube01 has a CX-4121A, while Kube02/Kube05 have CX-416A</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-physical-inspection","title":"via Physical Inspection","text":"<p>The back of the card \"should\" contain both a sticker, and label on the PCB with the specific model of your card.</p> <p></p> <p>This was from a dead card 25G CX-4121C I had on hand. It is a CX-4121C</p> <p>Digging through my stash, I found a few more examples.</p> <p>Here is the CX-416A 100G NIC used in Kube02, and Kube05 currently.</p> <p></p> <p>Here is an older CX-311A-XCAT (Single-port 10G. Dirt cheap. But old.)</p> <p></p> <p>And, finally, a ConnectX-3 CX-354A (Dual-Port 40G Ethernet / 56G Infiniband)</p> <p></p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#find-firmware","title":"Find Firmware","text":"<p>We can download firmware from Nvidia.</p> <p>Info<p>Links.. subject to change.</p> <p>Don't come at me with pitchforks with Nvidia moves these links... again...</p> </p> <ul> <li>Master Listing</li> <li>ConnectX-3 EN Firmware</li> <li>ConnectX-3 Pro EN Firmware</li> <li>ConnectX-4 LX Firmware</li> <li>ConnectX-4 EN Firmware</li> </ul>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#example-cx-416a-kube05","title":"Example - CX-416A (Kube05)","text":"<p>For this demo, I will be updating the firmware for the CX-416A on Kube05.</p> <p>First- I navigate to the listings for ConnectX-4 EN Firmware.</p> <p>Next, we need to locate the PSID.</p> <p>From the output from before- we have these details:</p> <pre><code>root@kube05:/etc/apt/sources.list.d# mlxfwmanager | grep -E \"Part Number|PSID\"\nPart Number:      MCX416A-CCA_Ax\nPSID:             MT_2150110033\n</code></pre> <p>Using both the part number, and PSID, we can locate the correct firmware.</p> <p>Info<p>If you cannot exactly match the part number, look through the various categories and try to match the PSID.</p> </p> <p></p> <p>Copy the download link for later.</p> <p>In this example, the link is: <code>https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip</code></p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#example-dell-branded-cx4121a","title":"Example - Dell-Branded CX4121A","text":"<p>Using the data from Kube01, we have these details:</p> <pre><code>root@kube01:~# mlxfwmanager | grep -E \"Part Number|PSID|Description\"\nPart Number:      020NJD_0MRT0D_Ax\nPSID:             DEL2420110034\nDescription:      Mellanox 25GBE 2P ConnectX-4 Lx Adapter\n</code></pre> <p>The first thing to note- this is a Dell product number. As well, the PSID prefixed with \"DEL\", also hints at Dell.</p> <p>For this, getting the firmware was slightly tricker.</p> <p>But- lets start at the ConnectX-4 LX Firmware</p> <p>We know this is a CX-4121A, based on the back of the card.</p> <p></p> <p>However, we run into an issue- this doesn't help us narrow it down.</p> <p></p> <p>So- at this point, you have to do a tiny bit of guess work.</p> <p>Take the original PSID: <code>DEL2420110034</code></p> <p>Strip the <code>DEL</code>, which leaves <code>2420110034</code></p> <p>And search through each category until you find <code>2420110034</code></p> <p>In this example, I found the matching partial PSID under \"MCX4121A-ACAT\"</p> <p></p> <p>The resulting URL being: <code>https://www.mellanox.com/downloads/firmware/fw-ConnectX4Lx-rel-14_32_1900-MCX4121A-ACA_Ax-UEFI-14.25.17-FlexBoot-3.6.502.bin.zip</code></p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#flash-card","title":"Flash Card","text":"<p>Since... I have a few of these to update, I am going to script out the process.</p> <p>Info<p>Normally, when updating firmware... Especially the NIC, I recommend you do so with a physically connected console (or IP-KVM).</p> <p>However, from my experiences doing this process- it can be done \"relatively safely\" over SSH as the firmware does not seem to apply until after boot.</p> </p> <pre><code># Using this URL as example: https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\n# Set Firmware URL\nFW_URL=\"https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\"\n# Get the archive name from the URL.\nFW_ARCHIVE_NAME=$(basename $FW_URL)\n# Get the resulting fw bin filename. (Remove the .zip extension)\nFW_FILE_NAME=$(basename \"$FW_ARCHIVE_NAME\" .zip)\n\n# Debug output\necho \"Archive Name: $FW_ARCHIVE_NAME\"\necho \"Bin Name: $FW_FILE_NAME\"\necho \"PCI Address: $CX_ADDRESS\"\n\n# Download firmware\nwget $FW_URL\n# Extract Firmware\nunzip $FW_ARCHIVE_NAME\n# Burn the new firmware.\nmstflint --allow_psid_change -d $CX_ADDRESS -i $FW_FILE_NAME burn \n\n# Finally, cleanup the files we downloaded.\nrm $FW_ARCHIVE_NAME\nrm $FW_FILE_NAME\n</code></pre> Output from Kube05 <pre><code>root@kube05:~# # Using this URL as example: https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\nroot@kube05:~# # Set Firmware URL\nroot@kube05:~# FW_URL=\"https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\"\nroot@kube05:~# # Get the archive name from the URL.\nroot@kube05:~# FW_ARCHIVE_NAME=$(basename $FW_URL)\nroot@kube05:~# # Get the resulting fw bin filename. (Remove the .zip extension)\nroot@kube05:~# FW_FILE_NAME=$(basename \"$FW_ARCHIVE_NAME\" .zip)\nroot@kube05:~#\nroot@kube05:~# # Debug output\nroot@kube05:~# echo \"Archive Name: $FW_ARCHIVE_NAME\"\nArchive Name: fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\nroot@kube05:~# echo \"Bin Name: $FW_FILE_NAME\"\nBin Name: fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin\nroot@kube05:~# echo \"PCI Address: $CX_ADDRESS\"\nPCI Address: 01:00.0\nroot@kube05:~#\nroot@kube05:~# # Download firmware\nroot@kube05:~# wget $FW_URL\n--2025-03-15 09:32:44--  https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\nResolving www.mellanox.com (www.mellanox.com)... 23.220.161.68, 23.220.161.71\nConnecting to www.mellanox.com (www.mellanox.com)|23.220.161.68|:443... connected.\nHTTP request sent, awaiting response... 301 Moved Permanently\nLocation: https://content.mellanox.com/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip [following]\n--2025-03-15 09:32:44--  https://content.mellanox.com/firmware/fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\nResolving content.mellanox.com (content.mellanox.com)... 107.178.241.102\nConnecting to content.mellanox.com (content.mellanox.com)|107.178.241.102|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 2366377 (2.3M) [application/zip]\nSaving to: \u2018fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\u2019\n\nfw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-Fl 100%[========================================================================================================================================&gt;]   2.26M  8.35MB/s    in 0.3s\n\n2025-03-15 09:32:45 (8.35 MB/s) - \u2018fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\u2019 saved [2366377/2366377]\n\nroot@kube05:~# # Extract Firmware\nroot@kube05:~# unzip $FW_ARCHIVE_NAME\nArchive:  fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip\ninflating: fw-ConnectX4-rel-12_28_2302-MCX416A-CCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin\nroot@kube05:~# mstflint --allow_psid_change -d $CX_ADDRESS -i $FW_FILE_NAME burn\n\nCurrent FW version on flash:  12.28.2006\nNew FW version:               12.28.2302\n\nFSMST_INITIALIZE -   OK\nWriting Boot image component -   OK\n-I- To load new FW run mstfwreset or reboot machine.\nroot@kube05:~# rm $FW_ARCHIVE_NAME\nroot@kube05:~# rm $FW_FILE_NAME\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#psid-mismatch","title":"PSID Mismatch","text":"<p>Info<p>This flag is already included with the above script.</p> <p>However- this dedicated section was added to assist others with this issue.</p> </p> <p>If you have a Dell/HP branded version, you may run into a PSID Mismatch.</p> <p>You will receive this error:</p> <pre><code>root@kube01:~/mlnx# mstflint -d $CX_ADDRESS -i $FW_FILE_NAME burn\nDone.\n    Current FW version on flash:  14.14.2320\n    New FW version:               14.32.1900\n\n\n-E- PSID mismatch. The PSID on flash (DEL2420110034) differs from the PSID in the given image (MT_2420110034).\n</code></pre> <p>This will stop the flashing process. To, enable changing the PSID, we can use this flag: <code>--allow_psid_change</code></p> <pre><code>root@kube01:~/mlnx# mstflint --allow_psid_change -d $CX_ADDRESS -i $FW_FILE_NAME burn\nDone.\n    Current FW version on flash:  14.14.2320\n    New FW version:               14.32.1900\n\n\n    You are about to replace current PSID on flash - \"DEL2420110034\" with a different PSID - \"MT_2420110034\".\n    Note: It is highly recommended not to change the PSID.\n\n  Do you want to continue ? (y/n) [n] : y\nBurning FW image without signatures -   1%\n\nBurning FW image without signatures - OK\nRestoring signature                     - OK\n-I- To load new FW run mstfwreset or reboot machine.\n</code></pre> <p>After, you will have a card with Mellanox firmware, instead of Dell/HP/etc firmware.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#configuration","title":"Configuration","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#read-configuration","title":"Read Configuration","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-ethtool_1","title":"via <code>ethtool</code>","text":"<p><code>ethtool</code> can be used to query information from ethernet interfaces.</p> <p>Please read ethtool manpages for additional options.</p> <pre><code># Query basic information, link modes, FEC, Speed, Duplex, etc...\n# Ie. Layer 2 Data / Parameters\necho \"Layer 2 Configuration\"\nethtool $CX_INTERFACE\n# Show ring / buffer parameters\necho \"Ring parameters\"\nethtool -g $CX_INTERFACE\n# Hardware Offload Parameters\necho \"Offload Parameters\"\nethtool -k $CX_INTERFACE\n# Driver Information\necho \"Driver Information\"\nethtool -i $CX_INTERFACE\n# Coalesce Configuration\necho \"Pause Information\"\nethtool -c $CX_INTERFACE\n# Channel Configuration\necho \"Channel Information\"\nethtool -l $CX_INTERFACE\n</code></pre> <p>Info<p>ethtool can also set parameters. However, these changes are not persistent!</p> <p>The changes would need to be saved somewhere, or placed in a script.</p> </p> Output from Kube01 <pre><code>root@kube01:~# # Query basic information, link modes, FEC, Speed, Duplex, etc...\nroot@kube01:~# # Ie. Layer 2 Data / Parameters\nroot@kube01:~# echo \"Layer 2 Configuration\"\nLayer 2 Configuration\nroot@kube01:~# ethtool $CX_INTERFACE\nSettings for enp1s0f0np0:\n        Supported ports: [ Backplane ]\n        Supported link modes:   1000baseKX/Full\n                                10000baseKR/Full\n                                25000baseCR/Full\n                                25000baseKR/Full\n                                25000baseSR/Full\n        Supported pause frame use: Symmetric\n        Supports auto-negotiation: Yes\n        Supported FEC modes: None        RS      BASER\n        Advertised link modes:  1000baseKX/Full\n                                10000baseKR/Full\n                                25000baseCR/Full\n                                25000baseKR/Full\n                                25000baseSR/Full\n        Advertised pause frame use: Symmetric\n        Advertised auto-negotiation: Yes\n        Advertised FEC modes: RS\n        Speed: 25000Mb/s\n        Duplex: Full\n        Auto-negotiation: on\n        Port: Direct Attach Copper\n        PHYAD: 0\n        Transceiver: internal\n        Supports Wake-on: d\n        Wake-on: d\n        Link detected: yes\nroot@kube01:~# # Show ring / buffer parameters\nroot@kube01:~# echo \"Ring parameters\"\nRing parameters\nroot@kube01:~# ethtool -g $CX_INTERFACE\nRing parameters for enp1s0f0np0:\nPre-set maximums:\nRX:             8192\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             8192\nCurrent hardware settings:\nRX:             1024\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             1024\nRX Buf Len:             n/a\nCQE Size:               n/a\nTX Push:        off\nTCP data split: off\nroot@kube01:~# # Hardware Offload Parameters\nroot@kube01:~# echo \"Offload Parameters\"\nOffload Parameters\nroot@kube01:~# ethtool -k $CX_INTERFACE\nFeatures for enp1s0f0np0:\nrx-checksumming: on\ntx-checksumming: on\n        tx-checksum-ipv4: off [fixed]\n        tx-checksum-ip-generic: on\n        tx-checksum-ipv6: off [fixed]\n        tx-checksum-fcoe-crc: off [fixed]\n        tx-checksum-sctp: off [fixed]\nscatter-gather: on\n        tx-scatter-gather: on\n        tx-scatter-gather-fraglist: off [fixed]\ntcp-segmentation-offload: on\n        tx-tcp-segmentation: on\n        tx-tcp-ecn-segmentation: off [fixed]\n        tx-tcp-mangleid-segmentation: off\n        tx-tcp6-segmentation: on\ngeneric-segmentation-offload: on\ngeneric-receive-offload: on\nlarge-receive-offload: off\nrx-vlan-offload: on\ntx-vlan-offload: on\nntuple-filters: off\nreceive-hashing: on\nhighdma: on [fixed]\nrx-vlan-filter: on\nvlan-challenged: off [fixed]\ntx-lockless: off [fixed]\nnetns-local: off [fixed]\ntx-gso-robust: off [fixed]\ntx-fcoe-segmentation: off [fixed]\ntx-gre-segmentation: on\ntx-gre-csum-segmentation: on\ntx-ipxip4-segmentation: off [fixed]\ntx-ipxip6-segmentation: off [fixed]\ntx-udp_tnl-segmentation: on\ntx-udp_tnl-csum-segmentation: on\ntx-gso-partial: on\ntx-tunnel-remcsum-segmentation: off [fixed]\ntx-sctp-segmentation: off [fixed]\ntx-esp-segmentation: off [fixed]\ntx-udp-segmentation: on\ntx-gso-list: off [fixed]\nfcoe-mtu: off [fixed]\ntx-nocache-copy: off\nloopback: off [fixed]\nrx-fcs: off\nrx-all: off\ntx-vlan-stag-hw-insert: on\nrx-vlan-stag-hw-parse: off [fixed]\nrx-vlan-stag-filter: on [fixed]\nl2-fwd-offload: off [fixed]\nhw-tc-offload: off\nesp-hw-offload: off [fixed]\nesp-tx-csum-hw-offload: off [fixed]\nrx-udp_tunnel-port-offload: on\ntls-hw-tx-offload: off [fixed]\ntls-hw-rx-offload: off [fixed]\nrx-gro-hw: off [fixed]\ntls-hw-record: off [fixed]\nrx-gro-list: off\nmacsec-hw-offload: on\nrx-udp-gro-forwarding: off\nhsr-tag-ins-offload: off [fixed]\nhsr-tag-rm-offload: off [fixed]\nhsr-fwd-offload: off [fixed]\nhsr-dup-offload: off [fixed]\nroot@kube01:~# # Driver Information\nroot@kube01:~# echo \"Driver Information\"\nDriver Information\nroot@kube01:~# ethtool -i $CX_INTERFACE\ndriver: mlx5_core\nversion: 6.8.12-8-pve\nfirmware-version: 14.32.1900 (MT_2420110034)\nexpansion-rom-version:\nbus-info: 0000:01:00.0\nsupports-statistics: yes\nsupports-test: yes\nsupports-eeprom-access: no\nsupports-register-dump: no\nsupports-priv-flags: yes\nroot@kube01:~# # Coalesce Configuration\nroot@kube01:~# echo \"Pause Information\"\nPause Information\nroot@kube01:~# ethtool -c $CX_INTERFACE\nCoalesce parameters for enp1s0f0np0:\nAdaptive RX: on  TX: on\nstats-block-usecs: n/a\nsample-interval: n/a\npkt-rate-low: n/a\npkt-rate-high: n/a\n\nrx-usecs: 8\nrx-frames: 128\nrx-usecs-irq: n/a\nrx-frames-irq: n/a\n\ntx-usecs: 8\ntx-frames: 128\ntx-usecs-irq: n/a\ntx-frames-irq: n/a\n\nrx-usecs-low: n/a\nrx-frame-low: n/a\ntx-usecs-low: n/a\ntx-frame-low: n/a\n\nrx-usecs-high: n/a\nrx-frame-high: n/a\ntx-usecs-high: n/a\ntx-frame-high: n/a\n\nCQE mode RX: on  TX: off\n\nroot@kube01:~# # Channel Configuration\nroot@kube01:~# echo \"Channel Information\"\nChannel Information\nroot@kube01:~# ethtool -l $CX_INTERFACE\nChannel parameters for enp1s0f0np0:\nPre-set maximums:\nRX:             n/a\nTX:             n/a\nOther:          n/a\nCombined:       12\nCurrent hardware settings:\nRX:             n/a\nTX:             n/a\nOther:          n/a\nCombined:       12\nroot@kube01:~#\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#via-mlxconfig","title":"via <code>mlxconfig</code>","text":"<p><code>mlxconfig</code> does exactly what its name says. It gets, and sets configurations.</p> <p>Info<p>Unlike ethtool, changes made using <code>mlxconfig</code> are persistent.</p> </p> <p>Command:</p> <pre><code>mlxconfig -d $CX_ADDRESS query\n</code></pre> <p>Output:</p> From Kube01 <pre><code>root@kube01:~# mlxconfig -d $CX_ADDRESS q\n\nDevice #1:\n----------\n\nDevice type:        ConnectX4LX\nName:               MCX4121A-ACA_Ax\nDescription:        ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6\nDevice:             01:00.0\n\nConfigurations:                                          Next Boot\n        MEMIC_BAR_SIZE                              0\n        MEMIC_SIZE_LIMIT                            _256KB(1)\n        FLEX_PARSER_PROFILE_ENABLE                  0\n        FLEX_IPV4_OVER_VXLAN_PORT                   0\n        ROCE_NEXT_PROTOCOL                          254\n        PF_NUM_OF_VF_VALID                          False(0)\n        NON_PREFETCHABLE_PF_BAR                     False(0)\n        VF_VPD_ENABLE                               False(0)\n        STRICT_VF_MSIX_NUM                          False(0)\n        VF_NODNIC_ENABLE                            False(0)\n        NUM_PF_MSIX_VALID                           True(1)\n        NUM_OF_VFS                                  8\n        NUM_OF_PF                                   2\n        SRIOV_EN                                    False(0)\n        PF_LOG_BAR_SIZE                             5\n        VF_LOG_BAR_SIZE                             0\n        NUM_PF_MSIX                                 63\n        NUM_VF_MSIX                                 11\n        INT_LOG_MAX_PAYLOAD_SIZE                    AUTOMATIC(0)\n        PCIE_CREDIT_TOKEN_TIMEOUT                   0\n        ACCURATE_TX_SCHEDULER                       False(0)\n        PARTIAL_RESET_EN                            False(0)\n        SW_RECOVERY_ON_ERRORS                       False(0)\n        RESET_WITH_HOST_ON_ERRORS                   False(0)\n        PCI_BUS0_RESTRICT_SPEED                     PCI_GEN_1(0)\n        PCI_BUS0_RESTRICT_ASPM                      False(0)\n        PCI_BUS0_RESTRICT_WIDTH                     PCI_X1(0)\n        PCI_BUS0_RESTRICT                           False(0)\n        PCI_DOWNSTREAM_PORT_OWNER                   Array[0..15]\n        CQE_COMPRESSION                             BALANCED(0)\n        IP_OVER_VXLAN_EN                            False(0)\n        MKEY_BY_NAME                                False(0)\n        UCTX_EN                                     True(1)\n        PCI_ATOMIC_MODE                             PCI_ATOMIC_DISABLED_EXT_ATOMIC_ENABLED(0)\n        TUNNEL_ECN_COPY_DISABLE                     False(0)\n        LRO_LOG_TIMEOUT0                            6\n        LRO_LOG_TIMEOUT1                            7\n        LRO_LOG_TIMEOUT2                            8\n        LRO_LOG_TIMEOUT3                            13\n        ICM_CACHE_MODE                              DEVICE_DEFAULT(0)\n        TX_SCHEDULER_BURST                          0\n        LOG_MAX_QUEUE                               17\n        LOG_DCR_HASH_TABLE_SIZE                     14\n        MAX_PACKET_LIFETIME                         0\n        DCR_LIFO_SIZE                               16384\n        NUM_OF_PLANES_P1                            0\n        NUM_OF_PLANES_P2                            0\n        IB_PROTO_WIDTH_EN_MASK_P1                   0\n        IB_PROTO_WIDTH_EN_MASK_P2                   0\n        ROCE_CC_PRIO_MASK_P1                        255\n        ROCE_CC_CNP_MODERATION_P1                   DEVICE_DEFAULT(0)\n        ROCE_CC_PRIO_MASK_P2                        255\n        ROCE_CC_CNP_MODERATION_P2                   DEVICE_DEFAULT(0)\n        CLAMP_TGT_RATE_AFTER_TIME_INC_P1            True(1)\n        CLAMP_TGT_RATE_P1                           False(0)\n        RPG_TIME_RESET_P1                           300\n        RPG_BYTE_RESET_P1                           32767\n        RPG_THRESHOLD_P1                            1\n        RPG_MAX_RATE_P1                             0\n        RPG_AI_RATE_P1                              5\n        RPG_HAI_RATE_P1                             50\n        RPG_GD_P1                                   11\n        RPG_MIN_DEC_FAC_P1                          50\n        RPG_MIN_RATE_P1                             1\n        RATE_TO_SET_ON_FIRST_CNP_P1                 0\n        DCE_TCP_G_P1                                1019\n        DCE_TCP_RTT_P1                              1\n        RATE_REDUCE_MONITOR_PERIOD_P1               4\n        INITIAL_ALPHA_VALUE_P1                      1023\n        MIN_TIME_BETWEEN_CNPS_P1                    4\n        CNP_802P_PRIO_P1                            6\n        CNP_DSCP_P1                                 48\n        CLAMP_TGT_RATE_AFTER_TIME_INC_P2            True(1)\n        CLAMP_TGT_RATE_P2                           False(0)\n        RPG_TIME_RESET_P2                           300\n        RPG_BYTE_RESET_P2                           32767\n        RPG_THRESHOLD_P2                            1\n        RPG_MAX_RATE_P2                             0\n        RPG_AI_RATE_P2                              5\n        RPG_HAI_RATE_P2                             50\n        RPG_GD_P2                                   11\n        RPG_MIN_DEC_FAC_P2                          50\n        RPG_MIN_RATE_P2                             1\n        RATE_TO_SET_ON_FIRST_CNP_P2                 0\n        DCE_TCP_G_P2                                1019\n        DCE_TCP_RTT_P2                              1\n        RATE_REDUCE_MONITOR_PERIOD_P2               4\n        INITIAL_ALPHA_VALUE_P2                      1023\n        MIN_TIME_BETWEEN_CNPS_P2                    4\n        CNP_802P_PRIO_P2                            6\n        CNP_DSCP_P2                                 48\n        LLDP_NB_DCBX_P1                             False(0)\n        LLDP_NB_RX_MODE_P1                          OFF(0)\n        LLDP_NB_TX_MODE_P1                          OFF(0)\n        LLDP_NB_DCBX_P2                             False(0)\n        LLDP_NB_RX_MODE_P2                          OFF(0)\n        LLDP_NB_TX_MODE_P2                          OFF(0)\n        ROCE_RTT_RESP_DSCP_P1                       0\n        ROCE_RTT_RESP_DSCP_MODE_P1                  DEVICE_DEFAULT(0)\n        ROCE_RTT_RESP_DSCP_P2                       0\n        ROCE_RTT_RESP_DSCP_MODE_P2                  DEVICE_DEFAULT(0)\n        DCBX_IEEE_P1                                True(1)\n        DCBX_CEE_P1                                 True(1)\n        DCBX_WILLING_P1                             True(1)\n        DCBX_IEEE_P2                                True(1)\n        DCBX_CEE_P2                                 True(1)\n        DCBX_WILLING_P2                             True(1)\n        KEEP_ETH_LINK_UP_P1                         True(1)\n        KEEP_IB_LINK_UP_P1                          False(0)\n        KEEP_LINK_UP_ON_BOOT_P1                     False(0)\n        KEEP_LINK_UP_ON_STANDBY_P1                  False(0)\n        DO_NOT_CLEAR_PORT_STATS_P1                  False(0)\n        AUTO_POWER_SAVE_LINK_DOWN_P1                False(0)\n        KEEP_ETH_LINK_UP_P2                         True(1)\n        KEEP_IB_LINK_UP_P2                          False(0)\n        KEEP_LINK_UP_ON_BOOT_P2                     False(0)\n        KEEP_LINK_UP_ON_STANDBY_P2                  False(0)\n        DO_NOT_CLEAR_PORT_STATS_P2                  False(0)\n        AUTO_POWER_SAVE_LINK_DOWN_P2                False(0)\n        NUM_OF_VL_P1                                _4_VLs(3)\n        NUM_OF_TC_P1                                _8_TCs(0)\n        NUM_OF_PFC_P1                               8\n        VL15_BUFFER_SIZE_P1                         0\n        NUM_OF_VL_P2                                _4_VLs(3)\n        NUM_OF_TC_P2                                _8_TCs(0)\n        NUM_OF_PFC_P2                               8\n        VL15_BUFFER_SIZE_P2                         0\n        DUP_MAC_ACTION_P1                           LAST_CFG(0)\n        SRIOV_IB_ROUTING_MODE_P1                    LID(1)\n        IB_ROUTING_MODE_P1                          LID(1)\n        DUP_MAC_ACTION_P2                           LAST_CFG(0)\n        SRIOV_IB_ROUTING_MODE_P2                    LID(1)\n        IB_ROUTING_MODE_P2                          LID(1)\n        PHY_FEC_OVERRIDE_P1                         DEVICE_DEFAULT(0)\n        PHY_FEC_OVERRIDE_P2                         DEVICE_DEFAULT(0)\n        PF_SD_GROUP                                 0\n        ROCE_CONTROL                                ROCE_ENABLE(2)\n        PCI_WR_ORDERING                             per_mkey(0)\n        MULTI_PORT_VHCA_EN                          False(0)\n        PORT_OWNER                                  True(1)\n        ALLOW_RD_COUNTERS                           True(1)\n        RENEG_ON_CHANGE                             True(1)\n        TRACER_ENABLE                               True(1)\n        IP_VER                                      IPv4(0)\n        BOOT_UNDI_NETWORK_WAIT                      0\n        UEFI_HII_EN                                 True(1)\n        BOOT_DBG_LOG                                False(0)\n        UEFI_LOGS                                   DISABLED(0)\n        BOOT_VLAN                                   1\n        LEGACY_BOOT_PROTOCOL                        NONE(0)\n        BOOT_INTERRUPT_DIS                          False(0)\n        BOOT_LACP_DIS                               False(0)\n        BOOT_VLAN_EN                                True(1)\n        BOOT_PKEY                                   0\n        DYNAMIC_VF_MSIX_TABLE                       False(0)\n        EXP_ROM_UEFI_ARM_ENABLE                     False(0)\n        EXP_ROM_UEFI_x86_ENABLE                     False(0)\n        EXP_ROM_PXE_ENABLE                          True(1)\n        ADVANCED_PCI_SETTINGS                       False(0)\n        SAFE_MODE_THRESHOLD                         10\n        SAFE_MODE_ENABLE                            True(1)\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#common-settings","title":"Common Settings","text":"<p>Note, these configurations are all set using <code>mlxconfig</code></p> <p>Info<p>You can also configure the network adapters at boot-time, by pressing the displayed key-combination during the boot process.</p> <p>This method, might be a bit easier for you.</p> </p> <p>If- you have a dual-port NIC, you will need to set many of these commands for BOTH PCI Addresses.</p> <p>To view all support configurations, with documentation, use this command:</p> <pre><code>mlxconfig -d $CX_ADDRESS show_confs\n</code></pre> <p>I will be using these variables for the below configurations. </p> <p>If- your adapter does not have multiple PHYSICAL addresses displayed- remove the line referencing CX_ADDRESS_2</p> <p>Info<p>Physical is mentioned here, as these cards support SR-IOV, which will present multiple \"virtual\" copies of the card, which can be directly passed into virtual machines, kubernetes, etc.</p> </p> <pre><code>lspci | grep Mellanox\n\n# Fill in your addresses.\nCX_ADDRESS_1=\"01:00.0\"\nCX_ADDRESS_2=\"01:00.1\"\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#enabledisable-pxeiscsi-boot-set-boot-parameters","title":"Enable/Disable PXE/iSCSI Boot / Set Boot Parameters","text":"<p>I personally, don't PXE boot my hypervisors. As such, eliminating the extra 30+ seconds during boot, is ideal for me.</p> <p>Configuration Documentation</p> <p>This can also be set to do iSCSI boot as well. (aka, You can boot from an iSCSI disk on a remote NAS)</p> <p>Each physical port is set independantly. </p> <p>The NICs support IPv4, and 6, Vlans, PXE and iSCSI, and quite a few other boot-related settings.</p> <p>Command:</p> <pre><code># Set desired mode: Options:\n# - None \n# - PXE - With failover \n# - iSCSI - Will failover to PXE after failures\n# - PXE_WO_FAIL_ISCSI - PXE without failover to iSCSI\n# - ISCSI_WO_FAIL_PXE - iSCSI boot without failover to PXE\n\nCX_1_BOOTMODE=\"None\"\nCX_2_BOOTMODE=\"None\"\n\n## Enable, or Disable setting vlan for PXE/iSCSI boot\nCX_1_BOOT_VLAN_ENABLE=0\nCX_2_BOOT_VLAN_ENABLE=0\n\n## Sets the VLAN used for PXE/iSCSI boot (if the above setting is enabled.)\nCX_1_BOOT_VLAN=1\nCX_2_BOOT_VLAN=1\n\nmlxconfig -d $CX_ADDRESS_1 set LEGACY_BOOT_PROTOCOL=$CX_1_BOOTMODE BOOT_VLAN_EN=$CX_1_BOOT_VLAN_ENABLE BOOT_VLAN=$CX_1_BOOT_VLAN\nmlxconfig -d $CX_ADDRESS_2 set LEGACY_BOOT_PROTOCOL=$CX_2_BOOTMODE BOOT_VLAN_EN=$CX_2_BOOT_VLAN_ENABLE BOOT_VLAN=$CX_2_BOOT_VLAN\n</code></pre> <p>If- you want to enable booting PXE/iSCSI via these NIC's, I'd recommend using the boot-time configuration utility, as it exposes the options in a much easier to use way.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#enabledisable-sr-iov","title":"Enable/Disable SR-IOV","text":"<p>SR-IOV is used to present multiple \"virtual\" copies of your physical NIC. These instances can be passed into a VM, allowing the VM DIRECT access to the network, skipping the hypervisor's networking stack.</p> <p>The benefit here- is potentially dramatically increased networking performance. However- there are some trade-offs...</p> <p>A few examples being-</p> <ol> <li>Proxmox firewall rules will have no-effect</li> <li>Work-arounds are needed for VM to be able to talk to Host, and vise-versa.</li> </ol> <p>Each physical port is set independantly. </p> <pre><code># 1 = Enable, 0 = Disable\nCX_1_SRIOV=0\nCX_2_SRIOV=0\n\n# Set number of VFS (SRIOV Virtual Functions)\nCX_1_SRIOV_NUMVFS=16\nCX_2_SRIOV_NUMVFS=16\n\n# Set the desired configurations.\nmlxconfig -d $CX_ADDRESS_1 set SRIOV_EN=$CX_1_SRIOV NUM_OF_VFS=$CX_1_SRIOV_NUMVFS\nmlxconfig -d $CX_ADDRESS_2 set SRIOV_EN=$CX_2_SRIOV NUM_OF_VFS=$CX_2_SRIOV_NUMVFS\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#power-saving-features","title":"Power Saving Features","text":"<p>Here are a few power savings features:</p> <p>Info<p>YES. The ConnectX-4 cards supports ASPM.</p> <p>Doesn't work for you? Update your firmware. The feature is relatively new. Make sure you have a ConnextX-4 or higher.</p> <pre><code>root@kube01:~# lspci -vvvv -s $CX_ADDRESS | grep ASPM\n        LnkCap: Port #0, Speed 8GT/s, Width x8, ASPM L1, Exit Latency L1 &lt;4us\n                ClockPM- Surprise- LLActRep- BwNot- ASPMOptComp+\n        LnkCtl: ASPM L1 Enabled; RCB 64 bytes, Disabled- CommClk+\n</code></pre> </p> <pre><code>settings=(\n# 1 = Power down NIC when not in use, 0 = Keep Link Powered\n    \"AUTO_POWER_SAVE_LINK_DOWN_P1=1\"\n    \"AUTO_POWER_SAVE_LINK_DOWN_P2=1\"\n# 0 = ASPM Enabled, 1 = ASPM Disabled\n    \"PCI_BUS0_RESTRICT_ASPM=0\"\n)\n\nmlxconfig -d $CX_ADDRESS set \"${settings[@]}\"\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#set-port-mode-infiniband-or-ethernet","title":"Set Port Mode Infiniband or Ethernet","text":"<p>ConnectX-4 infiniband NICs can set each port individually to either Infiniband mode, or Ethernet mode.</p> <p>For most cases, unless you have a Infiniband switch, running in IB mode, and the knowlege/setup for IB, you should be running in ethernet mode.</p> <pre><code>settings=(\n        # 1 = Infiniband, 2 = Ethernet\n        LINK_TYPE_P1=2\n        LINK_TYPE_P2=2\n)\n\n\n# Set the desired configurations.\nmlxconfig -d $CX_ADDRESS set \"${settings[@]}\"\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#persistent-ethtool-tuning-hardware-offload-jumbo-frames-etc","title":"Persistent Ethtool Tuning (Hardware offload, Jumbo Frames, etc)","text":"<p>As ethtool changes are not directly persistent... We need to fix that.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#method-1-put-settings-in-etcnetworkinterfaces","title":"Method 1. Put settings in /etc/network/interfaces","text":"<p>This method is simple, just add the correct settings to <code>/etc/network/interfaces</code></p> /etc/network/interfaces<pre><code>iface enp1s0 inet dhcp\n    # Ring Buffer Size\n    HARDWARE_DMA_RING_rx=8192\n    HARDWARE_DMA_RING_tx=8192\n    # Hardware Offload Features\n    OFFLOAD_rx=on\n    OFFLOAD_tx=on\n    OFFLOAD_tso=on\n    OFFLOAD_gso=on\n    OFFLOAD_tx_gso_partial=on\n    OFFLOAD_gro=on\n    OFFLOAD_lro=off\n    OFFLOAD_rxvlan=on\n    OFFLOAD_txvlan=on\n    OFFLOAD_rxhash=on\n    OFFLOAD_rx_vlan_filter=on\n    OFFLOAD_tx_gre_segmentation=on\n    OFFLOAD_tx_gre_csum_segmentation=on\n    OFFLOAD_tx_udp_tnl_segmentation=on\n    OFFLOAD_tx_udp_tnl_csum_segmentation=on\n    OFFLOAD_tx_udp_segmentation=on\n    OFFLOAD_rx_udp_tunnel_port_offload=on\n    OFFLOAD_macsec_hw_offload=off\n    # Disable Flow Control\n    IF_ETHERNET_PAUSE_rx=off\n    IF_ETHERNET_PAUSE_tx=off\n    # Enable Adaptive Coalescing\n    HARDWARE_IRQ_COALESCE_adaptive_rx=on\n    HARDWARE_IRQ_COALESCE_adaptive_tx=on\n    # Disable Wake on LAN\n    IF_ETHERNET_WOL=d\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#method-2-custom-if-up-script","title":"Method 2. Custom if-up script.","text":"<p>(This- is the method I went with. I feel, its easier to maintain.)</p> <p>Copy and paste the below block into a terminal. It will automatically create the script.</p> <pre><code>CUSTOM_SCRIPT_NAME=\"ethtool-custom\"\n# Create empty file\ntouch /etc/network/if-up.d/$CUSTOM_SCRIPT_NAME\n# Mark as executable\nchmod +x /etc/network/if-up.d/$CUSTOM_SCRIPT_NAME\n# Create script using text-editor.\n# The rest of the lines will be automatially added.\nnano /etc/network/if-up.d/$CUSTOM_SCRIPT_NAME\n#!/bin/bash\n\nIFACE=\"$1\"\n\ncase \"$IFACE\" in\n  enp1s0f0np0|enp1s0f1np1)\n    # Increase ring buffer size\n    ethtool -G \"$IFACE\" rx 8192 tx 8192\n    # Enable hardware checksum\n    ethtool -K \"$IFACE\" rx on tx on\n    # TCP Segmentation Offload\n    ethtool -K \"$IFACE\" tso on\n    # Generic Segmentation Offload\n    ethtool -K \"$IFACE\" gso on tx-gso-partial on\n    # Generic Receive Offload\n    ethtool -K \"$IFACE\" gro on\n    # DISABLE large receive offload - Known to cause issues with certain applications\n    ethtool -K \"$IFACE\" lro off\n    # Enable Vlan Offload TX &amp; TX\n    ethtool -K \"$IFACE\" rxvlan on txvlan on\n    # Enable receive hashing\n    ethtool -K \"$IFACE\" rxhash on\n    # Enable receive vlan filtering\n    ethtool -K \"$IFACE\" rx-vlan-filter on\n    # More segmentation-related features\n    ethtool -K \"$IFACE\" tx-gre-segmentation on tx-gre-csum-segmentation on tx-udp_tnl-segmentation on tx-udp_tnl-csum-segmentation on tx-udp-segmentation on\n    # No idea.\n    ethtool -K \"$IFACE\" rx-udp_tunnel-port-offload on\n    # Disable Macsec hardware offload - Adds additional overhead if we aren't using this.\n    ethtool -K \"$IFACE\" macsec-hw-offload off\n    # Disable Flow-Control\n    ethtool -A \"$IFACE\" rx off tx off\n    # Set Coalescing parameters to reduce Interrupts, adaptive if possible.\n    ethtool -C \"$IFACE\" adaptive-rx on adaptive-tx on\n    # Disable Wake on LAN.\n    ethtool -s \"$IFACE\" wol d\n    ;;\n  #eth1)\n    # eth1- specific goes here.\n    # ;;\n  *)\n    echo \"Did not match expected interface name. No actions taken\"\n    echo \"Interface Name: $IFACE\"\n    ;;\nesac\n\nexit 0\n</code></pre> <p>To test, execute the script and pass the first argument as the interface name</p> Kube01 Results <pre><code>root@kube01:/etc/network/if-up.d# ./ethtool-custom  enp1s0f0np0\nActual changes:\ntx-checksum-ipv4: off [requested on]\ntx-checksum-ipv6: off [requested on]\ntx-checksum-fcoe-crc: off [requested on]\ntx-checksum-sctp: off [requested on]\nActual changes:\ntx-tcp-ecn-segmentation: off [requested on]\nroot@kube01:/etc/network/if-up.d# ./ethtool-custom  enp1s0f1np1\nActual changes:\ntx-checksum-ipv4: off [requested on]\ntx-checksum-ipv6: off [requested on]\ntx-checksum-fcoe-crc: off [requested on]\ntx-checksum-sctp: off [requested on]\nActual changes:\ntx-tcp-ecn-segmentation: off [requested on]\ntx-tcp-mangleid-segmentation: on\n</code></pre> Kube05 Results <pre><code>root@kube05:~# /etc/network/if-up.d/$CUSTOM_SCRIPT_NAME enp1s0f0np0\nActual changes:\ntx-checksum-ipv4: off [requested on]\ntx-checksum-ipv6: off [requested on]\ntx-checksum-fcoe-crc: off [requested on]\ntx-checksum-sctp: off [requested on]\nActual changes:\ntx-tcp-ecn-segmentation: off [requested on]\ntx-tcp-mangleid-segmentation: on\nroot@kube05:~# /etc/network/if-up.d/$CUSTOM_SCRIPT_NAME enp1s0f1np1\nActual changes:\ntx-checksum-ipv4: off [requested on]\ntx-checksum-ipv6: off [requested on]\ntx-checksum-fcoe-crc: off [requested on]\ntx-checksum-sctp: off [requested on]\nActual changes:\ntx-tcp-ecn-segmentation: off [requested on]\ntx-tcp-mangleid-segmentation: on\nroot@kube05:~#\n</code></pre>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#other","title":"Other","text":"","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/mellanox-configuration-guide/#which-nics-or-switches-to-buy","title":"Which NICs or Switches to buy?","text":"<p>If- you are looking to buy 10/25/40/100G NICs, please see This Post.</p>","tags":["Homelab","Networking","Networking/Mellanox"]},{"location":"blog/2025/learning-about-computers--electronics/","title":"Learning about how a computer works and about electronics","text":"<p>Want to learn about how a computer works?</p> <p>Not- at a high level.... </p> <p>But, at a very, very low level, where you literally build a functional computer from transistors. </p> <p>If so- this is a list of resources which I have found extremely handy for myself.</p> <p>Also, because ADHD.... there is also a list of automation centric games, channels involving lasers, plasma, etc.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#building-a-pc-from-scratch","title":"Building.... a PC from scratch.","text":"<p>For learning the basics- one of the BEST resources I have found, is a simple game.</p> <p>NAND Game</p> <p>In this game- you will go through the process of literally assembling a functional computer, using nothing more then a bunch of relays. </p>"},{"location":"blog/2025/learning-about-computers--electronics/#had-a-lot-of-fun-but-want-wish-you-could-play-more","title":"Had a lot of fun, but, want wish you could play more?","text":"<p>Well, Sebastian Lague built a circuit simulator, which feels much like NAND Game.</p> <p>You can find it here: Digital-Logic-Sim</p> <p>Want some more context? He has a video series exploring how computers work, using the above tool.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#want-to-build-your-own-pc-from-scratch-and-play-tetris-on-it","title":"Want to build your own PC from scratch and play tetris on it?","text":"<p>If so, you will want to go take a look at James Sherman</p> <p>His channel is dedicated to a homemade 8-bit pipelined CPU.</p> <p>The populated PCBs you see in his most recent video- those aren't off the shelf.</p> <p>James literally designed them. Every component has a related video series.</p> <p>ALU design, UART, Audio, Memory, File Systems... ALL of it.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-want-to-do-that-but-without-as-much-work","title":"I want to do that- but, without AS much work.","text":"<p>Then checkout Ben Eater where the focus of the channel is a 6501 CPU running on a breadboard. Many of the same topics are addressed, such as input, output, assembly... etc..</p>"},{"location":"blog/2025/learning-about-computers--electronics/#thats-all-nice-but-i-just-want-to-make-a-video-game","title":"Thats all nice, but, I just want to make a video game.","text":"<p>If so- check out Javid9</p> <p>Very little assembly here- and the channel is mostly focused on writing graphical applications (games) in c++.</p> <p>However, he does have an entire series on writing a NES emulator.</p> <p>He explains all of the math in an easy to understand way. </p>"},{"location":"blog/2025/learning-about-computers--electronics/#know-what-i-just-want-to-play-a-video-game-and-learn-more-about-writing-code","title":"Know what, I just want to PLAY a video game, and learn more about writing code","text":"<p>Understandable. I have a few resources for you.</p> <p>Screeps is an online \"MMO\" where you program \"bots\" using javascript.</p> <p>Stationeers is a resource management / survival simulator where you build a space station, and... manage resources, and elements in order to survive.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-dont-actually-want-to-play-the-game-i-just-want-to-watch-it","title":"I don't actually want to play the game.... I just want to watch it.","text":"<p>Then, I suppose you can watch CowsAreEvil play it for you, and write the assembly.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-really-love-automation-focused-games","title":"I REALLY love automation-focused games.","text":"<p>So do I! Here are my favorites-</p> <ol> <li>Oxygen Not Included</li> <li>Factorio<ul> <li>One of the most optimized 2D Automation games around. </li> <li>Very interesting Devblog too.</li> </ul> </li> <li>Shapez<ul> <li>Imagine factorio, but, much simpler. Much more casual.</li> </ul> </li> <li>Mindustry<ul> <li>Tower-defense, with automation and resource management.</li> <li>And, you can play it on your phone.</li> </ul> </li> <li>Satisfactory<ul> <li>Factorio, but, in 3D!</li> </ul> </li> <li>Dyson Sphere Program<ul> <li>Satisfactory- but, at Universe Scale!</li> </ul> </li> <li>Stationeers<ul> <li>In space, and space is trying to kill you!</li> </ul> </li> </ol> <p>And, let me share one last game.</p> <p>Minecraft</p> <p>At this point, you might be wondering why it is being mentioned under a section about automation-based games.....</p> <p>Quite simply, Some of the modded variants have automation-based gameplay, which goes into more depth then most of the games listed above.</p> <ul> <li>Feed The Beast</li> <li>Gregtech: NH</li> </ul> <p>Take- Gregtech for example. It can have extremely complex resource diagrams, for producing materials. Platinum, for example</p> <p>Personally- I have spent more hours on the automation centric minecraft mods, then I have spent on any of the games listed about.</p> <p>Oh. And.... on the note of this post's original topic....</p> <p>You can build a computer, in minecraft. Which plays minecraft</p> <p>So- don't be quick to discredit it, based on its blocky graphics.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-dont-care-about-the-software-i-want-to-learn-more-about-electronics","title":"I don't care about the software, I want to learn more about electronics!","text":"<p>I have resources for that too!</p> <p>Visit EEVblog where you can meet Dave, who really enjoys electrical engineering. </p> <p>Or, if you prefer a bit more humor-</p> <p>Check out ElectroBOOM, where you can learn about electrical engineering while watching Mehdi shock himself. </p>"},{"location":"blog/2025/learning-about-computers--electronics/#oh-that-last-one-was-funny-do-you-have-anything-like-this-but-more-dangerous-i-like-danger","title":"Oh, that last one was funny. DO- you have anything like this, but, more dangerous?? I like danger!","text":"<p>You can watch... PhotonicInduction who will casually play with many things you should not step near.</p> <p>Although- be warned- he disappears for years at a time. We, aren't yet sure if he finally electrocuted himself, or was locked in prison for causing an widespread grid outage.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-like-lasers-and-lightning-i-want-to-build-a-death-ray","title":"I like lasers and lightning. I want to build a death ray.","text":"<p>StyroPyro is your man. </p>"},{"location":"blog/2025/learning-about-computers--electronics/#plasma-is-cool-cna-i-learn-more","title":"Plasma is cool. Cna I learn more?","text":"<p>Plasmachannel has your back.</p>"},{"location":"blog/2025/learning-about-computers--electronics/#i-just-want-to-see-random-short-videos-involving-electrical-components","title":"I just want to see random short videos involving electrical components.","text":"<p>GreatScott is an interesting fellow, with interesting videos. The content is pretty random, but, typically gravitates to electronics. </p> <p>But- unlike the really, REALLY stupid shorts you see while death-browsing on facebook... these videos are actually useful, and educational.</p>"},{"location":"blog/2025/din-mount-closet-part-1/","title":"DIN Mount Network Closet - Part 1 - Building the frame","text":"<p>So... Near the end of 2024, I ended up cleaning up my rack, and making everything nice and tidy.</p> <p>If- you missed that, have a look at the 2024 Homelab Summary</p> <p>For the next problem- my networking closet is an absolute disaster.</p> <p>There are wires hanging everywhere... There are switches, and cables everywhere... its a mess.</p> <p></p> <p>I plan on building a frame, with DIN rails for mounting all of this hardware.</p> <p>I see tons of racks. I see tons of mini racks. I rarely see DIN-mounted networking.</p> <p>Part 1, is building the frame which will hold all of the components. </p> <p>This is all wood and construction. Nothing technical.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#cutting-raw-materials","title":"Cutting raw materials","text":"<p>The frame itself, took roughly a week to build. A lot of time was spent just waiting for glue to harden and cure.</p> <p>Another design decision- I wanted this to be very easily removable, and installable- I came up with a pretty creative solution for this.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#taking-some-measurements","title":"Taking some measurements.","text":"<p>I wanted to mount this in the back of the closet, out of sight, out of mind. The problem is, there is limited room here.</p> <p></p> <p>This- is the first constraint of the project. </p> <p>I did want to make it wide enough to fit standard-width rack hardware.</p> <p></p> <p>In the end, I came up with around 23.5\" wide, and around 22.5\" tall.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#cutting-plywood","title":"Cutting Plywood","text":"<p>For this project, I used around a half sheet of plywood, and a few 1x2s. The overall lumber cost was less then 50$.</p> <p>Since I had measurements- the next step, was to cut the plywood.</p> <p>I started by using one of the 1x2s to trace the measurements.</p> <p></p> <p>After drawing the lines, and double-checking the measurements, the plywood was moved to a table where I could cut it using a standard skilsaw.</p> <p>I clamped one of the 1x2s to the plywood as a guide for the saw. (Me + Straight Lines = Not happening!)</p> <p>Always, double, and then triple-check your measurements.</p> <p>You can always measure again. But- once you make the cut- you can't go back.</p> <p></p> <p></p> <p>And- when you think everything is spot-on, measure again!</p> <p></p> <p>There SHOULD be a picture here of the cut plywood, however, of the 161 pictures I took of this project.... that was not one of them.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#mitering-the-trim","title":"Mitering the trim.","text":"<p>So- instead of just slapping up a basic piece of plywood, I did want to make this look somewhat appealing to the eye.</p> <p>The purpose of the 1x2s is to make a border around the edge.</p> <p>I decided to cut the corners at a 45 degree angle, to make nice, neat joins.</p> <p>So... out came the miter saw. I picked up this metabo for 87$, brand new from Amazon.</p> <p>Worth every penny. (Its- not 87$ anymore. But- only 129$ as of writing this.)</p> <p>Anyways- first cut down.</p> <p></p> <p>And... another.</p> <p></p> <p>And, after 8 total cuts, I had a frame.</p> <p></p> <p>Next step is- to start assembling....</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#basic-frame-assembly","title":"Basic frame assembly","text":"","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#initial-assembly","title":"Initial Assembly","text":"<p>For this frame, everything is both screwed, and glued together.</p> <p>Make sure to identify suitable nails, which will not over penetrate.</p> <p></p> <p>I did cheat- and use a 90 degree welding JIG I had in my shop.</p> <p></p> <p>Not required- but, does help to lock a corner to 90 degrees.</p> <p>As noted above, everything is glued. I used standard construction adhesive as I had a few tubes laying around.</p> <p></p> <p>Make sure to check your square before attaching anything!!!!</p> <p></p> <p>And, as usual, ensure everything stays square.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#clamping-overnight","title":"Clamping overnight","text":"<p>For the glue to correctly set, we need to ensure everything is clamped tightly.</p> <p>For this, you will need... a lot of clamps.</p> <p>This- was the end of the first night.</p> <p></p> <p>After removing the clamps the following evening, we have a pretty solid frame.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#hiding-nails","title":"Hiding Nails","text":"<p>I wanted to hide the visible nails from the final product. So- I started on this next.</p> <p>I used a hammer and a punch to slightly tap in each of the nails.</p> <p></p> <p>At this point, wood filler will fill in the void. However- I did not have any on hand.</p> <p>Instead- I had a tube of wood plastic.</p> <p>This- would be fine, except... it was white. (left over from trim work)</p> <p>But- I went ahead and used it anyways. Ideally- having it wood-colored would have made things a bit easier.</p> <p></p> <p>Finally- I used a putty knife to knock the bulk excess off- and then used a sanding block for the final sanding (not shown here).</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#mounting-wedge","title":"Mounting Wedge","text":"<p>Remember earlier- I said I wanted it to be easily installable, and removable? I decided to build a self-centering wedge mount.</p> <p>The goal, you can just pick it up off the wall when needed, and when mounted, it should be perfectly secure without any wobbling.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#coming-up-with-an-idea","title":"Coming up with an idea","text":"<p>Nothing here is being built based on any guide, video, etc. </p> <p>I have an idea- and I am winging it to the end result. As a result- there was a bit of experimentation here.</p> <p>I started with, painting an arrow on the back of the frame, to ensure I don't accidentally mount anything in the wrong direction.</p> <p></p> <p>Next, I use the miter saw to slice a few 2x4s into \"Wedges\"</p> <p></p> <p>A quick and dirty mock-up just to see if the idea could work.</p> <p>Info</p> <p>Yes- I know they are not cut even.</p> <p>Stick with me!!!</p> <p></p> <p>After seeing this- I decided I would stick with this course. So- I needed to go miter a few more 2x4s. </p> <p>This time- I got the cut perfectly centered.</p> <p></p> <p>A new mock with two sets of wedges.</p> <p></p> <p>Using two smaller wedges, instead of one large one gives me the ability to place a \"alignment device\" in the middle, making it easier to install.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#building-a-frame-around-the-back","title":"Building a frame around the back","text":"<p>When this is sitting against the wall, I don't want to scratch up the wall.</p> <p>I decided to go ahead and build a frame around the back.</p> <p>Starting... with a single piece...</p> <p></p> <p>And, of course, everything is screwed, and glued.</p> <p></p> <p>Glue- requires overnight clamping for best results.</p> <p>The clamping also ensures we have everything mounted as flat as possible.</p> <p>The 2x4s seen here are to ensure even spacing on either side.</p> <p></p> <p>Info</p> <p>The bottom was purposely left open. </p> <p>The reason being, I may drill holes to allow wires and cables to pass through to the back.</p> <p>At this point, we have a 3-side frame around the rear. Its time to start mounting the \"Wedge\" assembly.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#mounting-hardware","title":"Mounting hardware","text":"<p>You may have noticed a few pictures like the next one. The reason- You need to ensure you fasteners have enough penetration, without over penetrating.</p> <p></p> <p>I am using a Husky case from Home Depot to organize my hardware, It makes it easy to see what I have at a glance, and to help choose the correct hardware.</p> <p>Not pictured- I have THREE of these.</p> <p></p> <p>Not saying its the best solution- but, I am saying it works extremely well for me.</p> <p>Its portable, easy to view. Easy to store. And stack-able.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#glueing-the-wedge","title":"Glueing the wedge","text":"<p>Ok, for building the wedge assembly, I started with gluing the wedges to a piece of 1x2.</p> <p></p> <p>NOW, given these are literally in the shape of a wedge, clamping becomes slightly more difficult.</p> <p>BUT, with enough clamps.... anything is possible!</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#wedge-continued","title":"Wedge Continued","text":"<p>The next evening, I had my wedge assembly.</p> <p></p> <p>BUT, I did want to add a few screws to better secure it. So, I measured holes, and brought it to the drill press.</p> <p>Info</p> <p>A sliding vise was extremely handy here, and sped up this process significantly.</p> <p></p> <p>And.... I countersunk holes in the angled piece. 1\" of \"meat\" was left on the wedges to give plenty of material to screw to.</p> <p>The dial indicator on the drill press is extremely useful in getting the correct depth.</p> <p></p> <p>All said and done- we now have countersunk holes.</p> <p>And, of course, a picture for correct hardware selection.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#mounting-the-wedge","title":"Mounting the wedge","text":"<p>With the wedge assemblies themselves, screwed and glued.... it was time to mount them.</p> <p>And, of course, hardware selection photo...</p> <p></p> <p>Adding adhesive to the back of the assembly, in preparation to mount to the frame.</p> <p></p> <p>And... clamp everything down tight.... </p> <p></p> <p>Screwing the middle piece in.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#end-result","title":"End Result","text":"","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#front-side","title":"Front Side","text":"<p>For the front side- we have a simple frame. Lightly sanded, Not painted. Just- a bare frame to work with.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#back-side","title":"Back Side","text":"<p>The end result of the rear, is a self-centering wedge mount.</p> <p>Info</p> <p>Note- this is also the back side.</p> <p>I'm not investing any time into staining, sanding, painting... Because I will likely never see the backside again.</p> <p>Also- not pictured was the wedge in the middle.</p> <p>Its just a piece of scrap wood, which I cut and sanded a point into.</p> <p>I didn't pre-drill the hole, causing it to split. Its non-load bearing. It will be fine.</p> <p>The wood is cut at an angle, with a small wedge to align the center. The loose piece, will nail/bolt to the wall.</p> <p></p> <p>When closed, it makes a perfectly tight and secure connection, with no wobbles at all.</p> <p></p> <p>Another angle, with better lighting.</p> <p>Info</p> <p>Ignore... the red cable mounts on the right.</p> <p>Remember- the limited space mentioned earlier? Well- There wasn't enough room for these.</p> <p>The following image was taken during a test-fit, to ensure everything fitted into the space as expected.</p> <p>This picture was taken further along in the project. Ignore, the white paint, and the bolts at the bottom... for now. thats part 2.</p> <p>Weather stripping was added which will help to avoid scratching the wall, and to reduce/prevent any potential noise.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#next-steps","title":"Next steps?","text":"<p>Part 1 of this post is specifically about building the frame.</p> <p>For Part 2, we will start mounting DIN rails, networking components, cable management, etc.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-1/#part-2","title":"Part 2","text":"","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/","title":"DIN Mount Network Closet - Part 2 - Final construction and cleanup","text":"<p>This is part two, of a three post series.</p> <ul> <li>Part 1, I built the wooden frame. </li> <li>Part 2, we will be turning the wooden frame into my networking panel.</li> <li>Part 3 will be mounting networking components, and wire management.</li> </ul> <p>In case you missed part 1, here was the end result:</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#step-1-planning","title":"Step 1. Planning","text":"<p>A while back, I made this reddit post which demonstrated a pretty... ugly layout in Microsoft paint.</p> <p>While- apparently may felt this was a joke, and it was not very well received- it was indeed.... the actual plan.</p> <p>For context- here is the image I posted:</p> <p></p> <p>Well- in this post- I am going to make the ugly drawing a reality.</p> <p>But first...</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#step-2-paint","title":"Step 2. Paint","text":"<p>I am going to make it look a bit better.</p> <p>I will start with... some stain and poly, along with some white paint for the trim.</p> <p></p> <p>That, helped quite a bit.</p> <p></p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#step-3-layout","title":"Step 3. Layout","text":"<p>Here is where we get to the interesting part. Doing mock, and layout.</p> <p>I started with DIN Rails, a old EdgeRouter, and a small plastic container the same size as my Unifi USW-8s.</p> <p>The goal here, was to get a feel for how much room I had to work with.</p> <p></p> <p>Next- I wanted to include a patch panel. So- I slapped it on there to get started.</p> <p></p> <p>After playing with it a bit- I was convinced it would need to be mounted perpendicular to the frame, as I was not happy flush mounting it.</p> <p>So... I needed to build a 1U mount.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#building-1u-mount","title":"Building 1U mount","text":"<p>Looking at my material options, I had steel, and I had wood.</p> <p></p> <p>Steel, seemed like the best option. So- I started bending steel.</p> <p>A simple hammer and vise was the only thing needed here.</p> <p></p> <p>Checking fitment.</p> <p></p> <p>After cutting.</p> <p></p> <p>Now... I just needed to make a 2nd one.</p> <p>A few minutes later.... We have a 2nd one.</p> <p></p> <p>I did leverage my anvil to help shape these a bit more.</p> <p></p> <p>And... a bit more tweaking in the vise.</p> <p></p> <p>I wanted both of these to be nearly identical.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#drilling-holes","title":"Drilling Holes","text":"<p>Warning</p> <p>I made a pretty big mistake in this section.</p> <p>I decided to leave it. See.... if you can spot it.</p> <p>After tracing the holes, I went over to the drill press, and used a 2x4 to keep everything positioned while clamping.</p> <p></p> <p>I used a step bit, my sliding vise, and some cutting oil.</p> <p></p> <p>After drilling the holes, I used a chamfering bit to chamfer the holes.</p> <p></p> <p>Finally- I did a quick mock-up.</p> <p></p> <p>(Random note- the black thing in the background is a ESP-controlled 3 head flamethrower)</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#finishing-brackets","title":"Finishing Brackets","text":"<p>With- the brackets looking promising, I just needed to do some cleanup now.</p> <p>I started with tracing out around the patch panel.</p> <p></p> <p>Next, I took a rough cut using a die-grinder with a cut-off wheel.</p> <p></p> <p>And, finally finished these up using flap disks and a angle grinder.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#patch-panel-mounted","title":"Patch Panel Mounted","text":"<p>To mount to the frame, I decided to use some 5/8\" bolts.</p> <p>Complete overkill, but, I have quite a few of these.</p> <p></p> <p>Question</p> <p>Remember, earlier when I said I messed up on something?</p> <p>Have- you spotted it yet?</p> <p>Bracket and patch panel mounted.</p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#layout-finished","title":"Layout Finished","text":"<p>Ok, with the patch panel mounted, I can continue layout.</p> <p>And... its done. (Suppose- I did not take any pictures during this portion)</p> <p></p> <p></p> <p></p>","tags":["Homelab","Networking"]},{"location":"blog/2025/din-mount-closet-part-2/#step-4-mounting","title":"Step 4. Mounting","text":"<p>Well, first is first, need to clear a spot to hang this.</p> <p></p> <p>This is going to be a tight fit.</p> <p></p> <p>After validating it will fit, I took some measurements and installed the back-half of the \"wedge mount\"</p> <p></p> <p>And, then I just slid the \"shelf\" onto the mount. It locked securely into place without issue.</p> <p></p> <p>Thats, honestly it for this section. The only remaining item is to start mounting networking hardware.</p> <p>In Part 3, all of the networking components will be mounted and this project will be completed.</p>","tags":["Homelab","Networking"]},{"location":"blog/2025/mikrotik-outbound-wireguard/","title":"Mikrotik - Route specific websites or hosts through VPN.","text":"<p>This post outlines how to accomplish the following activities:</p> <ol> <li>Creating an interface for a remote wireguard VPN connection to an upstream VPN provider.</li> <li>Forcing specific websites over VPN via Destination IP or DNS.</li> <li>Forcing specific hosts over VPN via Source IP.</li> <li>Route ALL traffic over VPN.</li> <li>Blocking traffic if VPN is down.</li> </ol>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#get-configuration-from-vpn-provider","title":"Get configuration from VPN Provider","text":"<p>Your upstream VPN provider will give you a configuration which resembles this:</p> <pre><code>[Interface]\nPrivateKey = gMe7NtkQJdnxeFc5jmdke+CNY45Y/aN1ugLpiMF9X3g=\nAddress = 10.2.0.2/32\nDNS = 10.2.0.1\n\n[Peer]\nPublicKey = PsLFVA2NRBa0P8zXiwHN8LqD11e3weemHoduXs8XBns=\nAllowedIPs = 0.0.0.0/0\nEndpoint = 1.20.30.40:51820\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#configure-vpn-interface-routingfirewall-rules-etc","title":"Configure VPN Interface, Routing/Firewall rules, etc.","text":"<p>Here is the full script to automatically provision the VPN connection, and create the proper interfaces, lists, peers, routing-tables, and NAT.</p> <p>Details will be given below in this post.</p> <p>This will NOT route any traffic over the VPN. Those steps will be provided later in this post.</p> <p>Warning</p> <p>You will need to modify the variables at the top of the script.</p> <pre><code>### These variables MUST be changed\n\n## Set Peer Endpoint\n# Set the peer's endpoint here. (Under [peer] section of config)\n# Remove the port!\n\n: global peerEndpointIP 1.20.30.40\n# Set the peer's port here (The port from [Peer].Endpoint)\n: global peerEndpointPort 51820\n\n## Set Public/Private Keys\n# Put your peer's public key here. (Under [peer] section of config)\n: global peerPublicKey \"PsLFVA2NRBa0P8zXiwHN8LqD11e3weemHoduXs8XBns=\"\n# Put your private key here. (Under [interface] section of config)\n: global myPrivateKey \"gMe7NtkQJdnxeFc5jmdke+CNY45Y/aN1ugLpiMF9X3g=\"\n\n## Set Local IPs\n# This is the IP address from the [Interface] section of the configuration from our provider.\n: global myLocalIP 10.2.0.2\n# This is the local IP address from the Peer. It is not listed in the configuration I received- however, \n# We can assume is is a /30 subnet, which leaves... 10.2.0.1. Also- this matches the DNS received in the upstream configuration.\n: global peerLocalIP 10.2.0.1\n\n### These variables can optionally be changed, if needed.\n# Set a name for the interface\n: global vpnInterfaceName \"WG-VPN-OUT\"\n# Set a name for the interface list which will contain \"outbound\" VPNs\n: global vpnInterfaceListName \"Outbound_VPN\"\n# Set local port. (Only need to change if it is already in use by another connection)\n: global vpnLocalPort 22580\n# Name of the new routing-table which will be used to force clients over VPN connections\n: global vpnRoutingTableName \"force-vpn\"\n# Name of the firewall chain which will be used for VPN traffic\n: global vpnFirewallChainNameIn \"OUTBOUND_VPN-IN\"\n\n### Below here, creates the correct configurations.\n\n## Create Interface\n\n# Create interface\n/interface/wireguard/add listen-port=$vpnLocalPort mtu=1420 name=$vpnInterfaceName private-key=$myPrivateKey\n\n# Create the peer\n/interface/wireguard/peers/add allowed-address=0.0.0.0/0 comment=$vpnInterfaceName endpoint-address=$peerEndpointIP endpoint-port=$peerEndpointPort interface=$vpnInterfaceName public-key=$peerPublicKey\n\n# Create Interface List\n/interface/list/add comment=\"Outbound VPN Interfaces\" name=$vpnInterfaceListName\n\n# Add VPN Interface to list\n/interface/list/member/add comment=\"Remote VPN Peer\" interface=$vpnInterfaceName list=$vpnInterfaceListName\n\n# Create IP Address\n/ip/address/add address=\"$myLocalIP/30\" comment=$vpnInterfaceName interface=$vpnInterfaceName network=$myLocalIP\n\n# Create Routing Table. This will force the specified clients to route over the VPN.\n/routing/table/add disabled=no name=$vpnRoutingTableName fib\n\n# Create Routes to force traffic over VPN.\n/ip/route/add check-gateway=ping comment=\"Use VPN\" disabled=no distance=1 dst-address=0.0.0.0/0 gateway=$peerLocalIP routing-table=$vpnRoutingTableName scope=30 suppress-hw-offload=no target-scope=10\n\n# This create a blackhole route, which will drop outbound traffic if the VPN connection is down.\n/ip/route/add blackhole comment=\"Drop traffic if VPN is down\" disabled=no distance=32 dst-address=0.0.0.0/0 gateway=\"\" routing-table=$vpnRoutingTableName scope=30 suppress-hw-offload=no\n\n# Create outbound NAT rule to masquerade traffic going over VPN.\n/ip/firewall/nat/add action=masquerade chain=srcnat comment=\"VPN Masquerade\" out-interface-list=$vpnInterfaceListName\n\n# Create Firewall Rules. Only allow established connections. Drop everything else.\n/ip/firewall/filter\nadd chain=input                 action=jump                     comment=\"Chain: $vpnFirewallChainNameIn\" in-interface-list=$vpnInterfaceListName jump-target=$vpnFirewallChainNameIn\nadd chain=$vpnFirewallChainNameIn    action=fasttrack-connection     comment=\"Fasttrack: Related, Established\" connection-state=established,related hw-offload=yes\nadd chain=$vpnFirewallChainNameIn    action=accept                   comment=\"Accept: Established, Related, Untracked\" connection-state=established,related,untracked\nadd chain=$vpnFirewallChainNameIn    action=drop                     comment=\"Drop: State: Invalid\" connection-state=invalid\nadd chain=$vpnFirewallChainNameIn    action=drop                     comment=\"Drop All w/Log\" log=yes log-prefix=DROP\n\n# Create an address list containing the RFC1918 IPv4 subnet ranges. (Aka, Private IPv4 Ranges)\n/ip firewall address-list\nadd address=10.0.0.0/8 list=rfc1918\nadd address=172.16.0.0/12 list=rfc1918\nadd address=192.168.0.0/16 list=rfc1918\n\n# Create mangle rules, which will force the specific traffic to use the VPN-Only Routing Table\n/ip firewall mangle\n# This rule forces traffic via VPN for source IP address. Aka- force local hosts to use VPN\nadd action=mark-routing chain=prerouting comment=\"Force VPN for Source Address\"      dst-address-list=!rfc1918      new-routing-mark=$vpnRoutingTableName src-address-list=Force_SRC_VPN\n# This rule forces traffic via VPN for destination IP addresses. Aka, Specific hosts on the WAN, or specific websites.\nadd action=mark-routing chain=prerouting comment=\"Force VPN for Destination Address\" dst-address-list=Force_DST_VPN new-routing-mark=$vpnRoutingTableName\n</code></pre> <p>Note</p> <p>The above keys were randomly generated.... they don't work anywhere. Don't bother trying...</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#more-details","title":"More Details","text":"<p>This section will break the above script into smaller pieces, and provide brief explanations</p> <p>I don't believe any further details are needed for setting the variables.</p> <p>The purpose of the variables, is to remove the need for you to update multiple items in the configuration.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#create-interface","title":"Create Interface","text":"<p>This creates a new wireguard interface, and associates the private key from the upstream configuration.</p> <pre><code>## Create Interface\n\n# Create interface\n/interface/wireguard/add listen-port=$vpnLocalPort mtu=1420 name=$vpnInterfaceName private-key=$myPrivateKey\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#create-the-peer","title":"Create the peer","text":"<p>This will create the remote peer. By specifying the endpoint here, the router will automatically connect to the endpoint and maintain a connection.</p> <pre><code>/interface/wireguard/peers/add allowed-address=0.0.0.0/0 comment=$vpnInterfaceName endpoint-address=$peerEndpointIP endpoint-port=$peerEndpointPort interface=$vpnInterfaceName public-key=$peerPublicKey\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#create-interface-list","title":"Create Interface List","text":"<p>To simplify other configurations, I am leveraging an interface list. </p> <p>If- for example you had multiple outbound VPN connections to various providers, you could just add the interfaces to this list, which will automatically apply the same firewall rules.</p> <pre><code>/interface/list/add comment=\"Outbound VPN Interfaces\" name=$vpnInterfaceListName\n</code></pre> <p>Then- we add the VPN interface to the newly created list.</p> <pre><code>/interface/list/member/add comment=\"Remote VPN Peer\" interface=$vpnInterfaceName list=$vpnInterfaceListName\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#create-ip-address","title":"Create IP Address","text":"<p>We need to provision an IP address to allow routing to work.</p> <p>This line provisions our local IP address, for the VPN interface.</p> <pre><code>/ip/address/add address=\"$myLocalIP/30\" comment=$vpnInterfaceName interface=$vpnInterfaceName network=$myLocalIP\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#create-routing-table-this-will-force-the-specified-clients-to-route-over-the-vpn","title":"Create Routing Table. This will force the specified clients to route over the VPN.","text":"<p>The easiest way for us to route traffic over the VPN, is literally by routing the traffic over the VPN.</p> <p>To do this- we will first create a routing table. This- will not be used by anything \"yet\"</p> <pre><code>/routing/table/add disabled=no name=$vpnRoutingTableName fib\n</code></pre> <p>Next- we create the default route, which tells all traffic to route through the remote peer.</p> <p><code>check-gateway=ping</code> is configured here, which will mark the route as inactive if we are unable to ping the remote host. (aka, the connection is down.)</p> <p>The distance here is set to 1, which will make this the preferred route.</p> <p><pre><code>/ip/route/add check-gateway=ping comment=\"Use VPN\" disabled=no distance=1 dst-address=0.0.0.0/0 gateway=$peerLocalIP routing-table=$vpnRoutingTableName scope=30 suppress-hw-offload=no target-scope=10\n</code></pre> Afterwards, A blackhole route is created with a higher distance then the default route.</p> <p>When- the primary default route is marked as inactive due to the remote host being unreachable, this will become the default route.</p> <p>This will \"blackhole\" the traffic. Ie- it gets dropped.</p> <pre><code>/ip/route/add blackhole comment=\"Drop traffic if VPN is down\" disabled=no distance=32 dst-address=0.0.0.0/0 gateway=\"\" routing-table=$vpnRoutingTableName scope=30 suppress-hw-offload=no\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#outbound-nat","title":"Outbound NAT","text":"<p>While- most VPN providers do handle NAT on their end, I still prefer to do NAT on my side.</p> <p>One reason being- I don't want the remote VPN provider to know anything about my internal IP structures. I also don't want the remote provider to be able to easily distinguish my internal clients based on their IP addresses.</p> <p>So- I NAT outbound traffic going through any of the interfaces in the newly created interface list.</p> <pre><code>/ip/firewall/nat/add action=masquerade chain=srcnat comment=\"VPN Masquerade\" out-interface-list=$vpnInterfaceListName\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#firewall-rules","title":"Firewall Rules","text":"<p>Since- I have quite a few firewall rules, I prefer to use chains to organize rules together. For this example, I am storing all of the rules for the outbound VPN interfaces into a new chain.</p> <pre><code>/ip firewall filter\n\n# When traffic comes into any of the interfaces on the outbound VPN interface list, we will jump to the \"VPN-IN Chain\"\nadd chain=input                 action=jump                     comment=\"Chain: $vpnFirewallChainNameIn\" in-interface-list=$vpnInterfaceListName jump-target=$vpnFirewallChainNameIn\n\n## The below rules are only applied against traffic matched by the above jump rule.\n\n# For any hardware-offloaded established connections, fast-track.\nadd chain=$vpnFirewallChainNameIn    action=fasttrack-connection     comment=\"Fasttrack: Related, Established\" connection-state=established,related hw-offload=yes\n\n# Allow established, related sessions.\nadd chain=$vpnFirewallChainNameIn    action=accept                   comment=\"Accept: Established, Related, Untracked\" connection-state=established,related,untracked\n\n# Drop invalid packets.\nadd chain=$vpnFirewallChainNameIn    action=drop                     comment=\"Drop: State: Invalid\" connection-state=invalid\n\n# Drop... ALL packets.\n# This- will drop any inbound packets, which are not apart of an active, established session.\nadd chain=$vpnFirewallChainNameIn    action=drop                     comment=\"Drop All w/Log\" log=yes log-prefix=DROP\n</code></pre>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#selectively-route-traffic-through-vpn","title":"Selectively route traffic through VPN","text":"<p>Depending on how you wish to leverage this, I have provided a few options below on how to either force all traffic over the VPN, or how to selectively choose traffic.</p> <p>This is more or less a modified version of the routes added by the earlier script, which only targets the main routing table, rather then the VPN-only table.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#route-all-traffic-through-vpn","title":"Route ALL Traffic through VPN.","text":"<p>If, you want to force all traffic through VPN, this can be achieved a few different ways.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#via-default-route-on-main-routing-table","title":"Via default route on main routing table","text":"<p>You can... add a default route, which sends all traffic through the VPN interface.</p> <p><code>/ip/route/add check-gateway=ping comment=\"Use VPN\" disabled=no distance=1 dst-address=0.0.0.0/0 gateway=$peerLocalIP routing-table=main scope=30 suppress-hw-offload=no target-scope=10</code></p> <p>But, you need to make sure to add a route to ensure the VPN connection itself, is routed out the standard gateway.... Otherwise, the VPN connection won't work.</p> <p>Note- you will need to add your own gateway / interface here.</p> <p><code>/ip/route/add comment=\"Route VPN over WAN\" disabled=no distance=1 dst-address=$peerEndpointIP gateway=10.100.5.1 routing-table=main scope=30 suppress-hw-offload=no target-scope=10</code></p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#via-mangle-rules","title":"Via mangle rules","text":"<p>A simple mangle rule will route all outbound traffic through the forced-VPN routing table created by the original script.</p> <p><code>/ip/firewall/mangle/add action=mark-routing chain=prerouting comment=\"Force VPN\" dst-address-list=!rfc1918 new-routing-mark=$vpnRoutingTableName</code></p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#via-routing-rules","title":"Via routing rules","text":"<p>You can leverage routing rules to also do the above. However, routing rules cannot reference interface lists, firewall address lists, etc. As such, I would prefer using the above two examples.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#route-specific-hosts-through-vpn-by-source-ipmask","title":"Route Specific Hosts through VPN (By Source IP/Mask)","text":"<p>To force specific hosts to route all traffic through VPN, we will use a simple pre-routing rule.</p> <p>Info</p> <p>Note- you will need to customize the addresses for this list.</p> <pre><code>/ip firewall address-list\n# Add clients to be forced through the outbound VPN.\nadd address=192.168.1.8  comment=\"IP Addresses in this list will only be allowed to access the internet via VPN.\" list=Force_SRC_VPN\nadd address=192.168.1.16 comment=\"IP Addresses in this list will only be allowed to access the internet via VPN.\" list=Force_SRC_VPN\n</code></pre> <p>After the lists has been created, Add a mangle rule to force clients to use the new routing table created earlier, but only for traffic WAN-bound.</p> <p>Info</p> <p>This uses the $vpnRoutingTableName variable from the main script. This also uses the rfc1918 address-list created in the initial script.</p> <p>This mangle rule is created by the main script as well.</p> <pre><code>/ip firewall mangle\nadd action=mark-routing chain=prerouting comment=\"Force VPN for Source Address\" dst-address-list=!rfc1918 new-routing-mark=$vpnRoutingTableName src-address-list=Force_SRC_VPN\n</code></pre> <p>Thats it. Any hosts in the <code>Force_SRC_VPN</code> address-list will now be forced to be routed over the VPN connection.</p> <p>If the VPN connection is down, the traffic will instead be dropped via the routing blackhole.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#route-specific-websites-through-vpn-by-dns","title":"Route Specific Websites through VPN (By DNS)","text":"<p>This example shows how to force specific websites to be forced over the VPN connection.</p> <p>This can be used to selectively route certain websites which may have geopolitical restrictions.</p> <p>First- we will need to setup a reusable script which will be used to populate address lists based on DNS lookups.</p> <p>Note</p> <p>I did not create this script! But- in my testing, it does work.</p> <p>Original Source</p> <pre><code>/system script\nadd comment=\"Adds specified DNS Domains to an address list\" dont-require-permissions=no name=DNSToAddressList owner=admin policy=read,write source=\":global ListName\\\n    \\n:global Servers\\\n    \\n:global Done\\\n    \\n\\\n    \\n#has \\$Done been initialized\\?\\\n    \\n:if ([:typeof \\$Done] != \\\"boolean\\\") do={\\\n    \\n  :set Done true;\\\n    \\n}\\\n    \\n\\\n    \\n#make sure previous runs have finished\\\n    \\nwhile (!\\$Done) do={\\\n    \\n  :nothing;\\\n    \\n}\\\n    \\n\\\n    \\n#block any other runs\\\n    \\n:set Done false;\\\n    \\n\\\n    \\n#delete old address lists\\\n    \\n:foreach aListItem in=[/ip firewall address-list find list=\\$ListName] do={\\\n    \\n  /ip firewall address-list remove \\$aListItem;\\\n    \\n}\\\n    \\n\\\n    \\n:foreach aServer in=\\$Servers do={\\\n    \\n#force the dns entries to be cached\\\n    \\n  :resolve \\$aServer;\\\n    \\n\\\n    \\n  :foreach dnsRecord in=[/ip dns cache all find where (name=\\$aServer)] do={\\\n    \\n#if it's an A records add it directly\\\n    \\n    :if ([/ip dns cache all get \\$dnsRecord type]=\\\"A\\\") do={\\\n    \\n       /ip firewall address-list add list=\\$ListName address=[/ip dns cache all get \\$dnsRecord data] comment=\\$aServer;\\\n    \\n    }\\\n    \\n\\\n    \\n#if it's a CNAME follow it until we get A records\\\n    \\n    :if ([/ip dns cache all get \\$dnsRecord type]=\\\"CNAME\\\") do={\\\n    \\n      :local cname;\\\n    \\n      :local nextCname\\\n    \\n      :set cname [/ip dns cache all find where (name=\\$aServer &amp;&amp; type=\\\"CNAME\\\")];\\\n    \\n      :set nextCname [/ip dns cache all find where (name=[/ip dns cache all get \\$cname data] &amp;&amp; type=\\\"CNAME\\\")];\\\n    \\n\\\n    \\n      :while (\\$nextCname != \\\"\\\") do={\\\n    \\n          :set cname \\$nextCname;\\\n    \\n          :set nextCname [/ip dns cache all find where (name=[/ip dns cache all get \\$cname data] &amp;&amp; type=\\\"CNAME\\\")];\\\n    \\n        }\\\n    \\n  \\\n    \\n#add the a records we found\\\n    \\n    :foreach aRecord in=[/ip dns cache all find where (name=[/ip dns cache all get \\$cname data] &amp;&amp; type=\\\"A\\\")] do={\\\n    \\n      /ip firewall address-list add list=\\$ListName address=[/ip dns cache all get \\$aRecord data] comment=\\$aServer;\\\n    \\n      }\\\n    \\n    }\\\n    \\n  }\\\n    \\n}\\\n    \\n\\\n    \\n#allow other scripts to call this\\\n    \\n:set Done true\"\n</code></pre> <p>Next, we will create a schedule which will automatically execute on an interval to populate our IP Address Lists, for a given list of domains.</p> <p>This script will populate the target list with the DNS to IP lookups from the script itself. Customize the host names as needed. Multiple dns addresses can be added.</p> <p>I set the interval to run every hour, however, you can customize as needed.</p> <pre><code>/system scheduler\nadd comment=\"This executes the script which populates Force_DST_VPN address list\" interval=1h name=UpdateForcedVPNList on-event=\":global ListName Force_VPN\\\n    \\n:global Servers {\\\"yourwebsite.com\\\";\\\"www.yourwebiste.com\\\";\\\"anotherwebsite.com\\\"}\\\n    \\n/system script run DNSToAddressList\" policy=read,write,test start-time=startup\n</code></pre> <p>Now we need to create another mangle rule to force the specified traffic to use the VPN-Only routing table.</p> <p>Info</p> <p>This uses the $vpnRoutingTableName variable from the main script.</p> <p>This mangle rule is created by the main script as well.</p> <pre><code>/ip firewall mangle\nadd action=mark-routing chain=prerouting comment=\"Force VPN for Destination Address\" dst-address-list=Force_DST_VPN new-routing-mark=$vpnRoutingTableName\n</code></pre> <p>Thats... basically it.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#testing-destination-wan","title":"Testing destination WAN.","text":"<p>Using, a very well-known website with geopolitical restrictions, I added only the primary domain to an address list, and performed testing.</p> <pre><code>ping wellknownwebsite.com\n\nPinging wellknownwebsite.com [66.254.114.41] with 32 bytes of data:\nReply from 66.254.114.41: bytes=32 time=143ms TTL=57\nReply from 66.254.114.41: bytes=32 time=142ms TTL=57\n\nping www.wellknownwebsite.com\n\nPinging wellknownwebsite.com [66.254.114.41] with 32 bytes of data:\nReply from 66.254.114.41: bytes=32 time=146ms TTL=57\nReply from 66.254.114.41: bytes=32 time=142ms TTL=57\nReply from 66.254.114.41: bytes=32 time=143ms TTL=57\n\n## Testing.... with an alternative domain to said website\n\nping wellknownpremiumwebsite.com\n\nPinging wellknownpremiumwebsite.com [66.254.114.0] with 32 bytes of data:\nReply from 66.254.114.0: bytes=32 time=10ms TTL=55\nReply from 66.254.114.0: bytes=32 time=10ms TTL=55\nReply from 66.254.114.0: bytes=32 time=10ms TTL=55\n</code></pre> <p>In the first two examples the traffic is being routed out of a common european country, which is a very popular place for hosted VPNs.</p> <p>In the bottom example, the \"premium\" website was not added to the IP Address list. Notice the much shorter response times.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"blog/2025/mikrotik-outbound-wireguard/#summary","title":"Summary","text":"<p>This post was just intended to centralize documentation and methods for forcing traffic over a VPN connection.</p> <p>You should now be able to force traffic over VPN by both Source IP (your internal IP), Destination IP, and Destination DNS.</p> <p>This was not intended to be the end-all guide to Mikrotik VPN, only a short reference for forcing specific traffic over VPN connections.</p> <p>Here are a few of the various references I used to build these configurations:</p> <ul> <li>https://help.mikrotik.com/docs/spaces/ROS/pages/69664792/WireGuard</li> <li>https://help.mikrotik.com/docs/spaces/ROS/pages/47579229/Scripting#Scripting-Variables</li> <li>https://help.mikrotik.com/docs/spaces/ROS/pages/48660587/Mangle</li> <li>https://protonvpn.com/support/wireguard-mikrotik-routers/</li> <li>https://superuser.com/questions/999196/mikrotik-and-vpn-for-specific-web-sites-only</li> </ul> <p>The script created above was tested on a fresh Mikrotik RouterOS VM, and was confirmed to function as expected.</p> <p>There are MANY other ways of accomplishing the task of selective routing.... A few examples...</p> <ol> <li>Using dynamic routing protocols</li> <li>More in-depth routing rules.</li> <li>Using HTTP Proxy w/FW Rules</li> <li>Using Socks Proxy w/FW Rules.</li> <li>Using layer 7 firewall matchers (You- don't want to do this)</li> </ol> <p>However, I do feel- the steps above should give you a good start.</p>","tags":["Homelab","Networking","Networking/Mikrotik","Networking/VPN","Networking/VPN/WireGuard"]},{"location":"pages/disclaimers/","title":"Disclaimers / FAQs / etc","text":"<p>This page is used to store disclaimers used throughout this website.</p>"},{"location":"pages/disclaimers/#affiliate-links","title":"Affiliate Links","text":"<p>Occassionally, posts may include a warning such as this:</p> <p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p> <p>This means, I am leveraging affiliate links for my content. An affiliate link, does not alter or change the price you pay at all. However, if you purchase the products using my affiliate links, I will receive a very small percentage. This helps to support this site.</p> <p>As you may or may not have noticed- There are no ads. As such, affiliate links are currently the only method I have to recoup some of the hosting costs, and costs to purchase hardware to review and test. So- if you like my content, and would like to see more... those links are the only method of supporting me.</p>"},{"location":"pages/disclaimers/#donations","title":"Donations","text":"<p>I do NOT accept donations or payments. The only method offered for which you can financially support this site, is via purchasing through affiliate links. </p>"},{"location":"pages/disclaimers/#sponsored-content","title":"Sponsored Content","text":"<p>I DO accept requests for sponsored content. </p> <p>I cannot, and will not promise to shed the sponsored product in a positive light. </p> <p>I CAN promise, I will provide my unbiased opinions and feedback for any product for which I sponsor. </p> <p>As well, I will only evaluate sponsored products meeting the purpose of this site. ie- It must belong to one of these categories:</p> <ol> <li>Computers / Technology<ul> <li>Automation</li> <li>Software development</li> <li>Networking</li> <li>Gaming</li> <li>Most general technology-related subjects fitting the form/feel of this site.</li> </ul> </li> <li>Home/Solar<ul> <li>\"Smart\" products for the home.</li> <li>Mini-split units are included</li> <li>Solar-related products<ul> <li>Batteries</li> <li>Inverters</li> <li>Panels</li> <li>etc.</li> </ul> </li> </ul> </li> <li>Automotive Performance<ul> <li>Holley EFI</li> <li>Turbochargers</li> <li>Performance or electrical parts in general.</li> </ul> </li> </ol> <p>If, you are interesting in discussing a sponsorship, I can be reached via <code>admin</code>@<code>xtremeownage.com</code></p>"},{"location":"pages/tags/","title":"Tags","text":""},{"location":"pages/tags/#tag:433mhz","title":"433mhz","text":"<ul> <li>            433mhz Automation          </li> </ul>"},{"location":"pages/tags/#tag:alarm","title":"Alarm","text":"<ul> <li>            Embedded Door Sensors          </li> <li>            Home Assistant Alarm          </li> </ul>"},{"location":"pages/tags/#tag:backups","title":"Backups","text":"<ul> <li>            Backup Strategies          </li> </ul>"},{"location":"pages/tags/#tag:ceph","title":"Ceph","text":"<ul> <li>            Proxmox - Building a ceph cluster          </li> </ul>"},{"location":"pages/tags/#tag:development","title":"Development","text":"<ul> <li>            An anonymous request was received in between authentication handshake requests          </li> <li>            C# - Get Display Attribute Value from Enum          </li> <li>            Git - Delete Merged Branches          </li> <li>            Gitea - Slow Dashboard          </li> <li>            MicrosoftIdentityWebChallengeUserException          </li> <li>            Office Links Broken          </li> <li>            Parsing SCCM Collections          </li> <li>            Searching Splunk From Browser Bar          </li> <li>            TFS / Azure Devops - Semantic Versioning          </li> <li>            Unknown error (0x80005000) \u2013 Getting AD Group Members          </li> <li>            c# \u2013 Logging Directly to Splunk          </li> <li> </li> <li> </li> <li> </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:development/net","title":"Development/.NET","text":"<ul> <li>            An anonymous request was received in between authentication handshake requests          </li> <li>            Office Links Broken          </li> <li>            Unknown error (0x80005000) \u2013 Getting AD Group Members          </li> </ul>"},{"location":"pages/tags/#tag:development/c","title":"Development/C#","text":"<ul> <li>            An anonymous request was received in between authentication handshake requests          </li> <li>            C# - Get Display Attribute Value from Enum          </li> <li>            MicrosoftIdentityWebChallengeUserException          </li> <li>            Office Links Broken          </li> <li>            Parsing SCCM Collections          </li> <li>            TFS / Azure Devops - Semantic Versioning          </li> <li>            Unknown error (0x80005000) \u2013 Getting AD Group Members          </li> <li>            c# \u2013 Logging Directly to Splunk          </li> </ul>"},{"location":"pages/tags/#tag:development/git","title":"Development/Git","text":"<ul> <li>            Git - Delete Merged Branches          </li> </ul>"},{"location":"pages/tags/#tag:development/gitea","title":"Development/Gitea","text":"<ul> <li>            Gitea - Slow Dashboard          </li> </ul>"},{"location":"pages/tags/#tag:esphome","title":"ESPHome","text":"<ul> <li>            2023 Prime Day Deals          </li> <li>            ESPHome on critical infrastructure          </li> <li>            Feline Area Denial Device          </li> <li>            Hacking KVM with IP Control          </li> <li>            Pioneer Mini-split ESPHome          </li> <li>            Sonoff S31 - Low Cost Energy Monitoring          </li> </ul>"},{"location":"pages/tags/#tag:energy-monitoring","title":"Energy Monitoring","text":"<ul> <li>            2023 Home Assistant - Energy Monitoring          </li> <li>            2023 Prime Day Deals          </li> <li>            Home Assistant - Energy Flow Diagram          </li> <li>            Home Solar Project - Part 3 - Monitoring          </li> <li>            Kasa powerstrip as PDU          </li> <li>            Sonoff S31 - Low Cost Energy Monitoring          </li> </ul>"},{"location":"pages/tags/#tag:hvac","title":"HVAC","text":"<ul> <li>            Fireplace Automation - Part 3          </li> <li>            Full local Z-Wave HVAC Control          </li> <li>            Off grid AC          </li> <li>            Pioneer Mini-split ESPHome          </li> <li>            Programmable Thermostat GUI          </li> </ul>"},{"location":"pages/tags/#tag:home-assistant","title":"Home Assistant","text":"<ul> <li>            2023 Prime Day Deals          </li> <li>            Automated Holiday Lighting          </li> <li>            ESPHome on critical infrastructure          </li> <li>            Feline Area Denial Device          </li> <li>            Fireplace Automation - Part 3          </li> <li>            Full local Z-Wave HVAC Control          </li> <li>            Hacking KVM with IP Control          </li> <li>            Home Assistant - Energy Flow Diagram          </li> <li>            Home Assistant - Split Sensor          </li> <li>            Pioneer Mini-split ESPHome          </li> <li>            Programmable Thermostat GUI          </li> <li>            Proxmox - Coral TPU USB Passthrough          </li> <li>            Proxmox - Install HAOS          </li> <li>            Sonoff S31 - Low Cost Energy Monitoring          </li> </ul>"},{"location":"pages/tags/#tag:home-improvement","title":"Home Improvement","text":"<ul> <li>            Bathroom Floor Replacement          </li> </ul>"},{"location":"pages/tags/#tag:home-automation","title":"Home-Automation","text":"<ul> <li>            Solar-Assistant with Solark 12k          </li> </ul>"},{"location":"pages/tags/#tag:homelab","title":"Homelab","text":"<ul> <li>            10/40G Home Network Upgrade          </li> <li>            2023 Network Revamp, and Homelab History          </li> <li>            2024 10G Or Faster          </li> <li>            2024 Homelab status          </li> <li>            2024 Network Revamp          </li> <li>            40Gb Ethernet Cost and Benchmarks          </li> <li>            Adding more NVMe to my r730XD          </li> <li>            Backup Strategies          </li> <li>            Balancing Power Consumption and Cost: The True Price of Efficiency          </li> <li>            ConnectX-3 Configuration          </li> <li>            ConnectX-3 Set Port Mode to ETH/IB          </li> <li>            DIN Mount Closet Part 1          </li> <li>            DIN Mount Closet Part 2          </li> <li>            Death of my PowerEdge r720XD          </li> <li>            Detecting a packetloss / latency issue          </li> <li>            ESPHome on critical infrastructure          </li> <li>            Edgemax - Git Backups          </li> <li>            Hacking KVM with IP Control          </li> <li>            Kasa powerstrip as PDU          </li> <li>            Kubernetes - Edit Files in Containers          </li> <li>            Link speed versus Power Consumption          </li> <li>            Mellanox Configuration Guide          </li> <li>            Metered, Switch PDU          </li> <li>            Migrate from Virtualbox to Proxmox          </li> <li>            Mikrotik Outbound Wireguard          </li> <li>            My history with Unraid          </li> <li>            Network Performance Troubleshooting          </li> <li>            Proxmox - Add Disk to Existing Thin Provisioned LVM          </li> <li>            Proxmox - Building a ceph cluster          </li> <li>            Proxmox - Coral TPU USB Passthrough          </li> <li>            Proxmox - Debian Cloud Init Templates          </li> <li>            Proxmox - Delete pve/data pool          </li> <li>            Proxmox - Import OVA          </li> <li>            Proxmox - Install HAOS          </li> <li>            Proxmox - Random Error Fixes          </li> <li>            Proxmox - Reinstall host without losing cluster configuration          </li> <li>            R720XD Bifurcation          </li> <li>            Rack Em Up          </li> <li>            Rancher / K3s. How to upgrade          </li> <li>            Reattaching NVMe from VFIO          </li> <li>            Removing Stripe from ZFS Pool          </li> <li>            Static Site          </li> <li>            Surge Protection          </li> <li>            Synology Multipath          </li> <li>            Transitioning to Kubernetes          </li> <li>            TrueNAS Scale - Enable apt-get          </li> <li>            TrueNAS Scale - Use Vanilla Docker          </li> <li>            TrueNAS Scale - VM Cannot Access TrueNAS          </li> <li>            TrueNAS \u2013 iSCSI \u2013 GPT Protective partition          </li> <li>            Unifi - Debugging DDNS          </li> <li>            Using EMC Drives in other systems          </li> <li>            Windows 11 - Restore Context Menu          </li> <li> </li> <li> </li> <li> </li> <li> </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:homelab/efficiency","title":"Homelab/Efficiency","text":"<ul> <li>            Link speed versus Power Consumption          </li> </ul>"},{"location":"pages/tags/#tag:homelab/power","title":"Homelab/Power","text":"<ul> <li>            Metered, Switch PDU          </li> <li>            Surge Protection          </li> </ul>"},{"location":"pages/tags/#tag:homelab/truenas","title":"Homelab/TrueNAS","text":"<ul> <li>            My history with Unraid          </li> <li>            TrueNAS Scale - Use Vanilla Docker          </li> <li>            Unraid Vs TrueNAS SCALE 2021          </li> </ul>"},{"location":"pages/tags/#tag:homelab/unraid","title":"Homelab/Unraid","text":"<ul> <li>            My history with Unraid          </li> <li>            Unraid Vs TrueNAS SCALE 2021          </li> </ul>"},{"location":"pages/tags/#tag:homelab/windows","title":"Homelab/Windows","text":""},{"location":"pages/tags/#tag:homelab/windows/11","title":"Homelab/Windows/11","text":"<ul> <li>            Windows 11 - Restore Context Menu          </li> </ul>"},{"location":"pages/tags/#tag:kubernetes","title":"Kubernetes","text":"<ul> <li>            Kubernetes - Edit Files in Containers          </li> <li>            Rancher / K3s. How to upgrade          </li> <li>            Static Site          </li> <li>            Transitioning to Kubernetes          </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:kubernetes/general","title":"Kubernetes/General","text":"<ul> <li>            Kubernetes - Edit Files in Containers          </li> <li>            Rancher / K3s. How to upgrade          </li> </ul>"},{"location":"pages/tags/#tag:ntp","title":"NTP","text":"<ul> <li>            Reolink RLC-520 - Set Custom NTP          </li> </ul>"},{"location":"pages/tags/#tag:nvr","title":"NVR","text":"<ul> <li>            Proxmox - Coral TPU USB Passthrough          </li> <li>            Reolink RLC-520 - Set Custom NTP          </li> </ul>"},{"location":"pages/tags/#tag:networking","title":"Networking","text":"<ul> <li>            10/40G Home Network Upgrade          </li> <li>            2023 Network Revamp, and Homelab History          </li> <li>            2024 10G Or Faster          </li> <li>            40Gb Ethernet Cost and Benchmarks          </li> <li>            ConnectX-3 Configuration          </li> <li>            DIN Mount Closet Part 1          </li> <li>            DIN Mount Closet Part 2          </li> <li>            Detecting a packetloss / latency issue          </li> <li>            Edgemax - Git Backups          </li> <li>            Link speed versus Power Consumption          </li> <li>            Mellanox Configuration Guide          </li> <li>            Mikrotik Outbound Wireguard          </li> <li>            Network Performance Troubleshooting          </li> <li> </li> <li> </li> <li> </li> <li> </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:networking/edgemax","title":"Networking/Edgemax","text":"<ul> <li>            Edgemax - Git Backups          </li> </ul>"},{"location":"pages/tags/#tag:networking/mellanox","title":"Networking/Mellanox","text":"<ul> <li>            ConnectX-3 Configuration          </li> <li>            ConnectX-3 Set Port Mode to ETH/IB          </li> <li>            Mellanox Configuration Guide          </li> </ul>"},{"location":"pages/tags/#tag:networking/mikrotik","title":"Networking/Mikrotik","text":"<ul> <li>            2024 10G Or Faster          </li> <li>            2024 Network Revamp          </li> <li>            Mikrotik Outbound Wireguard          </li> </ul>"},{"location":"pages/tags/#tag:networking/unifi","title":"Networking/Unifi","text":"<ul> <li>            2024 10G Or Faster          </li> <li>            2024 Network Revamp          </li> <li>            Rant: Unifi Layer 3          </li> <li>            Unifi - Debugging DDNS          </li> </ul>"},{"location":"pages/tags/#tag:networking/vpn","title":"Networking/VPN","text":"<ul> <li>            Mikrotik Outbound Wireguard          </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:networking/vpn/wireguard","title":"Networking/VPN/WireGuard","text":"<ul> <li>            Mikrotik Outbound Wireguard          </li> </ul>"},{"location":"pages/tags/#tag:pc-builds","title":"PC Builds","text":"<ul> <li>            Adding more NVMe to my r730XD          </li> <li>            Death of my PowerEdge r720XD          </li> </ul>"},{"location":"pages/tags/#tag:proxmox","title":"Proxmox","text":"<ul> <li>            Backup Strategies          </li> <li>            Migrate from Virtualbox to Proxmox          </li> <li>            Proxmox - Add Disk to Existing Thin Provisioned LVM          </li> <li>            Proxmox - Building a ceph cluster          </li> <li>            Proxmox - Debian Cloud Init Templates          </li> <li>            Proxmox - Delete pve/data pool          </li> <li>            Proxmox - Import OVA          </li> <li>            Proxmox - Install HAOS          </li> <li>            Proxmox - Random Error Fixes          </li> <li>            Proxmox - Reinstall host without losing cluster configuration          </li> <li>            Reattaching NVMe from VFIO          </li> </ul>"},{"location":"pages/tags/#tag:review","title":"Review","text":"<ul> <li>            EG4 Rack Assembly          </li> <li>            Kasa powerstrip as PDU          </li> </ul>"},{"location":"pages/tags/#tag:reviews","title":"Reviews","text":"<ul> <li>            First Alert Z-Wave Combo CO/Smoke Detector          </li> </ul>"},{"location":"pages/tags/#tag:sccm","title":"SCCM","text":"<ul> <li>            Parsing SCCM Collections          </li> </ul>"},{"location":"pages/tags/#tag:service-now","title":"Service-Now","text":"<ul> <li>            Searching Splunk From Browser Bar          </li> </ul>"},{"location":"pages/tags/#tag:shop-talk","title":"Shop-Talk","text":"<ul> <li>            Building a Shop Table - Part 1          </li> <li>            Building a Shop Table - Part 2          </li> <li> </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:shop-talk/fabrication","title":"Shop-Talk/Fabrication","text":"<ul> <li>            Building a Shop Table - Part 1          </li> <li>            Building a Shop Table - Part 2          </li> </ul>"},{"location":"pages/tags/#tag:shop-talk/welding","title":"Shop-Talk/Welding","text":"<ul> <li>            Building a Shop Table - Part 1          </li> <li>            Building a Shop Table - Part 2          </li> </ul>"},{"location":"pages/tags/#tag:solar","title":"Solar","text":"<ul> <li>            EG4 Rack Assembly          </li> <li>            Home Solar Project - Next Steps          </li> <li>            Home Solar Project - Part 1 - Introduction          </li> <li>            Home Solar Project - Part 2 - Battery Selection          </li> <li>            Home Solar Project - Part 3 - Installation          </li> <li>            Home Solar Project - Part 3 - Monitoring          </li> <li>            Home Solar Project - Weather Disaster - Lessons Learned          </li> <li>            Off grid AC          </li> <li>            Solar-Assistant with Solark 12k          </li> </ul>"},{"location":"pages/tags/#tag:splunk","title":"Splunk","text":"<ul> <li>            Searching Splunk From Browser Bar          </li> <li>            c# \u2013 Logging Directly to Splunk          </li> </ul>"},{"location":"pages/tags/#tag:storage","title":"Storage","text":"<ul> <li>            Backup Strategies          </li> <li>            Reattaching NVMe from VFIO          </li> <li>            Removing Stripe from ZFS Pool          </li> <li>            Using EMC Drives in other systems          </li> <li> </li> </ul>"},{"location":"pages/tags/#tag:storage/synology","title":"Storage/Synology","text":"<ul> <li>            Synology Multipath          </li> </ul>"},{"location":"pages/tags/#tag:truenas","title":"TrueNAS","text":"<ul> <li>            R720XD Bifurcation          </li> <li>            TrueNAS Scale - Enable apt-get          </li> <li>            TrueNAS Scale - VM Cannot Access TrueNAS          </li> <li>            TrueNAS \u2013 iSCSI \u2013 GPT Protective partition          </li> </ul>"},{"location":"pages/tags/#tag:wled","title":"WLED","text":"<ul> <li>            Automating the galaxy          </li> </ul>"},{"location":"pages/tags/#tag:z-wave","title":"Z-Wave","text":"<ul> <li>            Embedded Door Sensors          </li> <li>            Fireplace Automation - Part 3          </li> <li>            First Alert Z-Wave Combo CO/Smoke Detector          </li> <li>            Full local Z-Wave HVAC Control          </li> <li>            Home Assistant Alarm          </li> </ul>"},{"location":"pages/Lemmy/subscribe-to-kbin-from-lemmy/","title":"How to subscribe to kbin from lemmy","text":"<p>Say, you found a community you want to subscribe to. Buts its on kbin.social, and you cannot figure out how to subscribe from lemmy.</p> <p>I will be using https://kbin.social/m/amitheasshole/microblog as an example here.</p>"},{"location":"pages/Lemmy/subscribe-to-kbin-from-lemmy/#step-1-copy-the-url","title":"Step 1. Copy the url.","text":"<p>In this case, we just need, https://kbin.social/m/amitheasshole/microblog</p>"},{"location":"pages/Lemmy/subscribe-to-kbin-from-lemmy/#step-2-get-your-instances-url","title":"Step 2. Get your instance's URL.","text":"<p>In my case, my primary instance is https://lemmyonline.com/</p>"},{"location":"pages/Lemmy/subscribe-to-kbin-from-lemmy/#step-3-combined-the-two","title":"Step 3. Combined the two.","text":"<p>{instance_url}/c/{kbin}</p> <p>So-</p> <p>https://lemmyonline.com/c/@kbinMeta@kbin.social</p>"},{"location":"pages/Projects/","title":"Projects","text":"<p>This page serves to organize a few of the larger projects I have either completed, or are still working on.</p> <ul> <li>Home Solar Project: This project is centered around adding Solar power generation, and battery backup capabilities to my house.</li> <li>40G NAS Project: This is where I have documented the journey and evolution of my home NAS. </li> <li>Homelab: This project tracks the status of my Homelab.</li> </ul>"},{"location":"pages/Projects/40G-NAS/","title":"40 Gigabit NAS Journey","text":"<p>Speedtest going over ethernet to my remote NAS in the other room.</p> <p>This speedtest was achieved after migrating to Core. If I can manage better results, I will update this image. </p>"},{"location":"pages/Projects/40G-NAS/#summary","title":"Summary","text":"<p>I have been trying to see exactly how fast I can push my existing hardware, without dumping ridiculous amounts of money on it.</p> <p>I have tried many things to maximize the amount of performance, including even temporarily buying a pair of 100GBe nics a while back. (TLDR; lots of driver issues\u2026.)</p> <p>Well, after months and months of tinkering, I have finally reached my goal of being able to easily saturate 40GBe ethernet.</p> <p>If you wish to read more of the details which led me to this point, here are a few of the previous posts:</p>"},{"location":"pages/Projects/40G-NAS/#projects","title":"Projects","text":""},{"location":"pages/Projects/40G-NAS/#2020-07-the-original-nas","title":"2020-07 The Original NAS.","text":"<p>I started my current NAS journey, with a 500$ build, after being disappointed at the high prices of synology / drobo / qnap systems. I wanted to prove I could build a more capable system for less money. I did succeed.</p> <p>This unit was eventually replaced due to the underpowered CPU.</p>"},{"location":"pages/Projects/40G-NAS/#2021-03-round-2-combined-nas-and-gaming-pc","title":"2021-03 Round 2. Combined NAS and Gaming PC","text":"<p>I ended up selling the above build, and for a few months, I turned my gaming PC into a combined gaming PC and server. Overall, it worked great. The only downside was the amount of heat being put into my bedroom. Oh, and limited number of PCIe lanes.</p> <p>This was replaced by a Dell R720XD, which I picked up for 500$ shipped, with 128GB of ram included.</p>"},{"location":"pages/Projects/40G-NAS/#2021-09-upgrading-my-home-network-to-1040g-backbone","title":"2021-09 Upgrading my home network to 10/40G backbone","text":"<p>Sept of 2021, I picked up a pair of brocade ICX-6610 10/40G switches. As well, this is the first article where my Dell R720XD was mentioned. I never did a formal write up on obtaining it. However, it replaced my Combined GamingPC/Server.</p> <p>As apart of this project, I also ran 10GBe to my office.</p>"},{"location":"pages/Projects/40G-NAS/#2021-11-adding-a-server-rack","title":"2021-11 Adding a server rack","text":"<p>Self explanatory, however, since having all of your hardware sitting on buckets and cardboard boxes is not the best thing to do, I invested in a rack\u2026 and made everything somewhat presentable.</p>"},{"location":"pages/Projects/40G-NAS/#2021-12-reducing-power-consumption-part-1-retiring-the-brocade-icx-6610","title":"2021-12 Reducing Power Consumption. Part 1. Retiring the Brocade ICX-6610","text":"<p>Turns out, the brocade ICX-6610 produces more heat/noise then I was happy with. In this post, I retired the old switches. This saved a big chunk of power, but, also meant, I no longer had a 40GBe network core. Instead, I leveraged my opnsense firewall for providing a 10G core, although routed.</p>"},{"location":"pages/Projects/40G-NAS/#2022-01-running-40gigabit-fiber","title":"2022-01 Running 40Gigabit Fiber","text":"<p>Since, 10GBe just wasn\u2019t cutting it for me, I finally got around to running 40Gbe fiber from my server closet to my office. This also added a Chelsio 40GBe NIC to my Gaming PC.</p> <p>Since the 40GB was point to point, no switches, no routers, etc, This also improved performance significantly over the 10GBe routed iscsi from previous steps.</p>"},{"location":"pages/Projects/40G-NAS/#2022-01-adding-bifurcation-to-my-poweredge-r720xd","title":"2022-01 Adding \"Bifurcation\" to my Poweredge r720XD","text":"<p>Since, my r720XD does not support bifurcation, I found a few PCIe cards to work as switches for my NVMes. This allowed me to run many more NVMe drives rather then only being able to leverage a single NVMe per PCIe-slot.</p>"},{"location":"pages/Projects/40G-NAS/#2022-03-trying-infiniband","title":"2022-03 Trying Infiniband","text":"<p>One day a few months back, I experimented with using Infiniband.</p> <p>This involved custom compiling drivers for TrueNAS, and having to hack up a lot of bits and pieces you generally do not want to touch.</p> <p>As well, the community forums are quite toxic to you doing anything that isn\u2019t supported out of the box. But, I did manage to successfully get infiniband up and running. However, I was unable to perform any reasonable tests as I didn\u2019t want to hack up the system anymore.</p>"},{"location":"pages/Projects/40G-NAS/#2022-04-reducing-power-consumption-part-2-moving-compute-to-sff-pcs","title":"2022-04 Reducing Power Consumption. Part 2. Moving Compute to SFF PCs","text":"<p>Given electricity costs money, and power usage means heat production, I continued down the path of reducing the energy consumption of my home lab.</p> <p>In this post, I reduced power consumption by ADDING new servers. Overall, I was able to reduce my R720XD\u2019s power consumption by a pretty good chunk by moving services to the new SFF optiplex machines I had acquired.</p> <p>Since, the server was no longer handling containers/VMs, I also removed its second CPU which actually helped performance out a good bit.</p> <p>On the downside, I now only have 96G of ram instead of 128G.</p>"},{"location":"pages/Projects/40G-NAS/#2022-04-migrating-from-scale-to-core","title":"2022-04 Migrating from Scale, to Core","text":"<p>The final step to achieve the performance numbers I have been hunting for- I installed TrueNAS core, and rebuilt my configuration from scratch.</p> <p>Out of the box, with no tuning whatsoever, it had no issues at all besting every performance metric from Scale.</p>"},{"location":"pages/Projects/40G-NAS/#2023-01-death-of-my-r720xd","title":"2023-01 Death of my r720XD","text":"<p>While my Home Solar Project was being installed, I powered down my r720xd to save a bit on battery, since I had to go a full day without any grid connection. Well, low and behold, when I went to power the machine back online, it wasn't having it.</p> <p>After the fact, I did find it was able to boot after installing a new PSU, however, it has long since been replaced by a r730.</p>"},{"location":"pages/Projects/Homelab/","title":"Project: Homelab","text":""},{"location":"pages/Projects/Homelab/#summary","title":"Summary","text":"<p>The goal of this project, is to document the status, and progress of my homelab, over time.</p> <p>My goal is to publish at least a yearly report on whats new, the current status, etc.</p>"},{"location":"pages/Projects/Homelab/#progress-reports","title":"Progress Reports","text":""},{"location":"pages/Projects/Homelab/#2023","title":"2023","text":"<ul> <li>2023 Network Revamp: Honestly, the best post I had for 2023.</li> </ul>"},{"location":"pages/Projects/Homelab/#2024","title":"2024","text":"<ul> <li>2024 Homelab Summary: An in-depth summary of my homelab, hardware, networking, etc.</li> <li>2024 Networking Refresh: Networking changes, redoing vlans, routing, etc.</li> </ul>"},{"location":"pages/Projects/Solar-Project/","title":"Home Solar Project","text":"<p>This project is centered around adding Solar power generation, and battery backup capabilities to my house.</p> <p>As new posts and content are created in the future regarding this project, the below list will be updated.</p> <ul> <li>Part 1. Project Introduction<ul> <li>Expected overview of this project, along with goals.</li> </ul> </li> <li>Part 2. Battery Selection<ul> <li>My battery selection process</li> </ul> </li> <li>EG4 Rack Review<ul> <li>Assembly / Review of the EG4 Battery Rack.</li> </ul> </li> <li>Part 3. Solar Installation<ul> <li>Installation of PV Panels, Inverters, Electrical work.</li> </ul> </li> <li>Part 4 - Data collection and monitoring<ul> <li>4.1 - Installing Solar Assistant<ul> <li>This is used to collect data from both the inverter, and the batteries. The collected data is provided via MQTT in real time.</li> </ul> </li> </ul> </li> <li>Next Steps?</li> <li>Installing A/C Soft-Start<ul> <li>Installing a soft-start for my A/C compressor, to allow it to easily start when running off-grid.</li> </ul> </li> <li>Running off-grid for 4 days after a disaster<ul> <li>A weather event caused me to run off-grid for a few days. Lessons learned.</li> </ul> </li> </ul>"},{"location":"pages/esphome/esphome-common/","title":"ESPhome Common","text":"<p>This is a quick page detailing a few of my \"Common\" components I leverage for ESPhome.</p> <p>Since, I am running over 30 ESPhome devices, I component-ize my configurations as much as possible to improve maintainability. </p>"},{"location":"pages/esphome/esphome-common/#directory-structure","title":"Directory Structure","text":"<p>For my esphome, to attempt to keep everything somewhat organized- I use a unique layout.</p> <p>I keep configurations for commonly used sections, under a <code>common</code> folder. I also have a <code>devices</code> folder, which containers commonly reused device-specific configurations. Ie- for the 12 or so sonoff S13s I have with mostly identical configurations. </p> <pre><code>\u251c\u2500\u2500 Projects Go Here!\n\u251c\u2500\u2500 common\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 button-restart.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 button-safemode.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 common.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-api.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-mqtt.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-ota.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-time.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-wifi.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config-wifi_no_powersave.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 sensor-uptime.yaml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 sensor-wifi-signal.yaml\n\u251c\u2500\u2500 devices\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 sonoff-s13-reset-only.yaml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 sonoff-s13.yaml\n\u251c\u2500\u2500 secrets.yaml\n\u251c\u2500\u2500 my-device.yaml\n</code></pre>"},{"location":"pages/esphome/esphome-common/#common","title":"Common","text":""},{"location":"pages/esphome/esphome-common/#commonyaml","title":"common.yaml","text":"<p>This just references my other common configuration files. </p> <p>I do it this way, to keep everything in my device-specific configuration files very simple.</p> common.yaml<pre><code>&lt;&lt;: !include config-wifi.yaml\n&lt;&lt;: !include config-time.yaml\n&lt;&lt;: !include config-api.yaml\n&lt;&lt;: !include config-ota.yaml\n&lt;&lt;: !include config-mqtt.yaml\n\nlogger:\n</code></pre>"},{"location":"pages/esphome/esphome-common/#secrets","title":"Secrets","text":""},{"location":"pages/esphome/esphome-common/#secretsyaml","title":"secrets.yaml","text":"<p>This is the standard Esphome Secrets file.</p> secrets.yaml<pre><code>ota_pass: \"Password for OTA updates\"\nfallback_pass: \"Password for Fallback AP\"\nencryption_key: \"Your ESPHome Encryption key.\"\n\nwifi_ssid: \"Your Wifi SSID\"\nwifi_pass: \"Your Wifi Password\"\ndomain: \".iot.yourdomain.com\"\n\n# NTP Server IP\n## See the config-time section on this post. This is not required.\nntp_server_ip: 192.168.1.1\ntimezone: America/Chicago\n\n# MQTT Server IP\n# Put YOUR Mqtt information here, IF, you want to use MQTT with your esphome devices. This is not required, and only comes in handy if you want to tie in external automation using MQTT.\nmqtt_ip: 192.168.1.1 \nmqtt_user: \"\"\nmqtt_pass: \"\"\n</code></pre>"},{"location":"pages/esphome/esphome-common/#config","title":"Config","text":""},{"location":"pages/esphome/esphome-common/#config-api","title":"config-api","text":"<p>This configures the Esphome API Component. This is how esphome talks to home-assistant.</p> config-api.yaml<pre><code>api:\n  encryption:\n    key: ${encryption_key}\n  # password: ${api_pass}\n</code></pre>"},{"location":"pages/esphome/esphome-common/#config-mqtt","title":"config-mqtt","text":"<p>This configures the Esphome MQTT Component. Note- this component is NOT required.</p> <p>I do this, to allow external automation tools (NOT home-assistant) to interact with my esphome devices and/or to gather data.</p> <p>The MQTT credentials are stored in <code>secrets.yaml</code></p> <p>Do note, I disable discovery, as I add these devices directly to home-assistant. If, you wish to use discovery instead, you could enable it here.</p> config-mqtt.yaml<pre><code>mqtt:\n  broker: ${mqtt_ip}\n  username: ${mqtt_user}\n  password: ${mqtt_pass}\n  discovery: false\n  discovery_retain: true\n  topic_prefix: esphome/devices/${devicename}\n  log_topic:\n    topic: esphome/logs/${devicename}\n    level: WARN\n  birth_message:\n    topic: esphome/state/${devicename}\n    payload: online\n  will_message:\n    topic: esphome/state/${devicename}\n    payload: offline\n</code></pre>"},{"location":"pages/esphome/esphome-common/#config-ota","title":"config-ota","text":"<p>This section configures OTA (over the air) update component.</p> config-ota.yaml<pre><code>ota:\n  password: ${ota_pass}\n</code></pre>"},{"location":"pages/esphome/esphome-common/#config-time","title":"config-time","text":"<p>Esphome Time Component. Note- this is not required by default. By default, it will query home assistant for the time. </p> <p>Configures my devices to use NTP. By default, devices will gather the time from home-assistant. However, since I have a perfectly functional NTP server hosted on my core switch- I leverage it instead.</p> config-time.yaml<pre><code># Enable Time Component\ntime:\n#  - platform: homeassistant\n#    id: homeassistant_time\n#    timezone: America/Chicago\n  - platform: sntp\n    servers: ${ntp_server_ip}\n    timezone: ${timezone}\n</code></pre>"},{"location":"pages/esphome/esphome-common/#config-wifi","title":"config-wifi","text":"<p>Configures the Wifi Component</p> <p>The ip_address variable is set in the configuration of each device. </p> <p>ssid/pass/etc are configured in secrets.yaml.</p> config-wifi.yaml<pre><code>wifi:\n  ssid: ${wifi_ssid}\n  password: ${wifi_pass}\n  domain: ${domain}\n  fast_connect: True                    # My IOT SSID is hidden. This is required to connect to it. Also- speeds up connection time.\n  power_save_mode: none                 # Don't enable power-savings mode.\n  reboot_timeout: 15min                 # Reboot after 15 minutes, if we are unable to connect to wifi\n  manual_ip:\n    static_ip: ${ip_address}            # I define each device with its own static IP.\n    gateway: ${gateway}\n    subnet: 255.255.255.0               \n    # Note- NO DNS is configured. These devices don't need DNS. I don't allow DNS on my IOT subnet.\n    # Reason being- DNS queries can be used to send data back to the internet.\n\n  ap:                                   # Fallback AP is enabled, because some of my ESP devices are inside of my wall. IF- something happened, This helps a lot to fix the issue.\n    ssid: \"${devicename} Fallback\"\n    password: ${fallback_pass}\n</code></pre>"},{"location":"pages/esphome/esphome-common/#buttons","title":"Buttons","text":""},{"location":"pages/esphome/esphome-common/#button-restart","title":"button-restart","text":"<p>This, just adds a \"restart\" button which will restart my device via home-assistant.</p> button-restart.yaml<pre><code>  - platform: restart\n    name: Restart\n    icon: \"mdi:restart\"\n    entity_category: diagnostic\n</code></pre>"},{"location":"pages/esphome/esphome-common/#button-safemode","title":"button-safemode","text":"<p>This adds a Safe Mode Button, which will reboot the esphome device into Safe Mode</p> button-safemode.yaml<pre><code>  - platform: safe_mode\n    name: Safe Mode Boot\n    icon: \"mdi:restart\"\n    entity_category: diagnostic\n</code></pre> <p>I don't think I have never had a reason to click or use this button, however, it does exist.</p>"},{"location":"pages/esphome/esphome-common/#sensors","title":"Sensors","text":""},{"location":"pages/esphome/esphome-common/#sensor-uptime","title":"sensor-uptime","text":"<p>This adds the ESPHome Uptime Sensor.</p> <p>Quite simply, it adds the current uptime of each device into home-assistant. </p> sensor-uptime.yaml<pre><code>  - platform: uptime\n    name: Uptime\n    state_class: measurement\n    device_class: duration\n</code></pre>"},{"location":"pages/esphome/esphome-common/#sensor-wifi-signal","title":"sensor-wifi-signal","text":"<p>This adds the ESPHome Wifi Signal Sensor.</p> <p>This allows me to see the devices's current wifi signal strength in home-assistant.</p> sensor-wifi-signal.yaml<pre><code>  - platform: wifi_signal\n    name: \"WiFi Signal\"\n    update_interval: 60s\n    state_class: measurement\n    device_class: SIGNAL_STRENGTH\n</code></pre>"},{"location":"snippets/affiliate/","title":"Affiliate","text":"<p>Affiliate Links Used</p> <p>This post DOES include affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>As a disclaimer, I do not display advertisements on this site. I do not accept donations.</p> <p>As such, the only compensation from this service, comes from affiliate links.</p> <p>I am a normal person, who plays with these projects in my spare time. </p> <p>I do not run a company with sponsored youtube channels. </p> <p>If you see a product linked on my blog, It means I paid for it out of my pocket, for my own personal uses, unless otherwise noted.</p> <p>This blog exists for the sole reason, of documenting my various projects and experiences, to share with others.</p> <p>If, you do not wish to use the links, you are under no obligation to click them.</p>"},{"location":"snippets/amazon-affiliate/","title":"Amazon affiliate","text":"<p>Amazon Affiliate Links Used</p> <p>This post DOES include Amazon affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>"},{"location":"snippets/ebay-affiliate/","title":"Ebay affiliate","text":"<p>E-Bay Affiliate Links Used</p> <p>This post DOES include EBay affiliate links. If you found this content useful, please consider buying the products displayed using the provided links.</p> <p>You will pay the same amount as normal, however, it does provide a small benefit to me. This benefit is usually used to purchase other products and hardware for which I can review / blog about.</p> <p>I do not display advertisements on this site. As such, the only compensation from this service, comes from affiliate links. I do not ask for, or even accept donations. </p>"},{"location":"snippets/non-sponsored/","title":"Non sponsored","text":"<p>This content is not sponsored</p> <p>None of the content, or products used in this post was sponsored.</p> <p>Any products tested, were purchased out of my pocket, and tested without cooperation with the manufacturer.</p>"},{"location":"blog/archive/2025/","title":"2025","text":""},{"location":"blog/archive/2024/","title":"2024","text":""},{"location":"blog/archive/2023/","title":"2023","text":""},{"location":"blog/archive/2022/","title":"2022","text":""},{"location":"blog/archive/2021/","title":"2021","text":""},{"location":"blog/archive/2020/","title":"2020","text":""},{"location":"blog/archive/2019/","title":"2019","text":""},{"location":"blog/category/development/","title":"Development","text":""},{"location":"blog/category/misc/","title":"Misc","text":""},{"location":"blog/category/shop-talk/","title":"Shop-Talk","text":""},{"location":"blog/category/technology/","title":"Technology","text":""},{"location":"blog/category/home-automation/","title":"Home-Automation","text":""},{"location":"blog/category/kubernetes/","title":"Kubernetes","text":""},{"location":"blog/category/home-improvement/","title":"Home-Improvement","text":""},{"location":"blog/category/solar/","title":"Solar","text":""},{"location":"blog/page/2/","title":"Index","text":""},{"location":"blog/page/3/","title":"Index","text":""},{"location":"blog/page/4/","title":"Index","text":""},{"location":"blog/page/5/","title":"Index","text":""},{"location":"blog/archive/2024/page/2/","title":"2024","text":""},{"location":"blog/archive/2023/page/2/","title":"2023","text":""},{"location":"blog/archive/2022/page/2/","title":"2022","text":""},{"location":"blog/category/home-automation/page/2/","title":"Home-Automation","text":""},{"location":"blog/category/technology/page/2/","title":"Technology","text":""},{"location":"blog/category/technology/page/3/","title":"Technology","text":""},{"location":"blog/category/technology/page/4/","title":"Technology","text":""}]}